
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 21, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-GraphAPITest.java</h3>
            <pre><code>1  package redis.clients.jedis.modules.graph;
2  import static org.junit.Assert.assertEquals;
3  import static org.junit.Assert.assertFalse;
4  import static org.junit.Assert.assertNotNull;
5  import static org.junit.Assert.assertNull;
6  import static org.junit.Assert.assertTrue;
7  import static org.junit.Assert.fail;
8  import java.util.*;
9  import org.junit.After;
10  import org.junit.Assert;
11  import org.junit.BeforeClass;
12  import org.junit.Test;
13  import redis.clients.jedis.graph.Header;
14  import redis.clients.jedis.graph.Record;
15  import redis.clients.jedis.graph.ResultSet;
16  import redis.clients.jedis.graph.Statistics;
17  import redis.clients.jedis.graph.entities.*;
18  import redis.clients.jedis.modules.RedisModuleCommandsTestBase;
19  public class GraphAPITest extends RedisModuleCommandsTestBase {
20    @BeforeClass
21    public static void prepare() {
22      RedisModuleCommandsTestBase.prepare();
23    }
24    @After
25    @Override
26    public void tearDown() throws Exception {
27      client.graphDelete("social");
28      super.tearDown();
29    }
30      @Test
31      public void testCreateNode() {
32          ResultSet resultSet = client.graphQuery("social", "CREATE ({name:'roi',age:32})");
33          Statistics stats = resultSet.getStatistics();
34          assertEquals(1, stats.nodesCreated());
35          assertEquals(0, stats.nodesDeleted());
36          assertEquals(0, stats.relationshipsCreated());
37          assertEquals(0, stats.relationshipsDeleted());
38          assertEquals(2, stats.propertiesSet());
39          assertNotNull(stats.queryIntervalExecutionTime());
40          assertEquals(0, resultSet.size());
41          assertFalse(resultSet.iterator().hasNext());
42          try {
43              resultSet.iterator().next();
44              fail();
45          } catch (NoSuchElementException ignored) {
46          }
47      }
48      @Test
49      public void testCreateLabeledNode() {
50          ResultSet resultSet = client.graphQuery("social", "CREATE (:human{name:'danny',age:12})");
51          Statistics stats = resultSet.getStatistics();
52          assertEquals(1, stats.nodesCreated());
53          assertEquals(2, stats.propertiesSet());
54          assertNotNull(stats.queryIntervalExecutionTime());
55          assertEquals(0, resultSet.size());
56          assertFalse(resultSet.iterator().hasNext());
57      }
58      @Test
59      public void testConnectNodes() {
60          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'roi',age:32})"));
61          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'amit',age:30})"));
62          ResultSet resultSet = client.graphQuery("social",
63                  "MATCH (a:person), (b:person) WHERE (a.name = 'roi' AND b.name='amit')  CREATE (a)-[:knows]->(b)");
64          Statistics stats = resultSet.getStatistics();
65          assertEquals(0, stats.nodesCreated());
66          assertEquals(1, stats.relationshipsCreated());
67          assertEquals(0, stats.relationshipsDeleted());
68          assertEquals(0, stats.propertiesSet());
69          assertNotNull(stats.queryIntervalExecutionTime());
70          assertEquals(0, resultSet.size());
71          assertFalse(resultSet.iterator().hasNext());
72      }
73      @Test
74      public void testDeleteNodes() {
75          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'roi',age:32})"));
76          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'amit',age:30})"));
77          ResultSet deleteResult = client.graphQuery("social", "MATCH (a:person) WHERE (a.name = 'roi') DELETE a");
78          Statistics delStats = deleteResult.getStatistics();
79          assertEquals(0, delStats.nodesCreated());
80          assertEquals(1, delStats.nodesDeleted());
81          assertEquals(0, delStats.relationshipsCreated());
82          assertEquals(0, delStats.relationshipsDeleted());
83          assertEquals(0, delStats.propertiesSet());
84          assertNotNull(delStats.queryIntervalExecutionTime());
85          assertEquals(0, deleteResult.size());
86          assertFalse(deleteResult.iterator().hasNext());
87          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'roi',age:32})"));
88          assertNotNull(client.graphQuery("social",
89                  "MATCH (a:person), (b:person) WHERE (a.name = 'roi' AND b.name='amit')  CREATE (a)-[:knows]->(a)"));
90          deleteResult = client.graphQuery("social", "MATCH (a:person) WHERE (a.name = 'roi') DELETE a");
91          assertEquals(0, delStats.nodesCreated());
92          assertEquals(1, delStats.nodesDeleted());
93          assertEquals(0, delStats.relationshipsCreated());
94          assertEquals(0, delStats.relationshipsDeleted());
95          assertEquals(0, delStats.propertiesSet());
96          assertNotNull(delStats.queryIntervalExecutionTime());
97          assertEquals(0, deleteResult.size());
98          assertFalse(deleteResult.iterator().hasNext());
99      }
100      @Test
101      public void testDeleteRelationship() {
102          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'roi',age:32})"));
103          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'amit',age:30})"));
104          assertNotNull(client.graphQuery("social",
105                  "MATCH (a:person), (b:person) WHERE (a.name = 'roi' AND b.name='amit')  CREATE (a)-[:knows]->(a)"));
<span onclick='openModal()' class='match'>106          ResultSet deleteResult = client.graphQuery("social",
107                  "MATCH (a:person)-[e]->() WHERE (a.name = 'roi') DELETE e");
108          Statistics delStats = deleteResult.getStatistics();
109          assertEquals(0, delStats.nodesCreated());
</span>110          assertEquals(0, delStats.nodesDeleted());
111          assertEquals(0, delStats.relationshipsCreated());
112          assertEquals(1, delStats.relationshipsDeleted());
113          assertEquals(0, delStats.propertiesSet());
114          assertNotNull(delStats.queryIntervalExecutionTime());
115          assertEquals(0, deleteResult.size());
116          assertFalse(deleteResult.iterator().hasNext());
117      }
118      @Test
119      public void testIndex() {
120          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'roi',age:32})"));
121          ResultSet createIndexResult = client.graphQuery("social", "CREATE INDEX ON :person(age)");
122          assertFalse(createIndexResult.iterator().hasNext());
123          assertEquals(1, createIndexResult.getStatistics().indicesCreated());
124          ResultSet createNonExistingIndexResult = client.graphQuery("social", "CREATE INDEX ON :person(age1)");
125          assertFalse(createNonExistingIndexResult.iterator().hasNext());
126          assertEquals(1, createNonExistingIndexResult.getStatistics().indicesCreated());
127          ResultSet createExistingIndexResult = client.graphQuery("social", "CREATE INDEX ON :person(age)");
128          assertFalse(createExistingIndexResult.iterator().hasNext());
129          assertEquals(0, createExistingIndexResult.getStatistics().indicesCreated());
130          ResultSet deleteExistingIndexResult = client.graphQuery("social", "DROP INDEX ON :person(age)");
131          assertFalse(deleteExistingIndexResult.iterator().hasNext());
132          assertEquals(1, deleteExistingIndexResult.getStatistics().indicesDeleted());
133      }
134      @Test
135      public void testHeader() {
136          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'roi',age:32})"));
137          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'amit',age:30})"));
138          assertNotNull(client.graphQuery("social",
139                  "MATCH (a:person), (b:person) WHERE (a.name = 'roi' AND b.name='amit')  CREATE (a)-[:knows]->(a)"));
140          ResultSet queryResult = client.graphQuery("social", "MATCH (a:person)-[r:knows]->(b:person) RETURN a,r, a.age");
141          Header header = queryResult.getHeader();
142          assertNotNull(header);
143          assertEquals("HeaderImpl{"
144                  + "schemaTypes=[SCALAR, SCALAR, SCALAR], "
145                  + "schemaNames=[a, r, a.age]}", header.toString());
146          List<String> schemaNames = header.getSchemaNames();
147          assertNotNull(schemaNames);
148          assertEquals(3, schemaNames.size());
149          assertEquals("a", schemaNames.get(0));
150          assertEquals("r", schemaNames.get(1));
151          assertEquals("a.age", schemaNames.get(2));
152      }
153      @Test
154      public void testRecord() {
155          String name = "roi";
156          int age = 32;
157          double doubleValue = 3.14;
158          boolean boolValue = true;
159          String place = "TLV";
160          int since = 2000;
161          Property<String> nameProperty = new Property<>("name", name);
162          Property<Integer> ageProperty = new Property<>("age", age);
163          Property<Double> doubleProperty = new Property<>("doubleValue", doubleValue);
164          Property<Boolean> trueBooleanProperty = new Property<>("boolValue", true);
165          Property<Boolean> falseBooleanProperty = new Property<>("boolValue", false);
166          Property<String> placeProperty = new Property<>("place", place);
167          Property<Integer> sinceProperty = new Property<>("since", since);
168          Node expectedNode = new Node();
169          expectedNode.setId(0);
170          expectedNode.addLabel("person");
171          expectedNode.addProperty(nameProperty);
172          expectedNode.addProperty(ageProperty);
173          expectedNode.addProperty(doubleProperty);
174          expectedNode.addProperty(trueBooleanProperty);
175          assertEquals(
176                  "Node{labels=[person], id=0, "
177                          + "propertyMap={name=Property{name='name', value=roi}, "
178                          + "boolValue=Property{name='boolValue', value=true}, "
179                          + "doubleValue=Property{name='doubleValue', value=3.14}, "
180                          + "age=Property{name='age', value=32}}}",
181                  expectedNode.toString());
182          Edge expectedEdge = new Edge();
183          expectedEdge.setId(0);
184          expectedEdge.setSource(0);
185          expectedEdge.setDestination(1);
186          expectedEdge.setRelationshipType("knows");
187          expectedEdge.addProperty(placeProperty);
188          expectedEdge.addProperty(sinceProperty);
189          expectedEdge.addProperty(doubleProperty);
190          expectedEdge.addProperty(falseBooleanProperty);
191          assertEquals("Edge{relationshipType='knows', source=0, destination=1, id=0, "
192                  + "propertyMap={boolValue=Property{name='boolValue', value=false}, "
193                  + "place=Property{name='place', value=TLV}, "
194                  + "doubleValue=Property{name='doubleValue', value=3.14}, "
195                  + "since=Property{name='since', value=2000}}}", expectedEdge.toString());
196          Map<String, Object> params = new HashMap<>();
197          params.put("name", name);
198          params.put("age", age);
199          params.put("boolValue", boolValue);
200          params.put("doubleValue", doubleValue);
201          assertNotNull(client.graphQuery("social",
202                  "CREATE (:person{name:$name,age:$age, doubleValue:$doubleValue, boolValue:$boolValue})", params));
203          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'amit',age:30})"));
204          assertNotNull(
205                  client.graphQuery("social", "MATCH (a:person), (b:person) WHERE (a.name = 'roi' AND b.name='amit')  " +
206                          "CREATE (a)-[:knows{place:'TLV', since:2000,doubleValue:3.14, boolValue:false}]->(b)"));
207          ResultSet resultSet = client.graphQuery("social", "MATCH (a:person)-[r:knows]->(b:person) RETURN a,r, " +
208                  "a.name, a.age, a.doubleValue, a.boolValue, " +
209                  "r.place, r.since, r.doubleValue, r.boolValue");
210          assertNotNull(resultSet);
211          Statistics stats = resultSet.getStatistics();
212          assertEquals(0, stats.nodesCreated());
213          assertEquals(0, stats.nodesDeleted());
214          assertEquals(0, stats.labelsAdded());
215          assertEquals(0, stats.propertiesSet());
216          assertEquals(0, stats.relationshipsCreated());
217          assertEquals(0, stats.relationshipsDeleted());
218          assertNotNull(stats.queryIntervalExecutionTime());
219          assertFalse(stats.queryIntervalExecutionTime().isEmpty());
220          assertEquals(1, resultSet.size());
221          Iterator<Record> iterator = resultSet.iterator();
222          assertTrue(iterator.hasNext());
223          Record record = iterator.next();
224          assertFalse(iterator.hasNext());
225          Node node = record.getValue(0);
226          assertNotNull(node);
227          assertEquals(expectedNode, node);
228          node = record.getValue("a");
229          assertEquals(expectedNode, node);
230          Edge edge = record.getValue(1);
231          assertNotNull(edge);
232          assertEquals(expectedEdge, edge);
233          edge = record.getValue("r");
234          assertEquals(expectedEdge, edge);
235          assertEquals(Arrays.asList("a", "r", "a.name", "a.age", "a.doubleValue", "a.boolValue",
236                  "r.place", "r.since", "r.doubleValue", "r.boolValue"), record.keys());
237          assertEquals(Arrays.asList(expectedNode, expectedEdge,
238                  name, (long) age, doubleValue, true,
239                  place, (long) since, doubleValue, false),
240                  record.values());
241          Node a = record.getValue("a");
242          for (String propertyName : expectedNode.getEntityPropertyNames()) {
243              assertEquals(expectedNode.getProperty(propertyName), a.getProperty(propertyName));
244          }
245          assertEquals("roi", record.getString(2));
246          assertEquals("32", record.getString(3));
247          assertEquals(32L, ((Long) record.getValue(3)).longValue());
248          assertEquals(32L, ((Long) record.getValue("a.age")).longValue());
249          assertEquals("roi", record.getString("a.name"));
250          assertEquals("32", record.getString("a.age"));
251      }
252      @Test
253      public void testAdditionToProcedures() {
254          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'roi',age:32})"));
255          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'amit',age:30})"));
256          assertNotNull(client.graphQuery("social",
257                  "MATCH (a:person), (b:person) WHERE (a.name = 'roi' AND b.name='amit')  CREATE (a)-[:knows]->(b)"));
258          Property<String> nameProperty = new Property<>("name", "roi");
259          Property<Integer> ageProperty = new Property<>("age", 32);
260          Property<String> lastNameProperty = new Property<>("lastName", "a");
261          Node expectedNode = new Node();
262          expectedNode.setId(0);
263          expectedNode.addLabel("person");
264          expectedNode.addProperty(nameProperty);
265          expectedNode.addProperty(ageProperty);
266          Edge expectedEdge = new Edge();
267          expectedEdge.setId(0);
268          expectedEdge.setSource(0);
269          expectedEdge.setDestination(1);
270          expectedEdge.setRelationshipType("knows");
271          ResultSet resultSet = client.graphQuery("social", "MATCH (a:person)-[r:knows]->(b:person) RETURN a,r");
272          assertNotNull(resultSet.getHeader());
273          Header header = resultSet.getHeader();
274          List<String> schemaNames = header.getSchemaNames();
275          assertNotNull(schemaNames);
276          assertEquals(2, schemaNames.size());
277          assertEquals("a", schemaNames.get(0));
278          assertEquals("r", schemaNames.get(1));
279          assertEquals(1, resultSet.size());
280          Iterator<Record> iterator = resultSet.iterator();
281          assertTrue(iterator.hasNext());
282          Record record = iterator.next();
283          assertFalse(iterator.hasNext());
284          assertEquals(Arrays.asList("a", "r"), record.keys());
285          assertEquals(Arrays.asList(expectedNode, expectedEdge), record.values());
286          expectedNode.removeProperty("name");
287          expectedNode.removeProperty("age");
288          expectedNode.addProperty(lastNameProperty);
289          expectedNode.removeLabel("person");
290          expectedNode.addLabel("worker");
291          expectedNode.setId(2);
292          expectedEdge.setRelationshipType("worksWith");
293          expectedEdge.setSource(2);
294          expectedEdge.setDestination(3);
295          expectedEdge.setId(1);
296          assertNotNull(client.graphQuery("social", "CREATE (:worker{lastName:'a'})"));
297          assertNotNull(client.graphQuery("social", "CREATE (:worker{lastName:'b'})"));
298          assertNotNull(client.graphQuery("social",
299                  "MATCH (a:worker), (b:worker) WHERE (a.lastName = 'a' AND b.lastName='b')  CREATE (a)-[:worksWith]->(b)"));
300          resultSet = client.graphQuery("social", "MATCH (a:worker)-[r:worksWith]->(b:worker) RETURN a,r");
301          assertNotNull(resultSet.getHeader());
302          header = resultSet.getHeader();
303          schemaNames = header.getSchemaNames();
304          assertNotNull(schemaNames);
305          assertEquals(2, schemaNames.size());
306          assertEquals("a", schemaNames.get(0));
307          assertEquals("r", schemaNames.get(1));
308          assertEquals(1, resultSet.size());
309          iterator = resultSet.iterator();
310          assertTrue(iterator.hasNext());
311          record = iterator.next();
312          assertFalse(iterator.hasNext());
313          assertEquals(Arrays.asList("a", "r"), record.keys());
314          assertEquals(Arrays.asList(expectedNode, expectedEdge), record.values());
315      }
316      @Test
317      public void testEscapedQuery() {
318          Map<String, Object> params1 = new HashMap<String, Object>();
319          params1.put("s1", "S\"'");
320          params1.put("s2", "S'\"");
321          assertNotNull(client.graphQuery("social", "CREATE (:escaped{s1:$s1,s2:$s2})", params1));
322          Map<String, Object> params2 = new HashMap<String, Object>();
323          params2.put("s1", "S\"'");
324          params2.put("s2", "S'\"");
325          assertNotNull(client.graphQuery("social", "MATCH (n) where n.s1=$s1 and n.s2=$s2 RETURN n", params2));
326          assertNotNull(client.graphQuery("social", "MATCH (n) where n.s1='S\"' RETURN n"));
327      }
328      @Test
329      public void testArraySupport() {
330          Node expectedANode = new Node();
331          expectedANode.setId(0);
332          expectedANode.addLabel("person");
333          Property<String> aNameProperty = new Property<>("name", "a");
334          Property<Integer> aAgeProperty = new Property<>("age", 32);
335          Property<List<Long>> aListProperty = new Property<>("array", Arrays.asList(0L, 1L, 2L));
336          expectedANode.addProperty(aNameProperty);
337          expectedANode.addProperty(aAgeProperty);
338          expectedANode.addProperty(aListProperty);
339          Node expectedBNode = new Node();
340          expectedBNode.setId(1);
341          expectedBNode.addLabel("person");
342          Property<String> bNameProperty = new Property<>("name", "b");
343          Property<Integer> bAgeProperty = new Property<>("age", 30);
344          Property<List<Long>> bListProperty = new Property<>("array", Arrays.asList(3L, 4L, 5L));
345          expectedBNode.addProperty(bNameProperty);
346          expectedBNode.addProperty(bAgeProperty);
347          expectedBNode.addProperty(bListProperty);
348          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'a',age:32,array:[0,1,2]})"));
349          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'b',age:30,array:[3,4,5]})"));
350          ResultSet resultSet = client.graphQuery("social", "WITH [0,1,2] as x return x");
351          assertNotNull(resultSet.getHeader());
352          Header header = resultSet.getHeader();
353          List<String> schemaNames = header.getSchemaNames();
354          assertNotNull(schemaNames);
355          assertEquals(1, schemaNames.size());
356          assertEquals("x", schemaNames.get(0));
357          assertEquals(1, resultSet.size());
358          Iterator<Record> iterator = resultSet.iterator();
359          assertTrue(iterator.hasNext());
360          Record record = iterator.next();
361          assertFalse(iterator.hasNext());
362          assertEquals(Arrays.asList("x"), record.keys());
363          List<Long> x = record.getValue("x");
364          assertEquals(Arrays.asList(0L, 1L, 2L), x);
365          resultSet = client.graphQuery("social", "MATCH(n) return collect(n) as x");
366          assertNotNull(resultSet.getHeader());
367          header = resultSet.getHeader();
368          schemaNames = header.getSchemaNames();
369          assertNotNull(schemaNames);
370          assertEquals(1, schemaNames.size());
371          assertEquals("x", schemaNames.get(0));
372          assertEquals(1, resultSet.size());
373          iterator = resultSet.iterator();
374          assertTrue(iterator.hasNext());
375          record = iterator.next();
376          assertFalse(iterator.hasNext());
377          assertEquals(Arrays.asList("x"), record.keys());
378          x = record.getValue("x");
379          assertEquals(Arrays.asList(expectedANode, expectedBNode), x);
380          resultSet = client.graphQuery("social", "unwind([0,1,2]) as x return x");
381          assertNotNull(resultSet.getHeader());
382          header = resultSet.getHeader();
383          schemaNames = header.getSchemaNames();
384          assertNotNull(schemaNames);
385          assertEquals(1, schemaNames.size());
386          assertEquals("x", schemaNames.get(0));
387          assertEquals(3, resultSet.size());
388          iterator = resultSet.iterator();
389          for (long i = 0; i < 3; i++) {
390              assertTrue(iterator.hasNext());
391              record = iterator.next();
392              assertEquals(Arrays.asList("x"), record.keys());
393              assertEquals(i, (long) record.getValue("x"));
394          }
395      }
396      @Test
397      public void testPath() {
398          List<Node> nodes = new ArrayList<>(3);
399          for (int i = 0; i < 3; i++) {
400              Node node = new Node();
401              node.setId(i);
402              node.addLabel("L1");
403              nodes.add(node);
404          }
405          List<Edge> edges = new ArrayList<>(2);
406          for (int i = 0; i < 2; i++) {
407              Edge edge = new Edge();
408              edge.setId(i);
409              edge.setRelationshipType("R1");
410              edge.setSource(i);
411              edge.setDestination(i + 1);
412              edges.add(edge);
413          }
414          Set<Path> expectedPaths = new HashSet<>();
415          Path path01 = new PathBuilder(2).append(nodes.get(0)).append(edges.get(0)).append(nodes.get(1)).build();
416          Path path12 = new PathBuilder(2).append(nodes.get(1)).append(edges.get(1)).append(nodes.get(2)).build();
417          Path path02 = new PathBuilder(3).append(nodes.get(0)).append(edges.get(0)).append(nodes.get(1))
418                  .append(edges.get(1)).append(nodes.get(2)).build();
419          expectedPaths.add(path01);
420          expectedPaths.add(path12);
421          expectedPaths.add(path02);
422          client.graphQuery("social", "CREATE (:L1)-[:R1]->(:L1)-[:R1]->(:L1)");
423          ResultSet resultSet = client.graphQuery("social", "MATCH p = (:L1)-[:R1*]->(:L1) RETURN p");
424          assertEquals(expectedPaths.size(), resultSet.size());
425          Iterator<Record> iterator = resultSet.iterator();
426          for (int i = 0; i < resultSet.size(); i++) {
427              Path p = iterator.next().getValue("p");
428              assertTrue(expectedPaths.contains(p));
429              expectedPaths.remove(p);
430          }
431      }
432      @Test
433      public void testNullGraphEntities() {
434          assertNotNull(client.graphQuery("social", "CREATE (:L)-[:E]->(:L2)"));
435          ResultSet resultSet = client.graphQuery("social", "OPTIONAL MATCH (a:NONEXISTENT)-[e]->(b) RETURN a, e, b");
436          assertEquals(1, resultSet.size());
437          Iterator<Record> iterator = resultSet.iterator();
438          assertTrue(iterator.hasNext());
439          Record record = iterator.next();
440          assertFalse(iterator.hasNext());
441          assertEquals(Arrays.asList(null, null, null), record.values());
442          resultSet = client.graphQuery("social", "MATCH (a) OPTIONAL MATCH (a)-[e]->(b) RETURN a, e, b ORDER BY ID(a)");
443          assertEquals(2, resultSet.size());
444          iterator = resultSet.iterator();
445          record = iterator.next();
446          assertEquals(3, record.size());
447          assertNotNull(record.getValue(0));
448          assertNotNull(record.getValue(1));
449          assertNotNull(record.getValue(2));
450          record = iterator.next();
451          assertEquals(3, record.size());
452          assertNotNull(record.getValue(0));
453          assertNull(record.getValue(1));
454          assertNull(record.getValue(2));
455          resultSet = client.graphQuery("social", "MATCH (a) OPTIONAL MATCH p = (a)-[e]->(b) RETURN p");
456          assertEquals(2, resultSet.size());
457          iterator = resultSet.iterator();
458          record = iterator.next();
459          assertEquals(1, record.size());
460          assertNotNull(record.getValue(0));
461          record = iterator.next();
462          assertEquals(1, record.size());
463          assertNull(record.getValue(0));
464      }
465      @Test
466      public void test64bitnumber() {
467          long value = 1L << 40;
468          Map<String, Object> params = new HashMap<>();
469          params.put("val", value);
470          ResultSet resultSet = client.graphQuery("social", "CREATE (n {val:$val}) RETURN n.val", params);
471          assertEquals(1, resultSet.size());
472          Record r = resultSet.iterator().next();
473          assertEquals(Long.valueOf(value), r.getValue(0));
474      }
475      @Test
476      public void testCachedExecution() {
477          client.graphQuery("social", "CREATE (:N {val:1}), (:N {val:2})");
478          Map<String, Object> params = new HashMap<>();
479          params.put("val", 1L);
480          ResultSet resultSet = client.graphQuery("social", "MATCH (n:N {val:$val}) RETURN n.val", params);
481          assertEquals(1, resultSet.size());
482          Record r = resultSet.iterator().next();
483          assertEquals(params.get("val"), r.getValue(0));
484          assertFalse(resultSet.getStatistics().cachedExecution());
485          for (int i = 0; i < 64; i++) {
486              resultSet = client.graphQuery("social", "MATCH (n:N {val:$val}) RETURN n.val", params);
487          }
488          assertEquals(1, resultSet.size());
489          r = resultSet.iterator().next();
490          assertEquals(params.get("val"), r.getValue(0));
491          assertTrue(resultSet.getStatistics().cachedExecution());
492      }
493      @Test
494      public void testMapDataType() {
495          Map<String, Object> expected = new HashMap<>();
496          expected.put("a", (long) 1);
497          expected.put("b", "str");
498          expected.put("c", null);
499          List<Object> d = new ArrayList<>();
500          d.add((long) 1);
501          d.add((long) 2);
502          d.add((long) 3);
503          expected.put("d", d);
504          expected.put("e", true);
505          Map<String, Object> f = new HashMap<>();
506          f.put("x", (long) 1);
507          f.put("y", (long) 2);
508          expected.put("f", f);
509          ResultSet res = client.graphQuery("social", "RETURN {a:1, b:'str', c:NULL, d:[1,2,3], e:True, f:{x:1, y:2}}");
510          assertEquals(1, res.size());
511          Record r = res.iterator().next();
512          Map<String, Object> actual = r.getValue(0);
513          assertEquals(expected, actual);
514      }
515      @Test
516      public void testGeoPointLatLon() {
517          ResultSet rs = client.graphQuery("social", "CREATE (:restaurant"
518                  + " {location: point({latitude:30.27822306, longitude:-97.75134723})})");
519          assertEquals(1, rs.getStatistics().nodesCreated());
520          assertEquals(1, rs.getStatistics().propertiesSet());
521          assertTestGeoPoint();
522      }
523      @Test
524      public void testGeoPointLonLat() {
525          ResultSet rs = client.graphQuery("social", "CREATE (:restaurant"
526                  + " {location: point({longitude:-97.75134723, latitude:30.27822306})})");
527          assertEquals(1, rs.getStatistics().nodesCreated());
528          assertEquals(1, rs.getStatistics().propertiesSet());
529          assertTestGeoPoint();
530      }
531      private void assertTestGeoPoint() {
532          ResultSet results = client.graphQuery("social", "MATCH (restaurant) RETURN restaurant");
533          assertEquals(1, results.size());
534          Record record = results.iterator().next();
535          assertEquals(1, record.size());
536          assertEquals(Collections.singletonList("restaurant"), record.keys());
537          Node node = record.getValue(0);
538          Property<?> property = node.getProperty("location");
539          assertEquals(new Point(30.27822306, -97.75134723), property.getValue());
540      }
541      @Test
542      public void timeoutArgument() {
543          ResultSet rs = client.graphQuery("social", "UNWIND range(0,100) AS x WITH x AS x WHERE x = 100 RETURN x", 1L);
544          assertEquals(1, rs.size());
545          Record r = rs.iterator().next();
546          assertEquals(Long.valueOf(100), r.getValue(0));
547      }
548      @Test
549      public void testCachedExecutionReadOnly() {
550          client.graphQuery("social", "CREATE (:N {val:1}), (:N {val:2})");
551          Map<String, Object> params = new HashMap<>();
552          params.put("val", 1L);
553          ResultSet resultSet =   client.graphReadonlyQuery("social", "MATCH (n:N {val:$val}) RETURN n.val", params);
554          assertEquals(1, resultSet.size());
555          Record r = resultSet.iterator().next();
556          assertEquals(params.get("val"), r.getValue(0));
557          assertFalse(resultSet.getStatistics().cachedExecution());
558          for (int i = 0; i < 64; i++) {
559              resultSet =   client.graphReadonlyQuery("social", "MATCH (n:N {val:$val}) RETURN n.val", params);
560          }
561          assertEquals(1, resultSet.size());
562          r = resultSet.iterator().next();
563          assertEquals(params.get("val"), r.getValue(0));
564          assertTrue(resultSet.getStatistics().cachedExecution());
565      }
566      @Test
567      public void testSimpleReadOnly() {
568          client.graphQuery("social", "CREATE (:person{name:'filipe',age:30})");
569          ResultSet rsRo = client.graphReadonlyQuery("social", "MATCH (a:person) WHERE (a.name = 'filipe') RETURN a.age");
570          assertEquals(1, rsRo.size());
571          Record r = rsRo.iterator().next();
572          assertEquals(Long.valueOf(30), r.getValue(0));
573      }
574    @Test
575    public void profile() {
576      assertNotNull(client.graphQuery("social", "CREATE (:person{name:'roi',age:32})"));
577      assertNotNull(client.graphQuery("social", "CREATE (:person{name:'amit',age:30})"));
578      List<String> profile = client.graphProfile("social",
579          "MATCH (a:person), (b:person) WHERE (a.name = 'roi' AND b.name='amit')  CREATE (a)-[:knows]->(b)");
580      assertFalse(profile.isEmpty());
581      profile.forEach(Assert::assertNotNull);
582    }
583    @Test
584    public void explain() {
585      assertNotNull(client.graphProfile("social", "CREATE (:person{name:'roi',age:32})"));
586      assertNotNull(client.graphProfile("social", "CREATE (:person{name:'amit',age:30})"));
587      List<String> explain = client.graphExplain("social",
588          "MATCH (a:person), (b:person) WHERE (a.name = 'roi' AND b.name='amit')  CREATE (a)-[:knows]->(b)");
589      assertFalse(explain.isEmpty());
590      explain.forEach(Assert::assertNotNull);
591    }
592    @Test
593    public void slowlog() {
594      assertNotNull(client.graphProfile("social", "CREATE (:person{name:'roi',age:32})"));
595      assertNotNull(client.graphProfile("social", "CREATE (:person{name:'amit',age:30})"));
596      List<List<Object>> slowlogs = client.graphSlowlog("social");
597      assertEquals(2, slowlogs.size());
598      slowlogs.forEach(sl -> assertFalse(sl.isEmpty()));
599      slowlogs.forEach(sl -> sl.forEach(Assert::assertNotNull));
600    }
601    @Test
602    public void list() {
603      assertEquals(Collections.emptyList(), client.graphList());
604      client.graphQuery("social", "CREATE (:person{name:'filipe',age:30})");
605      assertEquals(Collections.singletonList("social"), client.graphList());
606    }
607    @Test
608    public void config() {
609      client.graphQuery("social", "CREATE (:person{name:'filipe',age:30})");
610      final String name = "RESULTSET_SIZE";
611      final Object existingValue = client.graphConfigGet(name).get(name);
612      assertEquals("OK", client.graphConfigSet(name, 250L));
613      assertEquals(Collections.singletonMap(name, 250L), client.graphConfigGet(name));
614      client.graphConfigSet(name, existingValue != null ? existingValue : -1);
615    }
616  }
</code></pre>
        </div>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-GraphAPITest.java</h3>
            <pre><code>1  package redis.clients.jedis.modules.graph;
2  import static org.junit.Assert.assertEquals;
3  import static org.junit.Assert.assertFalse;
4  import static org.junit.Assert.assertNotNull;
5  import static org.junit.Assert.assertNull;
6  import static org.junit.Assert.assertTrue;
7  import static org.junit.Assert.fail;
8  import java.util.*;
9  import org.junit.After;
10  import org.junit.Assert;
11  import org.junit.BeforeClass;
12  import org.junit.Test;
13  import redis.clients.jedis.graph.Header;
14  import redis.clients.jedis.graph.Record;
15  import redis.clients.jedis.graph.ResultSet;
16  import redis.clients.jedis.graph.Statistics;
17  import redis.clients.jedis.graph.entities.*;
18  import redis.clients.jedis.modules.RedisModuleCommandsTestBase;
19  public class GraphAPITest extends RedisModuleCommandsTestBase {
20    @BeforeClass
21    public static void prepare() {
22      RedisModuleCommandsTestBase.prepare();
23    }
24    @After
25    @Override
26    public void tearDown() throws Exception {
27      client.graphDelete("social");
28      super.tearDown();
29    }
30      @Test
31      public void testCreateNode() {
32          ResultSet resultSet = client.graphQuery("social", "CREATE ({name:'roi',age:32})");
33          Statistics stats = resultSet.getStatistics();
34          assertEquals(1, stats.nodesCreated());
35          assertEquals(0, stats.nodesDeleted());
36          assertEquals(0, stats.relationshipsCreated());
37          assertEquals(0, stats.relationshipsDeleted());
38          assertEquals(2, stats.propertiesSet());
39          assertNotNull(stats.queryIntervalExecutionTime());
40          assertEquals(0, resultSet.size());
41          assertFalse(resultSet.iterator().hasNext());
42          try {
43              resultSet.iterator().next();
44              fail();
45          } catch (NoSuchElementException ignored) {
46          }
47      }
48      @Test
49      public void testCreateLabeledNode() {
<span onclick='openModal()' class='match'>50          ResultSet resultSet = client.graphQuery("social", "CREATE (:human{name:'danny',age:12})");
51          Statistics stats = resultSet.getStatistics();
52          assertEquals(1, stats.nodesCreated());
</span>53          assertEquals(2, stats.propertiesSet());
54          assertNotNull(stats.queryIntervalExecutionTime());
55          assertEquals(0, resultSet.size());
56          assertFalse(resultSet.iterator().hasNext());
57      }
58      @Test
59      public void testConnectNodes() {
60          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'roi',age:32})"));
61          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'amit',age:30})"));
62          ResultSet resultSet = client.graphQuery("social",
63                  "MATCH (a:person), (b:person) WHERE (a.name = 'roi' AND b.name='amit')  CREATE (a)-[:knows]->(b)");
64          Statistics stats = resultSet.getStatistics();
65          assertEquals(0, stats.nodesCreated());
66          assertEquals(1, stats.relationshipsCreated());
67          assertEquals(0, stats.relationshipsDeleted());
68          assertEquals(0, stats.propertiesSet());
69          assertNotNull(stats.queryIntervalExecutionTime());
70          assertEquals(0, resultSet.size());
71          assertFalse(resultSet.iterator().hasNext());
72      }
73      @Test
74      public void testDeleteNodes() {
75          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'roi',age:32})"));
76          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'amit',age:30})"));
77          ResultSet deleteResult = client.graphQuery("social", "MATCH (a:person) WHERE (a.name = 'roi') DELETE a");
78          Statistics delStats = deleteResult.getStatistics();
79          assertEquals(0, delStats.nodesCreated());
80          assertEquals(1, delStats.nodesDeleted());
81          assertEquals(0, delStats.relationshipsCreated());
82          assertEquals(0, delStats.relationshipsDeleted());
83          assertEquals(0, delStats.propertiesSet());
84          assertNotNull(delStats.queryIntervalExecutionTime());
85          assertEquals(0, deleteResult.size());
86          assertFalse(deleteResult.iterator().hasNext());
87          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'roi',age:32})"));
88          assertNotNull(client.graphQuery("social",
89                  "MATCH (a:person), (b:person) WHERE (a.name = 'roi' AND b.name='amit')  CREATE (a)-[:knows]->(a)"));
90          deleteResult = client.graphQuery("social", "MATCH (a:person) WHERE (a.name = 'roi') DELETE a");
91          assertEquals(0, delStats.nodesCreated());
92          assertEquals(1, delStats.nodesDeleted());
93          assertEquals(0, delStats.relationshipsCreated());
94          assertEquals(0, delStats.relationshipsDeleted());
95          assertEquals(0, delStats.propertiesSet());
96          assertNotNull(delStats.queryIntervalExecutionTime());
97          assertEquals(0, deleteResult.size());
98          assertFalse(deleteResult.iterator().hasNext());
99      }
100      @Test
101      public void testDeleteRelationship() {
102          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'roi',age:32})"));
103          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'amit',age:30})"));
104          assertNotNull(client.graphQuery("social",
105                  "MATCH (a:person), (b:person) WHERE (a.name = 'roi' AND b.name='amit')  CREATE (a)-[:knows]->(a)"));
106          ResultSet deleteResult = client.graphQuery("social",
107                  "MATCH (a:person)-[e]->() WHERE (a.name = 'roi') DELETE e");
108          Statistics delStats = deleteResult.getStatistics();
109          assertEquals(0, delStats.nodesCreated());
110          assertEquals(0, delStats.nodesDeleted());
111          assertEquals(0, delStats.relationshipsCreated());
112          assertEquals(1, delStats.relationshipsDeleted());
113          assertEquals(0, delStats.propertiesSet());
114          assertNotNull(delStats.queryIntervalExecutionTime());
115          assertEquals(0, deleteResult.size());
116          assertFalse(deleteResult.iterator().hasNext());
117      }
118      @Test
119      public void testIndex() {
120          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'roi',age:32})"));
121          ResultSet createIndexResult = client.graphQuery("social", "CREATE INDEX ON :person(age)");
122          assertFalse(createIndexResult.iterator().hasNext());
123          assertEquals(1, createIndexResult.getStatistics().indicesCreated());
124          ResultSet createNonExistingIndexResult = client.graphQuery("social", "CREATE INDEX ON :person(age1)");
125          assertFalse(createNonExistingIndexResult.iterator().hasNext());
126          assertEquals(1, createNonExistingIndexResult.getStatistics().indicesCreated());
127          ResultSet createExistingIndexResult = client.graphQuery("social", "CREATE INDEX ON :person(age)");
128          assertFalse(createExistingIndexResult.iterator().hasNext());
129          assertEquals(0, createExistingIndexResult.getStatistics().indicesCreated());
130          ResultSet deleteExistingIndexResult = client.graphQuery("social", "DROP INDEX ON :person(age)");
131          assertFalse(deleteExistingIndexResult.iterator().hasNext());
132          assertEquals(1, deleteExistingIndexResult.getStatistics().indicesDeleted());
133      }
134      @Test
135      public void testHeader() {
136          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'roi',age:32})"));
137          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'amit',age:30})"));
138          assertNotNull(client.graphQuery("social",
139                  "MATCH (a:person), (b:person) WHERE (a.name = 'roi' AND b.name='amit')  CREATE (a)-[:knows]->(a)"));
140          ResultSet queryResult = client.graphQuery("social", "MATCH (a:person)-[r:knows]->(b:person) RETURN a,r, a.age");
141          Header header = queryResult.getHeader();
142          assertNotNull(header);
143          assertEquals("HeaderImpl{"
144                  + "schemaTypes=[SCALAR, SCALAR, SCALAR], "
145                  + "schemaNames=[a, r, a.age]}", header.toString());
146          List<String> schemaNames = header.getSchemaNames();
147          assertNotNull(schemaNames);
148          assertEquals(3, schemaNames.size());
149          assertEquals("a", schemaNames.get(0));
150          assertEquals("r", schemaNames.get(1));
151          assertEquals("a.age", schemaNames.get(2));
152      }
153      @Test
154      public void testRecord() {
155          String name = "roi";
156          int age = 32;
157          double doubleValue = 3.14;
158          boolean boolValue = true;
159          String place = "TLV";
160          int since = 2000;
161          Property<String> nameProperty = new Property<>("name", name);
162          Property<Integer> ageProperty = new Property<>("age", age);
163          Property<Double> doubleProperty = new Property<>("doubleValue", doubleValue);
164          Property<Boolean> trueBooleanProperty = new Property<>("boolValue", true);
165          Property<Boolean> falseBooleanProperty = new Property<>("boolValue", false);
166          Property<String> placeProperty = new Property<>("place", place);
167          Property<Integer> sinceProperty = new Property<>("since", since);
168          Node expectedNode = new Node();
169          expectedNode.setId(0);
170          expectedNode.addLabel("person");
171          expectedNode.addProperty(nameProperty);
172          expectedNode.addProperty(ageProperty);
173          expectedNode.addProperty(doubleProperty);
174          expectedNode.addProperty(trueBooleanProperty);
175          assertEquals(
176                  "Node{labels=[person], id=0, "
177                          + "propertyMap={name=Property{name='name', value=roi}, "
178                          + "boolValue=Property{name='boolValue', value=true}, "
179                          + "doubleValue=Property{name='doubleValue', value=3.14}, "
180                          + "age=Property{name='age', value=32}}}",
181                  expectedNode.toString());
182          Edge expectedEdge = new Edge();
183          expectedEdge.setId(0);
184          expectedEdge.setSource(0);
185          expectedEdge.setDestination(1);
186          expectedEdge.setRelationshipType("knows");
187          expectedEdge.addProperty(placeProperty);
188          expectedEdge.addProperty(sinceProperty);
189          expectedEdge.addProperty(doubleProperty);
190          expectedEdge.addProperty(falseBooleanProperty);
191          assertEquals("Edge{relationshipType='knows', source=0, destination=1, id=0, "
192                  + "propertyMap={boolValue=Property{name='boolValue', value=false}, "
193                  + "place=Property{name='place', value=TLV}, "
194                  + "doubleValue=Property{name='doubleValue', value=3.14}, "
195                  + "since=Property{name='since', value=2000}}}", expectedEdge.toString());
196          Map<String, Object> params = new HashMap<>();
197          params.put("name", name);
198          params.put("age", age);
199          params.put("boolValue", boolValue);
200          params.put("doubleValue", doubleValue);
201          assertNotNull(client.graphQuery("social",
202                  "CREATE (:person{name:$name,age:$age, doubleValue:$doubleValue, boolValue:$boolValue})", params));
203          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'amit',age:30})"));
204          assertNotNull(
205                  client.graphQuery("social", "MATCH (a:person), (b:person) WHERE (a.name = 'roi' AND b.name='amit')  " +
206                          "CREATE (a)-[:knows{place:'TLV', since:2000,doubleValue:3.14, boolValue:false}]->(b)"));
207          ResultSet resultSet = client.graphQuery("social", "MATCH (a:person)-[r:knows]->(b:person) RETURN a,r, " +
208                  "a.name, a.age, a.doubleValue, a.boolValue, " +
209                  "r.place, r.since, r.doubleValue, r.boolValue");
210          assertNotNull(resultSet);
211          Statistics stats = resultSet.getStatistics();
212          assertEquals(0, stats.nodesCreated());
213          assertEquals(0, stats.nodesDeleted());
214          assertEquals(0, stats.labelsAdded());
215          assertEquals(0, stats.propertiesSet());
216          assertEquals(0, stats.relationshipsCreated());
217          assertEquals(0, stats.relationshipsDeleted());
218          assertNotNull(stats.queryIntervalExecutionTime());
219          assertFalse(stats.queryIntervalExecutionTime().isEmpty());
220          assertEquals(1, resultSet.size());
221          Iterator<Record> iterator = resultSet.iterator();
222          assertTrue(iterator.hasNext());
223          Record record = iterator.next();
224          assertFalse(iterator.hasNext());
225          Node node = record.getValue(0);
226          assertNotNull(node);
227          assertEquals(expectedNode, node);
228          node = record.getValue("a");
229          assertEquals(expectedNode, node);
230          Edge edge = record.getValue(1);
231          assertNotNull(edge);
232          assertEquals(expectedEdge, edge);
233          edge = record.getValue("r");
234          assertEquals(expectedEdge, edge);
235          assertEquals(Arrays.asList("a", "r", "a.name", "a.age", "a.doubleValue", "a.boolValue",
236                  "r.place", "r.since", "r.doubleValue", "r.boolValue"), record.keys());
237          assertEquals(Arrays.asList(expectedNode, expectedEdge,
238                  name, (long) age, doubleValue, true,
239                  place, (long) since, doubleValue, false),
240                  record.values());
241          Node a = record.getValue("a");
242          for (String propertyName : expectedNode.getEntityPropertyNames()) {
243              assertEquals(expectedNode.getProperty(propertyName), a.getProperty(propertyName));
244          }
245          assertEquals("roi", record.getString(2));
246          assertEquals("32", record.getString(3));
247          assertEquals(32L, ((Long) record.getValue(3)).longValue());
248          assertEquals(32L, ((Long) record.getValue("a.age")).longValue());
249          assertEquals("roi", record.getString("a.name"));
250          assertEquals("32", record.getString("a.age"));
251      }
252      @Test
253      public void testAdditionToProcedures() {
254          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'roi',age:32})"));
255          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'amit',age:30})"));
256          assertNotNull(client.graphQuery("social",
257                  "MATCH (a:person), (b:person) WHERE (a.name = 'roi' AND b.name='amit')  CREATE (a)-[:knows]->(b)"));
258          Property<String> nameProperty = new Property<>("name", "roi");
259          Property<Integer> ageProperty = new Property<>("age", 32);
260          Property<String> lastNameProperty = new Property<>("lastName", "a");
261          Node expectedNode = new Node();
262          expectedNode.setId(0);
263          expectedNode.addLabel("person");
264          expectedNode.addProperty(nameProperty);
265          expectedNode.addProperty(ageProperty);
266          Edge expectedEdge = new Edge();
267          expectedEdge.setId(0);
268          expectedEdge.setSource(0);
269          expectedEdge.setDestination(1);
270          expectedEdge.setRelationshipType("knows");
271          ResultSet resultSet = client.graphQuery("social", "MATCH (a:person)-[r:knows]->(b:person) RETURN a,r");
272          assertNotNull(resultSet.getHeader());
273          Header header = resultSet.getHeader();
274          List<String> schemaNames = header.getSchemaNames();
275          assertNotNull(schemaNames);
276          assertEquals(2, schemaNames.size());
277          assertEquals("a", schemaNames.get(0));
278          assertEquals("r", schemaNames.get(1));
279          assertEquals(1, resultSet.size());
280          Iterator<Record> iterator = resultSet.iterator();
281          assertTrue(iterator.hasNext());
282          Record record = iterator.next();
283          assertFalse(iterator.hasNext());
284          assertEquals(Arrays.asList("a", "r"), record.keys());
285          assertEquals(Arrays.asList(expectedNode, expectedEdge), record.values());
286          expectedNode.removeProperty("name");
287          expectedNode.removeProperty("age");
288          expectedNode.addProperty(lastNameProperty);
289          expectedNode.removeLabel("person");
290          expectedNode.addLabel("worker");
291          expectedNode.setId(2);
292          expectedEdge.setRelationshipType("worksWith");
293          expectedEdge.setSource(2);
294          expectedEdge.setDestination(3);
295          expectedEdge.setId(1);
296          assertNotNull(client.graphQuery("social", "CREATE (:worker{lastName:'a'})"));
297          assertNotNull(client.graphQuery("social", "CREATE (:worker{lastName:'b'})"));
298          assertNotNull(client.graphQuery("social",
299                  "MATCH (a:worker), (b:worker) WHERE (a.lastName = 'a' AND b.lastName='b')  CREATE (a)-[:worksWith]->(b)"));
300          resultSet = client.graphQuery("social", "MATCH (a:worker)-[r:worksWith]->(b:worker) RETURN a,r");
301          assertNotNull(resultSet.getHeader());
302          header = resultSet.getHeader();
303          schemaNames = header.getSchemaNames();
304          assertNotNull(schemaNames);
305          assertEquals(2, schemaNames.size());
306          assertEquals("a", schemaNames.get(0));
307          assertEquals("r", schemaNames.get(1));
308          assertEquals(1, resultSet.size());
309          iterator = resultSet.iterator();
310          assertTrue(iterator.hasNext());
311          record = iterator.next();
312          assertFalse(iterator.hasNext());
313          assertEquals(Arrays.asList("a", "r"), record.keys());
314          assertEquals(Arrays.asList(expectedNode, expectedEdge), record.values());
315      }
316      @Test
317      public void testEscapedQuery() {
318          Map<String, Object> params1 = new HashMap<String, Object>();
319          params1.put("s1", "S\"'");
320          params1.put("s2", "S'\"");
321          assertNotNull(client.graphQuery("social", "CREATE (:escaped{s1:$s1,s2:$s2})", params1));
322          Map<String, Object> params2 = new HashMap<String, Object>();
323          params2.put("s1", "S\"'");
324          params2.put("s2", "S'\"");
325          assertNotNull(client.graphQuery("social", "MATCH (n) where n.s1=$s1 and n.s2=$s2 RETURN n", params2));
326          assertNotNull(client.graphQuery("social", "MATCH (n) where n.s1='S\"' RETURN n"));
327      }
328      @Test
329      public void testArraySupport() {
330          Node expectedANode = new Node();
331          expectedANode.setId(0);
332          expectedANode.addLabel("person");
333          Property<String> aNameProperty = new Property<>("name", "a");
334          Property<Integer> aAgeProperty = new Property<>("age", 32);
335          Property<List<Long>> aListProperty = new Property<>("array", Arrays.asList(0L, 1L, 2L));
336          expectedANode.addProperty(aNameProperty);
337          expectedANode.addProperty(aAgeProperty);
338          expectedANode.addProperty(aListProperty);
339          Node expectedBNode = new Node();
340          expectedBNode.setId(1);
341          expectedBNode.addLabel("person");
342          Property<String> bNameProperty = new Property<>("name", "b");
343          Property<Integer> bAgeProperty = new Property<>("age", 30);
344          Property<List<Long>> bListProperty = new Property<>("array", Arrays.asList(3L, 4L, 5L));
345          expectedBNode.addProperty(bNameProperty);
346          expectedBNode.addProperty(bAgeProperty);
347          expectedBNode.addProperty(bListProperty);
348          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'a',age:32,array:[0,1,2]})"));
349          assertNotNull(client.graphQuery("social", "CREATE (:person{name:'b',age:30,array:[3,4,5]})"));
350          ResultSet resultSet = client.graphQuery("social", "WITH [0,1,2] as x return x");
351          assertNotNull(resultSet.getHeader());
352          Header header = resultSet.getHeader();
353          List<String> schemaNames = header.getSchemaNames();
354          assertNotNull(schemaNames);
355          assertEquals(1, schemaNames.size());
356          assertEquals("x", schemaNames.get(0));
357          assertEquals(1, resultSet.size());
358          Iterator<Record> iterator = resultSet.iterator();
359          assertTrue(iterator.hasNext());
360          Record record = iterator.next();
361          assertFalse(iterator.hasNext());
362          assertEquals(Arrays.asList("x"), record.keys());
363          List<Long> x = record.getValue("x");
364          assertEquals(Arrays.asList(0L, 1L, 2L), x);
365          resultSet = client.graphQuery("social", "MATCH(n) return collect(n) as x");
366          assertNotNull(resultSet.getHeader());
367          header = resultSet.getHeader();
368          schemaNames = header.getSchemaNames();
369          assertNotNull(schemaNames);
370          assertEquals(1, schemaNames.size());
371          assertEquals("x", schemaNames.get(0));
372          assertEquals(1, resultSet.size());
373          iterator = resultSet.iterator();
374          assertTrue(iterator.hasNext());
375          record = iterator.next();
376          assertFalse(iterator.hasNext());
377          assertEquals(Arrays.asList("x"), record.keys());
378          x = record.getValue("x");
379          assertEquals(Arrays.asList(expectedANode, expectedBNode), x);
380          resultSet = client.graphQuery("social", "unwind([0,1,2]) as x return x");
381          assertNotNull(resultSet.getHeader());
382          header = resultSet.getHeader();
383          schemaNames = header.getSchemaNames();
384          assertNotNull(schemaNames);
385          assertEquals(1, schemaNames.size());
386          assertEquals("x", schemaNames.get(0));
387          assertEquals(3, resultSet.size());
388          iterator = resultSet.iterator();
389          for (long i = 0; i < 3; i++) {
390              assertTrue(iterator.hasNext());
391              record = iterator.next();
392              assertEquals(Arrays.asList("x"), record.keys());
393              assertEquals(i, (long) record.getValue("x"));
394          }
395      }
396      @Test
397      public void testPath() {
398          List<Node> nodes = new ArrayList<>(3);
399          for (int i = 0; i < 3; i++) {
400              Node node = new Node();
401              node.setId(i);
402              node.addLabel("L1");
403              nodes.add(node);
404          }
405          List<Edge> edges = new ArrayList<>(2);
406          for (int i = 0; i < 2; i++) {
407              Edge edge = new Edge();
408              edge.setId(i);
409              edge.setRelationshipType("R1");
410              edge.setSource(i);
411              edge.setDestination(i + 1);
412              edges.add(edge);
413          }
414          Set<Path> expectedPaths = new HashSet<>();
415          Path path01 = new PathBuilder(2).append(nodes.get(0)).append(edges.get(0)).append(nodes.get(1)).build();
416          Path path12 = new PathBuilder(2).append(nodes.get(1)).append(edges.get(1)).append(nodes.get(2)).build();
417          Path path02 = new PathBuilder(3).append(nodes.get(0)).append(edges.get(0)).append(nodes.get(1))
418                  .append(edges.get(1)).append(nodes.get(2)).build();
419          expectedPaths.add(path01);
420          expectedPaths.add(path12);
421          expectedPaths.add(path02);
422          client.graphQuery("social", "CREATE (:L1)-[:R1]->(:L1)-[:R1]->(:L1)");
423          ResultSet resultSet = client.graphQuery("social", "MATCH p = (:L1)-[:R1*]->(:L1) RETURN p");
424          assertEquals(expectedPaths.size(), resultSet.size());
425          Iterator<Record> iterator = resultSet.iterator();
426          for (int i = 0; i < resultSet.size(); i++) {
427              Path p = iterator.next().getValue("p");
428              assertTrue(expectedPaths.contains(p));
429              expectedPaths.remove(p);
430          }
431      }
432      @Test
433      public void testNullGraphEntities() {
434          assertNotNull(client.graphQuery("social", "CREATE (:L)-[:E]->(:L2)"));
435          ResultSet resultSet = client.graphQuery("social", "OPTIONAL MATCH (a:NONEXISTENT)-[e]->(b) RETURN a, e, b");
436          assertEquals(1, resultSet.size());
437          Iterator<Record> iterator = resultSet.iterator();
438          assertTrue(iterator.hasNext());
439          Record record = iterator.next();
440          assertFalse(iterator.hasNext());
441          assertEquals(Arrays.asList(null, null, null), record.values());
442          resultSet = client.graphQuery("social", "MATCH (a) OPTIONAL MATCH (a)-[e]->(b) RETURN a, e, b ORDER BY ID(a)");
443          assertEquals(2, resultSet.size());
444          iterator = resultSet.iterator();
445          record = iterator.next();
446          assertEquals(3, record.size());
447          assertNotNull(record.getValue(0));
448          assertNotNull(record.getValue(1));
449          assertNotNull(record.getValue(2));
450          record = iterator.next();
451          assertEquals(3, record.size());
452          assertNotNull(record.getValue(0));
453          assertNull(record.getValue(1));
454          assertNull(record.getValue(2));
455          resultSet = client.graphQuery("social", "MATCH (a) OPTIONAL MATCH p = (a)-[e]->(b) RETURN p");
456          assertEquals(2, resultSet.size());
457          iterator = resultSet.iterator();
458          record = iterator.next();
459          assertEquals(1, record.size());
460          assertNotNull(record.getValue(0));
461          record = iterator.next();
462          assertEquals(1, record.size());
463          assertNull(record.getValue(0));
464      }
465      @Test
466      public void test64bitnumber() {
467          long value = 1L << 40;
468          Map<String, Object> params = new HashMap<>();
469          params.put("val", value);
470          ResultSet resultSet = client.graphQuery("social", "CREATE (n {val:$val}) RETURN n.val", params);
471          assertEquals(1, resultSet.size());
472          Record r = resultSet.iterator().next();
473          assertEquals(Long.valueOf(value), r.getValue(0));
474      }
475      @Test
476      public void testCachedExecution() {
477          client.graphQuery("social", "CREATE (:N {val:1}), (:N {val:2})");
478          Map<String, Object> params = new HashMap<>();
479          params.put("val", 1L);
480          ResultSet resultSet = client.graphQuery("social", "MATCH (n:N {val:$val}) RETURN n.val", params);
481          assertEquals(1, resultSet.size());
482          Record r = resultSet.iterator().next();
483          assertEquals(params.get("val"), r.getValue(0));
484          assertFalse(resultSet.getStatistics().cachedExecution());
485          for (int i = 0; i < 64; i++) {
486              resultSet = client.graphQuery("social", "MATCH (n:N {val:$val}) RETURN n.val", params);
487          }
488          assertEquals(1, resultSet.size());
489          r = resultSet.iterator().next();
490          assertEquals(params.get("val"), r.getValue(0));
491          assertTrue(resultSet.getStatistics().cachedExecution());
492      }
493      @Test
494      public void testMapDataType() {
495          Map<String, Object> expected = new HashMap<>();
496          expected.put("a", (long) 1);
497          expected.put("b", "str");
498          expected.put("c", null);
499          List<Object> d = new ArrayList<>();
500          d.add((long) 1);
501          d.add((long) 2);
502          d.add((long) 3);
503          expected.put("d", d);
504          expected.put("e", true);
505          Map<String, Object> f = new HashMap<>();
506          f.put("x", (long) 1);
507          f.put("y", (long) 2);
508          expected.put("f", f);
509          ResultSet res = client.graphQuery("social", "RETURN {a:1, b:'str', c:NULL, d:[1,2,3], e:True, f:{x:1, y:2}}");
510          assertEquals(1, res.size());
511          Record r = res.iterator().next();
512          Map<String, Object> actual = r.getValue(0);
513          assertEquals(expected, actual);
514      }
515      @Test
516      public void testGeoPointLatLon() {
517          ResultSet rs = client.graphQuery("social", "CREATE (:restaurant"
518                  + " {location: point({latitude:30.27822306, longitude:-97.75134723})})");
519          assertEquals(1, rs.getStatistics().nodesCreated());
520          assertEquals(1, rs.getStatistics().propertiesSet());
521          assertTestGeoPoint();
522      }
523      @Test
524      public void testGeoPointLonLat() {
525          ResultSet rs = client.graphQuery("social", "CREATE (:restaurant"
526                  + " {location: point({longitude:-97.75134723, latitude:30.27822306})})");
527          assertEquals(1, rs.getStatistics().nodesCreated());
528          assertEquals(1, rs.getStatistics().propertiesSet());
529          assertTestGeoPoint();
530      }
531      private void assertTestGeoPoint() {
532          ResultSet results = client.graphQuery("social", "MATCH (restaurant) RETURN restaurant");
533          assertEquals(1, results.size());
534          Record record = results.iterator().next();
535          assertEquals(1, record.size());
536          assertEquals(Collections.singletonList("restaurant"), record.keys());
537          Node node = record.getValue(0);
538          Property<?> property = node.getProperty("location");
539          assertEquals(new Point(30.27822306, -97.75134723), property.getValue());
540      }
541      @Test
542      public void timeoutArgument() {
543          ResultSet rs = client.graphQuery("social", "UNWIND range(0,100) AS x WITH x AS x WHERE x = 100 RETURN x", 1L);
544          assertEquals(1, rs.size());
545          Record r = rs.iterator().next();
546          assertEquals(Long.valueOf(100), r.getValue(0));
547      }
548      @Test
549      public void testCachedExecutionReadOnly() {
550          client.graphQuery("social", "CREATE (:N {val:1}), (:N {val:2})");
551          Map<String, Object> params = new HashMap<>();
552          params.put("val", 1L);
553          ResultSet resultSet =   client.graphReadonlyQuery("social", "MATCH (n:N {val:$val}) RETURN n.val", params);
554          assertEquals(1, resultSet.size());
555          Record r = resultSet.iterator().next();
556          assertEquals(params.get("val"), r.getValue(0));
557          assertFalse(resultSet.getStatistics().cachedExecution());
558          for (int i = 0; i < 64; i++) {
559              resultSet =   client.graphReadonlyQuery("social", "MATCH (n:N {val:$val}) RETURN n.val", params);
560          }
561          assertEquals(1, resultSet.size());
562          r = resultSet.iterator().next();
563          assertEquals(params.get("val"), r.getValue(0));
564          assertTrue(resultSet.getStatistics().cachedExecution());
565      }
566      @Test
567      public void testSimpleReadOnly() {
568          client.graphQuery("social", "CREATE (:person{name:'filipe',age:30})");
569          ResultSet rsRo = client.graphReadonlyQuery("social", "MATCH (a:person) WHERE (a.name = 'filipe') RETURN a.age");
570          assertEquals(1, rsRo.size());
571          Record r = rsRo.iterator().next();
572          assertEquals(Long.valueOf(30), r.getValue(0));
573      }
574    @Test
575    public void profile() {
576      assertNotNull(client.graphQuery("social", "CREATE (:person{name:'roi',age:32})"));
577      assertNotNull(client.graphQuery("social", "CREATE (:person{name:'amit',age:30})"));
578      List<String> profile = client.graphProfile("social",
579          "MATCH (a:person), (b:person) WHERE (a.name = 'roi' AND b.name='amit')  CREATE (a)-[:knows]->(b)");
580      assertFalse(profile.isEmpty());
581      profile.forEach(Assert::assertNotNull);
582    }
583    @Test
584    public void explain() {
585      assertNotNull(client.graphProfile("social", "CREATE (:person{name:'roi',age:32})"));
586      assertNotNull(client.graphProfile("social", "CREATE (:person{name:'amit',age:30})"));
587      List<String> explain = client.graphExplain("social",
588          "MATCH (a:person), (b:person) WHERE (a.name = 'roi' AND b.name='amit')  CREATE (a)-[:knows]->(b)");
589      assertFalse(explain.isEmpty());
590      explain.forEach(Assert::assertNotNull);
591    }
592    @Test
593    public void slowlog() {
594      assertNotNull(client.graphProfile("social", "CREATE (:person{name:'roi',age:32})"));
595      assertNotNull(client.graphProfile("social", "CREATE (:person{name:'amit',age:30})"));
596      List<List<Object>> slowlogs = client.graphSlowlog("social");
597      assertEquals(2, slowlogs.size());
598      slowlogs.forEach(sl -> assertFalse(sl.isEmpty()));
599      slowlogs.forEach(sl -> sl.forEach(Assert::assertNotNull));
600    }
601    @Test
602    public void list() {
603      assertEquals(Collections.emptyList(), client.graphList());
604      client.graphQuery("social", "CREATE (:person{name:'filipe',age:30})");
605      assertEquals(Collections.singletonList("social"), client.graphList());
606    }
607    @Test
608    public void config() {
609      client.graphQuery("social", "CREATE (:person{name:'filipe',age:30})");
610      final String name = "RESULTSET_SIZE";
611      final Object existingValue = client.graphConfigGet(name).get(name);
612      assertEquals("OK", client.graphConfigSet(name, 250L));
613      assertEquals(Collections.singletonMap(name, 250L), client.graphConfigGet(name));
614      client.graphConfigSet(name, existingValue != null ? existingValue : -1);
615    }
616  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-GraphAPITest.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-GraphAPITest.java</div>
                </div>
                <div class="column column_space"><pre><code>106          ResultSet deleteResult = client.graphQuery("social",
107                  "MATCH (a:person)-[e]->() WHERE (a.name = 'roi') DELETE e");
108          Statistics delStats = deleteResult.getStatistics();
109          assertEquals(0, delStats.nodesCreated());
</pre></code></div>
                <div class="column column_space"><pre><code>50          ResultSet resultSet = client.graphQuery("social", "CREATE (:human{name:'danny',age:12})");
51          Statistics stats = resultSet.getStatistics();
52          assertEquals(1, stats.nodesCreated());
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    