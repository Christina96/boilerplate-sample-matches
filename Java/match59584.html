<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for CompactLinkedHashMapTest.java & PopulatedCachesTest.java</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for CompactLinkedHashMapTest.java & PopulatedCachesTest.java
      </h3>
      <h1 align="center">
        32.7%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>CompactLinkedHashMapTest.java (57.528957%)<TH>PopulatedCachesTest.java (22.85276%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match59584-0.html#0',2,'match59584-1.html#0',3)" NAME="0">(140-152)<TD><A HREF="javascript:ZweiFrames('match59584-0.html#0',2,'match59584-1.html#0',3)" NAME="0">(315-334)</A><TD ALIGN=center><FONT COLOR="#ff0000">19</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match59584-0.html#1',2,'match59584-1.html#1',3)" NAME="1">(186-194)<TD><A HREF="javascript:ZweiFrames('match59584-0.html#1',2,'match59584-1.html#1',3)" NAME="1">(68-73)</A><TD ALIGN=center><FONT COLOR="#e40000">17</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match59584-0.html#2',2,'match59584-1.html#2',3)" NAME="2">(175-183)<TD><A HREF="javascript:ZweiFrames('match59584-0.html#2',2,'match59584-1.html#2',3)" NAME="2">(148-153)</A><TD ALIGN=center><FONT COLOR="#d60000">16</FONT>
<TR><TD BGCOLOR="#53858b"><FONT COLOR="#53858b">-</FONT><TD><A HREF="javascript:ZweiFrames('match59584-0.html#3',2,'match59584-1.html#3',3)" NAME="3">(162-169)<TD><A HREF="javascript:ZweiFrames('match59584-0.html#3',2,'match59584-1.html#3',3)" NAME="3">(130-138)</A><TD ALIGN=center><FONT COLOR="#ae0000">13</FONT>
<TR><TD BGCOLOR="#6cc417"><FONT COLOR="#6cc417">-</FONT><TD><A HREF="javascript:ZweiFrames('match59584-0.html#4',2,'match59584-1.html#4',3)" NAME="4">(15-29)<TD><A HREF="javascript:ZweiFrames('match59584-0.html#4',2,'match59584-1.html#4',3)" NAME="4">(15-29)</A><TD ALIGN=center><FONT COLOR="#ae0000">13</FONT>
<TR><TD BGCOLOR="#151b8d"><FONT COLOR="#151b8d">-</FONT><TD><A HREF="javascript:ZweiFrames('match59584-0.html#5',2,'match59584-1.html#5',3)" NAME="5">(196-201)<TD><A HREF="javascript:ZweiFrames('match59584-0.html#5',2,'match59584-1.html#5',3)" NAME="5">(258-263)</A><TD ALIGN=center><FONT COLOR="#a10000">12</FONT>
<TR><TD BGCOLOR="#8c8774"><FONT COLOR="#8c8774">-</FONT><TD><A HREF="javascript:ZweiFrames('match59584-0.html#6',2,'match59584-1.html#6',3)" NAME="6">(154-158)<TD><A HREF="javascript:ZweiFrames('match59584-0.html#6',2,'match59584-1.html#6',3)" NAME="6">(179-182)</A><TD ALIGN=center><FONT COLOR="#a10000">12</FONT>
<TR><TD BGCOLOR="#38a4a5"><FONT COLOR="#38a4a5">-</FONT><TD><A HREF="javascript:ZweiFrames('match59584-0.html#7',2,'match59584-1.html#7',3)" NAME="7">(170-174)<TD><A HREF="javascript:ZweiFrames('match59584-0.html#7',2,'match59584-1.html#7',3)" NAME="7">(165-168)</A><TD ALIGN=center><FONT COLOR="#930000">11</FONT>
<TR><TD BGCOLOR="#c58917"><FONT COLOR="#c58917">-</FONT><TD><A HREF="javascript:ZweiFrames('match59584-0.html#8',2,'match59584-1.html#8',3)" NAME="8">(119-127)<TD><A HREF="javascript:ZweiFrames('match59584-0.html#8',2,'match59584-1.html#8',3)" NAME="8">(365-370)</A><TD ALIGN=center><FONT COLOR="#780000">9</FONT>
<TR><TD BGCOLOR="#83a33a"><FONT COLOR="#83a33a">-</FONT><TD><A HREF="javascript:ZweiFrames('match59584-0.html#9',2,'match59584-1.html#9',3)" NAME="9">(107-114)<TD><A HREF="javascript:ZweiFrames('match59584-0.html#9',2,'match59584-1.html#9',3)" NAME="9">(229-233)</A><TD ALIGN=center><FONT COLOR="#780000">9</FONT>
<TR><TD BGCOLOR="#ad5910"><FONT COLOR="#ad5910">-</FONT><TD><A HREF="javascript:ZweiFrames('match59584-0.html#10',2,'match59584-1.html#10',3)" NAME="10">(97-104)<TD><A HREF="javascript:ZweiFrames('match59584-0.html#10',2,'match59584-1.html#10',3)" NAME="10">(206-210)</A><TD ALIGN=center><FONT COLOR="#780000">9</FONT>
<TR><TD BGCOLOR="#b041ff"><FONT COLOR="#b041ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match59584-0.html#11',2,'match59584-1.html#11',3)" NAME="11">(88-95)<TD><A HREF="javascript:ZweiFrames('match59584-0.html#11',2,'match59584-1.html#11',3)" NAME="11">(55-61)</A><TD ALIGN=center><FONT COLOR="#780000">9</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>CompactLinkedHashMapTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Copyright (C) 2012 The Guava Authors
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except
 * in compliance with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License
 * is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing permissions and limitations under
<A NAME="4"></A> * the License.
 */

<FONT color="#6cc417"><A HREF="javascript:ZweiFrames('match59584-1.html#4',3,'match59584-top.html#4',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>package com.google.common.collect;

import static com.google.common.truth.Truth.assertThat;

import com.google.common.collect.testing.MapTestSuiteBuilder;
import com.google.common.collect.testing.TestStringMapGenerator;
import com.google.common.collect.testing.features.CollectionFeature;
import com.google.common.collect.testing.features.CollectionSize;
import com.google.common.collect.testing.features.MapFeature;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import junit.framework.Test;
import junit.framework.TestCase;
import</B></FONT> junit.framework.TestSuite;

/**
 * Tests for {@code CompactLinkedHashMap}.
 *
 * @author Louis Wasserman
 */
public class CompactLinkedHashMapTest extends TestCase {
  public static Test suite() {
    TestSuite suite = new TestSuite();
    suite.addTest(
        MapTestSuiteBuilder.using(
                new TestStringMapGenerator() {
                  @Override
                  protected Map&lt;String, String&gt; create(Entry&lt;String, String&gt;[] entries) {
                    Map&lt;String, String&gt; map = CompactLinkedHashMap.create();
                    for (Entry&lt;String, String&gt; entry : entries) {
                      map.put(entry.getKey(), entry.getValue());
                    }
                    return map;
                  }
                })
            .named(&quot;CompactLinkedHashMap&quot;)
            .withFeatures(
                CollectionSize.ANY,
                CollectionFeature.SUPPORTS_ITERATOR_REMOVE,
                MapFeature.GENERAL_PURPOSE,
                MapFeature.ALLOWS_NULL_KEYS,
                MapFeature.ALLOWS_NULL_VALUES,
                CollectionFeature.SERIALIZABLE,
                CollectionFeature.KNOWN_ORDER)
            .createTestSuite());
    suite.addTest(
        MapTestSuiteBuilder.using(
                new TestStringMapGenerator() {
                  @Override
                  protected Map&lt;String, String&gt; create(Entry&lt;String, String&gt;[] entries) {
                    CompactLinkedHashMap&lt;String, String&gt; map = CompactLinkedHashMap.create();
                    map.convertToHashFloodingResistantImplementation();
                    for (Entry&lt;String, String&gt; entry : entries) {
                      map.put(entry.getKey(), entry.getValue());
                    }
                    return map;
                  }
                })
            .named(&quot;CompactLinkedHashMap with flooding resistance&quot;)
            .withFeatures(
                CollectionSize.ANY,
                CollectionFeature.SUPPORTS_ITERATOR_REMOVE,
                MapFeature.GENERAL_PURPOSE,
                MapFeature.ALLOWS_NULL_KEYS,
                MapFeature.ALLOWS_NULL_VALUES,
                CollectionFeature.SERIALIZABLE,
                CollectionFeature.KNOWN_ORDER)
            .createTestSuite());
    suite.addTestSuite(CompactLinkedHashMapTest.class);
<A NAME="11"></A>    return suite;
  }

  public void testInsertionOrder() <FONT color="#b041ff"><A HREF="javascript:ZweiFrames('match59584-1.html#11',3,'match59584-top.html#11',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>{
    Map&lt;Integer, String&gt; map = CompactLinkedHashMap.create();
    map.put(1, &quot;a&quot;);
    map.put(4, &quot;b&quot;);
    map.put(3, &quot;d&quot;);
    map.put(2, &quot;c&quot;);
<A NAME="10"></A>    testHasMapEntriesInOrder(map, 1, &quot;a&quot;, 4, &quot;b&quot;, 3, &quot;d&quot;, 2, &quot;c&quot;);
  }</B></FONT>

  public void testInsertionOrderAfterPutKeyTwice() <FONT color="#ad5910"><A HREF="javascript:ZweiFrames('match59584-1.html#10',3,'match59584-top.html#10',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>{
    Map&lt;Integer, String&gt; map = CompactLinkedHashMap.create();
    map.put(1, &quot;a&quot;);
    map.put(4, &quot;b&quot;);
    map.put(3, &quot;d&quot;);
    map.put(2, &quot;c&quot;);
    map.put(1, &quot;e&quot;);
<A NAME="9"></A>    testHasMapEntriesInOrder</B></FONT>(map, 1, &quot;e&quot;, 4, &quot;b&quot;, 3, &quot;d&quot;, 2, &quot;c&quot;);
  }

  public void testInsertionOrderAfterRemoveFirstEntry() <FONT color="#83a33a"><A HREF="javascript:ZweiFrames('match59584-1.html#9',3,'match59584-top.html#9',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>{
    Map&lt;Integer, String&gt; map = CompactLinkedHashMap.create();
    map.put(1, &quot;a&quot;);
    map.put(4, &quot;b&quot;);
    map.put(3, &quot;d&quot;);
    map.put(2, &quot;c&quot;);
    map.remove(1);
    testHasMapEntriesInOrder</B></FONT>(map, 4, &quot;b&quot;, 3, &quot;d&quot;, 2, &quot;c&quot;);
  }
<A NAME="8"></A>
  public void testInsertionOrderAfterRemoveMiddleEntry() {
    Map&lt;Integer, String&gt; map = CompactLinkedHashMap.create();
    <FONT color="#c58917"><A HREF="javascript:ZweiFrames('match59584-1.html#8',3,'match59584-top.html#8',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>map.put(1, &quot;a&quot;);
    map.put(4, &quot;b&quot;);
    map.put(3, &quot;d&quot;);
    map.put(2, &quot;c&quot;);
    map.remove(4);
    testHasMapEntriesInOrder(map, 1, &quot;a&quot;, 3, &quot;d&quot;, 2, &quot;c&quot;);
  }

  public void testInsertionOrderAfterRem</B></FONT>oveLastEntry() {
    Map&lt;Integer, String&gt; map = CompactLinkedHashMap.create();
    map.put(1, &quot;a&quot;);
    map.put(4, &quot;b&quot;);
    map.put(3, &quot;d&quot;);
    map.put(2, &quot;c&quot;);
    map.remove(2);
    testHasMapEntriesInOrder(map, 1, &quot;a&quot;, 4, &quot;b&quot;, 3, &quot;d&quot;);
  }

<A NAME="0"></A>  public void testTrimToSize() {
    CompactLinkedHashMap&lt;Integer, String&gt; map = CompactLinkedHashMap.createWithExpectedSize(100);
    map.put(1, &quot;a&quot;);
    <FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match59584-1.html#0',3,'match59584-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>map.put(4, &quot;b&quot;);
    map.put(3, &quot;d&quot;);
    map.put(2, &quot;c&quot;);
    map.trimToSize();
    assertThat(map.entries).hasLength(4);
    assertThat(map.keys).hasLength(4);
    assertThat(map.values).hasLength(4);
    assertThat(map.links).hasLength(4);
    assertEquals(4, map.size());
    testHasMapEntriesInOrder(map, 1, &quot;a&quot;, 4, &quot;b&quot;, 3, &quot;d&quot;, 2, &quot;c&quot;);
  }
<A NAME="6"></A>
  private void testHasMapEntriesInOrder(Map&lt;?, ?&gt; map</B></FONT>, Object... alternatingKeysAndValues) {
    List&lt;? extends Entry&lt;?, ?&gt;&gt; entries = Lists.newArrayList(map.entrySet());
    <FONT color="#8c8774"><A HREF="javascript:ZweiFrames('match59584-1.html#6',3,'match59584-top.html#6',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>List&lt;Object&gt; keys = Lists.newArrayList(map.keySet());
    List&lt;Object&gt; values = Lists.newArrayList(map.values());
    assertEquals(2 * entries.size(), alternatingKeysAndValues.length);
    assertEquals(2 * keys.size(), alternatingKeysAndValues.length);
    assertEquals(2 * values.size</B></FONT>(), alternatingKeysAndValues.length);
<A NAME="3"></A>    for (int i = 0; i &lt; map.size(); i++) {
      Object expectedKey = alternatingKeysAndValues[2 * i];
      Object expectedValue = alternatingKeysAndValues[2 * i + 1];
      Entry&lt;Object, Object&gt; expectedEntry = <FONT color="#53858b"><A HREF="javascript:ZweiFrames('match59584-1.html#3',3,'match59584-top.html#3',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>Maps.immutableEntry(expectedKey, expectedValue);
      assertEquals(expectedEntry, entries.get(i));
      assertEquals(expectedKey, keys.get(i));
      assertEquals(expectedValue, values.get(i));
    }
<A NAME="7"></A>  }

  public void testAllocArraysDefault() {</B></FONT>
    <FONT color="#38a4a5"><A HREF="javascript:ZweiFrames('match59584-1.html#7',3,'match59584-top.html#7',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>CompactLinkedHashMap&lt;Integer, String&gt; map = CompactLinkedHashMap.create();
    assertThat(map.needsAllocArrays()).isTrue();
<A NAME="2"></A>    assertThat(map.entries).isNull();
    assertThat(map.keys).isNull();
    assertThat</B></FONT>(map.values).isNull();
    <FONT color="#980517"><A HREF="javascript:ZweiFrames('match59584-1.html#2',3,'match59584-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertThat(map.links).isNull();

    map.put(1, Integer.toString(1));
    assertThat(map.needsAllocArrays()).isFalse();
    assertThat(map.entries).hasLength(CompactHashing.DEFAULT_SIZE);
    assertThat(map.keys).hasLength(CompactHashing.DEFAULT_SIZE);
    assertThat(map.values).hasLength(CompactHashing.DEFAULT_SIZE);
    assertThat(map.links).hasLength(CompactHashing.DEFAULT_SIZE);
<A NAME="1"></A>  }</B></FONT>

  public void testAllocArraysExpectedSize() {
    <FONT color="#f63526"><A HREF="javascript:ZweiFrames('match59584-1.html#1',3,'match59584-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>for (int i = 0; i &lt;= CompactHashing.DEFAULT_SIZE; i++) {
      CompactLinkedHashMap&lt;Integer, String&gt; map = CompactLinkedHashMap.createWithExpectedSize(i);
      assertThat(map.needsAllocArrays()).isTrue();
      assertThat(map.entries).isNull();
      assertThat(map.keys).isNull();
      assertThat(map.values).isNull();
      assertThat(map.links).isNull();
<A NAME="5"></A>
      map.put</B></FONT>(1, Integer.toString(1));
      assertThat(map.needsAllocArrays()).isFalse();
      <FONT color="#151b8d"><A HREF="javascript:ZweiFrames('match59584-1.html#5',3,'match59584-top.html#5',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>int expectedSize = Math.max(1, i);
      assertThat(map.entries).hasLength(expectedSize);
      assertThat(map.keys).hasLength(expectedSize);
      assertThat(map.values).hasLength(expectedSize);
      assertThat(map.links).hasLength(expectedSize);
    }</B></FONT>
  }

}
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>PopulatedCachesTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Copyright (C) 2011 The Guava Authors
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except
 * in compliance with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License
 * is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing permissions and limitations under
<A NAME="4"></A> * the License.
 */

<FONT color="#6cc417"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match59584-0.html#4',2,'match59584-top.html#4',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>package com.google.common.cache;

import static com.google.common.cache.CacheTesting.checkEmpty;
import static com.google.common.cache.CacheTesting.checkValidState;
import static com.google.common.cache.TestingCacheLoaders.identityLoader;
import static com.google.common.truth.Truth.assertThat;
import static java.util.concurrent.TimeUnit.DAYS;
import static java.util.concurrent.TimeUnit.SECONDS;

import com.google.common.base.Function;
import com.google.common.cache.CacheBuilderFactory.DurationSpec;
import com.google.common.cache.LocalCache.Strength;
import com.google.common.collect.ImmutableMap;
import com.google.common.collect.ImmutableSet;
import</B></FONT> com.google.common.collect.Iterables;
import com.google.common.collect.Iterators;
import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import com.google.common.testing.EqualsTester;
import java.util.Collection;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;
import junit.framework.TestCase;

/**
 * {@link LoadingCache} tests that deal with caches that actually contain some key-value mappings.
 *
 * @author mike nonemacher
 */

public class PopulatedCachesTest extends TestCase {
  // we use integers as keys; make sure the range covers some values that ARE cached by
  // Integer.valueOf(int), and some that are not cached. (127 is the highest cached value.)
  static final int WARMUP_MIN = 120;
  static final int WARMUP_MAX = 135;
<A NAME="11"></A>  static final int WARMUP_SIZE = WARMUP_MAX - WARMUP_MIN;

  public void testSize_populated() {
    for (LoadingCache&lt;Object, Object&gt; cache : caches()) <FONT color="#b041ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match59584-0.html#11',2,'match59584-top.html#11',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>{
      // don't let the entries get GCed
      List&lt;Entry&lt;Object, Object&gt;&gt; warmed = warmUp(cache);
      assertEquals(WARMUP_SIZE, cache.size());
      assertMapSize(cache.asMap(), WARMUP_SIZE);
      checkValidState(cache);
    }</B></FONT>
  }

  public void testContainsKey_found() {
<A NAME="1"></A>    for (LoadingCache&lt;Object, Object&gt; cache : caches()) {
      // don't let the entries get GCed
      List&lt;Entry&lt;Object, Object&gt;&gt; warmed = warmUp(cache);
      <FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match59584-0.html#1',2,'match59584-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>for (int i = WARMUP_MIN; i &lt; WARMUP_MAX; i++) {
        Entry&lt;Object, Object&gt; entry = warmed.get(i - WARMUP_MIN);
        assertTrue(cache.asMap().containsKey(entry.getKey()));
        assertTrue(cache.asMap().containsValue(entry.getValue()));
        // this getUnchecked() call shouldn't be a cache miss; verified below
        assertEquals(entry.getValue(), cache.getUnchecked(entry.getKey</B></FONT>()));
      }
      assertEquals(WARMUP_SIZE, cache.stats().missCount());
      checkValidState(cache);
    }
  }

  public void testPut_populated() {
    for (LoadingCache&lt;Object, Object&gt; cache : caches()) {
      // don't let the entries get GCed
      List&lt;Entry&lt;Object, Object&gt;&gt; warmed = warmUp(cache);
      for (int i = WARMUP_MIN; i &lt; WARMUP_MAX; i++) {
        Entry&lt;Object, Object&gt; entry = warmed.get(i - WARMUP_MIN);
        Object newValue = new Object();
        assertSame(entry.getValue(), cache.asMap().put(entry.getKey(), newValue));
        // don't let the new entry get GCed
        warmed.add(entryOf(entry.getKey(), newValue));
        Object newKey = new Object();
        assertNull(cache.asMap().put(newKey, entry.getValue()));
        // this getUnchecked() call shouldn't be a cache miss; verified below
        assertEquals(newValue, cache.getUnchecked(entry.getKey()));
        assertEquals(entry.getValue(), cache.getUnchecked(newKey));
        // don't let the new entry get GCed
        warmed.add(entryOf(newKey, entry.getValue()));
      }
      assertEquals(WARMUP_SIZE, cache.stats().missCount());
      checkValidState(cache);
    }
  }

  public void testPutIfAbsent_populated() {
    for (LoadingCache&lt;Object, Object&gt; cache : caches()) {
      // don't let the entries get GCed
      List&lt;Entry&lt;Object, Object&gt;&gt; warmed = warmUp(cache);
      for (int i = WARMUP_MIN; i &lt; WARMUP_MAX; i++) {
        Entry&lt;Object, Object&gt; entry = warmed.get(i - WARMUP_MIN);
        Object newValue = new Object();
        assertSame(entry.getValue(), cache.asMap().putIfAbsent(entry.getKey(), newValue));
        Object newKey = new Object();
        assertNull(cache.asMap().putIfAbsent(newKey, entry.getValue()));
        // this getUnchecked() call shouldn't be a cache miss; verified below
        assertEquals(entry.getValue(), cache.getUnchecked(entry.getKey()));
        assertEquals(entry.getValue(), cache.getUnchecked(newKey));
        // don't let the new entry get GCed
        warmed.add(entryOf(newKey, entry.getValue()));
      }
      assertEquals(WARMUP_SIZE, cache.stats().missCount());
      checkValidState(cache);
    }
  }

  public void testPutAll_populated() {
    for (LoadingCache&lt;Object, Object&gt; cache : caches()) {
      // don't let the entries get GCed
<A NAME="3"></A>      List&lt;Entry&lt;Object, Object&gt;&gt; warmed = warmUp(cache);
      Object newKey = new Object();
      Object newValue = new Object();
      cache.asMap().putAll(<FONT color="#53858b"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match59584-0.html#3',2,'match59584-top.html#3',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>ImmutableMap.of(newKey, newValue));
      // this getUnchecked() call shouldn't be a cache miss; verified below
      assertEquals(newValue, cache.getUnchecked(newKey));
      assertEquals(WARMUP_SIZE, cache.stats().missCount());
      checkValidState(cache);
    }
  }

  public void testReplace_populated() {</B></FONT>
    for (LoadingCache&lt;Object, Object&gt; cache : caches()) {
      // don't let the entries get GCed
      List&lt;Entry&lt;Object, Object&gt;&gt; warmed = warmUp(cache);
      for (int i = WARMUP_MIN; i &lt; WARMUP_MAX; i++) {
        Entry&lt;Object, Object&gt; entry = warmed.get(i - WARMUP_MIN);
        Object newValue = new Object();
<A NAME="2"></A>        assertSame(entry.getValue(), cache.asMap().replace(entry.getKey(), newValue));
        assertTrue(cache.asMap().replace(entry.getKey(), newValue, entry.getValue()));
        Object newKey = new Object();
        <FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match59584-0.html#2',2,'match59584-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>assertNull(cache.asMap().replace(newKey, entry.getValue()));
        assertFalse(cache.asMap().replace(newKey, entry.getValue(), newValue));
        // this getUnchecked() call shouldn't be a cache miss; verified below
        assertEquals(entry.getValue(), cache.getUnchecked(entry.getKey()));
        assertFalse(cache.asMap().containsKey(newKey));
      }</B></FONT>
      assertEquals(WARMUP_SIZE, cache.stats().missCount());
      checkValidState(cache);
    }
  }

  public void testRemove_byKey() {
    for (LoadingCache&lt;Object, Object&gt; cache : caches()) {
      // don't let the entries get GCed
<A NAME="7"></A>      List&lt;Entry&lt;Object, Object&gt;&gt; warmed = warmUp(cache);
      for (int i = WARMUP_MIN; i &lt; WARMUP_MAX; i++) {
        Entry&lt;Object, Object&gt; entry = warmed.get(i - WARMUP_MIN);
        <FONT color="#38a4a5"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match59584-0.html#7',2,'match59584-top.html#7',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>Object key = entry.getKey();
        assertEquals(entry.getValue(), cache.asMap().remove(key));
        assertNull(cache.asMap().remove(key));
        assertFalse(cache.asMap().containsKey</B></FONT>(key));
      }
      checkEmpty(cache);
    }
  }

  public void testRemove_byKeyAndValue() {
    for (LoadingCache&lt;Object, Object&gt; cache : caches()) {
<A NAME="6"></A>      // don't let the entries get GCed
      List&lt;Entry&lt;Object, Object&gt;&gt; warmed = warmUp(cache);
      for (int i = WARMUP_MIN; i &lt; WARMUP_MAX; i++) {
        <FONT color="#8c8774"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match59584-0.html#6',2,'match59584-top.html#6',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>Object key = warmed.get(i - WARMUP_MIN).getKey();
        Object value = warmed.get(i - WARMUP_MIN).getValue();
        assertFalse(cache.asMap().remove(key, -1));
        assertTrue(cache.asMap</B></FONT>().remove(key, value));
        assertFalse(cache.asMap().remove(key, -1));
        assertFalse(cache.asMap().containsKey(key));
      }
      checkEmpty(cache);
    }
  }


  public void testKeySet_populated() {
    for (LoadingCache&lt;Object, Object&gt; cache : caches()) {
      Set&lt;Object&gt; keys = cache.asMap().keySet();
      List&lt;Entry&lt;Object, Object&gt;&gt; warmed = warmUp(cache);

      Set&lt;Object&gt; expected = Maps.newHashMap(cache.asMap()).keySet();
      assertThat(keys).containsExactlyElementsIn(expected);
      assertThat(keys.toArray()).asList().containsExactlyElementsIn(expected);
      assertThat(keys.toArray(new Object[0])).asList().containsExactlyElementsIn(expected);

      new EqualsTester()
          .addEqualityGroup(cache.asMap().keySet(), keys)
<A NAME="10"></A>          .addEqualityGroup(ImmutableSet.of())
          .testEquals();
      assertEquals(WARMUP_SIZE, keys.size());
      for (int i = WARMUP_MIN; i &lt; WARMUP_MAX; i++) <FONT color="#ad5910"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match59584-0.html#10',2,'match59584-top.html#10',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>{
        Object key = warmed.get(i - WARMUP_MIN).getKey();
        assertTrue(keys.contains(key));
        assertTrue(keys.remove(key));
        assertFalse</B></FONT>(keys.remove(key));
        assertFalse(keys.contains(key));
      }
      checkEmpty(keys);
      checkEmpty(cache);
    }
  }

  public void testValues_populated() {
    for (LoadingCache&lt;Object, Object&gt; cache : caches()) {
      Collection&lt;Object&gt; values = cache.asMap().values();
      List&lt;Entry&lt;Object, Object&gt;&gt; warmed = warmUp(cache);

      Collection&lt;Object&gt; expected = Maps.newHashMap(cache.asMap()).values();
      assertThat(values).containsExactlyElementsIn(expected);
      assertThat(values.toArray()).asList().containsExactlyElementsIn(expected);
<A NAME="9"></A>      assertThat(values.toArray(new Object[0])).asList().containsExactlyElementsIn(expected);

      assertEquals(WARMUP_SIZE, values.size());
      for (int i = WARMUP_MIN; i &lt; WARMUP_MAX; i++) <FONT color="#83a33a"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match59584-0.html#9',2,'match59584-top.html#9',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>{
        Object value = warmed.get(i - WARMUP_MIN).getValue();
        assertTrue(values.contains(value));
        assertTrue(values.remove(value));
        assertFalse</B></FONT>(values.remove(value));
        assertFalse(values.contains(value));
      }
      checkEmpty(values);
      checkEmpty(cache);
    }
  }


  public void testEntrySet_populated() {
    for (LoadingCache&lt;Object, Object&gt; cache : caches()) {
      Set&lt;Entry&lt;Object, Object&gt;&gt; entries = cache.asMap().entrySet();
      List&lt;Entry&lt;Object, Object&gt;&gt; warmed = warmUp(cache, WARMUP_MIN, WARMUP_MAX);

      Set&lt;?&gt; expected = Maps.newHashMap(cache.asMap()).entrySet();
      assertThat(entries).containsExactlyElementsIn(expected);
      assertThat(entries.toArray()).asList().containsExactlyElementsIn(expected);
      assertThat(entries.toArray(new Object[0])).asList().containsExactlyElementsIn(expected);

      new EqualsTester()
          .addEqualityGroup(cache.asMap().entrySet(), entries)
          .addEqualityGroup(ImmutableSet.of())
<A NAME="5"></A>          .testEquals();
      assertEquals(WARMUP_SIZE, entries.size());
      for (int i = WARMUP_MIN; i &lt; WARMUP_MAX; i++) {
        <FONT color="#151b8d"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match59584-0.html#5',2,'match59584-top.html#5',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>Entry&lt;Object, Object&gt; newEntry = warmed.get(i - WARMUP_MIN);
        assertTrue(entries.contains(newEntry));
        assertTrue(entries.remove(newEntry));
        assertFalse(entries.remove(newEntry));
        assertFalse(entries.contains(newEntry));
      }</B></FONT>
      checkEmpty(entries);
      checkEmpty(cache);
    }
  }

  public void testWriteThroughEntry() {
    for (LoadingCache&lt;Object, Object&gt; cache : caches()) {
      cache.getUnchecked(1);
      Entry&lt;Object, Object&gt; entry = Iterables.getOnlyElement(cache.asMap().entrySet());

      cache.invalidate(1);
      assertEquals(0, cache.size());

      entry.setValue(3);
      assertEquals(1, cache.size());
      assertEquals(3, cache.getIfPresent(1));
      checkValidState(cache);

      try {
        entry.setValue(null);
        fail();
      } catch (NullPointerException expected) {
      }
      checkValidState(cache);
    }
  }

  /* ---------------- Local utilities -------------- */

  /** Most of the tests in this class run against every one of these caches. */
  private Iterable&lt;LoadingCache&lt;Object, Object&gt;&gt; caches() {
    // lots of different ways to configure a LoadingCache
    CacheBuilderFactory factory = cacheFactory();
    return Iterables.transform(
        factory.buildAllPermutations(),
        new Function&lt;CacheBuilder&lt;Object, Object&gt;, LoadingCache&lt;Object, Object&gt;&gt;() {
          @Override
          public LoadingCache&lt;Object, Object&gt; apply(CacheBuilder&lt;Object, Object&gt; builder) {
            return builder.recordStats().build(identityLoader());
          }
        });
  }

  private CacheBuilderFactory cacheFactory() {
    // This is trickier than expected. We plan to put 15 values in each of these (WARMUP_MIN to
    // WARMUP_MAX), but the tests assume no values get evicted. Even with a maximumSize of 100, one
    // of the values gets evicted. With weak keys, we use identity equality, which means using
    // System.identityHashCode, which means the assignment of keys to segments is nondeterministic,
<A NAME="0"></A>    // so more than (maximumSize / #segments) keys could get assigned to the same segment, which
    // would cause one to be evicted.
    return new CacheBuilderFactory()
        .withKeyStrengths(<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match59584-0.html#0',2,'match59584-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>ImmutableSet.of(Strength.STRONG, Strength.WEAK))
        .withValueStrengths(ImmutableSet.copyOf(Strength.values()))
        .withConcurrencyLevels(ImmutableSet.of(1, 4, 16, 64))
        .withMaximumSizes(ImmutableSet.of(400, 1000))
        .withInitialCapacities(ImmutableSet.of(0, 1, 10, 100, 1000))
        .withExpireAfterWrites(
            ImmutableSet.of(
                // DurationSpec.of(500, MILLISECONDS),
                DurationSpec.of(1, SECONDS), DurationSpec.of(1, DAYS)))
        .withExpireAfterAccesses(
            ImmutableSet.of(
                // DurationSpec.of(500, MILLISECONDS),
                DurationSpec.of(1, SECONDS), DurationSpec.of(1, DAYS)))
        .withRefreshes(
            ImmutableSet.of(
                // DurationSpec.of(500, MILLISECONDS),
                DurationSpec.of(1, SECONDS), DurationSpec.of(1, DAYS)));
  }

  private List&lt;Entry&lt;Object, Object&gt;&gt; warmUp(LoadingCache&lt;Object, Object&gt; cache</B></FONT>) {
    return warmUp(cache, WARMUP_MIN, WARMUP_MAX);
  }

  /**
   * Returns the entries that were added to the map, so they won't fall out of a map with weak or
   * soft references until the caller drops the reference to the returned entries.
   */
  private List&lt;Entry&lt;Object, Object&gt;&gt; warmUp(
      LoadingCache&lt;Object, Object&gt; cache, int minimum, int maximum) {

    List&lt;Entry&lt;Object, Object&gt;&gt; entries = Lists.newArrayList();
    for (int i = minimum; i &lt; maximum; i++) {
      Object key = i;
      Object value = cache.getUnchecked(key);
      entries.add(entryOf(key, value));
    }
    return entries;
  }

  private Entry&lt;Object, Object&gt; entryOf(Object key, Object value) {
    return Maps.immutableEntry(key, value);
  }

  private void assertMapSize(Map&lt;?, ?&gt; map, int size) {
    assertEquals(size, map.size());
    if (size &gt; 0) {
      assertFalse(map.isEmpty());
<A NAME="8"></A>    } else {
      assertTrue(map.isEmpty());
    }
    <FONT color="#c58917"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match59584-0.html#8',2,'match59584-top.html#8',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>assertCollectionSize(map.keySet(), size);
    assertCollectionSize(map.entrySet(), size);
    assertCollectionSize(map.values(), size);
  }

  private void assertC</B></FONT>ollectionSize(Collection&lt;?&gt; collection, int size) {
    assertEquals(size, collection.size());
    if (size &gt; 0) {
      assertFalse(collection.isEmpty());
    } else {
      assertTrue(collection.isEmpty());
    }
    assertEquals(size, Iterables.size(collection));
    assertEquals(size, Iterators.size(collection.iterator()));
  }
}
</PRE>
</div>
  </div>
</body>
</html>
