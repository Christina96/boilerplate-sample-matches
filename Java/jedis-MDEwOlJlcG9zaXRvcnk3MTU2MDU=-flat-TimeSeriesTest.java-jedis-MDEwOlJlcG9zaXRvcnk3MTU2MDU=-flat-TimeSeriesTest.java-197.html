
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 16, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-TimeSeriesTest.java</h3>
            <pre><code>1  package redis.clients.jedis.modules.timeseries;
2  import static org.junit.Assert.assertEquals;
3  import static org.junit.Assert.assertNotEquals;
4  import static org.junit.Assert.assertNotNull;
5  import static org.junit.Assert.assertNull;
6  import static org.junit.Assert.assertTrue;
7  import static org.junit.Assert.fail;
8  import static redis.clients.jedis.util.AssertUtil.assertEqualsByProtocol;
9  import java.util.*;
10  import org.junit.BeforeClass;
11  import org.junit.Test;
12  import redis.clients.jedis.RedisProtocol;
13  import redis.clients.jedis.exceptions.JedisDataException;
14  import redis.clients.jedis.modules.RedisModuleCommandsTestBase;
15  import redis.clients.jedis.timeseries.*;
16  import redis.clients.jedis.util.KeyValue;
17  public class TimeSeriesTest extends RedisModuleCommandsTestBase {
18    @BeforeClass
19    public static void prepare() {
20      RedisModuleCommandsTestBase.prepare();
21    }
22    @Test
23    public void testCreate() {
24      Map&lt;String, String&gt; labels = new HashMap&lt;&gt;();
25      labels.put(&quot;l1&quot;, &quot;v1&quot;);
26      labels.put(&quot;l2&quot;, &quot;v2&quot;);
27      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series1&quot;, TSCreateParams.createParams().retention(10).labels(labels)));
28      assertEquals(&quot;TSDB-TYPE&quot;, client.type(&quot;series1&quot;));
29      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series2&quot;, TSCreateParams.createParams().labels(labels)));
30      assertEquals(&quot;TSDB-TYPE&quot;, client.type(&quot;series2&quot;));
31      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series3&quot;, TSCreateParams.createParams().retention(10)));
32      assertEquals(&quot;TSDB-TYPE&quot;, client.type(&quot;series3&quot;));
33      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series4&quot;));
34      assertEquals(&quot;TSDB-TYPE&quot;, client.type(&quot;series4&quot;));
35      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series5&quot;, TSCreateParams.createParams().retention(0).uncompressed().labels(labels)));
36      assertEquals(&quot;TSDB-TYPE&quot;, client.type(&quot;series5&quot;));
37      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series6&quot;, TSCreateParams.createParams().retention(7898)
38          .uncompressed().duplicatePolicy(DuplicatePolicy.MAX).labels(labels)));
39      assertEquals(&quot;TSDB-TYPE&quot;, client.type(&quot;series6&quot;));
40      try {
41        assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series1&quot;, TSCreateParams.createParams().retention(10).labels(labels)));
42        fail();
43      } catch (JedisDataException e) {
44      }
45      try {
46        assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series1&quot;, TSCreateParams.createParams().labels(labels)));
47        fail();
48      } catch (JedisDataException e) {
49      }
50      try {
51        assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series1&quot;, TSCreateParams.createParams().retention(10)));
52        fail();
53      } catch (JedisDataException e) {
54      }
55      try {
56        assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series1&quot;));
57        fail();
58      } catch (JedisDataException e) {
59      }
60      try {
61        assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series1&quot;));
62        fail();
63      } catch (JedisDataException e) {
64      }
65      try {
66        assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series7&quot;, TSCreateParams.createParams().retention(7898)
67            .uncompressed().chunkSize(-10).duplicatePolicy(DuplicatePolicy.MAX).labels(labels)));
68        fail();
69      } catch (JedisDataException e) {
70      }
71    }
72    @Test
73    public void testAlter() {
74      Map&lt;String, String&gt; labels = new HashMap&lt;&gt;();
75      labels.put(&quot;l1&quot;, &quot;v1&quot;);
76      labels.put(&quot;l2&quot;, &quot;v2&quot;);
77      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesAlter&quot;, TSCreateParams.createParams().retention(60000).labels(labels)));
78      assertEquals(Collections.emptyList(), client.tsQueryIndex(&quot;l2=v22&quot;));
79      labels.put(&quot;l1&quot;, &quot;v11&quot;);
80      labels.remove(&quot;l2&quot;);
81      labels.put(&quot;l3&quot;, &quot;v33&quot;);
82      assertEquals(&quot;OK&quot;, client.tsAlter(&quot;seriesAlter&quot;, TSAlterParams.alterParams().retention(15000).chunkSize(8192)
83          .duplicatePolicy(DuplicatePolicy.SUM).labels(labels)));
84      TSInfo info = client.tsInfo(&quot;seriesAlter&quot;);
85      assertEquals(Long.valueOf(15000), info.getProperty(&quot;retentionTime&quot;));
86      assertEquals(Long.valueOf(8192), info.getProperty(&quot;chunkSize&quot;));
87      assertEquals(DuplicatePolicy.SUM, info.getProperty(&quot;duplicatePolicy&quot;));
88      assertEquals(&quot;v11&quot;, info.getLabel(&quot;l1&quot;));
89      assertNull(info.getLabel(&quot;l2&quot;));
90      assertEquals(&quot;v33&quot;, info.getLabel(&quot;l3&quot;));
91    }
92    @Test
93    public void testRule() {
94      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;source&quot;));
95      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;dest&quot;, TSCreateParams.createParams().retention(10)));
96      assertEquals(&quot;OK&quot;, client.tsCreateRule(&quot;source&quot;, &quot;dest&quot;, AggregationType.AVG, 100));
97      try {
98        client.tsCreateRule(&quot;source&quot;, &quot;dest&quot;, AggregationType.COUNT, 100);
99        fail();
100      } catch (JedisDataException e) {
101      }
102      assertEquals(&quot;OK&quot;, client.tsDeleteRule(&quot;source&quot;, &quot;dest&quot;));
103      assertEquals(&quot;OK&quot;, client.tsCreateRule(&quot;source&quot;, &quot;dest&quot;, AggregationType.COUNT, 100));
104      try {
105        assertEquals(&quot;OK&quot;, client.tsDeleteRule(&quot;source&quot;, &quot;dest1&quot;));
106        fail();
107      } catch (JedisDataException e) {
108      }
109    }
110    @Test
111    public void testAdd() {
112      Map&lt;String, String&gt; labels = new HashMap&lt;&gt;();
113      labels.put(&quot;l1&quot;, &quot;v1&quot;);
114      labels.put(&quot;l2&quot;, &quot;v2&quot;);
115      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesAdd&quot;, TSCreateParams.createParams().retention(10000).labels(labels)));
116      assertEquals(0, client.tsRange(&quot;seriesAdd&quot;, TSRangeParams.rangeParams()).size());
117      assertEquals(1000L, client.tsAdd(&quot;seriesAdd&quot;, 1000L, 1.1, TSCreateParams.createParams().retention(10000).labels(null)));
118      assertEquals(2000L, client.tsAdd(&quot;seriesAdd&quot;, 2000L, 0.9, TSCreateParams.createParams().labels(null)));
119      assertEquals(3200L, client.tsAdd(&quot;seriesAdd&quot;, 3200L, 1.1, TSCreateParams.createParams().retention(10000)));
120      assertEquals(4500L, client.tsAdd(&quot;seriesAdd&quot;, 4500L, -1.1));
121      TSElement[] rawValues = new TSElement[]{
122        new TSElement(1000L, 1.1),
123        new TSElement(2000L, 0.9),
124        new TSElement(3200L, 1.1),
125        new TSElement(4500L, -1.1)
126      };
127      List&lt;TSElement&gt; values = client.tsRange(&quot;seriesAdd&quot;, 800L, 3000L);
128      assertEquals(2, values.size());
129      assertEquals(Arrays.asList(rawValues[0], rawValues[1]), values);
130      values = client.tsRange(&quot;seriesAdd&quot;, 800L, 5000L);
131      assertEquals(4, values.size());
132      assertEquals(Arrays.asList(rawValues), values);
133      assertEquals(Arrays.asList(rawValues), client.tsRange(&quot;seriesAdd&quot;, TSRangeParams.rangeParams()));
134      List&lt;TSElement&gt; expectedCountValues = Arrays.asList(
135          new TSElement(2000L, 1), new TSElement(3200L, 1), new TSElement(4500L, 1));
136      values = client.tsRange(&quot;seriesAdd&quot;, TSRangeParams.rangeParams(1200L, 4600L).aggregation(AggregationType.COUNT, 1));
137      assertEquals(3, values.size());
138      assertEquals(expectedCountValues, values);
139      List&lt;TSElement&gt; expectedAvgValues = Arrays.asList(
140          new TSElement(0L, 1.1), new TSElement(2000L, 1), new TSElement(4000L, -1.1));
141      values = client.tsRange(&quot;seriesAdd&quot;, TSRangeParams.rangeParams(500L, 4600L).aggregation(AggregationType.AVG, 2000L));
142      assertEquals(3, values.size());
143      assertEquals(expectedAvgValues, values);
144      List&lt;TSElement&gt; valuesZeroBased = client.tsRange(&quot;seriesAdd&quot;,
145          TSRangeParams.rangeParams(0L, 4600L).aggregation(AggregationType.AVG, 2000L));
146      assertEquals(3, valuesZeroBased.size());
147      assertEquals(values, valuesZeroBased);
148      List&lt;TSElement&gt; expectedOverallSumValues = Arrays.asList(new TSElement(0L, 2.0));
149      values = client.tsRange(&quot;seriesAdd&quot;, TSRangeParams.rangeParams(0L, 5000L).aggregation(AggregationType.SUM, 5000L));
150      assertEquals(1, values.size());
151      assertEquals(expectedOverallSumValues, values);
152      List&lt;TSElement&gt; expectedOverallMinValues = Arrays.asList(new TSElement(0L, -1.1));
153      values = client.tsRange(&quot;seriesAdd&quot;, TSRangeParams.rangeParams(0L, 5000L).aggregation(AggregationType.MIN, 5000L));
154      assertEquals(1, values.size());
155      assertEquals(expectedOverallMinValues, values);
156      List&lt;TSElement&gt; expectedOverallMaxValues = Arrays.asList(new TSElement(0L, 1.1));
157      values = client.tsRange(&quot;seriesAdd&quot;, TSRangeParams.rangeParams(0L, 5000L).aggregation(AggregationType.MAX, 5000L));
158      assertEquals(1, values.size());
159      assertEquals(expectedOverallMaxValues, values);
160      assertEquals(Collections.emptyMap(), client.tsMRange(TSMRangeParams.multiRangeParams().filter(&quot;l=v&quot;)));
161      try {
162        client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L).aggregation(AggregationType.COUNT, 1));
163        fail();
164      } catch (IllegalArgumentException e) {
165      }
166      try {
167        client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L).aggregation(AggregationType.COUNT, 1).filter((String) null));
168        fail();
169      } catch (IllegalArgumentException e) {
170      }
171      Map&lt;String, TSMRangeElements&gt; ranges = client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L)
172          .aggregation(AggregationType.COUNT, 1).filter(&quot;l1=v1&quot;));
173      assertEquals(1, ranges.size());
174      TSMRangeElements range = ranges.values().stream().findAny().get();
175      assertEquals(&quot;seriesAdd&quot;, range.getKey());
176      assertEquals(Collections.emptyMap(), range.getLabels());
177      List&lt;TSElement&gt; rangeValues = range.getValue();
178      assertEquals(4, rangeValues.size());
179      assertEquals(new TSElement(1000, 1), rangeValues.get(0));
180      assertNotEquals(new TSElement(1000, 1.1), rangeValues.get(0));
181      assertEquals(2000L, rangeValues.get(1).getTimestamp());
182      assertEquals(&quot;(2000:1.0)&quot;, rangeValues.get(1).toString());
183      Map&lt;String, String&gt; labels2 = new HashMap&lt;&gt;();
184      labels2.put(&quot;l3&quot;, &quot;v3&quot;);
185      labels2.put(&quot;l4&quot;, &quot;v4&quot;);
186      assertEquals(1000L, client.tsAdd(&quot;seriesAdd2&quot;, 1000L, 1.1, TSCreateParams.createParams().retention(10000).labels(labels2)));
187      Map&lt;String, TSMRangeElements&gt; ranges2 = client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L)
188          .aggregation(AggregationType.COUNT, 1).withLabels().filter(&quot;l4=v4&quot;));
189      assertEquals(1, ranges2.size());
190      TSMRangeElements elements2 = ranges2.values().stream().findAny().get();
191      assertEquals(labels2, elements2.getLabels());
192      assertEqualsByProtocol(protocol, null, Arrays.asList(AggregationType.COUNT), elements2.getAggregators());
193      Map&lt;String, String&gt; labels3 = new HashMap&lt;&gt;();
194      labels3.put(&quot;l3&quot;, &quot;v33&quot;);
195      labels3.put(&quot;l4&quot;, &quot;v4&quot;);
196      assertEquals(1000L, client.tsAdd(&quot;seriesAdd3&quot;, 1000L, 1.1, TSCreateParams.createParams().labels(labels3)));
197      assertEquals(2000L, client.tsAdd(&quot;seriesAdd3&quot;, 2000L, 1.1, TSCreateParams.createParams().labels(labels3)));
198      assertEquals(3000L, client.tsAdd(&quot;seriesAdd3&quot;, 3000L, 1.1, TSCreateParams.createParams().labels(labels3)));
199      Map&lt;String, TSMRangeElements&gt; ranges3 = client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L)
200          .aggregation(AggregationType.AVG, 1L).withLabels(true).count(2).filter(&quot;l4=v4&quot;));
201      assertEquals(2, ranges3.size());
202      ArrayList&lt;TSMRangeElements&gt; ranges3List = new ArrayList&lt;&gt;(ranges3.values());
203      assertEquals(1, ranges3List.get(0).getValue().size());
204      assertEquals(labels2, ranges3List.get(0).getLabels());
205      assertEqualsByProtocol(protocol, null, Arrays.asList(AggregationType.AVG), ranges3List.get(0).getAggregators());
206      assertEquals(2, ranges3List.get(1).getValue().size());
207      assertEquals(labels3, ranges3List.get(1).getLabels());
208      assertEqualsByProtocol(protocol, null, Arrays.asList(AggregationType.AVG), ranges3List.get(1).getAggregators());
209      assertEquals(800L, client.tsAdd(&quot;seriesAdd&quot;, 800L, 1.1));
210      assertEquals(700L, client.tsAdd(&quot;seriesAdd&quot;, 700L, 1.1, TSCreateParams.createParams().retention(10000)));
211      assertEquals(600L, client.tsAdd(&quot;seriesAdd&quot;, 600L, 1.1, TSCreateParams.createParams().retention(10000).labels(null)));
212      assertEquals(400L, client.tsAdd(&quot;seriesAdd4&quot;, 400L, 0.4, TSCreateParams.createParams()
213          .retention(7898L).uncompressed().chunkSize(1000L).duplicatePolicy(DuplicatePolicy.SUM)
214          .labels(labels)));
215      assertEquals(&quot;TSDB-TYPE&quot;, client.type(&quot;seriesAdd4&quot;));
216      assertEquals(400L, client.tsAdd(&quot;seriesAdd4&quot;, 400L, 0.3, TSCreateParams.createParams()
217          .retention(7898L).uncompressed().chunkSize(1000L).duplicatePolicy(DuplicatePolicy.SUM)
218          .labels(labels)));
219      assertEquals(Arrays.asList(new TSElement(400L, 0.7)), client.tsRange(&quot;seriesAdd4&quot;, 0L, Long.MAX_VALUE));
220      try {
221        client.tsRange(&quot;seriesAdd1&quot;, TSRangeParams.rangeParams(500L, 4000L).aggregation(AggregationType.COUNT, 1));
222        fail();
223      } catch (JedisDataException e) {
224      }
225    }
226    @Test
227    public void issue75() {
228      client.tsMRange(TSMRangeParams.multiRangeParams().filter(&quot;id=1&quot;));
229    }
230    @Test
231    public void del() {
232      try {
233        client.tsDel(&quot;ts-del&quot;, 0, 1);
234        fail();
235      } catch (JedisDataException jde) {
236      }
237      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;ts-del&quot;, TSCreateParams.createParams().retention(10000L)));
238      assertEquals(0, client.tsDel(&quot;ts-del&quot;, 0, 1));
239      assertEquals(1000L, client.tsAdd(&quot;ts-del&quot;, 1000L, 1.1, TSCreateParams.createParams().retention(10000)));
240      assertEquals(2000L, client.tsAdd(&quot;ts-del&quot;, 2000L, 0.9));
241      assertEquals(3200L, client.tsAdd(&quot;ts-del&quot;, 3200L, 1.1, TSCreateParams.createParams().retention(10000)));
242      assertEquals(4500L, client.tsAdd(&quot;ts-del&quot;, 4500L, -1.1));
243      assertEquals(4, client.tsRange(&quot;ts-del&quot;, 0, 5000).size());
244      assertEquals(2, client.tsDel(&quot;ts-del&quot;, 2000, 4000));
245      assertEquals(2, client.tsRange(&quot;ts-del&quot;, 0, 5000).size());
246      assertEquals(1, client.tsRange(&quot;ts-del&quot;, 0, 2500).size());
247      assertEquals(1, client.tsRange(&quot;ts-del&quot;, 2500, 5000).size());
248    }
249    @Test
250    public void testValue() {
251      TSElement v = new TSElement(1234, 234.89634);
252      assertEquals(1234, v.getTimestamp());
253      assertEquals(234.89634, v.getValue(), 0);
254      assertEquals(v, new TSElement(1234, 234.89634));
255      assertNotEquals(v, new TSElement(1334, 234.89634));
256      assertNotEquals(v, new TSElement(1234, 234.8934));
257      assertNotEquals(1234, v.getValue());
258      assertEquals(&quot;(1234:234.89634)&quot;, v.toString());
259      assertEquals(-1856719580, v.hashCode());
260    }
261    @Test
262    public void testAddStar() throws InterruptedException {
263      Map&lt;String, String&gt; labels = new HashMap&lt;&gt;();
264      labels.put(&quot;l11&quot;, &quot;v11&quot;);
265      labels.put(&quot;l22&quot;, &quot;v22&quot;);
266      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesAdd2&quot;, TSCreateParams.createParams().retention(10000L).labels(labels)));
267      long startTime = System.currentTimeMillis();
268      Thread.sleep(1);
269      long add1 = client.tsAdd(&quot;seriesAdd2&quot;, 1.1);
270      assertTrue(add1 &gt; startTime);
271      Thread.sleep(1);
272      long add2 = client.tsAdd(&quot;seriesAdd2&quot;, 3.2);
273      assertTrue(add2 &gt; add1);
274      Thread.sleep(1);
275      long add3 = client.tsAdd(&quot;seriesAdd2&quot;, 3.2);
276      assertTrue(add3 &gt; add2);
277      Thread.sleep(1);
278      long add4 = client.tsAdd(&quot;seriesAdd2&quot;, -1.2);
279      assertTrue(add4 &gt; add3);
280      Thread.sleep(1);
281      long endTime = System.currentTimeMillis();
282      assertTrue(endTime &gt; add4);
283      List&lt;TSElement&gt; values = client.tsRange(&quot;seriesAdd2&quot;, startTime, add3);
284      assertEquals(3, values.size());
285    }
286    @Test
287    public void testMadd() {
288      Map&lt;String, String&gt; labels = new HashMap&lt;&gt;();
289      labels.put(&quot;l1&quot;, &quot;v1&quot;);
290      labels.put(&quot;l2&quot;, &quot;v2&quot;);
291      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesAdd1&quot;, TSCreateParams.createParams().retention(10000L).labels(labels)));
292      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesAdd2&quot;, TSCreateParams.createParams().retention(10000L).labels(labels)));
293      List&lt;Long&gt; result = client.tsMAdd(
294          new KeyValue&lt;&gt;(&quot;seriesAdd1&quot;, new TSElement(1000L, 1.1)),
295          new KeyValue&lt;&gt;(&quot;seriesAdd2&quot;, new TSElement(2000L, 3.2)),
296          new KeyValue&lt;&gt;(&quot;seriesAdd1&quot;, new TSElement(1500L, 2.67)),
297          new KeyValue&lt;&gt;(&quot;seriesAdd2&quot;, new TSElement(3200L, 54.2)),
298          new KeyValue&lt;&gt;(&quot;seriesAdd2&quot;, new TSElement(4300L, 21.2)));
299      assertEquals(1000L, result.get(0).longValue());
300      assertEquals(2000L, result.get(1).longValue());
301      assertEquals(1500L, result.get(2).longValue());
302      assertEquals(3200L, result.get(3).longValue());
303      assertEquals(4300L, result.get(4).longValue());
304      List&lt;TSElement&gt; values1 = client.tsRange(&quot;seriesAdd1&quot;, 0, Long.MAX_VALUE);
305      assertEquals(2, values1.size());
306      assertEquals(1.1, values1.get(0).getValue(), 0.001);
307      assertEquals(2.67, values1.get(1).getValue(), 0.001);
308      List&lt;TSElement&gt; values2 = client.tsRange(&quot;seriesAdd2&quot;, TSRangeParams.rangeParams(0, Long.MAX_VALUE).count(2));
309      assertEquals(2, values2.size());
310      assertEquals(3.2, values2.get(0).getValue(), 0.001);
311      assertEquals(54.2, values2.get(1).getValue(), 0.001);
312    }
313    @Test
314    public void testIncrByDecrBy() throws InterruptedException {
315      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesIncDec&quot;,
316          TSCreateParams.createParams().retention(100 * 1000 &amp;bsol;*100 sec*/)));
317      assertEquals(1L, client.tsAdd(&quot;seriesIncDec&quot;, 1L, 1), 0);
318      assertEquals(2L, client.tsIncrBy(&quot;seriesIncDec&quot;, 3, 2L), 0);
319      assertEquals(3L, client.tsDecrBy(&quot;seriesIncDec&quot;, 2, 3L), 0);
320      List&lt;TSElement&gt; values = client.tsRange(&quot;seriesIncDec&quot;, 1L, 3L);
321      assertEquals(3, values.size());
322      assertEquals(2, values.get(2).getValue(), 0);
323      assertEquals(3L, client.tsDecrBy(&quot;seriesIncDec&quot;, 2, 3L), 0);
324      values = client.tsRange(&quot;seriesIncDec&quot;, 1L, Long.MAX_VALUE);
325      assertEquals(3, values.size());
326      client.tsIncrBy(&quot;seriesIncDec&quot;, 100);
327      client.tsDecrBy(&quot;seriesIncDec&quot;, 33);
328    }
329    @Test
330    public void align() {
331      client.tsAdd(&quot;align&quot;, 1, 10d);
332      client.tsAdd(&quot;align&quot;, 3, 5d);
333      client.tsAdd(&quot;align&quot;, 11, 10d);
334      client.tsAdd(&quot;align&quot;, 25, 11d);
335      List&lt;TSElement&gt; values = client.tsRange(&quot;align&quot;, TSRangeParams.rangeParams(1L, 30L).aggregation(AggregationType.COUNT, 10));
336      assertEquals(Arrays.asList(new TSElement(1, 2), new TSElement(11, 1), new TSElement(21, 1)), values);
337      values = client.tsRange(&quot;align&quot;, TSRangeParams.rangeParams(1L, 30L).alignStart().aggregation(AggregationType.COUNT, 10));
338      assertEquals(Arrays.asList(new TSElement(1, 2), new TSElement(11, 1), new TSElement(21, 1)), values);
339      values = client.tsRange(&quot;align&quot;, TSRangeParams.rangeParams(1L, 30L).alignEnd().aggregation(AggregationType.COUNT, 10));
340      assertEquals(Arrays.asList(new TSElement(1, 2), new TSElement(11, 1), new TSElement(21, 1)), values);
341      values =
342          client.tsRange(&quot;align&quot;, TSRangeParams.rangeParams(1L, 30L).align(5).aggregation(AggregationType.COUNT, 10));
343      assertEquals(Arrays.asList(new TSElement(1, 2), new TSElement(11, 1), new TSElement(21, 1)), values);
344    }
345    @Test
346    public void rangeFilterBy() {
347      TSElement[] rawValues =
348          new TSElement[] {
349            new TSElement(1000L, 1.0),
350            new TSElement(2000L, 0.9),
351            new TSElement(3200L, 1.1),
352            new TSElement(4500L, -1.1)
353          };
354      for (TSElement value : rawValues) {
355        client.tsAdd(&quot;filterBy&quot;, value.getTimestamp(), value.getValue());
356      }
357      List&lt;TSElement&gt; values = client.tsRange(&quot;filterBy&quot;, 0L, 5000L);
358      assertEquals(Arrays.asList(rawValues), values);
359      values = client.tsRange(&quot;filterBy&quot;, TSRangeParams.rangeParams(0L, 5000L).filterByTS(1000L, 2000L));
360      assertEquals(Arrays.asList(rawValues[0], rawValues[1]), values);
361      values = client.tsRange(&quot;filterBy&quot;, TSRangeParams.rangeParams(0L, 5000L).filterByValues(1.0, 1.2));
362      assertEquals(Arrays.asList(rawValues[0], rawValues[2]), values);
363      values = client.tsRange(&quot;filterBy&quot;, TSRangeParams.rangeParams(0L, 5000L).filterByTS(1000L, 2000L).filterByValues(1.0, 1.2));
364      assertEquals(Arrays.asList(rawValues[0]), values);
365      values = client.tsRevRange(&quot;filterBy&quot;, 0L, 5000L);
366      assertEquals(Arrays.asList(rawValues[3], rawValues[2], rawValues[1], rawValues[0]), values);
367      values =
368          client.tsRevRange(&quot;filterBy&quot;, TSRangeParams.rangeParams(0L, 5000L).filterByTS(1000L, 2000L));
369      assertEquals(Arrays.asList(rawValues[1], rawValues[0]), values);
370      values =
371          client.tsRevRange(&quot;filterBy&quot;, TSRangeParams.rangeParams(0L, 5000L).filterByValues(1.0, 1.2));
372      assertEquals(Arrays.asList(rawValues[2], rawValues[0]), values);
373      values =
374          client.tsRevRange(&quot;filterBy&quot;, TSRangeParams.rangeParams(0L, 5000L).filterByTS(1000L, 2000L).filterByValues(1.0, 1.2));
375      assertEquals(Arrays.asList(rawValues[0]), values);
376    }
377    @Test
378    public void mrangeFilterBy() {
379      Map&lt;String, String&gt; labels = Collections.singletonMap(&quot;label&quot;, &quot;multi&quot;);
380      client.tsCreate(&quot;ts1&quot;, TSCreateParams.createParams().labels(labels));
381      client.tsCreate(&quot;ts2&quot;, TSCreateParams.createParams().labels(labels));
382      String filter = &quot;label=multi&quot;;
383      TSElement[] rawValues = new TSElement[]{
384        new TSElement(1000L, 1.0),
385        new TSElement(2000L, 0.9),
386        new TSElement(3200L, 1.1),
387        new TSElement(4500L, -1.1)
388      };
389      client.tsAdd(&quot;ts1&quot;, rawValues[0].getTimestamp(), rawValues[0].getValue());
390      client.tsAdd(&quot;ts2&quot;, rawValues[1].getTimestamp(), rawValues[1].getValue());
391      client.tsAdd(&quot;ts2&quot;, rawValues[2].getTimestamp(), rawValues[2].getValue());
392      client.tsAdd(&quot;ts1&quot;, rawValues[3].getTimestamp(), rawValues[3].getValue());
393      Map&lt;String, TSMRangeElements&gt; range = client.tsMRange(0L, 5000L, filter);
394      ArrayList&lt;TSMRangeElements&gt; rangeList = new ArrayList&lt;&gt;(range.values());
395      assertEquals(&quot;ts1&quot;, rangeList.get(0).getKey());
396      assertEquals(Arrays.asList(rawValues[0], rawValues[3]), rangeList.get(0).getValue());
397      assertEquals(&quot;ts2&quot;, rangeList.get(1).getKey());
398      assertEquals(Arrays.asList(rawValues[1], rawValues[2]), rangeList.get(1).getValue());
399      range = client.tsMRange(TSMRangeParams.multiRangeParams(0L, 5000L).filterByTS(1000L, 2000L).filter(filter));
400      rangeList = new ArrayList&lt;&gt;(range.values());
401      assertEquals(&quot;ts1&quot;, rangeList.get(0).getKey());
402      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
403      assertEquals(&quot;ts2&quot;, rangeList.get(1).getKey());
404      assertEquals(Arrays.asList(rawValues[1]), rangeList.get(1).getValue());
405      range = client.tsMRange(TSMRangeParams.multiRangeParams(0L, 5000L).filterByValues(1.0, 1.2).filter(filter));
406      rangeList = new ArrayList&lt;&gt;(range.values());
407      assertEquals(&quot;ts1&quot;, rangeList.get(0).getKey());
408      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
409      assertEquals(&quot;ts2&quot;, rangeList.get(1).getKey());
410      assertEquals(Arrays.asList(rawValues[2]), rangeList.get(1).getValue());
411      range = client.tsMRange(TSMRangeParams.multiRangeParams(0L, 5000L)
412          .filterByTS(1000L, 2000L).filterByValues(1.0, 1.2).filter(filter));
413      rangeList = new ArrayList&lt;&gt;(range.values());
414      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
415      range = client.tsMRevRange(0L, 5000L,  filter);
416      rangeList = new ArrayList&lt;&gt;(range.values());
417      assertEquals(&quot;ts1&quot;, rangeList.get(0).getKey());
418      assertEquals(Arrays.asList(rawValues[3], rawValues[0]), rangeList.get(0).getValue());
419      assertEquals(&quot;ts2&quot;, rangeList.get(1).getKey());
420      assertEquals(Arrays.asList(rawValues[2], rawValues[1]), rangeList.get(1).getValue());
421      range = client.tsMRevRange(TSMRangeParams.multiRangeParams(0L, 5000L).filterByTS(1000L, 2000L).filter(filter));
422      rangeList = new ArrayList&lt;&gt;(range.values());
423      assertEquals(&quot;ts1&quot;, rangeList.get(0).getKey());
424      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
425      assertEquals(&quot;ts2&quot;, rangeList.get(1).getKey());
426      assertEquals(Arrays.asList(rawValues[1]), rangeList.get(1).getValue());
427      range = client.tsMRevRange(TSMRangeParams.multiRangeParams(0L, 5000L).filterByValues(1.0, 1.2).filter(filter));
428      rangeList = new ArrayList&lt;&gt;(range.values());
429      assertEquals(&quot;ts1&quot;, rangeList.get(0).getKey());
430      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
431      assertEquals(&quot;ts2&quot;, rangeList.get(1).getKey());
432      assertEquals(Arrays.asList(rawValues[2]), rangeList.get(1).getValue());
433      range = client.tsMRevRange(TSMRangeParams.multiRangeParams(0L, 5000L)
434          .filterByTS(1000L, 2000L).filterByValues(1.0, 1.2).filter(filter));
435      rangeList = new ArrayList&lt;&gt;(range.values());
436      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
437    }
438    @Test
439    public void groupByReduce() {
440      client.tsCreate(&quot;ts1&quot;, TSCreateParams.createParams().labels(convertMap(&quot;metric&quot;, &quot;cpu&quot;, &quot;metric_name&quot;, &quot;system&quot;)));
441      client.tsCreate(&quot;ts2&quot;, TSCreateParams.createParams().labels(convertMap(&quot;metric&quot;, &quot;cpu&quot;, &quot;metric_name&quot;, &quot;user&quot;)));
442      client.tsAdd(&quot;ts1&quot;, 1L, 90.0);
443      client.tsAdd(&quot;ts1&quot;, 2L, 45.0);
444      client.tsAdd(&quot;ts2&quot;, 2L, 99.0);
445      Map&lt;String, TSMRangeElements&gt; range = client.tsMRange(TSMRangeParams.multiRangeParams(0L, 100L).withLabels()
446          .filter(&quot;metric=cpu&quot;).groupBy(&quot;metric_name&quot;, &quot;max&quot;));
447      assertEquals(2, range.size());
448      ArrayList&lt;TSMRangeElements&gt; rangeList = new ArrayList&lt;&gt;(range.values());
449      assertEquals(&quot;metric_name=system&quot;, rangeList.get(0).getKey());
450      assertEquals(&quot;system&quot;, rangeList.get(0).getLabels().get(&quot;metric_name&quot;));
451      if (protocol != RedisProtocol.RESP3) {
452        assertEquals(&quot;max&quot;, rangeList.get(0).getLabels().get(&quot;__reducer__&quot;));
453        assertEquals(&quot;ts1&quot;, rangeList.get(0).getLabels().get(&quot;__source__&quot;));
454      } else {
455        assertEquals(Arrays.asList(&quot;max&quot;), rangeList.get(0).getReducers());
456        assertEquals(Arrays.asList(&quot;ts1&quot;), rangeList.get(0).getSources());
457      }
458      assertEquals(Arrays.asList(new TSElement(1, 90), new TSElement(2, 45)), rangeList.get(0).getValue());
459      assertEquals(&quot;metric_name=user&quot;, rangeList.get(1).getKey());
460      assertEquals(&quot;user&quot;, rangeList.get(1).getLabels().get(&quot;metric_name&quot;));
461      if (protocol != RedisProtocol.RESP3) {
462        assertEquals(&quot;max&quot;, rangeList.get(1).getLabels().get(&quot;__reducer__&quot;));
463        assertEquals(&quot;ts2&quot;, rangeList.get(1).getLabels().get(&quot;__source__&quot;));
464      } else {
465        assertEquals(Arrays.asList(&quot;max&quot;), rangeList.get(1).getReducers());
466        assertEquals(Arrays.asList(&quot;ts2&quot;), rangeList.get(1).getSources());
467      }
468      assertEquals(Arrays.asList(new TSElement(2, 99)), rangeList.get(1).getValue());
469    }
470    private Map&lt;String, String&gt; convertMap(String... array) {
471      Map&lt;String, String&gt; map = new HashMap&lt;&gt;(array.length / 2);
472      for (int i = 0; i &lt; array.length; i += 2) {
473        map.put(array[i], array[i + 1]);
474      }
475      return map;
476    }
477    @Test
478    public void testGet() {
479      try {
480        client.tsGet(&quot;seriesGet&quot;);
481        fail();
482      } catch (JedisDataException e) {
483      }
484      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesGet&quot;, TSCreateParams.createParams()
485          .retention(100 * 1000 &amp;bsol;*100sec retentionTime*/)));
486      assertNull(client.tsGet(&quot;seriesGet&quot;));
487      client.tsAdd(&quot;seriesGet&quot;, 2558, 8.7);
488      assertEquals(new TSElement(2558, 8.7), client.tsGet(&quot;seriesGet&quot;));
489      client.tsAdd(&quot;seriesGet&quot;, 3458, 1.117);
490      assertEquals(new TSElement(3458, 1.117), client.tsGet(&quot;seriesGet&quot;));
491    }
492    @Test
493    public void testMGet() {
494      Map&lt;String, String&gt; labels = new HashMap&lt;&gt;();
495      labels.put(&quot;l1&quot;, &quot;v1&quot;);
496      labels.put(&quot;l2&quot;, &quot;v2&quot;);
497      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesMGet1&quot;, TSCreateParams.createParams()
498          .retention(100 * 1000 &amp;bsol;*100sec retentionTime*/).labels(labels)));
499      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesMGet2&quot;, TSCreateParams.createParams()
500          .retention(100 * 1000 &amp;bsol;*100sec retentionTime*/).labels(labels)));
501      Map&lt;String, TSMGetElement&gt; ranges1 = client.tsMGet(TSMGetParams.multiGetParams().withLabels(false), &quot;l1=v2&quot;);
502      assertEquals(0, ranges1.size());
503      Map&lt;String, TSMGetElement&gt; ranges2 = client.tsMGet(TSMGetParams.multiGetParams().withLabels(true), &quot;l1=v1&quot;);
504      assertEquals(2, ranges2.size());
505      ArrayList&lt;TSMGetElement&gt; ranges2List = new ArrayList&lt;&gt;(ranges2.values());
506      assertEquals(labels, ranges2List.get(0).getLabels());
507      assertEquals(labels, ranges2List.get(1).getLabels());
508      assertNull(ranges2List.get(0).getValue());
509      client.tsAdd(&quot;seriesMGet1&quot;, 1500, 1.3);
510      Map&lt;String, TSMGetElement&gt; ranges3 = client.tsMGet(TSMGetParams.multiGetParams().withLabels(false), &quot;l1=v1&quot;);
511      assertEquals(2, ranges3.size());
512      ArrayList&lt;TSMGetElement&gt; ranges3List = new ArrayList&lt;&gt;(ranges3.values());
513      assertEquals(Collections.emptyMap(), ranges3List.get(0).getLabels());
514      assertEquals(Collections.emptyMap(), ranges3List.get(1).getLabels());
515      assertEquals(new TSElement(1500, 1.3), ranges3List.get(0).getValue());
516      assertNull(ranges3List.get(1).getValue());
517    }
518    @Test
519    public void testQueryIndex() {
520      Map&lt;String, String&gt; labels = new HashMap&lt;&gt;();
521      labels.put(&quot;l1&quot;, &quot;v1&quot;);
522      labels.put(&quot;l2&quot;, &quot;v2&quot;);
523      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesQueryIndex1&quot;, TSCreateParams.createParams()
524          .retention(100 * 1000 &amp;bsol;*100sec retentionTime*/).labels(labels)));
525      labels.put(&quot;l2&quot;, &quot;v22&quot;);
526      labels.put(&quot;l3&quot;, &quot;v33&quot;);
527      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesQueryIndex2&quot;, TSCreateParams.createParams()
528          .retention(100 * 1000 &amp;bsol;*100sec retentionTime*/).labels(labels)));
529      assertEquals(Arrays.&lt;String&gt;asList(), client.tsQueryIndex(&quot;l1=v2&quot;));
530      assertEquals(Arrays.asList(&quot;seriesQueryIndex1&quot;, &quot;seriesQueryIndex2&quot;), client.tsQueryIndex(&quot;l1=v1&quot;));
531      assertEquals(Arrays.asList(&quot;seriesQueryIndex2&quot;), client.tsQueryIndex(&quot;l2=v22&quot;));
532    }
533    @Test
534    public void testInfo() {
535      Map&lt;String, String&gt; labels = new HashMap&lt;&gt;();
536      labels.put(&quot;l1&quot;, &quot;v1&quot;);
537      labels.put(&quot;l2&quot;, &quot;v2&quot;);
538      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;source&quot;, TSCreateParams.createParams().retention(10000L).labels(labels)));
539      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;dest&quot;, TSCreateParams.createParams().retention(20000L)));
540      assertEquals(&quot;OK&quot;, client.tsCreateRule(&quot;source&quot;, &quot;dest&quot;, AggregationType.AVG, 100));
541      TSInfo info = client.tsInfo(&quot;source&quot;);
542      assertEquals((Long) 10000L, info.getProperty(&quot;retentionTime&quot;));
543      assertEquals((Long) 4096L, info.getProperty(&quot;chunkSize&quot;));
544      assertEquals(&quot;v1&quot;, info.getLabel(&quot;l1&quot;));
545      assertEquals(&quot;v2&quot;, info.getLabel(&quot;l2&quot;));
546      assertNull(info.getLabel(&quot;l3&quot;));
547      assertEquals(1, info.getRules().size());
548      TSInfo.Rule rule = info.getRule(&quot;dest&quot;);
549      assertEquals(&quot;dest&quot;, rule.getCompactionKey());
550      assertEquals(100L, rule.getBucketDuration());
551      assertEquals(AggregationType.AVG, rule.getAggregator());
552      try {
553        client.tsInfo(&quot;none&quot;);
554        fail();
555      } catch (JedisDataException e) {
556      }
557    }
558    @Test
559    public void testInfoDebug() {
560      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;source&quot;, TSCreateParams.createParams()));
561      TSInfo info = client.tsInfoDebug(&quot;source&quot;);
562      assertEquals((Long) 0L, info.getProperty(&quot;retentionTime&quot;));
563      assertEquals(0, info.getLabels().size());
564      assertEquals(0, info.getRules().size());
565      List&lt;Map&lt;String, Object&gt;&gt; chunks = info.getChunks();
566      assertEquals(1, chunks.size());
567      Map&lt;String, Object&gt; chunk = chunks.get(0);
568      assertEquals(0L, chunk.get(&quot;samples&quot;));
569      assertTrue(chunk.get(&quot;size&quot;) instanceof Long);
570      assertTrue(chunk.get(&quot;startTimestamp&quot;) instanceof Long);
571      assertTrue(chunk.get(&quot;endTimestamp&quot;) instanceof Long);
572      assertTrue(chunk.get(&quot;bytesPerSample&quot;) instanceof Double);
573      try {
574        client.tsInfoDebug(&quot;none&quot;);
575        fail();
576      } catch (JedisDataException e) {
577      }
578    }
579    @Test
580    public void testRevRange() {
581      Map&lt;String, String&gt; labels = new HashMap&lt;&gt;();
582      labels.put(&quot;l1&quot;, &quot;v1&quot;);
583      labels.put(&quot;l2&quot;, &quot;v2&quot;);
584      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesAdd&quot;, TSCreateParams.createParams().retention(10000L).labels(labels)));
585      assertEquals(Collections.emptyList(), client.tsRevRange(&quot;seriesAdd&quot;, TSRangeParams.rangeParams()));
586      assertEquals(1000L, client.tsAdd(&quot;seriesRevRange&quot;, 1000L, 1.1, TSCreateParams.createParams().retention(10000)));
587      assertEquals(2000L, client.tsAdd(&quot;seriesRevRange&quot;, 2000L, 0.9, TSCreateParams.createParams().labels(null)));
588      assertEquals(3200L, client.tsAdd(&quot;seriesRevRange&quot;, 3200L, 1.1, TSCreateParams.createParams().retention(10000)));
589      assertEquals(4500L, client.tsAdd(&quot;seriesRevRange&quot;, 4500L, -1.1));
590      TSElement[] rawValues = new TSElement[]{
591        new TSElement(4500L, -1.1),
<span onclick='openModal()' class='match'>592        new TSElement(3200L, 1.1),
593        new TSElement(2000L, 0.9),
594        new TSElement(1000L, 1.1)
</span>595      };
596      List&lt;TSElement&gt; values = client.tsRevRange(&quot;seriesRevRange&quot;, 800L, 3000L);
597      assertEquals(2, values.size());
598      assertEquals(Arrays.asList(Arrays.copyOfRange(rawValues, 2, 4)), values);
599      values = client.tsRevRange(&quot;seriesRevRange&quot;, 800L, 5000L);
600      assertEquals(4, values.size());
601      assertEquals(Arrays.asList(rawValues), values);
602      assertEquals(Arrays.asList(rawValues), client.tsRevRange(&quot;seriesRevRange&quot;, TSRangeParams.rangeParams()));
603      List&lt;TSElement&gt; expectedCountValues = Arrays.asList(
604          new TSElement(4500L, 1), new TSElement(3200L, 1), new TSElement(2000L, 1));
605      values = client.tsRevRange(&quot;seriesRevRange&quot;, TSRangeParams.rangeParams(1200L, 4600L)
606          .aggregation(AggregationType.COUNT, 1));
607      assertEquals(3, values.size());
608      assertEquals(expectedCountValues, values);
609      List&lt;TSElement&gt; expectedAvgValues = Arrays.asList(
610          new TSElement(4000L, -1.1), new TSElement(2000L, 1), new TSElement(0L, 1.1));
611      values = client.tsRevRange(&quot;seriesRevRange&quot;, TSRangeParams.rangeParams(500L, 4600L)
612          .aggregation(AggregationType.AVG, 2000L));
613      assertEquals(3, values.size());
614      assertEquals(expectedAvgValues, values);
615    }
616    @Test
617    public void testMRevRange() {
618      assertEquals(Collections.emptyMap(), client.tsMRevRange(TSMRangeParams.multiRangeParams().filter(&quot;l=v&quot;)));
619      Map&lt;String, String&gt; labels1 = new HashMap&lt;&gt;();
620      labels1.put(&quot;l3&quot;, &quot;v3&quot;);
621      labels1.put(&quot;l4&quot;, &quot;v4&quot;);
622      assertEquals(1000L, client.tsAdd(&quot;seriesMRevRange1&quot;, 1000L, 1.1,
623          TSCreateParams.createParams().retention(10000).labels(labels1)));
624      assertEquals(2222L, client.tsAdd(&quot;seriesMRevRange1&quot;, 2222L, 3.1,
625          TSCreateParams.createParams().retention(10000).labels(labels1)));
626      Map&lt;String, TSMRangeElements&gt; ranges1 = client.tsMRevRange(TSMRangeParams.multiRangeParams(500L, 4600L)
627          .aggregation(AggregationType.COUNT, 1).withLabels().filter(&quot;l4=v4&quot;));
628      assertEquals(1, ranges1.size());
629      ArrayList&lt;TSMRangeElements&gt; ranges1List = new ArrayList&lt;&gt;(ranges1.values());
630      assertEquals(labels1, ranges1List.get(0).getLabels());
631      assertEquals(Arrays.asList(new TSElement(2222L, 1.0), new TSElement(1000L, 1.0)), ranges1List.get(0).getValue());
632      Map&lt;String, String&gt; labels2 = new HashMap&lt;&gt;();
633      labels2.put(&quot;l3&quot;, &quot;v3&quot;);
634      labels2.put(&quot;l4&quot;, &quot;v44&quot;);
635      assertEquals(1000L, client.tsAdd(&quot;seriesMRevRange2&quot;, 1000L, 8.88,
636          TSCreateParams.createParams().retention(10000).labels(labels2)));
637      assertEquals(1111L, client.tsAdd(&quot;seriesMRevRange2&quot;, 1111L, 99.99,
638          TSCreateParams.createParams().retention(10000).labels(labels2)));
639      Map&lt;String, TSMRangeElements&gt; ranges2 = client.tsMRevRange(500L, 4600L, &quot;l3=v3&quot;);
640      assertEquals(2, ranges2.size());
641      ArrayList&lt;TSMRangeElements&gt; ranges2List = new ArrayList&lt;&gt;(ranges2.values());
642      assertEquals(Collections.emptyMap(), ranges2List.get(0).getLabels());
643      assertEquals(Arrays.asList(new TSElement(2222L, 3.1), new TSElement(1000L, 1.1)), ranges2List.get(0).getValue());
644      assertEquals(Collections.emptyMap(), ranges2List.get(0).getLabels());
645      assertEquals(Arrays.asList(new TSElement(1111L, 99.99), new TSElement(1000L, 8.88)), ranges2List.get(1).getValue());
646      Map&lt;String, String&gt; labels3 = new HashMap&lt;&gt;();
647      labels3.put(&quot;l3&quot;, &quot;v33&quot;);
648      labels3.put(&quot;l4&quot;, &quot;v4&quot;);
649      assertEquals(2200L, client.tsAdd(&quot;seriesMRevRange3&quot;, 2200L, -1.1, TSCreateParams.createParams().labels(labels3)));
650      assertEquals(2400L, client.tsAdd(&quot;seriesMRevRange3&quot;, 2400L, 1.1, TSCreateParams.createParams().labels(labels3)));
651      assertEquals(3300L, client.tsAdd(&quot;seriesMRevRange3&quot;, 3300L, -33, TSCreateParams.createParams().labels(labels3)));
652      Map&lt;String, TSMRangeElements&gt; ranges3 = client.tsMRevRange(TSMRangeParams.multiRangeParams(500L, 4600L)
653          .aggregation(AggregationType.AVG, 500).withLabels().count(5).filter(&quot;l4=v4&quot;));
654      assertEquals(2, ranges3.size());
655      ArrayList&lt;TSMRangeElements&gt; ranges3List = new ArrayList&lt;&gt;(ranges3.values());
656      assertEquals(labels1, ranges3List.get(0).getLabels());
657      assertEquals(Arrays.asList(new TSElement(2000L, 3.1), new TSElement(1000L, 1.1)), ranges3List.get(0).getValue());
658      assertEquals(labels3, ranges3List.get(1).getLabels());
659      assertEquals(Arrays.asList(new TSElement(3000L, -33.0), new TSElement(2000L, 0.0)), ranges3List.get(1).getValue());
660    }
661    @Test
662    public void latest() {
663      client.tsCreate(&quot;ts1&quot;);
664      client.tsCreate(&quot;ts2&quot;);
665      client.tsCreateRule(&quot;ts1&quot;, &quot;ts2&quot;, AggregationType.SUM, 10);
666      client.tsAdd(&quot;ts1&quot;, 1, 1);
667      client.tsAdd(&quot;ts1&quot;, 2, 3);
668      client.tsAdd(&quot;ts1&quot;, 11, 7);
669      client.tsAdd(&quot;ts1&quot;, 13, 1);
670      List&lt;TSElement&gt; range = client.tsRange(&quot;ts1&quot;, 0, 20);
671      assertEquals(4, range.size());
672      final TSElement compact = new TSElement(0, 4);
673      final TSElement latest = new TSElement(10, 8);
674      assertEquals(compact, client.tsGet(&quot;ts2&quot;, TSGetParams.getParams()));
675      assertEquals(latest, client.tsGet(&quot;ts2&quot;, TSGetParams.getParams().latest()));
676      assertEquals(Arrays.asList(compact), client.tsRange(&quot;ts2&quot;, TSRangeParams.rangeParams(0, 10)));
677      assertEquals(Arrays.asList(compact, latest), client.tsRange(&quot;ts2&quot;, TSRangeParams.rangeParams(0, 10).latest()));
678      assertEquals(Arrays.asList(compact), client.tsRevRange(&quot;ts2&quot;, TSRangeParams.rangeParams(0, 10)));
679      assertEquals(Arrays.asList(latest, compact), client.tsRevRange(&quot;ts2&quot;, TSRangeParams.rangeParams(0, 10).latest()));
680    }
681    @Test
682    public void latestMulti() {
683      client.tsCreate(&quot;ts1&quot;);
684      client.tsCreate(&quot;ts2&quot;, TSCreateParams.createParams().label(&quot;compact&quot;, &quot;true&quot;));
685      client.tsCreateRule(&quot;ts1&quot;, &quot;ts2&quot;, AggregationType.SUM, 10);
686      client.tsAdd(&quot;ts1&quot;, 1, 1);
687      client.tsAdd(&quot;ts1&quot;, 2, 3);
688      client.tsAdd(&quot;ts1&quot;, 11, 7);
689      client.tsAdd(&quot;ts1&quot;, 13, 1);
690      List&lt;TSElement&gt; range = client.tsRange(&quot;ts1&quot;, 0, 20);
691      assertEquals(4, range.size());
692      final TSElement compact = new TSElement(0, 4);
693      final TSElement latest = new TSElement(10, 8);
694      assertEquals(makeSingletonMap(new TSMGetElement(&quot;ts2&quot;, null, compact)),
695          client.tsMGet(TSMGetParams.multiGetParams(), &quot;compact=true&quot;));
696      assertEquals(makeSingletonMap(new TSMGetElement(&quot;ts2&quot;, null, latest)),
697          client.tsMGet(TSMGetParams.multiGetParams().latest(), &quot;compact=true&quot;));
698      assertEquals(makeSingletonMap(new TSMRangeElements(&quot;ts2&quot;, null, Arrays.asList(compact))),
699          client.tsMRange(TSMRangeParams.multiRangeParams().filter(&quot;compact=true&quot;)));
700      assertEquals(makeSingletonMap(new TSMRangeElements(&quot;ts2&quot;, null, Arrays.asList(compact, latest))),
701          client.tsMRange(TSMRangeParams.multiRangeParams().latest().filter(&quot;compact=true&quot;)));
702      assertEquals(makeSingletonMap(new TSMRangeElements(&quot;ts2&quot;, null, Arrays.asList(compact))),
703          client.tsMRevRange(TSMRangeParams.multiRangeParams().filter(&quot;compact=true&quot;)));
704      assertEquals(makeSingletonMap(new TSMRangeElements(&quot;ts2&quot;, null, Arrays.asList(latest, compact))),
705          client.tsMRevRange(TSMRangeParams.multiRangeParams().latest().filter(&quot;compact=true&quot;)));
706    }
707    private Map&lt;String, TSMGetElement&gt; makeSingletonMap(TSMGetElement value) {
708      return Collections.singletonMap(value.getKey(), value);
709    }
710    private Map&lt;String, TSMRangeElements&gt; makeSingletonMap(TSMRangeElements value) {
711      return Collections.singletonMap(value.getKey(), value);
712    }
713    @Test
714    public void empty() {
715      client.tsCreate(&quot;ts&quot;, TSCreateParams.createParams().label(&quot;l&quot;, &quot;v&quot;));
716      client.tsAdd(&quot;ts&quot;, 1, 1);
717      client.tsAdd(&quot;ts&quot;, 2, 3);
718      client.tsAdd(&quot;ts&quot;, 11, 7);
719      client.tsAdd(&quot;ts&quot;, 13, 1);
720      List&lt;TSElement&gt; range = client.tsRange(&quot;ts&quot;, TSRangeParams.rangeParams().aggregation(AggregationType.MAX, 5));
721      assertEquals(2, range.size());
722      range = client.tsRange(&quot;ts&quot;, TSRangeParams.rangeParams().aggregation(AggregationType.MAX, 5).empty());
723      assertEquals(3, range.size());
724      assertNotNull(range.get(1).getValue()); 
725      range = client.tsRevRange(&quot;ts&quot;, TSRangeParams.rangeParams().aggregation(AggregationType.MIN, 5));
726      assertEquals(2, range.size());
727      range = client.tsRevRange(&quot;ts&quot;, TSRangeParams.rangeParams().aggregation(AggregationType.MIN, 5).empty());
728      assertEquals(3, range.size());
729      assertNotNull(range.get(1).getValue()); 
730      Map&lt;String, TSMRangeElements&gt; mrange = client.tsMRange(TSMRangeParams.multiRangeParams()
731          .aggregation(AggregationType.MIN, 5).filter(&quot;l=v&quot;));
732      assertEquals(1, mrange.size());
733      ArrayList&lt;TSMRangeElements&gt; mrangeList = new ArrayList&lt;&gt;(mrange.values());
734      assertEquals(2, mrangeList.get(0).getValue().size());
735      mrange = client.tsMRange(TSMRangeParams.multiRangeParams()
736          .aggregation(AggregationType.MIN, 5).empty().filter(&quot;l=v&quot;));
737      assertEquals(1, mrange.size());
738      mrangeList = new ArrayList&lt;&gt;(mrange.values());
739      assertEquals(3, mrangeList.get(0).getValue().size());
740      assertNotNull(mrangeList.get(0).getValue().get(1).getValue()); 
741      mrange = client.tsMRevRange(TSMRangeParams.multiRangeParams()
742          .aggregation(AggregationType.MAX, 5).filter(&quot;l=v&quot;));
743      assertEquals(1, mrange.size());
744      mrangeList = new ArrayList&lt;&gt;(mrange.values());
745      assertEquals(2, mrangeList.get(0).getValue().size());
746      mrange = client.tsMRevRange(TSMRangeParams.multiRangeParams()
747          .aggregation(AggregationType.MAX, 5).empty().filter(&quot;l=v&quot;));
748      assertEquals(1, mrange.size());
749      mrangeList = new ArrayList&lt;&gt;(mrange.values());
750      assertEquals(3, mrangeList.get(0).getValue().size());
751      assertNotNull(mrangeList.get(0).getValue().get(1).getValue()); 
752    }
753    @Test
754    public void bucketTimestamp() {
755      client.tsCreate(&quot;ts&quot;, TSCreateParams.createParams().label(&quot;l&quot;, &quot;v&quot;));
756      client.tsAdd(&quot;ts&quot;, 1, 1);
757      client.tsAdd(&quot;ts&quot;, 2, 3);
758      assertEquals(0, client.tsRange(&quot;ts&quot;, TSRangeParams.rangeParams()
759          .aggregation(AggregationType.FIRST, 10).bucketTimestampLow()).get(0).getTimestamp());
760      assertEquals(10, client.tsRange(&quot;ts&quot;, TSRangeParams.rangeParams()
761          .aggregation(AggregationType.LAST, 10).bucketTimestampHigh()).get(0).getTimestamp());
762      assertEquals(5, client.tsRange(&quot;ts&quot;, TSRangeParams.rangeParams()
763          .aggregation(AggregationType.RANGE, 10).bucketTimestampMid()).get(0).getTimestamp());
764      assertEquals(5, client.tsRevRange(&quot;ts&quot;, TSRangeParams.rangeParams()
765          .aggregation(AggregationType.TWA, 10).bucketTimestampMid()).get(0).getTimestamp());
766      assertEquals(5, client.tsRevRange(&quot;ts&quot;, TSRangeParams.rangeParams()
767          .aggregation(AggregationType.TWA, 10).bucketTimestamp(&quot;mid&quot;)).get(0).getTimestamp());
768      assertEquals(0, client.tsMRange(TSMRangeParams.multiRangeParams()
769          .aggregation(AggregationType.STD_P, 10).bucketTimestampLow().filter(&quot;l=v&quot;))
770          .values().stream().findAny().get().getValue().get(0).getTimestamp());
771      assertEquals(10, client.tsMRange(TSMRangeParams.multiRangeParams()
772          .aggregation(AggregationType.STD_S, 10).bucketTimestampHigh().filter(&quot;l=v&quot;))
773          .values().stream().findAny().get().getValue().get(0).getTimestamp());
774      assertEquals(5, client.tsMRange(TSMRangeParams.multiRangeParams()
775          .aggregation(AggregationType.TWA, 10).bucketTimestampMid().filter(&quot;l=v&quot;))
776          .values().stream().findAny().get().getValue().get(0).getTimestamp());
777      assertEquals(5, client.tsMRange(TSMRangeParams.multiRangeParams()
778          .aggregation(AggregationType.VAR_P, 10).bucketTimestampMid().filter(&quot;l=v&quot;))
779          .values().stream().findAny().get().getValue().get(0).getTimestamp());
780      assertEquals(5, client.tsMRange(TSMRangeParams.multiRangeParams()
781          .aggregation(AggregationType.VAR_S, 10).bucketTimestamp(&quot;~&quot;).filter(&quot;l=v&quot;))
782          .values().stream().findAny().get().getValue().get(0).getTimestamp());
783    }
784    @Test
785    public void alignTimestamp() {
786      client.tsCreate(&quot;ts1&quot;);
787      client.tsCreate(&quot;ts2&quot;);
788      client.tsCreate(&quot;ts3&quot;);
789      client.tsCreateRule(&quot;ts1&quot;, &quot;ts2&quot;, AggregationType.COUNT, 10, 0);
790      client.tsCreateRule(&quot;ts1&quot;, &quot;ts3&quot;, AggregationType.COUNT, 10, 1);
791      client.tsAdd(&quot;ts1&quot;, 1, 1);
792      client.tsAdd(&quot;ts1&quot;, 10, 3);
793      client.tsAdd(&quot;ts1&quot;, 21, 7);
794      assertEquals(2, client.tsRange(&quot;ts2&quot;, TSRangeParams.rangeParams().aggregation(AggregationType.COUNT, 10)).size());
795      assertEquals(1, client.tsRange(&quot;ts3&quot;, TSRangeParams.rangeParams().aggregation(AggregationType.COUNT, 10)).size());
796    }
797  }
</code></pre>
        </div>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-TimeSeriesTest.java</h3>
            <pre><code>1  package redis.clients.jedis.modules.timeseries;
2  import static org.junit.Assert.assertEquals;
3  import static org.junit.Assert.assertNotEquals;
4  import static org.junit.Assert.assertNotNull;
5  import static org.junit.Assert.assertNull;
6  import static org.junit.Assert.assertTrue;
7  import static org.junit.Assert.fail;
8  import static redis.clients.jedis.util.AssertUtil.assertEqualsByProtocol;
9  import java.util.*;
10  import org.junit.BeforeClass;
11  import org.junit.Test;
12  import redis.clients.jedis.RedisProtocol;
13  import redis.clients.jedis.exceptions.JedisDataException;
14  import redis.clients.jedis.modules.RedisModuleCommandsTestBase;
15  import redis.clients.jedis.timeseries.*;
16  import redis.clients.jedis.util.KeyValue;
17  public class TimeSeriesTest extends RedisModuleCommandsTestBase {
18    @BeforeClass
19    public static void prepare() {
20      RedisModuleCommandsTestBase.prepare();
21    }
22    @Test
23    public void testCreate() {
24      Map&lt;String, String&gt; labels = new HashMap&lt;&gt;();
25      labels.put(&quot;l1&quot;, &quot;v1&quot;);
26      labels.put(&quot;l2&quot;, &quot;v2&quot;);
27      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series1&quot;, TSCreateParams.createParams().retention(10).labels(labels)));
28      assertEquals(&quot;TSDB-TYPE&quot;, client.type(&quot;series1&quot;));
29      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series2&quot;, TSCreateParams.createParams().labels(labels)));
30      assertEquals(&quot;TSDB-TYPE&quot;, client.type(&quot;series2&quot;));
31      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series3&quot;, TSCreateParams.createParams().retention(10)));
32      assertEquals(&quot;TSDB-TYPE&quot;, client.type(&quot;series3&quot;));
33      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series4&quot;));
34      assertEquals(&quot;TSDB-TYPE&quot;, client.type(&quot;series4&quot;));
35      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series5&quot;, TSCreateParams.createParams().retention(0).uncompressed().labels(labels)));
36      assertEquals(&quot;TSDB-TYPE&quot;, client.type(&quot;series5&quot;));
37      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series6&quot;, TSCreateParams.createParams().retention(7898)
38          .uncompressed().duplicatePolicy(DuplicatePolicy.MAX).labels(labels)));
39      assertEquals(&quot;TSDB-TYPE&quot;, client.type(&quot;series6&quot;));
40      try {
41        assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series1&quot;, TSCreateParams.createParams().retention(10).labels(labels)));
42        fail();
43      } catch (JedisDataException e) {
44      }
45      try {
46        assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series1&quot;, TSCreateParams.createParams().labels(labels)));
47        fail();
48      } catch (JedisDataException e) {
49      }
50      try {
51        assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series1&quot;, TSCreateParams.createParams().retention(10)));
52        fail();
53      } catch (JedisDataException e) {
54      }
55      try {
56        assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series1&quot;));
57        fail();
58      } catch (JedisDataException e) {
59      }
60      try {
61        assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series1&quot;));
62        fail();
63      } catch (JedisDataException e) {
64      }
65      try {
66        assertEquals(&quot;OK&quot;, client.tsCreate(&quot;series7&quot;, TSCreateParams.createParams().retention(7898)
67            .uncompressed().chunkSize(-10).duplicatePolicy(DuplicatePolicy.MAX).labels(labels)));
68        fail();
69      } catch (JedisDataException e) {
70      }
71    }
72    @Test
73    public void testAlter() {
74      Map&lt;String, String&gt; labels = new HashMap&lt;&gt;();
75      labels.put(&quot;l1&quot;, &quot;v1&quot;);
76      labels.put(&quot;l2&quot;, &quot;v2&quot;);
77      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesAlter&quot;, TSCreateParams.createParams().retention(60000).labels(labels)));
78      assertEquals(Collections.emptyList(), client.tsQueryIndex(&quot;l2=v22&quot;));
79      labels.put(&quot;l1&quot;, &quot;v11&quot;);
80      labels.remove(&quot;l2&quot;);
81      labels.put(&quot;l3&quot;, &quot;v33&quot;);
82      assertEquals(&quot;OK&quot;, client.tsAlter(&quot;seriesAlter&quot;, TSAlterParams.alterParams().retention(15000).chunkSize(8192)
83          .duplicatePolicy(DuplicatePolicy.SUM).labels(labels)));
84      TSInfo info = client.tsInfo(&quot;seriesAlter&quot;);
85      assertEquals(Long.valueOf(15000), info.getProperty(&quot;retentionTime&quot;));
86      assertEquals(Long.valueOf(8192), info.getProperty(&quot;chunkSize&quot;));
87      assertEquals(DuplicatePolicy.SUM, info.getProperty(&quot;duplicatePolicy&quot;));
88      assertEquals(&quot;v11&quot;, info.getLabel(&quot;l1&quot;));
89      assertNull(info.getLabel(&quot;l2&quot;));
90      assertEquals(&quot;v33&quot;, info.getLabel(&quot;l3&quot;));
91    }
92    @Test
93    public void testRule() {
94      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;source&quot;));
95      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;dest&quot;, TSCreateParams.createParams().retention(10)));
96      assertEquals(&quot;OK&quot;, client.tsCreateRule(&quot;source&quot;, &quot;dest&quot;, AggregationType.AVG, 100));
97      try {
98        client.tsCreateRule(&quot;source&quot;, &quot;dest&quot;, AggregationType.COUNT, 100);
99        fail();
100      } catch (JedisDataException e) {
101      }
102      assertEquals(&quot;OK&quot;, client.tsDeleteRule(&quot;source&quot;, &quot;dest&quot;));
103      assertEquals(&quot;OK&quot;, client.tsCreateRule(&quot;source&quot;, &quot;dest&quot;, AggregationType.COUNT, 100));
104      try {
105        assertEquals(&quot;OK&quot;, client.tsDeleteRule(&quot;source&quot;, &quot;dest1&quot;));
106        fail();
107      } catch (JedisDataException e) {
108      }
109    }
110    @Test
111    public void testAdd() {
112      Map&lt;String, String&gt; labels = new HashMap&lt;&gt;();
113      labels.put(&quot;l1&quot;, &quot;v1&quot;);
114      labels.put(&quot;l2&quot;, &quot;v2&quot;);
115      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesAdd&quot;, TSCreateParams.createParams().retention(10000).labels(labels)));
116      assertEquals(0, client.tsRange(&quot;seriesAdd&quot;, TSRangeParams.rangeParams()).size());
117      assertEquals(1000L, client.tsAdd(&quot;seriesAdd&quot;, 1000L, 1.1, TSCreateParams.createParams().retention(10000).labels(null)));
118      assertEquals(2000L, client.tsAdd(&quot;seriesAdd&quot;, 2000L, 0.9, TSCreateParams.createParams().labels(null)));
119      assertEquals(3200L, client.tsAdd(&quot;seriesAdd&quot;, 3200L, 1.1, TSCreateParams.createParams().retention(10000)));
120      assertEquals(4500L, client.tsAdd(&quot;seriesAdd&quot;, 4500L, -1.1));
121      TSElement[] rawValues = new TSElement[]{
122        new TSElement(1000L, 1.1),
123        new TSElement(2000L, 0.9),
124        new TSElement(3200L, 1.1),
125        new TSElement(4500L, -1.1)
126      };
127      List&lt;TSElement&gt; values = client.tsRange(&quot;seriesAdd&quot;, 800L, 3000L);
128      assertEquals(2, values.size());
129      assertEquals(Arrays.asList(rawValues[0], rawValues[1]), values);
130      values = client.tsRange(&quot;seriesAdd&quot;, 800L, 5000L);
131      assertEquals(4, values.size());
132      assertEquals(Arrays.asList(rawValues), values);
133      assertEquals(Arrays.asList(rawValues), client.tsRange(&quot;seriesAdd&quot;, TSRangeParams.rangeParams()));
134      List&lt;TSElement&gt; expectedCountValues = Arrays.asList(
135          new TSElement(2000L, 1), new TSElement(3200L, 1), new TSElement(4500L, 1));
136      values = client.tsRange(&quot;seriesAdd&quot;, TSRangeParams.rangeParams(1200L, 4600L).aggregation(AggregationType.COUNT, 1));
137      assertEquals(3, values.size());
138      assertEquals(expectedCountValues, values);
139      List&lt;TSElement&gt; expectedAvgValues = Arrays.asList(
140          new TSElement(0L, 1.1), new TSElement(2000L, 1), new TSElement(4000L, -1.1));
141      values = client.tsRange(&quot;seriesAdd&quot;, TSRangeParams.rangeParams(500L, 4600L).aggregation(AggregationType.AVG, 2000L));
142      assertEquals(3, values.size());
143      assertEquals(expectedAvgValues, values);
144      List&lt;TSElement&gt; valuesZeroBased = client.tsRange(&quot;seriesAdd&quot;,
145          TSRangeParams.rangeParams(0L, 4600L).aggregation(AggregationType.AVG, 2000L));
146      assertEquals(3, valuesZeroBased.size());
147      assertEquals(values, valuesZeroBased);
148      List&lt;TSElement&gt; expectedOverallSumValues = Arrays.asList(new TSElement(0L, 2.0));
149      values = client.tsRange(&quot;seriesAdd&quot;, TSRangeParams.rangeParams(0L, 5000L).aggregation(AggregationType.SUM, 5000L));
150      assertEquals(1, values.size());
151      assertEquals(expectedOverallSumValues, values);
152      List&lt;TSElement&gt; expectedOverallMinValues = Arrays.asList(new TSElement(0L, -1.1));
153      values = client.tsRange(&quot;seriesAdd&quot;, TSRangeParams.rangeParams(0L, 5000L).aggregation(AggregationType.MIN, 5000L));
154      assertEquals(1, values.size());
155      assertEquals(expectedOverallMinValues, values);
156      List&lt;TSElement&gt; expectedOverallMaxValues = Arrays.asList(new TSElement(0L, 1.1));
157      values = client.tsRange(&quot;seriesAdd&quot;, TSRangeParams.rangeParams(0L, 5000L).aggregation(AggregationType.MAX, 5000L));
158      assertEquals(1, values.size());
159      assertEquals(expectedOverallMaxValues, values);
160      assertEquals(Collections.emptyMap(), client.tsMRange(TSMRangeParams.multiRangeParams().filter(&quot;l=v&quot;)));
161      try {
162        client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L).aggregation(AggregationType.COUNT, 1));
163        fail();
164      } catch (IllegalArgumentException e) {
165      }
166      try {
167        client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L).aggregation(AggregationType.COUNT, 1).filter((String) null));
168        fail();
169      } catch (IllegalArgumentException e) {
170      }
171      Map&lt;String, TSMRangeElements&gt; ranges = client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L)
172          .aggregation(AggregationType.COUNT, 1).filter(&quot;l1=v1&quot;));
173      assertEquals(1, ranges.size());
174      TSMRangeElements range = ranges.values().stream().findAny().get();
175      assertEquals(&quot;seriesAdd&quot;, range.getKey());
176      assertEquals(Collections.emptyMap(), range.getLabels());
177      List&lt;TSElement&gt; rangeValues = range.getValue();
178      assertEquals(4, rangeValues.size());
179      assertEquals(new TSElement(1000, 1), rangeValues.get(0));
180      assertNotEquals(new TSElement(1000, 1.1), rangeValues.get(0));
181      assertEquals(2000L, rangeValues.get(1).getTimestamp());
182      assertEquals(&quot;(2000:1.0)&quot;, rangeValues.get(1).toString());
183      Map&lt;String, String&gt; labels2 = new HashMap&lt;&gt;();
184      labels2.put(&quot;l3&quot;, &quot;v3&quot;);
185      labels2.put(&quot;l4&quot;, &quot;v4&quot;);
186      assertEquals(1000L, client.tsAdd(&quot;seriesAdd2&quot;, 1000L, 1.1, TSCreateParams.createParams().retention(10000).labels(labels2)));
187      Map&lt;String, TSMRangeElements&gt; ranges2 = client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L)
188          .aggregation(AggregationType.COUNT, 1).withLabels().filter(&quot;l4=v4&quot;));
189      assertEquals(1, ranges2.size());
190      TSMRangeElements elements2 = ranges2.values().stream().findAny().get();
191      assertEquals(labels2, elements2.getLabels());
192      assertEqualsByProtocol(protocol, null, Arrays.asList(AggregationType.COUNT), elements2.getAggregators());
193      Map&lt;String, String&gt; labels3 = new HashMap&lt;&gt;();
194      labels3.put(&quot;l3&quot;, &quot;v33&quot;);
195      labels3.put(&quot;l4&quot;, &quot;v4&quot;);
196      assertEquals(1000L, client.tsAdd(&quot;seriesAdd3&quot;, 1000L, 1.1, TSCreateParams.createParams().labels(labels3)));
197      assertEquals(2000L, client.tsAdd(&quot;seriesAdd3&quot;, 2000L, 1.1, TSCreateParams.createParams().labels(labels3)));
198      assertEquals(3000L, client.tsAdd(&quot;seriesAdd3&quot;, 3000L, 1.1, TSCreateParams.createParams().labels(labels3)));
199      Map&lt;String, TSMRangeElements&gt; ranges3 = client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L)
200          .aggregation(AggregationType.AVG, 1L).withLabels(true).count(2).filter(&quot;l4=v4&quot;));
201      assertEquals(2, ranges3.size());
202      ArrayList&lt;TSMRangeElements&gt; ranges3List = new ArrayList&lt;&gt;(ranges3.values());
203      assertEquals(1, ranges3List.get(0).getValue().size());
204      assertEquals(labels2, ranges3List.get(0).getLabels());
205      assertEqualsByProtocol(protocol, null, Arrays.asList(AggregationType.AVG), ranges3List.get(0).getAggregators());
206      assertEquals(2, ranges3List.get(1).getValue().size());
207      assertEquals(labels3, ranges3List.get(1).getLabels());
208      assertEqualsByProtocol(protocol, null, Arrays.asList(AggregationType.AVG), ranges3List.get(1).getAggregators());
209      assertEquals(800L, client.tsAdd(&quot;seriesAdd&quot;, 800L, 1.1));
210      assertEquals(700L, client.tsAdd(&quot;seriesAdd&quot;, 700L, 1.1, TSCreateParams.createParams().retention(10000)));
211      assertEquals(600L, client.tsAdd(&quot;seriesAdd&quot;, 600L, 1.1, TSCreateParams.createParams().retention(10000).labels(null)));
212      assertEquals(400L, client.tsAdd(&quot;seriesAdd4&quot;, 400L, 0.4, TSCreateParams.createParams()
213          .retention(7898L).uncompressed().chunkSize(1000L).duplicatePolicy(DuplicatePolicy.SUM)
214          .labels(labels)));
215      assertEquals(&quot;TSDB-TYPE&quot;, client.type(&quot;seriesAdd4&quot;));
216      assertEquals(400L, client.tsAdd(&quot;seriesAdd4&quot;, 400L, 0.3, TSCreateParams.createParams()
217          .retention(7898L).uncompressed().chunkSize(1000L).duplicatePolicy(DuplicatePolicy.SUM)
218          .labels(labels)));
219      assertEquals(Arrays.asList(new TSElement(400L, 0.7)), client.tsRange(&quot;seriesAdd4&quot;, 0L, Long.MAX_VALUE));
220      try {
221        client.tsRange(&quot;seriesAdd1&quot;, TSRangeParams.rangeParams(500L, 4000L).aggregation(AggregationType.COUNT, 1));
222        fail();
223      } catch (JedisDataException e) {
224      }
225    }
226    @Test
227    public void issue75() {
228      client.tsMRange(TSMRangeParams.multiRangeParams().filter(&quot;id=1&quot;));
229    }
230    @Test
231    public void del() {
232      try {
233        client.tsDel(&quot;ts-del&quot;, 0, 1);
234        fail();
235      } catch (JedisDataException jde) {
236      }
237      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;ts-del&quot;, TSCreateParams.createParams().retention(10000L)));
238      assertEquals(0, client.tsDel(&quot;ts-del&quot;, 0, 1));
239      assertEquals(1000L, client.tsAdd(&quot;ts-del&quot;, 1000L, 1.1, TSCreateParams.createParams().retention(10000)));
240      assertEquals(2000L, client.tsAdd(&quot;ts-del&quot;, 2000L, 0.9));
241      assertEquals(3200L, client.tsAdd(&quot;ts-del&quot;, 3200L, 1.1, TSCreateParams.createParams().retention(10000)));
242      assertEquals(4500L, client.tsAdd(&quot;ts-del&quot;, 4500L, -1.1));
243      assertEquals(4, client.tsRange(&quot;ts-del&quot;, 0, 5000).size());
244      assertEquals(2, client.tsDel(&quot;ts-del&quot;, 2000, 4000));
245      assertEquals(2, client.tsRange(&quot;ts-del&quot;, 0, 5000).size());
246      assertEquals(1, client.tsRange(&quot;ts-del&quot;, 0, 2500).size());
247      assertEquals(1, client.tsRange(&quot;ts-del&quot;, 2500, 5000).size());
248    }
249    @Test
250    public void testValue() {
251      TSElement v = new TSElement(1234, 234.89634);
252      assertEquals(1234, v.getTimestamp());
253      assertEquals(234.89634, v.getValue(), 0);
254      assertEquals(v, new TSElement(1234, 234.89634));
255      assertNotEquals(v, new TSElement(1334, 234.89634));
256      assertNotEquals(v, new TSElement(1234, 234.8934));
257      assertNotEquals(1234, v.getValue());
258      assertEquals(&quot;(1234:234.89634)&quot;, v.toString());
259      assertEquals(-1856719580, v.hashCode());
260    }
261    @Test
262    public void testAddStar() throws InterruptedException {
263      Map&lt;String, String&gt; labels = new HashMap&lt;&gt;();
264      labels.put(&quot;l11&quot;, &quot;v11&quot;);
265      labels.put(&quot;l22&quot;, &quot;v22&quot;);
266      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesAdd2&quot;, TSCreateParams.createParams().retention(10000L).labels(labels)));
267      long startTime = System.currentTimeMillis();
268      Thread.sleep(1);
269      long add1 = client.tsAdd(&quot;seriesAdd2&quot;, 1.1);
270      assertTrue(add1 &gt; startTime);
271      Thread.sleep(1);
272      long add2 = client.tsAdd(&quot;seriesAdd2&quot;, 3.2);
273      assertTrue(add2 &gt; add1);
274      Thread.sleep(1);
275      long add3 = client.tsAdd(&quot;seriesAdd2&quot;, 3.2);
276      assertTrue(add3 &gt; add2);
277      Thread.sleep(1);
278      long add4 = client.tsAdd(&quot;seriesAdd2&quot;, -1.2);
279      assertTrue(add4 &gt; add3);
280      Thread.sleep(1);
281      long endTime = System.currentTimeMillis();
282      assertTrue(endTime &gt; add4);
283      List&lt;TSElement&gt; values = client.tsRange(&quot;seriesAdd2&quot;, startTime, add3);
284      assertEquals(3, values.size());
285    }
286    @Test
287    public void testMadd() {
288      Map&lt;String, String&gt; labels = new HashMap&lt;&gt;();
289      labels.put(&quot;l1&quot;, &quot;v1&quot;);
290      labels.put(&quot;l2&quot;, &quot;v2&quot;);
291      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesAdd1&quot;, TSCreateParams.createParams().retention(10000L).labels(labels)));
292      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesAdd2&quot;, TSCreateParams.createParams().retention(10000L).labels(labels)));
293      List&lt;Long&gt; result = client.tsMAdd(
294          new KeyValue&lt;&gt;(&quot;seriesAdd1&quot;, new TSElement(1000L, 1.1)),
295          new KeyValue&lt;&gt;(&quot;seriesAdd2&quot;, new TSElement(2000L, 3.2)),
296          new KeyValue&lt;&gt;(&quot;seriesAdd1&quot;, new TSElement(1500L, 2.67)),
297          new KeyValue&lt;&gt;(&quot;seriesAdd2&quot;, new TSElement(3200L, 54.2)),
298          new KeyValue&lt;&gt;(&quot;seriesAdd2&quot;, new TSElement(4300L, 21.2)));
299      assertEquals(1000L, result.get(0).longValue());
300      assertEquals(2000L, result.get(1).longValue());
301      assertEquals(1500L, result.get(2).longValue());
302      assertEquals(3200L, result.get(3).longValue());
303      assertEquals(4300L, result.get(4).longValue());
304      List&lt;TSElement&gt; values1 = client.tsRange(&quot;seriesAdd1&quot;, 0, Long.MAX_VALUE);
305      assertEquals(2, values1.size());
306      assertEquals(1.1, values1.get(0).getValue(), 0.001);
307      assertEquals(2.67, values1.get(1).getValue(), 0.001);
308      List&lt;TSElement&gt; values2 = client.tsRange(&quot;seriesAdd2&quot;, TSRangeParams.rangeParams(0, Long.MAX_VALUE).count(2));
309      assertEquals(2, values2.size());
310      assertEquals(3.2, values2.get(0).getValue(), 0.001);
311      assertEquals(54.2, values2.get(1).getValue(), 0.001);
312    }
313    @Test
314    public void testIncrByDecrBy() throws InterruptedException {
315      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesIncDec&quot;,
316          TSCreateParams.createParams().retention(100 * 1000 &amp;bsol;*100 sec*/)));
317      assertEquals(1L, client.tsAdd(&quot;seriesIncDec&quot;, 1L, 1), 0);
318      assertEquals(2L, client.tsIncrBy(&quot;seriesIncDec&quot;, 3, 2L), 0);
319      assertEquals(3L, client.tsDecrBy(&quot;seriesIncDec&quot;, 2, 3L), 0);
320      List&lt;TSElement&gt; values = client.tsRange(&quot;seriesIncDec&quot;, 1L, 3L);
321      assertEquals(3, values.size());
322      assertEquals(2, values.get(2).getValue(), 0);
323      assertEquals(3L, client.tsDecrBy(&quot;seriesIncDec&quot;, 2, 3L), 0);
324      values = client.tsRange(&quot;seriesIncDec&quot;, 1L, Long.MAX_VALUE);
325      assertEquals(3, values.size());
326      client.tsIncrBy(&quot;seriesIncDec&quot;, 100);
327      client.tsDecrBy(&quot;seriesIncDec&quot;, 33);
328    }
329    @Test
330    public void align() {
331      client.tsAdd(&quot;align&quot;, 1, 10d);
332      client.tsAdd(&quot;align&quot;, 3, 5d);
333      client.tsAdd(&quot;align&quot;, 11, 10d);
334      client.tsAdd(&quot;align&quot;, 25, 11d);
335      List&lt;TSElement&gt; values = client.tsRange(&quot;align&quot;, TSRangeParams.rangeParams(1L, 30L).aggregation(AggregationType.COUNT, 10));
336      assertEquals(Arrays.asList(new TSElement(1, 2), new TSElement(11, 1), new TSElement(21, 1)), values);
337      values = client.tsRange(&quot;align&quot;, TSRangeParams.rangeParams(1L, 30L).alignStart().aggregation(AggregationType.COUNT, 10));
338      assertEquals(Arrays.asList(new TSElement(1, 2), new TSElement(11, 1), new TSElement(21, 1)), values);
339      values = client.tsRange(&quot;align&quot;, TSRangeParams.rangeParams(1L, 30L).alignEnd().aggregation(AggregationType.COUNT, 10));
340      assertEquals(Arrays.asList(new TSElement(1, 2), new TSElement(11, 1), new TSElement(21, 1)), values);
341      values =
342          client.tsRange(&quot;align&quot;, TSRangeParams.rangeParams(1L, 30L).align(5).aggregation(AggregationType.COUNT, 10));
343      assertEquals(Arrays.asList(new TSElement(1, 2), new TSElement(11, 1), new TSElement(21, 1)), values);
344    }
345    @Test
346    public void rangeFilterBy() {
347      TSElement[] rawValues =
348          new TSElement[] {
<span onclick='openModal()' class='match'>349            new TSElement(1000L, 1.0),
350            new TSElement(2000L, 0.9),
351            new TSElement(3200L, 1.1),
</span>352            new TSElement(4500L, -1.1)
353          };
354      for (TSElement value : rawValues) {
355        client.tsAdd(&quot;filterBy&quot;, value.getTimestamp(), value.getValue());
356      }
357      List&lt;TSElement&gt; values = client.tsRange(&quot;filterBy&quot;, 0L, 5000L);
358      assertEquals(Arrays.asList(rawValues), values);
359      values = client.tsRange(&quot;filterBy&quot;, TSRangeParams.rangeParams(0L, 5000L).filterByTS(1000L, 2000L));
360      assertEquals(Arrays.asList(rawValues[0], rawValues[1]), values);
361      values = client.tsRange(&quot;filterBy&quot;, TSRangeParams.rangeParams(0L, 5000L).filterByValues(1.0, 1.2));
362      assertEquals(Arrays.asList(rawValues[0], rawValues[2]), values);
363      values = client.tsRange(&quot;filterBy&quot;, TSRangeParams.rangeParams(0L, 5000L).filterByTS(1000L, 2000L).filterByValues(1.0, 1.2));
364      assertEquals(Arrays.asList(rawValues[0]), values);
365      values = client.tsRevRange(&quot;filterBy&quot;, 0L, 5000L);
366      assertEquals(Arrays.asList(rawValues[3], rawValues[2], rawValues[1], rawValues[0]), values);
367      values =
368          client.tsRevRange(&quot;filterBy&quot;, TSRangeParams.rangeParams(0L, 5000L).filterByTS(1000L, 2000L));
369      assertEquals(Arrays.asList(rawValues[1], rawValues[0]), values);
370      values =
371          client.tsRevRange(&quot;filterBy&quot;, TSRangeParams.rangeParams(0L, 5000L).filterByValues(1.0, 1.2));
372      assertEquals(Arrays.asList(rawValues[2], rawValues[0]), values);
373      values =
374          client.tsRevRange(&quot;filterBy&quot;, TSRangeParams.rangeParams(0L, 5000L).filterByTS(1000L, 2000L).filterByValues(1.0, 1.2));
375      assertEquals(Arrays.asList(rawValues[0]), values);
376    }
377    @Test
378    public void mrangeFilterBy() {
379      Map&lt;String, String&gt; labels = Collections.singletonMap(&quot;label&quot;, &quot;multi&quot;);
380      client.tsCreate(&quot;ts1&quot;, TSCreateParams.createParams().labels(labels));
381      client.tsCreate(&quot;ts2&quot;, TSCreateParams.createParams().labels(labels));
382      String filter = &quot;label=multi&quot;;
383      TSElement[] rawValues = new TSElement[]{
384        new TSElement(1000L, 1.0),
385        new TSElement(2000L, 0.9),
386        new TSElement(3200L, 1.1),
387        new TSElement(4500L, -1.1)
388      };
389      client.tsAdd(&quot;ts1&quot;, rawValues[0].getTimestamp(), rawValues[0].getValue());
390      client.tsAdd(&quot;ts2&quot;, rawValues[1].getTimestamp(), rawValues[1].getValue());
391      client.tsAdd(&quot;ts2&quot;, rawValues[2].getTimestamp(), rawValues[2].getValue());
392      client.tsAdd(&quot;ts1&quot;, rawValues[3].getTimestamp(), rawValues[3].getValue());
393      Map&lt;String, TSMRangeElements&gt; range = client.tsMRange(0L, 5000L, filter);
394      ArrayList&lt;TSMRangeElements&gt; rangeList = new ArrayList&lt;&gt;(range.values());
395      assertEquals(&quot;ts1&quot;, rangeList.get(0).getKey());
396      assertEquals(Arrays.asList(rawValues[0], rawValues[3]), rangeList.get(0).getValue());
397      assertEquals(&quot;ts2&quot;, rangeList.get(1).getKey());
398      assertEquals(Arrays.asList(rawValues[1], rawValues[2]), rangeList.get(1).getValue());
399      range = client.tsMRange(TSMRangeParams.multiRangeParams(0L, 5000L).filterByTS(1000L, 2000L).filter(filter));
400      rangeList = new ArrayList&lt;&gt;(range.values());
401      assertEquals(&quot;ts1&quot;, rangeList.get(0).getKey());
402      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
403      assertEquals(&quot;ts2&quot;, rangeList.get(1).getKey());
404      assertEquals(Arrays.asList(rawValues[1]), rangeList.get(1).getValue());
405      range = client.tsMRange(TSMRangeParams.multiRangeParams(0L, 5000L).filterByValues(1.0, 1.2).filter(filter));
406      rangeList = new ArrayList&lt;&gt;(range.values());
407      assertEquals(&quot;ts1&quot;, rangeList.get(0).getKey());
408      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
409      assertEquals(&quot;ts2&quot;, rangeList.get(1).getKey());
410      assertEquals(Arrays.asList(rawValues[2]), rangeList.get(1).getValue());
411      range = client.tsMRange(TSMRangeParams.multiRangeParams(0L, 5000L)
412          .filterByTS(1000L, 2000L).filterByValues(1.0, 1.2).filter(filter));
413      rangeList = new ArrayList&lt;&gt;(range.values());
414      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
415      range = client.tsMRevRange(0L, 5000L,  filter);
416      rangeList = new ArrayList&lt;&gt;(range.values());
417      assertEquals(&quot;ts1&quot;, rangeList.get(0).getKey());
418      assertEquals(Arrays.asList(rawValues[3], rawValues[0]), rangeList.get(0).getValue());
419      assertEquals(&quot;ts2&quot;, rangeList.get(1).getKey());
420      assertEquals(Arrays.asList(rawValues[2], rawValues[1]), rangeList.get(1).getValue());
421      range = client.tsMRevRange(TSMRangeParams.multiRangeParams(0L, 5000L).filterByTS(1000L, 2000L).filter(filter));
422      rangeList = new ArrayList&lt;&gt;(range.values());
423      assertEquals(&quot;ts1&quot;, rangeList.get(0).getKey());
424      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
425      assertEquals(&quot;ts2&quot;, rangeList.get(1).getKey());
426      assertEquals(Arrays.asList(rawValues[1]), rangeList.get(1).getValue());
427      range = client.tsMRevRange(TSMRangeParams.multiRangeParams(0L, 5000L).filterByValues(1.0, 1.2).filter(filter));
428      rangeList = new ArrayList&lt;&gt;(range.values());
429      assertEquals(&quot;ts1&quot;, rangeList.get(0).getKey());
430      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
431      assertEquals(&quot;ts2&quot;, rangeList.get(1).getKey());
432      assertEquals(Arrays.asList(rawValues[2]), rangeList.get(1).getValue());
433      range = client.tsMRevRange(TSMRangeParams.multiRangeParams(0L, 5000L)
434          .filterByTS(1000L, 2000L).filterByValues(1.0, 1.2).filter(filter));
435      rangeList = new ArrayList&lt;&gt;(range.values());
436      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
437    }
438    @Test
439    public void groupByReduce() {
440      client.tsCreate(&quot;ts1&quot;, TSCreateParams.createParams().labels(convertMap(&quot;metric&quot;, &quot;cpu&quot;, &quot;metric_name&quot;, &quot;system&quot;)));
441      client.tsCreate(&quot;ts2&quot;, TSCreateParams.createParams().labels(convertMap(&quot;metric&quot;, &quot;cpu&quot;, &quot;metric_name&quot;, &quot;user&quot;)));
442      client.tsAdd(&quot;ts1&quot;, 1L, 90.0);
443      client.tsAdd(&quot;ts1&quot;, 2L, 45.0);
444      client.tsAdd(&quot;ts2&quot;, 2L, 99.0);
445      Map&lt;String, TSMRangeElements&gt; range = client.tsMRange(TSMRangeParams.multiRangeParams(0L, 100L).withLabels()
446          .filter(&quot;metric=cpu&quot;).groupBy(&quot;metric_name&quot;, &quot;max&quot;));
447      assertEquals(2, range.size());
448      ArrayList&lt;TSMRangeElements&gt; rangeList = new ArrayList&lt;&gt;(range.values());
449      assertEquals(&quot;metric_name=system&quot;, rangeList.get(0).getKey());
450      assertEquals(&quot;system&quot;, rangeList.get(0).getLabels().get(&quot;metric_name&quot;));
451      if (protocol != RedisProtocol.RESP3) {
452        assertEquals(&quot;max&quot;, rangeList.get(0).getLabels().get(&quot;__reducer__&quot;));
453        assertEquals(&quot;ts1&quot;, rangeList.get(0).getLabels().get(&quot;__source__&quot;));
454      } else {
455        assertEquals(Arrays.asList(&quot;max&quot;), rangeList.get(0).getReducers());
456        assertEquals(Arrays.asList(&quot;ts1&quot;), rangeList.get(0).getSources());
457      }
458      assertEquals(Arrays.asList(new TSElement(1, 90), new TSElement(2, 45)), rangeList.get(0).getValue());
459      assertEquals(&quot;metric_name=user&quot;, rangeList.get(1).getKey());
460      assertEquals(&quot;user&quot;, rangeList.get(1).getLabels().get(&quot;metric_name&quot;));
461      if (protocol != RedisProtocol.RESP3) {
462        assertEquals(&quot;max&quot;, rangeList.get(1).getLabels().get(&quot;__reducer__&quot;));
463        assertEquals(&quot;ts2&quot;, rangeList.get(1).getLabels().get(&quot;__source__&quot;));
464      } else {
465        assertEquals(Arrays.asList(&quot;max&quot;), rangeList.get(1).getReducers());
466        assertEquals(Arrays.asList(&quot;ts2&quot;), rangeList.get(1).getSources());
467      }
468      assertEquals(Arrays.asList(new TSElement(2, 99)), rangeList.get(1).getValue());
469    }
470    private Map&lt;String, String&gt; convertMap(String... array) {
471      Map&lt;String, String&gt; map = new HashMap&lt;&gt;(array.length / 2);
472      for (int i = 0; i &lt; array.length; i += 2) {
473        map.put(array[i], array[i + 1]);
474      }
475      return map;
476    }
477    @Test
478    public void testGet() {
479      try {
480        client.tsGet(&quot;seriesGet&quot;);
481        fail();
482      } catch (JedisDataException e) {
483      }
484      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesGet&quot;, TSCreateParams.createParams()
485          .retention(100 * 1000 &amp;bsol;*100sec retentionTime*/)));
486      assertNull(client.tsGet(&quot;seriesGet&quot;));
487      client.tsAdd(&quot;seriesGet&quot;, 2558, 8.7);
488      assertEquals(new TSElement(2558, 8.7), client.tsGet(&quot;seriesGet&quot;));
489      client.tsAdd(&quot;seriesGet&quot;, 3458, 1.117);
490      assertEquals(new TSElement(3458, 1.117), client.tsGet(&quot;seriesGet&quot;));
491    }
492    @Test
493    public void testMGet() {
494      Map&lt;String, String&gt; labels = new HashMap&lt;&gt;();
495      labels.put(&quot;l1&quot;, &quot;v1&quot;);
496      labels.put(&quot;l2&quot;, &quot;v2&quot;);
497      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesMGet1&quot;, TSCreateParams.createParams()
498          .retention(100 * 1000 &amp;bsol;*100sec retentionTime*/).labels(labels)));
499      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesMGet2&quot;, TSCreateParams.createParams()
500          .retention(100 * 1000 &amp;bsol;*100sec retentionTime*/).labels(labels)));
501      Map&lt;String, TSMGetElement&gt; ranges1 = client.tsMGet(TSMGetParams.multiGetParams().withLabels(false), &quot;l1=v2&quot;);
502      assertEquals(0, ranges1.size());
503      Map&lt;String, TSMGetElement&gt; ranges2 = client.tsMGet(TSMGetParams.multiGetParams().withLabels(true), &quot;l1=v1&quot;);
504      assertEquals(2, ranges2.size());
505      ArrayList&lt;TSMGetElement&gt; ranges2List = new ArrayList&lt;&gt;(ranges2.values());
506      assertEquals(labels, ranges2List.get(0).getLabels());
507      assertEquals(labels, ranges2List.get(1).getLabels());
508      assertNull(ranges2List.get(0).getValue());
509      client.tsAdd(&quot;seriesMGet1&quot;, 1500, 1.3);
510      Map&lt;String, TSMGetElement&gt; ranges3 = client.tsMGet(TSMGetParams.multiGetParams().withLabels(false), &quot;l1=v1&quot;);
511      assertEquals(2, ranges3.size());
512      ArrayList&lt;TSMGetElement&gt; ranges3List = new ArrayList&lt;&gt;(ranges3.values());
513      assertEquals(Collections.emptyMap(), ranges3List.get(0).getLabels());
514      assertEquals(Collections.emptyMap(), ranges3List.get(1).getLabels());
515      assertEquals(new TSElement(1500, 1.3), ranges3List.get(0).getValue());
516      assertNull(ranges3List.get(1).getValue());
517    }
518    @Test
519    public void testQueryIndex() {
520      Map&lt;String, String&gt; labels = new HashMap&lt;&gt;();
521      labels.put(&quot;l1&quot;, &quot;v1&quot;);
522      labels.put(&quot;l2&quot;, &quot;v2&quot;);
523      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesQueryIndex1&quot;, TSCreateParams.createParams()
524          .retention(100 * 1000 &amp;bsol;*100sec retentionTime*/).labels(labels)));
525      labels.put(&quot;l2&quot;, &quot;v22&quot;);
526      labels.put(&quot;l3&quot;, &quot;v33&quot;);
527      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesQueryIndex2&quot;, TSCreateParams.createParams()
528          .retention(100 * 1000 &amp;bsol;*100sec retentionTime*/).labels(labels)));
529      assertEquals(Arrays.&lt;String&gt;asList(), client.tsQueryIndex(&quot;l1=v2&quot;));
530      assertEquals(Arrays.asList(&quot;seriesQueryIndex1&quot;, &quot;seriesQueryIndex2&quot;), client.tsQueryIndex(&quot;l1=v1&quot;));
531      assertEquals(Arrays.asList(&quot;seriesQueryIndex2&quot;), client.tsQueryIndex(&quot;l2=v22&quot;));
532    }
533    @Test
534    public void testInfo() {
535      Map&lt;String, String&gt; labels = new HashMap&lt;&gt;();
536      labels.put(&quot;l1&quot;, &quot;v1&quot;);
537      labels.put(&quot;l2&quot;, &quot;v2&quot;);
538      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;source&quot;, TSCreateParams.createParams().retention(10000L).labels(labels)));
539      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;dest&quot;, TSCreateParams.createParams().retention(20000L)));
540      assertEquals(&quot;OK&quot;, client.tsCreateRule(&quot;source&quot;, &quot;dest&quot;, AggregationType.AVG, 100));
541      TSInfo info = client.tsInfo(&quot;source&quot;);
542      assertEquals((Long) 10000L, info.getProperty(&quot;retentionTime&quot;));
543      assertEquals((Long) 4096L, info.getProperty(&quot;chunkSize&quot;));
544      assertEquals(&quot;v1&quot;, info.getLabel(&quot;l1&quot;));
545      assertEquals(&quot;v2&quot;, info.getLabel(&quot;l2&quot;));
546      assertNull(info.getLabel(&quot;l3&quot;));
547      assertEquals(1, info.getRules().size());
548      TSInfo.Rule rule = info.getRule(&quot;dest&quot;);
549      assertEquals(&quot;dest&quot;, rule.getCompactionKey());
550      assertEquals(100L, rule.getBucketDuration());
551      assertEquals(AggregationType.AVG, rule.getAggregator());
552      try {
553        client.tsInfo(&quot;none&quot;);
554        fail();
555      } catch (JedisDataException e) {
556      }
557    }
558    @Test
559    public void testInfoDebug() {
560      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;source&quot;, TSCreateParams.createParams()));
561      TSInfo info = client.tsInfoDebug(&quot;source&quot;);
562      assertEquals((Long) 0L, info.getProperty(&quot;retentionTime&quot;));
563      assertEquals(0, info.getLabels().size());
564      assertEquals(0, info.getRules().size());
565      List&lt;Map&lt;String, Object&gt;&gt; chunks = info.getChunks();
566      assertEquals(1, chunks.size());
567      Map&lt;String, Object&gt; chunk = chunks.get(0);
568      assertEquals(0L, chunk.get(&quot;samples&quot;));
569      assertTrue(chunk.get(&quot;size&quot;) instanceof Long);
570      assertTrue(chunk.get(&quot;startTimestamp&quot;) instanceof Long);
571      assertTrue(chunk.get(&quot;endTimestamp&quot;) instanceof Long);
572      assertTrue(chunk.get(&quot;bytesPerSample&quot;) instanceof Double);
573      try {
574        client.tsInfoDebug(&quot;none&quot;);
575        fail();
576      } catch (JedisDataException e) {
577      }
578    }
579    @Test
580    public void testRevRange() {
581      Map&lt;String, String&gt; labels = new HashMap&lt;&gt;();
582      labels.put(&quot;l1&quot;, &quot;v1&quot;);
583      labels.put(&quot;l2&quot;, &quot;v2&quot;);
584      assertEquals(&quot;OK&quot;, client.tsCreate(&quot;seriesAdd&quot;, TSCreateParams.createParams().retention(10000L).labels(labels)));
585      assertEquals(Collections.emptyList(), client.tsRevRange(&quot;seriesAdd&quot;, TSRangeParams.rangeParams()));
586      assertEquals(1000L, client.tsAdd(&quot;seriesRevRange&quot;, 1000L, 1.1, TSCreateParams.createParams().retention(10000)));
587      assertEquals(2000L, client.tsAdd(&quot;seriesRevRange&quot;, 2000L, 0.9, TSCreateParams.createParams().labels(null)));
588      assertEquals(3200L, client.tsAdd(&quot;seriesRevRange&quot;, 3200L, 1.1, TSCreateParams.createParams().retention(10000)));
589      assertEquals(4500L, client.tsAdd(&quot;seriesRevRange&quot;, 4500L, -1.1));
590      TSElement[] rawValues = new TSElement[]{
591        new TSElement(4500L, -1.1),
592        new TSElement(3200L, 1.1),
593        new TSElement(2000L, 0.9),
594        new TSElement(1000L, 1.1)
595      };
596      List&lt;TSElement&gt; values = client.tsRevRange(&quot;seriesRevRange&quot;, 800L, 3000L);
597      assertEquals(2, values.size());
598      assertEquals(Arrays.asList(Arrays.copyOfRange(rawValues, 2, 4)), values);
599      values = client.tsRevRange(&quot;seriesRevRange&quot;, 800L, 5000L);
600      assertEquals(4, values.size());
601      assertEquals(Arrays.asList(rawValues), values);
602      assertEquals(Arrays.asList(rawValues), client.tsRevRange(&quot;seriesRevRange&quot;, TSRangeParams.rangeParams()));
603      List&lt;TSElement&gt; expectedCountValues = Arrays.asList(
604          new TSElement(4500L, 1), new TSElement(3200L, 1), new TSElement(2000L, 1));
605      values = client.tsRevRange(&quot;seriesRevRange&quot;, TSRangeParams.rangeParams(1200L, 4600L)
606          .aggregation(AggregationType.COUNT, 1));
607      assertEquals(3, values.size());
608      assertEquals(expectedCountValues, values);
609      List&lt;TSElement&gt; expectedAvgValues = Arrays.asList(
610          new TSElement(4000L, -1.1), new TSElement(2000L, 1), new TSElement(0L, 1.1));
611      values = client.tsRevRange(&quot;seriesRevRange&quot;, TSRangeParams.rangeParams(500L, 4600L)
612          .aggregation(AggregationType.AVG, 2000L));
613      assertEquals(3, values.size());
614      assertEquals(expectedAvgValues, values);
615    }
616    @Test
617    public void testMRevRange() {
618      assertEquals(Collections.emptyMap(), client.tsMRevRange(TSMRangeParams.multiRangeParams().filter(&quot;l=v&quot;)));
619      Map&lt;String, String&gt; labels1 = new HashMap&lt;&gt;();
620      labels1.put(&quot;l3&quot;, &quot;v3&quot;);
621      labels1.put(&quot;l4&quot;, &quot;v4&quot;);
622      assertEquals(1000L, client.tsAdd(&quot;seriesMRevRange1&quot;, 1000L, 1.1,
623          TSCreateParams.createParams().retention(10000).labels(labels1)));
624      assertEquals(2222L, client.tsAdd(&quot;seriesMRevRange1&quot;, 2222L, 3.1,
625          TSCreateParams.createParams().retention(10000).labels(labels1)));
626      Map&lt;String, TSMRangeElements&gt; ranges1 = client.tsMRevRange(TSMRangeParams.multiRangeParams(500L, 4600L)
627          .aggregation(AggregationType.COUNT, 1).withLabels().filter(&quot;l4=v4&quot;));
628      assertEquals(1, ranges1.size());
629      ArrayList&lt;TSMRangeElements&gt; ranges1List = new ArrayList&lt;&gt;(ranges1.values());
630      assertEquals(labels1, ranges1List.get(0).getLabels());
631      assertEquals(Arrays.asList(new TSElement(2222L, 1.0), new TSElement(1000L, 1.0)), ranges1List.get(0).getValue());
632      Map&lt;String, String&gt; labels2 = new HashMap&lt;&gt;();
633      labels2.put(&quot;l3&quot;, &quot;v3&quot;);
634      labels2.put(&quot;l4&quot;, &quot;v44&quot;);
635      assertEquals(1000L, client.tsAdd(&quot;seriesMRevRange2&quot;, 1000L, 8.88,
636          TSCreateParams.createParams().retention(10000).labels(labels2)));
637      assertEquals(1111L, client.tsAdd(&quot;seriesMRevRange2&quot;, 1111L, 99.99,
638          TSCreateParams.createParams().retention(10000).labels(labels2)));
639      Map&lt;String, TSMRangeElements&gt; ranges2 = client.tsMRevRange(500L, 4600L, &quot;l3=v3&quot;);
640      assertEquals(2, ranges2.size());
641      ArrayList&lt;TSMRangeElements&gt; ranges2List = new ArrayList&lt;&gt;(ranges2.values());
642      assertEquals(Collections.emptyMap(), ranges2List.get(0).getLabels());
643      assertEquals(Arrays.asList(new TSElement(2222L, 3.1), new TSElement(1000L, 1.1)), ranges2List.get(0).getValue());
644      assertEquals(Collections.emptyMap(), ranges2List.get(0).getLabels());
645      assertEquals(Arrays.asList(new TSElement(1111L, 99.99), new TSElement(1000L, 8.88)), ranges2List.get(1).getValue());
646      Map&lt;String, String&gt; labels3 = new HashMap&lt;&gt;();
647      labels3.put(&quot;l3&quot;, &quot;v33&quot;);
648      labels3.put(&quot;l4&quot;, &quot;v4&quot;);
649      assertEquals(2200L, client.tsAdd(&quot;seriesMRevRange3&quot;, 2200L, -1.1, TSCreateParams.createParams().labels(labels3)));
650      assertEquals(2400L, client.tsAdd(&quot;seriesMRevRange3&quot;, 2400L, 1.1, TSCreateParams.createParams().labels(labels3)));
651      assertEquals(3300L, client.tsAdd(&quot;seriesMRevRange3&quot;, 3300L, -33, TSCreateParams.createParams().labels(labels3)));
652      Map&lt;String, TSMRangeElements&gt; ranges3 = client.tsMRevRange(TSMRangeParams.multiRangeParams(500L, 4600L)
653          .aggregation(AggregationType.AVG, 500).withLabels().count(5).filter(&quot;l4=v4&quot;));
654      assertEquals(2, ranges3.size());
655      ArrayList&lt;TSMRangeElements&gt; ranges3List = new ArrayList&lt;&gt;(ranges3.values());
656      assertEquals(labels1, ranges3List.get(0).getLabels());
657      assertEquals(Arrays.asList(new TSElement(2000L, 3.1), new TSElement(1000L, 1.1)), ranges3List.get(0).getValue());
658      assertEquals(labels3, ranges3List.get(1).getLabels());
659      assertEquals(Arrays.asList(new TSElement(3000L, -33.0), new TSElement(2000L, 0.0)), ranges3List.get(1).getValue());
660    }
661    @Test
662    public void latest() {
663      client.tsCreate(&quot;ts1&quot;);
664      client.tsCreate(&quot;ts2&quot;);
665      client.tsCreateRule(&quot;ts1&quot;, &quot;ts2&quot;, AggregationType.SUM, 10);
666      client.tsAdd(&quot;ts1&quot;, 1, 1);
667      client.tsAdd(&quot;ts1&quot;, 2, 3);
668      client.tsAdd(&quot;ts1&quot;, 11, 7);
669      client.tsAdd(&quot;ts1&quot;, 13, 1);
670      List&lt;TSElement&gt; range = client.tsRange(&quot;ts1&quot;, 0, 20);
671      assertEquals(4, range.size());
672      final TSElement compact = new TSElement(0, 4);
673      final TSElement latest = new TSElement(10, 8);
674      assertEquals(compact, client.tsGet(&quot;ts2&quot;, TSGetParams.getParams()));
675      assertEquals(latest, client.tsGet(&quot;ts2&quot;, TSGetParams.getParams().latest()));
676      assertEquals(Arrays.asList(compact), client.tsRange(&quot;ts2&quot;, TSRangeParams.rangeParams(0, 10)));
677      assertEquals(Arrays.asList(compact, latest), client.tsRange(&quot;ts2&quot;, TSRangeParams.rangeParams(0, 10).latest()));
678      assertEquals(Arrays.asList(compact), client.tsRevRange(&quot;ts2&quot;, TSRangeParams.rangeParams(0, 10)));
679      assertEquals(Arrays.asList(latest, compact), client.tsRevRange(&quot;ts2&quot;, TSRangeParams.rangeParams(0, 10).latest()));
680    }
681    @Test
682    public void latestMulti() {
683      client.tsCreate(&quot;ts1&quot;);
684      client.tsCreate(&quot;ts2&quot;, TSCreateParams.createParams().label(&quot;compact&quot;, &quot;true&quot;));
685      client.tsCreateRule(&quot;ts1&quot;, &quot;ts2&quot;, AggregationType.SUM, 10);
686      client.tsAdd(&quot;ts1&quot;, 1, 1);
687      client.tsAdd(&quot;ts1&quot;, 2, 3);
688      client.tsAdd(&quot;ts1&quot;, 11, 7);
689      client.tsAdd(&quot;ts1&quot;, 13, 1);
690      List&lt;TSElement&gt; range = client.tsRange(&quot;ts1&quot;, 0, 20);
691      assertEquals(4, range.size());
692      final TSElement compact = new TSElement(0, 4);
693      final TSElement latest = new TSElement(10, 8);
694      assertEquals(makeSingletonMap(new TSMGetElement(&quot;ts2&quot;, null, compact)),
695          client.tsMGet(TSMGetParams.multiGetParams(), &quot;compact=true&quot;));
696      assertEquals(makeSingletonMap(new TSMGetElement(&quot;ts2&quot;, null, latest)),
697          client.tsMGet(TSMGetParams.multiGetParams().latest(), &quot;compact=true&quot;));
698      assertEquals(makeSingletonMap(new TSMRangeElements(&quot;ts2&quot;, null, Arrays.asList(compact))),
699          client.tsMRange(TSMRangeParams.multiRangeParams().filter(&quot;compact=true&quot;)));
700      assertEquals(makeSingletonMap(new TSMRangeElements(&quot;ts2&quot;, null, Arrays.asList(compact, latest))),
701          client.tsMRange(TSMRangeParams.multiRangeParams().latest().filter(&quot;compact=true&quot;)));
702      assertEquals(makeSingletonMap(new TSMRangeElements(&quot;ts2&quot;, null, Arrays.asList(compact))),
703          client.tsMRevRange(TSMRangeParams.multiRangeParams().filter(&quot;compact=true&quot;)));
704      assertEquals(makeSingletonMap(new TSMRangeElements(&quot;ts2&quot;, null, Arrays.asList(latest, compact))),
705          client.tsMRevRange(TSMRangeParams.multiRangeParams().latest().filter(&quot;compact=true&quot;)));
706    }
707    private Map&lt;String, TSMGetElement&gt; makeSingletonMap(TSMGetElement value) {
708      return Collections.singletonMap(value.getKey(), value);
709    }
710    private Map&lt;String, TSMRangeElements&gt; makeSingletonMap(TSMRangeElements value) {
711      return Collections.singletonMap(value.getKey(), value);
712    }
713    @Test
714    public void empty() {
715      client.tsCreate(&quot;ts&quot;, TSCreateParams.createParams().label(&quot;l&quot;, &quot;v&quot;));
716      client.tsAdd(&quot;ts&quot;, 1, 1);
717      client.tsAdd(&quot;ts&quot;, 2, 3);
718      client.tsAdd(&quot;ts&quot;, 11, 7);
719      client.tsAdd(&quot;ts&quot;, 13, 1);
720      List&lt;TSElement&gt; range = client.tsRange(&quot;ts&quot;, TSRangeParams.rangeParams().aggregation(AggregationType.MAX, 5));
721      assertEquals(2, range.size());
722      range = client.tsRange(&quot;ts&quot;, TSRangeParams.rangeParams().aggregation(AggregationType.MAX, 5).empty());
723      assertEquals(3, range.size());
724      assertNotNull(range.get(1).getValue()); 
725      range = client.tsRevRange(&quot;ts&quot;, TSRangeParams.rangeParams().aggregation(AggregationType.MIN, 5));
726      assertEquals(2, range.size());
727      range = client.tsRevRange(&quot;ts&quot;, TSRangeParams.rangeParams().aggregation(AggregationType.MIN, 5).empty());
728      assertEquals(3, range.size());
729      assertNotNull(range.get(1).getValue()); 
730      Map&lt;String, TSMRangeElements&gt; mrange = client.tsMRange(TSMRangeParams.multiRangeParams()
731          .aggregation(AggregationType.MIN, 5).filter(&quot;l=v&quot;));
732      assertEquals(1, mrange.size());
733      ArrayList&lt;TSMRangeElements&gt; mrangeList = new ArrayList&lt;&gt;(mrange.values());
734      assertEquals(2, mrangeList.get(0).getValue().size());
735      mrange = client.tsMRange(TSMRangeParams.multiRangeParams()
736          .aggregation(AggregationType.MIN, 5).empty().filter(&quot;l=v&quot;));
737      assertEquals(1, mrange.size());
738      mrangeList = new ArrayList&lt;&gt;(mrange.values());
739      assertEquals(3, mrangeList.get(0).getValue().size());
740      assertNotNull(mrangeList.get(0).getValue().get(1).getValue()); 
741      mrange = client.tsMRevRange(TSMRangeParams.multiRangeParams()
742          .aggregation(AggregationType.MAX, 5).filter(&quot;l=v&quot;));
743      assertEquals(1, mrange.size());
744      mrangeList = new ArrayList&lt;&gt;(mrange.values());
745      assertEquals(2, mrangeList.get(0).getValue().size());
746      mrange = client.tsMRevRange(TSMRangeParams.multiRangeParams()
747          .aggregation(AggregationType.MAX, 5).empty().filter(&quot;l=v&quot;));
748      assertEquals(1, mrange.size());
749      mrangeList = new ArrayList&lt;&gt;(mrange.values());
750      assertEquals(3, mrangeList.get(0).getValue().size());
751      assertNotNull(mrangeList.get(0).getValue().get(1).getValue()); 
752    }
753    @Test
754    public void bucketTimestamp() {
755      client.tsCreate(&quot;ts&quot;, TSCreateParams.createParams().label(&quot;l&quot;, &quot;v&quot;));
756      client.tsAdd(&quot;ts&quot;, 1, 1);
757      client.tsAdd(&quot;ts&quot;, 2, 3);
758      assertEquals(0, client.tsRange(&quot;ts&quot;, TSRangeParams.rangeParams()
759          .aggregation(AggregationType.FIRST, 10).bucketTimestampLow()).get(0).getTimestamp());
760      assertEquals(10, client.tsRange(&quot;ts&quot;, TSRangeParams.rangeParams()
761          .aggregation(AggregationType.LAST, 10).bucketTimestampHigh()).get(0).getTimestamp());
762      assertEquals(5, client.tsRange(&quot;ts&quot;, TSRangeParams.rangeParams()
763          .aggregation(AggregationType.RANGE, 10).bucketTimestampMid()).get(0).getTimestamp());
764      assertEquals(5, client.tsRevRange(&quot;ts&quot;, TSRangeParams.rangeParams()
765          .aggregation(AggregationType.TWA, 10).bucketTimestampMid()).get(0).getTimestamp());
766      assertEquals(5, client.tsRevRange(&quot;ts&quot;, TSRangeParams.rangeParams()
767          .aggregation(AggregationType.TWA, 10).bucketTimestamp(&quot;mid&quot;)).get(0).getTimestamp());
768      assertEquals(0, client.tsMRange(TSMRangeParams.multiRangeParams()
769          .aggregation(AggregationType.STD_P, 10).bucketTimestampLow().filter(&quot;l=v&quot;))
770          .values().stream().findAny().get().getValue().get(0).getTimestamp());
771      assertEquals(10, client.tsMRange(TSMRangeParams.multiRangeParams()
772          .aggregation(AggregationType.STD_S, 10).bucketTimestampHigh().filter(&quot;l=v&quot;))
773          .values().stream().findAny().get().getValue().get(0).getTimestamp());
774      assertEquals(5, client.tsMRange(TSMRangeParams.multiRangeParams()
775          .aggregation(AggregationType.TWA, 10).bucketTimestampMid().filter(&quot;l=v&quot;))
776          .values().stream().findAny().get().getValue().get(0).getTimestamp());
777      assertEquals(5, client.tsMRange(TSMRangeParams.multiRangeParams()
778          .aggregation(AggregationType.VAR_P, 10).bucketTimestampMid().filter(&quot;l=v&quot;))
779          .values().stream().findAny().get().getValue().get(0).getTimestamp());
780      assertEquals(5, client.tsMRange(TSMRangeParams.multiRangeParams()
781          .aggregation(AggregationType.VAR_S, 10).bucketTimestamp(&quot;~&quot;).filter(&quot;l=v&quot;))
782          .values().stream().findAny().get().getValue().get(0).getTimestamp());
783    }
784    @Test
785    public void alignTimestamp() {
786      client.tsCreate(&quot;ts1&quot;);
787      client.tsCreate(&quot;ts2&quot;);
788      client.tsCreate(&quot;ts3&quot;);
789      client.tsCreateRule(&quot;ts1&quot;, &quot;ts2&quot;, AggregationType.COUNT, 10, 0);
790      client.tsCreateRule(&quot;ts1&quot;, &quot;ts3&quot;, AggregationType.COUNT, 10, 1);
791      client.tsAdd(&quot;ts1&quot;, 1, 1);
792      client.tsAdd(&quot;ts1&quot;, 10, 3);
793      client.tsAdd(&quot;ts1&quot;, 21, 7);
794      assertEquals(2, client.tsRange(&quot;ts2&quot;, TSRangeParams.rangeParams().aggregation(AggregationType.COUNT, 10)).size());
795      assertEquals(1, client.tsRange(&quot;ts3&quot;, TSRangeParams.rangeParams().aggregation(AggregationType.COUNT, 10)).size());
796    }
797  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-TimeSeriesTest.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-TimeSeriesTest.java</div>
                </div>
                <div class="column column_space"><pre><code>592        new TSElement(3200L, 1.1),
593        new TSElement(2000L, 0.9),
594        new TSElement(1000L, 1.1)
</pre></code></div>
                <div class="column column_space"><pre><code>349            new TSElement(1000L, 1.0),
350            new TSElement(2000L, 0.9),
351            new TSElement(3200L, 1.1),
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    