<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for ColumnStatsTest.java &amp; DDLIntegrationTest.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for ColumnStatsTest.java &amp; DDLIntegrationTest.java
      </h3>
<h1 align="center">
        21.8%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>ColumnStatsTest.java (67.66467%)<th>DDLIntegrationTest.java (13.033448%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(102-112)<td><a href="#" name="0">(408-439)</a><td align="center"><font color="#ff0000">23</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(24-47)<td><a href="#" name="1">(41-64)</a><td align="center"><font color="#f30000">22</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(65-70)<td><a href="#" name="2">(754-758)</a><td align="center"><font color="#900000">13</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(113-121)<td><a href="#" name="3">(367-378)</a><td align="center"><font color="#850000">12</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(88-98)<td><a href="#" name="4">(342-353)</a><td align="center"><font color="#850000">12</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(53-56)<td><a href="#" name="5">(81-96)</a><td align="center"><font color="#850000">12</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(122-127)<td><a href="#" name="6">(138-148)</a><td align="center"><font color="#6e0000">10</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(57-61)<td><a href="#" name="7">(161-172)</a><td align="center"><font color="#630000">9</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>ColumnStatsTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Licensed to Crate.io GmbH ("Crate") under one or more contributor
3  * license agreements.  See the NOTICE file distributed with this work for
4  * additional information regarding copyright ownership.  Crate licenses
5  * this file to you under the Apache License, Version 2.0 (the "License");
6  * you may not use this file except in compliance with the License.  You may
7  * obtain a copy of the License at
8  *
9  *   http://www.apache.org/licenses/LICENSE-2.0
10  *
11  * Unless required by applicable law or agreed to in writing, software
12  * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
13  * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
14  * License for the specific language governing permissions and limitations
15  * under the License.
16  *
17  * However, if you have executed another commercial license agreement
18  * with Crate these terms will supersede the license and you may use the
19  * software solely pursuant to the terms of the relevant commercial agreement.
20  */
21 <a name="1"></a>
22 package io.crate.statistics;
23 <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import com.pholser.junit.quickcheck.Property;
24 import com.pholser.junit.quickcheck.generator.InRange;
25 import com.pholser.junit.quickcheck.runner.JUnitQuickcheck;
26 import io.crate.types.DataTypes;
27 import org.elasticsearch.common.io.stream.BytesStreamOutput;
28 import org.elasticsearch.common.io.stream.StreamInput;
29 import org.hamcrest.Matchers;
30 import org.junit.Test;
31 import org.junit.runner.RunWith;
32 import java.io.IOException;
33 import java.util.ArrayList;
34 import java.util.List;
35 import java.util.stream.Collectors;
36 import java.util.stream.IntStream;
37 import static org.hamcrest.Matchers.contains;
38 import static org.hamcrest.Matchers.greaterThanOrEqualTo;
39 import static org.hamcrest.Matchers.is;
40 import static org.hamcrest.Matchers.lessThanOrEqualTo;
41 import static org.junit.Assert.assertThat;
42 import static org.junit.Assume.assumeThat;
43 @</b></font>RunWith(JUnitQuickcheck.class)
44 public class ColumnStatsTest {
45 <a name="5"></a>    @Test
46     public void test_column_stats_generation() {
47         List&lt;Integer&gt; numbers = List.of(1, 1, 2, 4, 4, 4, 4, 4);
48         <font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>ColumnStats columnStats = ColumnStats.fromSortedValues(numbers, DataTypes.INTEGER, 1, 400L);
49 <a name="7"></a>        assertThat(columnStats.averageSizeInBytes(), is((double) DataTypes.INTEGER.fixedSize()));
50         assertThat(columnStats.nullFraction(), Matchers.closeTo(0.111, 0.01));
51         assertThat(columnStats.approxDistinct(), is</b></font>(3.0));
52         <font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>MostCommonValues mostCommonValues = columnStats.mostCommonValues();
53         assertThat(mostCommonValues.values().length, is(0));
54     }
55     @</b></font>Property
56 <a name="2"></a>    public void test_null_fraction_is_between_incl_0_and_incl_1(ArrayList&lt;Integer&gt; numbers,
57                                                                 @InRange(minInt = 0) int nullCount,
58                                                                 long totalRowCount) {
59         <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assumeThat(totalRowCount, greaterThanOrEqualTo((long) nullCount));
60         assumeThat((long) numbers.size() + nullCount, lessThanOrEqualTo(totalRowCount));
61         ColumnStats&lt;Integer&gt; stats = ColumnStats.fromSortedValues(numbers, DataTypes.INTEGER, nullCount, totalRowCount);
62         assertThat(stats.nullFraction(), greaterThanOrEqualTo(0.0));
63         assertThat(stats.nullFraction(), lessThanOrEqualTo</b></font>(1.0));
64     }
65     @Test
66     public void test_common_stats_can_be_serialized_and_deserialized() throws IOException  {
67         List&lt;Integer&gt; numbers = List.of(1, 1, 2, 4, 4, 4, 4, 4);
68         ColumnStats columnStats = ColumnStats.fromSortedValues(numbers, DataTypes.INTEGER, 1, 400L);
69         BytesStreamOutput out = new BytesStreamOutput();
70         columnStats.writeTo(out);
71         StreamInput in = out.bytes().streamInput();
72         ColumnStats stats = new ColumnStats(in);
73         assertThat(stats, is(columnStats));
74     }
75 <a name="4"></a>
76     @Test
77     public void test_column_stats_generation_for_num_samples_gt_mcv_target() {
78         List&lt;Integer&gt; numbers = <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>IntStream.concat(
79             IntStream.concat(
80                 IntStream.range(1, 10),
81                 IntStream.generate(() -&gt; 10).limit(90)
82             ),
83             IntStream.concat(
84                 IntStream.generate(() -&gt; 20).limit(20),
85                 IntStream.range(30, 150)
86             ))
87             .boxed()
88             .collect(Collectors.toList</b></font>());
89 <a name="0"></a>
90         ColumnStats&lt;Integer&gt; columnStats = ColumnStats.fromSortedValues(numbers, DataTypes.INTEGER, 0, 400L);
91         List&lt;Integer&gt; histogramSample = columnStats.histogram().subList(0, 15);
92         assertThat(histogramSample, <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>contains(1, 2, 3, 4, 5, 6, 7, 8, 9, 30, 31, 32, 33, 34, 35));
93         MostCommonValues mostCommonValues = columnStats.mostCommonValues();
94         assertThat(mostCommonValues.values().length, is(2));
95         assertThat(mostCommonValues.values()[0], is(10));
96         assertThat(mostCommonValues.frequencies()[0], Matchers.closeTo(0.376, 0.01));
97         assertThat(mostCommonValues.values()[1], is(20));
98         assertThat(mostCommonValues.frequencies()[1], Matchers.closeTo(0.086, 0.01));
99     }
100 <a name="3"></a>
101     @Test
102     public void test_histogram_contains_evenly_spaced_values_from_samples() {</b></font>
103         List&lt;Integer&gt; histogram = <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>ColumnStats.generateHistogram(
104             4,
105             IntStream.range(1, 21).boxed().collect(Collectors.toList())
106         );
107         assertThat(histogram, contains(1, 7, 13, 19));
108     }
109 <a name="6"></a>
110     @Test
111     public void test_average_size_in_bytes_is_calculated_for_variable_width_columns() {</b></font>
112         ColumnStats stats = <font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>ColumnStats.fromSortedValues(List.of("a", "b", "ccc", "dddddd"), DataTypes.STRING, 0, 100L);
113         assertThat(stats.averageSizeInBytes(), is(50.0));
114     }
115     @Test
116     public void test_column_stats_generation_from_null_values_only_has_null_fraction_1() {</b></font>
117         ColumnStats columnStats = ColumnStats.fromSortedValues(List.of(), DataTypes.INTEGER, 200, 1000L);
118         assertThat(columnStats.nullFraction(), is(1.0));
119     }
120 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>DDLIntegrationTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Licensed to Crate.io GmbH ("Crate") under one or more contributor
3  * license agreements.  See the NOTICE file distributed with this work for
4  * additional information regarding copyright ownership.  Crate licenses
5  * this file to you under the Apache License, Version 2.0 (the "License");
6  * you may not use this file except in compliance with the License.  You may
7  * obtain a copy of the License at
8  *
9  *   http://www.apache.org/licenses/LICENSE-2.0
10  *
11  * Unless required by applicable law or agreed to in writing, software
12  * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
13  * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
14  * License for the specific language governing permissions and limitations
15  * under the License.
16  *
17  * However, if you have executed another commercial license agreement
18  * with Crate these terms will supersede the license and you may use the
19  * software solely pursuant to the terms of the relevant commercial agreement.
20  */
21 package io.crate.integrationtests;
22 import static com.carrotsearch.randomizedtesting.RandomizedTest.$;
23 import static io.crate.protocols.postgres.PGErrorStatus.DUPLICATE_TABLE;
24 import static io.crate.protocols.postgres.PGErrorStatus.INTERNAL_ERROR;
25 import static io.crate.protocols.postgres.PGErrorStatus.UNDEFINED_TABLE;
26 import static io.crate.testing.Asserts.assertThrowsMatches;
27 import static io.crate.testing.SQLErrorMatcher.isSQLError;
28 import static io.crate.testing.TestingHelpers.printedTable;
29 import static io.netty.handler.codec.http.HttpResponseStatus.BAD_REQUEST;
30 import static io.netty.handler.codec.http.HttpResponseStatus.CONFLICT;
31 import static io.netty.handler.codec.http.HttpResponseStatus.NOT_FOUND;
32 import static io.netty.handler.codec.rtsp.RtspResponseStatuses.INTERNAL_SERVER_ERROR;
33 import static org.hamcrest.CoreMatchers.startsWith;
34 import static org.hamcrest.Matchers.containsString;
35 import static org.hamcrest.core.Is.is;
36 <a name="1"></a>
37 import java.util.ArrayList;
38 import java.util.Arrays;
39 <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import java.util.List;
40 import java.util.Map;
41 import org.elasticsearch.Version;
42 import org.elasticsearch.action.admin.indices.template.get.GetIndexTemplatesResponse;
43 import org.elasticsearch.cluster.metadata.IndexMetadata;
44 import org.elasticsearch.common.settings.Settings;
45 import org.elasticsearch.test.ESIntegTestCase;
46 import org.hamcrest.Matchers;
47 import org.junit.Test;
48 import org.skyscreamer.jsonassert.JSONAssert;
49 import org.skyscreamer.jsonassert.JSONCompareMode;
50 import io.crate.metadata.PartitionName;
51 import io.crate.metadata.RelationName;
52 import io.crate.metadata.Schemas;
53 import io.crate.protocols.postgres.PGErrorStatus;
54 import io.crate.testing.Asserts;
55 import io.crate.testing.SQLErrorMatcher;
56 import io.crate.testing.TestingHelpers;
57 import io.crate.testing.UseRandomizedSchema;
58 import io.netty.handler.codec.http.HttpResponseStatus;
59 @</b></font>ESIntegTestCase.ClusterScope()
60 @UseRandomizedSchema(random = false)
61 public class DDLIntegrationTest extends SQLIntegrationTestCase {
62     @Test
63     public void testCreateTable() throws Exception {
64         execute("create table test (col1 integer primary key, col2 string) " +
65                 "clustered into 5 shards with (number_of_replicas = 1, \"write.wait_for_active_shards\"=1)");
66         String expectedMapping = "{\"default\":{" +
67                                  "\"dynamic\":\"strict\",\"_meta\":{" +
68                                  "\"primary_keys\":[\"col1\"]}," +
69                                  "\"properties\":{" +
70                                  "\"col1\":{\"type\":\"integer\",\"position\":1}," +
71 <a name="5"></a>                                 "\"col2\":{\"type\":\"keyword\",\"position\":2}" +
72                                  "}}}";
73         <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>String expectedSettings = "{\"test\":{" +
74                                   "\"settings\":{" +
75                                   "\"index.number_of_replicas\":\"1\"," +
76                                   "\"index.number_of_shards\":\"5\"," +
77                                   "\"index.version.created\":\"" + Version.CURRENT.internalId + "\"" +
78                                   "}}}";
79         assertEquals(expectedMapping, getIndexMapping("test"));
80         JSONAssert.assertEquals(expectedSettings, getIndexSettings("test"), false);
81         execute("insert into test (col1, col2) values (1, 'foo')");
82         assertEquals(1, response.rowCount());
83         refresh();
84         execute("SELECT * FROM test");
85         assertEquals(1L, response.rowCount</b></font>());
86     }
87     @Test
88     public void testCreateTableWithRefreshIntervalDisableRefresh() throws Exception {
89         execute("create table test (id int primary key, content string) " +
90                 "clustered into 5 shards " +
91                 "with (refresh_interval=0, number_of_replicas = 0)");
92         String expectedSettings = "{\"test\":{" +
93                                   "\"settings\":{" +
94                                   "\"index.number_of_replicas\":\"0\"," +
95                                   "\"index.number_of_shards\":\"5\"," +
96                                   "\"index.refresh_interval\":\"0s\"," +
97                                   "\"index.version.created\":\"" + Version.CURRENT.internalId + "\"" +
98                                   "}}}";
99         JSONAssert.assertEquals(expectedSettings, getIndexSettings("test"), false);
100         execute("ALTER TABLE test SET (refresh_interval = '5000ms')");
101         String expectedSetSettings = "{\"test\":{" +
102                                      "\"settings\":{" +
103                                      "\"index.number_of_replicas\":\"0\"," +
104                                      "\"index.number_of_shards\":\"5\"," +
105                                      "\"index.refresh_interval\":\"5s\"," +
106                                      "\"index.version.created\":\"" + Version.CURRENT.internalId + "\"" +
107                                      "}}}";
108         JSONAssert.assertEquals(expectedSetSettings, getIndexSettings("test"), false);
109         execute("ALTER TABLE test RESET (refresh_interval)");
110         String expectedResetSettings = "{\"test\":{" +
111                                        "\"settings\":{" +
112                                        "\"index.number_of_replicas\":\"0\"," +
113                                        "\"index.number_of_shards\":\"5\"," +
114                                        "\"index.refresh_interval\":\"1s\"," +
115                                        "\"index.version.created\":\"" + Version.CURRENT.internalId + "\"" +
116                                        "}}}";
117         JSONAssert.assertEquals(expectedResetSettings, getIndexSettings("test"), false);
118     }
119 <a name="6"></a>    @Test
120     public void testCreateTableAlreadyExistsException() throws Exception {
121         execute("create table test (col1 integer primary key, col2 string)");
122         <font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>ensureYellow();
123         assertThrowsMatches(() -&gt; execute("create table test (col1 integer primary key, col2 string)"),
124                      isSQLError(is("Relation 'doc.test' already exists."),
125                                 DUPLICATE_TABLE,
126                                 CONFLICT,
127                                 4093)
128         );
129     }
130     @Test
131     public void testCreateTableWithReplicasAndShards() throws Exception {</b></font>
132         execute("create table test (col1 integer primary key, col2 string)" +
133                 "clustered by (col1) into 10 shards with (number_of_replicas=2, \"write.wait_for_active_shards\"=1)");
134         String expectedMapping = "{\"default\":{" +
135                                  "\"dynamic\":\"strict\"," +
136                                  "\"_meta\":{" +
137                                  "\"primary_keys\":[\"col1\"]," +
138                                  "\"routing\":\"col1\"}," +
139                                  "\"properties\":{" +
140                                  "\"col1\":{\"type\":\"integer\"}," +
141 <a name="7"></a>                                 "\"col2\":{\"type\":\"keyword\"}" +
142                                  "}}}";
143         <font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>String expectedSettings = "{\"test\":{" +
144                                   "\"settings\":{" +
145                                   "\"index.number_of_replicas\":\"2\"," +
146                                   "\"index.number_of_shards\":\"10\"," +
147                                   "\"index.version.created\":\"" + Version.CURRENT.internalId + "\"" +
148                                   "}}}";
149         JSONAssert.assertEquals(expectedMapping, getIndexMapping("test"), JSONCompareMode.LENIENT);
150         JSONAssert.assertEquals(expectedSettings, getIndexSettings("test"), JSONCompareMode.LENIENT);
151     }
152     @</b></font>Test
153     public void testCreateTableWithStrictColumnPolicy() throws Exception {
154         execute("create table test (col1 integer primary key, col2 string) " +
155                 "clustered into 5 shards " +
156                 "with (column_policy='strict', number_of_replicas = 0)");
157         String expectedMapping = "{\"default\":{" +
158                                  "\"dynamic\":\"strict\",\"_meta\":{" +
159                                  "\"primary_keys\":[\"col1\"]}," +
160                                  "\"properties\":{" +
161                                  "\"col1\":{\"type\":\"integer\",\"position\":1}," +
162                                  "\"col2\":{\"type\":\"keyword\",\"position\":2}" +
163                                  "}}}";
164         String expectedSettings = "{\"test\":{" +
165                                   "\"settings\":{" +
166                                   "\"index.number_of_replicas\":\"0\"," +
167                                   "\"index.number_of_shards\":\"5\"," +
168                                   "\"index.version.created\":\"" + Version.CURRENT.internalId + "\"" +
169                                   "}}}";
170         assertEquals(expectedMapping, getIndexMapping("test"));
171         JSONAssert.assertEquals(expectedSettings, getIndexSettings("test"), false);
172     }
173     @Test
174     public void testCreateGeoShapeExplicitIndex() throws Exception {
175         execute("create table test (col1 geo_shape INDEX using QUADTREE with (precision='1m', distance_error_pct='0.25'))");
176         ensureYellow();
177         String expectedMapping = "{\"default\":{" +
178                                  "\"dynamic\":\"strict\",\"_meta\":{}," +
179                                  "\"properties\":{" +
180                                  "\"col1\":{\"type\":\"geo_shape\",\"tree\":\"quadtree\",\"position\":1,\"precision\":\"1.0m\",\"distance_error_pct\":0.25}}}}";
181         assertEquals(expectedMapping, getIndexMapping("test"));
182     }
183     @Test
184     public void testCreateColumnWithDefaultExpression() throws Exception {
185         execute("create table test (col1 text default 'foo')");
186         String expectedMapping = "{\"default\":{" +
187                                  "\"dynamic\":\"strict\",\"_meta\":{}," +
188                                  "\"properties\":{\"col1\":{\"type\":\"keyword\",\"position\":1,\"default_expr\":\"'foo'\"}}}}";
189         assertEquals(expectedMapping, getIndexMapping("test"));
190     }
191     @Test
192     public void testCreateGeoShape() throws Exception {
193         execute("create table test (col1 geo_shape)");
194         ensureYellow();
195         String expectedMapping = "{\"default\":{" +
196                                  "\"dynamic\":\"strict\",\"_meta\":{}," +
197                                  "\"properties\":{\"col1\":{\"type\":\"geo_shape\",\"position\":1}}}}";
198         assertEquals(expectedMapping, getIndexMapping("test"));
199     }
200     @Test
201     public void testGeoShapeInvalidPrecision() throws Exception {
202         assertThrowsMatches(() -&gt; execute("create table test (col1 geo_shape INDEX using QUADTREE with (precision='10%'))"),
203                      isSQLError(is("Value '10%' of setting precision is not a valid distance unit"),
204                                 INTERNAL_ERROR,
205                                 BAD_REQUEST,
206                                 4000)
207         );
208     }
209     @Test
210     public void testGeoShapeInvalidDistance() throws Exception {
211         assertThrowsMatches(() -&gt; execute(
212             "create table test (col1 geo_shape INDEX using QUADTREE with (distance_error_pct=true))"),
213                      isSQLError(is("Value 'true' of setting distance_error_pct is not a float value"),
214                          INTERNAL_ERROR,
215                          BAD_REQUEST,
216                          4000)
217         );
218     }
219     @Test
220     public void testUnknownGeoShapeSetting() throws Exception {
221         assertThrowsMatches(() -&gt; execute("create table test (col1 geo_shape INDEX using QUADTREE with (does_not_exist=false))"),
222                      isSQLError(is("Setting \"does_not_exist\" ist not supported on geo_shape index"),
223                                 INTERNAL_ERROR,
224                                 BAD_REQUEST,
225                                 4000)
226         );
227     }
228     @Test
229     public void testCreateTableWithInlineDefaultIndex() throws Exception {
230         execute("create table quotes (quote string index using plain) with (number_of_replicas = 0)");
231         String quote = "Would it save you a lot of time if I just gave up and went mad now?";
232         execute("insert into quotes values (?)", new Object[]{quote});
233         refresh();
234         execute("select quote from quotes where match(quote, 'time')");
235         assertEquals(0, response.rowCount());
236         execute("select quote from quotes where quote = ?", new Object[]{quote});
237         assertEquals(1L, response.rowCount());
238         assertEquals(quote, response.rows()[0][0]);
239     }
240     @Test
241     public void testCreateTableWithInlineIndex() throws Exception {
242         execute("create table quotes (quote string index using fulltext) with (number_of_replicas = 0)");
243         String quote = "Would it save you a lot of time if I just gave up and went mad now?";
244         execute("insert into quotes values (?)", new Object[]{quote});
245         execute("refresh table quotes");
246         execute("select quote from quotes where match(quote, 'time')");
247         assertEquals(1L, response.rowCount());
248         assertEquals(quote, response.rows()[0][0]);
249         execute("select quote from quotes where quote = ?", new Object[]{quote});
250         assertEquals(0, response.rowCount());
251     }
252     @Test
253     public void testCreateTableWithIndexOff() throws Exception {
254         execute("create table quotes (id int, quote string index off) with (number_of_replicas = 0)");
255         String quote = "Would it save you a lot of time if I just gave up and went mad now?";
256         execute("insert into quotes (id, quote) values (?, ?)", new Object[]{1, quote});
257         execute("refresh table quotes");
258         assertThrowsMatches(
259             () -&gt; execute("select quote from quotes where quote = ?", new Object[]{quote}),
260             isSQLError(
261                 containsString("Cannot search on field [quote] since it is not indexed."),
262                 INTERNAL_ERROR,
263                 BAD_REQUEST,
264                 4000
265             )
266         );
267     }
268     @Test
269     public void testCreateTableWithIndex() throws Exception {
270         execute("create table quotes (quote string, " +
271                 "index quote_fulltext using fulltext(quote) with (analyzer='stop')) with (number_of_replicas = 0)");
272         String quote = "Would it save you a lot of time if I just gave up and went mad now?";
273         execute("insert into quotes values (?)", new Object[]{quote});
274         execute("refresh table quotes");
275         execute("select quote from quotes where match(quote_fulltext, 'time')");
276         assertEquals(1L, response.rowCount());
277         assertEquals(quote, response.rows()[0][0]);
278         execute("select quote from quotes where quote = ?", new Object[]{quote});
279         assertEquals(1L, response.rowCount());
280     }
281     @Test
282     public void testCreateTableWithCompositeIndex() throws Exception {
283         execute("create table novels (title string, description string, " +
284                 "index title_desc_fulltext using fulltext(title, description) " +
285                 "with(analyzer='stop')) with (number_of_replicas = 0)");
286         String title = "So Long, and Thanks for All the Fish";
287         String description = "Many were increasingly of the opinion that they'd all made a big " +
288                              "mistake in coming down from the trees in the first place. And some said that " +
289                              "even the trees had been a bad move, and that no one should ever have left " +
290 <a name="4"></a>                             "the oceans.";
291         execute("insert into novels (title, description) values(?, ?)",
292             new Object[]{title, description});
293         <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>refresh();
294         execute("select title, description from novels where match(title_desc_fulltext, 'fish')");
295         assertEquals(1L, response.rowCount());
296         assertEquals(title, response.rows()[0][0]);
297         assertEquals(description, response.rows()[0][1]);
298         execute("select title, description from novels where match(title_desc_fulltext, 'oceans')");
299         assertEquals(1L, response.rowCount());
300         assertEquals</b></font>(title, response.rows()[0][0]);
301         assertEquals(description, response.rows()[0][1]);
302         execute("select title from novels where title = ?", new Object[]{title});
303         assertEquals(1L, response.rowCount());
304     }
305     @Test
306     public void test_create_table_with_check_fail_on_insert() {
307         execute("create table t (id integer primary key, qty integer, constraint check_1 check (qty &gt; 0))");
308 <a name="3"></a>        execute("insert into t(id, qty) values(0, null), (1, 1)");
309         refresh();
310         execute("select id, qty from t order by id");
311         <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(printedTable(response.rows()),
312                      "0| NULL\n" +
313                      "1| 1\n");
314         assertThrowsMatches(() -&gt; execute("insert into t(id, qty) values(2, -1)"),
315                      isSQLError(containsString("Failed CONSTRAINT check_1 CHECK (\"qty\" &gt; 0) and values"),
316                      INTERNAL_ERROR,
317                      BAD_REQUEST,
318                      4000));
319     }
320     @Test
321     public void test_create_table_with_check_fail_on_update() {</b></font>
322         execute("create table t (id integer primary key, qty integer constraint check_1 check (qty &gt; 0))");
323         execute("insert into t(id, qty) values(0, 1)");
324         refresh();
325         execute("select id, qty from t order by id");
326         assertEquals(printedTable(response.rows()), "0| 1\n");
327         execute("update t set qty = 1 where id = 0 returning id, qty");
328         assertEquals(printedTable(response.rows()), "0| 1\n");
329         assertThrowsMatches(() -&gt; execute("update t set qty = -1 where id = 0"),
330                      isSQLError(containsString("Failed CONSTRAINT check_1 CHECK (\"qty\" &gt; 0) and values"),
331                                 INTERNAL_ERROR,
332                                 INTERNAL_SERVER_ERROR,
333                                 5000));
334     }
335     @Test
336     public void test_alter_table_add_column_succedds_because_check_constaint_refers_to_self_columns() {
337         execute("create table t (id integer primary key, qty integer constraint check_1 check (qty &gt; 0))");
338         execute("alter table t add column bazinga integer constraint bazinga_check check(bazinga &lt;&gt; 42)");
339         execute("insert into t(id, qty, bazinga) values(0, 1, 100)");
340         assertThrowsMatches(() -&gt; execute("insert into t(id, qty, bazinga) values(0, 1, 42)"),
341                      isSQLError(containsString("Failed CONSTRAINT bazinga_check CHECK (\"bazinga\" &lt;&gt; 42) and values {qty=1, id=0, bazinga=42}"),
342                                 INTERNAL_ERROR,
343                                 BAD_REQUEST,
344                                 4000));
345     }
346 <a name="0"></a>
347     @Test
348     public void test_alter_table_drop_constraint_removes_the_constraint_and_leaves_other_constraints_in_place() {
349         <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>execute("create table t (" +
350                       "    id int primary key, " +
351                       "    qty int constraint check_qty_gt_zero check(qty &gt; 0), " +
352                       "    constraint check_id_ge_zero check (id &gt;= 0)" +
353                       ")");
354         String selectCheckConstraintsStmt =
355             "select table_schema, table_name, constraint_type, constraint_name " +
356             "from information_schema.table_constraints " +
357             "where table_name='t'" +
358             "order by constraint_name";
359         execute(selectCheckConstraintsStmt);
360         assertThat(printedTable(response.rows()), is(
361             "doc| t| CHECK| check_id_ge_zero\n" +
362             "doc| t| CHECK| check_qty_gt_zero\n" +
363             "doc| t| PRIMARY KEY| t_pk\n"
364         ));
365         execute("alter table t drop constraint check_id_ge_zero");
366         execute(selectCheckConstraintsStmt);
367         assertThat(printedTable(response.rows()), is(
368             "doc| t| CHECK| check_qty_gt_zero\n" +
369             "doc| t| PRIMARY KEY| t_pk\n"
370         ));
371         execute("insert into t(id, qty) values(-42, 100)");
372         assertThrowsMatches(() -&gt; execute("insert into t(id, qty) values(0, 0)"),
373                      isSQLError(is("Failed CONSTRAINT check_qty_gt_zero CHECK (\"qty\" &gt; 0) and values {qty=0, id=0}"),
374                          INTERNAL_ERROR,
375                          BAD_REQUEST,
376                          4000));
377     }
378     @Test
379     public void testAlterTable() throws Exception {</b></font>
380         execute("create table test (col1 int) with (number_of_replicas='0-all')");
381         ensureYellow();
382         execute("select number_of_replicas from information_schema.tables where table_name = 'test'");
383         assertEquals("0-all", response.rows()[0][0]);
384         execute("alter table test set (number_of_replicas=0)");
385         execute("select number_of_replicas from information_schema.tables where table_name = 'test'");
386         assertEquals("0", response.rows()[0][0]);
387     }
388     @Test
389     public void testAlterTableAddColumn() {
390         execute("create table t (id int primary key) with (number_of_replicas=0)");
391         execute("alter table t add column name string");
392         execute("select data_type from information_schema.columns where " +
393                 "table_name = 't' and column_name = 'name'");
394         assertThat(response.rows()[0][0], is("text"));
395         execute("alter table t add column o object as (age int)");
396         execute("select data_type from information_schema.columns where " +
397                 "table_name = 't' and column_name = 'o'");
398         assertThat((String) response.rows()[0][0], is("object"));
399     }
400     @Test
401     public void testAlterTableAddColumnAsPrimaryKey() throws Exception {
402         execute("create table t (id int primary key) " +
403                 "clustered into 1 shards " +
404                 "with (number_of_replicas=0)");
405         ensureYellow();
406         execute("alter table t add column name string primary key");
407         execute("select constraint_name from information_schema.table_constraints " +
408                 "where table_name = 't' and table_schema = 'doc' and constraint_type = 'PRIMARY KEY'");
409         assertThat(response.rowCount(), is(1L));
410         assertThat(response.rows()[0][0], is("t_pk"));
411     }
412     @Test
413     public void testAlterTableWithRecordsAddColumnAsPrimaryKey() throws Exception {
414         execute("create table t (id int primary key) " +
415                 "clustered into 1 shards " +
416                 "with (number_of_replicas=0)");
417         ensureYellow();
418         execute("insert into t (id) values(1)");
419         refresh();
420         assertThrowsMatches(() -&gt; execute("alter table t add column name string primary key"),
421         isSQLError(is("Cannot add a primary key column to a table that isn't empty"), INTERNAL_ERROR, BAD_REQUEST, 4004));
422     }
423     @Test
424     public void testAlterTableWithoutRecordsAddGeneratedColumn() throws Exception {
425         execute("create table t (id int) " +
426                 "clustered into 1 shards " +
427                 "with (number_of_replicas=0)");
428         ensureYellow();
429         execute("alter table t add column id_generated as (id + 1)");
430         execute("insert into t (id) values(1)");
431         refresh();
432         execute("select id, id_generated from t");
433         assertThat(response.rows()[0][0], is(1));
434         assertThat(response.rows()[0][1], is(2));
435     }
436     @Test
437     public void testAlterTableWithRecordsAddGeneratedColumn() throws Exception {
438         execute("create table t (id int) " +
439                 "clustered into 1 shards " +
440                 "with (number_of_replicas=0)");
441         ensureYellow();
442         execute("insert into t (id) values(1)");
443         refresh();
444         assertThrowsMatches(() -&gt; execute("alter table t add column id_generated as (id + 1)"),
445                      isSQLError(is("Cannot add a generated column to a table that isn't empty"),
446                                 INTERNAL_ERROR,
447                                 BAD_REQUEST,
448                                 4004));
449     }
450     @Test
451     public void testAlterTableAddDotExpression() {
452         execute("create table t (id int) " +
453                 "clustered into 1 shards " +
454                 "with (number_of_replicas=0)");
455         ensureYellow();
456         assertThrowsMatches(() -&gt; execute("alter table t add \"o.x\" int"),
457                      isSQLError(is("\"o.x\" contains a dot"),
458                                 INTERNAL_ERROR,
459                                 BAD_REQUEST,
460                                 4008));
461     }
462     @Test
463     public void testAlterTableAddDotExpressionInSubscript() {
464         execute("create table t (id int) clustered into 1 shards with (number_of_replicas=0)");
465         ensureYellow();
466         assertThrowsMatches(() -&gt;  execute("alter table t add \"o['x.y']\" int"),
467                      isSQLError(is("\"o['x.y']\" contains a dot"),
468                                 INTERNAL_ERROR,
469                                 BAD_REQUEST,
470                                 4008));
471     }
472     @Test
473     public void testAlterTableAddObjectColumnToNonExistingObject() {
474         execute("create table t (id int) " +
475                 "clustered into 1 shards " +
476                 "with (number_of_replicas=0)");
477         ensureYellow();
478         execute("alter table t add o['x'] int");
479         execute("select column_name from information_schema.columns where " +
480                 "table_name = 't' and table_schema='doc'" +
481                 "order by column_name asc");
482         assertThat(response.rowCount(), is(3L));
483         List&lt;String&gt; fqColumnNames = new ArrayList&lt;&gt;();
484         for (Object[] row : response.rows()) {
485             fqColumnNames.add((String) row[0]);
486         }
487         assertThat(fqColumnNames, Matchers.contains("id", "o", "o['x']"));
488     }
489     @Test
490     public void testAlterTableAddObjectColumnToExistingObject() {
491         execute("create table t (o object as (x string)) " +
492                 "clustered into 1 shards " +
493                 "with (number_of_replicas=0)");
494         ensureYellow();
495         execute("alter table t add o['y'] int");
496         assertThrowsMatches(() -&gt; execute("alter table t add o object as (z string)"),
497                      isSQLError(containsString("The table doc.t already has a column named o"),
498                                 INTERNAL_ERROR,
499                                 BAD_REQUEST,
500                                 4000));
501         execute("select column_name from information_schema.columns where " +
502                 "table_name = 't' and table_schema='doc'" +
503                 "order by column_name asc");
504         assertThat(response.rowCount(), is(3L));
505         List&lt;String&gt; fqColumnNames = new ArrayList&lt;&gt;();
506         for (Object[] row : response.rows()) {
507             fqColumnNames.add((String) row[0]);
508         }
509         assertThat(fqColumnNames, Matchers.contains("o", "o['x']", "o['y']"));
510     }
511     @Test
512     public void testAlterTableAddObjectColumnToExistingObjectNested() throws Exception {
513         execute("CREATE TABLE my_table (" +
514                 "  name string, " +
515                 "  age integer," +
516                 "  book object as (isbn string)" +
517                 ")");
518         ensureYellow();
519         execute("alter table my_table add column book['author'] object as (\"authorId\" integer)");
520         waitNoPendingTasksOnAll();
521         execute("select column_name from information_schema.columns where " +
522                 "table_name = 'my_table' and table_schema='doc'" +
523                 "order by column_name asc");
524         assertThat(response.rowCount(), is(6L));
525         assertThat(TestingHelpers.getColumn(response.rows(), 0),
526             is(Matchers.&lt;Object&gt;arrayContaining("age", "book", "book['author']", "book['author']['authorId']", "book['isbn']", "name")));
527         execute("alter table my_table add column book['author']['authorName'] string");
528         waitNoPendingTasksOnAll();
529         execute("select column_name from information_schema.columns where " +
530                 "table_name = 'my_table' and table_schema='doc'" +
531                 "order by column_name asc");
532         assertThat(response.rowCount(), is(7L));
533         assertThat(TestingHelpers.getColumn(response.rows(), 0),
534             is(Matchers.&lt;Object&gt;arrayContaining("age", "book", "book['author']", "book['author']['authorId']", "book['author']['authorName']", "book['isbn']", "name")));
535     }
536     @Test
537     public void testAlterTableAddNestedObjectWithArrayToExistingObject() throws Exception {
538         execute("CREATE TABLE my_table (col1 object)");
539         ensureYellow();
540         execute("ALTER TABLE my_table ADD COLUMN col1['col2'] object as (col3 array(string))");
541         waitNoPendingTasksOnAll();
542         execute("SELECT column_name, data_type FROM information_schema.columns " +
543                 "WHERE table_name = 'my_table' AND table_schema = 'doc' " +
544                 "ORDER BY column_name asc");
545         assertThat(TestingHelpers.getColumn(response.rows(), 0),
546             is(Matchers.&lt;Object&gt;arrayContaining("col1", "col1['col2']", "col1['col2']['col3']")));
547         assertThat(TestingHelpers.getColumn(response.rows(), 1),
548             is(Matchers.arrayContaining("object", "object", "text_array")));
549         execute("DROP TABLE my_table");
550         ensureYellow();
551         execute("CREATE TABLE my_table (col1 object as (col2 object))");
552         ensureYellow();
553         execute("ALTER TABLE my_table ADD COLUMN col1['col2']['col3'] object as (col4 array(long))");
554         waitNoPendingTasksOnAll();
555         execute("SELECT column_name, data_type FROM information_schema.columns " +
556                 "WHERE table_name = 'my_table' AND table_schema = 'doc' " +
557                 "ORDER BY column_name asc");
558         assertThat(TestingHelpers.getColumn(response.rows(), 0),
559             is(Matchers.&lt;Object&gt;arrayContaining("col1", "col1['col2']", "col1['col2']['col3']", "col1['col2']['col3']['col4']")));
560         assertThat(TestingHelpers.getColumn(response.rows(), 1),
561             is(Matchers.arrayContaining("object", "object", "object", "bigint_array")));
562     }
563     @Test
564     public void testAlterTableAddObjectToObjectArray() throws Exception {
565         execute("CREATE TABLE t (" +
566                 "   attributes ARRAY(" +
567                 "       OBJECT (STRICT) as (" +
568                 "           name STRING" +
569                 "       )" +
570                 "   )" +
571                 ")");
572         ensureYellow();
573         execute("ALTER TABLE t ADD column attributes['is_nice'] BOOLEAN");
574         execute("INSERT INTO t (attributes) values ([{name='Trillian', is_nice=True}])");
575         refresh();
576         execute("select attributes from t");
577         assertThat(((List&lt;Object&gt;)response.rows()[0][0]).get(0), is(Map.of("name", "Trillian", "is_nice", true)));
578     }
579     @Test
580     public void testDropTable() throws Exception {
581         execute("create table test (col1 integer primary key, col2 string)");
582         assertThat(internalCluster().clusterService().state().metadata().hasIndex("test"), is(true));
583         execute("drop table test");
584         assertThat(response.rowCount(), is(1L));
585         assertThat(internalCluster().clusterService().state().metadata().hasIndex("test"), is(false));
586     }
587     @Test
588     public void testDropTableIfExistsRaceCondition() throws Exception {
589         execute("create table test (name string)");
590         execute("drop table test");
591         execute("drop table if exists test");
592     }
593     @Test
594     public void testDropUnknownTable() throws Exception {
595         assertThrowsMatches(() -&gt; execute("drop table test"),
596                      isSQLError(is("Relation 'test' unknown"), UNDEFINED_TABLE, NOT_FOUND, 4041));
597     }
598     @Test
599     public void testDropTableIfExists() {
600         execute("create table test (col1 integer primary key, col2 string)");
601         assertThat(internalCluster().clusterService().state().metadata().hasIndex("test"), is(true));
602         execute("drop table if exists test");
603         assertThat(response.rowCount(), is(1L));
604         assertThat(internalCluster().clusterService().state().metadata().hasIndex("test"), is(false));
605     }
606     @Test
607     public void testDropIfExistsUnknownTable() throws Exception {
608         execute("drop table if exists nonexistent");
609         assertThat(response.rowCount(), is(0L));
610     }
611     @Test
612     public void testCreateAlterAndDropBlobTable() throws Exception {
613         execute("create blob table screenshots with (number_of_replicas=0)");
614         execute("alter blob table screenshots set (number_of_replicas=1)");
615         execute("select number_of_replicas from information_schema.tables " +
616                 "where table_schema = 'blob' and table_name = 'screenshots'");
617         assertEquals("1", response.rows()[0][0]);
618         execute("drop blob table screenshots");
619     }
620     @Test
621     public void testDropIfExistsBlobTable() throws Exception {
622         execute("create blob table screenshots with (number_of_replicas=0)");
623         execute("drop blob table if exists screenshots");
624         assertEquals(response.rowCount(), 1);
625     }
626     @Test
627     public void testDropBlobTableIfExistsUnknownTable() throws Exception {
628         execute("drop blob table if exists nonexistent");
629         assertThat(response.rowCount(), is(0L));
630     }
631     @Test
632     public void testAlterShardsOfPartitionedTableAffectsNewPartitions() {
633         execute(
634             "create table quotes (" +
635             "   id integer," +
636             "   quote string," +
637             "   date timestamp with time zone" +
638             ") partitioned by(date) " +
639             "clustered into 3 shards with (number_of_replicas='0-all')");
640         ensureYellow();
641         execute("insert into quotes (id, quote, date) values (?, ?, ?), (?, ?, ?)",
642             new Object[]{
643                 1, "Don't panic", 1395874800000L,
644                 2, "Now panic", 1395961200000L}
645         );
646         execute("alter table quotes set (number_of_shards=5)");
647 <a name="2"></a>
648         String templateName = PartitionName.templateName(Schemas.DOC_SCHEMA_NAME, "quotes");
649         GetIndexTemplatesResponse templatesResponse =
650             <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>client().admin().indices().prepareGetTemplates(templateName).execute().actionGet();
651         Settings templateSettings = templatesResponse.getIndexTemplates().get(0).getSettings();
652         assertThat(templateSettings.getAsInt(IndexMetadata.SETTING_NUMBER_OF_SHARDS, 0), is(5));
653         execute</b></font>("insert into quotes (id, quote, date) values (?, ?, ?)",
654             new Object[]{3, "Time is a illusion. Lunchtime doubles so", 1495961200000L}
655         );
656         PartitionName partitionName = new PartitionName(
657             new RelationName("doc", "quotes"), Arrays.asList("1495961200000"));
658         execute("select number_of_shards from information_schema.table_partitions where partition_ident = ? and table_name = ?",
659             $(partitionName.ident(), partitionName.relationName().name()));
660         assertThat(response.rows()[0][0], is(5));
661     }
662     @Test
663     public void testAlterShardsTableCombinedWithOtherSettingsIsInvalid() {
664         execute(
665             "create table quotes (" +
666             "   id integer," +
667             "   quote string," +
668             "   date timestamp with time zone" +
669             ") clustered into 3 shards with (number_of_replicas='0-all')");
670         assertThrowsMatches(() -&gt; execute("alter table quotes set (number_of_shards=1, number_of_replicas='1-all')"),
671                      isSQLError(is("Setting [number_of_shards] cannot be combined with other settings"),
672                                 INTERNAL_ERROR,
673                                 BAD_REQUEST,
674                                 4000));
675     }
676     @Test
677     public void testAlterShardsPartitionCombinedWithOtherSettingsIsInvalid() {
678         execute(
679             "create table quotes (" +
680             "   id integer," +
681             "   quote string," +
682             "   date timestamp with time zone" +
683             ") partitioned by(date) " +
684             "clustered into 3 shards with (number_of_replicas='0-all')");
685         execute("insert into quotes (id, quote, date) values (?, ?, ?), (?, ?, ?)",
686             new Object[]{
687                 1, "Don't panic", 1395874800000L,
688                 2, "Now panic", 1395961200000L}
689         );
690         assertThrowsMatches(() -&gt; execute("alter table quotes partition (date=1395874800000) " +
691                                    "set (number_of_shards=1, number_of_replicas='1-all')"),
692                      isSQLError(is("Setting [number_of_shards] cannot be combined with other settings"),
693                                 INTERNAL_ERROR,
694                                 BAD_REQUEST,
695                                 4000));
696     }
697     @Test
698     public void testCreateTableWithCustomSchema() throws Exception {
699         execute("create table a.t (name string) with (number_of_replicas=0)");
700         ensureYellow();
701         execute("insert into a.t (name) values ('Ford')");
702         assertThat(response.rowCount(), is(1L));
703         refresh();
704         execute("select name from a.t");
705         assertThat(response.rowCount(), is(1L));
706         assertThat((String) response.rows()[0][0], is("Ford"));
707         execute("select table_schema from information_schema.tables where table_name = 't'");
708         assertThat(response.rowCount(), is(1L));
709         assertThat((String) response.rows()[0][0], is("a"));
710     }
711     @Test
712     public void testCreateTableWithIllegalCustomSchemaCheckedByES() throws Exception {
713         assertThrowsMatches(() -&gt; execute("create table \"AAA\".t (name string) with (number_of_replicas=0)"),
714                      isSQLError(is("Relation name \"AAA.t\" is invalid."), INTERNAL_ERROR, BAD_REQUEST, 4002));
715     }
716     @Test
717     public void testDropTableWithCustomSchema() throws Exception {
718         execute("create table a.t (name string) with (number_of_replicas=0)");
719         ensureYellow();
720         execute("drop table a.t");
721         assertThat(response.rowCount(), is(1L));
722         execute("select table_schema from information_schema.tables where table_name = 't'");
723         assertThat(response.rowCount(), is(0L));
724     }
725     @Test
726     public void testCreateTableWithGeneratedColumn() throws Exception {
727         execute(
728             "create table test (" +
729             "   ts timestamp with time zone," +
730             "   day as date_trunc('day', ts)) with (number_of_replicas=0)");
731         ensureYellow();
732         String expectedMapping = "{\"default\":" +
733                                  "{\"dynamic\":\"strict\"," +
734                                  "\"_meta\":{" +
735                                  "\"generated_columns\":{\"day\":\"date_trunc('day', ts)\"}}," +
736                                  "\"properties\":{" +
737                                  "\"day\":{\"type\":\"date\",\"position\":2,\"format\":\"epoch_millis||strict_date_optional_time\"}," +
738                                  "\"ts\":{\"type\":\"date\",\"position\":1,\"format\":\"epoch_millis||strict_date_optional_time\"}" +
739                                  "}}}";
740         assertEquals(expectedMapping, getIndexMapping("test"));
741     }
742     @Test
743     public void testAddGeneratedColumnToTableWithExistingGeneratedColumns() throws Exception {
744         execute(
745             "create table test (" +
746             "   ts timestamp with time zone," +
747             "   day as date_trunc('day', ts)) with (number_of_replicas=0)");
748         execute("alter table test add column added timestamp generated always as date_trunc('day', ts)");
749         ensureYellow();
750         String expectedMapping = "{\"default\":" +
751                                  "{\"dynamic\":\"strict\"," +
752                                  "\"_meta\":{" +
753                                  "\"generated_columns\":{" +
754                                  "\"added\":\"date_trunc('day', ts)\"," +
755                                  "\"day\":\"date_trunc('day', ts)\"}}," +
756                                  "\"properties\":{" +
757                                  "\"added\":{\"type\":\"date\",\"position\":3,\"format\":\"epoch_millis||strict_date_optional_time\"}," +
758                                  "\"day\":{\"type\":\"date\",\"position\":2,\"format\":\"epoch_millis||strict_date_optional_time\"}," +
759                                  "\"ts\":{\"type\":\"date\",\"position\":1,\"format\":\"epoch_millis||strict_date_optional_time\"}" +
760                                  "}}}";
761         assertEquals(expectedMapping, getIndexMapping("test"));
762     }
763     @Test
764     public void test_alter_table_cannot_add_broken_generated_column() throws Exception {
765         execute("create table tbl (x int)");
766         Asserts.assertThrowsMatches(
767             () -&gt; execute("alter table tbl add column ts timestamp without time zone generated always as 'foobar'"),
768             SQLErrorMatcher.isSQLError(
769                 is("Cannot cast `'foobar'` of type `text` to type `timestamp without time zone`"),
770                 PGErrorStatus.INTERNAL_ERROR,
771                 HttpResponseStatus.BAD_REQUEST,
772                 4000
773             )
774         );
775     }
776     @Test
777     public void test_alter_table_add_column_keeps_existing_meta_information() throws Exception {
778         execute("""
779             CREATE TABLE tbl (
780                 author TEXT NOT NULL,
781                 INDEX author_ft USING FULLTEXT (author) WITH (analyzer = 'standard')
782             )
783         """);
784         execute("ALTER TABLE tbl ADD COLUMN dummy text NOT NULL");
785         execute("show create table tbl");
786         assertThat((String) response.rows()[0][0], startsWith("""
787             CREATE TABLE IF NOT EXISTS "doc"."tbl" (
788                "author" TEXT NOT NULL,
789                "dummy" TEXT NOT NULL,
790                INDEX "author_ft" USING FULLTEXT ("author") WITH (
791                   analyzer = 'standard'
792                )
793             )
794             """.stripIndent()
795         ));
796     }
797 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
