<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for ColumnStatsTest.java & DDLIntegrationTest.java</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for ColumnStatsTest.java & DDLIntegrationTest.java
      </h3>
      <h1 align="center">
        21.8%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>ColumnStatsTest.java (67.66467%)<TH>DDLIntegrationTest.java (13.033448%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match510398-0.html#0',2,'match510398-1.html#0',3)" NAME="0">(102-112)<TD><A HREF="javascript:ZweiFrames('match510398-0.html#0',2,'match510398-1.html#0',3)" NAME="0">(408-439)</A><TD ALIGN=center><FONT COLOR="#ff0000">23</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match510398-0.html#1',2,'match510398-1.html#1',3)" NAME="1">(24-47)<TD><A HREF="javascript:ZweiFrames('match510398-0.html#1',2,'match510398-1.html#1',3)" NAME="1">(41-64)</A><TD ALIGN=center><FONT COLOR="#f30000">22</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match510398-0.html#2',2,'match510398-1.html#2',3)" NAME="2">(65-70)<TD><A HREF="javascript:ZweiFrames('match510398-0.html#2',2,'match510398-1.html#2',3)" NAME="2">(754-758)</A><TD ALIGN=center><FONT COLOR="#900000">13</FONT>
<TR><TD BGCOLOR="#53858b"><FONT COLOR="#53858b">-</FONT><TD><A HREF="javascript:ZweiFrames('match510398-0.html#3',2,'match510398-1.html#3',3)" NAME="3">(113-121)<TD><A HREF="javascript:ZweiFrames('match510398-0.html#3',2,'match510398-1.html#3',3)" NAME="3">(367-378)</A><TD ALIGN=center><FONT COLOR="#850000">12</FONT>
<TR><TD BGCOLOR="#6cc417"><FONT COLOR="#6cc417">-</FONT><TD><A HREF="javascript:ZweiFrames('match510398-0.html#4',2,'match510398-1.html#4',3)" NAME="4">(88-98)<TD><A HREF="javascript:ZweiFrames('match510398-0.html#4',2,'match510398-1.html#4',3)" NAME="4">(342-353)</A><TD ALIGN=center><FONT COLOR="#850000">12</FONT>
<TR><TD BGCOLOR="#151b8d"><FONT COLOR="#151b8d">-</FONT><TD><A HREF="javascript:ZweiFrames('match510398-0.html#5',2,'match510398-1.html#5',3)" NAME="5">(53-56)<TD><A HREF="javascript:ZweiFrames('match510398-0.html#5',2,'match510398-1.html#5',3)" NAME="5">(81-96)</A><TD ALIGN=center><FONT COLOR="#850000">12</FONT>
<TR><TD BGCOLOR="#8c8774"><FONT COLOR="#8c8774">-</FONT><TD><A HREF="javascript:ZweiFrames('match510398-0.html#6',2,'match510398-1.html#6',3)" NAME="6">(122-127)<TD><A HREF="javascript:ZweiFrames('match510398-0.html#6',2,'match510398-1.html#6',3)" NAME="6">(138-148)</A><TD ALIGN=center><FONT COLOR="#6e0000">10</FONT>
<TR><TD BGCOLOR="#38a4a5"><FONT COLOR="#38a4a5">-</FONT><TD><A HREF="javascript:ZweiFrames('match510398-0.html#7',2,'match510398-1.html#7',3)" NAME="7">(57-61)<TD><A HREF="javascript:ZweiFrames('match510398-0.html#7',2,'match510398-1.html#7',3)" NAME="7">(161-172)</A><TD ALIGN=center><FONT COLOR="#630000">9</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>ColumnStatsTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
 * software solely pursuant to the terms of the relevant commercial agreement.
 */
<A NAME="1"></A>
package io.crate.statistics;

<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match510398-1.html#1',3,'match510398-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>import com.pholser.junit.quickcheck.Property;
import com.pholser.junit.quickcheck.generator.InRange;
import com.pholser.junit.quickcheck.runner.JUnitQuickcheck;
import io.crate.types.DataTypes;
import org.elasticsearch.common.io.stream.BytesStreamOutput;
import org.elasticsearch.common.io.stream.StreamInput;
import org.hamcrest.Matchers;
import org.junit.Test;
import org.junit.runner.RunWith;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;
import java.util.stream.IntStream;

import static org.hamcrest.Matchers.contains;
import static org.hamcrest.Matchers.greaterThanOrEqualTo;
import static org.hamcrest.Matchers.is;
import static org.hamcrest.Matchers.lessThanOrEqualTo;
import static org.junit.Assert.assertThat;
import static org.junit.Assume.assumeThat;

@</B></FONT>RunWith(JUnitQuickcheck.class)
public class ColumnStatsTest {

<A NAME="5"></A>    @Test
    public void test_column_stats_generation() {
        List&lt;Integer&gt; numbers = List.of(1, 1, 2, 4, 4, 4, 4, 4);
        <FONT color="#151b8d"><A HREF="javascript:ZweiFrames('match510398-1.html#5',3,'match510398-top.html#5',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>ColumnStats columnStats = ColumnStats.fromSortedValues(numbers, DataTypes.INTEGER, 1, 400L);
<A NAME="7"></A>        assertThat(columnStats.averageSizeInBytes(), is((double) DataTypes.INTEGER.fixedSize()));
        assertThat(columnStats.nullFraction(), Matchers.closeTo(0.111, 0.01));
        assertThat(columnStats.approxDistinct(), is</B></FONT>(3.0));
        <FONT color="#38a4a5"><A HREF="javascript:ZweiFrames('match510398-1.html#7',3,'match510398-top.html#7',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>MostCommonValues mostCommonValues = columnStats.mostCommonValues();
        assertThat(mostCommonValues.values().length, is(0));
    }

    @</B></FONT>Property
<A NAME="2"></A>    public void test_null_fraction_is_between_incl_0_and_incl_1(ArrayList&lt;Integer&gt; numbers,
                                                                @InRange(minInt = 0) int nullCount,
                                                                long totalRowCount) {
        <FONT color="#980517"><A HREF="javascript:ZweiFrames('match510398-1.html#2',3,'match510398-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assumeThat(totalRowCount, greaterThanOrEqualTo((long) nullCount));
        assumeThat((long) numbers.size() + nullCount, lessThanOrEqualTo(totalRowCount));

        ColumnStats&lt;Integer&gt; stats = ColumnStats.fromSortedValues(numbers, DataTypes.INTEGER, nullCount, totalRowCount);
        assertThat(stats.nullFraction(), greaterThanOrEqualTo(0.0));
        assertThat(stats.nullFraction(), lessThanOrEqualTo</B></FONT>(1.0));
    }

    @Test
    public void test_common_stats_can_be_serialized_and_deserialized() throws IOException  {
        List&lt;Integer&gt; numbers = List.of(1, 1, 2, 4, 4, 4, 4, 4);
        ColumnStats columnStats = ColumnStats.fromSortedValues(numbers, DataTypes.INTEGER, 1, 400L);

        BytesStreamOutput out = new BytesStreamOutput();
        columnStats.writeTo(out);
        StreamInput in = out.bytes().streamInput();
        ColumnStats stats = new ColumnStats(in);

        assertThat(stats, is(columnStats));
    }
<A NAME="4"></A>
    @Test
    public void test_column_stats_generation_for_num_samples_gt_mcv_target() {
        List&lt;Integer&gt; numbers = <FONT color="#6cc417"><A HREF="javascript:ZweiFrames('match510398-1.html#4',3,'match510398-top.html#4',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>IntStream.concat(
            IntStream.concat(
                IntStream.range(1, 10),
                IntStream.generate(() -&gt; 10).limit(90)
            ),
            IntStream.concat(
                IntStream.generate(() -&gt; 20).limit(20),
                IntStream.range(30, 150)
            ))
            .boxed()
            .collect(Collectors.toList</B></FONT>());
<A NAME="0"></A>
        ColumnStats&lt;Integer&gt; columnStats = ColumnStats.fromSortedValues(numbers, DataTypes.INTEGER, 0, 400L);
        List&lt;Integer&gt; histogramSample = columnStats.histogram().subList(0, 15);
        assertThat(histogramSample, <FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match510398-1.html#0',3,'match510398-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>contains(1, 2, 3, 4, 5, 6, 7, 8, 9, 30, 31, 32, 33, 34, 35));
        MostCommonValues mostCommonValues = columnStats.mostCommonValues();
        assertThat(mostCommonValues.values().length, is(2));
        assertThat(mostCommonValues.values()[0], is(10));
        assertThat(mostCommonValues.frequencies()[0], Matchers.closeTo(0.376, 0.01));
        assertThat(mostCommonValues.values()[1], is(20));
        assertThat(mostCommonValues.frequencies()[1], Matchers.closeTo(0.086, 0.01));
    }
<A NAME="3"></A>
    @Test
    public void test_histogram_contains_evenly_spaced_values_from_samples() {</B></FONT>
        List&lt;Integer&gt; histogram = <FONT color="#53858b"><A HREF="javascript:ZweiFrames('match510398-1.html#3',3,'match510398-top.html#3',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>ColumnStats.generateHistogram(
            4,
            IntStream.range(1, 21).boxed().collect(Collectors.toList())
        );
        assertThat(histogram, contains(1, 7, 13, 19));
    }
<A NAME="6"></A>
    @Test
    public void test_average_size_in_bytes_is_calculated_for_variable_width_columns() {</B></FONT>
        ColumnStats stats = <FONT color="#8c8774"><A HREF="javascript:ZweiFrames('match510398-1.html#6',3,'match510398-top.html#6',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>ColumnStats.fromSortedValues(List.of(&quot;a&quot;, &quot;b&quot;, &quot;ccc&quot;, &quot;dddddd&quot;), DataTypes.STRING, 0, 100L);
        assertThat(stats.averageSizeInBytes(), is(50.0));
    }

    @Test
    public void test_column_stats_generation_from_null_values_only_has_null_fraction_1() {</B></FONT>
        ColumnStats columnStats = ColumnStats.fromSortedValues(List.of(), DataTypes.INTEGER, 200, 1000L);
        assertThat(columnStats.nullFraction(), is(1.0));
    }
}
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>DDLIntegrationTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
 * software solely pursuant to the terms of the relevant commercial agreement.
 */

package io.crate.integrationtests;

import static com.carrotsearch.randomizedtesting.RandomizedTest.$;
import static io.crate.protocols.postgres.PGErrorStatus.DUPLICATE_TABLE;
import static io.crate.protocols.postgres.PGErrorStatus.INTERNAL_ERROR;
import static io.crate.protocols.postgres.PGErrorStatus.UNDEFINED_TABLE;
import static io.crate.testing.Asserts.assertThrowsMatches;
import static io.crate.testing.SQLErrorMatcher.isSQLError;
import static io.crate.testing.TestingHelpers.printedTable;
import static io.netty.handler.codec.http.HttpResponseStatus.BAD_REQUEST;
import static io.netty.handler.codec.http.HttpResponseStatus.CONFLICT;
import static io.netty.handler.codec.http.HttpResponseStatus.NOT_FOUND;
import static io.netty.handler.codec.rtsp.RtspResponseStatuses.INTERNAL_SERVER_ERROR;
import static org.hamcrest.CoreMatchers.startsWith;
import static org.hamcrest.Matchers.containsString;
import static org.hamcrest.core.Is.is;
<A NAME="1"></A>
import java.util.ArrayList;
import java.util.Arrays;
<FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match510398-0.html#1',2,'match510398-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>import java.util.List;
import java.util.Map;

import org.elasticsearch.Version;
import org.elasticsearch.action.admin.indices.template.get.GetIndexTemplatesResponse;
import org.elasticsearch.cluster.metadata.IndexMetadata;
import org.elasticsearch.common.settings.Settings;
import org.elasticsearch.test.ESIntegTestCase;
import org.hamcrest.Matchers;
import org.junit.Test;
import org.skyscreamer.jsonassert.JSONAssert;
import org.skyscreamer.jsonassert.JSONCompareMode;

import io.crate.metadata.PartitionName;
import io.crate.metadata.RelationName;
import io.crate.metadata.Schemas;
import io.crate.protocols.postgres.PGErrorStatus;
import io.crate.testing.Asserts;
import io.crate.testing.SQLErrorMatcher;
import io.crate.testing.TestingHelpers;
import io.crate.testing.UseRandomizedSchema;
import io.netty.handler.codec.http.HttpResponseStatus;

@</B></FONT>ESIntegTestCase.ClusterScope()
@UseRandomizedSchema(random = false)
public class DDLIntegrationTest extends SQLIntegrationTestCase {

    @Test
    public void testCreateTable() throws Exception {
        execute(&quot;create table test (col1 integer primary key, col2 string) &quot; +
                &quot;clustered into 5 shards with (number_of_replicas = 1, \&quot;write.wait_for_active_shards\&quot;=1)&quot;);
        String expectedMapping = &quot;{\&quot;default\&quot;:{&quot; +
                                 &quot;\&quot;dynamic\&quot;:\&quot;strict\&quot;,\&quot;_meta\&quot;:{&quot; +
                                 &quot;\&quot;primary_keys\&quot;:[\&quot;col1\&quot;]},&quot; +
                                 &quot;\&quot;properties\&quot;:{&quot; +
                                 // doc_values: true is default and not included
                                 &quot;\&quot;col1\&quot;:{\&quot;type\&quot;:\&quot;integer\&quot;,\&quot;position\&quot;:1},&quot; +
<A NAME="5"></A>                                 &quot;\&quot;col2\&quot;:{\&quot;type\&quot;:\&quot;keyword\&quot;,\&quot;position\&quot;:2}&quot; +
                                 &quot;}}}&quot;;

        <FONT color="#151b8d"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match510398-0.html#5',2,'match510398-top.html#5',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>String expectedSettings = &quot;{\&quot;test\&quot;:{&quot; +
                                  &quot;\&quot;settings\&quot;:{&quot; +
                                  &quot;\&quot;index.number_of_replicas\&quot;:\&quot;1\&quot;,&quot; +
                                  &quot;\&quot;index.number_of_shards\&quot;:\&quot;5\&quot;,&quot; +
                                  &quot;\&quot;index.version.created\&quot;:\&quot;&quot; + Version.CURRENT.internalId + &quot;\&quot;&quot; +
                                  &quot;}}}&quot;;

        assertEquals(expectedMapping, getIndexMapping(&quot;test&quot;));
        JSONAssert.assertEquals(expectedSettings, getIndexSettings(&quot;test&quot;), false);

        // test index usage
        execute(&quot;insert into test (col1, col2) values (1, 'foo')&quot;);
        assertEquals(1, response.rowCount());
        refresh();
        execute(&quot;SELECT * FROM test&quot;);
        assertEquals(1L, response.rowCount</B></FONT>());
    }

    @Test
    public void testCreateTableWithRefreshIntervalDisableRefresh() throws Exception {
        execute(&quot;create table test (id int primary key, content string) &quot; +
                &quot;clustered into 5 shards &quot; +
                &quot;with (refresh_interval=0, number_of_replicas = 0)&quot;);
        String expectedSettings = &quot;{\&quot;test\&quot;:{&quot; +
                                  &quot;\&quot;settings\&quot;:{&quot; +
                                  &quot;\&quot;index.number_of_replicas\&quot;:\&quot;0\&quot;,&quot; +
                                  &quot;\&quot;index.number_of_shards\&quot;:\&quot;5\&quot;,&quot; +
                                  &quot;\&quot;index.refresh_interval\&quot;:\&quot;0s\&quot;,&quot; +
                                  &quot;\&quot;index.version.created\&quot;:\&quot;&quot; + Version.CURRENT.internalId + &quot;\&quot;&quot; +
                                  &quot;}}}&quot;;
        JSONAssert.assertEquals(expectedSettings, getIndexSettings(&quot;test&quot;), false);

        execute(&quot;ALTER TABLE test SET (refresh_interval = '5000ms')&quot;);
        String expectedSetSettings = &quot;{\&quot;test\&quot;:{&quot; +
                                     &quot;\&quot;settings\&quot;:{&quot; +
                                     &quot;\&quot;index.number_of_replicas\&quot;:\&quot;0\&quot;,&quot; +
                                     &quot;\&quot;index.number_of_shards\&quot;:\&quot;5\&quot;,&quot; +
                                     &quot;\&quot;index.refresh_interval\&quot;:\&quot;5s\&quot;,&quot; +
                                     &quot;\&quot;index.version.created\&quot;:\&quot;&quot; + Version.CURRENT.internalId + &quot;\&quot;&quot; +
                                     &quot;}}}&quot;;
        JSONAssert.assertEquals(expectedSetSettings, getIndexSettings(&quot;test&quot;), false);

        execute(&quot;ALTER TABLE test RESET (refresh_interval)&quot;);
        String expectedResetSettings = &quot;{\&quot;test\&quot;:{&quot; +
                                       &quot;\&quot;settings\&quot;:{&quot; +
                                       &quot;\&quot;index.number_of_replicas\&quot;:\&quot;0\&quot;,&quot; +
                                       &quot;\&quot;index.number_of_shards\&quot;:\&quot;5\&quot;,&quot; +
                                       &quot;\&quot;index.refresh_interval\&quot;:\&quot;1s\&quot;,&quot; +
                                       &quot;\&quot;index.version.created\&quot;:\&quot;&quot; + Version.CURRENT.internalId + &quot;\&quot;&quot; +
                                       &quot;}}}&quot;;
        JSONAssert.assertEquals(expectedResetSettings, getIndexSettings(&quot;test&quot;), false);
    }


<A NAME="6"></A>    @Test
    public void testCreateTableAlreadyExistsException() throws Exception {
        execute(&quot;create table test (col1 integer primary key, col2 string)&quot;);
        <FONT color="#8c8774"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match510398-0.html#6',2,'match510398-top.html#6',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>ensureYellow();
        assertThrowsMatches(() -&gt; execute(&quot;create table test (col1 integer primary key, col2 string)&quot;),
                     isSQLError(is(&quot;Relation 'doc.test' already exists.&quot;),
                                DUPLICATE_TABLE,
                                CONFLICT,
                                4093)
        );
    }

    @Test
    public void testCreateTableWithReplicasAndShards() throws Exception {</B></FONT>
        execute(&quot;create table test (col1 integer primary key, col2 string)&quot; +
                &quot;clustered by (col1) into 10 shards with (number_of_replicas=2, \&quot;write.wait_for_active_shards\&quot;=1)&quot;);
        String expectedMapping = &quot;{\&quot;default\&quot;:{&quot; +
                                 &quot;\&quot;dynamic\&quot;:\&quot;strict\&quot;,&quot; +
                                 &quot;\&quot;_meta\&quot;:{&quot; +
                                 &quot;\&quot;primary_keys\&quot;:[\&quot;col1\&quot;],&quot; +
                                 &quot;\&quot;routing\&quot;:\&quot;col1\&quot;},&quot; +
                                 &quot;\&quot;properties\&quot;:{&quot; +
                                 &quot;\&quot;col1\&quot;:{\&quot;type\&quot;:\&quot;integer\&quot;},&quot; +
<A NAME="7"></A>                                 &quot;\&quot;col2\&quot;:{\&quot;type\&quot;:\&quot;keyword\&quot;}&quot; +
                                 &quot;}}}&quot;;

        <FONT color="#38a4a5"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match510398-0.html#7',2,'match510398-top.html#7',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>String expectedSettings = &quot;{\&quot;test\&quot;:{&quot; +
                                  &quot;\&quot;settings\&quot;:{&quot; +
                                  &quot;\&quot;index.number_of_replicas\&quot;:\&quot;2\&quot;,&quot; +
                                  &quot;\&quot;index.number_of_shards\&quot;:\&quot;10\&quot;,&quot; +
                                  &quot;\&quot;index.version.created\&quot;:\&quot;&quot; + Version.CURRENT.internalId + &quot;\&quot;&quot; +
                                  &quot;}}}&quot;;

        JSONAssert.assertEquals(expectedMapping, getIndexMapping(&quot;test&quot;), JSONCompareMode.LENIENT);
        JSONAssert.assertEquals(expectedSettings, getIndexSettings(&quot;test&quot;), JSONCompareMode.LENIENT);
    }

    @</B></FONT>Test
    public void testCreateTableWithStrictColumnPolicy() throws Exception {
        execute(&quot;create table test (col1 integer primary key, col2 string) &quot; +
                &quot;clustered into 5 shards &quot; +
                &quot;with (column_policy='strict', number_of_replicas = 0)&quot;);
        String expectedMapping = &quot;{\&quot;default\&quot;:{&quot; +
                                 &quot;\&quot;dynamic\&quot;:\&quot;strict\&quot;,\&quot;_meta\&quot;:{&quot; +
                                 &quot;\&quot;primary_keys\&quot;:[\&quot;col1\&quot;]},&quot; +
                                 &quot;\&quot;properties\&quot;:{&quot; +
                                 &quot;\&quot;col1\&quot;:{\&quot;type\&quot;:\&quot;integer\&quot;,\&quot;position\&quot;:1},&quot; +
                                 &quot;\&quot;col2\&quot;:{\&quot;type\&quot;:\&quot;keyword\&quot;,\&quot;position\&quot;:2}&quot; +
                                 &quot;}}}&quot;;

        String expectedSettings = &quot;{\&quot;test\&quot;:{&quot; +
                                  &quot;\&quot;settings\&quot;:{&quot; +
                                  &quot;\&quot;index.number_of_replicas\&quot;:\&quot;0\&quot;,&quot; +
                                  &quot;\&quot;index.number_of_shards\&quot;:\&quot;5\&quot;,&quot; +
                                  &quot;\&quot;index.version.created\&quot;:\&quot;&quot; + Version.CURRENT.internalId + &quot;\&quot;&quot; +
                                  &quot;}}}&quot;;


        assertEquals(expectedMapping, getIndexMapping(&quot;test&quot;));
        JSONAssert.assertEquals(expectedSettings, getIndexSettings(&quot;test&quot;), false);
    }

    @Test
    public void testCreateGeoShapeExplicitIndex() throws Exception {
        execute(&quot;create table test (col1 geo_shape INDEX using QUADTREE with (precision='1m', distance_error_pct='0.25'))&quot;);
        ensureYellow();
        String expectedMapping = &quot;{\&quot;default\&quot;:{&quot; +
                                 &quot;\&quot;dynamic\&quot;:\&quot;strict\&quot;,\&quot;_meta\&quot;:{},&quot; +
                                 &quot;\&quot;properties\&quot;:{&quot; +
                                 &quot;\&quot;col1\&quot;:{\&quot;type\&quot;:\&quot;geo_shape\&quot;,\&quot;tree\&quot;:\&quot;quadtree\&quot;,\&quot;position\&quot;:1,\&quot;precision\&quot;:\&quot;1.0m\&quot;,\&quot;distance_error_pct\&quot;:0.25}}}}&quot;;
        assertEquals(expectedMapping, getIndexMapping(&quot;test&quot;));
    }

    @Test
    public void testCreateColumnWithDefaultExpression() throws Exception {
        execute(&quot;create table test (col1 text default 'foo')&quot;);
        String expectedMapping = &quot;{\&quot;default\&quot;:{&quot; +
                                 &quot;\&quot;dynamic\&quot;:\&quot;strict\&quot;,\&quot;_meta\&quot;:{},&quot; +
                                 &quot;\&quot;properties\&quot;:{\&quot;col1\&quot;:{\&quot;type\&quot;:\&quot;keyword\&quot;,\&quot;position\&quot;:1,\&quot;default_expr\&quot;:\&quot;'foo'\&quot;}}}}&quot;;
        assertEquals(expectedMapping, getIndexMapping(&quot;test&quot;));

    }

    @Test
    public void testCreateGeoShape() throws Exception {
        execute(&quot;create table test (col1 geo_shape)&quot;);
        ensureYellow();
        String expectedMapping = &quot;{\&quot;default\&quot;:{&quot; +
                                 &quot;\&quot;dynamic\&quot;:\&quot;strict\&quot;,\&quot;_meta\&quot;:{},&quot; +
                                 &quot;\&quot;properties\&quot;:{\&quot;col1\&quot;:{\&quot;type\&quot;:\&quot;geo_shape\&quot;,\&quot;position\&quot;:1}}}}&quot;;
        assertEquals(expectedMapping, getIndexMapping(&quot;test&quot;));

    }

    @Test
    public void testGeoShapeInvalidPrecision() throws Exception {
        assertThrowsMatches(() -&gt; execute(&quot;create table test (col1 geo_shape INDEX using QUADTREE with (precision='10%'))&quot;),
                     isSQLError(is(&quot;Value '10%' of setting precision is not a valid distance unit&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4000)
        );
    }

    @Test
    public void testGeoShapeInvalidDistance() throws Exception {
        assertThrowsMatches(() -&gt; execute(
            &quot;create table test (col1 geo_shape INDEX using QUADTREE with (distance_error_pct=true))&quot;),
                     isSQLError(is(&quot;Value 'true' of setting distance_error_pct is not a float value&quot;),
                         INTERNAL_ERROR,
                         BAD_REQUEST,
                         4000)
        );
    }

    @Test
    public void testUnknownGeoShapeSetting() throws Exception {
        assertThrowsMatches(() -&gt; execute(&quot;create table test (col1 geo_shape INDEX using QUADTREE with (does_not_exist=false))&quot;),
                     isSQLError(is(&quot;Setting \&quot;does_not_exist\&quot; ist not supported on geo_shape index&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4000)
        );
    }

    @Test
    public void testCreateTableWithInlineDefaultIndex() throws Exception {
        execute(&quot;create table quotes (quote string index using plain) with (number_of_replicas = 0)&quot;);
        String quote = &quot;Would it save you a lot of time if I just gave up and went mad now?&quot;;
        execute(&quot;insert into quotes values (?)&quot;, new Object[]{quote});
        refresh();

        // matching does not work on plain indexes
        execute(&quot;select quote from quotes where match(quote, 'time')&quot;);
        assertEquals(0, response.rowCount());

        // filtering on the actual value does work
        execute(&quot;select quote from quotes where quote = ?&quot;, new Object[]{quote});
        assertEquals(1L, response.rowCount());
        assertEquals(quote, response.rows()[0][0]);
    }

    @Test
    public void testCreateTableWithInlineIndex() throws Exception {
        execute(&quot;create table quotes (quote string index using fulltext) with (number_of_replicas = 0)&quot;);
        String quote = &quot;Would it save you a lot of time if I just gave up and went mad now?&quot;;
        execute(&quot;insert into quotes values (?)&quot;, new Object[]{quote});
        execute(&quot;refresh table quotes&quot;);

        execute(&quot;select quote from quotes where match(quote, 'time')&quot;);
        assertEquals(1L, response.rowCount());
        assertEquals(quote, response.rows()[0][0]);

        // filtering on the actual value does not work anymore because its now indexed using the
        // standard analyzer
        execute(&quot;select quote from quotes where quote = ?&quot;, new Object[]{quote});
        assertEquals(0, response.rowCount());
    }

    @Test
    public void testCreateTableWithIndexOff() throws Exception {
        execute(&quot;create table quotes (id int, quote string index off) with (number_of_replicas = 0)&quot;);
        String quote = &quot;Would it save you a lot of time if I just gave up and went mad now?&quot;;
        execute(&quot;insert into quotes (id, quote) values (?, ?)&quot;, new Object[]{1, quote});
        execute(&quot;refresh table quotes&quot;);

        assertThrowsMatches(
            () -&gt; execute(&quot;select quote from quotes where quote = ?&quot;, new Object[]{quote}),
            isSQLError(
                containsString(&quot;Cannot search on field [quote] since it is not indexed.&quot;),
                INTERNAL_ERROR,
                BAD_REQUEST,
                4000
            )
        );
    }

    @Test
    public void testCreateTableWithIndex() throws Exception {
        execute(&quot;create table quotes (quote string, &quot; +
                &quot;index quote_fulltext using fulltext(quote) with (analyzer='stop')) with (number_of_replicas = 0)&quot;);
        String quote = &quot;Would it save you a lot of time if I just gave up and went mad now?&quot;;
        execute(&quot;insert into quotes values (?)&quot;, new Object[]{quote});
        execute(&quot;refresh table quotes&quot;);

        execute(&quot;select quote from quotes where match(quote_fulltext, 'time')&quot;);
        assertEquals(1L, response.rowCount());
        assertEquals(quote, response.rows()[0][0]);

        // filtering on the actual value does still work
        execute(&quot;select quote from quotes where quote = ?&quot;, new Object[]{quote});
        assertEquals(1L, response.rowCount());
    }

    @Test
    public void testCreateTableWithCompositeIndex() throws Exception {
        execute(&quot;create table novels (title string, description string, &quot; +
                &quot;index title_desc_fulltext using fulltext(title, description) &quot; +
                &quot;with(analyzer='stop')) with (number_of_replicas = 0)&quot;);

        String title = &quot;So Long, and Thanks for All the Fish&quot;;
        String description = &quot;Many were increasingly of the opinion that they'd all made a big &quot; +
                             &quot;mistake in coming down from the trees in the first place. And some said that &quot; +
                             &quot;even the trees had been a bad move, and that no one should ever have left &quot; +
<A NAME="4"></A>                             &quot;the oceans.&quot;;
        execute(&quot;insert into novels (title, description) values(?, ?)&quot;,
            new Object[]{title, description});
        <FONT color="#6cc417"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match510398-0.html#4',2,'match510398-top.html#4',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>refresh();

        // match token existing at field `title`
        execute(&quot;select title, description from novels where match(title_desc_fulltext, 'fish')&quot;);
        assertEquals(1L, response.rowCount());
        assertEquals(title, response.rows()[0][0]);
        assertEquals(description, response.rows()[0][1]);

        // match token existing at field `description`
        execute(&quot;select title, description from novels where match(title_desc_fulltext, 'oceans')&quot;);
        assertEquals(1L, response.rowCount());
        assertEquals</B></FONT>(title, response.rows()[0][0]);
        assertEquals(description, response.rows()[0][1]);

        // filtering on the actual values does still work
        execute(&quot;select title from novels where title = ?&quot;, new Object[]{title});
        assertEquals(1L, response.rowCount());
    }

    @Test
    public void test_create_table_with_check_fail_on_insert() {
        execute(&quot;create table t (id integer primary key, qty integer, constraint check_1 check (qty &gt; 0))&quot;);
<A NAME="3"></A>        execute(&quot;insert into t(id, qty) values(0, null), (1, 1)&quot;);
        refresh();
        execute(&quot;select id, qty from t order by id&quot;);
        <FONT color="#53858b"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match510398-0.html#3',2,'match510398-top.html#3',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>assertEquals(printedTable(response.rows()),
                     &quot;0| NULL\n&quot; +
                     &quot;1| 1\n&quot;);
        assertThrowsMatches(() -&gt; execute(&quot;insert into t(id, qty) values(2, -1)&quot;),
                     isSQLError(containsString(&quot;Failed CONSTRAINT check_1 CHECK (\&quot;qty\&quot; &gt; 0) and values&quot;),
                     INTERNAL_ERROR,
                     BAD_REQUEST,
                     4000));
    }

    @Test
    public void test_create_table_with_check_fail_on_update() {</B></FONT>
        execute(&quot;create table t (id integer primary key, qty integer constraint check_1 check (qty &gt; 0))&quot;);
        execute(&quot;insert into t(id, qty) values(0, 1)&quot;);
        refresh();
        execute(&quot;select id, qty from t order by id&quot;);
        assertEquals(printedTable(response.rows()), &quot;0| 1\n&quot;);
        execute(&quot;update t set qty = 1 where id = 0 returning id, qty&quot;);
        assertEquals(printedTable(response.rows()), &quot;0| 1\n&quot;);
        assertThrowsMatches(() -&gt; execute(&quot;update t set qty = -1 where id = 0&quot;),
                     isSQLError(containsString(&quot;Failed CONSTRAINT check_1 CHECK (\&quot;qty\&quot; &gt; 0) and values&quot;),
                                INTERNAL_ERROR,
                                INTERNAL_SERVER_ERROR,
                                5000));

    }

    @Test
    public void test_alter_table_add_column_succedds_because_check_constaint_refers_to_self_columns() {
        execute(&quot;create table t (id integer primary key, qty integer constraint check_1 check (qty &gt; 0))&quot;);
        execute(&quot;alter table t add column bazinga integer constraint bazinga_check check(bazinga &lt;&gt; 42)&quot;);
        execute(&quot;insert into t(id, qty, bazinga) values(0, 1, 100)&quot;);
        assertThrowsMatches(() -&gt; execute(&quot;insert into t(id, qty, bazinga) values(0, 1, 42)&quot;),
                     isSQLError(containsString(&quot;Failed CONSTRAINT bazinga_check CHECK (\&quot;bazinga\&quot; &lt;&gt; 42) and values {qty=1, id=0, bazinga=42}&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4000));
    }
<A NAME="0"></A>
    @Test
    public void test_alter_table_drop_constraint_removes_the_constraint_and_leaves_other_constraints_in_place() {
        <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match510398-0.html#0',2,'match510398-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>execute(&quot;create table t (&quot; +
                      &quot;    id int primary key, &quot; +
                      &quot;    qty int constraint check_qty_gt_zero check(qty &gt; 0), &quot; +
                      &quot;    constraint check_id_ge_zero check (id &gt;= 0)&quot; +
                      &quot;)&quot;);
        String selectCheckConstraintsStmt =
            &quot;select table_schema, table_name, constraint_type, constraint_name &quot; +
            &quot;from information_schema.table_constraints &quot; +
            &quot;where table_name='t'&quot; +
            &quot;order by constraint_name&quot;;
        execute(selectCheckConstraintsStmt);
        assertThat(printedTable(response.rows()), is(
            &quot;doc| t| CHECK| check_id_ge_zero\n&quot; +
            &quot;doc| t| CHECK| check_qty_gt_zero\n&quot; +
            &quot;doc| t| PRIMARY KEY| t_pk\n&quot;
        ));
        execute(&quot;alter table t drop constraint check_id_ge_zero&quot;);
        execute(selectCheckConstraintsStmt);
        assertThat(printedTable(response.rows()), is(
            &quot;doc| t| CHECK| check_qty_gt_zero\n&quot; +
            &quot;doc| t| PRIMARY KEY| t_pk\n&quot;
        ));
        execute(&quot;insert into t(id, qty) values(-42, 100)&quot;);
        assertThrowsMatches(() -&gt; execute(&quot;insert into t(id, qty) values(0, 0)&quot;),
                     isSQLError(is(&quot;Failed CONSTRAINT check_qty_gt_zero CHECK (\&quot;qty\&quot; &gt; 0) and values {qty=0, id=0}&quot;),
                         INTERNAL_ERROR,
                         BAD_REQUEST,
                         4000));
    }

    @Test
    public void testAlterTable() throws Exception {</B></FONT>
        execute(&quot;create table test (col1 int) with (number_of_replicas='0-all')&quot;);
        ensureYellow();

        execute(&quot;select number_of_replicas from information_schema.tables where table_name = 'test'&quot;);
        assertEquals(&quot;0-all&quot;, response.rows()[0][0]);

        execute(&quot;alter table test set (number_of_replicas=0)&quot;);
        execute(&quot;select number_of_replicas from information_schema.tables where table_name = 'test'&quot;);
        assertEquals(&quot;0&quot;, response.rows()[0][0]);
    }

    @Test
    public void testAlterTableAddColumn() {
        execute(&quot;create table t (id int primary key) with (number_of_replicas=0)&quot;);
        execute(&quot;alter table t add column name string&quot;);

        execute(&quot;select data_type from information_schema.columns where &quot; +
                &quot;table_name = 't' and column_name = 'name'&quot;);
        assertThat(response.rows()[0][0], is(&quot;text&quot;));

        execute(&quot;alter table t add column o object as (age int)&quot;);
        execute(&quot;select data_type from information_schema.columns where &quot; +
                &quot;table_name = 't' and column_name = 'o'&quot;);
        assertThat((String) response.rows()[0][0], is(&quot;object&quot;));
    }


    @Test
    public void testAlterTableAddColumnAsPrimaryKey() throws Exception {
        execute(&quot;create table t (id int primary key) &quot; +
                &quot;clustered into 1 shards &quot; +
                &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;alter table t add column name string primary key&quot;);
        execute(&quot;select constraint_name from information_schema.table_constraints &quot; +
                &quot;where table_name = 't' and table_schema = 'doc' and constraint_type = 'PRIMARY KEY'&quot;);

        assertThat(response.rowCount(), is(1L));
        assertThat(response.rows()[0][0], is(&quot;t_pk&quot;));
    }

    @Test
    public void testAlterTableWithRecordsAddColumnAsPrimaryKey() throws Exception {
        execute(&quot;create table t (id int primary key) &quot; +
                &quot;clustered into 1 shards &quot; +
                &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into t (id) values(1)&quot;);
        refresh();

        assertThrowsMatches(() -&gt; execute(&quot;alter table t add column name string primary key&quot;),
        isSQLError(is(&quot;Cannot add a primary key column to a table that isn't empty&quot;), INTERNAL_ERROR, BAD_REQUEST, 4004));
    }

    @Test
    public void testAlterTableWithoutRecordsAddGeneratedColumn() throws Exception {
        execute(&quot;create table t (id int) &quot; +
                &quot;clustered into 1 shards &quot; +
                &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;alter table t add column id_generated as (id + 1)&quot;);
        execute(&quot;insert into t (id) values(1)&quot;);
        refresh();
        execute(&quot;select id, id_generated from t&quot;);
        assertThat(response.rows()[0][0], is(1));
        assertThat(response.rows()[0][1], is(2));
    }

    @Test
    public void testAlterTableWithRecordsAddGeneratedColumn() throws Exception {
        execute(&quot;create table t (id int) &quot; +
                &quot;clustered into 1 shards &quot; +
                &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into t (id) values(1)&quot;);
        refresh();

        assertThrowsMatches(() -&gt; execute(&quot;alter table t add column id_generated as (id + 1)&quot;),
                     isSQLError(is(&quot;Cannot add a generated column to a table that isn't empty&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4004));
    }

    @Test
    public void testAlterTableAddDotExpression() {
        execute(&quot;create table t (id int) &quot; +
                &quot;clustered into 1 shards &quot; +
                &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();
        assertThrowsMatches(() -&gt; execute(&quot;alter table t add \&quot;o.x\&quot; int&quot;),
                     isSQLError(is(&quot;\&quot;o.x\&quot; contains a dot&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4008));
    }

    @Test
    public void testAlterTableAddDotExpressionInSubscript() {
        execute(&quot;create table t (id int) clustered into 1 shards with (number_of_replicas=0)&quot;);
        ensureYellow();

        assertThrowsMatches(() -&gt;  execute(&quot;alter table t add \&quot;o['x.y']\&quot; int&quot;),
                     isSQLError(is(&quot;\&quot;o['x.y']\&quot; contains a dot&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4008));

    }

    @Test
    public void testAlterTableAddObjectColumnToNonExistingObject() {
        execute(&quot;create table t (id int) &quot; +
                &quot;clustered into 1 shards &quot; +
                &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;alter table t add o['x'] int&quot;);
        execute(&quot;select column_name from information_schema.columns where &quot; +
                &quot;table_name = 't' and table_schema='doc'&quot; +
                &quot;order by column_name asc&quot;);
        assertThat(response.rowCount(), is(3L));

        List&lt;String&gt; fqColumnNames = new ArrayList&lt;&gt;();
        for (Object[] row : response.rows()) {
            fqColumnNames.add((String) row[0]);
        }
        assertThat(fqColumnNames, Matchers.contains(&quot;id&quot;, &quot;o&quot;, &quot;o['x']&quot;));
    }

    @Test
    public void testAlterTableAddObjectColumnToExistingObject() {
        execute(&quot;create table t (o object as (x string)) &quot; +
                &quot;clustered into 1 shards &quot; +
                &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;alter table t add o['y'] int&quot;);
        // column o exists already
        assertThrowsMatches(() -&gt; execute(&quot;alter table t add o object as (z string)&quot;),
                     isSQLError(containsString(&quot;The table doc.t already has a column named o&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4000));

        execute(&quot;select column_name from information_schema.columns where &quot; +
                &quot;table_name = 't' and table_schema='doc'&quot; +
                &quot;order by column_name asc&quot;);
        assertThat(response.rowCount(), is(3L));

        List&lt;String&gt; fqColumnNames = new ArrayList&lt;&gt;();
        for (Object[] row : response.rows()) {
            fqColumnNames.add((String) row[0]);
        }
        assertThat(fqColumnNames, Matchers.contains(&quot;o&quot;, &quot;o['x']&quot;, &quot;o['y']&quot;));
    }

    @Test
    public void testAlterTableAddObjectColumnToExistingObjectNested() throws Exception {
        execute(&quot;CREATE TABLE my_table (&quot; +
                &quot;  name string, &quot; +
                &quot;  age integer,&quot; +
                &quot;  book object as (isbn string)&quot; +
                &quot;)&quot;);
        ensureYellow();
        execute(&quot;alter table my_table add column book['author'] object as (\&quot;authorId\&quot; integer)&quot;);
        waitNoPendingTasksOnAll();
        execute(&quot;select column_name from information_schema.columns where &quot; +
                &quot;table_name = 'my_table' and table_schema='doc'&quot; +
                &quot;order by column_name asc&quot;);
        assertThat(response.rowCount(), is(6L));
        assertThat(TestingHelpers.getColumn(response.rows(), 0),
            is(Matchers.&lt;Object&gt;arrayContaining(&quot;age&quot;, &quot;book&quot;, &quot;book['author']&quot;, &quot;book['author']['authorId']&quot;, &quot;book['isbn']&quot;, &quot;name&quot;)));
        execute(&quot;alter table my_table add column book['author']['authorName'] string&quot;);
        waitNoPendingTasksOnAll();
        execute(&quot;select column_name from information_schema.columns where &quot; +
                &quot;table_name = 'my_table' and table_schema='doc'&quot; +
                &quot;order by column_name asc&quot;);
        assertThat(response.rowCount(), is(7L));
        assertThat(TestingHelpers.getColumn(response.rows(), 0),
            is(Matchers.&lt;Object&gt;arrayContaining(&quot;age&quot;, &quot;book&quot;, &quot;book['author']&quot;, &quot;book['author']['authorId']&quot;, &quot;book['author']['authorName']&quot;, &quot;book['isbn']&quot;, &quot;name&quot;)));

    }

    @Test
    public void testAlterTableAddNestedObjectWithArrayToExistingObject() throws Exception {
        execute(&quot;CREATE TABLE my_table (col1 object)&quot;);
        ensureYellow();
        execute(&quot;ALTER TABLE my_table ADD COLUMN col1['col2'] object as (col3 array(string))&quot;);
        waitNoPendingTasksOnAll();
        execute(&quot;SELECT column_name, data_type FROM information_schema.columns &quot; +
                &quot;WHERE table_name = 'my_table' AND table_schema = 'doc' &quot; +
                &quot;ORDER BY column_name asc&quot;);
        assertThat(TestingHelpers.getColumn(response.rows(), 0),
            is(Matchers.&lt;Object&gt;arrayContaining(&quot;col1&quot;, &quot;col1['col2']&quot;, &quot;col1['col2']['col3']&quot;)));
        assertThat(TestingHelpers.getColumn(response.rows(), 1),
            is(Matchers.arrayContaining(&quot;object&quot;, &quot;object&quot;, &quot;text_array&quot;)));

        execute(&quot;DROP TABLE my_table&quot;);
        ensureYellow();

        execute(&quot;CREATE TABLE my_table (col1 object as (col2 object))&quot;);
        ensureYellow();
        execute(&quot;ALTER TABLE my_table ADD COLUMN col1['col2']['col3'] object as (col4 array(long))&quot;);
        waitNoPendingTasksOnAll();
        execute(&quot;SELECT column_name, data_type FROM information_schema.columns &quot; +
                &quot;WHERE table_name = 'my_table' AND table_schema = 'doc' &quot; +
                &quot;ORDER BY column_name asc&quot;);
        assertThat(TestingHelpers.getColumn(response.rows(), 0),
            is(Matchers.&lt;Object&gt;arrayContaining(&quot;col1&quot;, &quot;col1['col2']&quot;, &quot;col1['col2']['col3']&quot;, &quot;col1['col2']['col3']['col4']&quot;)));
        assertThat(TestingHelpers.getColumn(response.rows(), 1),
            is(Matchers.arrayContaining(&quot;object&quot;, &quot;object&quot;, &quot;object&quot;, &quot;bigint_array&quot;)));
    }

    @Test
    public void testAlterTableAddObjectToObjectArray() throws Exception {
        execute(&quot;CREATE TABLE t (&quot; +
                &quot;   attributes ARRAY(&quot; +
                &quot;       OBJECT (STRICT) as (&quot; +
                &quot;           name STRING&quot; +
                &quot;       )&quot; +
                &quot;   )&quot; +
                &quot;)&quot;);
        ensureYellow();
        execute(&quot;ALTER TABLE t ADD column attributes['is_nice'] BOOLEAN&quot;);
        execute(&quot;INSERT INTO t (attributes) values ([{name='Trillian', is_nice=True}])&quot;);
        refresh();
        execute(&quot;select attributes from t&quot;);
        assertThat(((List&lt;Object&gt;)response.rows()[0][0]).get(0), is(Map.of(&quot;name&quot;, &quot;Trillian&quot;, &quot;is_nice&quot;, true)));
    }

    @Test
    public void testDropTable() throws Exception {
        execute(&quot;create table test (col1 integer primary key, col2 string)&quot;);

        assertThat(internalCluster().clusterService().state().metadata().hasIndex(&quot;test&quot;), is(true));

        execute(&quot;drop table test&quot;);
        assertThat(response.rowCount(), is(1L));

        assertThat(internalCluster().clusterService().state().metadata().hasIndex(&quot;test&quot;), is(false));
    }

    @Test
    public void testDropTableIfExistsRaceCondition() throws Exception {
        execute(&quot;create table test (name string)&quot;);
        execute(&quot;drop table test&quot;);
        // could fail if the meta data update triggered by the previous drop table wasn't fully propagated in the cluster
        execute(&quot;drop table if exists test&quot;);
    }

    @Test
    public void testDropUnknownTable() throws Exception {
        assertThrowsMatches(() -&gt; execute(&quot;drop table test&quot;),
                     isSQLError(is(&quot;Relation 'test' unknown&quot;), UNDEFINED_TABLE, NOT_FOUND, 4041));
    }

    @Test
    public void testDropTableIfExists() {
        execute(&quot;create table test (col1 integer primary key, col2 string)&quot;);

        assertThat(internalCluster().clusterService().state().metadata().hasIndex(&quot;test&quot;), is(true));
        execute(&quot;drop table if exists test&quot;);
        assertThat(response.rowCount(), is(1L));
        assertThat(internalCluster().clusterService().state().metadata().hasIndex(&quot;test&quot;), is(false));
    }

    @Test
    public void testDropIfExistsUnknownTable() throws Exception {
        execute(&quot;drop table if exists nonexistent&quot;);
        assertThat(response.rowCount(), is(0L));
    }

    @Test
    public void testCreateAlterAndDropBlobTable() throws Exception {
        execute(&quot;create blob table screenshots with (number_of_replicas=0)&quot;);
        execute(&quot;alter blob table screenshots set (number_of_replicas=1)&quot;);
        execute(&quot;select number_of_replicas from information_schema.tables &quot; +
                &quot;where table_schema = 'blob' and table_name = 'screenshots'&quot;);
        assertEquals(&quot;1&quot;, response.rows()[0][0]);
        execute(&quot;drop blob table screenshots&quot;);
    }

    @Test
    public void testDropIfExistsBlobTable() throws Exception {
        execute(&quot;create blob table screenshots with (number_of_replicas=0)&quot;);
        execute(&quot;drop blob table if exists screenshots&quot;);
        assertEquals(response.rowCount(), 1);
    }

    @Test
    public void testDropBlobTableIfExistsUnknownTable() throws Exception {
        execute(&quot;drop blob table if exists nonexistent&quot;);
        assertThat(response.rowCount(), is(0L));
    }

    @Test
    public void testAlterShardsOfPartitionedTableAffectsNewPartitions() {
        execute(
            &quot;create table quotes (&quot; +
            &quot;   id integer,&quot; +
            &quot;   quote string,&quot; +
            &quot;   date timestamp with time zone&quot; +
            &quot;) partitioned by(date) &quot; +
            &quot;clustered into 3 shards with (number_of_replicas='0-all')&quot;);
        ensureYellow();

        execute(&quot;insert into quotes (id, quote, date) values (?, ?, ?), (?, ?, ?)&quot;,
            new Object[]{
                1, &quot;Don't panic&quot;, 1395874800000L,
                2, &quot;Now panic&quot;, 1395961200000L}
        );
        execute(&quot;alter table quotes set (number_of_shards=5)&quot;);
<A NAME="2"></A>
        String templateName = PartitionName.templateName(Schemas.DOC_SCHEMA_NAME, &quot;quotes&quot;);
        GetIndexTemplatesResponse templatesResponse =
            <FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match510398-0.html#2',2,'match510398-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>client().admin().indices().prepareGetTemplates(templateName).execute().actionGet();
        Settings templateSettings = templatesResponse.getIndexTemplates().get(0).getSettings();
        assertThat(templateSettings.getAsInt(IndexMetadata.SETTING_NUMBER_OF_SHARDS, 0), is(5));

        execute</B></FONT>(&quot;insert into quotes (id, quote, date) values (?, ?, ?)&quot;,
            new Object[]{3, &quot;Time is a illusion. Lunchtime doubles so&quot;, 1495961200000L}
        );
        PartitionName partitionName = new PartitionName(
            new RelationName(&quot;doc&quot;, &quot;quotes&quot;), Arrays.asList(&quot;1495961200000&quot;));

        execute(&quot;select number_of_shards from information_schema.table_partitions where partition_ident = ? and table_name = ?&quot;,
            $(partitionName.ident(), partitionName.relationName().name()));
        assertThat(response.rows()[0][0], is(5));
    }

    @Test
    public void testAlterShardsTableCombinedWithOtherSettingsIsInvalid() {
        execute(
            &quot;create table quotes (&quot; +
            &quot;   id integer,&quot; +
            &quot;   quote string,&quot; +
            &quot;   date timestamp with time zone&quot; +
            &quot;) clustered into 3 shards with (number_of_replicas='0-all')&quot;);

        assertThrowsMatches(() -&gt; execute(&quot;alter table quotes set (number_of_shards=1, number_of_replicas='1-all')&quot;),
                     isSQLError(is(&quot;Setting [number_of_shards] cannot be combined with other settings&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4000));
    }

    @Test
    public void testAlterShardsPartitionCombinedWithOtherSettingsIsInvalid() {
        execute(
            &quot;create table quotes (&quot; +
            &quot;   id integer,&quot; +
            &quot;   quote string,&quot; +
            &quot;   date timestamp with time zone&quot; +
            &quot;) partitioned by(date) &quot; +
            &quot;clustered into 3 shards with (number_of_replicas='0-all')&quot;);

        execute(&quot;insert into quotes (id, quote, date) values (?, ?, ?), (?, ?, ?)&quot;,
            new Object[]{
                1, &quot;Don't panic&quot;, 1395874800000L,
                2, &quot;Now panic&quot;, 1395961200000L}
        );

        assertThrowsMatches(() -&gt; execute(&quot;alter table quotes partition (date=1395874800000) &quot; +
                                   &quot;set (number_of_shards=1, number_of_replicas='1-all')&quot;),
                     isSQLError(is(&quot;Setting [number_of_shards] cannot be combined with other settings&quot;),
                                INTERNAL_ERROR,
                                BAD_REQUEST,
                                4000));
    }

    @Test
    public void testCreateTableWithCustomSchema() throws Exception {
        execute(&quot;create table a.t (name string) with (number_of_replicas=0)&quot;);
        ensureYellow();

        execute(&quot;insert into a.t (name) values ('Ford')&quot;);
        assertThat(response.rowCount(), is(1L));
        refresh();

        execute(&quot;select name from a.t&quot;);
        assertThat(response.rowCount(), is(1L));
        assertThat((String) response.rows()[0][0], is(&quot;Ford&quot;));

        execute(&quot;select table_schema from information_schema.tables where table_name = 't'&quot;);
        assertThat(response.rowCount(), is(1L));
        assertThat((String) response.rows()[0][0], is(&quot;a&quot;));
    }

    @Test
    public void testCreateTableWithIllegalCustomSchemaCheckedByES() throws Exception {
        assertThrowsMatches(() -&gt; execute(&quot;create table \&quot;AAA\&quot;.t (name string) with (number_of_replicas=0)&quot;),
                     isSQLError(is(&quot;Relation name \&quot;AAA.t\&quot; is invalid.&quot;), INTERNAL_ERROR, BAD_REQUEST, 4002));

    }

    @Test
    public void testDropTableWithCustomSchema() throws Exception {
        execute(&quot;create table a.t (name string) with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;drop table a.t&quot;);
        assertThat(response.rowCount(), is(1L));

        execute(&quot;select table_schema from information_schema.tables where table_name = 't'&quot;);
        assertThat(response.rowCount(), is(0L));
    }

    @Test
    public void testCreateTableWithGeneratedColumn() throws Exception {
        execute(
            &quot;create table test (&quot; +
            &quot;   ts timestamp with time zone,&quot; +
            &quot;   day as date_trunc('day', ts)) with (number_of_replicas=0)&quot;);
        ensureYellow();
        String expectedMapping = &quot;{\&quot;default\&quot;:&quot; +
                                 &quot;{\&quot;dynamic\&quot;:\&quot;strict\&quot;,&quot; +
                                 &quot;\&quot;_meta\&quot;:{&quot; +
                                 &quot;\&quot;generated_columns\&quot;:{\&quot;day\&quot;:\&quot;date_trunc('day', ts)\&quot;}},&quot; +
                                 &quot;\&quot;properties\&quot;:{&quot; +
                                 &quot;\&quot;day\&quot;:{\&quot;type\&quot;:\&quot;date\&quot;,\&quot;position\&quot;:2,\&quot;format\&quot;:\&quot;epoch_millis||strict_date_optional_time\&quot;},&quot; +
                                 &quot;\&quot;ts\&quot;:{\&quot;type\&quot;:\&quot;date\&quot;,\&quot;position\&quot;:1,\&quot;format\&quot;:\&quot;epoch_millis||strict_date_optional_time\&quot;}&quot; +
                                 &quot;}}}&quot;;

        assertEquals(expectedMapping, getIndexMapping(&quot;test&quot;));
    }

    @Test
    public void testAddGeneratedColumnToTableWithExistingGeneratedColumns() throws Exception {
        execute(
            &quot;create table test (&quot; +
            &quot;   ts timestamp with time zone,&quot; +
            &quot;   day as date_trunc('day', ts)) with (number_of_replicas=0)&quot;);
        execute(&quot;alter table test add column added timestamp generated always as date_trunc('day', ts)&quot;);
        ensureYellow();
        String expectedMapping = &quot;{\&quot;default\&quot;:&quot; +
                                 &quot;{\&quot;dynamic\&quot;:\&quot;strict\&quot;,&quot; +
                                 &quot;\&quot;_meta\&quot;:{&quot; +
                                 &quot;\&quot;generated_columns\&quot;:{&quot; +
                                 &quot;\&quot;added\&quot;:\&quot;date_trunc('day', ts)\&quot;,&quot; +
                                 &quot;\&quot;day\&quot;:\&quot;date_trunc('day', ts)\&quot;}},&quot; +
                                 &quot;\&quot;properties\&quot;:{&quot; +
                                 &quot;\&quot;added\&quot;:{\&quot;type\&quot;:\&quot;date\&quot;,\&quot;position\&quot;:3,\&quot;format\&quot;:\&quot;epoch_millis||strict_date_optional_time\&quot;},&quot; +
                                 &quot;\&quot;day\&quot;:{\&quot;type\&quot;:\&quot;date\&quot;,\&quot;position\&quot;:2,\&quot;format\&quot;:\&quot;epoch_millis||strict_date_optional_time\&quot;},&quot; +
                                 &quot;\&quot;ts\&quot;:{\&quot;type\&quot;:\&quot;date\&quot;,\&quot;position\&quot;:1,\&quot;format\&quot;:\&quot;epoch_millis||strict_date_optional_time\&quot;}&quot; +
                                 &quot;}}}&quot;;

        assertEquals(expectedMapping, getIndexMapping(&quot;test&quot;));
    }


    @Test
    public void test_alter_table_cannot_add_broken_generated_column() throws Exception {
        execute(&quot;create table tbl (x int)&quot;);

        Asserts.assertThrowsMatches(
            () -&gt; execute(&quot;alter table tbl add column ts timestamp without time zone generated always as 'foobar'&quot;),
            SQLErrorMatcher.isSQLError(
                is(&quot;Cannot cast `'foobar'` of type `text` to type `timestamp without time zone`&quot;),
                PGErrorStatus.INTERNAL_ERROR,
                HttpResponseStatus.BAD_REQUEST,
                4000
            )
        );
    }

    @Test
    public void test_alter_table_add_column_keeps_existing_meta_information() throws Exception {
        execute(&quot;&quot;&quot;
            CREATE TABLE tbl (
                author TEXT NOT NULL,
                INDEX author_ft USING FULLTEXT (author) WITH (analyzer = 'standard')
            )
        &quot;&quot;&quot;);

        execute(&quot;ALTER TABLE tbl ADD COLUMN dummy text NOT NULL&quot;);

        execute(&quot;show create table tbl&quot;);
        assertThat((String) response.rows()[0][0], startsWith(&quot;&quot;&quot;
            CREATE TABLE IF NOT EXISTS &quot;doc&quot;.&quot;tbl&quot; (
               &quot;author&quot; TEXT NOT NULL,
               &quot;dummy&quot; TEXT NOT NULL,
               INDEX &quot;author_ft&quot; USING FULLTEXT (&quot;author&quot;) WITH (
                  analyzer = 'standard'
               )
            )
            &quot;&quot;&quot;.stripIndent()
        ));
    }
}
</PRE>
</div>
  </div>
</body>
</html>
