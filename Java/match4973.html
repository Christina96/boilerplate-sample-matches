<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for AbstractTransportTestCases.java &amp; ClientImplTest.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for AbstractTransportTestCases.java &amp; ClientImplTest.java
      </h3>
<h1 align="center">
        34.3%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>AbstractTransportTestCases.java (59.819122%)<th>ClientImplTest.java (24.139729%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(20-68)<td><a href="#" name="0">(21-69)</a><td align="center"><font color="#ff0000">45</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(298-321)<td><a href="#" name="1">(1122-1139)</a><td align="center"><font color="#770000">21</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(256-278)<td><a href="#" name="2">(938-955)</a><td align="center"><font color="#770000">21</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(335-358)<td><a href="#" name="3">(836-865)</a><td align="center"><font color="#710000">20</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(656-666)<td><a href="#" name="4">(870-882)</a><td align="center"><font color="#660000">18</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(609-619)<td><a href="#" name="5">(344-367)</a><td align="center"><font color="#660000">18</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(215-233)<td><a href="#" name="6">(1278-1303)</a><td align="center"><font color="#660000">18</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(669-678)<td><a href="#" name="7">(685-697)</a><td align="center"><font color="#600000">17</font>
<tr onclick='openModal("#c58917")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c58917"><font color="#c58917">-</font><td><a href="#" name="8">(577-590)<td><a href="#" name="8">(1101-1118)</a><td align="center"><font color="#600000">17</font>
<tr onclick='openModal("#83a33a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#83a33a"><font color="#83a33a">-</font><td><a href="#" name="9">(470-482)<td><a href="#" name="9">(918-934)</a><td align="center"><font color="#600000">17</font>
<tr onclick='openModal("#ad5910")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ad5910"><font color="#ad5910">-</font><td><a href="#" name="10">(233-243)<td><a href="#" name="10">(174-193)</a><td align="center"><font color="#600000">17</font>
<tr onclick='openModal("#b041ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#b041ff"><font color="#b041ff">-</font><td><a href="#" name="11">(440-450)<td><a href="#" name="11">(1619-1631)</a><td align="center"><font color="#4f0000">14</font>
<tr onclick='openModal("#571b7e")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#571b7e"><font color="#571b7e">-</font><td><a href="#" name="12">(404-414)<td><a href="#" name="12">(265-278)</a><td align="center"><font color="#4f0000">14</font>
<tr onclick='openModal("#3b9c9c")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3b9c9c"><font color="#3b9c9c">-</font><td><a href="#" name="13">(368-378)<td><a href="#" name="13">(217-230)</a><td align="center"><font color="#4f0000">14</font>
<tr onclick='openModal("#842dce")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#842dce"><font color="#842dce">-</font><td><a href="#" name="14">(279-288)<td><a href="#" name="14">(1833-1849)</a><td align="center"><font color="#4f0000">14</font>
<tr onclick='openModal("#f52887")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f52887"><font color="#f52887">-</font><td><a href="#" name="15">(642-654)<td><a href="#" name="15">(593-614)</a><td align="center"><font color="#490000">13</font>
<tr onclick='openModal("#2981b2")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#2981b2"><font color="#2981b2">-</font><td><a href="#" name="16">(621-627)<td><a href="#" name="16">(785-799)</a><td align="center"><font color="#490000">13</font>
<tr onclick='openModal("#3090c7")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3090c7"><font color="#3090c7">-</font><td><a href="#" name="17">(548-558)<td><a href="#" name="17">(1432-1442)</a><td align="center"><font color="#490000">13</font>
<tr onclick='openModal("#800517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#800517"><font color="#800517">-</font><td><a href="#" name="18">(512-522)<td><a href="#" name="18">(1365-1375)</a><td align="center"><font color="#490000">13</font>
<tr onclick='openModal("#f62817")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f62817"><font color="#f62817">-</font><td><a href="#" name="19">(629-637)<td><a href="#" name="19">(286-299)</a><td align="center"><font color="#440000">12</font>
<tr onclick='openModal("#4e9258")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4e9258"><font color="#4e9258">-</font><td><a href="#" name="20">(245-251)<td><a href="#" name="20">(706-721)</a><td align="center"><font color="#440000">12</font>
<tr onclick='openModal("#947010")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#947010"><font color="#947010">-</font><td><a href="#" name="21">(689-692)<td><a href="#" name="21">(1140-1152)</a><td align="center"><font color="#380000">10</font>
<tr onclick='openModal("#4cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4cc417"><font color="#4cc417">-</font><td><a href="#" name="22">(326-330)<td><a href="#" name="22">(367-372)</a><td align="center"><font color="#380000">10</font>
<tr onclick='openModal("#f660ab")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f660ab"><font color="#f660ab">-</font><td><a href="#" name="23">(289-293)<td><a href="#" name="23">(232-240)</a><td align="center"><font color="#380000">10</font>
<tr onclick='openModal("#79764d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#79764d"><font color="#79764d">-</font><td><a href="#" name="24">(681-686)<td><a href="#" name="24">(392-399)</a><td align="center"><font color="#330000">9</font>
<tr onclick='openModal("#5eac10")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#5eac10"><font color="#5eac10">-</font><td><a href="#" name="25">(488-501)<td><a href="#" name="25">(1316-1331)</a><td align="center"><font color="#330000">9</font>
<tr onclick='openModal("#68818b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#68818b"><font color="#68818b">-</font><td><a href="#" name="26">(452-465)<td><a href="#" name="26">(1258-1274)</a><td align="center"><font color="#330000">9</font>
<tr onclick='openModal("#e77471")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#e77471"><font color="#e77471">-</font><td><a href="#" name="27">(416-429)<td><a href="#" name="27">(806-823)</a><td align="center"><font color="#330000">9</font>
<tr onclick='openModal("#717d7d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#717d7d"><font color="#717d7d">-</font><td><a href="#" name="28">(397-404)<td><a href="#" name="28">(389-391)</a><td align="center"><font color="#330000">9</font>
<tr onclick='openModal("#af7a82")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#af7a82"><font color="#af7a82">-</font><td><a href="#" name="29">(380-393)<td><a href="#" name="29">(648-660)</a><td align="center"><font color="#330000">9</font>
<tr onclick='openModal("#ae694a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ae694a"><font color="#ae694a">-</font><td><a href="#" name="30">(362-368)<td><a href="#" name="30">(373-388)</a><td align="center"><font color="#330000">9</font>
<tr onclick='openModal("#3ea99f")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3ea99f"><font color="#3ea99f">-</font><td><a href="#" name="31">(198-206)<td><a href="#" name="31">(546-557)</a><td align="center"><font color="#330000">9</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>AbstractTransportTestCases.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>package com.allanbank.mongodb.client.transport;
2 import static com.allanbank.mongodb.bson.builder.BuilderFactory.d;
3 import static com.allanbank.mongodb.bson.builder.BuilderFactory.e;
4 import static java.util.concurrent.TimeUnit.MILLISECONDS;
5 import static java.util.concurrent.TimeUnit.SECONDS;
6 import static org.hamcrest.Matchers.hasSize;
7 import static org.hamcrest.Matchers.instanceOf;
8 import static org.hamcrest.Matchers.is;
9 import static org.junit.Assert.assertThat;
10 import java.io.ByteArrayOutputStream;
11 import java.io.IOException;
12 import java.net.InetSocketAddress;
13 import java.nio.ByteBuffer;
14 import java.nio.IntBuffer;
15 import java.util.Arrays;
16 import org.junit.After;
17 import org.junit.AfterClass;
18 import org.junit.Before;
19 import org.junit.BeforeClass;
20 import org.junit.Test;
21 import com.allanbank.mongodb.Durability;
22 import com.allanbank.mongodb.MongoClientConfiguration;
23 import com.allanbank.mongodb.ReadPreference;
24 import com.allanbank.mongodb.bson.Document;
25 import com.allanbank.mongodb.bson.io.BsonOutputStream;
26 import com.allanbank.mongodb.bson.io.EndianUtils;
27 import com.allanbank.mongodb.bson.io.StringDecoderCache;
28 import com.allanbank.mongodb.bson.io.StringEncoderCache;
29 import com.allanbank.mongodb.builder.Find;
30 import com.allanbank.mongodb.client.ClusterType;
31 import com.allanbank.mongodb.client.Message;
32 import com.allanbank.mongodb.client.MockSocketServer;
33 import com.allanbank.mongodb.client.Operation;
34 import com.allanbank.mongodb.client.message.Command;
35 import com.allanbank.mongodb.client.message.Delete;
36 import com.allanbank.mongodb.client.message.GetLastError;
37 import com.allanbank.mongodb.client.message.GetMore;
38 import com.allanbank.mongodb.client.message.Insert;
39 import com.allanbank.mongodb.client.message.KillCursors;
40 import com.allanbank.mongodb.client.message.Query;
41 import com.allanbank.mongodb.client.message.Reply;
42 import com.allanbank.mongodb.client.message.Update;
43 import com.allanbank.mongodb.client.state.Cluster;
44 import com.allanbank.mongodb.client.state.Server;
45 import</b></font> com.allanbank.mongodb.util.IOUtils;
46 public abstract class AbstractTransportTestCases {
47     protected static StringDecoderCache ourDecoderCache;
48     protected static StringEncoderCache ourEncoderCache;
49     protected static MockSocketServer ourMockServer;
50     private static final byte[] ourHelloWorld = new byte[] { 0x16, 0x00, 0x00,
51             0x00, 0x02, (byte) 'h', (byte) 'e', (byte) 'l', (byte) 'l',
52             (byte) 'o', 0x00, 0x06, 0x00, 0x00, 0x00, (byte) 'w', (byte) 'o',
53             (byte) 'r', (byte) 'l', (byte) 'd', 0x00, 0x00 };
54     @BeforeClass
55     public static void createCaches() {
56         ourEncoderCache = new StringEncoderCache();
57         ourDecoderCache = new StringDecoderCache();
58     }
59     @AfterClass
60     public static void destroyCaches() {
61         ourEncoderCache = null;
62         ourDecoderCache = null;
63     }
64     public static void fail(final String message, final Throwable cause) {
65         final AssertionError error = new AssertionError(message);
66         error.initCause(cause);
67         throw error;
68     }
69     @BeforeClass
70     public static void startMockServer() {
71         try {
72             ourMockServer = new MockSocketServer();
73             ourMockServer.start();
74         }
75         catch (final IOException error) {
76             fail("Could not start the mock MongoDB server: "
77                     + error.getMessage(), error);
78         }
79     }
80     @AfterClass
81     public static void stopMockServer() {
82         IOUtils.close(ourMockServer);
83         ourMockServer = null;
84     }
85     protected MongoClientConfiguration myConfig = null;
86     protected TestTransportResponseListener myListener = null;
87     protected Server myServer = null;
88     protected Transport&lt;TransportOutputBuffer&gt; myTestTransport = null;
89     @Before
90     public void setUp() {
91         final InetSocketAddress address = ourMockServer.getInetSocketAddress();
92         final Cluster cluster = new Cluster(myConfig, ClusterType.STAND_ALONE);
93         myConfig = new MongoClientConfiguration(address);
94         myServer = cluster.add(address);
95         myListener = new TestTransportResponseListener();
96     }
97     @After
98     public void tearDown() {
99         myConfig = null;
100         myServer = null;
101         IOUtils.close(myTestTransport);
102         assertThat(myListener.getCloses().size(), is(1));
103         myTestTransport = null;
104         myListener = null;
105         if (ourMockServer != null) {
106 <a name="31"></a>            ourMockServer.clear();
107             ourMockServer.waitForDisconnect(60000);
108         }
109     <font color="#3ea99f"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>}
110     @Test
111     public void testCanConnect() {
112         connect();
113         assertThat(ourMockServer.waitForClient(10, SECONDS), is</b></font>(true));
114     }
115 <a name="6"></a>    @Test
116     public void testHandleServerDisconnect() {
117         <font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>connect();
118         assertThat(ourMockServer.waitForClient(10, SECONDS), is(true));
119         ourMockServer.disconnectClient();
120         assertThat(ourMockServer.waitForDisconnect(10, SECONDS), is(true));
121         myListener.waitForClose(10, SECONDS);
122         assertThat(myListener.getCloses(), hasSize(1));
123     }
124     @Test
125     public void testHandleServerDisconnectAfterHeader() throws IOException {
126         final ByteBuffer byteBuff = <font color="#ad5910"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>ByteBuffer.allocate(9 * 4)</b></font>;
127         final IntBuffer buff = byteBuff.asIntBuffer();
128         buff.put(0, EndianUtils.swap((7 * 4) + 8 + ourHelloWorld.length));
129         buff.put(1, 0);
130         buff.put(2, EndianUtils.swap(1));
131         buff.put(3, EndianUtils.swap(Operation.REPLY.getCode()));
132         buff.put(4, 0);
133         buff.put(5, 0);
134         buff.put(6, 0);
135 <a name="20"></a>        buff.put(7, 0);
136         buff.put(8, EndianUtils.swap</b></font>(1));
137         final ByteArrayOutputStream out = <font color="#4e9258"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>new ByteArrayOutputStream();
138         out.write(byteBuff.array(), 0, byteBuff.array().length);
139         out.write(ourHelloWorld, 0, ourHelloWorld.length / 2);
140         ourMockServer.setReplies(Arrays.asList(out.toByteArray()));
141         connect();
142         assertThat(ourMockServer.waitForClient(10, SECONDS), is</b></font>(true));
143 <a name="2"></a>        final TransportOutputBuffer outBuffer = myTestTransport
144                 .createSendBuffer(0);
145         outBuffer.write(1, new GetLastError("db", Durability.ACK), null);
146         <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>myTestTransport.send(outBuffer);
147         myTestTransport.flush();
148         assertThat(ourMockServer.waitForRequest(1, 10, SECONDS), is(true));
149         myListener.waitForResponse(50, MILLISECONDS);
150         ourMockServer.disconnectClient();
151         assertThat(ourMockServer.waitForDisconnect(10, SECONDS), is(true));
152         myListener.waitForClose(10, SECONDS);
153         assertThat(myListener.getCloses(), hasSize(1));
154     }
155 <a name="14"></a>    @Test
156     public void testHandleServerDisconnectInHeader() throws IOException {
157         final ByteBuffer byteBuff = ByteBuffer.allocate</b></font>((9 * 4) - (2 * 4));
158         final IntBuffer buff = <font color="#842dce"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>byteBuff.asIntBuffer();
159         buff.put(0, EndianUtils.swap((7 * 4) + 8 + ourHelloWorld.length));
160         buff.put(1, 0);
161         buff.put(2, EndianUtils.swap(1));
162         buff.put(3, EndianUtils.swap(Operation.REPLY.getCode()));
163         buff.put(4, 0);
164         buff.put(5, 0);
165 <a name="23"></a>        buff.put(6, 0);
166         final ByteArrayOutputStream out = new</b></font> ByteArrayOutputStream();
167         <font color="#f660ab"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>out.write(byteBuff.array(), 0, byteBuff.array().length);
168         ourMockServer.setReplies(Arrays.asList(out.toByteArray()));
169         connect();
170         assertThat(ourMockServer.waitForClient(10, SECONDS), is</b></font>(true));
171 <a name="1"></a>        final TransportOutputBuffer outBuffer = myTestTransport
172                 .createSendBuffer(0);
173         outBuffer.write(1, new GetLastError("db", Durability.ACK), null);
174         <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>myTestTransport.send(outBuffer);
175         myTestTransport.flush();
176         assertThat(ourMockServer.waitForRequest(1, 10, SECONDS), is(true));
177         myListener.waitForResponse(50, MILLISECONDS);
178         ourMockServer.disconnectClient();
179         assertThat(ourMockServer.waitForDisconnect(10, SECONDS), is(true));
180         myListener.waitForClose(10, SECONDS);
181         assertThat(myListener.getCloses(), hasSize(1));
182     }
183     @Test
184     public void testHandleServerDisconnectInHeaderLength() throws IOException {
185         final ByteBuffer byteBuff = ByteBuffer.allocate</b></font>(4);
186         final IntBuffer buff = byteBuff.asIntBuffer();
187 <a name="22"></a>        buff.put(0, EndianUtils.swap((7 * 4) + 8 + ourHelloWorld.length));
188         final ByteArrayOutputStream out = new ByteArrayOutputStream();
189         <font color="#4cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>out.write(byteBuff.array(), 0, byteBuff.array().length - 1);
190         ourMockServer.setReplies(Arrays.asList(out.toByteArray()));
191         connect();
192         assertThat(ourMockServer.waitForClient(10, SECONDS), is</b></font>(true));
193 <a name="3"></a>        final TransportOutputBuffer outBuffer = myTestTransport
194                 .createSendBuffer(0);
195         outBuffer.write(1, new GetLastError("db", Durability.ACK), null);
196         <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>myTestTransport.send(outBuffer);
197         myTestTransport.flush();
198         assertThat(ourMockServer.waitForRequest(1, 10, SECONDS), is(true));
199         myListener.waitForResponse(50, MILLISECONDS);
200         ourMockServer.disconnectClient();
201         assertThat(ourMockServer.waitForDisconnect(10, SECONDS), is(true));
202         myListener.waitForClose(10, SECONDS);
203         assertThat(myListener.getCloses(), hasSize(1));
204     }
205     @Test
206     public void testSendAndReceiveCommand() throws IOException {
207         final int messageId = 100</b></font>;
208 <a name="30"></a>        final ByteArrayOutputStream out = new ByteArrayOutputStream();
209         final BsonOutputStream bsonOut = new BsonOutputStream(out);
210         final Message outMessage = new Command("db", "collection", <font color="#ae694a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>d().build());
211         outMessage.write(messageId, bsonOut);
212 <a name="13"></a>        ourMockServer.setReplies(Arrays.asList(out.toByteArray()));
213         connect();
214         assertThat(ourMockServer.waitForClient</b></font>(<font color="#3b9c9c"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>SECONDS.toMillis(5)), is(true));
215         final TransportOutputBuffer outBuffer = myTestTransport
216                 .createSendBuffer(0);
217         outBuffer.write(messageId, outMessage, null);
218         myTestTransport.send(outBuffer);
219         myTestTransport.flush();
220         assertThat(ourMockServer.waitForRequest(1, 10, SECONDS), is(true));
221 <a name="29"></a>        myListener.waitForResponse(10, SECONDS);
222         assertThat(myListener.getResponses(), hasSize</b></font>(1));
223         final TransportInputBuffer inBuffer = myListener.getResponses().get(0);
224         final Message inMessage = <font color="#af7a82"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>inBuffer.read();
225         assertThat(inMessage, instanceOf(Query.class));
226     }
227     @Test
228     public void testSendAndReceiveDelete() throws IOException {
229         final int messageId = 100</b></font>;
230 <a name="28"></a>        final ByteArrayOutputStream out = new ByteArrayOutputStream();
231         final BsonOutputStream bsonOut = new BsonOutputStream(out);
232         final Message outMessage = new Delete("db", "collection", <font color="#717d7d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>d().build(),
233                 false);
234         outMessage.write(messageId, bsonOut);
235 <a name="12"></a>        ourMockServer.setReplies(Arrays.asList(out.toByteArray()));
236         connect();
237         assertThat(ourMockServer.waitForClient</b></font>(<font color="#571b7e"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>SECONDS.toMillis(5)), is(true));
238         final TransportOutputBuffer outBuffer = myTestTransport
239                 .createSendBuffer(0);
240         outBuffer.write(messageId, outMessage, null);
241         myTestTransport.send(outBuffer);
242         myTestTransport.flush();
243         assertThat(ourMockServer.waitForRequest(1, 10, SECONDS), is(true));
244 <a name="27"></a>        myListener.waitForResponse(10, SECONDS);
245         assertThat(myListener.getResponses(), hasSize</b></font>(1));
246         final TransportInputBuffer inBuffer = myListener.getResponses().get(0);
247         final Message inMessage = <font color="#e77471"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>inBuffer.read();
248         assertThat(inMessage, is(outMessage));
249     }
250     @Test
251     public void testSendAndReceiveGetMore() throws IOException {
252         final int messageId = 100</b></font>;
253         final ByteArrayOutputStream out = new ByteArrayOutputStream();
254         final BsonOutputStream bsonOut = new BsonOutputStream(out);
255         final Message outMessage = new GetMore("db", "collection", 101L, 50,
256                 ReadPreference.PRIMARY);
257         outMessage.write(messageId, bsonOut);
258 <a name="11"></a>        ourMockServer.setReplies(Arrays.asList(out.toByteArray()));
259         connect();
260         assertThat(ourMockServer.waitForClient(<font color="#b041ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>SECONDS.toMillis(5)), is(true));
261         final TransportOutputBuffer outBuffer = myTestTransport
262                 .createSendBuffer(0);
263         outBuffer.write(messageId, outMessage, null);
264         myTestTransport.send(outBuffer);
265         myTestTransport.flush();
266         assertThat(ourMockServer.waitForRequest(1, 10, SECONDS), is(true));
267 <a name="26"></a>        myListener.waitForResponse(10, SECONDS);
268         assertThat(myListener.getResponses(), hasSize</b></font>(1));
269         final TransportInputBuffer inBuffer = myListener.getResponses().get(0);
270         final Message inMessage = <font color="#68818b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>inBuffer.read();
271         assertThat(inMessage, is(outMessage));
272     }
273     @Test
274     public void testSendAndReceiveInsert() throws IOException {
275         final int messageId = 100</b></font>;
276         final ByteArrayOutputStream out = new ByteArrayOutputStream();
277 <a name="9"></a>        final BsonOutputStream bsonOut = new BsonOutputStream(out);
278         final Message outMessage = new Insert("db", "collection",
279                 <font color="#83a33a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Arrays.asList(d().build()), false);
280         outMessage.write(messageId, bsonOut);
281         ourMockServer.setReplies(Arrays.asList(out.toByteArray()));
282         connect();
283         assertThat(ourMockServer.waitForClient(SECONDS.toMillis(5)), is(true));
284         final TransportOutputBuffer outBuffer = myTestTransport
285                 .createSendBuffer(0);
286         outBuffer.write(messageId, outMessage, null);
287         myTestTransport.send(outBuffer);
288         myTestTransport.flush</b></font>();
289         assertThat(ourMockServer.waitForRequest(1, 10, SECONDS), is(true));
290 <a name="25"></a>        myListener.waitForResponse(10, SECONDS);
291         assertThat(myListener.getResponses(), hasSize(1));
292         final TransportInputBuffer inBuffer = myListener.getResponses().get(0);
293         final Message inMessage = <font color="#5eac10"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>inBuffer.read();
294         assertThat(inMessage, is(outMessage));
295     }
296     @Test
297     public void testSendAndReceiveKillCursor() throws IOException {
298         final int messageId = 100</b></font>;
299         final ByteArrayOutputStream out = new ByteArrayOutputStream();
300         final BsonOutputStream bsonOut = new BsonOutputStream(out);
301         final Message outMessage = new KillCursors(new long[] { 1L },
302                 ReadPreference.PRIMARY);
303         outMessage.write(messageId, bsonOut);
304 <a name="18"></a>        ourMockServer.setReplies(Arrays.asList(out.toByteArray()));
305         connect();
306         assertThat(ourMockServer.waitForClient(SECONDS.toMillis(5)), <font color="#800517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>is(true));
307         final TransportOutputBuffer outBuffer = myTestTransport
308                 .createSendBuffer(0);
309         outBuffer.write(messageId, outMessage, null);
310         myTestTransport.send(outBuffer);
311         myTestTransport.flush();
312         assertThat(ourMockServer.waitForRequest(1, 10, SECONDS), is(true));
313         myListener.waitForResponse(10, SECONDS);
314         assertThat(myListener.getResponses(), hasSize</b></font>(1));
315         final TransportInputBuffer inBuffer = myListener.getResponses().get(0);
316         final Message inMessage = inBuffer.read();
317         assertThat(inMessage, is(outMessage));
318     }
319     @Test
320     public void testSendAndReceiveQuery() throws IOException {
321         final int messageId = 100;
322         final ByteArrayOutputStream out = new ByteArrayOutputStream();
323         final BsonOutputStream bsonOut = new BsonOutputStream(out);
324         final Message outMessage = new Query("db", "collection", Find.ALL,
325                 Find.ALL, 0, 0, 1, false, ReadPreference.PRIMARY, false, false,
326                 false, false);
327         outMessage.write(messageId, bsonOut);
328 <a name="17"></a>        ourMockServer.setReplies(Arrays.asList(out.toByteArray()));
329         connect();
330         assertThat(ourMockServer.waitForClient(SECONDS.toMillis(5)), <font color="#3090c7"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>is(true));
331         final TransportOutputBuffer outBuffer = myTestTransport
332                 .createSendBuffer(0);
333         outBuffer.write(messageId, outMessage, null);
334         myTestTransport.send(outBuffer);
335         myTestTransport.flush();
336         assertThat(ourMockServer.waitForRequest(1, 10, SECONDS), is(true));
337         myListener.waitForResponse(10, SECONDS);
338         assertThat(myListener.getResponses(), hasSize</b></font>(1));
339         final TransportInputBuffer inBuffer = myListener.getResponses().get(0);
340         final Message inMessage = inBuffer.read();
341         assertThat(inMessage, is(outMessage));
342     }
343     @Test
344     public void testSendAndReceiveUpdate() throws IOException {
345         final int messageId = 100;
346 <a name="8"></a>        final ByteArrayOutputStream out = new ByteArrayOutputStream();
347         final BsonOutputStream bsonOut = new BsonOutputStream(out);
348         final Message outMessage = new Update("db", "collection", <font color="#c58917"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>d().build(),
349                 d().build(), false, false);
350         outMessage.write(messageId, bsonOut);
351         ourMockServer.setReplies(Arrays.asList(out.toByteArray()));
352         connect();
353         assertThat(ourMockServer.waitForClient(SECONDS.toMillis(5)), is(true));
354         final TransportOutputBuffer outBuffer = myTestTransport
355                 .createSendBuffer(0);
356         outBuffer.write(messageId, outMessage, null);
357         myTestTransport.send(outBuffer);
358         myTestTransport.flush</b></font>();
359         assertThat(ourMockServer.waitForRequest(1, 10, SECONDS), is(true));
360         myListener.waitForResponse(10, SECONDS);
361         assertThat(myListener.getResponses(), hasSize(1));
362         final TransportInputBuffer inBuffer = myListener.getResponses().get(0);
363         final Message inMessage = inBuffer.read();
364         assertThat(inMessage, is(outMessage));
365     }
366 <a name="5"></a>    @Test
367     public void testSimpleSendAndReceive() throws IOException {
368         <font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>final ByteBuffer byteBuff = ByteBuffer.allocate(9 * 4);
369         final IntBuffer buff = byteBuff.asIntBuffer();
370         buff.put(0, EndianUtils.swap((7 * 4) + 8 + ourHelloWorld.length));
371         buff.put(1, 0);
372         buff.put(2, EndianUtils.swap(1));
373         buff.put(3, EndianUtils.swap(Operation.REPLY.getCode()));
374         buff.put(4, 0);
375         buff.put(5, 0);
376         buff.put(6, 0);
377 <a name="16"></a>        buff.put(7, 0);
378         buff.put(8, EndianUtils.swap</b></font>(1));
379         final ByteArrayOutputStream out = <font color="#2981b2"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>new ByteArrayOutputStream();
380         out.write(byteBuff.array(), 0, byteBuff.array().length);
381         out.write(ourHelloWorld, 0, ourHelloWorld.length);
382         ourMockServer.setReplies(Arrays.asList(out.toByteArray()));
383 <a name="19"></a>        connect();
384         assertThat(ourMockServer.waitForClient(SECONDS.toMillis(5)), is</b></font>(true));
385         final TransportOutputBuffer outBuffer = <font color="#f62817"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>myTestTransport
386                 .createSendBuffer(0);
387         outBuffer.write(1, new GetLastError("db", Durability.ACK), null);
388         myTestTransport.send(outBuffer);
389         myTestTransport.flush();
390         assertThat(ourMockServer.waitForRequest(1, 10, SECONDS), is(true));
391         myListener.waitForResponse(10, SECONDS);
392         assertThat(myListener.getResponses(), hasSize</b></font>(1));
393         final TransportInputBuffer inBuffer = myListener.getResponses().get(0);
394 <a name="15"></a>        final Message inMessage = inBuffer.read();
395         assertThat(inMessage, instanceOf(Reply.class));
396         assertThat(((Reply) inMessage).getResults(), hasSize(1));
397         <font color="#f52887"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>final Document reply = ((Reply) inMessage).getResults().get(0);
398         assertThat(reply, is(d(e("hello", "world")).build()));
399     }
400 <a name="4"></a>    @Test
401     public void testSimpleSendAndReceiveTwo() throws IOException {</b></font>
402         <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>final ByteBuffer byteBuff = ByteBuffer.allocate(9 * 4);
403         final IntBuffer buff = byteBuff.asIntBuffer();
404         buff.put(0, EndianUtils.swap((7 * 4) + 8 + ourHelloWorld.length));
405         buff.put(1, 0);
406         buff.put(2, EndianUtils.swap(1));
407         buff.put(3, EndianUtils.swap(Operation.REPLY.getCode()));
408         buff.put(4, 0);
409         buff.put(5, 0);
410         buff.put(6, 0);
411         buff.put(7, 0);
412 <a name="7"></a>        buff.put(8, EndianUtils.swap</b></font>(1));
413         final ByteArrayOutputStream out = new ByteArrayOutputStream();
414         <font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>out.write(byteBuff.array(), 0, byteBuff.array().length);
415         out.write(ourHelloWorld, 0, ourHelloWorld.length);
416         out.write(byteBuff.array(), 0, byteBuff.array().length);
417         out.write(ourHelloWorld, 0, ourHelloWorld.length);
418         ourMockServer.setReplies(Arrays.asList(out.toByteArray()));
419         connect();
420         assertThat(ourMockServer.waitForClient(SECONDS.toMillis(5)), is(true));
421 <a name="24"></a>        final TransportOutputBuffer outBuffer = myTestTransport</b></font>
422                 .createSendBuffer(0);
423         outBuffer.write(1, new GetLastError("db", Durability.ACK), null);
424         <font color="#79764d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>myTestTransport.send(outBuffer);
425         myTestTransport.flush();
426         assertThat(ourMockServer.waitForRequest(1, 10, SECONDS), is(true));
427         myListener.waitForResponses(2, 10, SECONDS);
428 <a name="21"></a>        assertThat(myListener.getResponses(), hasSize</b></font>(2));
429         for (final TransportInputBuffer inBuffer : myListener.getResponses()) {
430             final Message inMessage = inBuffer.read();
431             <font color="#947010"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(inMessage, instanceOf(Reply.class));
432             assertThat(((Reply) inMessage).getResults(), hasSize(1));
433             final Document reply = ((Reply) inMessage).getResults().get(0);
434             assertThat(reply, is</b></font>(d(e("hello", "world")).build()));
435         }
436     }
437     @SuppressWarnings("unchecked")
438     protected void connect() {
439         try {
440             final TransportFactory testFactory = createFactory();
441             myTestTransport = (Transport&lt;TransportOutputBuffer&gt;) testFactory
442                     .createTransport(myServer, myConfig, ourEncoderCache,
443                             ourDecoderCache, myListener);
444             myTestTransport.start();
445         }
446         catch (final IOException e) {
447             fail(e.getMessage(), e);
448         }
449     }
450     protected abstract TransportFactory createFactory();
451 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>ClientImplTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>package com.allanbank.mongodb.client;
2 import static com.allanbank.mongodb.client.connection.CallbackReply.reply;
3 import static org.easymock.EasyMock.anyObject;
4 import static org.easymock.EasyMock.capture;
5 import static org.easymock.EasyMock.createMock;
6 import static org.easymock.EasyMock.eq;
7 import static org.easymock.EasyMock.expect;
8 import static org.easymock.EasyMock.expectLastCall;
9 import static org.hamcrest.CoreMatchers.containsString;
10 import static org.hamcrest.CoreMatchers.instanceOf;
11 import static org.hamcrest.CoreMatchers.is;
12 import static org.junit.Assert.assertEquals;
13 import static org.junit.Assert.assertSame;
14 import static org.junit.Assert.assertThat;
15 import static org.junit.Assert.assertTrue;
16 import static org.junit.Assert.fail;
17 import java.beans.PropertyChangeEvent;
18 import java.beans.PropertyChangeListener;
19 import java.io.IOException;
20 import java.net.InetSocketAddress;
21 import java.util.Collections;
22 import java.util.List;
23 import java.util.concurrent.TimeUnit;
24 import org.easymock.Capture;
25 import org.easymock.EasyMock;
26 import org.junit.After;
27 import org.junit.AfterClass;
28 import org.junit.Before;
29 import org.junit.BeforeClass;
30 import org.junit.Test;
31 import com.allanbank.mongodb.Durability;
32 import com.allanbank.mongodb.MongoClientConfiguration;
33 import com.allanbank.mongodb.MongoCursorControl;
34 import com.allanbank.mongodb.MongoDbException;
35 import com.allanbank.mongodb.MongoIterator;
36 import com.allanbank.mongodb.ReadPreference;
37 import com.allanbank.mongodb.StreamCallback;
38 import com.allanbank.mongodb.bson.Document;
39 import com.allanbank.mongodb.bson.DocumentAssignable;
40 import com.allanbank.mongodb.bson.builder.BuilderFactory;
41 import com.allanbank.mongodb.bson.builder.DocumentBuilder;
42 import com.allanbank.mongodb.bson.impl.ImmutableDocument;
43 import com.allanbank.mongodb.client.callback.CursorStreamingCallback;
44 import com.allanbank.mongodb.client.callback.ReplyCallback;
45 import</b></font> com.allanbank.mongodb.client.connection.Connection;
46 import com.allanbank.mongodb.client.connection.MockMongoDBServer;
47 import com.allanbank.mongodb.client.connection.ReconnectStrategy;
48 import com.allanbank.mongodb.client.connection.proxy.ProxiedConnectionFactory;
49 import com.allanbank.mongodb.client.connection.socket.SocketConnectionFactory;
50 import com.allanbank.mongodb.client.message.Command;
51 import com.allanbank.mongodb.client.message.GetLastError;
52 import com.allanbank.mongodb.client.message.GetMore;
53 import com.allanbank.mongodb.client.message.IsMaster;
54 import com.allanbank.mongodb.client.message.Query;
55 import com.allanbank.mongodb.client.message.Update;
56 import com.allanbank.mongodb.client.state.Cluster;
57 import com.allanbank.mongodb.client.state.Server;
58 import com.allanbank.mongodb.client.state.ServerSelector;
59 import com.allanbank.mongodb.client.state.SimpleReconnectStrategy;
60 import com.allanbank.mongodb.error.CannotConnectException;
61 import com.allanbank.mongodb.error.ConnectionLostException;
62 import com.allanbank.mongodb.error.MongoClientClosedException;
63 import com.allanbank.mongodb.util.ServerNameUtils;
64 @SuppressWarnings("unchecked")
65 public class ClientImplTest {
66     private static MockMongoDBServer ourServer;
67     private static final Document PRIMARY_UPDATE = new ImmutableDocument(
68             BuilderFactory.start().add("ismaster", true));
69     @BeforeClass
70     public static void setUpBeforeClass() throws IOException {
71         ourServer = new MockMongoDBServer();
72         ourServer.start();
73     }
74     @AfterClass
75     public static void tearDownAfterClass() throws IOException {
76         ourServer.setRunning(false);
77         ourServer.close();
78         ourServer = null;
79     }
80     protected MongoClientConfiguration myConfig;
81     protected ClientImpl myTestInstance;
82     private ProxiedConnectionFactory myMockConnectionFactory;
83     @Before
84     public void setUp() {
85         myMockConnectionFactory = EasyMock
86                 .createMock(ProxiedConnectionFactory.class);
87         myConfig = new MongoClientConfiguration();
88         myTestInstance = new ClientImpl(myConfig, myMockConnectionFactory);
89         reset(myMockConnectionFactory);
90     }
91     @After
92     public void tearDown() {
93         myMockConnectionFactory = null;
94         myConfig = null;
95         myTestInstance = null;
96         ourServer.clear();
97     }
98     @SuppressWarnings("boxing")
99     @Test
100 <a name="10"></a>    public void testClose() throws IOException {
101         final Command message = new Command("testDb",
102                 Command.COMMAND_COLLECTION, <font color="#ad5910"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>BuilderFactory.start().build());
103         final Connection mockConnection = createMock(Connection.class);
104         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
105         mockConnection
106                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
107         expectLastCall();
108         mockConnection.send(message, null);
109         expectLastCall();
110         mockConnection.shutdown(false);
111         expectLastCall();
112         mockConnection.waitForClosed(myConfig.getReadTimeout(),
113                 TimeUnit.MILLISECONDS);
114         expectLastCall();
115         expect(mockConnection.isOpen()).andReturn</b></font>(false);
116         myMockConnectionFactory.close();
117         expectLastCall();
118         replay(mockConnection);
119         myTestInstance.send(message, null);
120         myTestInstance.close();
121         verify(mockConnection);
122     }
123     @SuppressWarnings("boxing")
124     @Test
125 <a name="13"></a>    public void testCloseFails() throws IOException {
126         final Command message = new Command("testDb",
127                 Command.COMMAND_COLLECTION, <font color="#3b9c9c"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>BuilderFactory.start().build());
128         final Connection mockConnection = createMock(Connection.class);
129         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
130         mockConnection
131                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
132         expectLastCall();
133         mockConnection.send(message, null);
134         expectLastCall();
135 <a name="23"></a>        mockConnection.shutdown(false);
136         expectLastCall</b></font>();
137         <font color="#f660ab"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>mockConnection.waitForClosed(myConfig.getReadTimeout(),
138                 TimeUnit.MILLISECONDS);
139         expectLastCall();
140         expect(mockConnection.isOpen()).andReturn(true);
141         mockConnection.close();
142         expectLastCall();
143         mockConnection
144                 .removePropertyChangeListener(anyObject</b></font>(PropertyChangeListener.class));
145         expectLastCall();
146         myMockConnectionFactory.close();
147         expectLastCall();
148         replay(mockConnection);
149         myTestInstance.send(message, null);
150         myTestInstance.close();
151         verify(mockConnection);
152     }
153     @SuppressWarnings("boxing")
154     @Test
155 <a name="12"></a>    public void testCloseOnThrownIoException() throws IOException {
156         final Command message = new Command("testDb",
157                 Command.COMMAND_COLLECTION, <font color="#571b7e"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>BuilderFactory.start().build());
158         final Connection mockConnection = createMock(Connection.class);
159         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
160         mockConnection
161                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
162         expectLastCall();
163         mockConnection.send(message, null);
164         expectLastCall();
165         mockConnection.shutdown(false);
166         expectLastCall</b></font>();
167         mockConnection.waitForClosed(myConfig.getReadTimeout(),
168                 TimeUnit.MILLISECONDS);
169         expectLastCall();
170 <a name="19"></a>
171         expect(mockConnection.isOpen()).andReturn(true);
172         mockConnection.close();
173         <font color="#f62817"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>expectLastCall().andThrow(new IOException("This is a test."));
174         mockConnection
175                 .removePropertyChangeListener(anyObject(PropertyChangeListener.class));
176         expectLastCall();
177         myMockConnectionFactory.close();
178         expectLastCall();
179         replay(mockConnection);
180         myTestInstance.send(message, null);
181         myTestInstance.close();
182         verify</b></font>(mockConnection);
183     }
184     @Test
185     public void testCloseThenThrows() throws IOException {
186         final Command message = new Command("testDb",
187                 Command.COMMAND_COLLECTION, BuilderFactory.start().build());
188         myTestInstance.close();
189         try {
190             myTestInstance.send(message, null);
191             fail("Should have thrown a MongoClientClosedException.");
192         }
193         catch (final MongoClientClosedException mcce) {
194         }
195     }
196     @SuppressWarnings("boxing")
197     @Test
198     public void testCreatesConnectionOnScannedPending() throws IOException {
199         final Message message = new Command("db", Command.COMMAND_COLLECTION,
200                 BuilderFactory.start().build());
201         myConfig.setMaxConnectionCount(7);
202         final Connection mockConnection1 = createMock(Connection.class);
203         final Connection mockConnection2 = createMock(Connection.class);
204 <a name="5"></a>        final Connection mockConnection3 = createMock(Connection.class);
205         final Connection mockConnection4 = createMock(Connection.class);
206         final Connection mockConnection5 = createMock(Connection.class);
207         <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>final Connection mockConnection6 = createMock(Connection.class);
208         final Connection mockConnection7 = createMock(Connection.class);
209         expect(myMockConnectionFactory.connect()).andReturn(mockConnection1);
210         mockConnection1
211                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
212         expectLastCall();
213         mockConnection1.send(message, null);
214         expectLastCall();
215         replay(mockConnection1, mockConnection2, mockConnection3,
216                 mockConnection4, mockConnection5, mockConnection6,
217                 mockConnection7);
218         myTestInstance.send(message, null);
219         verify(mockConnection1, mockConnection2, mockConnection3,
220                 mockConnection4, mockConnection5, mockConnection6,
221                 mockConnection7);
222         reset(mockConnection1, mockConnection2, mockConnection3,
223                 mockConnection4, mockConnection5, mockConnection6,
224 <a name="22"></a>                mockConnection7);
225         expect</b></font>(<font color="#4cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>mockConnection1.isAvailable()).andReturn(true);
226         expect(mockConnection1.getPendingCount()).andReturn(1);
227         expect(myMockConnectionFactory.connect()).andReturn(mockConnection2);
228 <a name="30"></a>        mockConnection2
229                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
230         expectLastCall</b></font>();
231         <font color="#ae694a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>mockConnection2.send(message, null);
232         expectLastCall();
233         replay(mockConnection1, mockConnection2, mockConnection3,
234                 mockConnection4, mockConnection5, mockConnection6,
235                 mockConnection7);
236         myTestInstance.send(message, null);
237         verify(mockConnection1, mockConnection2, mockConnection3,
238                 mockConnection4, mockConnection5, mockConnection6,
239                 mockConnection7);
240         reset(mockConnection1, mockConnection2, mockConnection3,
241                 mockConnection4, mockConnection5, mockConnection6,
242                 mockConnection7);
243 <a name="28"></a>
244         expect(mockConnection1.isAvailable</b></font>()).andReturn(true);
245 <a name="24"></a>        <font color="#717d7d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>expect(mockConnection1.getPendingCount()).andReturn(1);
246         expect(mockConnection2.isAvailable()).andReturn(true);
247         expect(mockConnection2.getPendingCount</b></font>()).andReturn(1);
248         <font color="#79764d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>expect(myMockConnectionFactory.connect()).andReturn(mockConnection3);
249         mockConnection3
250                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
251         expectLastCall();
252         mockConnection3.send(message, null);
253         expectLastCall();
254         replay</b></font>(mockConnection1, mockConnection2, mockConnection3,
255                 mockConnection4, mockConnection5, mockConnection6,
256                 mockConnection7);
257         myTestInstance.send(message, null);
258         verify(mockConnection1, mockConnection2, mockConnection3,
259                 mockConnection4, mockConnection5, mockConnection6,
260                 mockConnection7);
261         reset(mockConnection1, mockConnection2, mockConnection3,
262                 mockConnection4, mockConnection5, mockConnection6,
263                 mockConnection7);
264         expect(mockConnection1.isAvailable()).andReturn(true);
265         expect(mockConnection1.getPendingCount()).andReturn(1);
266         expect(mockConnection2.isAvailable()).andReturn(true);
267         expect(mockConnection2.getPendingCount()).andReturn(1);
268         expect(myMockConnectionFactory.connect()).andReturn(mockConnection4);
269         mockConnection4
270                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
271         expectLastCall();
272         mockConnection4.send(message, null);
273         expectLastCall();
274         replay(mockConnection1, mockConnection2, mockConnection3,
275                 mockConnection4, mockConnection5, mockConnection6,
276                 mockConnection7);
277         myTestInstance.send(message, null);
278         verify(mockConnection1, mockConnection2, mockConnection3,
279                 mockConnection4, mockConnection5, mockConnection6,
280                 mockConnection7);
281         reset(mockConnection1, mockConnection2, mockConnection3,
282                 mockConnection4, mockConnection5, mockConnection6,
283                 mockConnection7);
284         expect(mockConnection1.isAvailable()).andReturn(true);
285         expect(mockConnection1.getPendingCount()).andReturn(1);
286         expect(mockConnection2.isAvailable()).andReturn(true);
287         expect(mockConnection2.getPendingCount()).andReturn(1);
288         expect(myMockConnectionFactory.connect()).andReturn(mockConnection5);
289         mockConnection5
290                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
291         expectLastCall();
292         mockConnection5.send(message, null);
293         expectLastCall();
294         replay(mockConnection1, mockConnection2, mockConnection3,
295                 mockConnection4, mockConnection5, mockConnection6,
296                 mockConnection7);
297         myTestInstance.send(message, null);
298         verify(mockConnection1, mockConnection2, mockConnection3,
299                 mockConnection4, mockConnection5, mockConnection6,
300                 mockConnection7);
301         reset(mockConnection1, mockConnection2, mockConnection3,
302                 mockConnection4, mockConnection5, mockConnection6,
303                 mockConnection7);
304         expect(mockConnection1.isAvailable()).andReturn(true);
305         expect(mockConnection1.getPendingCount()).andReturn(1);
306         expect(mockConnection2.isAvailable()).andReturn(true);
307         expect(mockConnection2.getPendingCount()).andReturn(1);
308         expect(myMockConnectionFactory.connect()).andReturn(mockConnection6);
309         mockConnection6
310                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
311         expectLastCall();
312         mockConnection6.send(message, null);
313         expectLastCall();
314         replay(mockConnection1, mockConnection2, mockConnection3,
315                 mockConnection4, mockConnection5, mockConnection6,
316                 mockConnection7);
317         myTestInstance.send(message, null);
318         verify(mockConnection1, mockConnection2, mockConnection3,
319                 mockConnection4, mockConnection5, mockConnection6,
320                 mockConnection7);
321         reset(mockConnection1, mockConnection2, mockConnection3,
322                 mockConnection4, mockConnection5, mockConnection6,
323                 mockConnection7);
324         expect(mockConnection1.isAvailable()).andReturn(true);
325         expect(mockConnection1.getPendingCount()).andReturn(1);
326         expect(mockConnection2.isAvailable()).andReturn(true);
327         expect(mockConnection2.getPendingCount()).andReturn(1);
328         expect(myMockConnectionFactory.connect()).andReturn(mockConnection7);
329         mockConnection7
330                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
331         expectLastCall();
332         mockConnection7.send(message, null);
333         expectLastCall();
334         replay(mockConnection1, mockConnection2, mockConnection3,
335                 mockConnection4, mockConnection5, mockConnection6,
336                 mockConnection7);
337         myTestInstance.send(message, null);
338         verify(mockConnection1, mockConnection2, mockConnection3,
339                 mockConnection4, mockConnection5, mockConnection6,
340                 mockConnection7);
341         reset(mockConnection1, mockConnection2, mockConnection3,
342                 mockConnection4, mockConnection5, mockConnection6,
343                 mockConnection7);
344         expect(mockConnection1.isAvailable()).andReturn(true);
345         expect(mockConnection1.getPendingCount()).andReturn(1);
346         expect(mockConnection2.isAvailable()).andReturn(true);
347         expect(mockConnection2.getPendingCount()).andReturn(1);
348         expect(mockConnection1.isAvailable()).andReturn(true);
349         expect(mockConnection1.getPendingCount()).andReturn(3);
350         expect(mockConnection2.isAvailable()).andReturn(true);
351         expect(mockConnection2.getPendingCount()).andReturn(1);
352         mockConnection2.send(message, null);
353         expectLastCall();
354         replay(mockConnection1, mockConnection2, mockConnection3,
355                 mockConnection4, mockConnection5, mockConnection6,
356                 mockConnection7);
357         myTestInstance.send(message, null);
358         verify(mockConnection1, mockConnection2, mockConnection3,
359                 mockConnection4, mockConnection5, mockConnection6,
360                 mockConnection7);
361         reset(mockConnection1, mockConnection2, mockConnection3,
362                 mockConnection4, mockConnection5, mockConnection6,
363                 mockConnection7);
364         expect(mockConnection2.isAvailable()).andReturn(true);
365         expect(mockConnection2.getPendingCount()).andReturn(1);
366         expect(mockConnection3.isAvailable()).andReturn(true);
367         expect(mockConnection3.getPendingCount()).andReturn(1);
368         expect(mockConnection2.isAvailable()).andReturn(true);
369         expect(mockConnection2.getPendingCount()).andReturn(1);
370         expect(mockConnection3.isAvailable()).andReturn(true);
371         expect(mockConnection3.getPendingCount()).andReturn(3);
372         mockConnection2.send(message, null);
373         expectLastCall();
374         replay(mockConnection1, mockConnection2, mockConnection3,
375                 mockConnection4, mockConnection5, mockConnection6,
376                 mockConnection7);
377         myTestInstance.send(message, null);
378 <a name="31"></a>        verify(mockConnection1, mockConnection2, mockConnection3,
379                 mockConnection4, mockConnection5, mockConnection6,
380                 mockConnection7);
381     <font color="#3ea99f"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>}
382     @Test
383     public void testGetClusterType() {
384         expect(myMockConnectionFactory.getClusterType()).andReturn(
385                 ClusterType.STAND_ALONE);
386         replay</b></font>();
387         assertEquals(ClusterType.STAND_ALONE, myTestInstance.getClusterType());
388         verify();
389     }
390     @Test
391     public void testGetConfig() {
392         assertSame(myConfig, myTestInstance.getConfig());
393     }
394     @Test
395     public void testGetDefaultDurability() {
396         assertSame(myConfig.getDefaultDurability(),
397                 myTestInstance.getDefaultDurability());
398         myConfig.setDefaultDurability(Durability.journalDurable(1000));
399         assertSame(myConfig.getDefaultDurability(),
400                 myTestInstance.getDefaultDurability());
401     }
402 <a name="15"></a>    @Test
403     public void testHandleConnectionClosedForUnknownConnection()
404             throws IOException {
405         <font color="#f52887"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>final Connection mockConnection = createMock(Connection.class);
406         mockConnection
407                 .removePropertyChangeListener(anyObject(PropertyChangeListener.class));
408         expectLastCall();
409         replay(mockConnection);
410         myTestInstance.handleConnectionClosed(mockConnection);
411         verify(mockConnection);
412     }
413     @Test
414     public void testInvalidPrpertyChange() throws IOException {</b></font>
415         final Message message = new Command("db", Command.COMMAND_COLLECTION,
416                 BuilderFactory.start().build());
417         final Capture&lt;PropertyChangeListener&gt; propListenerCapture = new Capture&lt;PropertyChangeListener&gt;();
418         final Connection mockConnection = createMock(Connection.class);
419         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
420         mockConnection.addPropertyChangeListener(capture(propListenerCapture));
421         expectLastCall();
422         mockConnection.send(message, null);
423         expectLastCall();
424         replay(mockConnection);
425         myTestInstance.send(message, null);
426         propListenerCapture.getValue().propertyChange(
427                 new PropertyChangeEvent(mockConnection,
428                         Connection.OPEN_PROP_NAME + "g", Boolean.TRUE,
429                         Boolean.FALSE));
430         propListenerCapture.getValue()
431                 .propertyChange(
432                         new PropertyChangeEvent(mockConnection,
433                                 Connection.OPEN_PROP_NAME, Boolean.FALSE,
434                                 Boolean.TRUE));
435         propListenerCapture.getValue().propertyChange(
436                 new PropertyChangeEvent(mockConnection,
437                         Connection.OPEN_PROP_NAME, Boolean.TRUE, Integer
438 <a name="29"></a>                                .valueOf(1)));
439         <font color="#af7a82"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(1, myTestInstance.getConnectionCount());
440         verify(mockConnection);
441     }
442     @Test
443     public void testReconnect() {
444         final String serverName = ourServer.getInetSocketAddress()</b></font>
445                 .getHostName()
446                 + ":"
447                 + ourServer.getInetSocketAddress().getPort();
448         ourServer.setReplies(
449                 reply(BuilderFactory.start(PRIMARY_UPDATE).addString("_id",
450                         serverName), BuilderFactory.start(PRIMARY_UPDATE)
451                         .addString("_id", "localhost:1234")),
452                 reply(BuilderFactory.start(PRIMARY_UPDATE).addString("_id",
453                         serverName), BuilderFactory.start(PRIMARY_UPDATE)
454                         .addString("_id", "localhost:1234")),
455                 reply(BuilderFactory.start(PRIMARY_UPDATE).addString("_id",
456                         serverName), BuilderFactory.start(PRIMARY_UPDATE)
457                         .addString("_id", "localhost:1234")),
458                 reply(BuilderFactory.start(PRIMARY_UPDATE).addString("_id",
459                         serverName), BuilderFactory.start(PRIMARY_UPDATE)
460                         .addString("_id", "localhost:1234")),
461                 reply(BuilderFactory.start(PRIMARY_UPDATE).addString("_id",
462                         serverName), BuilderFactory.start(PRIMARY_UPDATE)
463                         .addString("_id", "localhost:1234")),
464                 reply(BuilderFactory.start(PRIMARY_UPDATE).addString("_id",
465 <a name="7"></a>                        serverName), BuilderFactory.start(PRIMARY_UPDATE)
466                         .addString("_id", "localhost:1234")),
467                 reply(BuilderFactory.start(PRIMARY_UPDATE).addString("_id",
468                         serverName), <font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>BuilderFactory.start(PRIMARY_UPDATE)
469                         .addString("_id", "localhost:1234")),
470                 reply(BuilderFactory.start(PRIMARY_UPDATE).addString("_id",
471                         serverName), BuilderFactory.start(PRIMARY_UPDATE)
472                         .addString("_id", "localhost:1234")),
473                 reply(BuilderFactory.start(PRIMARY_UPDATE).addString("_id",
474                         serverName), BuilderFactory.start(PRIMARY_UPDATE)
475                         .addString("_id", "localhost:1234")),
476                 reply(BuilderFactory.start(PRIMARY_UPDATE).addString("_id",
477                         serverName), BuilderFactory.start(PRIMARY_UPDATE)
478                         .addString("_id", "localhost:1234")));
479         final GetLastError message = new GetLastError("testDb", Durability.ACK)</b></font>;
480         final MongoClientConfiguration config = new MongoClientConfiguration(
481                 "mongodb://"
482                         + ServerNameUtils.normalize(ourServer
483                                 .getInetSocketAddress()));
484         config.setAutoDiscoverServers(false);
485 <a name="20"></a>
486         try {
487             myTestInstance = new ClientImpl(config,
488                     <font color="#4e9258"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>new SocketConnectionFactory(config));
489             myTestInstance.send(message, null);
490             ourServer.waitForRequest(2, 10000);
491             ourServer.disconnectClient();
492             assertTrue(ourServer.waitForDisconnect(10000));
493             assertTrue(ourServer.waitForClient(10000));
494             ourServer.waitForRequest(2, 10000); 
495             Thread.sleep(50);
496             myTestInstance.send(message, null);
497             ourServer.waitForRequest</b></font>(3, 10000);
498         }
499         catch (final InterruptedException e) {
500         }
501         finally {
502             myTestInstance.close();
503         }
504     }
505     @Test
506     public void testReconnectFails() throws IOException {
507         final Message message = new Command("db", Command.COMMAND_COLLECTION,
508                 BuilderFactory.start().build());
509         final Cluster cluster = new Cluster(myConfig, ClusterType.STAND_ALONE);
510         final Server server = cluster.add(new InetSocketAddress("localhost",
511                 27017));
512         final Capture&lt;PropertyChangeListener&gt; propListenerCapture = new Capture&lt;PropertyChangeListener&gt;();
513         final Connection mockConnection = createMock(Connection.class);
514         final Connection mockConnection2 = createMock(Connection.class);
515         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
516         mockConnection.addPropertyChangeListener(capture(propListenerCapture));
517         expectLastCall();
518         mockConnection.send(message, null);
519         expectLastCall();
520         final SimpleReconnectStrategy strategy = new SimpleReconnectStrategy();
521         strategy.setConfig(myConfig);
522         strategy.setSelector(new ServerSelector() {
523             @Override
524             public List&lt;Server&gt; pickServers() {
525                 return Collections.singletonList(server);
526             }
527         });
528         strategy.setConnectionFactory(myMockConnectionFactory);
529         strategy.setState(cluster);
530         expect(mockConnection.isShuttingDown()).andReturn(false);
531         expect(myMockConnectionFactory.getReconnectStrategy()).andReturn(
532                 strategy);
533         expect(mockConnection.getServer()).andReturn(server);
534         expect(myMockConnectionFactory.connect(server, myConfig)).andThrow(
535                 new IOException("Injected"));
536         expect(myMockConnectionFactory.connect(server, myConfig)).andReturn(
537                 mockConnection2);
538 <a name="16"></a>                mockConnection2
539                 .send(eq(new IsMaster()), anyObject(ReplyCallback.class));
540         expectLastCall().andThrow(<font color="#2981b2"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>new MongoDbException("synthetic ping error"));
541         mockConnection2.close();
542         expectLastCall();
543         mockConnection.raiseErrors(anyObject(MongoDbException.class));
544         expectLastCall();
545         mockConnection
546                 .removePropertyChangeListener(anyObject(PropertyChangeListener.class));
547         expectLastCall();
548         replay(mockConnection, mockConnection2);
549         myTestInstance.send(message, null);
550         propListenerCapture.getValue</b></font>()
551                 .propertyChange(
552                         new PropertyChangeEvent(mockConnection,
553                                 Connection.OPEN_PROP_NAME, Boolean.TRUE,
554 <a name="27"></a>                                Boolean.FALSE));
555         <font color="#e77471"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(0, myTestInstance.getConnectionCount());
556         verify(mockConnection, mockConnection2);
557     }
558     @Test
559     public void testReconnectOnShutdownConnection() throws IOException,
560             InterruptedException {
561         final Message message = new Command("db", Command.COMMAND_COLLECTION,</b></font>
562                 BuilderFactory.start().build());
563         myConfig.setMaxConnectionCount(1);
564         final Connection mockConnection = createMock(Connection.class);
565         final ReconnectStrategy mockStrategy = createMock(ReconnectStrategy.class);
566         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
567         mockConnection
568 <a name="3"></a>                .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
569         expectLastCall();
570         mockConnection.send(message, null);
571         <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>expectLastCall();
572         expect(mockConnection.isShuttingDown()).andReturn(true);
573         mockConnection
574                 .removePropertyChangeListener(anyObject(PropertyChangeListener.class));
575         expectLastCall();
576         mockConnection.raiseErrors(anyObject(MongoDbException.class));
577         expectLastCall();
578         replay(mockConnection, mockStrategy);
579         myTestInstance.send(message, null);
580         myTestInstance.handleConnectionClosed(mockConnection);
581         verify(mockConnection, mockStrategy);
582     }
583     @Test
584     public void testReconnectThatFails() throws IOException,
585             InterruptedException {
586         final Message message = new Command("db", Command.COMMAND_COLLECTION,</b></font>
587                 BuilderFactory.start().build());
588 <a name="4"></a>
589         myConfig.setMaxConnectionCount(1);
590         <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>final Connection mockConnection = createMock(Connection.class);
591         final ReconnectStrategy mockStrategy = createMock(ReconnectStrategy.class);
592         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
593         mockConnection
594                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
595         expectLastCall();
596         mockConnection.send(message, null);
597         expectLastCall();
598         expect(mockConnection.isShuttingDown()).andReturn(false);
599         expect(myMockConnectionFactory.getReconnectStrategy</b></font>()).andReturn(
600                 mockStrategy);
601         expect(mockStrategy.reconnect(mockConnection)).andReturn(null);
602         mockConnection
603                 .removePropertyChangeListener(anyObject(PropertyChangeListener.class));
604         expectLastCall();
605         mockConnection.raiseErrors(anyObject(MongoDbException.class));
606         expectLastCall();
607         replay(mockConnection, mockStrategy);
608         myTestInstance.send(message, null);
609         myTestInstance.handleConnectionClosed(mockConnection);
610         verify(mockConnection, mockStrategy);
611     }
612     @SuppressWarnings("boxing")
613     @Test
614     public void testRestartDocumentAssignable() throws IOException {
615         final DocumentBuilder b = BuilderFactory.start();
616         b.add(MongoCursorControl.NAME_SPACE_FIELD, "a.b");
617         b.add(MongoCursorControl.CURSOR_ID_FIELD, 123456);
618         b.add(MongoCursorControl.SERVER_FIELD, "server");
619         b.add(MongoCursorControl.LIMIT_FIELD, 4321);
620         b.add(MongoCursorControl.BATCH_SIZE_FIELD, 23);
621 <a name="9"></a>
622         final GetMore message = new GetMore("a", "b", 123456, 23,
623                 ReadPreference.server("server"));
624         final Connection mockConnection = <font color="#83a33a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>createMock(Connection.class);
625         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
626         mockConnection
627                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
628         expectLastCall();
629         mockConnection.send(eq(message), anyObject(ReplyCallback.class));
630         expectLastCall();
631         replay(mockConnection);
632         final MongoIterator&lt;Document&gt; iter = myTestInstance.restart(b);
633         verify(mockConnection);
634         assertThat(iter, instanceOf</b></font>(MongoIteratorImpl.class));
635 <a name="2"></a>        final MongoIteratorImpl iterImpl = (MongoIteratorImpl) iter;
636         assertThat(iterImpl.getBatchSize(), is(23));
637         assertThat(iterImpl.getLimit(), is(4321));
638         assertThat(iterImpl.getCursorId(), <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>is(123456L));
639         assertThat(iterImpl.getDatabaseName(), is("a"));
640         assertThat(iterImpl.getCollectionName(), is("b"));
641         assertThat(iterImpl.getClient(), is((Client) myTestInstance));
642         assertThat(iterImpl.getReadPerference(),
643                 is(ReadPreference.server("server")));
644     }
645     @Test
646     public void testRestartDocumentAssignableNonCursorDoc() throws IOException {
647         final DocumentBuilder b = BuilderFactory.start</b></font>();
648         b.add(MongoCursorControl.NAME_SPACE_FIELD, "a.b");
649         b.add(MongoCursorControl.CURSOR_ID_FIELD, 123456);
650         b.add(MongoCursorControl.SERVER_FIELD, "server");
651         b.add(MongoCursorControl.LIMIT_FIELD, 4321);
652         b.add(MongoCursorControl.BATCH_SIZE_FIELD, 23);
653         replay();
654         b.remove(MongoCursorControl.BATCH_SIZE_FIELD);
655         b.add("c", 1);
656         try {
657             myTestInstance.restart(b);
658         }
659         catch (final IllegalArgumentException good) {         }
660         b.remove("c");
661         b.add(MongoCursorControl.BATCH_SIZE_FIELD, 23);
662         b.remove(MongoCursorControl.LIMIT_FIELD);
663         b.add("c", 1);
664         try {
665             myTestInstance.restart(b);
666         }
667         catch (final IllegalArgumentException good) {         }
668         b.remove("c");
669         b.add(MongoCursorControl.LIMIT_FIELD, 23);
670         b.remove(MongoCursorControl.SERVER_FIELD);
671         b.add("c", 1);
672         try {
673             myTestInstance.restart(b);
674         }
675         catch (final IllegalArgumentException good) {         }
676         b.remove("c");
677         b.add(MongoCursorControl.SERVER_FIELD, "server");
678         b.remove(MongoCursorControl.CURSOR_ID_FIELD);
679         b.add("c", 1);
680         try {
681             myTestInstance.restart(b);
682         }
683         catch (final IllegalArgumentException good) {         }
684         b.remove("c");
685         b.add(MongoCursorControl.CURSOR_ID_FIELD, 23);
686         b.remove(MongoCursorControl.NAME_SPACE_FIELD);
687         b.add("c", 1);
688         try {
689             myTestInstance.restart(b);
690         }
691         catch (final IllegalArgumentException good) {         }
692         b.remove("c");
693         b.add(MongoCursorControl.NAME_SPACE_FIELD, "a.b");
694         b.remove(MongoCursorControl.BATCH_SIZE_FIELD);
695         try {
696             myTestInstance.restart(b);
697         }
698         catch (final IllegalArgumentException good) {         }
699         b.add(MongoCursorControl.BATCH_SIZE_FIELD, 23);
700         b.remove(MongoCursorControl.BATCH_SIZE_FIELD);
701         b.add(MongoCursorControl.BATCH_SIZE_FIELD, "s");
702         try {
703             myTestInstance.restart(b);
704         }
705         catch (final IllegalArgumentException good) {         }
706         b.remove(MongoCursorControl.BATCH_SIZE_FIELD);
707         b.add(MongoCursorControl.BATCH_SIZE_FIELD, 23);
708         b.remove(MongoCursorControl.LIMIT_FIELD);
709         b.add(MongoCursorControl.LIMIT_FIELD, "s");
710         try {
711             myTestInstance.restart(b);
712         }
713         catch (final IllegalArgumentException good) {         }
714         b.remove(MongoCursorControl.LIMIT_FIELD);
715         b.add(MongoCursorControl.LIMIT_FIELD, 23);
716         b.remove(MongoCursorControl.SERVER_FIELD);
717         b.add(MongoCursorControl.SERVER_FIELD, 1);
718         try {
719             myTestInstance.restart(b);
720         }
721         catch (final IllegalArgumentException good) {         }
722         b.remove(MongoCursorControl.SERVER_FIELD);
723         b.add(MongoCursorControl.SERVER_FIELD, "server");
724         b.remove(MongoCursorControl.CURSOR_ID_FIELD);
725         b.add(MongoCursorControl.CURSOR_ID_FIELD, "s");
726         try {
727             myTestInstance.restart(b);
728         }
729         catch (final IllegalArgumentException good) {         }
730         b.remove(MongoCursorControl.CURSOR_ID_FIELD);
731         b.add(MongoCursorControl.CURSOR_ID_FIELD, 23);
732         b.remove(MongoCursorControl.NAME_SPACE_FIELD);
733         b.add(MongoCursorControl.NAME_SPACE_FIELD, 1);
734         try {
735             myTestInstance.restart(b);
736         }
737         catch (final IllegalArgumentException good) {         }
738         b.remove(MongoCursorControl.NAME_SPACE_FIELD);
739         b.add(MongoCursorControl.NAME_SPACE_FIELD, "a.b");
740         verify();
741     }
742     @SuppressWarnings("boxing")
743     @Test
744     public void testRestartStreamCallbackDocumentAssignable()
745             throws IOException {
746         final DocumentBuilder b = BuilderFactory.start();
747         b.add(MongoCursorControl.NAME_SPACE_FIELD, "a.b");
748         b.add(MongoCursorControl.CURSOR_ID_FIELD, 123456);
749         b.add(MongoCursorControl.SERVER_FIELD, "server");
750         b.add(MongoCursorControl.LIMIT_FIELD, 4321);
751         b.add(MongoCursorControl.BATCH_SIZE_FIELD, 23);
752 <a name="8"></a>        final GetMore message = new GetMore("a", "b", 123456, 23,
753                 ReadPreference.server("server"));
754         final StreamCallback&lt;Document&gt; mockStreamCallback = createMock(StreamCallback.class);
755         final Connection mockConnection = <font color="#c58917"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>createMock(Connection.class);
756         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
757         mockConnection
758                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
759         expectLastCall();
760         mockConnection.send(eq(message), anyObject(ReplyCallback.class));
761         expectLastCall();
762         replay(mockConnection, mockStreamCallback);
763         final MongoCursorControl iter = myTestInstance.restart(
764                 mockStreamCallback, b);
765         verify(mockConnection, mockStreamCallback);
766         assertThat(iter, instanceOf</b></font>(CursorStreamingCallback.class));
767 <a name="1"></a>        final CursorStreamingCallback iterImpl = (CursorStreamingCallback) iter;
768         assertThat(iterImpl.getBatchSize(), is(23));
769         assertThat(iterImpl.getLimit(), is(4321));
770         assertThat(<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>iterImpl.getCursorId(), is(123456L));
771         assertThat(iterImpl.getDatabaseName(), is("a"));
772         assertThat(iterImpl.getCollectionName(), is("b"));
773         assertThat(iterImpl.getClient(), is((Client) myTestInstance));
774         assertThat(iterImpl.getAddress(), is("server"));
775     }
776     @Test
777     public void testRestartStreamCallbackDocumentAssignableNonCursorDoc()
778 <a name="21"></a>            throws IOException {
779         final DocumentBuilder b = BuilderFactory.start</b></font>();
780         <font color="#947010"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>b.add(MongoCursorControl.NAME_SPACE_FIELD, "a.b");
781         b.add(MongoCursorControl.CURSOR_ID_FIELD, 123456);
782         b.add(MongoCursorControl.SERVER_FIELD, "server");
783         b.add(MongoCursorControl.LIMIT_FIELD, 4321);
784         b.add(MongoCursorControl.BATCH_SIZE_FIELD, 23);
785         final StreamCallback&lt;Document&gt; mockStreamCallback = createMock(StreamCallback.class);
786         replay(mockStreamCallback);
787         b.remove(MongoCursorControl.BATCH_SIZE_FIELD);
788         b.add</b></font>("c", 1);
789         try {
790             myTestInstance.restart(mockStreamCallback, b);
791         }
792         catch (final IllegalArgumentException good) {         }
793         b.remove("c");
794         b.add(MongoCursorControl.BATCH_SIZE_FIELD, 23);
795         b.remove(MongoCursorControl.LIMIT_FIELD);
796         b.add("c", 1);
797         try {
798             myTestInstance.restart(mockStreamCallback, b);
799         }
800         catch (final IllegalArgumentException good) {         }
801         b.remove("c");
802         b.add(MongoCursorControl.LIMIT_FIELD, 23);
803         b.remove(MongoCursorControl.SERVER_FIELD);
804         b.add("c", 1);
805         try {
806             myTestInstance.restart(mockStreamCallback, b);
807         }
808         catch (final IllegalArgumentException good) {         }
809         b.remove("c");
810         b.add(MongoCursorControl.SERVER_FIELD, "server");
811         b.remove(MongoCursorControl.CURSOR_ID_FIELD);
812         b.add("c", 1);
813         try {
814             myTestInstance.restart(mockStreamCallback, b);
815         }
816         catch (final IllegalArgumentException good) {         }
817         b.remove("c");
818         b.add(MongoCursorControl.CURSOR_ID_FIELD, 23);
819         b.remove(MongoCursorControl.NAME_SPACE_FIELD);
820         b.add("c", 1);
821         try {
822             myTestInstance.restart(mockStreamCallback, b);
823         }
824         catch (final IllegalArgumentException good) {         }
825         b.remove("c");
826         b.add(MongoCursorControl.NAME_SPACE_FIELD, "a.b");
827         b.remove(MongoCursorControl.BATCH_SIZE_FIELD);
828         try {
829             myTestInstance.restart(mockStreamCallback, b);
830         }
831         catch (final IllegalArgumentException good) {         }
832         b.add(MongoCursorControl.BATCH_SIZE_FIELD, 23);
833         b.remove(MongoCursorControl.BATCH_SIZE_FIELD);
834         b.add(MongoCursorControl.BATCH_SIZE_FIELD, "s");
835         try {
836             myTestInstance.restart(mockStreamCallback, b);
837         }
838         catch (final IllegalArgumentException good) {         }
839         b.remove(MongoCursorControl.BATCH_SIZE_FIELD);
840         b.add(MongoCursorControl.BATCH_SIZE_FIELD, 23);
841         b.remove(MongoCursorControl.LIMIT_FIELD);
842         b.add(MongoCursorControl.LIMIT_FIELD, "s");
843         try {
844             myTestInstance.restart(mockStreamCallback, b);
845         }
846         catch (final IllegalArgumentException good) {         }
847         b.remove(MongoCursorControl.LIMIT_FIELD);
848         b.add(MongoCursorControl.LIMIT_FIELD, 23);
849         b.remove(MongoCursorControl.SERVER_FIELD);
850         b.add(MongoCursorControl.SERVER_FIELD, 1);
851         try {
852             myTestInstance.restart(mockStreamCallback, b);
853         }
854         catch (final IllegalArgumentException good) {         }
855         b.remove(MongoCursorControl.SERVER_FIELD);
856         b.add(MongoCursorControl.SERVER_FIELD, "server");
857         b.remove(MongoCursorControl.CURSOR_ID_FIELD);
858         b.add(MongoCursorControl.CURSOR_ID_FIELD, "s");
859         try {
860             myTestInstance.restart(mockStreamCallback, b);
861         }
862         catch (final IllegalArgumentException good) {         }
863         b.remove(MongoCursorControl.CURSOR_ID_FIELD);
864         b.add(MongoCursorControl.CURSOR_ID_FIELD, 23);
865         b.remove(MongoCursorControl.NAME_SPACE_FIELD);
866         b.add(MongoCursorControl.NAME_SPACE_FIELD, 1);
867         try {
868             myTestInstance.restart(mockStreamCallback, b);
869 <a name="26"></a>        }
870         catch (final IllegalArgumentException good) {         }
871         <font color="#68818b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>b.remove(MongoCursorControl.NAME_SPACE_FIELD);
872         b.add(MongoCursorControl.NAME_SPACE_FIELD, "a.b");
873         verify(mockStreamCallback);
874     }
875     @Test
876     public void testSendGetMoreCallbackOfReply() throws IOException {
877         final ReplyCallback callback = createMock(ReplyCallback.class)</b></font>;
878 <a name="6"></a>        final GetMore message = new GetMore("testDb", "collection", 1234L,
879                 12345, ReadPreference.PRIMARY);
880         final Connection mockConnection = <font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>createMock(Connection.class);
881         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
882         mockConnection
883                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
884         expectLastCall();
885         mockConnection.send(message, callback);
886         expectLastCall();
887         replay(mockConnection);
888         myTestInstance.send(message, callback);
889         verify(mockConnection);
890     }
891     @Test
892     public void testSendMessage() throws IOException {
893         final Update message = new Update("testDb", "collection", null, null,</b></font>
894                 false, false);
895         final Connection mockConnection = createMock(Connection.class);
896         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
897         mockConnection
898                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
899         expectLastCall();
900 <a name="25"></a>        mockConnection.send(message, null);
901         expectLastCall();
902         <font color="#5eac10"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>replay(mockConnection);
903         myTestInstance.send(message, null);
904         verify(mockConnection);
905     }
906     @Test
907     public void testSendMessageAndCreateConnectionFailes() throws IOException {
908         final Update message = new Update("testDb", "collection", null, null,</b></font>
909                 false, false);
910         final Connection mockConnection = createMock(Connection.class);
911         expect(myMockConnectionFactory.connect()).andThrow(new IOException());
912         replay(mockConnection);
913         try {
914             myTestInstance.send(message, null);
915             fail("Should have thrown a MongoDbException.");
916         }
917         catch (final MongoDbException good) {
918         }
919         verify(mockConnection);
920     }
921     @SuppressWarnings("boxing")
922     @Test
923     public void testSendMessageClosesFirstWhenMaxShrinks() throws IOException {
924         final Message message = new Command("db", Command.COMMAND_COLLECTION,
925                 BuilderFactory.start().build());
926 <a name="18"></a>
927         myConfig.setMaxConnectionCount(2);
928         final Connection mockConnection = <font color="#800517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>createMock(Connection.class);
929         final Connection mockConnection2 = createMock(Connection.class);
930         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
931         mockConnection
932                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
933         expectLastCall();
934         mockConnection.send(message, null);
935         expectLastCall();
936         expect</b></font>(mockConnection.isAvailable()).andReturn(true);
937         expect(mockConnection.getPendingCount()).andReturn(1);
938         expect(myMockConnectionFactory.connect()).andReturn(mockConnection2);
939         mockConnection2
940                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
941         expectLastCall();
942         mockConnection2.send(message, null);
943         expectLastCall();
944         mockConnection.shutdown(false);
945         expectLastCall();
946         expect(mockConnection2.isAvailable()).andReturn(true);
947         expect(mockConnection2.getPendingCount()).andReturn(1);
948         expect(mockConnection2.isAvailable()).andReturn(true);
949         mockConnection2.send(message, null);
950         expectLastCall();
951         expect(mockConnection2.isAvailable()).andReturn(true);
952         expect(mockConnection2.getPendingCount()).andReturn(1);
953         expect(mockConnection2.isAvailable()).andReturn(true);
954         mockConnection2.send(message, null);
955         expectLastCall();
956         mockConnection
957                 .removePropertyChangeListener(anyObject(PropertyChangeListener.class));
958         expectLastCall();
959         replay(mockConnection, mockConnection2);
960         myConfig.setMaxConnectionCount(2);
961         myTestInstance.send(message, null);
962         myTestInstance.send(message, null);
963         myConfig.setMaxConnectionCount(1);
964         myTestInstance.send(message, null);
965         myTestInstance.send(message, null);
966         myTestInstance.handleConnectionClosed(mockConnection);
967         verify(mockConnection, mockConnection2);
968     }
969     @SuppressWarnings("boxing")
970     @Test
971     public void testSendMessageClosesFirstWhenMaxShrinksAndCloseFails()
972             throws IOException {
973         final Message message = new Command("db", Command.COMMAND_COLLECTION,
974                 BuilderFactory.start().build());
975 <a name="17"></a>
976         myConfig.setMaxConnectionCount(2);
977         final Connection mockConnection = <font color="#3090c7"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>createMock(Connection.class);
978         final Connection mockConnection2 = createMock(Connection.class);
979         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
980         mockConnection
981                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
982         expectLastCall();
983         mockConnection.send(message, null);
984         expectLastCall();
985         expect</b></font>(mockConnection.isAvailable()).andReturn(true);
986         expect(mockConnection.getPendingCount()).andReturn(1);
987         expect(myMockConnectionFactory.connect()).andReturn(mockConnection2);
988         mockConnection2
989                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
990         expectLastCall();
991         mockConnection2.send(message, null);
992         expectLastCall();
993         mockConnection.shutdown(false);
994         expectLastCall();
995         expect(mockConnection2.isAvailable()).andReturn(true);
996         expect(mockConnection2.getPendingCount()).andReturn(0);
997         mockConnection2.send(message, null);
998         expectLastCall();
999         expect(mockConnection2.isAvailable()).andReturn(true);
1000         expect(mockConnection2.getPendingCount()).andReturn(1);
1001         expect(mockConnection2.isAvailable()).andReturn(true);
1002         mockConnection2.send(message, null);
1003         expectLastCall();
1004         replay(mockConnection, mockConnection2);
1005         myConfig.setMaxConnectionCount(2);
1006         myTestInstance.send(message, null);
1007         myTestInstance.send(message, null);
1008         myConfig.setMaxConnectionCount(1);
1009         myTestInstance.send(message, null);
1010         myTestInstance.send(message, null);
1011         verify(mockConnection, mockConnection2);
1012     }
1013     @SuppressWarnings("boxing")
1014     @Test
1015     public void testSendMessageCreatesSecondConnectionOnPending()
1016             throws IOException {
1017         final Message message = new Command("db", Command.COMMAND_COLLECTION,
1018                 BuilderFactory.start().build());
1019         myConfig.setMaxConnectionCount(2);
1020         final Connection mockConnection = createMock(Connection.class);
1021         final Connection mockConnection2 = createMock(Connection.class);
1022         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
1023         mockConnection
1024                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
1025         expectLastCall();
1026         mockConnection.send(message, null);
1027         expectLastCall();
1028         expect(mockConnection.isAvailable()).andReturn(true);
1029         expect(mockConnection.getPendingCount()).andReturn(1);
1030         expect(myMockConnectionFactory.connect()).andReturn(mockConnection2);
1031         mockConnection2
1032                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
1033         expectLastCall();
1034         mockConnection2.send(message, null);
1035         expectLastCall();
1036         replay(mockConnection, mockConnection2);
1037         myTestInstance.send(message, null);
1038         myTestInstance.send(message, null);
1039         verify(mockConnection, mockConnection2);
1040     }
1041     @SuppressWarnings("boxing")
1042     @Test
1043     public void testSendMessageFailsWhenAllAreClosed() throws IOException {
1044         final Message message = new Command("db", Command.COMMAND_COLLECTION,
1045                 BuilderFactory.start().build());
1046         myConfig.setMaxConnectionCount(2);
1047         final Connection mockConnection = createMock(Connection.class);
1048         final Connection mockConnection2 = createMock(Connection.class);
1049         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
1050         mockConnection
1051                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
1052         expectLastCall();
1053         mockConnection.send(message, null);
1054         expectLastCall();
1055         expect(mockConnection.isAvailable()).andReturn(true);
1056         expect(mockConnection.getPendingCount()).andReturn(1);
1057         expect(myMockConnectionFactory.connect()).andReturn(mockConnection2);
1058         mockConnection2
1059                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
1060         expectLastCall();
1061         mockConnection2.send(message, null);
1062         expectLastCall();
1063         expect(mockConnection.isAvailable()).andReturn(true);
1064         expect(mockConnection.getPendingCount()).andReturn(2);
1065         expect(mockConnection2.isAvailable()).andReturn(true);
1066         expect(mockConnection2.getPendingCount()).andReturn(1);
1067         expect(mockConnection.isAvailable()).andReturn(false);
1068         expect(mockConnection2.isAvailable()).andReturn(false);
1069         replay(mockConnection, mockConnection2);
1070         myTestInstance.send(message, null);
1071         myTestInstance.send(message, null);
1072         try {
1073             myTestInstance.send(message, null);
1074             fail("Should have failed.");
1075         }
1076         catch (final CannotConnectException failure) {
1077             assertThat(
1078                     failure.getMessage(),
1079                     containsString("Could not create a connection to the server."));
1080         }
1081         verify(mockConnection, mockConnection2);
1082     }
1083     @Test
1084     public void testSendMessageGetLastErrorCallbackOfReply() throws IOException {
1085         final Message message = new Update("testDb", "collection", null, null,
1086                 false, false);
1087         final GetLastError lastError = new GetLastError("testDb", false, false,
1088                 0, 0);
1089         final ReplyCallback callback = createMock(ReplyCallback.class);
1090         final Connection mockConnection = createMock(Connection.class);
1091         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
1092         mockConnection
1093                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
1094         expectLastCall();
1095         mockConnection.send(message, lastError, callback);
1096         expectLastCall();
1097         replay(mockConnection);
1098         myTestInstance.send(message, lastError, callback);
1099         verify(mockConnection);
1100     }
1101     @SuppressWarnings("boxing")
1102 <a name="11"></a>    @Test
1103     public void testSendMessagePicksIdleExisting() throws IOException {
1104         final Message message = new Command("db", Command.COMMAND_COLLECTION,
1105                 <font color="#b041ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>BuilderFactory.start().build());
1106         final Connection mockConnection = createMock(Connection.class);
1107         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
1108         mockConnection
1109                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
1110         expectLastCall();
1111         mockConnection.send(message, null);
1112         expectLastCall();
1113         expect</b></font>(mockConnection.isAvailable()).andReturn(true);
1114         expect(mockConnection.getPendingCount()).andReturn(0);
1115         mockConnection.send(message, null);
1116         expectLastCall();
1117         replay(mockConnection);
1118         myTestInstance.send(message, null);
1119         myTestInstance.send(message, null);
1120         verify(mockConnection);
1121     }
1122     @SuppressWarnings("boxing")
1123     @Test
1124     public void testSendMessagePicksMostIdleWhenAllPending() throws IOException {
1125         final Message message = new Command("db", Command.COMMAND_COLLECTION,
1126                 BuilderFactory.start().build());
1127         myConfig.setMaxConnectionCount(2);
1128         final Connection mockConnection = createMock(Connection.class);
1129         final Connection mockConnection2 = createMock(Connection.class);
1130         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
1131         mockConnection
1132                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
1133         expectLastCall();
1134         mockConnection.send(message, null);
1135         expectLastCall();
1136         expect(mockConnection.isAvailable()).andReturn(true);
1137         expect(mockConnection.getPendingCount()).andReturn(1);
1138         expect(myMockConnectionFactory.connect()).andReturn(mockConnection2);
1139         mockConnection2
1140                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
1141         expectLastCall();
1142         mockConnection2.send(message, null);
1143         expectLastCall();
1144         expect(mockConnection.isAvailable()).andReturn(true);
1145         expect(mockConnection.getPendingCount()).andReturn(2);
1146         expect(mockConnection2.isAvailable()).andReturn(true);
1147         expect(mockConnection2.getPendingCount()).andReturn(1);
1148         expect(mockConnection.isAvailable()).andReturn(true);
1149         expect(mockConnection.getPendingCount()).andReturn(2);
1150         expect(mockConnection2.isAvailable()).andReturn(true);
1151         expect(mockConnection2.getPendingCount()).andReturn(1);
1152         mockConnection2.send(message, null);
1153         expectLastCall();
1154         replay(mockConnection, mockConnection2);
1155         myTestInstance.send(message, null);
1156         myTestInstance.send(message, null);
1157         myTestInstance.send(message, null);
1158         verify(mockConnection, mockConnection2);
1159     }
1160     @SuppressWarnings("boxing")
1161     @Test
1162     public void testSendMessageWaitsForReconnect() throws IOException,
1163             InterruptedException {
1164         final Message message = new Command("db", Command.COMMAND_COLLECTION,
1165                 BuilderFactory.start().build());
1166         myConfig.setMaxConnectionCount(1);
1167         final Connection mockConnection = createMock(Connection.class);
1168         final Connection mockConnection2 = createMock(Connection.class);
1169         makeThreadSafe(mockConnection, mockConnection2);
1170         final ReconnectStrategy pauseStrategy = new SimpleReconnectStrategy() {
1171             @Override
1172             public Connection reconnect(final Connection oldConnection) {
1173                 try {
1174                     Thread.sleep(500);
1175                 }
1176                 catch (final InterruptedException e) {
1177                 }
1178                 return mockConnection2;
1179             }
1180         };
1181         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
1182         mockConnection
1183                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
1184         expectLastCall();
1185         mockConnection.send(message, null);
1186         expectLastCall();
1187         expect(mockConnection.isShuttingDown()).andReturn(false);
1188         expect(myMockConnectionFactory.getReconnectStrategy()).andReturn(
1189                 pauseStrategy);
1190         mockConnection
1191                 .removePropertyChangeListener(anyObject(PropertyChangeListener.class));
1192         expectLastCall();
1193         mockConnection2
1194                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
1195         expectLastCall();
1196         mockConnection.raiseErrors(anyObject(ConnectionLostException.class));
1197         expectLastCall();
1198         expect(mockConnection.isAvailable()).andReturn(false).times(2);
1199         expect(mockConnection2.isAvailable()).andReturn(true);
1200         expect(mockConnection2.getPendingCount()).andReturn(0);
1201         mockConnection2.send(message, null);
1202         expectLastCall();
1203         replay(mockConnection, mockConnection2);
1204         myTestInstance.send(message, null);
1205         new Thread(new Runnable() {
1206             @Override
1207             public void run() {
1208                 myTestInstance.handleConnectionClosed(mockConnection);
1209             }
1210         }).start();
1211         Thread.sleep(100);
1212         myTestInstance.send(message, null);
1213         verify(mockConnection, mockConnection2);
1214     }
1215     @SuppressWarnings("boxing")
1216     @Test
1217     public void testSendMessageWaitsForReconnectTimesOut() throws IOException,
1218             InterruptedException {
1219         myConfig.setReconnectTimeout(250);
1220         final Message message = new Command("db", Command.COMMAND_COLLECTION,
1221                 BuilderFactory.start().build());
1222         myConfig.setMaxConnectionCount(1);
1223         final Connection mockConnection = createMock(Connection.class);
1224         final Connection mockConnection2 = createMock(Connection.class);
1225         makeThreadSafe(mockConnection, mockConnection2);
1226         final ReconnectStrategy pauseStrategy = new SimpleReconnectStrategy() {
1227             @Override
1228             public Connection reconnect(final Connection oldConnection) {
1229                 try {
1230                     Thread.sleep(500);
1231                 }
1232                 catch (final InterruptedException e) {
1233                 }
1234                 return mockConnection2;
1235             }
1236         };
1237         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
1238         mockConnection
1239                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
1240         expectLastCall();
1241         mockConnection.send(message, null);
1242         expectLastCall();
1243         mockConnection
1244                 .removePropertyChangeListener(anyObject(PropertyChangeListener.class));
1245         expectLastCall();
1246         mockConnection.raiseErrors(anyObject(MongoDbException.class));
1247 <a name="14"></a>        expectLastCall();
1248         expect(mockConnection.isShuttingDown()).andReturn(false);
1249         <font color="#842dce"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>expect(myMockConnectionFactory.getReconnectStrategy()).andReturn(
1250                 pauseStrategy);
1251         mockConnection2
1252                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
1253         expectLastCall();
1254         expect(mockConnection.isAvailable()).andReturn(false).times(2, 4);
1255         replay(mockConnection, mockConnection2);
1256         myTestInstance.send(message, null);
1257         final Thread t = new</b></font> Thread(new Runnable() {
1258             @Override
1259             public void run() {
1260                 myTestInstance.handleConnectionClosed(mockConnection);
1261             }
1262         });
1263         t.start();
1264         Thread.sleep(100);
1265         try {
1266             myTestInstance.send(message, null);
1267         }
1268         catch (final CannotConnectException failure) {
1269             assertThat(
1270                     failure.getMessage(),
1271                     containsString("Could not create a connection to the server."));
1272         }
1273         t.join();
1274         verify(mockConnection, mockConnection2);
1275     }
1276     @Test
1277     public void testSendQueryCallbackOfReply() throws IOException {
1278         final Query message = new Query("db", "coll", null, null, 0, 0, 0,
1279                 false, ReadPreference.PRIMARY, false, false, false, false);
1280         final ReplyCallback callback = createMock(ReplyCallback.class);
1281         final Connection mockConnection = createMock(Connection.class);
1282         expect(myMockConnectionFactory.connect()).andReturn(mockConnection);
1283         mockConnection
1284                 .addPropertyChangeListener(anyObject(PropertyChangeListener.class));
1285         expectLastCall();
1286         mockConnection.send(message, callback);
1287         expectLastCall();
1288         replay(mockConnection);
1289         myTestInstance.send(message, callback);
1290         verify(mockConnection);
1291     }
1292     private void makeThreadSafe(final Object... mocks) {
1293         for (final Object mock : mocks) {
1294             EasyMock.makeThreadSafe(mock, true);
1295         }
1296         EasyMock.makeThreadSafe(myMockConnectionFactory, true);
1297     }
1298     private void replay(final Object... mocks) {
1299         EasyMock.replay(mocks);
1300         EasyMock.replay(myMockConnectionFactory);
1301     }
1302     private void reset(final Object... mocks) {
1303         EasyMock.reset(mocks);
1304         EasyMock.reset(myMockConnectionFactory);
1305     }
1306     private void verify(final Object... mocks) {
1307         EasyMock.verify(mocks);
1308         EasyMock.verify(myMockConnectionFactory);
1309     }
1310 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
