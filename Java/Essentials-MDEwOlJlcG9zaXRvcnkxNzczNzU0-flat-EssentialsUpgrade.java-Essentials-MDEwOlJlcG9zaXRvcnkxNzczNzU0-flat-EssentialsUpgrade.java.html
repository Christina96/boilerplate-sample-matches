
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 22, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>Essentials-MDEwOlJlcG9zaXRvcnkxNzczNzU0-flat-EssentialsUpgrade.java</h3>
            <pre><code>1  package com.earth2me.essentials;
2  import static com.earth2me.essentials.I18n.tl;
3  import com.earth2me.essentials.craftbukkit.BanLookup;
4  import com.earth2me.essentials.craftbukkit.FakeWorld;
5  import com.earth2me.essentials.settings.Spawns;
6  import com.earth2me.essentials.storage.YamlStorageWriter;
7  import com.earth2me.essentials.utils.StringUtil;
8  import com.google.common.base.Charsets;
9  import java.io.*;
10  import java.math.BigInteger;
11  import java.security.DigestInputStream;
12  import java.security.MessageDigest;
13  import java.util.*;
14  import java.util.logging.Level;
15  import java.util.logging.Logger;
16  import net.ess3.api.IEssentials;
17  import org.bukkit.BanList;
18  import org.bukkit.Bukkit;
19  import org.bukkit.Location;
20  import org.bukkit.World;
21  public class EssentialsUpgrade
22  {
23  	private final static Logger LOGGER = Logger.getLogger("Essentials");
24  	private final transient IEssentials ess;
25  	private final transient EssentialsConf doneFile;
26  	EssentialsUpgrade(final IEssentials essentials)
27  	{
28  		ess = essentials;
29  		if (!ess.getDataFolder().exists())
30  		{
31  			ess.getDataFolder().mkdirs();
32  		}
33  		doneFile = new EssentialsConf(new File(ess.getDataFolder(), "upgrades-done.yml"));
34  		doneFile.load();
35  	}
36  	private void moveMotdRulesToFile(String name)
37  	{
38  		if (doneFile.getBoolean("move" + name + "ToFile", false))
39  		{
40  			return;
41  		}
42  		try
43  		{
44  			final File file = new File(ess.getDataFolder(), name + ".txt");
45  			if (file.exists())
46  			{
47  				return;
48  			}
49  			final File configFile = new File(ess.getDataFolder(), "config.yml");
50  			if (!configFile.exists())
51  			{
52  				return;
53  			}
54  			final EssentialsConf conf = new EssentialsConf(configFile);
55  			conf.load();
56  			List<String> lines = conf.getStringList(name);
57  			if (lines != null && !lines.isEmpty())
58  			{
59  				if (!file.createNewFile())
60  				{
61  					throw new IOException("Failed to create file " + file);
62  				}
63  				PrintWriter writer = new PrintWriter(file);
64  				for (String line : lines)
65  				{
66  					writer.println(line);
67  				}
68  				writer.close();
69  			}
70  			doneFile.setProperty("move" + name + "ToFile", true);
71  			doneFile.save();
72  		}
73  		catch (IOException e)
74  		{
75  			LOGGER.log(Level.SEVERE, tl("upgradingFilesError"), e);
76  		}
77  	}
78  	private void removeLinesFromConfig(File file, String regex, String info) throws Exception
79  	{
80  		boolean needUpdate = false;
81  		final BufferedReader bReader = new BufferedReader(new FileReader(file));
82  		final File tempFile = File.createTempFile("essentialsupgrade", ".tmp.yml", ess.getDataFolder());
83  		final BufferedWriter bWriter = new BufferedWriter(new FileWriter(tempFile));
84  		do
85  		{
86  			final String line = bReader.readLine();
87  			if (line == null)
88  			{
89  				break;
90  			}
91  			if (line.matches(regex))
92  			{
93  				if (!needUpdate && info != null)
94  				{
95  					bWriter.write(info, 0, info.length());
96  					bWriter.newLine();
97  				}
98  				needUpdate = true;
99  			}
100  			else
101  			{
102  				if (line.endsWith("\r\n"))
103  				{
104  					bWriter.write(line, 0, line.length() - 2);
105  				}
106  				else if (line.endsWith("\r") || line.endsWith("\n"))
107  				{
108  					bWriter.write(line, 0, line.length() - 1);
109  				}
110  				else
111  				{
112  					bWriter.write(line, 0, line.length());
113  				}
114  				bWriter.newLine();
115  			}
116  		}
117  		while (true);
118  		bReader.close();
119  		bWriter.close();
120  		if (needUpdate)
121  		{
122  			if (!file.renameTo(new File(file.getParentFile(), file.getName().concat("." + System.currentTimeMillis() + ".upgradebackup"))))
123  			{
124  				throw new Exception(tl("configFileMoveError"));
125  			}
126  			if (!tempFile.renameTo(file))
127  			{
128  				throw new Exception(tl("configFileRenameError"));
129  			}
130  		}
131  		else
132  		{
133  			tempFile.delete();
134  		}
135  	}
136  	private void updateUsersPowerToolsFormat()
137  	{
138  		if (doneFile.getBoolean("updateUsersPowerToolsFormat", false))
139  		{
140  			return;
141  		}
142  		final File userdataFolder = new File(ess.getDataFolder(), "userdata");
143  		if (!userdataFolder.exists() || !userdataFolder.isDirectory())
144  		{
145  			return;
146  		}
147  		final File[] userFiles = userdataFolder.listFiles();
148  		for (File file : userFiles)
149  		{
150  			if (!file.isFile() || !file.getName().endsWith(".yml"))
151  			{
152  				continue;
153  			}
154  			final EssentialsConf config = new EssentialsConf(file);
155  			try
156  			{
157  				config.load();
158  				if (config.hasProperty("powertools"))
159  				{
160  					@SuppressWarnings("unchecked")
161  					final Map<String, Object> powertools = config.getConfigurationSection("powertools").getValues(false);
162  					if (powertools == null)
163  					{
164  						continue;
165  					}
166  					for (Map.Entry<String, Object> entry : powertools.entrySet())
167  					{
168  						if (entry.getValue() instanceof String)
169  						{
170  							List<String> temp = new ArrayList<String>();
171  							temp.add((String)entry.getValue());
172  							((Map<String, Object>)powertools).put(entry.getKey(), temp);
173  						}
174  					}
175  					config.forceSave();
176  				}
177  			}
178  			catch (RuntimeException ex)
179  			{
180  				LOGGER.log(Level.INFO, "File: " + file.toString());
181  				throw ex;
182  			}
183  		}
184  		doneFile.setProperty("updateUsersPowerToolsFormat", true);
185  		doneFile.save();
186  	}
187  	private void updateUsersHomesFormat()
188  	{
189  		if (doneFile.getBoolean("updateUsersHomesFormat", false))
190  		{
191  			return;
192  		}
193  		final File userdataFolder = new File(ess.getDataFolder(), "userdata");
194  		if (!userdataFolder.exists() || !userdataFolder.isDirectory())
195  		{
196  			return;
197  		}
198  		final File[] userFiles = userdataFolder.listFiles();
199  		for (File file : userFiles)
200  		{
201  			if (!file.isFile() || !file.getName().endsWith(".yml"))
202  			{
203  				continue;
204  			}
205  			final EssentialsConf config = new EssentialsConf(file);
206  			try
207  			{
208  				config.load();
209  				if (config.hasProperty("home") && config.hasProperty("home.default"))
210  				{
211  					@SuppressWarnings("unchecked")
212  					final String defworld = (String)config.getProperty("home.default");
213  					final Location defloc = getFakeLocation(config, "home.worlds." + defworld);
214  					if (defloc != null)
215  					{
216  						config.setProperty("homes.home", defloc);
217  					}
218  					Set<String> worlds = config.getConfigurationSection("home.worlds").getKeys(false);
219  					Location loc;
220  					String worldName;
221  					if (worlds == null)
222  					{
223  						continue;
224  					}
225  					for (String world : worlds)
226  					{
227  						if (defworld.equalsIgnoreCase(world))
228  						{
229  							continue;
230  						}
231  						loc = getFakeLocation(config, "home.worlds." + world);
232  						if (loc == null)
233  						{
234  							continue;
235  						}
236  						worldName = loc.getWorld().getName().toLowerCase(Locale.ENGLISH);
237  						if (worldName != null && !worldName.isEmpty())
238  						{
239  							config.setProperty("homes." + worldName, loc);
240  						}
241  					}
242  					config.removeProperty("home");
243  					config.forceSave();
244  				}
245  			}
246  			catch (RuntimeException ex)
247  			{
248  				LOGGER.log(Level.INFO, "File: " + file.toString());
249  				throw ex;
250  			}
251  		}
252  		doneFile.setProperty("updateUsersHomesFormat", true);
253  		doneFile.save();
254  	}
255  	private void sanitizeAllUserFilenames()
256  	{
257  		if (doneFile.getBoolean("sanitizeAllUserFilenames", false))
258  		{
259  			return;
260  		}
261  		final File usersFolder = new File(ess.getDataFolder(), "userdata");
262  		if (!usersFolder.exists())
263  		{
264  			return;
265  		}
266  		final File[] listOfFiles = usersFolder.listFiles();
267  		for (File listOfFile : listOfFiles)
268  		{
269  			final String filename = listOfFile.getName();
270  			if (!listOfFile.isFile() || !filename.endsWith(".yml"))
271  			{
272  				continue;
273  			}
274  			final String sanitizedFilename = StringUtil.sanitizeFileName(filename.substring(0, filename.length() - 4)) + ".yml";
275  			if (sanitizedFilename.equals(filename))
276  			{
277  				continue;
278  			}
279  			final File tmpFile = new File(listOfFile.getParentFile(), sanitizedFilename + ".tmp");
280  			final File newFile = new File(listOfFile.getParentFile(), sanitizedFilename);
281  			if (!listOfFile.renameTo(tmpFile))
282  			{
283  				LOGGER.log(Level.WARNING, tl("userdataMoveError", filename, sanitizedFilename));
284  				continue;
285  			}
286  			if (newFile.exists())
287  			{
288  				LOGGER.log(Level.WARNING, tl("duplicatedUserdata", filename, sanitizedFilename));
289  				continue;
290  			}
291  			if (!tmpFile.renameTo(newFile))
292  			{
293  				LOGGER.log(Level.WARNING, tl("userdataMoveBackError", sanitizedFilename, sanitizedFilename));
294  			}
295  		}
296  		doneFile.setProperty("sanitizeAllUserFilenames", true);
297  		doneFile.save();
298  	}
299  	private World getFakeWorld(final String name)
300  	{
301  		final File bukkitDirectory = ess.getDataFolder().getParentFile().getParentFile();
302  		final File worldDirectory = new File(bukkitDirectory, name);
303  		if (worldDirectory.exists() && worldDirectory.isDirectory())
304  		{
305  			return new FakeWorld(worldDirectory.getName(), World.Environment.NORMAL);
306  		}
307  		return null;
308  	}
309  	public Location getFakeLocation(EssentialsConf config, String path)
310  	{
311  		String worldName = config.getString((path != null ? path + "." : "") + "world");
312  		if (worldName == null || worldName.isEmpty())
313  		{
314  			return null;
315  		}
316  		World world = getFakeWorld(worldName);
317  		if (world == null)
318  		{
319  			return null;
320  		}
321  		return new Location(world,
322  							config.getDouble((path != null ? path + "." : "") + "x", 0),
323  							config.getDouble((path != null ? path + "." : "") + "y", 0),
324  							config.getDouble((path != null ? path + "." : "") + "z", 0),
325  							(float)config.getDouble((path != null ? path + "." : "") + "yaw", 0),
326  							(float)config.getDouble((path != null ? path + "." : "") + "pitch", 0));
327  	}
328  	private void deleteOldItemsCsv()
329  	{
330  		if (doneFile.getBoolean("deleteOldItemsCsv", false))
331  		{
332  			return;
333  		}
334  		final File file = new File(ess.getDataFolder(), "items.csv");
335  		if (file.exists())
336  		{
337  			try
338  			{
339  				final Set<BigInteger> oldconfigs = new HashSet<BigInteger>();
340  				oldconfigs.add(new BigInteger("66ec40b09ac167079f558d1099e39f10", 16)); 
341  				oldconfigs.add(new BigInteger("34284de1ead43b0bee2aae85e75c041d", 16)); 
342  				oldconfigs.add(new BigInteger("c33bc9b8ee003861611bbc2f48eb6f4f", 16)); 
343  				oldconfigs.add(new BigInteger("6ff17925430735129fc2a02f830c1daa", 16)); 
344  				MessageDigest digest = ManagedFile.getDigest();
345  				final BufferedInputStream bis = new BufferedInputStream(new FileInputStream(file));
346  				final DigestInputStream dis = new DigestInputStream(bis, digest);
347  				final byte[] buffer = new byte[1024];
348  				try
349  				{
350  					while (dis.read(buffer) != -1)
351  					{
352  					}
353  				}
354  				finally
355  				{
356  					dis.close();
357  				}
358  				BigInteger hash = new BigInteger(1, digest.digest());
359  				if (oldconfigs.contains(hash) && !file.delete())
360  				{
361  					throw new IOException("Could not delete file " + file.toString());
362  				}
363  				doneFile.setProperty("deleteOldItemsCsv", true);
364  				doneFile.save();
365  			}
366  			catch (IOException ex)
367  			{
368  				Bukkit.getLogger().log(Level.SEVERE, ex.getMessage(), ex);
369  			}
370  		}
371  	}
372  	private void updateSpawnsToNewSpawnsConfig()
373  	{
374  		if (doneFile.getBoolean("updateSpawnsToNewSpawnsConfig", false))
375  		{
376  			return;
377  		}
378  		final File configFile = new File(ess.getDataFolder(), "spawn.yml");
379  		if (configFile.exists())
380  		{
381  			final EssentialsConf config = new EssentialsConf(configFile);
382  			try
383  			{
384  				config.load();
385  				if (!config.hasProperty("spawns"))
386  				{
387  					final Spawns spawns = new Spawns();
388  					Set<String> keys = config.getKeys(false);
389  					for (String group : keys)
390  					{
391  						Location loc = getFakeLocation(config, group);
392  						spawns.getSpawns().put(group.toLowerCase(Locale.ENGLISH), loc);
393  					}
394  					if (!configFile.renameTo(new File(ess.getDataFolder(), "spawn.yml.old")))
395  					{
396  						throw new Exception(tl("fileRenameError", "spawn.yml"));
397  					}
398  					PrintWriter writer = new PrintWriter(configFile);
399  					try
400  					{
401  						new YamlStorageWriter(writer).save(spawns);
402  					}
403  					finally
404  					{
405  						writer.close();
406  					}
407  				}
408  			}
409  			catch (Exception ex)
410  			{
411  				Bukkit.getLogger().log(Level.SEVERE, ex.getMessage(), ex);
412  			}
413  		}
414  		doneFile.setProperty("updateSpawnsToNewSpawnsConfig", true);
415  		doneFile.save();
416  	}
417  	private void updateJailsToNewJailsConfig()
418  	{
419  		if (doneFile.getBoolean("updateJailsToNewJailsConfig", false))
420  		{
421  			return;
422  		}
423  		final File configFile = new File(ess.getDataFolder(), "jail.yml");
424  		if (configFile.exists())
425  		{
426  			final EssentialsConf config = new EssentialsConf(configFile);
427  			try
428  			{
429  				config.load();
430  				if (!config.hasProperty("jails"))
431  				{
432  					final com.earth2me.essentials.settings.Jails jails = new com.earth2me.essentials.settings.Jails();
433  					Set<String> keys = config.getKeys(false);
434  					for (String jailName : keys)
435  					{
436  						Location loc = getFakeLocation(config, jailName);
437  						jails.getJails().put(jailName.toLowerCase(Locale.ENGLISH), loc);
438  					}
439  					if (!configFile.renameTo(new File(ess.getDataFolder(), "jail.yml.old")))
440  					{
441  						throw new Exception(tl("fileRenameError", "jail.yml"));
442  					}
443  					PrintWriter writer = new PrintWriter(configFile);
444  					try
445  					{
446  						new YamlStorageWriter(writer).save(jails);
447  					}
448  					finally
449  					{
450  						writer.close();
451  					}
452  				}
453  			}
454  			catch (Exception ex)
455  			{
456  				Bukkit.getLogger().log(Level.SEVERE, ex.getMessage(), ex);
457  			}
458  		}
459  		doneFile.setProperty("updateJailsToNewJailsConfig", true);
460  		doneFile.save();
461  	}
462  	private void warnMetrics()
463  	{
464  		if (doneFile.getBoolean("warnMetrics", false))
465  		{
466  			return;
467  		}
468  		ess.getSettings().setMetricsEnabled(false);
469  		doneFile.setProperty("warnMetrics", true);
470  		doneFile.save();
471  	}
472  	private void uuidFileChange()
473  	{
474  		if (doneFile.getBoolean("uuidFileChange", false))
475  		{
476  			return;
477  		}
478  		Boolean ignoreUFCache = doneFile.getBoolean("ignore-userfiles-cache", false);
479  		final File userdir = new File(ess.getDataFolder(), "userdata");
480  		if (!userdir.exists())
481  		{
482  			return;
483  		}
484  		int countFiles = 0;
485  		int countReqFiles = 0;
486  		for (String string : userdir.list())
487  		{
<span onclick='openModal()' class='match'>488  			if (!string.endsWith(".yml") || string.length() < 5)
489  			{
490  				continue;
491  			}
492  			countFiles++;
</span>493  			final String name = string.substring(0, string.length() - 4);
494  			UUID uuid = null;
495  			try
496  			{
497  				uuid = UUID.fromString(name);
498  			}
499  			catch (IllegalArgumentException ex)
500  			{
501  				countReqFiles++;
502  			}
503  			if (countFiles > 100)
504  			{
505  				break;
506  			}
507  		}
508  		if (countReqFiles < 1)
509  		{
510  			return;
511  		}
512  		ess.getLogger().info("#### Starting Essentials UUID userdata conversion in a few seconds. ####");
513  		ess.getLogger().info("We recommend you take a backup of your server before upgrading from the old username system.");
514  		try
515  		{
516  			Thread.sleep(15000);
517  		}
518  		catch (InterruptedException ex)
519  		{
520  		}
521  		uuidFileConvert(ess, ignoreUFCache);
522  		doneFile.setProperty("uuidFileChange", true);
523  		doneFile.save();
524  	}
525  	public static void uuidFileConvert(IEssentials ess, Boolean ignoreUFCache)
526  	{
527  		ess.getLogger().info("Starting Essentials UUID userdata conversion");
528  		final File userdir = new File(ess.getDataFolder(), "userdata");
529  		if (!userdir.exists())
530  		{
531  			return;
532  		}
533  		int countFiles = 0;
534  		int countFails = 0;
535  		int countEssCache = 0;
536  		int countBukkit = 0;
537  		ess.getLogger().info("Found " + userdir.list().length + " files to convert...");
538  		for (String string : userdir.list())
539  		{
540  			if (!string.endsWith(".yml") || string.length() < 5)
541  			{
542  				continue;
543  			}
544  			final int showProgress = countFiles % 250;
545  			if (showProgress == 0)
546  			{
547  				ess.getUserMap().getUUIDMap().forceWriteUUIDMap();
548  				ess.getLogger().info("Converted " + countFiles + "/" + userdir.list().length);
549  			}
550  			countFiles++;
551  			String name = string.substring(0, string.length() - 4);
552  			EssentialsUserConf config;
553  			UUID uuid = null;
554  			try
555  			{
556  				uuid = UUID.fromString(name);
557  			}
558  			catch (IllegalArgumentException ex)
559  			{
560  				File file = new File(userdir, string);
561  				EssentialsConf conf = new EssentialsConf(file);
562  				conf.load();
563  				conf.setProperty("lastAccountName", name);
564  				conf.save();
565  				String uuidConf = ignoreUFCache ? "force-uuid" : "uuid";
566  				String uuidString = conf.getString(uuidConf, null);
567  				for (int i = 0; i < 4; i++)
568  				{
569  					try
570  					{
571  						uuid = UUID.fromString(uuidString);
572  						countEssCache++;
573  						break;
574  					}
575  					catch (Exception ex2)
576  					{
577  						if (conf.getBoolean("npc", false))
578  						{
579  							uuid = UUID.nameUUIDFromBytes(("NPC:" + name).getBytes(Charsets.UTF_8));
580  							break;
581  						}
582  						org.bukkit.OfflinePlayer player = ess.getServer().getOfflinePlayer(name);
583  						uuid = player.getUniqueId();
584  					}
585  					if (uuid != null)
586  					{
587  						countBukkit++;
588  						break;
589  					}
590  				}
591  				if (uuid != null)
592  				{
593  					conf.forceSave();
594  					config = new EssentialsUserConf(name, uuid, new File(userdir, uuid + ".yml"));
595  					config.convertLegacyFile();
596  					ess.getUserMap().trackUUID(uuid, name, false);
597  					continue;
598  				}
599  				countFails++;
600  			}
601  		}
602  		ess.getUserMap().getUUIDMap().forceWriteUUIDMap();
603  		ess.getLogger().info("Converted " + countFiles + "/" + countFiles + ".  Conversion complete.");
604  		ess.getLogger().info("Converted via cache: " + countEssCache + " :: Converted via lookup: " + countBukkit + " :: Failed to convert: " + countFails);
605  		ess.getLogger().info("To rerun the conversion type /essentials uuidconvert");
606  	}
607  	public void banFormatChange()
608  	{
609  		if (doneFile.getBoolean("banFormatChange", false))
610  		{
611  			return;
612  		}
613  		ess.getLogger().info("Starting Essentials ban format conversion");
614  		final File userdir = new File(ess.getDataFolder(), "userdata");
615  		if (!userdir.exists())
616  		{
617  			return;
618  		}
619  		int countFiles = 0;
620  		ess.getLogger().info("Found " + userdir.list().length + " files to convert...");
621  		for (String string : userdir.list())
622  		{
623  			if (!string.endsWith(".yml") || string.length() < 5)
624  			{
625  				continue;
626  			}
627  			final int showProgress = countFiles % 250;
628  			if (showProgress == 0)
629  			{
630  				ess.getLogger().info("Converted " + countFiles + "/" + userdir.list().length);
631  			}
632  			countFiles++;
633  			final File pFile = new File(userdir, string);
634  			final EssentialsConf conf = new EssentialsConf(pFile);
635  			conf.load();
636  			String banReason;
637  			Long banTimeout;
638  			try
639  			{
640  				banReason = conf.getConfigurationSection("ban").getString("reason");
641  			}
642  			catch (NullPointerException n)
643  			{
644  				banReason = null;
645  			}
646  			final String playerName = conf.getString("lastAccountName");
647  			if (playerName != null && playerName.length() > 1 && banReason != null && banReason.length() > 1)
648  			{
649  				try
650  				{
651  					if (conf.getConfigurationSection("ban").contains("timeout"))
652  					{
653  						banTimeout = Long.parseLong(conf.getConfigurationSection("ban").getString("timeout"));
654  					}
655  					else
656  					{
657  						banTimeout = 0L;
658  					}
659  				}
660  				catch (NumberFormatException n)
661  				{
662  					banTimeout = 0L;
663  				}
664  				if (BanLookup.isBanned(ess, playerName))
665  				{
666  					updateBan(playerName, banReason, banTimeout);
667  				}
668  			}
669  			conf.removeProperty("ban");
670  			conf.save();
671  		}
672  		doneFile.setProperty("banFormatChange", true);
673  		doneFile.save();
674  		ess.getLogger().info("Ban format update complete.");
675  	}
676  	private void updateBan(String playerName, String banReason, Long banTimeout)
677  	{
678  		if (banTimeout == 0)
679  		{
680  			Bukkit.getBanList(BanList.Type.NAME).addBan(playerName, banReason, null, Console.NAME);
681  		}
682  		else
683  		{
684  			Bukkit.getBanList(BanList.Type.NAME).addBan(playerName, banReason, new Date(banTimeout), Console.NAME);
685  		}
686  	}
687  	public void beforeSettings()
688  	{
689  		if (!ess.getDataFolder().exists())
690  		{
691  			ess.getDataFolder().mkdirs();
692  		}
693  		moveMotdRulesToFile("motd");
694  		moveMotdRulesToFile("rules");
695  	}
696  	public void afterSettings()
697  	{
698  		sanitizeAllUserFilenames();
699  		updateUsersPowerToolsFormat();
700  		updateUsersHomesFormat();
701  		deleteOldItemsCsv();
702  		updateSpawnsToNewSpawnsConfig();
703  		updateJailsToNewJailsConfig();
704  		uuidFileChange();
705  		banFormatChange();
706  		warnMetrics();
707  	}
708  }
</code></pre>
        </div>
        <div class="column">
            <h3>Essentials-MDEwOlJlcG9zaXRvcnkxNzczNzU0-flat-EssentialsUpgrade.java</h3>
            <pre><code>1  package com.earth2me.essentials;
2  import static com.earth2me.essentials.I18n.tl;
3  import com.earth2me.essentials.craftbukkit.BanLookup;
4  import com.earth2me.essentials.craftbukkit.FakeWorld;
5  import com.earth2me.essentials.settings.Spawns;
6  import com.earth2me.essentials.storage.YamlStorageWriter;
7  import com.earth2me.essentials.utils.StringUtil;
8  import com.google.common.base.Charsets;
9  import java.io.*;
10  import java.math.BigInteger;
11  import java.security.DigestInputStream;
12  import java.security.MessageDigest;
13  import java.util.*;
14  import java.util.logging.Level;
15  import java.util.logging.Logger;
16  import net.ess3.api.IEssentials;
17  import org.bukkit.BanList;
18  import org.bukkit.Bukkit;
19  import org.bukkit.Location;
20  import org.bukkit.World;
21  public class EssentialsUpgrade
22  {
23  	private final static Logger LOGGER = Logger.getLogger("Essentials");
24  	private final transient IEssentials ess;
25  	private final transient EssentialsConf doneFile;
26  	EssentialsUpgrade(final IEssentials essentials)
27  	{
28  		ess = essentials;
29  		if (!ess.getDataFolder().exists())
30  		{
31  			ess.getDataFolder().mkdirs();
32  		}
33  		doneFile = new EssentialsConf(new File(ess.getDataFolder(), "upgrades-done.yml"));
34  		doneFile.load();
35  	}
36  	private void moveMotdRulesToFile(String name)
37  	{
38  		if (doneFile.getBoolean("move" + name + "ToFile", false))
39  		{
40  			return;
41  		}
42  		try
43  		{
44  			final File file = new File(ess.getDataFolder(), name + ".txt");
45  			if (file.exists())
46  			{
47  				return;
48  			}
49  			final File configFile = new File(ess.getDataFolder(), "config.yml");
50  			if (!configFile.exists())
51  			{
52  				return;
53  			}
54  			final EssentialsConf conf = new EssentialsConf(configFile);
55  			conf.load();
56  			List<String> lines = conf.getStringList(name);
57  			if (lines != null && !lines.isEmpty())
58  			{
59  				if (!file.createNewFile())
60  				{
61  					throw new IOException("Failed to create file " + file);
62  				}
63  				PrintWriter writer = new PrintWriter(file);
64  				for (String line : lines)
65  				{
66  					writer.println(line);
67  				}
68  				writer.close();
69  			}
70  			doneFile.setProperty("move" + name + "ToFile", true);
71  			doneFile.save();
72  		}
73  		catch (IOException e)
74  		{
75  			LOGGER.log(Level.SEVERE, tl("upgradingFilesError"), e);
76  		}
77  	}
78  	private void removeLinesFromConfig(File file, String regex, String info) throws Exception
79  	{
80  		boolean needUpdate = false;
81  		final BufferedReader bReader = new BufferedReader(new FileReader(file));
82  		final File tempFile = File.createTempFile("essentialsupgrade", ".tmp.yml", ess.getDataFolder());
83  		final BufferedWriter bWriter = new BufferedWriter(new FileWriter(tempFile));
84  		do
85  		{
86  			final String line = bReader.readLine();
87  			if (line == null)
88  			{
89  				break;
90  			}
91  			if (line.matches(regex))
92  			{
93  				if (!needUpdate && info != null)
94  				{
95  					bWriter.write(info, 0, info.length());
96  					bWriter.newLine();
97  				}
98  				needUpdate = true;
99  			}
100  			else
101  			{
102  				if (line.endsWith("\r\n"))
103  				{
104  					bWriter.write(line, 0, line.length() - 2);
105  				}
106  				else if (line.endsWith("\r") || line.endsWith("\n"))
107  				{
108  					bWriter.write(line, 0, line.length() - 1);
109  				}
110  				else
111  				{
112  					bWriter.write(line, 0, line.length());
113  				}
114  				bWriter.newLine();
115  			}
116  		}
117  		while (true);
118  		bReader.close();
119  		bWriter.close();
120  		if (needUpdate)
121  		{
122  			if (!file.renameTo(new File(file.getParentFile(), file.getName().concat("." + System.currentTimeMillis() + ".upgradebackup"))))
123  			{
124  				throw new Exception(tl("configFileMoveError"));
125  			}
126  			if (!tempFile.renameTo(file))
127  			{
128  				throw new Exception(tl("configFileRenameError"));
129  			}
130  		}
131  		else
132  		{
133  			tempFile.delete();
134  		}
135  	}
136  	private void updateUsersPowerToolsFormat()
137  	{
138  		if (doneFile.getBoolean("updateUsersPowerToolsFormat", false))
139  		{
140  			return;
141  		}
142  		final File userdataFolder = new File(ess.getDataFolder(), "userdata");
143  		if (!userdataFolder.exists() || !userdataFolder.isDirectory())
144  		{
145  			return;
146  		}
147  		final File[] userFiles = userdataFolder.listFiles();
148  		for (File file : userFiles)
149  		{
150  			if (!file.isFile() || !file.getName().endsWith(".yml"))
151  			{
152  				continue;
153  			}
154  			final EssentialsConf config = new EssentialsConf(file);
155  			try
156  			{
157  				config.load();
158  				if (config.hasProperty("powertools"))
159  				{
160  					@SuppressWarnings("unchecked")
161  					final Map<String, Object> powertools = config.getConfigurationSection("powertools").getValues(false);
162  					if (powertools == null)
163  					{
164  						continue;
165  					}
166  					for (Map.Entry<String, Object> entry : powertools.entrySet())
167  					{
168  						if (entry.getValue() instanceof String)
169  						{
170  							List<String> temp = new ArrayList<String>();
171  							temp.add((String)entry.getValue());
172  							((Map<String, Object>)powertools).put(entry.getKey(), temp);
173  						}
174  					}
175  					config.forceSave();
176  				}
177  			}
178  			catch (RuntimeException ex)
179  			{
180  				LOGGER.log(Level.INFO, "File: " + file.toString());
181  				throw ex;
182  			}
183  		}
184  		doneFile.setProperty("updateUsersPowerToolsFormat", true);
185  		doneFile.save();
186  	}
187  	private void updateUsersHomesFormat()
188  	{
189  		if (doneFile.getBoolean("updateUsersHomesFormat", false))
190  		{
191  			return;
192  		}
193  		final File userdataFolder = new File(ess.getDataFolder(), "userdata");
194  		if (!userdataFolder.exists() || !userdataFolder.isDirectory())
195  		{
196  			return;
197  		}
198  		final File[] userFiles = userdataFolder.listFiles();
199  		for (File file : userFiles)
200  		{
201  			if (!file.isFile() || !file.getName().endsWith(".yml"))
202  			{
203  				continue;
204  			}
205  			final EssentialsConf config = new EssentialsConf(file);
206  			try
207  			{
208  				config.load();
209  				if (config.hasProperty("home") && config.hasProperty("home.default"))
210  				{
211  					@SuppressWarnings("unchecked")
212  					final String defworld = (String)config.getProperty("home.default");
213  					final Location defloc = getFakeLocation(config, "home.worlds." + defworld);
214  					if (defloc != null)
215  					{
216  						config.setProperty("homes.home", defloc);
217  					}
218  					Set<String> worlds = config.getConfigurationSection("home.worlds").getKeys(false);
219  					Location loc;
220  					String worldName;
221  					if (worlds == null)
222  					{
223  						continue;
224  					}
225  					for (String world : worlds)
226  					{
227  						if (defworld.equalsIgnoreCase(world))
228  						{
229  							continue;
230  						}
231  						loc = getFakeLocation(config, "home.worlds." + world);
232  						if (loc == null)
233  						{
234  							continue;
235  						}
236  						worldName = loc.getWorld().getName().toLowerCase(Locale.ENGLISH);
237  						if (worldName != null && !worldName.isEmpty())
238  						{
239  							config.setProperty("homes." + worldName, loc);
240  						}
241  					}
242  					config.removeProperty("home");
243  					config.forceSave();
244  				}
245  			}
246  			catch (RuntimeException ex)
247  			{
248  				LOGGER.log(Level.INFO, "File: " + file.toString());
249  				throw ex;
250  			}
251  		}
252  		doneFile.setProperty("updateUsersHomesFormat", true);
253  		doneFile.save();
254  	}
255  	private void sanitizeAllUserFilenames()
256  	{
257  		if (doneFile.getBoolean("sanitizeAllUserFilenames", false))
258  		{
259  			return;
260  		}
261  		final File usersFolder = new File(ess.getDataFolder(), "userdata");
262  		if (!usersFolder.exists())
263  		{
264  			return;
265  		}
266  		final File[] listOfFiles = usersFolder.listFiles();
267  		for (File listOfFile : listOfFiles)
268  		{
269  			final String filename = listOfFile.getName();
270  			if (!listOfFile.isFile() || !filename.endsWith(".yml"))
271  			{
272  				continue;
273  			}
274  			final String sanitizedFilename = StringUtil.sanitizeFileName(filename.substring(0, filename.length() - 4)) + ".yml";
275  			if (sanitizedFilename.equals(filename))
276  			{
277  				continue;
278  			}
279  			final File tmpFile = new File(listOfFile.getParentFile(), sanitizedFilename + ".tmp");
280  			final File newFile = new File(listOfFile.getParentFile(), sanitizedFilename);
281  			if (!listOfFile.renameTo(tmpFile))
282  			{
283  				LOGGER.log(Level.WARNING, tl("userdataMoveError", filename, sanitizedFilename));
284  				continue;
285  			}
286  			if (newFile.exists())
287  			{
288  				LOGGER.log(Level.WARNING, tl("duplicatedUserdata", filename, sanitizedFilename));
289  				continue;
290  			}
291  			if (!tmpFile.renameTo(newFile))
292  			{
293  				LOGGER.log(Level.WARNING, tl("userdataMoveBackError", sanitizedFilename, sanitizedFilename));
294  			}
295  		}
296  		doneFile.setProperty("sanitizeAllUserFilenames", true);
297  		doneFile.save();
298  	}
299  	private World getFakeWorld(final String name)
300  	{
301  		final File bukkitDirectory = ess.getDataFolder().getParentFile().getParentFile();
302  		final File worldDirectory = new File(bukkitDirectory, name);
303  		if (worldDirectory.exists() && worldDirectory.isDirectory())
304  		{
305  			return new FakeWorld(worldDirectory.getName(), World.Environment.NORMAL);
306  		}
307  		return null;
308  	}
309  	public Location getFakeLocation(EssentialsConf config, String path)
310  	{
311  		String worldName = config.getString((path != null ? path + "." : "") + "world");
312  		if (worldName == null || worldName.isEmpty())
313  		{
314  			return null;
315  		}
316  		World world = getFakeWorld(worldName);
317  		if (world == null)
318  		{
319  			return null;
320  		}
321  		return new Location(world,
322  							config.getDouble((path != null ? path + "." : "") + "x", 0),
323  							config.getDouble((path != null ? path + "." : "") + "y", 0),
324  							config.getDouble((path != null ? path + "." : "") + "z", 0),
325  							(float)config.getDouble((path != null ? path + "." : "") + "yaw", 0),
326  							(float)config.getDouble((path != null ? path + "." : "") + "pitch", 0));
327  	}
328  	private void deleteOldItemsCsv()
329  	{
330  		if (doneFile.getBoolean("deleteOldItemsCsv", false))
331  		{
332  			return;
333  		}
334  		final File file = new File(ess.getDataFolder(), "items.csv");
335  		if (file.exists())
336  		{
337  			try
338  			{
339  				final Set<BigInteger> oldconfigs = new HashSet<BigInteger>();
340  				oldconfigs.add(new BigInteger("66ec40b09ac167079f558d1099e39f10", 16)); 
341  				oldconfigs.add(new BigInteger("34284de1ead43b0bee2aae85e75c041d", 16)); 
342  				oldconfigs.add(new BigInteger("c33bc9b8ee003861611bbc2f48eb6f4f", 16)); 
343  				oldconfigs.add(new BigInteger("6ff17925430735129fc2a02f830c1daa", 16)); 
344  				MessageDigest digest = ManagedFile.getDigest();
345  				final BufferedInputStream bis = new BufferedInputStream(new FileInputStream(file));
346  				final DigestInputStream dis = new DigestInputStream(bis, digest);
347  				final byte[] buffer = new byte[1024];
348  				try
349  				{
350  					while (dis.read(buffer) != -1)
351  					{
352  					}
353  				}
354  				finally
355  				{
356  					dis.close();
357  				}
358  				BigInteger hash = new BigInteger(1, digest.digest());
359  				if (oldconfigs.contains(hash) && !file.delete())
360  				{
361  					throw new IOException("Could not delete file " + file.toString());
362  				}
363  				doneFile.setProperty("deleteOldItemsCsv", true);
364  				doneFile.save();
365  			}
366  			catch (IOException ex)
367  			{
368  				Bukkit.getLogger().log(Level.SEVERE, ex.getMessage(), ex);
369  			}
370  		}
371  	}
372  	private void updateSpawnsToNewSpawnsConfig()
373  	{
374  		if (doneFile.getBoolean("updateSpawnsToNewSpawnsConfig", false))
375  		{
376  			return;
377  		}
378  		final File configFile = new File(ess.getDataFolder(), "spawn.yml");
379  		if (configFile.exists())
380  		{
381  			final EssentialsConf config = new EssentialsConf(configFile);
382  			try
383  			{
384  				config.load();
385  				if (!config.hasProperty("spawns"))
386  				{
387  					final Spawns spawns = new Spawns();
388  					Set<String> keys = config.getKeys(false);
389  					for (String group : keys)
390  					{
391  						Location loc = getFakeLocation(config, group);
392  						spawns.getSpawns().put(group.toLowerCase(Locale.ENGLISH), loc);
393  					}
394  					if (!configFile.renameTo(new File(ess.getDataFolder(), "spawn.yml.old")))
395  					{
396  						throw new Exception(tl("fileRenameError", "spawn.yml"));
397  					}
398  					PrintWriter writer = new PrintWriter(configFile);
399  					try
400  					{
401  						new YamlStorageWriter(writer).save(spawns);
402  					}
403  					finally
404  					{
405  						writer.close();
406  					}
407  				}
408  			}
409  			catch (Exception ex)
410  			{
411  				Bukkit.getLogger().log(Level.SEVERE, ex.getMessage(), ex);
412  			}
413  		}
414  		doneFile.setProperty("updateSpawnsToNewSpawnsConfig", true);
415  		doneFile.save();
416  	}
417  	private void updateJailsToNewJailsConfig()
418  	{
419  		if (doneFile.getBoolean("updateJailsToNewJailsConfig", false))
420  		{
421  			return;
422  		}
423  		final File configFile = new File(ess.getDataFolder(), "jail.yml");
424  		if (configFile.exists())
425  		{
426  			final EssentialsConf config = new EssentialsConf(configFile);
427  			try
428  			{
429  				config.load();
430  				if (!config.hasProperty("jails"))
431  				{
432  					final com.earth2me.essentials.settings.Jails jails = new com.earth2me.essentials.settings.Jails();
433  					Set<String> keys = config.getKeys(false);
434  					for (String jailName : keys)
435  					{
436  						Location loc = getFakeLocation(config, jailName);
437  						jails.getJails().put(jailName.toLowerCase(Locale.ENGLISH), loc);
438  					}
439  					if (!configFile.renameTo(new File(ess.getDataFolder(), "jail.yml.old")))
440  					{
441  						throw new Exception(tl("fileRenameError", "jail.yml"));
442  					}
443  					PrintWriter writer = new PrintWriter(configFile);
444  					try
445  					{
446  						new YamlStorageWriter(writer).save(jails);
447  					}
448  					finally
449  					{
450  						writer.close();
451  					}
452  				}
453  			}
454  			catch (Exception ex)
455  			{
456  				Bukkit.getLogger().log(Level.SEVERE, ex.getMessage(), ex);
457  			}
458  		}
459  		doneFile.setProperty("updateJailsToNewJailsConfig", true);
460  		doneFile.save();
461  	}
462  	private void warnMetrics()
463  	{
464  		if (doneFile.getBoolean("warnMetrics", false))
465  		{
466  			return;
467  		}
468  		ess.getSettings().setMetricsEnabled(false);
469  		doneFile.setProperty("warnMetrics", true);
470  		doneFile.save();
471  	}
472  	private void uuidFileChange()
473  	{
474  		if (doneFile.getBoolean("uuidFileChange", false))
475  		{
476  			return;
477  		}
478  		Boolean ignoreUFCache = doneFile.getBoolean("ignore-userfiles-cache", false);
479  		final File userdir = new File(ess.getDataFolder(), "userdata");
480  		if (!userdir.exists())
481  		{
482  			return;
483  		}
484  		int countFiles = 0;
485  		int countReqFiles = 0;
486  		for (String string : userdir.list())
487  		{
488  			if (!string.endsWith(".yml") || string.length() < 5)
489  			{
490  				continue;
491  			}
492  			countFiles++;
493  			final String name = string.substring(0, string.length() - 4);
494  			UUID uuid = null;
495  			try
496  			{
497  				uuid = UUID.fromString(name);
498  			}
499  			catch (IllegalArgumentException ex)
500  			{
501  				countReqFiles++;
502  			}
503  			if (countFiles > 100)
504  			{
505  				break;
506  			}
507  		}
508  		if (countReqFiles < 1)
509  		{
510  			return;
511  		}
512  		ess.getLogger().info("#### Starting Essentials UUID userdata conversion in a few seconds. ####");
513  		ess.getLogger().info("We recommend you take a backup of your server before upgrading from the old username system.");
514  		try
515  		{
516  			Thread.sleep(15000);
517  		}
518  		catch (InterruptedException ex)
519  		{
520  		}
521  		uuidFileConvert(ess, ignoreUFCache);
522  		doneFile.setProperty("uuidFileChange", true);
523  		doneFile.save();
524  	}
525  	public static void uuidFileConvert(IEssentials ess, Boolean ignoreUFCache)
526  	{
527  		ess.getLogger().info("Starting Essentials UUID userdata conversion");
528  		final File userdir = new File(ess.getDataFolder(), "userdata");
529  		if (!userdir.exists())
530  		{
531  			return;
532  		}
533  		int countFiles = 0;
534  		int countFails = 0;
535  		int countEssCache = 0;
536  		int countBukkit = 0;
537  		ess.getLogger().info("Found " + userdir.list().length + " files to convert...");
538  		for (String string : userdir.list())
539  		{
<span onclick='openModal()' class='match'>540  			if (!string.endsWith(".yml") || string.length() < 5)
541  			{
542  				continue;
543  			}
544  			final int showProgress = countFiles % 250;
</span>545  			if (showProgress == 0)
546  			{
547  				ess.getUserMap().getUUIDMap().forceWriteUUIDMap();
548  				ess.getLogger().info("Converted " + countFiles + "/" + userdir.list().length);
549  			}
550  			countFiles++;
551  			String name = string.substring(0, string.length() - 4);
552  			EssentialsUserConf config;
553  			UUID uuid = null;
554  			try
555  			{
556  				uuid = UUID.fromString(name);
557  			}
558  			catch (IllegalArgumentException ex)
559  			{
560  				File file = new File(userdir, string);
561  				EssentialsConf conf = new EssentialsConf(file);
562  				conf.load();
563  				conf.setProperty("lastAccountName", name);
564  				conf.save();
565  				String uuidConf = ignoreUFCache ? "force-uuid" : "uuid";
566  				String uuidString = conf.getString(uuidConf, null);
567  				for (int i = 0; i < 4; i++)
568  				{
569  					try
570  					{
571  						uuid = UUID.fromString(uuidString);
572  						countEssCache++;
573  						break;
574  					}
575  					catch (Exception ex2)
576  					{
577  						if (conf.getBoolean("npc", false))
578  						{
579  							uuid = UUID.nameUUIDFromBytes(("NPC:" + name).getBytes(Charsets.UTF_8));
580  							break;
581  						}
582  						org.bukkit.OfflinePlayer player = ess.getServer().getOfflinePlayer(name);
583  						uuid = player.getUniqueId();
584  					}
585  					if (uuid != null)
586  					{
587  						countBukkit++;
588  						break;
589  					}
590  				}
591  				if (uuid != null)
592  				{
593  					conf.forceSave();
594  					config = new EssentialsUserConf(name, uuid, new File(userdir, uuid + ".yml"));
595  					config.convertLegacyFile();
596  					ess.getUserMap().trackUUID(uuid, name, false);
597  					continue;
598  				}
599  				countFails++;
600  			}
601  		}
602  		ess.getUserMap().getUUIDMap().forceWriteUUIDMap();
603  		ess.getLogger().info("Converted " + countFiles + "/" + countFiles + ".  Conversion complete.");
604  		ess.getLogger().info("Converted via cache: " + countEssCache + " :: Converted via lookup: " + countBukkit + " :: Failed to convert: " + countFails);
605  		ess.getLogger().info("To rerun the conversion type /essentials uuidconvert");
606  	}
607  	public void banFormatChange()
608  	{
609  		if (doneFile.getBoolean("banFormatChange", false))
610  		{
611  			return;
612  		}
613  		ess.getLogger().info("Starting Essentials ban format conversion");
614  		final File userdir = new File(ess.getDataFolder(), "userdata");
615  		if (!userdir.exists())
616  		{
617  			return;
618  		}
619  		int countFiles = 0;
620  		ess.getLogger().info("Found " + userdir.list().length + " files to convert...");
621  		for (String string : userdir.list())
622  		{
623  			if (!string.endsWith(".yml") || string.length() < 5)
624  			{
625  				continue;
626  			}
627  			final int showProgress = countFiles % 250;
628  			if (showProgress == 0)
629  			{
630  				ess.getLogger().info("Converted " + countFiles + "/" + userdir.list().length);
631  			}
632  			countFiles++;
633  			final File pFile = new File(userdir, string);
634  			final EssentialsConf conf = new EssentialsConf(pFile);
635  			conf.load();
636  			String banReason;
637  			Long banTimeout;
638  			try
639  			{
640  				banReason = conf.getConfigurationSection("ban").getString("reason");
641  			}
642  			catch (NullPointerException n)
643  			{
644  				banReason = null;
645  			}
646  			final String playerName = conf.getString("lastAccountName");
647  			if (playerName != null && playerName.length() > 1 && banReason != null && banReason.length() > 1)
648  			{
649  				try
650  				{
651  					if (conf.getConfigurationSection("ban").contains("timeout"))
652  					{
653  						banTimeout = Long.parseLong(conf.getConfigurationSection("ban").getString("timeout"));
654  					}
655  					else
656  					{
657  						banTimeout = 0L;
658  					}
659  				}
660  				catch (NumberFormatException n)
661  				{
662  					banTimeout = 0L;
663  				}
664  				if (BanLookup.isBanned(ess, playerName))
665  				{
666  					updateBan(playerName, banReason, banTimeout);
667  				}
668  			}
669  			conf.removeProperty("ban");
670  			conf.save();
671  		}
672  		doneFile.setProperty("banFormatChange", true);
673  		doneFile.save();
674  		ess.getLogger().info("Ban format update complete.");
675  	}
676  	private void updateBan(String playerName, String banReason, Long banTimeout)
677  	{
678  		if (banTimeout == 0)
679  		{
680  			Bukkit.getBanList(BanList.Type.NAME).addBan(playerName, banReason, null, Console.NAME);
681  		}
682  		else
683  		{
684  			Bukkit.getBanList(BanList.Type.NAME).addBan(playerName, banReason, new Date(banTimeout), Console.NAME);
685  		}
686  	}
687  	public void beforeSettings()
688  	{
689  		if (!ess.getDataFolder().exists())
690  		{
691  			ess.getDataFolder().mkdirs();
692  		}
693  		moveMotdRulesToFile("motd");
694  		moveMotdRulesToFile("rules");
695  	}
696  	public void afterSettings()
697  	{
698  		sanitizeAllUserFilenames();
699  		updateUsersPowerToolsFormat();
700  		updateUsersHomesFormat();
701  		deleteOldItemsCsv();
702  		updateSpawnsToNewSpawnsConfig();
703  		updateJailsToNewJailsConfig();
704  		uuidFileChange();
705  		banFormatChange();
706  		warnMetrics();
707  	}
708  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Essentials-MDEwOlJlcG9zaXRvcnkxNzczNzU0-flat-EssentialsUpgrade.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Essentials-MDEwOlJlcG9zaXRvcnkxNzczNzU0-flat-EssentialsUpgrade.java</div>
                </div>
                <div class="column column_space"><pre><code>488  			if (!string.endsWith(".yml") || string.length() < 5)
489  			{
490  				continue;
491  			}
492  			countFiles++;
</pre></code></div>
                <div class="column column_space"><pre><code>540  			if (!string.endsWith(".yml") || string.length() < 5)
541  			{
542  				continue;
543  			}
544  			final int showProgress = countFiles % 250;
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    