
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 18.75%, Tokens: 11</h2>
        <div class="column">
            <h3>segmentfault-lessons-MDEwOlJlcG9zaXRvcnk5MzE1NzM4MQ==-flat-PersonDemo_4.java</h3>
            <pre><code>1  package com.segmentfault.deep.in.java.beans.properties;
2  import java.beans.PropertyChangeEvent;
3  import java.beans.PropertyVetoException;
4  import java.util.concurrent.ExecutionException;
5  import java.util.concurrent.ExecutorService;
6  import java.util.concurrent.Executors;
7  import java.util.concurrent.Future;
8  import static com.segmentfault.deep.in.java.beans.properties.Person.isNumeric;
9  import static java.lang.String.format;
10  import static java.lang.String.valueOf;
11  public class PersonDemo {
12      public static void main(String[] args) throws PropertyVetoException, ExecutionException, InterruptedException {
13          Person person = new Person();
14          person.addPropertyChangeListener(event -> {
15              System.out.printf("监听到属性[%s] 内容变化（事件来源：%s），老值：%s，新值：%s\n",
16                      event.getPropertyName(),
17                      event.getSource(),
18                      event.getOldValue(),
19                      event.getNewValue()
20              );
21          });
22          person.addVetoableChangeListener(event -> {
23              String newValue = valueOf(event.getNewValue());
24              if (isNumeric(newValue)) {
25                  throw new PropertyVetoException(
26                          format("当前属性[%s]的新值[%s]不合法，不能为纯数字!", event.getPropertyName(), newValue), event);
27              }
28          });
<span onclick='openModal()' class='match'>29          Thread.setDefaultUncaughtExceptionHandler((t, e) -> {
30              e.printStackTrace();
31          });
32          person.setName("小马哥");
33          System.out.println("当前 person.name = " + person.getName());
34          person.setName("mercyblitz");
35          System.out.println("当前 person.name = " + person.getName());
36          person.setName("12345");
37          System.out.println("当前 person.name = " + person.getName());
</span>38      }
39  }
</code></pre>
        </div>
        <div class="column">
            <h3>ribbon-MDEwOlJlcG9zaXRvcnk3NjE2MTU4-flat-DiscoveryEnabledLoadBalancerSupportsUseIpAddrTest.java</h3>
            <pre><code>1  package com.netflix.niws.loadbalancer;
2  import static org.easymock.EasyMock.expect;
3  import static org.powermock.api.easymock.PowerMock.createMock;
4  import static org.powermock.api.easymock.PowerMock.replay;
5  import static org.powermock.api.easymock.PowerMock.verify;
6  import java.util.ArrayList;
7  import java.util.List;
8  import org.junit.After;
9  import org.junit.Assert;
10  import org.junit.Before;
11  import org.junit.Test;
12  import org.junit.runner.RunWith;
13  import org.powermock.api.easymock.PowerMock;
14  import org.powermock.core.classloader.annotations.PowerMockIgnore;
15  import org.powermock.core.classloader.annotations.PrepareForTest;
16  import org.powermock.modules.junit4.PowerMockRunner;
17  import com.netflix.appinfo.InstanceInfo;
18  import com.netflix.client.config.DefaultClientConfigImpl;
19  import com.netflix.config.ConfigurationManager;
20  import com.netflix.discovery.DiscoveryClient;
21  import com.netflix.discovery.DiscoveryManager;
22  import com.netflix.loadbalancer.Server;
23  @RunWith(PowerMockRunner.class)
24  @PrepareForTest( {DiscoveryManager.class, DiscoveryClient.class} )
25  @PowerMockIgnore("javax.management.*")
26  @SuppressWarnings("PMD.AvoidUsingHardCodedIP")
27  public class DiscoveryEnabledLoadBalancerSupportsUseIpAddrTest {
28  	static final String IP1 = "1.1.1.1";
29  	static final String HOST1 = "server1.app.host.com";
30  	static final String IP2 = "1.1.1.2";
31  	static final String HOST2 = "server1.app.host.com";
32      @Before
33      public void setupMock(){
34          List<InstanceInfo> servers = LoadBalancerTestUtils.getDummyInstanceInfo("dummy", HOST1, IP1, 8080);
35          List<InstanceInfo> servers2 = LoadBalancerTestUtils.getDummyInstanceInfo("dummy", HOST2, IP2, 8080);
36          servers.addAll(servers2);
37          PowerMock.mockStatic(DiscoveryManager.class);
38          PowerMock.mockStatic(DiscoveryClient.class);
39          DiscoveryClient mockedDiscoveryClient = LoadBalancerTestUtils.mockDiscoveryClient();
<span onclick='openModal()' class='match'>40          DiscoveryManager mockedDiscoveryManager = createMock(DiscoveryManager.class);
41          expect(DiscoveryManager.getInstance()).andReturn(mockedDiscoveryManager).anyTimes();
42          expect(mockedDiscoveryManager.getDiscoveryClient()).andReturn(mockedDiscoveryClient).anyTimes();
43          expect(mockedDiscoveryClient.getInstancesByVipAddress("dummy", false, "region")).andReturn(servers).anyTimes();
</span>44          replay(DiscoveryManager.class);
45          replay(DiscoveryClient.class);
46          replay(mockedDiscoveryManager);
47          replay(mockedDiscoveryClient);
48      }
49      private List<Server> testUsesIpAddr(boolean globalSpecified, boolean global, boolean clientSpecified, boolean client) throws Exception{
50      	if (globalSpecified) {
51              ConfigurationManager.getConfigInstance().setProperty("ribbon.UseIPAddrForServer", global);
52      	}
53      	else {
54      		ConfigurationManager.getConfigInstance().clearProperty("ribbon.UseIPAddrForServer");
55      	}
56      	if (clientSpecified) {
57      		ConfigurationManager.getConfigInstance().setProperty("DiscoveryEnabled.testUsesIpAddr.ribbon.UseIPAddrForServer", client);
58      	}
59      	else {
60      		ConfigurationManager.getConfigInstance().clearProperty("DiscoveryEnabled.testUsesIpAddr.ribbon.UseIPAddrForServer");
61      	}
62      	System.out.println("r = " + ConfigurationManager.getConfigInstance().getProperty("ribbon.UseIPAddrForServer"));
63      	System.out.println("d = " + ConfigurationManager.getConfigInstance().getProperty("DiscoveryEnabled.testUsesIpAddr.ribbon.UseIPAddrForServer"));
64          ConfigurationManager.getConfigInstance().setProperty("DiscoveryEnabled.testUsesIpAddr.ribbon.NIWSServerListClassName", DiscoveryEnabledNIWSServerList.class.getName());
65          ConfigurationManager.getConfigInstance().setProperty("DiscoveryEnabled.testUsesIpAddr.ribbon.DeploymentContextBasedVipAddresses", "dummy");
66          ConfigurationManager.getConfigInstance().setProperty("DiscoveryEnabled.testUsesIpAddr.ribbon.TargetRegion", "region");
67          DiscoveryEnabledNIWSServerList deList = new DiscoveryEnabledNIWSServerList("TESTVIP:8080");
68          DefaultClientConfigImpl clientConfig = DefaultClientConfigImpl.class.newInstance();
69          clientConfig.loadProperties("DiscoveryEnabled.testUsesIpAddr");
70          deList.initWithNiwsConfig(clientConfig);
71          List<DiscoveryEnabledServer> serverList = deList.getInitialListOfServers();
72          Assert.assertEquals(2, serverList.size());
73          List<Server> servers = new ArrayList<Server>();
74          for (DiscoveryEnabledServer server : serverList) {
75          	servers.add((Server)server);
76          }
77          return servers;
78      }
79      @Test
80      public void testUsesIpAddrByWhenClientTrueOnly() throws Exception{
81          List<Server> servers = testUsesIpAddr(false, false, true, true);
82          Assert.assertEquals(servers.get(0).getHost(), IP1);
83          Assert.assertEquals(servers.get(1).getHost(), IP2);
84      }
85      @Test
86      public void testUsesIpAddrByWhenClientFalseOnly() throws Exception{
87          List<Server> servers = testUsesIpAddr(false, false, true, false);
88          Assert.assertEquals(servers.get(0).getHost(), HOST1);
89          Assert.assertEquals(servers.get(1).getHost(), HOST2);
90      }
91      @Test
92      public void testUsesIpAddrByWhenGlobalTrueOnly() throws Exception{
93          List<Server> servers = testUsesIpAddr(true, true, false, false);
94          Assert.assertEquals(servers.get(0).getHost(), IP1);
95          Assert.assertEquals(servers.get(1).getHost(), IP2);
96      }
97      @Test
98      public void testUsesIpAddrByWhenGlobalFalseOnly() throws Exception{
99          List<Server> servers = testUsesIpAddr(true, false, false, false);
100          Assert.assertEquals(servers.get(0).getHost(), HOST1);
101          Assert.assertEquals(servers.get(1).getHost(), HOST2);
102      }
103      @Test
104      public void testUsesHostnameByDefault() throws Exception{
105          List<Server> servers = testUsesIpAddr(false, false, false, false);
106          Assert.assertEquals(servers.get(0).getHost(), HOST1);
107          Assert.assertEquals(servers.get(1).getHost(), HOST2);
108      }
109      @After
110      public void afterMock(){
111          verify(DiscoveryManager.class);
112          verify(DiscoveryClient.class);
113      }
114  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from segmentfault-lessons-MDEwOlJlcG9zaXRvcnk5MzE1NzM4MQ==-flat-PersonDemo_4.java</div>
                <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from ribbon-MDEwOlJlcG9zaXRvcnk3NjE2MTU4-flat-DiscoveryEnabledLoadBalancerSupportsUseIpAddrTest.java</div>
                <div class="column column_space"><pre><code>29          Thread.setDefaultUncaughtExceptionHandler((t, e) -> {
30              e.printStackTrace();
31          });
32          person.setName("小马哥");
33          System.out.println("当前 person.name = " + person.getName());
34          person.setName("mercyblitz");
35          System.out.println("当前 person.name = " + person.getName());
36          person.setName("12345");
37          System.out.println("当前 person.name = " + person.getName());
</pre></code></div>
                <div class="column column_space"><pre><code>40          DiscoveryManager mockedDiscoveryManager = createMock(DiscoveryManager.class);
41          expect(DiscoveryManager.getInstance()).andReturn(mockedDiscoveryManager).anyTimes();
42          expect(mockedDiscoveryManager.getDiscoveryClient()).andReturn(mockedDiscoveryClient).anyTimes();
43          expect(mockedDiscoveryClient.getInstancesByVipAddress("dummy", false, "region")).andReturn(servers).anyTimes();
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    