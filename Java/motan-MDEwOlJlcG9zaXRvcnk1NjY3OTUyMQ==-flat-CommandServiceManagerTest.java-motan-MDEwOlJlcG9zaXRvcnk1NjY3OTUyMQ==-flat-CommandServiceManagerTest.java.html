
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 22, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>motan-MDEwOlJlcG9zaXRvcnk1NjY3OTUyMQ==-flat-CommandServiceManagerTest.java</h3>
            <pre><code>1  package com.weibo.api.motan.registry.support.command;
2  import com.google.common.collect.Lists;
3  import com.weibo.api.motan.common.URLParamType;
4  import com.weibo.api.motan.registry.NotifyListener;
5  import com.weibo.api.motan.rpc.URL;
6  import org.hamcrest.BaseMatcher;
7  import org.hamcrest.Description;
8  import org.jmock.Expectations;
9  import org.jmock.integration.junit4.JUnit4Mockery;
10  import org.jmock.lib.legacy.ClassImposteriser;
11  import org.junit.Test;
12  import java.util.ArrayList;
13  import java.util.HashMap;
14  import java.util.List;
15  import java.util.Map;
16  import static org.junit.Assert.*;
17  public class CommandServiceManagerTest {
18      private static JUnit4Mockery mockery = new JUnit4Mockery() {
19          {
20              setImposteriser(ClassImposteriser.INSTANCE);
21          }
22      };
23      @Test
24      public void testStaticCommandParse() {
25          checkStaticCommand(null, false, 0);
26          checkStaticCommand("group0", false, 0);
27          checkStaticCommand("group1", true, 2);
28          checkStaticCommand("group1 , group0", true, 2);
29          checkStaticCommand("group1 , group2 ,group3", true, 4);
30          checkStaticCommand("group1 , group2 ,group0, group3", true, 4);
31      }
32      private void checkStaticCommand(String mixGroups, boolean hasStaticCommand, int expectMergeGroupsSize) {
33          URL refUrl = getDefaultUrl("group0", mixGroups);
34          CommandServiceManager manager = new CommandServiceManager(refUrl);
35          RpcCommand command = manager.getStaticCommand();
36          if (hasStaticCommand) {
37              assertNotNull("should has static command", command);
38              assertEquals("merge group size", expectMergeGroupsSize, command.getClientCommandList().get(0).getMergeGroups().size());
39          } else {
40              assertNull("should not has static command", command);
41          }
42      }
43      @Test
44      public void notifyService() throws Exception {
45          checkNotifyService("testNotifyService-1", null, null, 2);
46          checkNotifyService("testNotifyService-2", "group1", null, 5);
47          checkNotifyService("testNotifyService-3", null, RpcCommandUtil.commandToString(getDefaultSingleCommand(Lists.newArrayList("group0", "group1"), null)), 5);
48      }
49      private void checkNotifyService(String name, String mixGroups, String dynamicCommand, int expectSize) {
50          URL refUrl = getDefaultUrl("group0", mixGroups);
51          CommandServiceManager manager = getCommandServiceManagerForNotify(name, refUrl, expectSize, true);
52          if (dynamicCommand != null) {
53              manager.setCommandCache(dynamicCommand);
54          }
55          List<URL> notifyList = Lists.newArrayList(refUrl, refUrl);
56          manager.notifyService(refUrl, refUrl, notifyList);
57          Map<String, List<URL>> groupCache = manager.getGroupServiceCache();
58          assertEquals("group result cache size", notifyList.size(), groupCache.get(refUrl.getGroup()).size());
59          mockery.assertIsSatisfied();
60      }
61      private CommandServiceManager getCommandServiceManagerForNotify(String name, URL refUrl, int expectSize, boolean notify) {
62          CommandFailbackRegistry registry = getDefaultRegistry(name, 3, refUrl, "group0", "group1", "group2");
63          CommandServiceManager manager = new CommandServiceManager(refUrl);
64          manager.setRegistry(registry);
65          NotifyListener listener = mockery.mock(NotifyListener.class, name);
66          if (notify) {
67              mockery.checking(new Expectations() {
68                  {
69                      oneOf(listener).notify(with(any(URL.class)), with(new BaseMatcher<List<URL>>() {
70                                  @Override
71                                  public boolean matches(Object o) {
72                                      List<URL> list = (List<URL>) o;
73                                      return list.size() == expectSize;
74                                  }
75                                  @Override
76                                  public void describeTo(Description description) {
77                                  }
78                              })
79                      );
80                  }
81              });
82          }
83          manager.addNotifyListener(listener);
84          return manager;
85      }
86      @Test
87      public void notifyCommand() throws Exception {
88          checkNotifyCommand("checkNotifyCommand-1", null, 0, null, null, false, 0, false);
89          checkNotifyCommand("checkNotifyCommand-2", "group1", 0, null, null, false, 0, false);
90          List<String> groups = Lists.newArrayList("group0", "group1");
91          checkNotifyCommand("checkNotifyCommand-3", null, groups.size(), null, getDefaultSingleCommand(groups, null), true, 0, false);
92          checkNotifyCommand("checkNotifyCommand-4", "group1,group2", groups.size(), null, getDefaultSingleCommand(groups, null), true, 0, false);
93          List<String> oldGroups = Lists.newArrayList("group0:2", "group1:3");
94          List<String> newGroups = Lists.newArrayList("group2");
95          checkNotifyCommand("checkNotifyCommand-5", null, newGroups.size(), getDefaultSingleCommand(oldGroups, null), getDefaultSingleCommand(newGroups, null), true, 2, false);
96          checkNotifyCommand("checkNotifyCommand-6", "group1,group2", newGroups.size(), getDefaultSingleCommand(oldGroups, null), getDefaultSingleCommand(newGroups, null), true, 2, false);
97          oldGroups = Lists.newArrayList("group0:2", "group1:3");
98          newGroups = Lists.newArrayList("group0:2", "group1:3");
99          checkNotifyCommand("checkNotifyCommand-7", null, newGroups.size(), getDefaultSingleCommand(oldGroups, null), getDefaultSingleCommand(newGroups, null), false, 0, false);
100          checkNotifyCommand("checkNotifyCommand-8", "group1,group2", newGroups.size(), getDefaultSingleCommand(oldGroups, null), getDefaultSingleCommand(newGroups, null), false, 0, false);
101          oldGroups = Lists.newArrayList("group1:2", "group2:3");
102          checkNotifyCommand("checkNotifyCommand-9", null, 1, getDefaultSingleCommand(oldGroups, null), null, true, 3, true);
103          checkNotifyCommand("checkNotifyCommand-10", "group1,group2", 3, getDefaultSingleCommand(oldGroups, null), null, true, 0, false);
104      }
105      private void checkNotifyCommand(String name, String mixGroup, int groupSize, RpcCommand oldCommand, RpcCommand newCommand, boolean notify, int unSubscribe, boolean reSub) {
106          URL refUrl = getDefaultUrl("group0", mixGroup);
107          CommandServiceManager manager = getCommandServiceManagerForNotify(name, refUrl, groupSize * 3, notify);
108          if (oldCommand != null) {
109              manager.setCommandCache(RpcCommandUtil.commandToString(oldCommand));
110              manager.discoverServiceWithCommand(new HashMap<>(), manager.getCommandCache());
111          }
112          mockery.checking(new Expectations() {
113              {
114                  if (unSubscribe > 0) {
115                      exactly(unSubscribe).of(manager.getRegistry()).unsubscribeService(with(any(URL.class)), with(any(ServiceListener.class)));
116                  }
117              }
118          });
119          manager.notifyCommand(refUrl, RpcCommandUtil.commandToString(newCommand));
120          assertEquals("dynamic command cache", RpcCommandUtil.commandToString(newCommand), RpcCommandUtil.commandToString(manager.getCommandCache()));
121          assertEquals("group size", groupSize, manager.getGroupServiceCache().size());
122          if (reSub) {
123              assertEquals("group service cache size", 1, manager.getGroupServiceCache().size());
124              assertNotNull(manager.getGroupServiceCache().get(refUrl.getGroup()));
125          }
126          mockery.assertIsSatisfied();
127      }
128      @Test
129      public void discoverServiceWithCommand() throws Exception {
130          checkWithMixGroups(false, false);
131          checkWithMixGroups(true, false);
132          checkWithMixGroups(false, true);
133          checkWithMixGroups(true, true);
134      }
135      private void checkWithMixGroups(boolean withDynamicWeight, boolean withStaticCommand) {
136          CommandFailbackRegistry registry = mockery.mock(CommandFailbackRegistry.class, "mockRegistry" + withDynamicWeight + withStaticCommand);
137          URL refUrl = getDefaultUrl("group0", withStaticCommand ? "group1" : null);
138          CommandServiceManager manager = new CommandServiceManager(refUrl);
139          manager.setRegistry(registry);
140          Map<String, Integer> weights = new HashMap<>();
141          List<String> mergeGroups = new ArrayList<>();
142          mergeGroups.add("group0" + (withDynamicWeight ? ":3" : ""));
143          mergeGroups.add("group1" + (withDynamicWeight ? ":5" : ""));
144          mergeGroups.add("group2" + (withDynamicWeight ? ":2" : ""));
145          RpcCommand command = getDefaultSingleCommand(mergeGroups, null);
146          mockery.checking(new Expectations() {
147              {
148                  URL url1 = refUrl.createCopy();
149                  url1.addParameter(URLParamType.group.getName(), "group1");
150                  URL url2 = refUrl.createCopy();
151                  url2.addParameter(URLParamType.group.getName(), "group2");
152                  oneOf(registry).discoverService(refUrl);
153                  will(returnValue(Lists.newArrayList(refUrl, refUrl)));
154                  oneOf(registry).discoverService(url1);
155                  will(returnValue(Lists.newArrayList(url1, url1)));
156                  oneOf(registry).discoverService(url2);
157                  will(returnValue(Lists.newArrayList(url2, url2)));
158                  oneOf(registry).subscribeService(refUrl, manager);
159                  oneOf(registry).subscribeService(url1, manager);
160                  oneOf(registry).subscribeService(url2, manager);
161              }
162          });
163          int groupSize = mergeGroups.size();
164          List<URL> result = manager.discoverServiceWithCommand(weights, command);
165          assertEquals("result size with dynamic command", withDynamicWeight ? 2 * groupSize + 1 : 2 * groupSize, result.size());
166          assertEquals("weight with dynamic command", groupSize, weights.size());
167          if (withDynamicWeight) {
168              assertEquals("weight rule url check", "rule", result.get(0).getProtocol());
169              assertEquals("weight rule url check", "group0:3,group2:2,group1:5", result.get(0).getParameter(URLParamType.weights.getName()));
170          } else {
171              assertFalse("weight rule url check", "rule".equals(result.get(0).getProtocol()));
172          }
173          weights = new HashMap<>();
174          result = manager.discoverServiceWithCommand(weights, null);
175          if (withStaticCommand) {
176              assertEquals("result size with static command", 4, result.size());
177              assertEquals("weight with static command", 2, weights.size());
178          } else {
179              assertEquals("result size without static command", 2, result.size());
180              assertEquals("weight without static command", 0, weights.size());
181          }
182          mockery.assertIsSatisfied();
183      }
184      @Test
185      public void testRouteRules() {
186          URL refUrl = getDefaultUrl("group0", null);
187          CommandFailbackRegistry registry = mockery.mock(CommandFailbackRegistry.class, "testRouteRules");
188          String[] hosts = {"10.71.1.1", "10.71.2.1", "10.71.1.2", "10.72.1.1", "10.73.1.1", "10.73.2.2", "10.75.1.1"};
189          String[] groups = {"group0", "group1", "group2"};
190          mockery.checking(new Expectations() {
191              {
192                  for (String group : groups) {
193                      URL groupUrl = refUrl.createCopy();
194                      groupUrl.addParameter(URLParamType.group.getName(), group);
195                      List<URL> result = new ArrayList<>();
196                      for (String host : hosts) {
197                          URL url = groupUrl.createCopy();
198                          url.setHost(host);
199                          result.add(url);
200                      }
201                      allowing(registry).discoverService(groupUrl);
202                      will(returnValue(result));
203                  }
204                  allowing(registry).subscribeService(with(any(URL.class)), with(any(ServiceListener.class)));
205              }
206          });
207          CommandServiceManager manager = new CommandServiceManager(refUrl);
208          manager.setRegistry(registry);
209          checkRouteRules(manager, hosts, Lists.newArrayList("* to 10.*"), "10.77.1.1", hosts.length, null);
210          checkRouteRules(manager, hosts, Lists.newArrayList("10.* to 10.*"), "10.77.1.1", hosts.length, null);
<span onclick='openModal()' class='match'>211          checkRouteRules(manager, hosts, Lists.newArrayList("10.77.* to 10.*"), "10.77.1.1", hosts.length, null);
212          checkRouteRules(manager, hosts, Lists.newArrayList("10.77.1.* to 10.*"), "10.77.1.1", hosts.length, null);
</span>213          checkRouteRules(manager, hosts, Lists.newArrayList("10.77.1.* to !10.*"), "10.77.1.1", 0, null);
214          checkRouteRules(manager, hosts, Lists.newArrayList("10.77.1.1 to 10.*"), "10.77.1.1", hosts.length, null);
215          checkRouteRules(manager, hosts, Lists.newArrayList("10.77.1.1 to 10.71.*"), "10.77.1.1", 3, new int[]{3, 4, 5, 6});
216          checkRouteRules(manager, hosts, Lists.newArrayList("!10.77.1.1 to 10.71.*"), "10.77.1.1", hosts.length, null);
217          checkRouteRules(manager, hosts, Lists.newArrayList("10.88.1.1 to 10.71.*"), "10.77.1.1", hosts.length, null);
218          checkRouteRules(manager, hosts, Lists.newArrayList("10.* to 10.71.*"), "10.77.1.1", 3, new int[]{3, 4, 5, 6});
219          checkRouteRules(manager, hosts, Lists.newArrayList("10.* to 10.71.1.*"), "10.77.1.1", 2, new int[]{1, 3, 4, 5, 6});
220          checkRouteRules(manager, hosts, Lists.newArrayList("10.* to !10.71.1.*"), "10.77.1.1", 5, new int[]{0, 2});
221          checkRouteRules(manager, hosts, Lists.newArrayList("10.* to 10.73.1.1"), "10.77.1.1", 1, new int[]{0, 1, 2, 3, 5, 6});
222          checkRouteRules(manager, hosts, Lists.newArrayList("!10.* to 10.73.1.1"), "10.77.1.1", hosts.length, null);
223          checkRouteRules(manager, hosts, Lists.newArrayList("10.* to !10.73.1.1"), "10.77.1.1", 6, new int[]{4});
224          checkRouteRules(manager, hosts, Lists.newArrayList("* to !10.71.*"), "10.78.1.1", 4, new int[]{0, 1, 2});
225      }
226      private void checkRouteRules(CommandServiceManager manager, String[] hosts, List<String> routeRules, String localIp, int expectSize, int[] excludeIndex) {
227          List<URL> result = manager.discoverServiceWithCommand(new HashMap<>(), getDefaultSingleCommand(null, routeRules), localIp);
228          assertEquals("check route rules result size", expectSize, result.size());
229          if (excludeIndex != null) {
230              for (int index : excludeIndex) {
231                  for (URL url : result) {
232                      assertFalse("should exclude url" + hosts[index], url.getHost().equals(hosts[index]));
233                  }
234              }
235          }
236      }
237      private URL getDefaultUrl(String group, String mixGroups) {
238          URL url = new URL("motan", "127.0.0.1", 0, "testService");
239          url.addParameter(URLParamType.group.getName(), group);
240          url.addParameter(URLParamType.mixGroups.getName(), mixGroups);
241          return url;
242      }
243      private RpcCommand getDefaultSingleCommand(List<String> mergeGroups, List<String> routeRules) {
244          RpcCommand command = RpcCommandUtil.stringToCommand(RpcCommandUtilTest.TEST_COMMAND_STRING_1);
245          command.getClientCommandList().get(0).setPattern("*");
246          command.getClientCommandList().get(0).setMergeGroups(mergeGroups);
247          command.getClientCommandList().get(0).setRouteRules(routeRules);
248          return command;
249      }
250      private CommandFailbackRegistry getDefaultRegistry(String name, int notifySize, URL baseUrl, String... groups) {
251          CommandFailbackRegistry registry = mockery.mock(CommandFailbackRegistry.class, "mockRegistry-" + name);
252          mockery.checking(new Expectations() {
253              {
254                  for (String group : groups) {
255                      URL url = baseUrl.createCopy();
256                      url.addParameter(URLParamType.group.getName(), group);
257                      List<URL> result = new ArrayList<>();
258                      for (int i = 0; i < notifySize; i++) {
259                          result.add(url);
260                      }
261                      allowing(registry).discoverService(url);
262                      will(returnValue(result));
263                  }
264                  allowing(registry).subscribeService(with(any(URL.class)), with(any(ServiceListener.class)));
265                  allowing(registry).getUrl();
266                  will(returnValue(new URL("testRegistry", "127.0.0.1", 0, "testRegistry")));
267              }
268          });
269          return registry;
270      }
271  }
</code></pre>
        </div>
        <div class="column">
            <h3>motan-MDEwOlJlcG9zaXRvcnk1NjY3OTUyMQ==-flat-CommandServiceManagerTest.java</h3>
            <pre><code>1  package com.weibo.api.motan.registry.support.command;
2  import com.google.common.collect.Lists;
3  import com.weibo.api.motan.common.URLParamType;
4  import com.weibo.api.motan.registry.NotifyListener;
5  import com.weibo.api.motan.rpc.URL;
6  import org.hamcrest.BaseMatcher;
7  import org.hamcrest.Description;
8  import org.jmock.Expectations;
9  import org.jmock.integration.junit4.JUnit4Mockery;
10  import org.jmock.lib.legacy.ClassImposteriser;
11  import org.junit.Test;
12  import java.util.ArrayList;
13  import java.util.HashMap;
14  import java.util.List;
15  import java.util.Map;
16  import static org.junit.Assert.*;
17  public class CommandServiceManagerTest {
18      private static JUnit4Mockery mockery = new JUnit4Mockery() {
19          {
20              setImposteriser(ClassImposteriser.INSTANCE);
21          }
22      };
23      @Test
24      public void testStaticCommandParse() {
25          checkStaticCommand(null, false, 0);
26          checkStaticCommand("group0", false, 0);
27          checkStaticCommand("group1", true, 2);
28          checkStaticCommand("group1 , group0", true, 2);
29          checkStaticCommand("group1 , group2 ,group3", true, 4);
30          checkStaticCommand("group1 , group2 ,group0, group3", true, 4);
31      }
32      private void checkStaticCommand(String mixGroups, boolean hasStaticCommand, int expectMergeGroupsSize) {
33          URL refUrl = getDefaultUrl("group0", mixGroups);
34          CommandServiceManager manager = new CommandServiceManager(refUrl);
35          RpcCommand command = manager.getStaticCommand();
36          if (hasStaticCommand) {
37              assertNotNull("should has static command", command);
38              assertEquals("merge group size", expectMergeGroupsSize, command.getClientCommandList().get(0).getMergeGroups().size());
39          } else {
40              assertNull("should not has static command", command);
41          }
42      }
43      @Test
44      public void notifyService() throws Exception {
45          checkNotifyService("testNotifyService-1", null, null, 2);
46          checkNotifyService("testNotifyService-2", "group1", null, 5);
47          checkNotifyService("testNotifyService-3", null, RpcCommandUtil.commandToString(getDefaultSingleCommand(Lists.newArrayList("group0", "group1"), null)), 5);
48      }
49      private void checkNotifyService(String name, String mixGroups, String dynamicCommand, int expectSize) {
50          URL refUrl = getDefaultUrl("group0", mixGroups);
51          CommandServiceManager manager = getCommandServiceManagerForNotify(name, refUrl, expectSize, true);
52          if (dynamicCommand != null) {
53              manager.setCommandCache(dynamicCommand);
54          }
55          List<URL> notifyList = Lists.newArrayList(refUrl, refUrl);
56          manager.notifyService(refUrl, refUrl, notifyList);
57          Map<String, List<URL>> groupCache = manager.getGroupServiceCache();
58          assertEquals("group result cache size", notifyList.size(), groupCache.get(refUrl.getGroup()).size());
59          mockery.assertIsSatisfied();
60      }
61      private CommandServiceManager getCommandServiceManagerForNotify(String name, URL refUrl, int expectSize, boolean notify) {
62          CommandFailbackRegistry registry = getDefaultRegistry(name, 3, refUrl, "group0", "group1", "group2");
63          CommandServiceManager manager = new CommandServiceManager(refUrl);
64          manager.setRegistry(registry);
65          NotifyListener listener = mockery.mock(NotifyListener.class, name);
66          if (notify) {
67              mockery.checking(new Expectations() {
68                  {
69                      oneOf(listener).notify(with(any(URL.class)), with(new BaseMatcher<List<URL>>() {
70                                  @Override
71                                  public boolean matches(Object o) {
72                                      List<URL> list = (List<URL>) o;
73                                      return list.size() == expectSize;
74                                  }
75                                  @Override
76                                  public void describeTo(Description description) {
77                                  }
78                              })
79                      );
80                  }
81              });
82          }
83          manager.addNotifyListener(listener);
84          return manager;
85      }
86      @Test
87      public void notifyCommand() throws Exception {
88          checkNotifyCommand("checkNotifyCommand-1", null, 0, null, null, false, 0, false);
89          checkNotifyCommand("checkNotifyCommand-2", "group1", 0, null, null, false, 0, false);
90          List<String> groups = Lists.newArrayList("group0", "group1");
91          checkNotifyCommand("checkNotifyCommand-3", null, groups.size(), null, getDefaultSingleCommand(groups, null), true, 0, false);
92          checkNotifyCommand("checkNotifyCommand-4", "group1,group2", groups.size(), null, getDefaultSingleCommand(groups, null), true, 0, false);
93          List<String> oldGroups = Lists.newArrayList("group0:2", "group1:3");
94          List<String> newGroups = Lists.newArrayList("group2");
95          checkNotifyCommand("checkNotifyCommand-5", null, newGroups.size(), getDefaultSingleCommand(oldGroups, null), getDefaultSingleCommand(newGroups, null), true, 2, false);
96          checkNotifyCommand("checkNotifyCommand-6", "group1,group2", newGroups.size(), getDefaultSingleCommand(oldGroups, null), getDefaultSingleCommand(newGroups, null), true, 2, false);
97          oldGroups = Lists.newArrayList("group0:2", "group1:3");
98          newGroups = Lists.newArrayList("group0:2", "group1:3");
99          checkNotifyCommand("checkNotifyCommand-7", null, newGroups.size(), getDefaultSingleCommand(oldGroups, null), getDefaultSingleCommand(newGroups, null), false, 0, false);
100          checkNotifyCommand("checkNotifyCommand-8", "group1,group2", newGroups.size(), getDefaultSingleCommand(oldGroups, null), getDefaultSingleCommand(newGroups, null), false, 0, false);
101          oldGroups = Lists.newArrayList("group1:2", "group2:3");
102          checkNotifyCommand("checkNotifyCommand-9", null, 1, getDefaultSingleCommand(oldGroups, null), null, true, 3, true);
103          checkNotifyCommand("checkNotifyCommand-10", "group1,group2", 3, getDefaultSingleCommand(oldGroups, null), null, true, 0, false);
104      }
105      private void checkNotifyCommand(String name, String mixGroup, int groupSize, RpcCommand oldCommand, RpcCommand newCommand, boolean notify, int unSubscribe, boolean reSub) {
106          URL refUrl = getDefaultUrl("group0", mixGroup);
107          CommandServiceManager manager = getCommandServiceManagerForNotify(name, refUrl, groupSize * 3, notify);
108          if (oldCommand != null) {
109              manager.setCommandCache(RpcCommandUtil.commandToString(oldCommand));
110              manager.discoverServiceWithCommand(new HashMap<>(), manager.getCommandCache());
111          }
112          mockery.checking(new Expectations() {
113              {
114                  if (unSubscribe > 0) {
115                      exactly(unSubscribe).of(manager.getRegistry()).unsubscribeService(with(any(URL.class)), with(any(ServiceListener.class)));
116                  }
117              }
118          });
119          manager.notifyCommand(refUrl, RpcCommandUtil.commandToString(newCommand));
120          assertEquals("dynamic command cache", RpcCommandUtil.commandToString(newCommand), RpcCommandUtil.commandToString(manager.getCommandCache()));
121          assertEquals("group size", groupSize, manager.getGroupServiceCache().size());
122          if (reSub) {
123              assertEquals("group service cache size", 1, manager.getGroupServiceCache().size());
124              assertNotNull(manager.getGroupServiceCache().get(refUrl.getGroup()));
125          }
126          mockery.assertIsSatisfied();
127      }
128      @Test
129      public void discoverServiceWithCommand() throws Exception {
130          checkWithMixGroups(false, false);
131          checkWithMixGroups(true, false);
132          checkWithMixGroups(false, true);
133          checkWithMixGroups(true, true);
134      }
135      private void checkWithMixGroups(boolean withDynamicWeight, boolean withStaticCommand) {
136          CommandFailbackRegistry registry = mockery.mock(CommandFailbackRegistry.class, "mockRegistry" + withDynamicWeight + withStaticCommand);
137          URL refUrl = getDefaultUrl("group0", withStaticCommand ? "group1" : null);
138          CommandServiceManager manager = new CommandServiceManager(refUrl);
139          manager.setRegistry(registry);
140          Map<String, Integer> weights = new HashMap<>();
141          List<String> mergeGroups = new ArrayList<>();
142          mergeGroups.add("group0" + (withDynamicWeight ? ":3" : ""));
143          mergeGroups.add("group1" + (withDynamicWeight ? ":5" : ""));
144          mergeGroups.add("group2" + (withDynamicWeight ? ":2" : ""));
145          RpcCommand command = getDefaultSingleCommand(mergeGroups, null);
146          mockery.checking(new Expectations() {
147              {
148                  URL url1 = refUrl.createCopy();
149                  url1.addParameter(URLParamType.group.getName(), "group1");
150                  URL url2 = refUrl.createCopy();
151                  url2.addParameter(URLParamType.group.getName(), "group2");
152                  oneOf(registry).discoverService(refUrl);
153                  will(returnValue(Lists.newArrayList(refUrl, refUrl)));
154                  oneOf(registry).discoverService(url1);
155                  will(returnValue(Lists.newArrayList(url1, url1)));
156                  oneOf(registry).discoverService(url2);
157                  will(returnValue(Lists.newArrayList(url2, url2)));
158                  oneOf(registry).subscribeService(refUrl, manager);
159                  oneOf(registry).subscribeService(url1, manager);
160                  oneOf(registry).subscribeService(url2, manager);
161              }
162          });
163          int groupSize = mergeGroups.size();
164          List<URL> result = manager.discoverServiceWithCommand(weights, command);
165          assertEquals("result size with dynamic command", withDynamicWeight ? 2 * groupSize + 1 : 2 * groupSize, result.size());
166          assertEquals("weight with dynamic command", groupSize, weights.size());
167          if (withDynamicWeight) {
168              assertEquals("weight rule url check", "rule", result.get(0).getProtocol());
169              assertEquals("weight rule url check", "group0:3,group2:2,group1:5", result.get(0).getParameter(URLParamType.weights.getName()));
170          } else {
171              assertFalse("weight rule url check", "rule".equals(result.get(0).getProtocol()));
172          }
173          weights = new HashMap<>();
174          result = manager.discoverServiceWithCommand(weights, null);
175          if (withStaticCommand) {
176              assertEquals("result size with static command", 4, result.size());
177              assertEquals("weight with static command", 2, weights.size());
178          } else {
179              assertEquals("result size without static command", 2, result.size());
180              assertEquals("weight without static command", 0, weights.size());
181          }
182          mockery.assertIsSatisfied();
183      }
184      @Test
185      public void testRouteRules() {
186          URL refUrl = getDefaultUrl("group0", null);
187          CommandFailbackRegistry registry = mockery.mock(CommandFailbackRegistry.class, "testRouteRules");
188          String[] hosts = {"10.71.1.1", "10.71.2.1", "10.71.1.2", "10.72.1.1", "10.73.1.1", "10.73.2.2", "10.75.1.1"};
189          String[] groups = {"group0", "group1", "group2"};
190          mockery.checking(new Expectations() {
191              {
192                  for (String group : groups) {
193                      URL groupUrl = refUrl.createCopy();
194                      groupUrl.addParameter(URLParamType.group.getName(), group);
195                      List<URL> result = new ArrayList<>();
196                      for (String host : hosts) {
197                          URL url = groupUrl.createCopy();
198                          url.setHost(host);
199                          result.add(url);
200                      }
201                      allowing(registry).discoverService(groupUrl);
202                      will(returnValue(result));
203                  }
204                  allowing(registry).subscribeService(with(any(URL.class)), with(any(ServiceListener.class)));
205              }
206          });
207          CommandServiceManager manager = new CommandServiceManager(refUrl);
208          manager.setRegistry(registry);
209          checkRouteRules(manager, hosts, Lists.newArrayList("* to 10.*"), "10.77.1.1", hosts.length, null);
210          checkRouteRules(manager, hosts, Lists.newArrayList("10.* to 10.*"), "10.77.1.1", hosts.length, null);
211          checkRouteRules(manager, hosts, Lists.newArrayList("10.77.* to 10.*"), "10.77.1.1", hosts.length, null);
212          checkRouteRules(manager, hosts, Lists.newArrayList("10.77.1.* to 10.*"), "10.77.1.1", hosts.length, null);
213          checkRouteRules(manager, hosts, Lists.newArrayList("10.77.1.* to !10.*"), "10.77.1.1", 0, null);
214          checkRouteRules(manager, hosts, Lists.newArrayList("10.77.1.1 to 10.*"), "10.77.1.1", hosts.length, null);
215          checkRouteRules(manager, hosts, Lists.newArrayList("10.77.1.1 to 10.71.*"), "10.77.1.1", 3, new int[]{3, 4, 5, 6});
<span onclick='openModal()' class='match'>216          checkRouteRules(manager, hosts, Lists.newArrayList("!10.77.1.1 to 10.71.*"), "10.77.1.1", hosts.length, null);
217          checkRouteRules(manager, hosts, Lists.newArrayList("10.88.1.1 to 10.71.*"), "10.77.1.1", hosts.length, null);
</span>218          checkRouteRules(manager, hosts, Lists.newArrayList("10.* to 10.71.*"), "10.77.1.1", 3, new int[]{3, 4, 5, 6});
219          checkRouteRules(manager, hosts, Lists.newArrayList("10.* to 10.71.1.*"), "10.77.1.1", 2, new int[]{1, 3, 4, 5, 6});
220          checkRouteRules(manager, hosts, Lists.newArrayList("10.* to !10.71.1.*"), "10.77.1.1", 5, new int[]{0, 2});
221          checkRouteRules(manager, hosts, Lists.newArrayList("10.* to 10.73.1.1"), "10.77.1.1", 1, new int[]{0, 1, 2, 3, 5, 6});
222          checkRouteRules(manager, hosts, Lists.newArrayList("!10.* to 10.73.1.1"), "10.77.1.1", hosts.length, null);
223          checkRouteRules(manager, hosts, Lists.newArrayList("10.* to !10.73.1.1"), "10.77.1.1", 6, new int[]{4});
224          checkRouteRules(manager, hosts, Lists.newArrayList("* to !10.71.*"), "10.78.1.1", 4, new int[]{0, 1, 2});
225      }
226      private void checkRouteRules(CommandServiceManager manager, String[] hosts, List<String> routeRules, String localIp, int expectSize, int[] excludeIndex) {
227          List<URL> result = manager.discoverServiceWithCommand(new HashMap<>(), getDefaultSingleCommand(null, routeRules), localIp);
228          assertEquals("check route rules result size", expectSize, result.size());
229          if (excludeIndex != null) {
230              for (int index : excludeIndex) {
231                  for (URL url : result) {
232                      assertFalse("should exclude url" + hosts[index], url.getHost().equals(hosts[index]));
233                  }
234              }
235          }
236      }
237      private URL getDefaultUrl(String group, String mixGroups) {
238          URL url = new URL("motan", "127.0.0.1", 0, "testService");
239          url.addParameter(URLParamType.group.getName(), group);
240          url.addParameter(URLParamType.mixGroups.getName(), mixGroups);
241          return url;
242      }
243      private RpcCommand getDefaultSingleCommand(List<String> mergeGroups, List<String> routeRules) {
244          RpcCommand command = RpcCommandUtil.stringToCommand(RpcCommandUtilTest.TEST_COMMAND_STRING_1);
245          command.getClientCommandList().get(0).setPattern("*");
246          command.getClientCommandList().get(0).setMergeGroups(mergeGroups);
247          command.getClientCommandList().get(0).setRouteRules(routeRules);
248          return command;
249      }
250      private CommandFailbackRegistry getDefaultRegistry(String name, int notifySize, URL baseUrl, String... groups) {
251          CommandFailbackRegistry registry = mockery.mock(CommandFailbackRegistry.class, "mockRegistry-" + name);
252          mockery.checking(new Expectations() {
253              {
254                  for (String group : groups) {
255                      URL url = baseUrl.createCopy();
256                      url.addParameter(URLParamType.group.getName(), group);
257                      List<URL> result = new ArrayList<>();
258                      for (int i = 0; i < notifySize; i++) {
259                          result.add(url);
260                      }
261                      allowing(registry).discoverService(url);
262                      will(returnValue(result));
263                  }
264                  allowing(registry).subscribeService(with(any(URL.class)), with(any(ServiceListener.class)));
265                  allowing(registry).getUrl();
266                  will(returnValue(new URL("testRegistry", "127.0.0.1", 0, "testRegistry")));
267              }
268          });
269          return registry;
270      }
271  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from motan-MDEwOlJlcG9zaXRvcnk1NjY3OTUyMQ==-flat-CommandServiceManagerTest.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from motan-MDEwOlJlcG9zaXRvcnk1NjY3OTUyMQ==-flat-CommandServiceManagerTest.java</div>
                </div>
                <div class="column column_space"><pre><code>211          checkRouteRules(manager, hosts, Lists.newArrayList("10.77.* to 10.*"), "10.77.1.1", hosts.length, null);
212          checkRouteRules(manager, hosts, Lists.newArrayList("10.77.1.* to 10.*"), "10.77.1.1", hosts.length, null);
</pre></code></div>
                <div class="column column_space"><pre><code>216          checkRouteRules(manager, hosts, Lists.newArrayList("!10.77.1.1 to 10.71.*"), "10.77.1.1", hosts.length, null);
217          checkRouteRules(manager, hosts, Lists.newArrayList("10.88.1.1 to 10.71.*"), "10.77.1.1", hosts.length, null);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    