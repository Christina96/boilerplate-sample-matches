
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 17, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-RedisJsonV2Test.java</h3>
            <pre><code>1  package redis.clients.jedis.modules.json;
2  import static java.util.Collections.singletonList;
3  import static org.junit.Assert.*;
4  import static redis.clients.jedis.json.Path2.ROOT_PATH;
5  import static redis.clients.jedis.modules.json.JsonObjects.*;
6  import com.google.gson.Gson;
7  import java.util.Arrays;
8  import java.util.Collections;
9  import java.util.List;
10  import org.hamcrest.MatcherAssert;
11  import org.hamcrest.Matchers;
12  import org.json.JSONArray;
13  import org.json.JSONObject;
14  import org.junit.Before;
15  import org.junit.BeforeClass;
16  import org.junit.Test;
17  import redis.clients.jedis.exceptions.JedisDataException;
18  import redis.clients.jedis.json.JsonSetParams;
19  import redis.clients.jedis.json.Path2;
20  import redis.clients.jedis.json.commands.RedisJsonV2Commands;
21  import redis.clients.jedis.modules.RedisModuleCommandsTestBase;
<span onclick='openModal()' class='match'>22  public class RedisJsonV2Test extends RedisModuleCommandsTestBase {
23    private static final Gson gson = new Gson();
24    private RedisJsonV2Commands jsonClient;
</span>25    @BeforeClass
26    public static void prepare() {
27      RedisModuleCommandsTestBase.prepare();
28    }
29    @Before
30    @Override
31    public void setUp() {
32      super.setUp();
33      this.jsonClient = super.client;
34    }
35    @Test
36    public void basicSetGetShouldSucceed() {
37      jsonClient.jsonSetWithEscape("null", ROOT_PATH, (Object) null);
38      assertJsonArrayEquals(jsonArray((Object) null), jsonClient.jsonGet("null", ROOT_PATH));
39      jsonClient.jsonSetWithEscape("str", "strong");
40      assertEquals("strong", jsonClient.jsonGet("str"));
41      IRLObject obj = new IRLObject();
42      jsonClient.jsonSetWithEscape("obj", obj);
43      Object expected = gson.fromJson(gson.toJson(obj), Object.class);
44      assertTrue(expected.equals(jsonClient.jsonGet("obj")));
45      Path2 p = Path2.of(".str");
46      jsonClient.jsonSet("obj", p, gson.toJson("strung"));
47      assertJsonArrayEquals(jsonArray("strung"), jsonClient.jsonGet("obj", p));
48    }
49    @Test
50    public void setExistingPathOnlyIfExistsShouldSucceed() {
51      jsonClient.jsonSetWithEscape("obj", new IRLObject());
52      Path2 p = Path2.of(".str");
53      jsonClient.jsonSetWithEscape("obj", p, "strangle", JsonSetParams.jsonSetParams().xx());
54      assertJsonArrayEquals(jsonArray("strangle"), jsonClient.jsonGet("obj", p));
55    }
56    @Test
57    public void setNonExistingOnlyIfNotExistsShouldSucceed() {
58      jsonClient.jsonSet("obj", gson.toJson(new IRLObject()));
59      Path2 p = Path2.of(".none");
60      jsonClient.jsonSet("obj", p, gson.toJson("strangle"), JsonSetParams.jsonSetParams().nx());
61      assertJsonArrayEquals(jsonArray("strangle"), jsonClient.jsonGet("obj", p));
62    }
63    @Test
64    public void setWithoutAPathDefaultsToRootPath() {
65      String objStr = gson.toJson(new IRLObject());
66      jsonClient.jsonSet("obj1", new JSONObject(objStr));
67      jsonClient.jsonSetWithEscape("obj1", (Object) "strangle", JsonSetParams.jsonSetParams().xx());
68      assertJsonArrayEquals(jsonArray("strangle"), jsonClient.jsonGet("obj1", ROOT_PATH));
69    }
70    @Test
71    public void setExistingPathOnlyIfNotExistsShouldFail() {
72      jsonClient.jsonSetWithEscape("obj", new IRLObject());
73      Path2 p = Path2.of(".str");
74      assertNull(jsonClient.jsonSetWithEscape("obj", p, "strangle", JsonSetParams.jsonSetParams().nx()));
75    }
76    @Test
77    public void setNonExistingPathOnlyIfExistsShouldFail() {
78      jsonClient.jsonSetWithEscape("obj", new IRLObject());
79      Path2 p = Path2.of(".none");
80      assertNull(jsonClient.jsonSetWithEscape("obj", p, "strangle", JsonSetParams.jsonSetParams().xx()));
81    }
82    @Test(expected = JedisDataException.class)
83    public void setException() {
84      jsonClient.jsonSet("test", Path2.of(".foo"), "bar");
85    }
86    @Test
87    public void getMultiplePathsShouldSucceed() {
88      IRLObject obj = new IRLObject();
89      jsonClient.jsonSetWithEscape("obj", obj);
90      JSONObject result = (JSONObject) jsonClient.jsonGet("obj", Path2.of("bool"), Path2.of("str"));
91      assertJsonArrayEquals(jsonArray(true), result.get("$.bool"));
92      assertJsonArrayEquals(jsonArray("string"), result.get("$.str"));
93    }
94    @Test
95    public void getMultiLevels() {
96      JSONObject obj = new JSONObject();
97      obj.put("foo", "John");
98      JSONObject inner = new JSONObject();
99      inner.put("foo", "Jane");
100      obj.put("bar", inner);
101      jsonClient.jsonSet("multi", obj);
102      assertJsonArrayEquals(jsonArray("John", "Jane"), jsonClient.jsonGet("multi", new Path2("..foo")));
103    }
104    @Test
105    public void toggle() {
106      IRLObject obj = new IRLObject();
107      jsonClient.jsonSetWithEscape("obj", obj);
108      Path2 pbool = Path2.of(".bool");
109      assertJsonArrayEquals(jsonArray(true), jsonClient.jsonGet("obj", pbool));
110      jsonClient.jsonToggle("obj", pbool);
111      assertJsonArrayEquals(jsonArray(false), jsonClient.jsonGet("obj", pbool));
112      jsonClient.jsonToggle("obj", pbool);
113      assertJsonArrayEquals(jsonArray(true), jsonClient.jsonGet("obj", pbool));
114      Path2 pstr = Path2.of(".str");
115      assertEquals(singletonList(null), jsonClient.jsonToggle("obj", pstr));
116      assertJsonArrayEquals(jsonArray("string"), jsonClient.jsonGet("obj", pstr));
117    }
118    @Test
119    public void getAbsent() {
120      jsonClient.jsonSetWithEscape("test", ROOT_PATH, "foo");
121      assertJsonArrayEquals(jsonArray(), jsonClient.jsonGet("test", Path2.of(".bar")));
122    }
123    @Test
124    public void delValidShouldSucceed() {
125      jsonClient.jsonSetWithEscape("obj", ROOT_PATH, new IRLObject());
126      assertEquals(1L, jsonClient.jsonDel("obj", Path2.of(".str")));
127      assertTrue(client.exists("obj"));
128      assertEquals(1L, jsonClient.jsonDel("obj"));
129      assertFalse(client.exists("obj"));
130    }
131    @Test
132    public void delNonExistingPathsAreIgnored() {
133      jsonClient.jsonSetWithEscape("foobar", ROOT_PATH, new FooBarObject());
134      assertEquals(0L, jsonClient.jsonDel("foobar", Path2.of(".foo[1]")));
135    }
136    @Test
137    public void typeChecksShouldSucceed() {
138      jsonClient.jsonSet("foobar", ROOT_PATH, new JSONObject(gson.toJson(new FooBarObject())));
139      assertEquals(singletonList(Object.class), jsonClient.jsonType("foobar", ROOT_PATH));
140      assertEquals(singletonList(String.class), jsonClient.jsonType("foobar", Path2.of(".foo")));
141      assertEquals(singletonList(int.class), jsonClient.jsonType("foobar", Path2.of(".fooI")));
142      assertEquals(singletonList(float.class), jsonClient.jsonType("foobar", Path2.of(".fooF")));
143      assertEquals(singletonList(List.class), jsonClient.jsonType("foobar", Path2.of(".fooArr")));
144      assertEquals(singletonList(boolean.class), jsonClient.jsonType("foobar", Path2.of(".fooB")));
145      assertEquals(Collections.emptyList(), jsonClient.jsonType("foobar", Path2.of(".fooErr")));
146    }
147    @Test
148    public void testJsonMerge() {
149      JSONObject json = new JSONObject("{\"person\":{\"name\":\"John Doe\",\"age\":25,\"address\":{\"home\":\"123 Main Street\"},\"phone\":\"123-456-7890\"}}");
150      assertEquals("OK", jsonClient.jsonSet("test_merge", json));
151      json = new JSONObject("{\"person\":{\"name\":\"John Doe\",\"age\":30,\"address\":{\"home\":\"123 Main Street\"},\"phone\":\"123-456-7890\"}}");
152      assertEquals("OK", jsonClient.jsonMerge("test_merge", Path2.of("$"), "{\"person\":{\"age\":30}}"));
153      assertJsonArrayEquals(jsonArray(json), jsonClient.jsonGet("test_merge", Path2.of("$")));
154      assertEquals("OK", jsonClient.jsonMerge("test_merge", Path2.of("$.person.address"), "{\"work\":\"Redis office\"}"));
155      json = new JSONObject("{\"person\":{\"name\":\"John Doe\",\"age\":30,\"address\":{\"home\":\"123 Main Street\",\"work\":\"Redis office\"},\"phone\":\"123-456-7890\"}}");
156      assertJsonArrayEquals(jsonArray(json), jsonClient.jsonGet("test_merge", Path2.of("$")));
157      assertEquals("OK", jsonClient.jsonMerge("test_merge", Path2.of("$.person"), "{\"age\":null}"));
158      json = new JSONObject("{\"person\":{\"name\":\"John Doe\",\"address\":{\"home\":\"123 Main Street\",\"work\":\"Redis office\"},\"phone\":\"123-456-7890\"}}");
159      assertJsonArrayEquals(jsonArray(json), jsonClient.jsonGet("test_merge", Path2.of("$")));
160      assertEquals(1L, client.del("test_merge"));
161    }
162    @Test
163    public void testJsonMergeArray()
164    {
165      JSONObject json = new JSONObject("{\"a\":{\"b\":{\"c\":[\"d\",\"e\"]}}}");
166      assertEquals("OK", jsonClient.jsonSet("test_merge_array", Path2.of("$"), json));
167      assertEquals("OK", jsonClient.jsonMerge("test_merge_array", Path2.of("$.a.b.c"), "[\"f\"]"));
168      json = new JSONObject("{\"a\":{\"b\":{\"c\":[\"f\"]}}}");
169      assertJsonArrayEquals(jsonArray(json), jsonClient.jsonGet("test_merge_array", Path2.of("$")));
170      assertEquals("OK", jsonClient.jsonSet("test_merge_array", Path2.of("$"), "{\"a\":{\"b\":{\"c\":\"d\"}}}"));
171      assertEquals("OK", jsonClient.jsonMerge("test_merge_array", Path2.of("$.a.b.c"), "[\"f\"]"));
172      json = new JSONObject("{\"a\":{\"b\":{\"c\":[\"f\"]}}}");
173      assertJsonArrayEquals(jsonArray(json), jsonClient.jsonGet("test_merge_array", Path2.of("$")));
174      assertEquals("OK", jsonClient.jsonSet("test_merge_array", Path2.of("$"), "{\"a\":{\"b\":{\"c\":[\"d\",\"e\"]}}}"));
175      assertEquals("OK", jsonClient.jsonMerge("test_merge_array", Path2.of("$.a.b"), "{\"c\":null}"));
176      json = new JSONObject("{\"a\":{\"b\":{}}}");
177      assertJsonArrayEquals(jsonArray(json), jsonClient.jsonGet("test_merge_array", Path2.of("$")));
178    }
179    @Test
180    public void mgetWithPathWithAllKeysExist() {
181      Baz baz1 = new Baz("quuz1", "grault1", "waldo1");
182      Baz baz2 = new Baz("quuz2", "grault2", "waldo2");
183      Qux qux1 = new Qux("quux1", "corge1", "garply1", baz1);
184      Qux qux2 = new Qux("quux2", "corge2", "garply2", baz2);
185      jsonClient.jsonSet("qux1", new JSONObject(gson.toJson(qux1)));
186      jsonClient.jsonSet("qux2", new JSONObject(gson.toJson(qux2)));
187      List<JSONArray> list = jsonClient.jsonMGet(Path2.of("baz"), "qux1", "qux2");
188      assertEquals(2, list.size());
189      assertJsonArrayEquals(jsonArray(new JSONObject(gson.toJson(baz1))), list.get(0));
190      assertJsonArrayEquals(jsonArray(new JSONObject(gson.toJson(baz2))), list.get(1));
191    }
192    @Test
193    public void mgetAtRootPathWithMissingKeys() {
194      Baz baz1 = new Baz("quuz1", "grault1", "waldo1");
195      Baz baz2 = new Baz("quuz2", "grault2", "waldo2");
196      Qux qux1 = new Qux("quux1", "corge1", "garply1", baz1);
197      Qux qux2 = new Qux("quux2", "corge2", "garply2", baz2);
198      jsonClient.jsonSetWithEscape("qux1", qux1);
199      jsonClient.jsonSetWithEscape("qux2", qux2);
200      List<JSONArray> list = jsonClient.jsonMGet("qux1", "qux2", "qux3");
201      assertEquals(3, list.size());
202      assertNull(list.get(2));
203      list.removeAll(singletonList(null));
204      assertEquals(2, list.size());
205    }
206    @Test
207    public void arrLen() {
208      jsonClient.jsonSet("arr", ROOT_PATH, new JSONArray(new int[]{0, 1, 2, 3, 4}));
209      assertEquals(singletonList(5L), jsonClient.jsonArrLen("arr", ROOT_PATH));
210    }
211    @Test
212    public void clearArray() {
213      jsonClient.jsonSet("foobar", ROOT_PATH, gson.toJson(new FooBarObject()));
214      Path2 arrPath = Path2.of(".fooArr");
215      assertEquals(singletonList(3L), jsonClient.jsonArrLen("foobar", arrPath));
216      assertEquals(1L, jsonClient.jsonClear("foobar", arrPath));
217      assertEquals(singletonList(0L), jsonClient.jsonArrLen("foobar", arrPath));
218      Path2 strPath = Path2.of(".foo");
219      assertEquals(0L, jsonClient.jsonClear("foobar", strPath));
220      assertJsonArrayEquals(jsonArray("bar"), jsonClient.jsonGet("foobar", strPath));
221    }
222    @Test
223    public void clearObject() {
224      Baz baz = new Baz("quuz", "grault", "waldo");
225      Qux qux = new Qux("quux", "corge", "garply", baz);
226      jsonClient.jsonSet("qux", gson.toJson(qux));
227      Path2 objPath = Path2.of(".baz");
228      assertEquals(1L, jsonClient.jsonClear("qux", objPath));
229      assertJsonArrayEquals(jsonArray(new JSONObject()), jsonClient.jsonGet("qux", objPath));
230    }
231    @Test
232    public void arrAppendSameType() {
233      String json = "{ a: 'hello', b: [1, 2, 3], c: { d: ['ello'] }}";
234      jsonClient.jsonSet("test_arrappend", ROOT_PATH, new JSONObject(json));
235      assertEquals(singletonList(6L), jsonClient.jsonArrAppend("test_arrappend", Path2.of(".b"), 4, 5, 6));
236      assertJsonArrayEquals(jsonArray(jsonArray(1, 2, 3, 4, 5, 6)), jsonClient.jsonGet("test_arrappend", Path2.of(".b")));
237    }
238    @Test
239    public void arrAppendMultipleTypes() {
240      Object fooObject = gson.toJson("foo");
241      Object trueObject = gson.toJson(true);
242      Object nullObject = gson.toJson(null);
243      String json = "{ a: 'hello', b: [1, 2, 3], c: { d: ['ello'] }}";
244      jsonClient.jsonSet("test_arrappend", ROOT_PATH, new JSONObject(json));
245      assertEquals(singletonList(6L), jsonClient.jsonArrAppend("test_arrappend", Path2.of(".b"), fooObject, trueObject, nullObject));
246      assertJsonArrayEquals(jsonArray(jsonArray(1, 2, 3, "foo", true, null)), jsonClient.jsonGet("test_arrappend", Path2.of(".b")));
247    }
248    @Test
249    public void arrAppendMultipleTypesWithDeepPath() {
250      String json = "{ a: 'hello', b: [1, 2, 3], c: { d: ['ello'] }}";
251      jsonClient.jsonSet("test_arrappend", ROOT_PATH, new JSONObject(json));
252      assertEquals(singletonList(4L), jsonClient.jsonArrAppendWithEscape("test_arrappend", Path2.of(".c.d"), "foo", true, null));
253      assertJsonArrayEquals(jsonArray(jsonArray("ello", "foo", true, null)), jsonClient.jsonGet("test_arrappend", Path2.of(".c.d")));
254    }
255    @Test
256    public void arrAppendAgaintsEmptyArray() {
257      String json = "{ a: 'hello', b: [1, 2, 3], c: { d: [] }}";
258      jsonClient.jsonSet("test_arrappend", ROOT_PATH, new JSONObject(json));
259      assertEquals(singletonList(3L), jsonClient.jsonArrAppendWithEscape("test_arrappend", Path2.of(".c.d"), "a", "b", "c"));
260      assertJsonArrayEquals(jsonArray(jsonArray("a", "b", "c")), jsonClient.jsonGet("test_arrappend", Path2.of(".c.d")));
261    }
262    @Test
263    public void arrAppendPathIsNotArray() {
264      String json = "{ a: 'hello', b: [1, 2, 3], c: { d: ['ello'] }}";
265      jsonClient.jsonSet("test_arrappend", ROOT_PATH, new JSONObject(json));
266      assertEquals(singletonList(null), jsonClient.jsonArrAppend("test_arrappend", Path2.of(".a"), 1));
267      assertEquals(singletonList(null), jsonClient.jsonArrAppend("test_arrappend", Path2.of(".a"), gson.toJson(1)));
268      assertEquals(singletonList(null), jsonClient.jsonArrAppendWithEscape("test_arrappend", Path2.of(".a"), 1));
269    }
270    @Test(expected = JedisDataException.class)
271    public void arrIndexAbsentKey() {
272      jsonClient.jsonArrIndexWithEscape("quxquux", ROOT_PATH, new JSONObject());
273    }
274    @Test
275    public void arrIndexWithInts() {
276      jsonClient.jsonSetWithEscape("quxquux", ROOT_PATH, new int[]{8, 6, 7, 5, 3, 0, 9});
277      assertEquals(singletonList(2L), jsonClient.jsonArrIndexWithEscape("quxquux", ROOT_PATH, 7));
278      assertEquals(singletonList(-1L), jsonClient.jsonArrIndexWithEscape("quxquux", ROOT_PATH, "7"));
279    }
280    @Test
281    public void arrIndexWithStrings() {
282      jsonClient.jsonSetWithEscape("quxquux", ROOT_PATH, new String[]{"8", "6", "7", "5", "3", "0", "9"});
283      assertEquals(singletonList(2L), jsonClient.jsonArrIndexWithEscape("quxquux", ROOT_PATH, "7"));
284    }
285    @Test
286    public void arrIndexWithStringsAndPath() {
287      jsonClient.jsonSetWithEscape("foobar", ROOT_PATH, new FooBarObject());
288      assertEquals(singletonList(1L), jsonClient.jsonArrIndexWithEscape("foobar", Path2.of(".fooArr"), "b"));
289    }
290    @Test
291    public void arrIndexNonExistentPath() {
292      jsonClient.jsonSet("foobar", ROOT_PATH, gson.toJson(new FooBarObject()));
293      assertEquals(Collections.emptyList(), jsonClient.jsonArrIndex("foobar", Path2.of(".barArr"), gson.toJson("x")));
294    }
295    @Test
296    public void arrInsert() {
297      String json = "['hello', 'world', true, 1, 3, null, false]";
298      jsonClient.jsonSet("test_arrinsert", ROOT_PATH, new JSONArray(json));
299      assertEquals(singletonList(8L), jsonClient.jsonArrInsertWithEscape("test_arrinsert", ROOT_PATH, 1, "foo"));
300      assertJsonArrayEquals(jsonArray(jsonArray("hello", "foo", "world", true, 1, 3, null, false)),
301          jsonClient.jsonGet("test_arrinsert", ROOT_PATH));
302    }
303    @Test
304    public void arrInsertWithNegativeIndex() {
305      String json = "['hello', 'world', true, 1, 3, null, false]";
306      jsonClient.jsonSet("test_arrinsert", ROOT_PATH, new JSONArray(json));
307      assertEquals(singletonList(8L), jsonClient.jsonArrInsertWithEscape("test_arrinsert", ROOT_PATH, -1, "foo"));
308      assertJsonArrayEquals(jsonArray(jsonArray("hello", "world", true, 1, 3, null, "foo", false)),
309          jsonClient.jsonGet("test_arrinsert", ROOT_PATH));
310    }
311    @Test
312    public void arrPop() {
313      jsonClient.jsonSet("arr", ROOT_PATH, new JSONArray(new int[]{0, 1, 2, 3, 4}));
314      assertEquals(singletonList(4d), jsonClient.jsonArrPop("arr", ROOT_PATH));
315      assertEquals(singletonList(3d), jsonClient.jsonArrPop("arr", ROOT_PATH, -1));
316      assertEquals(singletonList(0d), jsonClient.jsonArrPop("arr", ROOT_PATH, 0));
317    }
318    @Test
319    public void arrTrim() {
320      jsonClient.jsonSet("arr", ROOT_PATH, new JSONArray(new int[]{0, 1, 2, 3, 4}));
321      assertEquals(singletonList(3L), jsonClient.jsonArrTrim("arr", ROOT_PATH, 1, 3));
322      assertJsonArrayEquals(jsonArray(jsonArray(1, 2, 3)), jsonClient.jsonGet("arr", ROOT_PATH));
323    }
324    @Test
325    public void strAppend() {
326      jsonClient.jsonSet("str", ROOT_PATH, gson.toJson("foo"));
327      assertEquals(singletonList(6L), jsonClient.jsonStrAppend("str", ROOT_PATH, "bar"));
328      assertEquals("foobar", jsonClient.jsonGet("str"));
329    }
330    @Test
331    public void strLen() {
332      jsonClient.jsonSetWithEscape("str", "foobar");
333      assertEquals(singletonList(6L), jsonClient.jsonStrLen("str", ROOT_PATH));
334    }
335    @Test
336    public void numIncrBy() {
337      jsonClient.jsonSet("doc", "{\"a\":\"b\",\"b\":[{\"a\":2}, {\"a\":5}, {\"a\":\"c\"}]}");
338      assertJsonArrayEquals(jsonArray((Object) null), jsonClient.jsonNumIncrBy("doc", Path2.of(".a"), 1d));
339      assertJsonArrayEquals(jsonArray(null, 4, 7, null), jsonClient.jsonNumIncrBy("doc", Path2.of("..a"), 2d));
340      assertJsonArrayEquals(jsonArray((Object) null), jsonClient.jsonNumIncrBy("doc", Path2.of("..b"), 0d));
341      assertJsonArrayEquals(jsonArray(), jsonClient.jsonNumIncrBy("doc", Path2.of("..c"), 0d));
342    }
343    @Test
344    public void obj() {
345      String json = "{\"a\":[3], \"nested\": {\"a\": {\"b\":2, \"c\": 1}}}";
346      jsonClient.jsonSet("doc", ROOT_PATH, json);
347      assertEquals(Arrays.asList(2L), jsonClient.jsonObjLen("doc", ROOT_PATH));
348      assertEquals(Arrays.asList(Arrays.asList("a", "nested")), jsonClient.jsonObjKeys("doc", ROOT_PATH));
349      assertEquals(Arrays.asList(null, 2L), jsonClient.jsonObjLen("doc", Path2.of("..a")));
350      assertEquals(Arrays.asList(null, Arrays.asList("b", "c")), jsonClient.jsonObjKeys("doc", Path2.of("..a")));
351    }
352    @Test
353    public void debugMemory() {
354      assertEquals(Collections.emptyList(), jsonClient.jsonDebugMemory("json", ROOT_PATH));
355      jsonClient.jsonSet("json", new JSONObject("{ foo: 'bar', bar: { foo: 10 }}"));
356      assertEquals(1, jsonClient.jsonDebugMemory("json", ROOT_PATH).size());
357      assertEquals(2, jsonClient.jsonDebugMemory("json", Path2.of("$..foo")).size());
358      assertEquals(1, jsonClient.jsonDebugMemory("json", Path2.of("$..bar")).size());
359    }
360    @Test
361    public void resp() {
362      assertNull(jsonClient.jsonResp("resp", ROOT_PATH));
363      String json = "{\"foo\": {\"hello\":\"world\"}, \"bar\": [null, 3, 2.5, true]}";
364      jsonClient.jsonSet("resp", ROOT_PATH, json);
365      List<List<Object>> fullResp = jsonClient.jsonResp("resp", ROOT_PATH);
366      assertEquals(1, fullResp.size());
367      List<Object> resp = fullResp.get(0);
368      assertEquals("{", resp.get(0));
369      assertEquals("foo", resp.get(1));
370      assertEquals(Arrays.asList("{", "hello", "world"), resp.get(2));
371      assertEquals("bar", resp.get(3));
372      List<Object> arr = (List<Object>) resp.get(4);
373      assertEquals("[", arr.get(0));
374      assertNull(arr.get(1));
375      assertEquals(Long.valueOf(3), arr.get(2));
376      MatcherAssert.assertThat(arr.get(3), Matchers.isOneOf("2.5", 2.5));
377      assertEquals("true", arr.get(4));
378    }
379    private void assertJsonArrayEquals(JSONArray a, Object _b) {
380      if (!(_b instanceof JSONArray)) {
381        fail("Actual value is not JSONArray.");
382      }
383      JSONArray b = (JSONArray) _b;
384      assertEquals("JSONArray length mismatch", a.length(), b.length());
385      int length = a.length();
386      for (int index = 0; index < length; index++) {
387        if (a.isNull(index)) {
388          assertTrue(index + "'th element is not null", b.isNull(index));
389          continue;
390        }
391        Object ia = a.get(index);
392        Object ib = b.get(index);
393        if (ia instanceof JSONArray) {
394          assertJsonArrayEquals((JSONArray) ia, ib);
395        } else if (ia instanceof JSONObject) {
396          assertJsonObjectEquals((JSONObject) ia, ib);
397        } else if (ia instanceof Number && ib instanceof Number) {
398          assertEquals(index + "'th element mismatch", ((Number) ia).doubleValue(), ((Number) ib).doubleValue(), 0d);
399        } else {
400          assertEquals(index + "'th element mismatch", ia, ib);
401        }
402      }
403    }
404    private void assertJsonObjectEquals(JSONObject a, Object _b) {
405      if (!(_b instanceof JSONObject)) {
406        fail("Actual value is not JSONObject.");
407      }
408      JSONObject b = (JSONObject) _b;
409      assertEquals("JSONObject length mismatch", a.length(), b.length());
410      assertEquals(a.keySet(), b.keySet());
411      for (String key : a.keySet()) {
412        if (a.isNull(key)) {
413          assertTrue(key + "'s value is not null", b.isNull(key));
414          continue;
415        }
416        Object oa = a.get(key);
417        Object ob = b.get(key);
418        if (oa instanceof JSONArray) {
419          assertJsonArrayEquals((JSONArray) oa, ob);
420        } else if (oa instanceof JSONObject) {
421          assertJsonObjectEquals((JSONObject) oa, ob);
422        } else {
423          assertEquals(key + "'s value mismatch", oa, ob);
424        }
425      }
426    }
427    private static JSONArray jsonArray(Object... objects) {
428      JSONArray arr = new JSONArray();
429      for (Object o : objects) {
430        arr.put(o);
431      }
432      return arr;
433    }
434  }
</code></pre>
        </div>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-RedisModulesPipelineTest.java</h3>
            <pre><code>1  package redis.clients.jedis.modules;
2  import static org.junit.Assert.assertEquals;
3  import static org.junit.Assert.assertNotNull;
4  import static redis.clients.jedis.json.Path.ROOT_PATH;
5  import static redis.clients.jedis.modules.json.JsonObjects.Baz;
6  import static redis.clients.jedis.modules.json.JsonObjects.IRLObject;
7  import static redis.clients.jedis.search.RediSearchUtil.toStringMap;
8  import com.google.gson.Gson;
9  import java.util.HashMap;
10  import java.util.List;
11  import java.util.Map;
12  import java.util.Collections;
13  import org.json.JSONArray;
14  import org.json.JSONObject;
15  import org.junit.BeforeClass;
16  import org.junit.Test;
17  import redis.clients.jedis.Pipeline;
18  import redis.clients.jedis.Response;
19  import redis.clients.jedis.json.JsonSetParams;
20  import redis.clients.jedis.json.Path;
21  import redis.clients.jedis.json.Path2;
22  import redis.clients.jedis.search.*;
23  import redis.clients.jedis.search.aggr.*;
<span onclick='openModal()' class='match'>24  public class RedisModulesPipelineTest extends RedisModuleCommandsTestBase {
25    private static final Gson gson = new Gson();
26    @BeforeClass
</span>27    public static void prepare() {
28      RedisModuleCommandsTestBase.prepare();
29    }
30    @Test
31    public void search() {
32      Schema sc = new Schema().addTextField("title", 1.0).addTextField("body", 1.0);
33      String index = "testindex";
34      Map<String, Object> fields = new HashMap<>();
35      fields.put("title", "hello world");
36      fields.put("body", "lorem ipsum");
37      Pipeline p = (Pipeline) client.pipelined();
38      Response<String> create = p.ftCreate(index, IndexOptions.defaultOptions(), sc);
39      Response<String> alter = p.ftAlter(index, new Schema().addTextField("foo", 1.0));
40      p.hset("doc1", toStringMap(fields));
41      p.hset("doc2", toStringMap(fields));
42      Response<SearchResult> searchResult = p.ftSearch(index, new Query("hello world"));
43      Response<SearchResult> searchBytesResult = p.ftSearch(index.getBytes(), new Query("hello world"));
44      Response<AggregationResult> aggregateResult = p.ftAggregate(index, new AggregationBuilder().groupBy("@title"));
45      Response<String> explain = p.ftExplain(index, new Query("@title:title_val"));
46      Response<List<String>> explainCLI = p.ftExplainCLI(index, new Query("@title:title_val"));
47      Response<Map<String, Object>> info = p.ftInfo(index);
48      Response<String> configSet = p.ftConfigSet("timeout", "100");
49      Response<Map<String, String>> configGet = p.ftConfigGet("*");
50      Response<String> configSetIndex = p.ftConfigSet(index, "timeout", "100");
51      Response<Map<String, String>> configGetIndex = p.ftConfigGet(index, "*");
52      Response<String> synUpdate = p.ftSynUpdate(index, "foo", "bar");
53      Response<Map<String, List<String>>> synDump = p.ftSynDump(index);
54      p.sync();
55      assertEquals("OK", create.get());
56      assertEquals("OK", alter.get());
57      assertEquals("OK", alter.get());
58      assertEquals(2, searchResult.get().getTotalResults());
59      assertEquals(2, searchBytesResult.get().getTotalResults());
60      assertEquals(1, aggregateResult.get().getTotalResults());
61      assertNotNull(explain.get());
62      assertNotNull(explainCLI.get().get(0));
63      assertEquals(index, info.get().get("index_name"));
64      assertEquals("OK", configSet.get());
65      assertEquals("100", configGet.get().get("TIMEOUT"));
66      assertEquals("OK", configSetIndex.get());
67      assertEquals("100", configGetIndex.get().get("TIMEOUT"));
68      assertEquals("OK", synUpdate.get());
69      Map<String, List<String>> expected = new HashMap<>();
70      expected.put("bar", Collections.singletonList("foo"));
71      assertEquals(expected, synDump.get());
72    }
73    @Test
74    public void jsonV1() {
75      Map<String, String> hm1 = new HashMap<>();
76      hm1.put("hello", "world");
77      hm1.put("oh", "snap");
78      Map<String, Object> hm2 = new HashMap<>();
79      hm2.put("array", new String[]{"a", "b", "c"});
80      hm2.put("boolean", true);
81      hm2.put("number", 3);
82      Baz baz1 = new Baz("quuz1", "grault1", "waldo1");
83      Baz baz2 = new Baz("quuz2", "grault2", "waldo2");
84      Baz baz3 = new Baz("quuz3", "grault3", "waldo3");
85      Pipeline p = (Pipeline) client.pipelined();
86      Response<String> set1 = p.jsonSet("foo", Path.ROOT_PATH, hm1);
87      Response<Object> get = p.jsonGet("foo");
88      Response<Map> getObject = p.jsonGet("foo", Map.class);
89      Response<Object> getWithPath = p.jsonGet("foo", Path.ROOT_PATH);
90      Response<Map> getObjectWithPath = p.jsonGet("foo", Map.class, Path.ROOT_PATH);
91      Response<List<JSONArray>> mget = p.jsonMGet("foo");
92      p.jsonSet("baz", new JSONObject(gson.toJson(baz1)));
93      Response<List<Baz>> mgetClass = p.jsonMGet(Path.ROOT_PATH, Baz.class, "baz");
94      Response<Long> strLenPath = p.jsonStrLen("foo", new Path("hello"));
95      Response<Long> strAppPath = p.jsonStrAppend("foo", new Path("hello"), "!");
96      Response<Long> delPath = p.jsonDel("foo", new Path("hello"));
97      Response<Long> delKey = p.jsonDel("foo");
98      Response<String> set2 = p.jsonSet("foo", Path.ROOT_PATH, hm2, new JsonSetParams().nx());
99      Response<Object> popPath = p.jsonArrPop("foo", new Path("array"));
100      Response<Object> indexPop = p.jsonArrPop("foo", new Path("array"), 2);
101      Response<Long> append = p.jsonArrAppend("foo", new Path("array"), "b", "c", "d");
102      Response<Long> index = p.jsonArrIndex("foo", new Path("array"), "c");
103      Response<Long> insert = p.jsonArrInsert("foo", new Path("array"), 0, "x");
104      Response<Long> arrLenWithPath = p.jsonArrLen("foo", new Path("array"));
105      Response<Long> trim = p.jsonArrTrim("foo", new Path("array"), 1, 4);
106      Response<String> toggle = p.jsonToggle("foo", new Path("boolean"));
107      Response<Class<?>> type = p.jsonType("foo", new Path("boolean"));
108      Response<Class<?>> keyType = p.jsonType("foo");
109      Response<Long> clearPath = p.jsonClear("foo", new Path("boolean"));
110      Response<Long> clearKey = p.jsonClear("foo");
111      Response<String> set3 = p.jsonSet("foo", Path.ROOT_PATH, "newStr");
112      Response<Long> strLen = p.jsonStrLen("foo");
113      Response<Long> strApp = p.jsonStrAppend("foo", "?");
114      Response<String> set4 = p.jsonSetWithEscape("obj", new IRLObject());
115      p.jsonSet("arr", ROOT_PATH, new int[]{ 0, 1, 2, 3 });
116      Response<Object> pop = p.jsonArrPop("arr");
117      Response<Long> arrLen = p.jsonArrLen("arr");
118      p.jsonSet("baz", ROOT_PATH, new Baz[]{ baz1, baz2, baz3 });
119      Response<Baz> popClass = p.jsonArrPop("baz", Baz.class);
120      Response<Baz> popClassWithPath = p.jsonArrPop("baz", Baz.class, Path.ROOT_PATH);
121      Response<Baz> popClassWithIndex = p.jsonArrPop("baz", Baz.class, Path.ROOT_PATH, 0);
122      p.sync();
123      assertEquals("OK", set1.get());
124      assertEquals(hm1, get.get());
125      assertEquals(hm1, getObject.get());
126      assertEquals(hm1, getWithPath.get());
127      assertEquals(hm1, getObjectWithPath.get());
128      assertEquals(1, mget.get().size());
129      assertEquals(baz1, mgetClass.get().get(0));
130      assertEquals(Long.valueOf(5), strLenPath.get());
131      assertEquals(Long.valueOf(6), strAppPath.get());
132      assertEquals(Long.valueOf(1), delPath.get());
133      assertEquals(Long.valueOf(1), delKey.get());
134      assertEquals("OK", set2.get());
135      assertEquals("c", popPath.get());
136      assertEquals("b", indexPop.get());
137      assertEquals(Long.valueOf(4), append.get());
138      assertEquals(Long.valueOf(2), index.get());
139      assertEquals(Long.valueOf(5), insert.get());
140      assertEquals(Long.valueOf(5), arrLenWithPath.get());
141      assertEquals(Long.valueOf(4), trim.get());
142      assertEquals("false", toggle.get());
143      assertEquals(boolean.class, type.get());
144      assertEquals(Object.class, keyType.get());
145      assertEquals(Long.valueOf(0), clearPath.get());
146      assertEquals(Long.valueOf(1), clearKey.get());
147      assertEquals("OK", set3.get());
148      assertEquals(Long.valueOf(6), strLen.get());
149      assertEquals(Long.valueOf(7), strApp.get());
150      assertEquals("OK", set4.get());
151      assertEquals(3.0, pop.get());
152      assertEquals(Long.valueOf(3), arrLen.get());
153      assertEquals(baz3, popClass.get());
154      assertEquals(baz2, popClassWithPath.get());
155      assertEquals(baz1, popClassWithIndex.get());
156    }
157    @Test
158    public void jsonV2() {
159      Map<String, String> hm1 = new HashMap<>();
160      hm1.put("hello", "world");
161      hm1.put("oh", "snap");
162      Map<String, Object> hm2 = new HashMap<>();
163      hm2.put("array", new String[]{"a", "b", "c"});
164      hm2.put("boolean", true);
165      hm2.put("number", 3);
166      Pipeline p = (Pipeline) client.pipelined();
167      Response<String> setWithEscape = p.jsonSetWithEscape("foo", Path2.ROOT_PATH, hm1);
168      Response<Object> get = p.jsonGet("foo",  Path2.ROOT_PATH);
169      Response<List<JSONArray>> mget = p.jsonMGet(Path2.ROOT_PATH, "foo");
170      Response<List<Long>> strLen = p.jsonStrLen("foo", new Path2("hello"));
171      Response<List<Long>> strApp = p.jsonStrAppend("foo", new Path2("hello"), "!");
172      Response<Long> del = p.jsonDel("foo", new Path2("hello"));
173      Response<String> set = p.jsonSet("bar", Path2.ROOT_PATH, gson.toJson("strung"));
174      Response<String> setWithParams = p.jsonSet("foo", Path2.ROOT_PATH, gson.toJson(hm2), new JsonSetParams().xx());
175      Response<String> setWithEscapeWithParams = p.jsonSetWithEscape("foo", Path2.ROOT_PATH, hm2, new JsonSetParams().xx());
176      Response<List<Object>> pop = p.jsonArrPop("foo", new Path2("array"));
177      Response<List<Object>> popWithIndex = p.jsonArrPop("foo", new Path2("array"), 2);
178      Response<List<Long>> append = p.jsonArrAppend("foo", Path2.of("$.array"), gson.toJson("b"), gson.toJson("d"));
179      Response<List<Long>> appendWithEscape = p.jsonArrAppendWithEscape("foo", Path2.of("$.array"), "e");
180      Response<List<Long>> index = p.jsonArrIndex("foo", Path2.of("$.array"), gson.toJson("b"));
181      Response<List<Long>> indexWithEscape = p.jsonArrIndexWithEscape("foo", Path2.of("$.array"), "b");
182      Response<List<Long>> insert = p.jsonArrInsert("foo", new Path2("array"), 0, gson.toJson("x"));
183      Response<List<Long>> insertWithEscape = p.jsonArrInsertWithEscape("foo", new Path2("array"), 0, "x");
184      Response<List<Long>> arrLen = p.jsonArrLen("foo", new Path2("array"));
185      Response<List<Long>> trim = p.jsonArrTrim("foo", new Path2("array"), 1, 2);
186      Response<List<Boolean>> toggle = p.jsonToggle("foo", new Path2("boolean"));
187      Response<List<Class<?>>> type = p.jsonType("foo", new Path2("boolean"));
188      Response<Long> clear = p.jsonClear("foo", new Path2("array"));
189      p.sync();
190      assertEquals("OK", setWithEscape.get());
191      assertNotNull(get.get());
192      assertEquals(1, mget.get().size());
193      assertEquals(Long.valueOf(5), strLen.get().get(0));
194      assertEquals(1, strApp.get().size());
195      assertEquals(Long.valueOf(1), del.get());
196      assertEquals("OK", set.get());
197      assertEquals("OK", setWithParams.get());
198      assertEquals("OK", setWithEscapeWithParams.get());
199      assertEquals("c", pop.get().get(0));
200      assertEquals("b", popWithIndex.get().get(0));
201      assertEquals(Long.valueOf(3), append.get().get(0));
202      assertEquals(Long.valueOf(4), appendWithEscape.get().get(0));
203      assertEquals(Long.valueOf(1), index.get().get(0));
204      assertEquals(Long.valueOf(1), indexWithEscape.get().get(0));
205      assertEquals(Long.valueOf(5), insert.get().get(0));
206      assertEquals(Long.valueOf(6), insertWithEscape.get().get(0));
207      assertEquals(Long.valueOf(6), arrLen.get().get(0));
208      assertEquals(Long.valueOf(2), trim.get().get(0));
209      assertEquals(false, toggle.get().get(0));
210      assertEquals(boolean.class, type.get().get(0));
211      assertEquals(Long.valueOf(1), clear.get());
212    }
213  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-RedisJsonV2Test.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-RedisModulesPipelineTest.java</div>
                </div>
                <div class="column column_space"><pre><code>22  public class RedisJsonV2Test extends RedisModuleCommandsTestBase {
23    private static final Gson gson = new Gson();
24    private RedisJsonV2Commands jsonClient;
</pre></code></div>
                <div class="column column_space"><pre><code>24  public class RedisModulesPipelineTest extends RedisModuleCommandsTestBase {
25    private static final Gson gson = new Gson();
26    @BeforeClass
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    