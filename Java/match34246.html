<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for UnixDomainSocketAcceptanceTest.java &amp; DurabilityTest.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for UnixDomainSocketAcceptanceTest.java &amp; DurabilityTest.java
      </h3>
<h1 align="center">
        8.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>UnixDomainSocketAcceptanceTest.java (14.215686%)<th>DurabilityTest.java (6.1965814%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(21-42)<td><a href="#" name="0">(21-39)</a><td align="center"><font color="#ff0000">17</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(119-128)<td><a href="#" name="1">(118-125)</a><td align="center"><font color="#b40000">12</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>UnixDomainSocketAcceptanceTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>package com.allanbank.mongodb.acceptance;
2 import static org.junit.Assume.assumeNoException;
3 import static org.junit.Assume.assumeTrue;
4 import java.io.File;
5 import java.io.FileOutputStream;
6 import java.io.InputStream;
7 import java.net.InetAddress;
8 import java.net.InetSocketAddress;
9 import java.net.Socket;
10 import java.net.SocketException;
11 import java.net.URL;
12 import java.net.URLClassLoader;
13 import javax.net.SocketFactory;
14 import org.junit.AfterClass;
15 import org.junit.BeforeClass;
16 import com.allanbank.mongodb.MongoClientConfiguration;
17 import</b></font> com.allanbank.mongodb.util.IOUtils;
18 public class UnixDomainSocketAcceptanceTest
19         extends BasicAcceptanceTestCases {
20     public static final File JAR_FILE;
21     public static final String LAST_JUNIXSOCKET_RELEASE;
22     public static final String LAST_JUNIXSOCKET_RELEASE_FILE;
23     public static final File LIB_DIR;
24     public static final File TAR_FILE;
25     protected static URLClassLoader ourJUnixSocketLibClassLoader = null;
26     protected static InetSocketAddress ourSocketAddress = null;
27     static {
28         LAST_JUNIXSOCKET_RELEASE = "junixsocket-1.3";
29         LAST_JUNIXSOCKET_RELEASE_FILE = LAST_JUNIXSOCKET_RELEASE
30                 + "-bin.tar.bz2";
31         TAR_FILE = new File("target/" + LAST_JUNIXSOCKET_RELEASE_FILE);
32         LIB_DIR = new File("target/" + LAST_JUNIXSOCKET_RELEASE
33                 + "/lib-native/");
34         JAR_FILE = new File("target/" + LAST_JUNIXSOCKET_RELEASE + "/dist/"
35                 + LAST_JUNIXSOCKET_RELEASE + ".jar");
36     }
37     @BeforeClass
38     public static void startServer() {
39         startStandAlone();
40         buildLargeCollection();
41         FileOutputStream out = null;
42         InputStream in = null;
43         try {
44             if (TAR_FILE.exists()) {
45                 TAR_FILE.delete();
46             }
47             final URL url = new URL("http://junixsocket.googlecode.com/files/"
48                     + LAST_JUNIXSOCKET_RELEASE_FILE);
49             out = new FileOutputStream(TAR_FILE);
50             in = url.openStream();
51             final byte[] buffer = new byte[4096];
52             int read = 0;
53             while (0 &lt;= read) {
54                 out.write(buffer, 0, read);
55                 read = in.read(buffer);
56             }
57             out.flush();
58             out.close();
59 <a name="1"></a>
60             final ProcessBuilder builder = new ProcessBuilder("tar", "xfj",
61                     <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>TAR_FILE.getCanonicalPath());
62             builder.directory(TAR_FILE.getParentFile());
63             final Process untar = builder.start();
64             untar.waitFor();
65             assumeTrue(LIB_DIR.isDirectory());
66             assumeTrue(JAR_FILE.isFile());
67             System.setProperty("org.newsclub.net.unix.library.path",
68                     LIB_DIR.getCanonicalPath</b></font>());
69             ourJUnixSocketLibClassLoader = new URLClassLoader(
70                     new URL[] { JAR_FILE.toURI().toURL() });
71             final Class&lt;?&gt; clazz = ourJUnixSocketLibClassLoader
72                     .loadClass("org.newsclub.net.unix.AFUNIXSocketAddress");
73             ourSocketAddress = (InetSocketAddress) clazz.getConstructor(
74                     File.class)
75                     .newInstance(new File("/tmp/mongodb-27017.sock"));
76         }
77         catch (final Exception e) {
78             e.printStackTrace();
79             assumeNoException(e);
80         }
81         finally {
82             IOUtils.close(out);
83             IOUtils.close(in);
84         }
85     }
86     @AfterClass
87     public static void stopServer() {
88         ourSocketAddress = null;
89         ourJUnixSocketLibClassLoader = null;
90         System.clearProperty("org.newsclub.net.unix.library.path");
91         ourClusterTestSupport.delete(new File(TAR_FILE.getParentFile(),
92                 LAST_JUNIXSOCKET_RELEASE));
93         stopStandAlone();
94         if (TAR_FILE.exists()) {
95             TAR_FILE.delete();
96         }
97     }
98     @Override
99     protected MongoClientConfiguration initConfig() {
100         super.initConfig();
101         myConfig.addServer(ourSocketAddress);
102         myConfig.setSocketFactory(new UnixDomainSocketFactory());
103         return myConfig;
104     }
105     public static class UnixDomainSocketFactory
106             extends SocketFactory {
107         @Override
108         public Socket createSocket() throws java.io.IOException {
109             try {
110                 final Class&lt;?&gt; clazz = ourJUnixSocketLibClassLoader
111                         .loadClass("org.newsclub.net.unix.AFUNIXSocket");
112                 return (Socket) clazz.getMethod("newInstance").invoke(null);
113             }
114             catch (final Exception error) {
115                 final SocketException socketError = new SocketException(
116                         error.getMessage());
117                 socketError.initCause(error);
118                 throw socketError;
119             }
120         }
121         @Override
122         public Socket createSocket(final InetAddress host, final int port)
123                 throws SocketException {
124             throw new SocketException(
125                     "AFUNIX socket does not support connections to a host/port");
126         }
127         @Override
128         public Socket createSocket(final InetAddress address, final int port,
129                 final InetAddress localAddress, final int localPort)
130                 throws SocketException {
131             throw new SocketException(
132                     "AFUNIX socket does not support connections to a host/port");
133         }
134         @Override
135         public Socket createSocket(final String host, final int port)
136                 throws SocketException {
137             throw new SocketException(
138                     "AFUNIX socket does not support connections to a host/port");
139         }
140         @Override
141         public Socket createSocket(final String host, final int port,
142                 final InetAddress localHost, final int localPort)
143                 throws SocketException {
144             throw new SocketException(
145                     "AFUNIX socket does not support connections to a host/port");
146         }
147     }
148 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>DurabilityTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>package com.allanbank.mongodb;
2 import static org.hamcrest.CoreMatchers.instanceOf;
3 import static org.hamcrest.CoreMatchers.sameInstance;
4 import static org.junit.Assert.assertEquals;
5 import static org.junit.Assert.assertFalse;
6 import static org.junit.Assert.assertNull;
7 import static org.junit.Assert.assertSame;
8 import static org.junit.Assert.assertThat;
9 import static org.junit.Assert.assertTrue;
10 import java.io.ByteArrayInputStream;
11 import java.io.ByteArrayOutputStream;
12 import java.io.IOException;
13 import java.io.ObjectInputStream;
14 import java.io.ObjectOutputStream;
15 import java.util.ArrayList;
16 import java.util.Arrays;
17 import</b></font> java.util.List;
18 import java.util.Random;
19 import org.junit.Test;
20 import com.allanbank.mongodb.bson.builder.BuilderFactory;
21 import com.allanbank.mongodb.bson.builder.DocumentBuilder;
22 import com.allanbank.mongodb.bson.impl.ImmutableDocument;
23 public class DurabilityTest {
24     @Test
25     public void testAsDocument() {
26         final DocumentBuilder builder = BuilderFactory.start();
27         builder.add("getlasterror", 1);
28         assertEquals(builder.asDocument(), Durability.NONE.asDocument());
29         builder.reset();
30         builder.add("getlasterror", 1);
31         builder.add("w", 1);
32         assertEquals(builder.asDocument(), Durability.ACK.asDocument());
33         builder.reset();
34         builder.add("getlasterror", 1);
35         builder.add("fsync", true);
36         builder.add("wtimeout", 123);
37         assertEquals(builder.asDocument(), Durability.fsyncDurable(123)
38                 .asDocument());
39         builder.reset();
40         builder.add("getlasterror", 1);
41         builder.add("j", true);
42         builder.add("wtimeout", 124);
43         assertEquals(builder.asDocument(), Durability.journalDurable(124)
44                 .asDocument());
45         builder.reset();
46         builder.add("getlasterror", 1);
47         builder.add("wtimeout", 125);
48         builder.add("w", 2);
49         assertEquals(builder.asDocument(), Durability.replicaDurable(125)
50                 .asDocument());
51         builder.reset();
52         builder.add("getlasterror", 1);
53         builder.add("wtimeout", 126);
54         builder.add("w", 3);
55         assertEquals(builder.asDocument(), Durability.replicaDurable(3, 126)
56                 .asDocument());
57         builder.reset();
58         builder.add("getlasterror", 1);
59         builder.add("wtimeout", 127);
60         builder.add("w", "foo");
61         assertEquals(builder.asDocument(), Durability
62                 .replicaDurable("foo", 127).asDocument());
63         builder.reset();
64         builder.add("getlasterror", 1);
65         builder.add("j", true);
66         builder.add("wtimeout", 128);
67         builder.add("w", "bar");
68         assertEquals(builder.asDocument(),
69                 Durability.replicaDurable(true, "bar", 128).asDocument());
70         builder.reset();
71         builder.add("getlasterror", 1);
72 <a name="1"></a>        builder.add("j", true);
73         builder.add("wtimeout", 129);
74         builder.add("w", 4);
75         assertEquals(<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>builder.asDocument(),
76                 Durability.replicaDurable(true, 4, 129).asDocument());
77         final Durability durability = Durability.replicaDurable(true, 4, 129);
78         assertThat(durability.asDocument(),
79                 sameInstance(durability.asDocument()));
80         assertThat(durability.asDocument(), instanceOf</b></font>(ImmutableDocument.class));
81     }
82     @SuppressWarnings("boxing")
83     @Test
84     public void testEqualsObject() {
85         final List&lt;Durability&gt; objs1 = new ArrayList&lt;Durability&gt;();
86         final List&lt;Durability&gt; objs2 = new ArrayList&lt;Durability&gt;();
87         objs1.add(Durability.NONE);
88         objs2.add(Durability.NONE);
89         objs1.add(Durability.ACK);
90         objs2.add(Durability.ACK);
91         for (final Boolean waitForFsync : Arrays.asList(Boolean.TRUE,
92                 Boolean.FALSE)) {
93             for (final Boolean waitForJournal : Arrays.asList(Boolean.TRUE,
94                     Boolean.FALSE)) {
95                 for (final Integer waitTimeoutMillis : Arrays.asList(1, 2, 3,
96                         4, 10, 100, -1)) {
97                     for (final Integer waitForReplicas : Arrays.asList(1, 2, 3,
98                             4, 10, 100, -1)) {
99                         objs1.add(new Durability(waitForFsync, waitForJournal,
100                                 waitForReplicas, waitTimeoutMillis));
101                         objs2.add(new Durability(waitForFsync, waitForJournal,
102                                 waitForReplicas, waitTimeoutMillis));
103                     }
104                     for (final String mode : Arrays.asList("a", "b")) {
105                         objs1.add(new Durability(waitForFsync, waitForJournal,
106                                 mode, waitTimeoutMillis));
107                         objs2.add(new Durability(waitForFsync, waitForJournal,
108                                 mode, waitTimeoutMillis));
109                     }
110                 }
111             }
112         }
113         assertEquals(objs1.size(), objs2.size());
114         for (int i = 0; i &lt; objs1.size(); ++i) {
115             final Durability obj1 = objs1.get(i);
116             Durability obj2 = objs2.get(i);
117             assertTrue(obj1.equals(obj1));
118             assertEquals(obj1, obj2);
119             assertEquals(obj1.hashCode(), obj2.hashCode());
120             for (int j = i + 1; j &lt; objs1.size(); ++j) {
121                 obj2 = objs2.get(j);
122                 assertFalse(obj1.equals(obj2));
123                 assertFalse(obj1.hashCode() == obj2.hashCode());
124             }
125             assertFalse(obj1.equals("foo"));
126             assertFalse(obj1.equals(null));
127         }
128     }
129     @Test
130     public void testFsyncDurable() {
131         final Random random = new Random(System.currentTimeMillis());
132         final int wait = random.nextInt(100000);
133         final Durability durability = Durability.fsyncDurable(wait);
134         assertTrue(durability.isWaitForFsync());
135         assertFalse(durability.isWaitForJournal());
136         assertTrue(durability.isWaitForReply());
137         assertEquals(wait, durability.getWaitTimeoutMillis());
138         assertEquals(0, durability.getWaitForReplicas());
139         assertNull(durability.getWaitForReplicasByMode());
140     }
141     @Test
142     public void testJournalDurable() {
143         final Random random = new Random(System.currentTimeMillis());
144         final int wait = random.nextInt(100000);
145         final Durability durability = Durability.journalDurable(wait);
146         assertFalse(durability.isWaitForFsync());
147         assertTrue(durability.isWaitForJournal());
148         assertTrue(durability.isWaitForReply());
149         assertEquals(wait, durability.getWaitTimeoutMillis());
150         assertEquals(0, durability.getWaitForReplicas());
151         assertNull(durability.getWaitForReplicasByMode());
152     }
153     @Test
154     public void testReadResolve() throws IOException, ClassNotFoundException {
155         for (final Durability d : Arrays
156                 .asList(Durability.ACK, Durability.NONE)) {
157             final ByteArrayOutputStream out = new ByteArrayOutputStream();
158             final ObjectOutputStream oout = new ObjectOutputStream(out);
159             oout.writeObject(d);
160             oout.close();
161             final ByteArrayInputStream in = new ByteArrayInputStream(
162                     out.toByteArray());
163             final ObjectInputStream oin = new ObjectInputStream(in);
164             assertSame(d, oin.readObject());
165         }
166         final Durability d = Durability.journalDurable(100);
167         final ByteArrayOutputStream out = new ByteArrayOutputStream();
168         final ObjectOutputStream oout = new ObjectOutputStream(out);
169         oout.writeObject(d);
170         oout.close();
171         final ByteArrayInputStream in = new ByteArrayInputStream(
172                 out.toByteArray());
173         final ObjectInputStream oin = new ObjectInputStream(in);
174         final Object read = oin.readObject();
175         assertEquals(d, read);
176         assertFalse(d == read);
177     }
178     @Test
179     public void testReplicaDurableBooleanIntInt() {
180         final Random random = new Random(System.currentTimeMillis());
181         final boolean journal = random.nextBoolean();
182         final int wait = random.nextInt(100000);
183         final int replicaCount = random.nextInt(10000);
184         final Durability durability = Durability.replicaDurable(journal,
185                 replicaCount, wait);
186         assertFalse(durability.isWaitForFsync());
187         assertEquals(Boolean.valueOf(journal),
188                 Boolean.valueOf(durability.isWaitForJournal()));
189         assertTrue(durability.isWaitForReply());
190         assertEquals(wait, durability.getWaitTimeoutMillis());
191         assertEquals(replicaCount, durability.getWaitForReplicas());
192         assertNull(durability.getWaitForReplicasByMode());
193     }
194     @Test
195     public void testReplicaDurableBooleanStringInt() {
196         final Random random = new Random(System.currentTimeMillis());
197         final boolean journal = random.nextBoolean();
198         final int wait = random.nextInt(100000);
199         final String tag = String.valueOf(random.nextInt(10000));
200         final Durability durability = Durability.replicaDurable(journal, tag,
201                 wait);
202         assertFalse(durability.isWaitForFsync());
203         assertEquals(Boolean.valueOf(journal),
204                 Boolean.valueOf(durability.isWaitForJournal()));
205         assertTrue(durability.isWaitForReply());
206         assertEquals(wait, durability.getWaitTimeoutMillis());
207         assertEquals(0, durability.getWaitForReplicas());
208         assertEquals(tag, durability.getWaitForReplicasByMode());
209     }
210     @Test
211     public void testReplicaDurableInt() {
212         final Random random = new Random(System.currentTimeMillis());
213         final int wait = random.nextInt(100000);
214         final Durability durability = Durability.replicaDurable(wait);
215         assertFalse(durability.isWaitForFsync());
216         assertFalse(durability.isWaitForJournal());
217         assertTrue(durability.isWaitForReply());
218         assertEquals(wait, durability.getWaitTimeoutMillis());
219         assertEquals(2, durability.getWaitForReplicas());
220         assertNull(durability.getWaitForReplicasByMode());
221         assertNull(durability.getWaitForReplicasByMode());
222     }
223     @Test
224     public void testReplicaDurableIntInt() {
225         final Random random = new Random(System.currentTimeMillis());
226         final int wait = random.nextInt(100000);
227         final int replicaCount = random.nextInt(10000);
228         final Durability durability = Durability.replicaDurable(replicaCount,
229                 wait);
230         assertFalse(durability.isWaitForFsync());
231         assertFalse(durability.isWaitForJournal());
232         assertTrue(durability.isWaitForReply());
233         assertEquals(wait, durability.getWaitTimeoutMillis());
234         assertEquals(replicaCount, durability.getWaitForReplicas());
235         assertNull(durability.getWaitForReplicasByMode());
236     }
237     @Test
238     public void testReplicaDurableStringInt() {
239         final Random random = new Random(System.currentTimeMillis());
240         final int wait = random.nextInt(100000);
241         final String tag = String.valueOf(random.nextInt(10000));
242         final Durability durability = Durability.replicaDurable(tag, wait);
243         assertFalse(durability.isWaitForFsync());
244         assertFalse(durability.isWaitForJournal());
245         assertTrue(durability.isWaitForReply());
246         assertEquals(wait, durability.getWaitTimeoutMillis());
247         assertEquals(0, durability.getWaitForReplicas());
248         assertEquals(tag, durability.getWaitForReplicasByMode());
249         assertEquals("{ getlasterror : 1, wtimeout : " + wait + ", w : '" + tag
250                 + "' }", durability.toString());
251     }
252     @Test
253     public void testValueOf() {
254         assertSame(Durability.ACK, Durability.valueOf("AcK"));
255         assertSame(Durability.ACK, Durability.valueOf("sAfe"));
256         assertSame(Durability.NONE, Durability.valueOf("NoNe"));
257         assertEquals(Durability.replicaDurable(true, 4, 129),
258                 Durability.valueOf("{ j : true, wtimeout : 129, w : 4 }"));
259         assertEquals(
260                 Durability.replicaDurable(true, "bar", 128),
261                 Durability
262                         .valueOf("{ getlasterror : 1, j : true, wtimeout : 128, w : 'bar' }"));
263         assertEquals(
264                 Durability.replicaDurable(true, "bar", 128),
265                 Durability
266                         .valueOf("{ getlasterror : 1, j : 1, wtimeout : 128, w : bar }"));
267         assertEquals(
268                 Durability.replicaDurable("foo", 127),
269                 Durability
270                         .valueOf("{ getlasterror : 1, wtimeout : 127, w : 'foo' }"));
271         assertEquals(Durability.replicaDurable(3, 126),
272                 Durability
273                         .valueOf("{ getlasterror : 1, wtimeout : 126, w : 3 }"));
274         assertEquals(Durability.replicaDurable(125),
275                 Durability.valueOf("{ wtimeout : 125, w : 2 }"));
276         assertEquals(Durability.journalDurable(124),
277                 Durability.valueOf("{ wtimeout : 124, j : 1 }"));
278         assertEquals(Durability.fsyncDurable(123),
279                 Durability.valueOf("{ wtimeout : 123, fsync : 1 }"));
280         assertNull(Durability.valueOf("{ wtimeout : 'a', fsync : 1 }"));
281         assertNull(Durability.valueOf("{ foo : 1 }"));
282         assertNull(Durability.valueOf("foo"));
283     }
284 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
