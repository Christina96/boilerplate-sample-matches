<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for PerMessageDeflateEncoderTest.java &amp; DefaultHttp2ConnectionEncoderTest.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for PerMessageDeflateEncoderTest.java &amp; DefaultHttp2ConnectionEncoderTest.java
      </h3>
<h1 align="center">
        24.0%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>PerMessageDeflateEncoderTest.java (59.753086%)<th>DefaultHttp2ConnectionEncoderTest.java (15.068493%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(18-49)<td><a href="#" name="0">(51-82)</a><td align="center"><font color="#ff0000">28</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(228-247)<td><a href="#" name="1">(780-792)</a><td align="center"><font color="#e30000">25</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(140-155)<td><a href="#" name="2">(283-299)</a><td align="center"><font color="#d10000">23</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(187-199)<td><a href="#" name="3">(859-870)</a><td align="center"><font color="#b60000">20</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(293-306)<td><a href="#" name="4">(630-639)</a><td align="center"><font color="#ad0000">19</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(61-73)<td><a href="#" name="5">(374-382)</a><td align="center"><font color="#910000">16</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(216-226)<td><a href="#" name="6">(808-812)</a><td align="center"><font color="#7f0000">14</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(264-271)<td><a href="#" name="7">(682-688)</a><td align="center"><font color="#760000">13</font>
<tr onclick='openModal("#c58917")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c58917"><font color="#c58917">-</font><td><a href="#" name="8">(91-103)<td><a href="#" name="8">(716-723)</a><td align="center"><font color="#760000">13</font>
<tr onclick='openModal("#83a33a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#83a33a"><font color="#83a33a">-</font><td><a href="#" name="9">(199-205)<td><a href="#" name="9">(140-145)</a><td align="center"><font color="#6d0000">12</font>
<tr onclick='openModal("#ad5910")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ad5910"><font color="#ad5910">-</font><td><a href="#" name="10">(165-171)<td><a href="#" name="10">(334-338)</a><td align="center"><font color="#640000">11</font>
<tr onclick='openModal("#b041ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#b041ff"><font color="#b041ff">-</font><td><a href="#" name="11">(106-113)<td><a href="#" name="11">(344-351)</a><td align="center"><font color="#640000">11</font>
<tr onclick='openModal("#571b7e")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#571b7e"><font color="#571b7e">-</font><td><a href="#" name="12">(131-139)<td><a href="#" name="12">(121-126)</a><td align="center"><font color="#5b0000">10</font>
<tr onclick='openModal("#3b9c9c")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3b9c9c"><font color="#3b9c9c">-</font><td><a href="#" name="13">(247-250)<td><a href="#" name="13">(130-133)</a><td align="center"><font color="#510000">9</font>
<tr onclick='openModal("#842dce")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#842dce"><font color="#842dce">-</font><td><a href="#" name="14">(173-180)<td><a href="#" name="14">(656-661)</a><td align="center"><font color="#510000">9</font>
<tr onclick='openModal("#f52887")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f52887"><font color="#f52887">-</font><td><a href="#" name="15">(78-85)<td><a href="#" name="15">(339-344)</a><td align="center"><font color="#510000">9</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>PerMessageDeflateEncoderTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 package io.netty.handler.codec.http.websocketx.extensions.compression;
2 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import io.netty.buffer.ByteBuf;
3 import io.netty.buffer.ByteBufUtil;
4 import io.netty.buffer.Unpooled;
5 import io.netty.channel.embedded.EmbeddedChannel;
6 import io.netty.handler.codec.EncoderException;
7 import io.netty.handler.codec.compression.ZlibCodecFactory;
8 import io.netty.handler.codec.compression.ZlibWrapper;
9 import io.netty.handler.codec.http.websocketx.BinaryWebSocketFrame;
10 import io.netty.handler.codec.http.websocketx.ContinuationWebSocketFrame;
11 import io.netty.handler.codec.http.websocketx.TextWebSocketFrame;
12 import io.netty.handler.codec.http.websocketx.WebSocketFrame;
13 import io.netty.handler.codec.http.websocketx.extensions.WebSocketExtension;
14 import io.netty.handler.codec.http.websocketx.extensions.WebSocketExtensionFilter;
15 import org.junit.jupiter.api.Test;
16 import org.junit.jupiter.api.function.Executable;
17 import java.util.Arrays;
18 import java.util.Random;
19 import static io.netty.handler.codec.http.websocketx.extensions.WebSocketExtensionFilter.*;
20 import static io.netty.handler.codec.http.websocketx.extensions.compression.DeflateDecoder.*;
21 import static io.netty.util.CharsetUtil.*;
22 import static org.junit.jupiter.api.Assertions.assertArrayEquals;
23 import static org.junit.jupiter.api.Assertions.assertEquals;
24 import static org.junit.jupiter.api.Assertions.assertFalse;
25 import static org.junit.jupiter.api.Assertions.assertNotNull;
26 import static org.junit.jupiter.api.Assertions.assertThrows;
27 import static org.junit.jupiter.api.Assertions.assertTrue;
28 public class PerMessageDeflateEncoderTest {
29     private static final Random random = new Random()</b></font>;
30     @Test
31     public void testCompressedFrame() {
32         EmbeddedChannel encoderChannel = new EmbeddedChannel(new PerMessageDeflateEncoder(9, 15, false));
33         EmbeddedChannel decoderChannel = new EmbeddedChannel(
34                 ZlibCodecFactory.newZlibDecoder(ZlibWrapper.NONE));
35 <a name="5"></a>        byte[] payload = new byte[300];
36         random.nextBytes(payload);
37         BinaryWebSocketFrame frame = new BinaryWebSocketFrame(true,
38                                                               WebSocketExtension.RSV3, <font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Unpooled.wrappedBuffer(payload));
39         assertTrue(encoderChannel.writeOutbound(frame));
40         BinaryWebSocketFrame compressedFrame = encoderChannel.readOutbound();
41         assertNotNull(compressedFrame);
42         assertNotNull(compressedFrame.content());
43         assertEquals(WebSocketExtension.RSV1 | WebSocketExtension.RSV3, compressedFrame.rsv());
44         assertTrue(decoderChannel.writeInbound(compressedFrame.content()));
45         assertTrue(decoderChannel.writeInbound(DeflateDecoder.FRAME_TAIL.duplicate</b></font>()));
46         ByteBuf uncompressedPayload = decoderChannel.readInbound();
47 <a name="15"></a>        assertEquals(300, uncompressedPayload.readableBytes());
48         byte[] finalPayload = new byte[300];
49         <font color="#f52887"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>uncompressedPayload.readBytes(finalPayload);
50         assertArrayEquals(finalPayload, payload);
51         uncompressedPayload.release();
52     }
53     @Test
54     public void testAlreadyCompressedFrame() {
55         EmbeddedChannel encoderChannel = new EmbeddedChannel(new PerMessageDeflateEncoder(9, 15, false))</b></font>;
56 <a name="8"></a>        byte[] payload = new byte[300];
57         random.nextBytes(payload);
58         <font color="#c58917"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>BinaryWebSocketFrame frame = new BinaryWebSocketFrame(true,
59                                                               WebSocketExtension.RSV3 | WebSocketExtension.RSV1,
60                                                               Unpooled.wrappedBuffer(payload));
61         assertTrue(encoderChannel.writeOutbound(frame));
62         BinaryWebSocketFrame newFrame = encoderChannel.readOutbound();
63         assertNotNull(newFrame);
64         assertNotNull(newFrame.content());
65         assertEquals(WebSocketExtension.RSV3 | WebSocketExtension.RSV1, newFrame.rsv());
66 <a name="11"></a>        assertEquals</b></font>(300, newFrame.content().readableBytes());
67         byte[] finalPayload = new byte[300];
68         <font color="#b041ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newFrame.content().readBytes(finalPayload);
69         assertArrayEquals(finalPayload, payload);
70         newFrame.release();
71     }
72     @Test
73     public void testFragmentedFrame() {
74         EmbeddedChannel encoderChannel = new</b></font> EmbeddedChannel(new PerMessageDeflateEncoder(9, 15, false,
75                                                                                           NEVER_SKIP));
76         EmbeddedChannel decoderChannel = new EmbeddedChannel(
77                 ZlibCodecFactory.newZlibDecoder(ZlibWrapper.NONE));
78         byte[] payload1 = new byte[100];
79         random.nextBytes(payload1);
80         byte[] payload2 = new byte[100];
81         random.nextBytes(payload2);
82         byte[] payload3 = new byte[100];
83         random.nextBytes(payload3);
84         BinaryWebSocketFrame frame1 = new BinaryWebSocketFrame(false,
85                                                                WebSocketExtension.RSV3,
86 <a name="12"></a>                                                               Unpooled.wrappedBuffer(payload1));
87         ContinuationWebSocketFrame frame2 = new ContinuationWebSocketFrame(false,
88                                                                            WebSocketExtension.RSV3,
89                                                                            <font color="#571b7e"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Unpooled.wrappedBuffer(payload2));
90         ContinuationWebSocketFrame frame3 = new ContinuationWebSocketFrame(true,
91                                                                            WebSocketExtension.RSV3,
92                                                                            Unpooled.wrappedBuffer(payload3));
93 <a name="2"></a>        assertTrue(encoderChannel.writeOutbound(frame1));
94         assertTrue(encoderChannel.writeOutbound(frame2));
95         assertTrue(encoderChannel.writeOutbound</b></font>(frame3));
96         BinaryWebSocketFrame compressedFrame1 = <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>encoderChannel.readOutbound();
97         ContinuationWebSocketFrame compressedFrame2 = encoderChannel.readOutbound();
98         ContinuationWebSocketFrame compressedFrame3 = encoderChannel.readOutbound();
99         assertNotNull(compressedFrame1);
100         assertNotNull(compressedFrame2);
101         assertNotNull(compressedFrame3);
102         assertEquals(WebSocketExtension.RSV1 | WebSocketExtension.RSV3, compressedFrame1.rsv());
103         assertEquals(WebSocketExtension.RSV3, compressedFrame2.rsv());
104         assertEquals(WebSocketExtension.RSV3, compressedFrame3.rsv());
105         assertFalse(compressedFrame1.isFinalFragment());
106         assertFalse(compressedFrame2.isFinalFragment());
107         assertTrue(compressedFrame3.isFinalFragment());
108         assertTrue(decoderChannel.writeInbound(compressedFrame1.content</b></font>()));
109         ByteBuf uncompressedPayload1 = decoderChannel.readInbound();
110         byte[] finalPayload1 = new byte[100];
111         uncompressedPayload1.readBytes(finalPayload1);
112         assertArrayEquals(finalPayload1, payload1);
113         uncompressedPayload1.release();
114 <a name="10"></a>        assertTrue(decoderChannel.writeInbound(compressedFrame2.content()));
115         ByteBuf uncompressedPayload2 = decoderChannel.readInbound();
116         byte[] finalPayload2 = new byte[100];
117         <font color="#ad5910"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>uncompressedPayload2.readBytes(finalPayload2);
118         assertArrayEquals(finalPayload2, payload2);
119         uncompressedPayload2.release();
120         assertTrue(decoderChannel.writeInbound(compressedFrame3.content()));
121 <a name="14"></a>        assertTrue(decoderChannel.writeInbound(DeflateDecoder.FRAME_TAIL.duplicate()));
122         ByteBuf uncompressedPayload3 = decoderChannel.readInbound</b></font>();
123         byte[] finalPayload3 = new byte[100];
124         <font color="#842dce"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>uncompressedPayload3.readBytes(finalPayload3);
125         assertArrayEquals(finalPayload3, payload3);
126         uncompressedPayload3.release();
127     }
128     @Test
129     public void testCompressionSkipForBinaryFrame() {
130         EmbeddedChannel encoderChannel = new EmbeddedChannel(new PerMessageDeflateEncoder(9, 15, false,</b></font>
131                                                                                           ALWAYS_SKIP));
132         byte[] payload = new byte[300];
133         random.nextBytes(payload);
134 <a name="3"></a>
135         WebSocketFrame binaryFrame = new BinaryWebSocketFrame(Unpooled.wrappedBuffer(payload));
136         <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertTrue(encoderChannel.writeOutbound(binaryFrame.copy()));
137         WebSocketFrame outboundFrame = encoderChannel.readOutbound();
138         assertEquals(0, outboundFrame.rsv());
139         assertArrayEquals(payload, ByteBufUtil.getBytes(outboundFrame.content()));
140         assertTrue(outboundFrame.release());
141         assertFalse(encoderChannel.finish());
142     }
143 <a name="9"></a>
144     @Test
145     public void testSelectivityCompressionSkip() {
146         WebSocketExtensionFilter selectivityCompressionFilter = <font color="#83a33a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>new WebSocketExtensionFilter() {</b></font>
147             @Override
148             public boolean mustSkip(WebSocketFrame frame) {
149                 return  (frame instanceof TextWebSocketFrame || frame instanceof BinaryWebSocketFrame)
150                     &amp;&amp; frame.content().readableBytes() &lt; 100;
151             }
152         }</b></font>;
153         EmbeddedChannel encoderChannel = new EmbeddedChannel(
154                 new PerMessageDeflateEncoder(9, 15, false, selectivityCompressionFilter));
155         EmbeddedChannel decoderChannel = new EmbeddedChannel(
156                 ZlibCodecFactory.newZlibDecoder(ZlibWrapper.NONE));
157         String textPayload = "not compressed payload";
158         byte[] binaryPayload = new byte[101];
159 <a name="6"></a>        random.nextBytes(binaryPayload);
160         WebSocketFrame textFrame = new TextWebSocketFrame(textPayload);
161         BinaryWebSocketFrame binaryFrame = new BinaryWebSocketFrame(<font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Unpooled.wrappedBuffer(binaryPayload));
162         assertTrue(encoderChannel.writeOutbound(textFrame));
163         assertTrue(encoderChannel.writeOutbound(binaryFrame));
164         WebSocketFrame outboundTextFrame = encoderChannel.readOutbound();
165         //compression skipped for textFrame
166         assertEquals(0, outboundTextFrame.rsv());
167 <a name="1"></a>        assertEquals(textPayload, outboundTextFrame.content().toString(UTF_8));
168         assertTrue(outboundTextFrame.release</b></font>());
169         WebSocketFrame outboundBinaryFrame = <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>encoderChannel.readOutbound();
170         //compression not skipped for binaryFrame
171         assertEquals(WebSocketExtension.RSV1, outboundBinaryFrame.rsv());
172         assertTrue(decoderChannel.writeInbound(outboundBinaryFrame.content().retain()));
173         ByteBuf uncompressedBinaryPayload = decoderChannel.readInbound();
174         assertArrayEquals(binaryPayload, ByteBufUtil.getBytes(uncompressedBinaryPayload));
175         assertTrue(outboundBinaryFrame.release());
176         assertTrue(uncompressedBinaryPayload.release());
177         assertFalse(encoderChannel.finish());
178         assertFalse(decoderChannel.finish());
179     }
180 <a name="13"></a>
181     @Test
182     public void testIllegalStateWhenCompressionInProgress() {
183         WebSocketExtensionFilter selectivityCompressionFilter = <font color="#3b9c9c"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>new WebSocketExtensionFilter() {</b></font>
184             @Override
185             public boolean mustSkip(WebSocketFrame frame) {
186                 return frame.content</b></font>().readableBytes() &lt; 100;
187             }
188         };
189         final EmbeddedChannel encoderChannel = new EmbeddedChannel(
190                 new PerMessageDeflateEncoder(9, 15, false, selectivityCompressionFilter));
191         byte[] firstPayload = new byte[200];
192         random.nextBytes(firstPayload);
193         byte[] finalPayload = new byte[90];
194         random.nextBytes(finalPayload);
195 <a name="7"></a>
196         BinaryWebSocketFrame firstPart = new BinaryWebSocketFrame(false, 0, Unpooled.wrappedBuffer(firstPayload));
197         final ContinuationWebSocketFrame finalPart = new ContinuationWebSocketFrame(true, 0,
198                                                                               <font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Unpooled.wrappedBuffer(finalPayload));
199         assertTrue(encoderChannel.writeOutbound(firstPart));
200         BinaryWebSocketFrame outboundFirstPart = encoderChannel.readOutbound();
201         //first part is compressed
202         assertEquals(WebSocketExtension.RSV1, outboundFirstPart.rsv());
203         assertFalse(Arrays.equals(firstPayload, ByteBufUtil.getBytes(outboundFirstPart.content())));
204         assertTrue(outboundFirstPart.release</b></font>());
205         //final part throwing exception
206         try {
207             assertThrows(EncoderException.class, new Executable() {
208                 @Override
209                 public void execute() throws Throwable {
210                     encoderChannel.writeOutbound(finalPart);
211                 }
212             });
213         } finally {
214             assertTrue(finalPart.release());
215             assertFalse(encoderChannel.finishAndReleaseAll());
216         }
217     }
218     @Test
219     public void testEmptyFrameCompression() {
220         EmbeddedChannel encoderChannel = new EmbeddedChannel(new PerMessageDeflateEncoder(9, 15, false));
221 <a name="4"></a>
222         TextWebSocketFrame emptyFrame = new TextWebSocketFrame("");
223         <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertTrue(encoderChannel.writeOutbound(emptyFrame));
224         TextWebSocketFrame emptyDeflateFrame = encoderChannel.readOutbound();
225         assertEquals(WebSocketExtension.RSV1, emptyDeflateFrame.rsv());
226         assertTrue(ByteBufUtil.equals(EMPTY_DEFLATE_BLOCK, emptyDeflateFrame.content()));
227         assertFalse(emptyDeflateFrame.release());
228         assertFalse(encoderChannel.finish());
229     }
230     @Test
231     public void testCodecExceptionForNotFinEmptyFrame() {
232         final EmbeddedChannel encoderChannel = new EmbeddedChannel(new PerMessageDeflateEncoder(9, 15, false))</b></font>;
233         final TextWebSocketFrame emptyNotFinFrame = new TextWebSocketFrame(false, 0, "");
234         try {
235             assertThrows(EncoderException.class, new Executable() {
236                 @Override
237                 public void execute() {
238                     encoderChannel.writeOutbound(emptyNotFinFrame);
239                 }
240             });
241         } finally {
242             assertFalse(emptyNotFinFrame.release());
243             assertFalse(encoderChannel.finish());
244         }
245     }
246 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>DefaultHttp2ConnectionEncoderTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 package io.netty.handler.codec.http2;
2 import io.netty.buffer.ByteBuf;
3 import io.netty.buffer.PooledByteBufAllocator;
4 import io.netty.buffer.Unpooled;
5 import io.netty.buffer.UnpooledByteBufAllocator;
6 import io.netty.channel.Channel;
7 import io.netty.channel.ChannelConfig;
8 import io.netty.channel.ChannelFuture;
9 import io.netty.channel.ChannelHandlerContext;
10 import io.netty.channel.ChannelMetadata;
11 import io.netty.channel.ChannelPipeline;
12 import io.netty.channel.ChannelPromise;
13 import io.netty.channel.DefaultChannelConfig;
14 import io.netty.channel.DefaultChannelPromise;
15 import io.netty.handler.codec.http.HttpResponseStatus;
16 import io.netty.handler.codec.http2.Http2RemoteFlowController.FlowControlled;
17 import io.netty.util.concurrent.ImmediateEventExecutor;
18 import junit.framework.AssertionFailedError;
19 import org.junit.jupiter.api.BeforeEach;
20 import org.junit.jupiter.api.Test;
21 import org.mockito.ArgumentCaptor;
22 import org.mockito.InOrder;
23 import org.mockito.Mock;
24 import org.mockito.MockitoAnnotations;
25 import org.mockito.invocation.InvocationOnMock;
26 import org.mockito.stubbing.Answer;
27 import java.util.ArrayList;
28 import java.util.List;
29 import static io.netty.buffer.Unpooled.EMPTY_BUFFER;
30 import static io.netty.buffer.Unpooled.wrappedBuffer;
31 <a name="0"></a>import static io.netty.handler.codec.http2.Http2CodecUtil.DEFAULT_PRIORITY_WEIGHT;
32 import static io.netty.handler.codec.http2.Http2Error.PROTOCOL_ERROR;
33 import static io.netty.handler.codec.http2.Http2Stream.State.HALF_CLOSED_REMOTE;
34 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import static io.netty.handler.codec.http2.Http2Stream.State.RESERVED_LOCAL;
35 import static io.netty.handler.codec.http2.Http2TestUtil.newVoidPromise;
36 import static io.netty.util.CharsetUtil.UTF_8;
37 import static org.hamcrest.MatcherAssert.assertThat;
38 import static org.hamcrest.CoreMatchers.instanceOf;
39 import static org.junit.jupiter.api.Assertions.assertEquals;
40 import static org.junit.jupiter.api.Assertions.assertFalse;
41 import static org.junit.jupiter.api.Assertions.assertNull;
42 import static org.junit.jupiter.api.Assertions.assertSame;
43 import static org.junit.jupiter.api.Assertions.assertTrue;
44 import static org.junit.jupiter.api.Assertions.fail;
45 import static org.mockito.Mockito.any;
46 import static org.mockito.Mockito.anyBoolean;
47 import static org.mockito.Mockito.anyInt;
48 import static org.mockito.Mockito.anyLong;
49 import static org.mockito.Mockito.anyShort;
50 import static org.mockito.Mockito.doAnswer;
51 import static org.mockito.Mockito.doNothing;
52 import static org.mockito.Mockito.eq;
53 import static org.mockito.Mockito.inOrder;
54 import static org.mockito.Mockito.mock;
55 import static org.mockito.Mockito.never;
56 import static org.mockito.Mockito.times;
57 import static org.mockito.Mockito.verify;
58 import static org.mockito.Mockito.verifyNoMoreInteractions;
59 import static org.mockito.Mockito.when;
60 public class DefaultHttp2ConnectionEncoderTest {
61     private static final int STREAM_ID = 2</b></font>;
62     private static final int PUSH_STREAM_ID = 4;
63     @Mock
64     private Http2RemoteFlowController remoteFlow;
65     @Mock
66     private ChannelHandlerContext ctx;
67     @Mock
68     private Channel channel;
69     @Mock
70     private Channel.Unsafe unsafe;
71     @Mock
72     private ChannelPipeline pipeline;
73     @Mock
74     private Http2FrameWriter writer;
75     @Mock
76     private Http2FrameWriter.Configuration writerConfig;
77     @Mock
78     private Http2FrameSizePolicy frameSizePolicy;
79     @Mock
80     private Http2LifecycleManager lifecycleManager;
81     private DefaultHttp2ConnectionEncoder encoder;
82     private Http2Connection connection;
83     private ArgumentCaptor&lt;Http2RemoteFlowController.FlowControlled&gt; payloadCaptor;
84     private List&lt;String&gt; writtenData;
85     private List&lt;Integer&gt; writtenPadding;
86     private boolean streamClosed;
87 <a name="12"></a>
88     @BeforeEach
89     public void setup() throws Exception {
90         <font color="#571b7e"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>MockitoAnnotations.initMocks(this);
91         ChannelMetadata metadata = new ChannelMetadata(false, 16);
92         when(channel.isActive()).thenReturn(true);
93         when(channel.pipeline()).thenReturn(pipeline);
94         when(channel.metadata()).thenReturn</b></font>(metadata);
95 <a name="13"></a>        when(channel.unsafe()).thenReturn(unsafe);
96         ChannelConfig config = new DefaultChannelConfig(channel);
97         when(channel.config()).thenReturn(config);
98         doAnswer(<font color="#3b9c9c"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>new Answer&lt;ChannelFuture&gt;() {
99             @Override
100             public ChannelFuture answer(InvocationOnMock in) {
101                 return newPromise</b></font>().setFailure((Throwable) in.getArgument(0));
102             }
103         }).when(channel).newFailedFuture(any(Throwable.class));
104 <a name="9"></a>        when(writer.configuration()).thenReturn(writerConfig);
105         when(writerConfig.frameSizePolicy()).thenReturn(frameSizePolicy);
106         when(frameSizePolicy.maxFrameSize()).thenReturn(64);
107         doAnswer(<font color="#83a33a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>new Answer&lt;ChannelFuture&gt;() {
108             @Override
109             public ChannelFuture answer(InvocationOnMock in) throws Throwable {
110                 return ((ChannelPromise) in.getArguments()[2]).setSuccess();
111             }
112         }</b></font>).when(writer).writeSettings(eq(ctx), any(Http2Settings.class), any(ChannelPromise.class));
113         doAnswer(new Answer&lt;ChannelFuture&gt;() {
114             @Override
115             public ChannelFuture answer(InvocationOnMock in) throws Throwable {
116                 ((ByteBuf) in.getArguments()[3]).release();
117                 return ((ChannelPromise) in.getArguments()[4]).setSuccess();
118             }
119         }).when(writer).writeGoAway(eq(ctx), anyInt(), anyInt(), any(ByteBuf.class), any(ChannelPromise.class));
120         writtenData = new ArrayList&lt;String&gt;();
121         writtenPadding = new ArrayList&lt;Integer&gt;();
122         when(writer.writeData(eq(ctx), anyInt(), any(ByteBuf.class), anyInt(), anyBoolean(),
123                 any(ChannelPromise.class))).then(new Answer&lt;ChannelFuture&gt;() {
124                     @Override
125                     public ChannelFuture answer(InvocationOnMock in) throws Throwable {
126                         ChannelPromise promise = (ChannelPromise) in.getArguments()[5];
127                         if (streamClosed) {
128                             fail("Stream already closed");
129                         } else {
130                             streamClosed = (Boolean) in.getArguments()[4];
131                         }
132                         writtenPadding.add((Integer) in.getArguments()[3]);
133                         ByteBuf data = (ByteBuf) in.getArguments()[2];
134                         writtenData.add(data.toString(UTF_8));
135                         data.release();
136                         return promise.setSuccess();
137                     }
138                 });
139         when(writer.writeHeaders(eq(ctx), anyInt(), any(Http2Headers.class), anyInt(), anyShort(), anyBoolean(),
140                 anyInt(), anyBoolean(), any(ChannelPromise.class)))
141                 .then(new Answer&lt;ChannelFuture&gt;() {
142                     @Override
143                     public ChannelFuture answer(InvocationOnMock invocationOnMock) {
144                         ChannelPromise promise = invocationOnMock.getArgument(8);
145                         if (streamClosed) {
146                             fail("Stream already closed");
147                         } else {
148                             streamClosed = invocationOnMock.getArgument(5);
149                         }
150                         return promise.setSuccess();
151                     }
152                 });
153         when(writer.writeHeaders(eq(ctx), anyInt(), any(Http2Headers.class),
154                 anyInt(), anyBoolean(), any(ChannelPromise.class)))
155                 .then(new Answer&lt;ChannelFuture&gt;() {
156                     @Override
157                     public ChannelFuture answer(InvocationOnMock invocationOnMock) {
158                         ChannelPromise promise = invocationOnMock.getArgument(5);
159                         if (streamClosed) {
160                             fail("Stream already closed");
161                         } else {
162                             streamClosed = invocationOnMock.getArgument(4);
163                         }
164                         return promise.setSuccess();
165                     }
166                 });
167         payloadCaptor = ArgumentCaptor.forClass(Http2RemoteFlowController.FlowControlled.class);
168         doNothing().when(remoteFlow).addFlowControlled(any(Http2Stream.class), payloadCaptor.capture());
169         when(ctx.alloc()).thenReturn(UnpooledByteBufAllocator.DEFAULT);
170         when(ctx.channel()).thenReturn(channel);
171         doAnswer(new Answer&lt;ChannelPromise&gt;() {
172             @Override
173             public ChannelPromise answer(InvocationOnMock in) throws Throwable {
174                 return newPromise();
175             }
176         }).when(ctx).newPromise();
177         doAnswer(new Answer&lt;ChannelFuture&gt;() {
178             @Override
179             public ChannelFuture answer(InvocationOnMock in) throws Throwable {
180                 return newSucceededFuture();
181             }
182         }).when(ctx).newSucceededFuture();
183         when(ctx.flush()).thenThrow(new AssertionFailedError("forbidden"));
184         when(channel.alloc()).thenReturn(PooledByteBufAllocator.DEFAULT);
185         connection = new DefaultHttp2Connection(true);
186         connection.remote().flowController(remoteFlow);
187         encoder = new DefaultHttp2ConnectionEncoder(connection, writer);
188         encoder.lifecycleManager(lifecycleManager);
189     }
190     @Test
191     public void dataWithEndOfStreamWriteShouldSignalThatFrameWasConsumedOnError() throws Exception {
192         dataWriteShouldSignalThatFrameWasConsumedOnError0(true);
193     }
194     @Test
195     public void dataWriteShouldSignalThatFrameWasConsumedOnError() throws Exception {
196         dataWriteShouldSignalThatFrameWasConsumedOnError0(false);
197     }
198     private void dataWriteShouldSignalThatFrameWasConsumedOnError0(boolean endOfStream) throws Exception {
199         createStream(STREAM_ID, false);
200         final ByteBuf data = dummyData();
201         ChannelPromise p = newPromise();
202         encoder.writeData(ctx, STREAM_ID, data, 0, endOfStream, p);
203         FlowControlled controlled = payloadCaptor.getValue();
204         assertEquals(8, controlled.size());
205         payloadCaptor.getValue().write(ctx, 4);
206         assertEquals(4, controlled.size());
207         Throwable error = new IllegalStateException();
208         payloadCaptor.getValue().error(ctx, error);
209         payloadCaptor.getValue().write(ctx, 8);
210         assertEquals(0, controlled.size());
211         assertEquals("abcd", writtenData.get(0));
212         assertEquals(0, data.refCnt());
213         assertSame(error, p.cause());
214     }
215     @Test
216     public void dataWriteShouldSucceed() throws Exception {
217         createStream(STREAM_ID, false);
218         final ByteBuf data = dummyData();
219         ChannelPromise p = newPromise();
220         encoder.writeData(ctx, STREAM_ID, data, 0, true, p);
221         assertEquals(8, payloadCaptor.getValue().size());
222         payloadCaptor.getValue().write(ctx, 8);
223         assertEquals(0, payloadCaptor.getValue().size());
224         assertEquals("abcdefgh", writtenData.get(0));
225         assertEquals(0, data.refCnt());
226         assertTrue(p.isSuccess());
227     }
228     @Test
229     public void dataFramesShouldMerge() throws Exception {
230         createStream(STREAM_ID, false);
231         final ByteBuf data = dummyData().retain();
232 <a name="2"></a>        ChannelPromise promise1 = newPromise();
233         encoder.writeData(ctx, STREAM_ID, data, 0, true, promise1);
234         ChannelPromise promise2 = newPromise();
235         <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>encoder.writeData(ctx, STREAM_ID, data, 0, true, promise2);
236         List&lt;FlowControlled&gt; capturedWrites = payloadCaptor.getAllValues();
237         FlowControlled mergedPayload = capturedWrites.get(0);
238         mergedPayload.merge(ctx, capturedWrites.get(1));
239         assertEquals(16, mergedPayload.size());
240         assertFalse(promise1.isDone());
241         assertFalse(promise2.isDone());
242         mergedPayload.write(ctx, 16);
243         assertEquals(0, mergedPayload.size());
244         assertEquals("abcdefghabcdefgh", writtenData.get(0));
245         assertEquals(0, data.refCnt());
246         assertTrue(promise1.isSuccess());
247         assertTrue</b></font>(promise2.isSuccess());
248     }
249     @Test
250     public void dataFramesShouldMergeUseVoidPromise() throws Exception {
251         createStream(STREAM_ID, false);
252         final ByteBuf data = dummyData().retain();
253         ChannelPromise promise1 = newVoidPromise(channel);
254         encoder.writeData(ctx, STREAM_ID, data, 0, true, promise1);
255         ChannelPromise promise2 = newVoidPromise(channel);
256         encoder.writeData(ctx, STREAM_ID, data, 0, true, promise2);
257         List&lt;FlowControlled&gt; capturedWrites = payloadCaptor.getAllValues();
258         FlowControlled mergedPayload = capturedWrites.get(0);
259         mergedPayload.merge(ctx, capturedWrites.get(1));
260         assertEquals(16, mergedPayload.size());
261         assertFalse(promise1.isSuccess());
262         assertFalse(promise2.isSuccess());
263         mergedPayload.write(ctx, 16);
264         assertEquals(0, mergedPayload.size());
265         assertEquals("abcdefghabcdefgh", writtenData.get(0));
266         assertEquals(0, data.refCnt());
267         assertFalse(promise1.isSuccess());
268         assertFalse(promise2.isSuccess());
269     }
270 <a name="10"></a>    @Test
271     public void dataFramesDontMergeWithHeaders() throws Exception {
272         createStream(STREAM_ID, false);
273         final ByteBuf data = <font color="#ad5910"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>dummyData().retain();
274         encoder.writeData(ctx, STREAM_ID, data, 0, false, newPromise());
275 <a name="15"></a>        when(remoteFlow.hasFlowControlled(any(Http2Stream.class))).thenReturn(true);
276         encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, newPromise());
277         List&lt;FlowControlled&gt; capturedWrites = payloadCaptor.getAllValues</b></font>();
278         assertFalse(<font color="#f52887"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>capturedWrites.get(0).merge(ctx, capturedWrites.get(1)));
279     }
280 <a name="11"></a>
281     @Test
282     public void emptyFrameShouldSplitPadding() throws Exception {
283         ByteBuf data = <font color="#b041ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>Unpooled.buffer(0)</b></font>;
284         assertSplitPaddingOnEmptyBuffer(data);
285         assertEquals(0, data.refCnt());
286     }
287     @Test
288     public void writeHeadersUsingVoidPromise() throws Exception {
289         final Throwable cause = new</b></font> RuntimeException("fake exception");
290         when(writer.writeHeaders(eq(ctx), eq(STREAM_ID), any(Http2Headers.class),
291                                  anyInt(), anyBoolean(), any(ChannelPromise.class)))
292                 .then(new Answer&lt;ChannelFuture&gt;() {
293                     @Override
294                     public ChannelFuture answer(InvocationOnMock invocationOnMock) throws Throwable {
295                         ChannelPromise promise = invocationOnMock.getArgument(5);
296                         assertFalse(promise.isVoid());
297                         return promise.setFailure(cause);
298                     }
299                 });
300         createStream(STREAM_ID, false);
301         encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, newVoidPromise(channel));
302         verify(writer).writeHeaders(eq(ctx), eq(STREAM_ID), any(Http2Headers.class),
303                                     anyInt(), anyBoolean(), any(ChannelPromise.class));
304         verify(pipeline).fireExceptionCaught(cause);
305     }
306 <a name="5"></a>
307     private void assertSplitPaddingOnEmptyBuffer(ByteBuf data) throws Exception {
308         createStream(STREAM_ID, false);
309         <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>when(frameSizePolicy.maxFrameSize()).thenReturn(5);
310         ChannelPromise p = newPromise();
311         encoder.writeData(ctx, STREAM_ID, data, 10, true, p);
312         assertEquals(10, payloadCaptor.getValue().size());
313         payloadCaptor.getValue().write(ctx, 10);
314         assertEquals(1, writtenData.size());
315         assertEquals("", writtenData.get(0));
316         assertEquals</b></font>(10, (int) writtenPadding.get(0));
317         assertEquals(0, data.refCnt());
318         assertTrue(p.isSuccess());
319     }
320     @Test
321     public void headersWriteForUnknownStreamShouldCreateStream() throws Exception {
322         writeAllFlowControlledFrames();
323         final int streamId = 6;
324         ChannelPromise promise = newPromise();
325         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise);
326         verify(writer).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE), eq(0),
327                 eq(false), eq(promise));
328         assertTrue(promise.isSuccess());
329     }
330     @Test
331     public void headersWriteShouldOpenStreamForPush() throws Exception {
332         writeAllFlowControlledFrames();
333         Http2Stream parent = createStream(STREAM_ID, false);
334         reservePushStream(PUSH_STREAM_ID, parent);
335         ChannelPromise promise = newPromise();
336         encoder.writeHeaders(ctx, PUSH_STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, false, promise);
337         assertEquals(HALF_CLOSED_REMOTE, stream(PUSH_STREAM_ID).state());
338         verify(writer).writeHeaders(eq(ctx), eq(PUSH_STREAM_ID), eq(EmptyHttp2Headers.INSTANCE),
339                 eq(0), eq(false), eq(promise));
340     }
341     @Test
342     public void trailersDoNotEndStreamThrows() {
343         writeAllFlowControlledFrames();
344         final int streamId = 6;
345         ChannelPromise promise = newPromise();
346         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise);
347         ChannelPromise promise2 = newPromise();
348         ChannelFuture future = encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise2);
349         assertTrue(future.isDone());
350         assertFalse(future.isSuccess());
351         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
352                 eq(0), eq(false), eq(promise));
353     }
354     @Test
355     public void trailersDoNotEndStreamWithDataThrows() {
356         writeAllFlowControlledFrames();
357         final int streamId = 6;
358         ChannelPromise promise = newPromise();
359         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise);
360         Http2Stream stream = connection.stream(streamId);
361         when(remoteFlow.hasFlowControlled(eq(stream))).thenReturn(true);
362         ChannelPromise promise2 = newPromise();
363         ChannelFuture future = encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise2);
364         assertTrue(future.isDone());
365         assertFalse(future.isSuccess());
366         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
367                 eq(0), eq(false), eq(promise));
368     }
369     @Test
370     public void tooManyHeadersNoEOSThrows() {
371         tooManyHeadersThrows(false);
372     }
373     @Test
374     public void tooManyHeadersEOSThrows() {
375         tooManyHeadersThrows(true);
376     }
377     private void tooManyHeadersThrows(boolean eos) {
378         writeAllFlowControlledFrames();
379         final int streamId = 6;
380         ChannelPromise promise = newPromise();
381         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise);
382         ChannelPromise promise2 = newPromise();
383         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, true, promise2);
384         ChannelPromise promise3 = newPromise();
385         ChannelFuture future = encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, eos, promise3);
386         assertTrue(future.isDone());
387         assertFalse(future.isSuccess());
388         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
389                 eq(0), eq(false), eq(promise));
390         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
391                 eq(0), eq(true), eq(promise2));
392     }
393     @Test
394     public void infoHeadersAndTrailersAllowed() throws Exception {
395         infoHeadersAndTrailers(true, 1);
396     }
397     @Test
398     public void multipleInfoHeadersAndTrailersAllowed() throws Exception {
399         infoHeadersAndTrailers(true, 10);
400     }
401     @Test
402     public void infoHeadersAndTrailersNoEOSThrows() throws Exception {
403         infoHeadersAndTrailers(false, 1);
404     }
405     @Test
406     public void multipleInfoHeadersAndTrailersNoEOSThrows() throws Exception {
407         infoHeadersAndTrailers(false, 10);
408     }
409     private void infoHeadersAndTrailers(boolean eos, int infoHeaderCount) {
410         writeAllFlowControlledFrames();
411         final int streamId = 6;
412         Http2Headers infoHeaders = informationalHeaders();
413         for (int i = 0; i &lt; infoHeaderCount; ++i) {
414             encoder.writeHeaders(ctx, streamId, infoHeaders, 0, false, newPromise());
415         }
416         ChannelPromise promise2 = newPromise();
417         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise2);
418         ChannelPromise promise3 = newPromise();
419         ChannelFuture future = encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, eos, promise3);
420         assertTrue(future.isDone());
421         assertEquals(eos, future.isSuccess());
422         verify(writer, times(infoHeaderCount)).writeHeaders(eq(ctx), eq(streamId), eq(infoHeaders),
423                 eq(0), eq(false), any(ChannelPromise.class));
424         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
425                 eq(0), eq(false), eq(promise2));
426         if (eos) {
427             verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
428                     eq(0), eq(true), eq(promise3));
429         }
430     }
431     private static Http2Headers informationalHeaders() {
432         Http2Headers headers = new DefaultHttp2Headers();
433         headers.status(HttpResponseStatus.CONTINUE.codeAsText());
434         return headers;
435     }
436     @Test
437     public void tooManyHeadersWithDataNoEOSThrows() {
438         tooManyHeadersWithDataThrows(false);
439     }
440     @Test
441     public void tooManyHeadersWithDataEOSThrows() {
442         tooManyHeadersWithDataThrows(true);
443     }
444     private void tooManyHeadersWithDataThrows(boolean eos) {
445         writeAllFlowControlledFrames();
446         final int streamId = 6;
447         ChannelPromise promise = newPromise();
448         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise);
449         Http2Stream stream = connection.stream(streamId);
450         when(remoteFlow.hasFlowControlled(eq(stream))).thenReturn(true);
451         ChannelPromise promise2 = newPromise();
452         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, true, promise2);
453         ChannelPromise promise3 = newPromise();
454         ChannelFuture future = encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, eos, promise3);
455         assertTrue(future.isDone());
456         assertFalse(future.isSuccess());
457         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
458                 eq(0), eq(false), eq(promise));
459         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
460                 eq(0), eq(true), eq(promise2));
461     }
462     @Test
463     public void infoHeadersAndTrailersWithDataAllowed() {
464         infoHeadersAndTrailersWithData(true, 1);
465     }
466     @Test
467     public void multipleInfoHeadersAndTrailersWithDataAllowed() {
468         infoHeadersAndTrailersWithData(true, 10);
469     }
470     @Test
471     public void infoHeadersAndTrailersWithDataNoEOSThrows() {
472         infoHeadersAndTrailersWithData(false, 1);
473     }
474     @Test
475     public void multipleInfoHeadersAndTrailersWithDataNoEOSThrows() {
476         infoHeadersAndTrailersWithData(false, 10);
477     }
478     private void infoHeadersAndTrailersWithData(boolean eos, int infoHeaderCount) {
479         writeAllFlowControlledFrames();
480         final int streamId = 6;
481         Http2Headers infoHeaders = informationalHeaders();
482         for (int i = 0; i &lt; infoHeaderCount; ++i) {
483             encoder.writeHeaders(ctx, streamId, infoHeaders, 0, false, newPromise());
484         }
485         Http2Stream stream = connection.stream(streamId);
486         when(remoteFlow.hasFlowControlled(eq(stream))).thenReturn(true);
487         ChannelPromise promise2 = newPromise();
488         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise2);
489         ChannelPromise promise3 = newPromise();
490         ChannelFuture future = encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, eos, promise3);
491         assertTrue(future.isDone());
492         assertEquals(eos, future.isSuccess());
493         verify(writer, times(infoHeaderCount)).writeHeaders(eq(ctx), eq(streamId), eq(infoHeaders),
494                 eq(0), eq(false), any(ChannelPromise.class));
495         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
496                 eq(0), eq(false), eq(promise2));
497         if (eos) {
498             verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
499                     eq(0), eq(true), eq(promise3));
500         }
501     }
502     @Test
503     public void pushPromiseWriteAfterGoAwayReceivedShouldFail() throws Exception {
504         createStream(STREAM_ID, false);
505         goAwayReceived(0);
506         ChannelFuture future = encoder.writePushPromise(ctx, STREAM_ID, PUSH_STREAM_ID, EmptyHttp2Headers.INSTANCE, 0,
507                 newPromise());
508         assertTrue(future.isDone());
509         assertFalse(future.isSuccess());
510     }
511     @Test
512     public void pushPromiseWriteShouldReserveStream() throws Exception {
513         createStream(STREAM_ID, false);
514         ChannelPromise promise = newPromise();
515         encoder.writePushPromise(ctx, STREAM_ID, PUSH_STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, promise);
516         assertEquals(RESERVED_LOCAL, stream(PUSH_STREAM_ID).state());
517         verify(writer).writePushPromise(eq(ctx), eq(STREAM_ID), eq(PUSH_STREAM_ID),
518                 eq(EmptyHttp2Headers.INSTANCE), eq(0), eq(promise));
519     }
520 <a name="4"></a>
521     @Test
522     public void priorityWriteAfterGoAwayShouldSucceed() throws Exception {
523         <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>createStream(STREAM_ID, false);
524         goAwayReceived(Integer.MAX_VALUE);
525         ChannelPromise promise = newPromise();
526         encoder.writePriority(ctx, STREAM_ID, 0, (short) 255, true, promise);
527         verify(writer).writePriority(eq(ctx), eq(STREAM_ID), eq(0), eq((short) 255), eq(true), eq(promise));
528     }
529     @Test
530     public void priorityWriteShouldSetPriorityForStream() throws Exception {
531         ChannelPromise promise = newPromise()</b></font>;
532         short weight = 255;
533         encoder.writePriority(ctx, STREAM_ID, 0, weight, true, promise);
534         Http2Stream stream = stream(STREAM_ID);
535         assertNull(stream);
536         verify(writer).writePriority(eq(ctx), eq(STREAM_ID), eq(0), eq((short) 255), eq(true), eq(promise));
537     }
538     @Test
539     public void priorityWriteOnPreviouslyExistingStreamShouldSucceed() throws Exception {
540         createStream(STREAM_ID, false).close();
541 <a name="14"></a>        ChannelPromise promise = newPromise();
542         short weight = 255;
543         encoder.writePriority(ctx, STREAM_ID, 0, weight, true, promise);
544         verify(writer).writePriority(eq(ctx), eq(STREAM_ID), eq(0), <font color="#842dce"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>eq(weight), eq(true), eq(promise));
545     }
546     @Test
547     public void priorityWriteOnPreviouslyExistingParentStreamShouldSucceed() throws Exception {
548         final int parentStreamId = STREAM_ID + 2</b></font>;
549         createStream(STREAM_ID, false);
550         createStream(parentStreamId, false).close();
551         ChannelPromise promise = newPromise();
552         short weight = 255;
553         encoder.writePriority(ctx, STREAM_ID, parentStreamId, weight, true, promise);
554         verify(writer).writePriority(eq(ctx), eq(STREAM_ID), eq(parentStreamId), eq(weight), eq(true), eq(promise));
555     }
556     @Test
557     public void rstStreamWriteForUnknownStreamShouldIgnore() throws Exception {
558         ChannelPromise promise = newPromise();
559         encoder.writeRstStream(ctx, 5, PROTOCOL_ERROR.code(), promise);
560         verify(writer, never()).writeRstStream(eq(ctx), anyInt(), anyLong(), eq(promise));
561     }
562     @Test
563 <a name="7"></a>    public void rstStreamShouldCloseStream() throws Exception {
564         writeAllFlowControlledFrames();
565         <font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, newPromise());
566         stream(STREAM_ID);
567         ChannelPromise promise = newPromise();
568         encoder.writeRstStream(ctx, STREAM_ID, PROTOCOL_ERROR.code(), promise);
569         verify(lifecycleManager).resetStream(eq(ctx), eq(STREAM_ID), anyLong(), eq</b></font>(promise));
570     }
571     @Test
572     public void pingWriteAfterGoAwayShouldSucceed() throws Exception {
573         ChannelPromise promise = newPromise();
574         goAwayReceived(0);
575         encoder.writePing(ctx, false, 0L, promise);
576         verify(writer).writePing(eq(ctx), eq(false), eq(0L), eq(promise));
577     }
578     @Test
579     public void pingWriteShouldSucceed() throws Exception {
580         ChannelPromise promise = newPromise();
581         encoder.writePing(ctx, false, 0L, promise);
582         verify(writer).writePing(eq(ctx), eq(false), eq(0L), eq(promise));
583     }
584     @Test
585     public void settingsWriteAfterGoAwayShouldSucceed() throws Exception {
586         goAwayReceived(0);
587         ChannelPromise promise = newPromise();
588         encoder.writeSettings(ctx, new Http2Settings(), promise);
589         verify(writer).writeSettings(eq(ctx), any(Http2Settings.class), eq(promise));
590     }
591 <a name="8"></a>
592     @Test
593     public void settingsWriteShouldNotUpdateSettings() throws Exception {
594         <font color="#c58917"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>Http2Settings settings = new Http2Settings();
595         settings.initialWindowSize(100);
596         settings.maxConcurrentStreams(1000);
597         settings.headerTableSize(2000);
598         ChannelPromise promise = newPromise();
599         encoder.writeSettings(ctx, settings, promise);
600         verify(writer).writeSettings(eq(ctx), eq(settings), eq</b></font>(promise));
601     }
602     @Test
603     public void dataWriteShouldCreateHalfClosedStream() throws Exception {
604         writeAllFlowControlledFrames();
605         Http2Stream stream = createStream(STREAM_ID, false);
606         ByteBuf data = dummyData();
607         ChannelPromise promise = newPromise();
608         encoder.writeData(ctx, STREAM_ID, data.retain(), 0, true, promise);
609         assertTrue(promise.isSuccess());
610         verify(remoteFlow).addFlowControlled(eq(stream), any(FlowControlled.class));
611         verify(lifecycleManager).closeStreamLocal(stream, promise);
612         assertEquals(data.toString(UTF_8), writtenData.get(0));
613         data.release();
614     }
615     @Test
616     public void headersWriteShouldHalfCloseStream() throws Exception {
617         writeAllFlowControlledFrames();
618         createStream(STREAM_ID, false);
619         ChannelPromise promise = newPromise();
620         encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, promise);
621         assertTrue(promise.isSuccess());
622         verify(lifecycleManager).closeStreamLocal(eq(stream(STREAM_ID)), eq(promise));
623     }
624     @Test
625     public void headersWriteShouldHalfClosePushStream() throws Exception {
626         writeAllFlowControlledFrames();
627         Http2Stream parent = createStream(STREAM_ID, false);
628         Http2Stream stream = reservePushStream(PUSH_STREAM_ID, parent);
629         ChannelPromise promise = newPromise();
630         encoder.writeHeaders(ctx, PUSH_STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, promise);
631         assertEquals(HALF_CLOSED_REMOTE, stream.state());
632         assertTrue(promise.isSuccess());
633         verify(lifecycleManager).closeStreamLocal(eq(stream), eq(promise));
634     }
635     @Test
636     public void headersWriteShouldHalfCloseAfterOnErrorForPreCreatedStream() throws Exception {
637         final ChannelPromise promise = newPromise();
638         final Throwable ex = new RuntimeException();
639         when(writer.writeHeaders(eq(ctx), eq(STREAM_ID), eq(EmptyHttp2Headers.INSTANCE), eq(0), eq(true), eq(promise)))
640             .thenAnswer(new Answer&lt;ChannelFuture&gt;() {
641                 @Override
642                 public ChannelFuture answer(InvocationOnMock invocation) {
643                     promise.setFailure(ex);
644                     return promise;
645                 }
646             });
647 <a name="1"></a>
648         writeAllFlowControlledFrames();
649         Http2Stream stream = createStream(STREAM_ID, false);
650         <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, promise);
651         assertTrue(promise.isDone());
652         assertFalse(promise.isSuccess());
653         assertFalse(stream.isHeadersSent());
654         InOrder inOrder = inOrder(lifecycleManager);
655         inOrder.verify(lifecycleManager).onError(eq(ctx), eq(true), eq(ex));
656         inOrder.verify(lifecycleManager).closeStreamLocal(eq(stream(STREAM_ID)), eq(promise));
657     }
658     @Test
659     public void headersWriteShouldHalfCloseAfterOnErrorForImplicitlyCreatedStream() throws Exception {
660         final ChannelPromise promise = newPromise()</b></font>;
661         final Throwable ex = new RuntimeException();
662         when(writer.writeHeaders(eq(ctx), eq(STREAM_ID), eq(EmptyHttp2Headers.INSTANCE), eq(0), eq(true), eq(promise)))
663             .thenAnswer(new Answer&lt;ChannelFuture&gt;() {
664                 @Override
665                 public ChannelFuture answer(InvocationOnMock invocation) {
666                     promise.setFailure(ex);
667                     return promise;
668                 }
669             });
670         writeAllFlowControlledFrames();
671 <a name="6"></a>        encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, promise);
672         assertTrue(promise.isDone());
673         <font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertFalse(promise.isSuccess());
674         assertFalse(stream(STREAM_ID).isHeadersSent());
675         InOrder inOrder = inOrder(lifecycleManager);
676         inOrder.verify(lifecycleManager).onError(eq(ctx), eq(true), eq(ex));
677         inOrder.verify</b></font>(lifecycleManager).closeStreamLocal(eq(stream(STREAM_ID)), eq(promise));
678     }
679     @Test
680     public void encoderDelegatesGoAwayToLifeCycleManager() {
681         ChannelPromise promise = newPromise();
682         encoder.writeGoAway(ctx, STREAM_ID, Http2Error.INTERNAL_ERROR.code(), null, promise);
683         verify(lifecycleManager).goAway(eq(ctx), eq(STREAM_ID), eq(Http2Error.INTERNAL_ERROR.code()),
684                 eq((ByteBuf) null), eq(promise));
685         verifyNoMoreInteractions(writer);
686     }
687     @Test
688     public void dataWriteToClosedStreamShouldFail() throws Exception {
689         createStream(STREAM_ID, false).close();
690         ByteBuf data = mock(ByteBuf.class);
691         ChannelPromise promise = newPromise();
692         encoder.writeData(ctx, STREAM_ID, data, 0, false, promise);
693         assertTrue(promise.isDone());
694         assertFalse(promise.isSuccess());
695         assertThat(promise.cause(), instanceOf(IllegalArgumentException.class));
696         verify(data).release();
697     }
698     @Test
699     public void dataWriteToHalfClosedLocalStreamShouldFail() throws Exception {
700         createStream(STREAM_ID, true);
701         ByteBuf data = mock(ByteBuf.class);
702         ChannelPromise promise = newPromise();
703         encoder.writeData(ctx, STREAM_ID, data, 0, false, promise);
704         assertTrue(promise.isDone());
705         assertFalse(promise.isSuccess());
706         assertThat(promise.cause(), instanceOf(IllegalStateException.class));
707         verify(data).release();
708     }
709     @Test
710     public void canWriteDataFrameAfterGoAwaySent() throws Exception {
711         Http2Stream stream = createStream(STREAM_ID, false);
712         connection.goAwaySent(0, 0, EMPTY_BUFFER);
713         ByteBuf data = mock(ByteBuf.class);
714         encoder.writeData(ctx, STREAM_ID, data, 0, false, newPromise());
715         verify(remoteFlow).addFlowControlled(eq(stream), any(FlowControlled.class));
716     }
717 <a name="3"></a>
718     @Test
719     public void canWriteHeaderFrameAfterGoAwaySent() throws Exception {
720         <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>writeAllFlowControlledFrames();
721         createStream(STREAM_ID, false);
722         goAwaySent(0);
723         ChannelPromise promise = newPromise();
724         encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, false, promise);
725         verify(writer).writeHeaders(eq(ctx), eq(STREAM_ID), eq(EmptyHttp2Headers.INSTANCE),
726                 eq(0), eq(false), eq(promise));
727     }
728     @Test
729     public void canWriteDataFrameAfterGoAwayReceived() throws Exception {
730         Http2Stream stream = createStream(STREAM_ID, false)</b></font>;
731         goAwayReceived(STREAM_ID);
732         ByteBuf data = mock(ByteBuf.class);
733         encoder.writeData(ctx, STREAM_ID, data, 0, false, newPromise());
734         verify(remoteFlow).addFlowControlled(eq(stream), any(FlowControlled.class));
735     }
736     @Test
737     public void canWriteHeaderFrameAfterGoAwayReceived() throws Http2Exception {
738         writeAllFlowControlledFrames();
739         goAwayReceived(STREAM_ID);
740         ChannelPromise promise = newPromise();
741         encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, false, promise);
742         verify(writer).writeHeaders(eq(ctx), eq(STREAM_ID), eq(EmptyHttp2Headers.INSTANCE),
743                 eq(0), eq(false), eq(promise));
744     }
745     @Test
746     public void headersWithNoPriority() {
747         writeAllFlowControlledFrames();
748         final int streamId = 6;
749         ChannelPromise promise = newPromise();
750         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise);
751         verify(writer).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
752                 eq(0), eq(false), eq(promise));
753     }
754     @Test
755     public void headersWithPriority() {
756         writeAllFlowControlledFrames();
757         final int streamId = 6;
758         ChannelPromise promise = newPromise();
759         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 10, DEFAULT_PRIORITY_WEIGHT,
760                 true, 1, false, promise);
761         verify(writer).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE), eq(10),
762                 eq(DEFAULT_PRIORITY_WEIGHT), eq(true), eq(1), eq(false), eq(promise));
763     }
764     private void writeAllFlowControlledFrames() {
765         doAnswer(new Answer&lt;Void&gt;() {
766             @Override
767             public Void answer(InvocationOnMock invocationOnMock) throws Throwable {
768                 FlowControlled flowControlled = (FlowControlled) invocationOnMock.getArguments()[1];
769                 flowControlled.write(ctx, Integer.MAX_VALUE);
770                 flowControlled.writeComplete();
771                 return null;
772             }
773         }).when(remoteFlow).addFlowControlled(any(Http2Stream.class), payloadCaptor.capture());
774     }
775     private Http2Stream createStream(int streamId, boolean halfClosed) throws Http2Exception {
776         return connection.local().createStream(streamId, halfClosed);
777     }
778     private Http2Stream reservePushStream(int pushStreamId, Http2Stream parent) throws Http2Exception {
779         return connection.local().reservePushStream(pushStreamId, parent);
780     }
781     private Http2Stream stream(int streamId) {
782         return connection.stream(streamId);
783     }
784     private void goAwayReceived(int lastStreamId) throws Http2Exception {
785         connection.goAwayReceived(lastStreamId, 0, EMPTY_BUFFER);
786     }
787     private void goAwaySent(int lastStreamId) throws Http2Exception {
788         connection.goAwaySent(lastStreamId, 0, EMPTY_BUFFER);
789     }
790     private ChannelPromise newPromise() {
791         return new DefaultChannelPromise(channel, ImmediateEventExecutor.INSTANCE);
792     }
793     private ChannelFuture newSucceededFuture() {
794         return newPromise().setSuccess();
795     }
796     private static ByteBuf dummyData() {
797         return wrappedBuffer("abcdefgh".getBytes(UTF_8));
798     }
799 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
