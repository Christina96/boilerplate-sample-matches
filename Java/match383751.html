<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for AggregationProjection.java & TextFieldMapper.java</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for AggregationProjection.java & TextFieldMapper.java
      </h3>
      <h1 align="center">
        24.4%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>AggregationProjection.java (31.081081%)<TH>TextFieldMapper.java (20.175438%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match383751-0.html#0',2,'match383751-1.html#0',3)" NAME="0">(87-97)<TD><A HREF="javascript:ZweiFrames('match383751-0.html#0',2,'match383751-1.html#0',3)" NAME="0">(190-200)</A><TD ALIGN=center><FONT COLOR="#ff0000">14</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match383751-0.html#1',2,'match383751-1.html#1',3)" NAME="1">(30-48)<TD><A HREF="javascript:ZweiFrames('match383751-0.html#1',2,'match383751-1.html#1',3)" NAME="1">(22-40)</A><TD ALIGN=center><FONT COLOR="#ec0000">13</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match383751-0.html#2',2,'match383751-1.html#2',3)" NAME="2">(79-86)<TD><A HREF="javascript:ZweiFrames('match383751-0.html#2',2,'match383751-1.html#2',3)" NAME="2">(178-185)</A><TD ALIGN=center><FONT COLOR="#b60000">10</FONT>
<TR><TD BGCOLOR="#53858b"><FONT COLOR="#53858b">-</FONT><TD><A HREF="javascript:ZweiFrames('match383751-0.html#3',2,'match383751-1.html#3',3)" NAME="3">(105-108)<TD><A HREF="javascript:ZweiFrames('match383751-0.html#3',2,'match383751-1.html#3',3)" NAME="3">(167-171)</A><TD ALIGN=center><FONT COLOR="#a30000">9</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>AggregationProjection.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
 * software solely pursuant to the terms of the relevant commercial agreement.
 */

package io.crate.execution.dsl.projection;

import io.crate.common.collections.Lists2;
import io.crate.common.collections.MapBuilder;
import io.crate.expression.symbol.AggregateMode;
<A NAME="1"></A>import io.crate.expression.symbol.Aggregation;
import io.crate.expression.symbol.SelectSymbol;
import io.crate.expression.symbol.Symbol;
<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match383751-1.html#1',3,'match383751-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>import io.crate.expression.symbol.SymbolVisitors;
import io.crate.expression.symbol.Symbols;
import io.crate.metadata.RowGranularity;
import org.elasticsearch.common.io.stream.StreamInput;
import org.elasticsearch.common.io.stream.StreamOutput;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Objects;

/**
 * A projection which aggregates all inputs to a single row
 */
public class AggregationProjection extends Projection {

    private final RowGranularity contextGranularity;
    private final AggregateMode mode</B></FONT>;
    private final List&lt;Aggregation&gt; aggregations;

    public AggregationProjection(StreamInput in) throws IOException {
        int size = in.readVInt();
        aggregations = new ArrayList&lt;&gt;(size);
        for (int i = 0; i &lt; size; i++) {
            aggregations.add((Aggregation) Symbols.fromStream(in));
        }
        contextGranularity = RowGranularity.fromStream(in);
        mode = AggregateMode.readFrom(in);
    }

    public AggregationProjection(List&lt;Aggregation&gt; aggregations, RowGranularity contextGranularity, AggregateMode mode) {
        assert aggregations != null : &quot;aggregations must not be null&quot;;
        assert aggregations.stream().noneMatch(s -&gt;
            SymbolVisitors.any(Symbols.IS_COLUMN.or(x -&gt; x instanceof SelectSymbol), s))
            : &quot;Cannot operate on Reference, Field or SelectSymbol symbols: &quot; + aggregations;

        this.contextGranularity = contextGranularity;
        this.mode = mode;
        this.aggregations = aggregations;
    }

    @Override
    public RowGranularity requiredGranularity() {
        return contextGranularity;
    }
<A NAME="2"></A>
    public List&lt;Aggregation&gt; aggregations() {
        return aggregations;
    <FONT color="#980517"><A HREF="javascript:ZweiFrames('match383751-1.html#2',3,'match383751-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>}

    @Override
    public ProjectionType projectionType() {
        return ProjectionType.AGGREGATION;
<A NAME="0"></A>    }

    @</B></FONT>Override
    public &lt;C, R&gt; R accept(ProjectionVisitor&lt;C, R&gt; visitor, C context) <FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match383751-1.html#0',3,'match383751-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>{
        return visitor.visitAggregationProjection(this, context);
    }

    @Override
    public List&lt;? extends Symbol&gt; outputs() {
        return aggregations;
    }

    @Override
    public void writeTo(StreamOutput out</B></FONT>) throws IOException {
        Symbols.toStream(aggregations, out);
        RowGranularity.toStream(contextGranularity, out);
        AggregateMode.writeTo(mode, out);
    }
<A NAME="3"></A>
    @Override
    public boolean equals(Object o) {
        <FONT color="#53858b"><A HREF="javascript:ZweiFrames('match383751-1.html#3',3,'match383751-top.html#3',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>if (this == o) {
            return true;
        }
        if (o == null || getClass() != o.getClass()) {</B></FONT>
            return false;
        }
        AggregationProjection that = (AggregationProjection) o;
        return contextGranularity == that.contextGranularity &amp;&amp;
               mode == that.mode &amp;&amp;
               Objects.equals(aggregations, that.aggregations);
    }

    @Override
    public int hashCode() {
        return Objects.hash(super.hashCode(), contextGranularity, mode, aggregations);
    }

    public AggregateMode mode() {
        return mode;
    }

    @Override
    public Map&lt;String, Object&gt; mapRepresentation() {
        return MapBuilder.&lt;String, Object&gt;newMapBuilder()
            .put(&quot;type&quot;, &quot;HashAggregation&quot;)
            .put(&quot;aggregations&quot;, '[' + Lists2.joinOn(&quot;, &quot;, aggregations, Aggregation::toString) + ']')
            .map();
    }
}
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>TextFieldMapper.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Elasticsearch under one or more contributor
 * license agreements. See the NOTICE file distributed with
 * this work for additional information regarding copyright
 * ownership. Elasticsearch licenses this file to you under
 * the Apache License, Version 2.0 (the &quot;License&quot;); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
<A NAME="1"></A>
package org.elasticsearch.index.mapper;

<FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match383751-0.html#1',2,'match383751-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>import static org.elasticsearch.index.mapper.TypeParsers.parseTextField;

import java.io.IOException;
import java.util.List;
import java.util.Map;

import org.apache.lucene.document.Field;
import org.apache.lucene.document.FieldType;
import org.apache.lucene.index.IndexOptions;
import org.apache.lucene.index.IndexableField;
import org.elasticsearch.common.settings.Settings;
import org.elasticsearch.common.xcontent.XContentBuilder;

/** A {@link FieldMapper} for full-text fields. */
public class TextFieldMapper extends FieldMapper {

    public static final String CONTENT_TYPE = &quot;text&quot;;

    public static final String FAST_PHRASE_SUFFIX = &quot;._index_phrase&quot;</B></FONT>;

    public static class Defaults {
        public static final int FIELDDATA_MIN_SEGMENT_SIZE = 0;
        public static final int INDEX_PREFIX_MIN_CHARS = 2;
        public static final int INDEX_PREFIX_MAX_CHARS = 5;

        public static final FieldType FIELD_TYPE = new FieldType();

        static {
            FIELD_TYPE.setTokenized(true);
            FIELD_TYPE.setStored(false);
            FIELD_TYPE.setStoreTermVectors(false);
            FIELD_TYPE.setOmitNorms(false);
            FIELD_TYPE.setIndexOptions(IndexOptions.DOCS_AND_FREQS_AND_POSITIONS);
            FIELD_TYPE.freeze();
        }

        /**
         * The default position_increment_gap is set to 100 so that phrase
         * queries of reasonably high slop will not match across field values.
         */
        public static final int POSITION_INCREMENT_GAP = 100;
    }

    public static class Builder extends FieldMapper.Builder&lt;Builder&gt; {

        public Builder(String name) {
            super(name, Defaults.FIELD_TYPE);
            builder = this;
        }

        @Override
        public Builder docValues(boolean docValues) {
            if (docValues) {
                throw new IllegalArgumentException(&quot;[text] fields do not support doc values&quot;);
            }
            return super.docValues(docValues);
        }


        private TextFieldType buildFieldType(BuilderContext context) {
            TextFieldType ft = new TextFieldType(
                buildFullName(context),
                indexed,
                fieldType.indexOptions().compareTo(IndexOptions.DOCS_AND_FREQS_AND_POSITIONS) &gt;= 0);
            ft.setIndexAnalyzer(indexAnalyzer);
            ft.setSearchAnalyzer(searchAnalyzer);
            ft.setSearchQuoteAnalyzer(searchQuoteAnalyzer);
            return ft;
        }


        @Override
        public TextFieldMapper build(BuilderContext context) {
            TextFieldType tft = buildFieldType(context);
            return new TextFieldMapper(
                name,
                position,
                defaultExpression,
                fieldType,
                tft,
                context.indexSettings(),
                multiFieldsBuilder.build(this, context),
                copyTo
            );
        }


    }

    public static class TypeParser implements Mapper.TypeParser {
        @Override
        public Mapper.Builder parse(String fieldName, Map&lt;String, Object&gt; node, ParserContext parserContext) throws MapperParsingException {
            TextFieldMapper.Builder builder = new TextFieldMapper.Builder(fieldName);
            builder.indexAnalyzer(parserContext.getIndexAnalyzers().getDefaultIndexAnalyzer());
            builder.searchAnalyzer(parserContext.getIndexAnalyzers().getDefaultSearchAnalyzer());
            builder.searchQuoteAnalyzer(parserContext.getIndexAnalyzers().getDefaultSearchQuoteAnalyzer());
            parseTextField(builder, fieldName, node, parserContext);
            return builder;
        }
    }

    public static final class TextFieldType extends StringFieldType {

        public TextFieldType(String name, boolean indexed, boolean hasPositions) {
            super(name, indexed, false);
            this.hasPositions = hasPositions;
        }

        public TextFieldType(String name) {
            this(name, true, true);
        }

        @Override
        public String typeName() {
            return CONTENT_TYPE;
        }

    }

    protected TextFieldMapper(String simpleName,
                              Integer position,
                              String defaultExpression,
                              FieldType fieldType,
                              TextFieldType mappedFieldType,
                              Settings indexSettings,
                              MultiFields multiFields,
                              CopyTo copyTo) {
        super(simpleName, position, defaultExpression, fieldType, mappedFieldType, indexSettings, multiFields, copyTo);
        assert mappedFieldType.hasDocValues() == false;
    }

    @Override
    protected TextFieldMapper clone() {
        return (TextFieldMapper) super.clone();
    }

    @Override
    protected void parseCreateField(ParseContext context, List&lt;IndexableField&gt; fields) throws IOException {
        final String value;
        if (context.externalValueSet()) {
            value = context.externalValue().toString();
        } else {
<A NAME="3"></A>            value = context.parser().textOrNull();
        }

        <FONT color="#53858b"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match383751-0.html#3',2,'match383751-top.html#3',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>if (value == null) {
            return;
        }

        if (fieldType.indexOptions() != IndexOptions.NONE || fieldType.stored()) {</B></FONT>
            Field field = new Field(fieldType().name(), value, fieldType);
            fields.add(field);
            if (fieldType.omitNorms()) {
<A NAME="2"></A>                createFieldNamesField(context, fields);
            }
        }
    <FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match383751-0.html#2',2,'match383751-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>}

    @Override
    protected String contentType() {
        return CONTENT_TYPE;
    }

    @</B></FONT>Override
    protected void mergeOptions(FieldMapper other, List&lt;String&gt; conflicts) {
<A NAME="0"></A>    }

    @Override
    public TextFieldType fieldType() <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match383751-0.html#0',2,'match383751-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>{
        return (TextFieldType) super.fieldType();
    }

    @Override
    protected boolean docValuesByDefault() {
        return false;
    }

    @Override
    protected void doXContentBody(XContentBuilder builder</B></FONT>, boolean includeDefaults, Params params) throws IOException {
        super.doXContentBody(builder, includeDefaults, params);
        doXContentAnalyzers(builder, includeDefaults);
    }
}
</PRE>
</div>
  </div>
</body>
</html>
