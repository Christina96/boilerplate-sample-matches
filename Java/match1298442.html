<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for DefaultSchemaIntegrationTest.java &amp; CopyToPlan.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for DefaultSchemaIntegrationTest.java &amp; CopyToPlan.java
      </h3>
<h1 align="center">
        14.2%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>DefaultSchemaIntegrationTest.java (30.927835%)<th>CopyToPlan.java (9.259259%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(81-88)<td><a href="#" name="0">(116-123)</a><td align="center"><font color="#ff0000">11</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(61-65)<td><a href="#" name="1">(153-161)</a><td align="center"><font color="#e70000">10</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(24-37)<td><a href="#" name="2">(72-83)</a><td align="center"><font color="#d00000">9</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>DefaultSchemaIntegrationTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Licensed to Crate.io GmbH ("Crate") under one or more contributor
3  * license agreements.  See the NOTICE file distributed with this work for
4  * additional information regarding copyright ownership.  Crate licenses
5  * this file to you under the Apache License, Version 2.0 (the "License");
6  * you may not use this file except in compliance with the License.  You may
7  * obtain a copy of the License at
8  *
9  *   http://www.apache.org/licenses/LICENSE-2.0
10  *
11  * Unless required by applicable law or agreed to in writing, software
12  * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
13  * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
14  * License for the specific language governing permissions and limitations
15  * under the License.
16  *
17  * However, if you have executed another commercial license agreement
18  * with Crate these terms will supersede the license and you may use the
19  * software solely pursuant to the terms of the relevant commercial agreement.
20  */
21 <a name="2"></a>
22 package io.crate.integrationtests;
23 <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import io.crate.testing.SQLResponse;
24 import org.junit.Rule;
25 import org.junit.Test;
26 import org.junit.rules.TemporaryFolder;
27 import java.io.File;
28 import java.nio.file.Paths;
29 import static org.hamcrest.core.Is.is;
30 public class DefaultSchemaIntegrationTest extends SQLIntegrationTestCase {
31     @Rule</b></font>
32     public TemporaryFolder tmpFolder = new TemporaryFolder();
33     public SQLResponse execute(String stmt, Object[] args, String schema) {
34         return execute(stmt, args, createSession(schema));
35     }
36     @Test
37     public void testSelectFromFooSchemaWithRequestHeaders() throws Exception {
38         execute("create table foobar (x string) with (number_of_replicas = 0)", "foo" );
39         ensureYellow();
40         waitNoPendingTasksOnAll();
41         execute("alter table foobar set (number_of_replicas = '0-1')", "foo" );
42         assertThat(getTableCount("foo", "foobar"), is(1L));
43         assertThat(getTableCount("doc", "foobar"), is(0L));
44         execute("insert into foobar (x) values ('a'), ('b')", "foo");
45         execute("refresh table foobar", "foo");
46 <a name="1"></a>        execute("update foobar set x = 'c'", "foo");
47         assertThat(response.rowCount(), is(2L));
48         <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>execute("select * from foobar", "foo");
49         assertThat(response.rowCount(), is(2L));
50         File foobarExport = tmpFolder.newFolder("foobar_export");
51         String uriTemplate = Paths.get</b></font>(foobarExport.toURI()).toUri().toString();
52         execute("copy foobar to directory ?", new Object[]{uriTemplate}, "foo");
53         refresh();
54         execute("delete from foobar", "foo");
55         refresh();
56         execute("select * from foobar", "foo");
57         assertThat(response.rowCount(), is(0L));
58         execute("copy foobar from ? with (shared=True)", new Object[]{uriTemplate + "*"}, "foo");
59         execute("refresh table foobar", "foo");
60         execute("select * from foobar", "foo");
61         assertThat(response.rowCount(), is(2L));
62 <a name="0"></a>
63         execute("insert into foobar (x) (select x from foobar)", "foo");
64         execute("refresh table foobar", "foo");
65         <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>execute("select * from foobar", "foo");
66         assertThat(response.rowCount(), is(4L));
67         execute("drop table foobar", "foo");
68         assertThat(getTableCount("foo", "foobar"), is(0L));
69     }
70     private long </b></font>getTableCount(String schema, String tableName) {
71         execute("select count(*) from information_schema.tables where table_schema = ? and table_name = ?",
72             new Object[]{schema, tableName});
73         return ((long) response.rows()[0][0]);
74     }
75 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>CopyToPlan.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Licensed to Crate.io GmbH ("Crate") under one or more contributor
3  * license agreements.  See the NOTICE file distributed with this work for
4  * additional information regarding copyright ownership.  Crate licenses
5  * this file to you under the Apache License, Version 2.0 (the "License");
6  * you may not use this file except in compliance with the License.  You may
7  * obtain a copy of the License at
8  *
9  *   http://www.apache.org/licenses/LICENSE-2.0
10  *
11  * Unless required by applicable law or agreed to in writing, software
12  * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
13  * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
14  * License for the specific language governing permissions and limitations
15  * under the License.
16  *
17  * However, if you have executed another commercial license agreement
18  * with Crate these terms will supersede the license and you may use the
19  * software solely pursuant to the terms of the relevant commercial agreement.
20  */
21 package io.crate.planner.statement;
22 import io.crate.analyze.AnalyzedCopyTo;
23 import io.crate.analyze.BoundCopyTo;
24 import io.crate.analyze.PartitionPropertiesAnalyzer;
25 import io.crate.analyze.SymbolEvaluator;
26 import io.crate.analyze.WhereClause;
27 import io.crate.analyze.relations.DocTableRelation;
28 import io.crate.common.annotations.VisibleForTesting;
29 import io.crate.common.collections.Lists2;
30 import io.crate.data.Row;
31 import io.crate.data.RowConsumer;
32 import io.crate.exceptions.PartitionUnknownException;
33 import io.crate.exceptions.UnsupportedFeatureException;
34 import io.crate.execution.dsl.phases.NodeOperationTree;
35 import io.crate.execution.dsl.projection.MergeCountProjection;
36 import io.crate.execution.dsl.projection.WriterProjection;
37 import io.crate.execution.dsl.projection.builder.ProjectionBuilder;
38 import io.crate.execution.engine.NodeOperationTreeGenerator;
39 import io.crate.expression.symbol.Literal;
40 import io.crate.expression.symbol.RefVisitor;
41 import io.crate.expression.symbol.Symbol;
42 import io.crate.metadata.ColumnIdent;
43 import io.crate.metadata.CoordinatorTxnCtx;
44 import io.crate.metadata.DocReferences;
45 import io.crate.metadata.GeneratedReference;
46 import io.crate.metadata.NodeContext;
47 import io.crate.metadata.Reference;
48 import io.crate.metadata.doc.DocSysColumns;
49 import io.crate.metadata.doc.DocTableInfo;
50 import io.crate.planner.DependencyCarrier;
51 import io.crate.planner.ExecutionPlan;
52 import io.crate.planner.Merge;
53 import io.crate.planner.Plan;
54 import io.crate.planner.PlannerContext;
55 import io.crate.planner.operators.Collect;
56 import io.crate.planner.operators.LogicalPlan;
57 import io.crate.planner.operators.SubQueryResults;
58 import io.crate.planner.optimizer.matcher.Captures;
59 import io.crate.planner.optimizer.matcher.Match;
60 import io.crate.planner.optimizer.rule.OptimizeCollectWhereClauseAccess;
61 import io.crate.sql.tree.Assignment;
62 import io.crate.statistics.TableStats;
63 import io.crate.types.DataTypes;
64 import org.elasticsearch.common.settings.Settings;
65 import java.util.ArrayList;
66 <a name="2"></a>import java.util.Collections;
67 import java.util.HashMap;
68 import java.util.List;
69 <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import java.util.Map;
70 import java.util.Set;
71 import java.util.function.Function;
72 import static io.crate.analyze.CopyStatementSettings.COMPRESSION_SETTING;
73 import static io.crate.analyze.CopyStatementSettings.OUTPUT_FORMAT_SETTING;
74 import static io.crate.analyze.CopyStatementSettings.settingAsEnum;
75 import static io.crate.analyze.GenericPropertiesConverter.genericPropertiesToSettings;
76 public final class CopyToPlan implements Plan {
77     private final AnalyzedCopyTo copyTo</b></font>;
78     private final TableStats tableStats;
79     public CopyToPlan(AnalyzedCopyTo copyTo, TableStats tableStats) {
80         this.copyTo = copyTo;
81         this.tableStats = tableStats;
82     }
83     @VisibleForTesting
84     AnalyzedCopyTo copyTo() {
85         return copyTo;
86     }
87     @Override
88     public StatementType type() {
89         return StatementType.COPY;
90     }
91     @Override
92     public void executeOrFail(DependencyCarrier executor,
93                               PlannerContext plannerContext,
94                               RowConsumer consumer,
95                               Row params,
96                               SubQueryResults subQueryResults) {
97         ExecutionPlan executionPlan = planCopyToExecution(
98             copyTo,
99             plannerContext,
100             tableStats,
101             executor.projectionBuilder(),
102             params,
103 <a name="0"></a>            subQueryResults
104         );
105         NodeOperationTree nodeOpTree = <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>NodeOperationTreeGenerator
106             .fromPlan(executionPlan, executor.localNodeId());
107         executor.phasesTaskFactory()
108             .create(plannerContext.jobId(), List.of(nodeOpTree))
109             .execute(consumer, plannerContext.transactionContext());
110     }
111     @VisibleForTesting</b></font>
112     static ExecutionPlan planCopyToExecution(AnalyzedCopyTo copyTo,
113                                              PlannerContext context,
114                                              TableStats tableStats,
115                                              ProjectionBuilder projectionBuilder,
116                                              Row params,
117                                              SubQueryResults subQueryResults) {
118         var boundedCopyTo = bind(
119             copyTo,
120             context.transactionContext(),
121             context.nodeContext(),
122             params,
123             subQueryResults);
124         WriterProjection.OutputFormat outputFormat = boundedCopyTo.outputFormat();
125         if (outputFormat == null) {
126             outputFormat = boundedCopyTo.columnsDefined() ?
127                 WriterProjection.OutputFormat.JSON_ARRAY : WriterProjection.OutputFormat.JSON_OBJECT;
128         }
129         WriterProjection projection = ProjectionBuilder.writerProjection(
130             boundedCopyTo.outputs(),
131             boundedCopyTo.uri(),
132             boundedCopyTo.compressionType(),
133             boundedCopyTo.overwrites(),
134             boundedCopyTo.outputNames(),
135             outputFormat,
136 <a name="1"></a>            boundedCopyTo.withClauseOptions());
137         LogicalPlan collect = Collect.create(
138             new DocTableRelation(<font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>boundedCopyTo.table()),
139             boundedCopyTo.outputs(),
140             boundedCopyTo.whereClause(),
141             tableStats,
142             context.params()
143         );
144         LogicalPlan source = optimizeCollect(context, tableStats, collect);
145         ExecutionPlan executionPlan = source.build(context, Set.of(), projectionBuilder, 0, 0, null, null, params, SubQueryResults.EMPTY);
146         executionPlan.addProjection</b></font>(projection);
147         return Merge.ensureOnHandler(
148             executionPlan,
149             context,
150             List.of(MergeCountProjection.INSTANCE));
151     }
152     private static LogicalPlan optimizeCollect(PlannerContext context, TableStats tableStats, LogicalPlan collect) {
153         OptimizeCollectWhereClauseAccess rewriteCollectToGet = new OptimizeCollectWhereClauseAccess();
154         Match&lt;Collect&gt; match = rewriteCollectToGet.pattern().accept(collect, Captures.empty());
155         if (match.isPresent()) {
156             LogicalPlan plan = rewriteCollectToGet.apply(match.value(),
157                                                          match.captures(),
158                                                          tableStats,
159                                                          context.transactionContext(),
160                                                          context.nodeContext());
161             return plan == null ? collect : plan;
162         }
163         return collect;
164     }
165     @VisibleForTesting
166     public static BoundCopyTo bind(AnalyzedCopyTo copyTo,
167                                    CoordinatorTxnCtx txnCtx,
168                                    NodeContext nodeCtx,
169                                    Row parameters,
170                                    SubQueryResults subQueryResults) {
171         Function&lt;? super Symbol, Object&gt; eval = x -&gt; SymbolEvaluator.evaluate(
172             txnCtx,
173             nodeCtx,
174             x,
175             parameters,
176             subQueryResults
177         );
178         DocTableInfo table = (DocTableInfo) copyTo.tableInfo();
179         List&lt;String&gt; partitions = resolvePartitions(
180             Lists2.map(copyTo.table().partitionProperties(), x -&gt; x.map(eval)),
181             table
182         );
183         List&lt;Symbol&gt; outputs = new ArrayList&lt;&gt;();
184         Map&lt;ColumnIdent, Symbol&gt; overwrites = null;
185         boolean columnsDefined = false;
186         final List&lt;String&gt; outputNames = new ArrayList&lt;&gt;(copyTo.columns().size());
187         if (!copyTo.columns().isEmpty()) {
188             for (Symbol symbol : copyTo.columns()) {
189                 assert symbol instanceof Reference : "Only references are expected here";
190                 RefVisitor.visitRefs(symbol, r -&gt; outputNames.add(r.column().sqlFqn()));
191                 outputs.add(DocReferences.toSourceLookup(symbol));
192             }
193             columnsDefined = true;
194         } else {
195             Reference sourceRef;
196             if (table.isPartitioned() &amp;&amp; partitions.isEmpty()) {
197                 overwrites = new HashMap&lt;&gt;();
198                 for (Reference reference : table.partitionedByColumns()) {
199                     if (!(reference instanceof GeneratedReference)) {
200                         overwrites.put(reference.column(), reference);
201                     }
202                 }
203                 if (overwrites.size() &gt; 0) {
204                     sourceRef = table.getReference(DocSysColumns.DOC);
205                 } else {
206                     sourceRef = table.getReference(DocSysColumns.RAW);
207                 }
208             } else {
209                 sourceRef = table.getReference(DocSysColumns.RAW);
210             }
211             outputs = List.of(sourceRef);
212         }
213         Settings settings = genericPropertiesToSettings(copyTo.properties().map(eval));
214         WriterProjection.CompressionType compressionType =
215             settingAsEnum(WriterProjection.CompressionType.class, COMPRESSION_SETTING.get(settings));
216         WriterProjection.OutputFormat outputFormat =
217             settingAsEnum(WriterProjection.OutputFormat.class, OUTPUT_FORMAT_SETTING.get(settings));
218         if (!columnsDefined &amp;&amp; outputFormat == WriterProjection.OutputFormat.JSON_ARRAY) {
219             throw new UnsupportedFeatureException("Output format not supported without specifying columns.");
220         }
221         WhereClause whereClause = new WhereClause(copyTo.whereClause(), partitions, Collections.emptySet());
222         return new BoundCopyTo(
223             outputs,
224             table,
225             whereClause,
226             Literal.of(DataTypes.STRING.sanitizeValue(eval.apply(copyTo.uri()))),
227             compressionType,
228             outputFormat,
229             outputNames.isEmpty() ? null : outputNames,
230             columnsDefined,
231             overwrites,
232             settings);
233     }
234     private static List&lt;String&gt; resolvePartitions(List&lt;Assignment&lt;Object&gt;&gt; partitionProperties,
235                                                   DocTableInfo table) {
236         if (partitionProperties.isEmpty()) {
237             return Collections.emptyList();
238         }
239         var partitionName = PartitionPropertiesAnalyzer.toPartitionName(
240             table,
241             partitionProperties);
242         if (!table.partitions().contains(partitionName)) {
243             throw new PartitionUnknownException(partitionName);
244         }
245         return List.of(partitionName.asIndexName());
246     }
247 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
