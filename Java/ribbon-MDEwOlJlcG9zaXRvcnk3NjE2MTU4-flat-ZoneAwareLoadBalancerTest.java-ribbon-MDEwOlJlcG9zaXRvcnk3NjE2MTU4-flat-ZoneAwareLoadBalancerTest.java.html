
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 18, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>ribbon-MDEwOlJlcG9zaXRvcnk3NjE2MTU4-flat-ZoneAwareLoadBalancerTest.java</h3>
            <pre><code>1  package com.netflix.loadbalancer;
2  import static org.junit.Assert.assertEquals;
3  import static org.junit.Assert.assertNotNull;
4  import static org.junit.Assert.assertNotSame;
5  import static org.junit.Assert.assertTrue;
6  import static org.junit.Assert.fail;
7  import java.util.ArrayList;
8  import java.util.Arrays;
9  import java.util.Collections;
10  import java.util.HashMap;
11  import java.util.HashSet;
12  import java.util.List;
13  import java.util.Map;
14  import java.util.Set;
15  import com.netflix.client.config.DefaultClientConfigImpl;
16  import org.junit.Ignore;
17  import org.junit.Test;
18  import com.netflix.client.ClientFactory;
19  import com.netflix.config.ConfigurationManager;
20  public class ZoneAwareLoadBalancerTest {
21      private Server createServer(String host, String zone) {
22          return createServer(host, 7001, zone);    
23      }
24      private Server createServer(String host, int port, String zone) {
25          Server server = new Server(host, port);
26          server.setZone(zone);
27          server.setAlive(true);
28          return server;
29      }
30      private Server createServer(int hostId, String zoneSuffix) {
31          return createServer(zoneSuffix + "-" + "server" + hostId, "us-eAst-1" + zoneSuffix);
32      }
33      private void testChooseServer(ZoneAwareLoadBalancer<Server> balancer, String... expectedZones) {
34          Set<String> result = new HashSet<String>();
35          for (int i = 0; i < 100; i++) {
36              Server server = balancer.chooseServer(null);
37              String zone = server.getZone().toLowerCase();
38              result.add(zone);
39          }
40          Set<String> expected = new HashSet<String>();
41          expected.addAll(Arrays.asList(expectedZones));
42          assertEquals(expected, result);
43      }
44      @Test
45      public void testChooseZone() throws Exception {
46          ConfigurationManager.getConfigInstance().setProperty("niws.loadbalancer.serverStats.activeRequestsCount.effectiveWindowSeconds", 10);
47          DefaultClientConfigImpl config = new DefaultClientConfigImpl();
48          config.loadProperties("testChooseZone");
49          ZoneAwareLoadBalancer<Server> balancer = new ZoneAwareLoadBalancer<Server>();
50          balancer.init();
51          IRule globalRule = new RoundRobinRule();
52          balancer.setRule(globalRule);        
53          LoadBalancerStats loadBalancerStats = balancer.getLoadBalancerStats();
54          loadBalancerStats.initWithNiwsConfig(config);
55          assertNotNull(loadBalancerStats);
56          List<Server> servers = new ArrayList<Server>();
57          servers.add(createServer(1, "a"));
58          servers.add(createServer(2, "a"));
59          servers.add(createServer(3, "a"));
60          servers.add(createServer(4, "a"));
61          servers.add(createServer(1, "b"));
62          servers.add(createServer(2, "b"));
63          servers.add(createServer(3, "b"));
64          servers.add(createServer(1, "c"));
65          servers.add(createServer(2, "c"));
66          servers.add(createServer(3, "c"));
67          servers.add(createServer(4, "c"));
68          balancer.setServersList(servers);
69          balancer.setUpServerList(servers);
70          assertTrue(balancer.getLoadBalancer("us-east-1a").getRule() instanceof RoundRobinRule);
71          assertNotSame(globalRule, balancer.getLoadBalancer("us-east-1a").getRule());
72          testChooseServer(balancer, "us-east-1a", "us-east-1b", "us-east-1c");
73          loadBalancerStats.incrementActiveRequestsCount(createServer(1, "c"));
74          loadBalancerStats.incrementActiveRequestsCount(createServer(3, "c"));
75          loadBalancerStats.incrementActiveRequestsCount(createServer(3, "c"));
76          loadBalancerStats.decrementActiveRequestsCount(createServer(3, "c"));
77          assertEquals(2, loadBalancerStats.getActiveRequestsCount("us-east-1c"));
78          assertEquals(0.5d, loadBalancerStats.getActiveRequestsPerServer("us-east-1c"), 0.0001d);
79          testChooseServer(balancer, "us-east-1a", "us-east-1b");
80          for (int i = 0; i < 3; i++) {
81              loadBalancerStats.incrementSuccessiveConnectionFailureCount(createServer(1, "a"));
82          }
83          assertEquals(1, loadBalancerStats.getCircuitBreakerTrippedCount("us-east-1a"));
84          loadBalancerStats.incrementSuccessiveConnectionFailureCount(createServer(2, "b"));
85          assertEquals(0, loadBalancerStats.getCircuitBreakerTrippedCount("us-east-1b"));        
86          testChooseServer(balancer, "us-east-1a", "us-east-1b");
87          loadBalancerStats.incrementActiveRequestsCount(createServer(2, "a"));
88          assertEquals(1d/3, loadBalancerStats.getActiveRequestsPerServer("us-east-1a"), 0.0001);
89          testChooseServer(balancer, "us-east-1b", "us-east-1a");
90          Thread.sleep(15000);
91          assertEquals(0, loadBalancerStats.getCircuitBreakerTrippedCount("us-east-1a"));
92          assertEquals(3, loadBalancerStats.getSingleServerStat(createServer(1, "a")).getSuccessiveConnectionFailureCount());
93          assertEquals(0, loadBalancerStats.getActiveRequestsCount("us-east-1c"));
94          assertEquals(0, loadBalancerStats.getSingleServerStat(createServer(1, "c")).getActiveRequestsCount());
95          loadBalancerStats.clearSuccessiveConnectionFailureCount(createServer(1, "a"));
96          assertEquals(0, loadBalancerStats.getSingleServerStat(createServer(1, "a")).getSuccessiveConnectionFailureCount());
97          assertEquals(0, loadBalancerStats.getCircuitBreakerTrippedCount("us-east-1a"));
98          loadBalancerStats.decrementActiveRequestsCount(createServer(2, "a"));
99          assertEquals(0, loadBalancerStats.getActiveRequestsPerServer("us-east-1b"), 0.000001);
100          assertEquals(0, loadBalancerStats.getActiveRequestsPerServer("us-east-1c"), 0.000001);
101          assertEquals(0, loadBalancerStats.getActiveRequestsPerServer("us-east-1a"), 0.000001);
102          testChooseServer(balancer, "us-east-1a", "us-east-1b", "us-east-1c");
103          List<Server> emptyList = Collections.emptyList();
104          Map<String, List<Server>> map = new HashMap<String, List<Server>>();
105          map.put("us-east-1a", emptyList);
106          map.put("us-east-1b", emptyList);
<span onclick='openModal()' class='match'>107          balancer.setServerListForZones(map);
108          testChooseServer(balancer, "us-east-1a", "us-east-1b", "us-east-1c");
109      }
</span>110      @Test
111      public void testZoneOutage() throws Exception {
112          ConfigurationManager.getConfigInstance().clearProperty("niws.loadbalancer.serverStats.activeRequestsCount.effectiveWindowSeconds");
113          ZoneAwareLoadBalancer<Server> balancer = new ZoneAwareLoadBalancer<Server>();
114          balancer.init();
115          LoadBalancerStats loadBalancerStats = balancer.getLoadBalancerStats();
116          assertNotNull(loadBalancerStats);
117          List<Server> servers = new ArrayList<Server>();
118          servers.add(createServer(1, "a"));
119          servers.add(createServer(2, "a"));
120          servers.add(createServer(1, "b"));
121          servers.add(createServer(2, "b"));
122          servers.add(createServer(1, "c"));
123          servers.add(createServer(2, "c"));
124          balancer.setServersList(servers);
125          balancer.setUpServerList(servers);
126          testChooseServer(balancer, "us-east-1a", "us-east-1b", "us-east-1c");        
127          for (int i = 0; i < 3; i++) {
128              loadBalancerStats.incrementSuccessiveConnectionFailureCount(createServer(1, "a"));
129              loadBalancerStats.incrementSuccessiveConnectionFailureCount(createServer(2, "a"));
130          }
131          assertEquals(2, loadBalancerStats.getCircuitBreakerTrippedCount("us-east-1a"));
132          testChooseServer(balancer, "us-east-1b", "us-east-1c");
133          loadBalancerStats.incrementActiveRequestsCount(createServer(1, "b"));
134          loadBalancerStats.incrementActiveRequestsCount(createServer(1, "c"));
135          testChooseServer(balancer, "us-east-1b", "us-east-1c");        
136          loadBalancerStats.decrementActiveRequestsCount(createServer(1, "b"));
137          testChooseServer(balancer, "us-east-1b");
138      }
139      @Test
140      public void testNonZoneOverride() {
141          ZoneAwareLoadBalancer<Server> balancer = new ZoneAwareLoadBalancer<Server>();
142          balancer.init();
143          LoadBalancerStats loadBalancerStats = balancer.getLoadBalancerStats();
144          assertNotNull(loadBalancerStats);
145          List<Server> servers = new ArrayList<Server>();
146          for (int i = 1; i <= 11; i++) {
147              servers.add(createServer(i, "a"));
148              servers.add(createServer(i, "b"));            
149              servers.add(createServer(i, "c"));            
150          }
151          balancer.setServersList(servers);
152          balancer.setUpServerList(servers);
153          loadBalancerStats.incrementActiveRequestsCount(createServer(1, "b"));
154          loadBalancerStats.incrementActiveRequestsCount(createServer(1, "c"));
155          testChooseServer(balancer, "us-east-1a", "us-east-1b", "us-east-1c");
156          loadBalancerStats.incrementActiveRequestsCount(createServer(1, "b"));
157          loadBalancerStats.incrementActiveRequestsCount(createServer(1, "b"));
158          testChooseServer(balancer, "us-east-1a", "us-east-1c");
159          loadBalancerStats.incrementActiveRequestsCount(createServer(2, "c"));
160          loadBalancerStats.incrementActiveRequestsCount(createServer(4, "c"));
161          testChooseServer(balancer, "us-east-1a", "us-east-1b", "us-east-1c");
162      }
163      @Test
164      public void testAvailabilityFiltering() {
165          ZoneAwareLoadBalancer balancer = new ZoneAwareLoadBalancer();
166          balancer.init();
167          balancer.setRule(new AvailabilityFilteringRule());
168          LoadBalancerStats loadBalancerStats = balancer.getLoadBalancerStats();
169          assertNotNull(loadBalancerStats);
170          List<Server> servers = new ArrayList<Server>();        
171          servers.add(createServer(1, "a"));
172          servers.add(createServer(2, "a"));
173          servers.add(createServer(1, "b"));
174          servers.add(createServer(2, "b"));
175          servers.add(createServer(1, "c"));
176          servers.add(createServer(2, "c"));
177          balancer.setServersList(servers);
178          balancer.setUpServerList(servers);
179          for (int i = 0; i < 4; i++) {
180              Server server = servers.get(i);
181              for (int j = 0; j < 3; j++) {
182                  loadBalancerStats.getSingleServerStat(server).incrementSuccessiveConnectionFailureCount();
183              }
184          }
185          Set<Server> expected = new HashSet<Server>();
186          expected.add(createServer(1, "c"));
187          expected.add(createServer(2, "c"));
188          Set<Server> result = new HashSet<Server>();
189          for (int i = 0; i < 20; i++) {
190              Server server = balancer.chooseServer(null);
191              result.add(server);
192          }
193          assertEquals(expected, result);
194          for (int i = 0; i < 3; i++) {
195              loadBalancerStats.getSingleServerStat(servers.get(4)).incrementSuccessiveConnectionFailureCount();
196          }
197          for (int i = 0; i < 20; i++) {
198              Server server = balancer.chooseServer(null);
199              assertEquals(servers.get(5), server);
200          }
201          for (int i = 0; i < 3; i++) {
202              loadBalancerStats.getSingleServerStat(servers.get(5)).incrementSuccessiveConnectionFailureCount();
203          }
204          expected = new HashSet<Server>(servers);
205          result = new HashSet<Server>();
206          for (int i = 0; i < 20; i++) {
207              Server server = balancer.chooseServer(null);
208              if (server == null) {
209                  fail("Unexpected null server");
210              }
211              result.add(server);
212          }
213          assertEquals(expected, result);
214          servers = new ArrayList<Server>();        
215          servers.add(createServer(1, "a"));
216          servers.add(createServer(2, "a"));
217          servers.add(createServer(1, "b"));
218          servers.add(createServer(2, "b"));
219          balancer.setServersList(servers);
220          assertTrue(balancer.getLoadBalancer("us-east-1c").getAllServers().isEmpty());
221          AvailabilityFilteringRule rule = (AvailabilityFilteringRule) balancer.getLoadBalancer("us-east-1c").getRule();
222          assertEquals(0, rule.getAvailableServersCount());
223      }
224      @Test
225      public void testConstruction() {
226          ConfigurationManager.getConfigInstance().setProperty("mylb.ribbon.NFLoadBalancerRuleClassName", RandomRule.class.getName());
227          ZoneAwareLoadBalancer lb = (ZoneAwareLoadBalancer) ClientFactory.getNamedLoadBalancer("mylb");
228          assertTrue(lb.getLoadBalancer("myzone").getRule() instanceof RandomRule);
229      }
230      @Test
231      public void testActiveConnectionsLimit() {
232          ConfigurationManager.getConfigInstance().clearProperty("niws.loadbalancer.serverStats.activeRequestsCount.effectiveWindowSeconds");
233          ConfigurationManager.getConfigInstance().setProperty("testlb.ribbon.ActiveConnectionsLimit", 1);
234      	ZoneAwareLoadBalancer balancer = (ZoneAwareLoadBalancer) ClientFactory.getNamedLoadBalancer("testlb");
235          LoadBalancerStats loadBalancerStats = balancer.getLoadBalancerStats();
236          assertNotNull(loadBalancerStats);
237          List<Server> servers = new ArrayList<Server>();        
238          servers.add(createServer(1, "a"));
239          servers.add(createServer(2, "a"));
240          servers.add(createServer(3, "a"));
241          servers.add(createServer(4, "a"));
242          servers.add(createServer(5, "a"));
243          servers.add(createServer(6, "a"));
244          servers.add(createServer(1, "b"));
245          servers.add(createServer(2, "b"));
246          servers.add(createServer(3, "b"));
247          servers.add(createServer(4, "b"));
248          servers.add(createServer(5, "b"));
249          servers.add(createServer(6, "b"));
250          servers.add(createServer(7, "b"));
251          servers.add(createServer(8, "b"));
252          balancer.setServersList(servers);
253          balancer.setUpServerList(servers);
254          Server server = servers.get(0);
255          loadBalancerStats.getSingleServerStat(server).incrementActiveRequestsCount();
256          server = servers.get(8);
257          loadBalancerStats.getSingleServerStat(server).incrementActiveRequestsCount();
258          server = servers.get(servers.size() - 1);
259          for (int j = 0; j < 3; j++) {
260              loadBalancerStats.getSingleServerStat(server).incrementSuccessiveConnectionFailureCount();
261          }
262          Set<Server> expected = new HashSet<Server>();
263          expected.add(createServer(2, "a"));
264          expected.add(createServer(3, "a"));
265          expected.add(createServer(4, "a"));
266          expected.add(createServer(5, "a"));
267          expected.add(createServer(6, "a"));
268          expected.add(createServer(1, "b"));
269          expected.add(createServer(2, "b"));
270          expected.add(createServer(4, "b"));
271          expected.add(createServer(5, "b"));
272          expected.add(createServer(6, "b"));
273          expected.add(createServer(7, "b"));
274          AvailabilityFilteringRule rule = (AvailabilityFilteringRule) balancer.getRule();
275          assertEquals(expected.size(), rule.getAvailableServersCount());
276          AvailabilityFilteringRule rule1 = (AvailabilityFilteringRule) balancer.getLoadBalancer("us-east-1a").getRule();
277          assertEquals(5, rule1.getAvailableServersCount());
278          AvailabilityFilteringRule rule2 = (AvailabilityFilteringRule) balancer.getLoadBalancer("us-east-1b").getRule();
279          assertEquals(6, rule2.getAvailableServersCount());
280          Set<Server> result = new HashSet<Server>();
281          for (int i = 0; i < 100; i++) {            
282              result.add(balancer.chooseServer(null));
283          }
284          assertEquals(expected, result);
285      }
286  }
</code></pre>
        </div>
        <div class="column">
            <h3>ribbon-MDEwOlJlcG9zaXRvcnk3NjE2MTU4-flat-ZoneAwareLoadBalancerTest.java</h3>
            <pre><code>1  package com.netflix.loadbalancer;
2  import static org.junit.Assert.assertEquals;
3  import static org.junit.Assert.assertNotNull;
4  import static org.junit.Assert.assertNotSame;
5  import static org.junit.Assert.assertTrue;
6  import static org.junit.Assert.fail;
7  import java.util.ArrayList;
8  import java.util.Arrays;
9  import java.util.Collections;
10  import java.util.HashMap;
11  import java.util.HashSet;
12  import java.util.List;
13  import java.util.Map;
14  import java.util.Set;
15  import com.netflix.client.config.DefaultClientConfigImpl;
16  import org.junit.Ignore;
17  import org.junit.Test;
18  import com.netflix.client.ClientFactory;
19  import com.netflix.config.ConfigurationManager;
20  public class ZoneAwareLoadBalancerTest {
21      private Server createServer(String host, String zone) {
22          return createServer(host, 7001, zone);    
23      }
24      private Server createServer(String host, int port, String zone) {
25          Server server = new Server(host, port);
26          server.setZone(zone);
27          server.setAlive(true);
28          return server;
29      }
30      private Server createServer(int hostId, String zoneSuffix) {
31          return createServer(zoneSuffix + "-" + "server" + hostId, "us-eAst-1" + zoneSuffix);
32      }
33      private void testChooseServer(ZoneAwareLoadBalancer<Server> balancer, String... expectedZones) {
34          Set<String> result = new HashSet<String>();
35          for (int i = 0; i < 100; i++) {
36              Server server = balancer.chooseServer(null);
37              String zone = server.getZone().toLowerCase();
38              result.add(zone);
39          }
40          Set<String> expected = new HashSet<String>();
41          expected.addAll(Arrays.asList(expectedZones));
42          assertEquals(expected, result);
43      }
44      @Test
45      public void testChooseZone() throws Exception {
46          ConfigurationManager.getConfigInstance().setProperty("niws.loadbalancer.serverStats.activeRequestsCount.effectiveWindowSeconds", 10);
47          DefaultClientConfigImpl config = new DefaultClientConfigImpl();
48          config.loadProperties("testChooseZone");
49          ZoneAwareLoadBalancer<Server> balancer = new ZoneAwareLoadBalancer<Server>();
50          balancer.init();
51          IRule globalRule = new RoundRobinRule();
52          balancer.setRule(globalRule);        
53          LoadBalancerStats loadBalancerStats = balancer.getLoadBalancerStats();
54          loadBalancerStats.initWithNiwsConfig(config);
55          assertNotNull(loadBalancerStats);
56          List<Server> servers = new ArrayList<Server>();
57          servers.add(createServer(1, "a"));
58          servers.add(createServer(2, "a"));
59          servers.add(createServer(3, "a"));
60          servers.add(createServer(4, "a"));
61          servers.add(createServer(1, "b"));
62          servers.add(createServer(2, "b"));
63          servers.add(createServer(3, "b"));
64          servers.add(createServer(1, "c"));
65          servers.add(createServer(2, "c"));
66          servers.add(createServer(3, "c"));
67          servers.add(createServer(4, "c"));
68          balancer.setServersList(servers);
69          balancer.setUpServerList(servers);
70          assertTrue(balancer.getLoadBalancer("us-east-1a").getRule() instanceof RoundRobinRule);
71          assertNotSame(globalRule, balancer.getLoadBalancer("us-east-1a").getRule());
72          testChooseServer(balancer, "us-east-1a", "us-east-1b", "us-east-1c");
73          loadBalancerStats.incrementActiveRequestsCount(createServer(1, "c"));
74          loadBalancerStats.incrementActiveRequestsCount(createServer(3, "c"));
75          loadBalancerStats.incrementActiveRequestsCount(createServer(3, "c"));
76          loadBalancerStats.decrementActiveRequestsCount(createServer(3, "c"));
77          assertEquals(2, loadBalancerStats.getActiveRequestsCount("us-east-1c"));
78          assertEquals(0.5d, loadBalancerStats.getActiveRequestsPerServer("us-east-1c"), 0.0001d);
79          testChooseServer(balancer, "us-east-1a", "us-east-1b");
80          for (int i = 0; i < 3; i++) {
81              loadBalancerStats.incrementSuccessiveConnectionFailureCount(createServer(1, "a"));
82          }
83          assertEquals(1, loadBalancerStats.getCircuitBreakerTrippedCount("us-east-1a"));
84          loadBalancerStats.incrementSuccessiveConnectionFailureCount(createServer(2, "b"));
85          assertEquals(0, loadBalancerStats.getCircuitBreakerTrippedCount("us-east-1b"));        
86          testChooseServer(balancer, "us-east-1a", "us-east-1b");
87          loadBalancerStats.incrementActiveRequestsCount(createServer(2, "a"));
88          assertEquals(1d/3, loadBalancerStats.getActiveRequestsPerServer("us-east-1a"), 0.0001);
89          testChooseServer(balancer, "us-east-1b", "us-east-1a");
90          Thread.sleep(15000);
91          assertEquals(0, loadBalancerStats.getCircuitBreakerTrippedCount("us-east-1a"));
92          assertEquals(3, loadBalancerStats.getSingleServerStat(createServer(1, "a")).getSuccessiveConnectionFailureCount());
93          assertEquals(0, loadBalancerStats.getActiveRequestsCount("us-east-1c"));
94          assertEquals(0, loadBalancerStats.getSingleServerStat(createServer(1, "c")).getActiveRequestsCount());
95          loadBalancerStats.clearSuccessiveConnectionFailureCount(createServer(1, "a"));
96          assertEquals(0, loadBalancerStats.getSingleServerStat(createServer(1, "a")).getSuccessiveConnectionFailureCount());
97          assertEquals(0, loadBalancerStats.getCircuitBreakerTrippedCount("us-east-1a"));
98          loadBalancerStats.decrementActiveRequestsCount(createServer(2, "a"));
99          assertEquals(0, loadBalancerStats.getActiveRequestsPerServer("us-east-1b"), 0.000001);
100          assertEquals(0, loadBalancerStats.getActiveRequestsPerServer("us-east-1c"), 0.000001);
101          assertEquals(0, loadBalancerStats.getActiveRequestsPerServer("us-east-1a"), 0.000001);
102          testChooseServer(balancer, "us-east-1a", "us-east-1b", "us-east-1c");
103          List<Server> emptyList = Collections.emptyList();
104          Map<String, List<Server>> map = new HashMap<String, List<Server>>();
105          map.put("us-east-1a", emptyList);
106          map.put("us-east-1b", emptyList);
107          balancer.setServerListForZones(map);
108          testChooseServer(balancer, "us-east-1a", "us-east-1b", "us-east-1c");
109      }
110      @Test
111      public void testZoneOutage() throws Exception {
112          ConfigurationManager.getConfigInstance().clearProperty("niws.loadbalancer.serverStats.activeRequestsCount.effectiveWindowSeconds");
113          ZoneAwareLoadBalancer<Server> balancer = new ZoneAwareLoadBalancer<Server>();
114          balancer.init();
115          LoadBalancerStats loadBalancerStats = balancer.getLoadBalancerStats();
116          assertNotNull(loadBalancerStats);
117          List<Server> servers = new ArrayList<Server>();
118          servers.add(createServer(1, "a"));
119          servers.add(createServer(2, "a"));
120          servers.add(createServer(1, "b"));
121          servers.add(createServer(2, "b"));
122          servers.add(createServer(1, "c"));
123          servers.add(createServer(2, "c"));
124          balancer.setServersList(servers);
<span onclick='openModal()' class='match'>125          balancer.setUpServerList(servers);
126          testChooseServer(balancer, "us-east-1a", "us-east-1b", "us-east-1c");        
127          for (int i = 0; i < 3; i++) {
</span>128              loadBalancerStats.incrementSuccessiveConnectionFailureCount(createServer(1, "a"));
129              loadBalancerStats.incrementSuccessiveConnectionFailureCount(createServer(2, "a"));
130          }
131          assertEquals(2, loadBalancerStats.getCircuitBreakerTrippedCount("us-east-1a"));
132          testChooseServer(balancer, "us-east-1b", "us-east-1c");
133          loadBalancerStats.incrementActiveRequestsCount(createServer(1, "b"));
134          loadBalancerStats.incrementActiveRequestsCount(createServer(1, "c"));
135          testChooseServer(balancer, "us-east-1b", "us-east-1c");        
136          loadBalancerStats.decrementActiveRequestsCount(createServer(1, "b"));
137          testChooseServer(balancer, "us-east-1b");
138      }
139      @Test
140      public void testNonZoneOverride() {
141          ZoneAwareLoadBalancer<Server> balancer = new ZoneAwareLoadBalancer<Server>();
142          balancer.init();
143          LoadBalancerStats loadBalancerStats = balancer.getLoadBalancerStats();
144          assertNotNull(loadBalancerStats);
145          List<Server> servers = new ArrayList<Server>();
146          for (int i = 1; i <= 11; i++) {
147              servers.add(createServer(i, "a"));
148              servers.add(createServer(i, "b"));            
149              servers.add(createServer(i, "c"));            
150          }
151          balancer.setServersList(servers);
152          balancer.setUpServerList(servers);
153          loadBalancerStats.incrementActiveRequestsCount(createServer(1, "b"));
154          loadBalancerStats.incrementActiveRequestsCount(createServer(1, "c"));
155          testChooseServer(balancer, "us-east-1a", "us-east-1b", "us-east-1c");
156          loadBalancerStats.incrementActiveRequestsCount(createServer(1, "b"));
157          loadBalancerStats.incrementActiveRequestsCount(createServer(1, "b"));
158          testChooseServer(balancer, "us-east-1a", "us-east-1c");
159          loadBalancerStats.incrementActiveRequestsCount(createServer(2, "c"));
160          loadBalancerStats.incrementActiveRequestsCount(createServer(4, "c"));
161          testChooseServer(balancer, "us-east-1a", "us-east-1b", "us-east-1c");
162      }
163      @Test
164      public void testAvailabilityFiltering() {
165          ZoneAwareLoadBalancer balancer = new ZoneAwareLoadBalancer();
166          balancer.init();
167          balancer.setRule(new AvailabilityFilteringRule());
168          LoadBalancerStats loadBalancerStats = balancer.getLoadBalancerStats();
169          assertNotNull(loadBalancerStats);
170          List<Server> servers = new ArrayList<Server>();        
171          servers.add(createServer(1, "a"));
172          servers.add(createServer(2, "a"));
173          servers.add(createServer(1, "b"));
174          servers.add(createServer(2, "b"));
175          servers.add(createServer(1, "c"));
176          servers.add(createServer(2, "c"));
177          balancer.setServersList(servers);
178          balancer.setUpServerList(servers);
179          for (int i = 0; i < 4; i++) {
180              Server server = servers.get(i);
181              for (int j = 0; j < 3; j++) {
182                  loadBalancerStats.getSingleServerStat(server).incrementSuccessiveConnectionFailureCount();
183              }
184          }
185          Set<Server> expected = new HashSet<Server>();
186          expected.add(createServer(1, "c"));
187          expected.add(createServer(2, "c"));
188          Set<Server> result = new HashSet<Server>();
189          for (int i = 0; i < 20; i++) {
190              Server server = balancer.chooseServer(null);
191              result.add(server);
192          }
193          assertEquals(expected, result);
194          for (int i = 0; i < 3; i++) {
195              loadBalancerStats.getSingleServerStat(servers.get(4)).incrementSuccessiveConnectionFailureCount();
196          }
197          for (int i = 0; i < 20; i++) {
198              Server server = balancer.chooseServer(null);
199              assertEquals(servers.get(5), server);
200          }
201          for (int i = 0; i < 3; i++) {
202              loadBalancerStats.getSingleServerStat(servers.get(5)).incrementSuccessiveConnectionFailureCount();
203          }
204          expected = new HashSet<Server>(servers);
205          result = new HashSet<Server>();
206          for (int i = 0; i < 20; i++) {
207              Server server = balancer.chooseServer(null);
208              if (server == null) {
209                  fail("Unexpected null server");
210              }
211              result.add(server);
212          }
213          assertEquals(expected, result);
214          servers = new ArrayList<Server>();        
215          servers.add(createServer(1, "a"));
216          servers.add(createServer(2, "a"));
217          servers.add(createServer(1, "b"));
218          servers.add(createServer(2, "b"));
219          balancer.setServersList(servers);
220          assertTrue(balancer.getLoadBalancer("us-east-1c").getAllServers().isEmpty());
221          AvailabilityFilteringRule rule = (AvailabilityFilteringRule) balancer.getLoadBalancer("us-east-1c").getRule();
222          assertEquals(0, rule.getAvailableServersCount());
223      }
224      @Test
225      public void testConstruction() {
226          ConfigurationManager.getConfigInstance().setProperty("mylb.ribbon.NFLoadBalancerRuleClassName", RandomRule.class.getName());
227          ZoneAwareLoadBalancer lb = (ZoneAwareLoadBalancer) ClientFactory.getNamedLoadBalancer("mylb");
228          assertTrue(lb.getLoadBalancer("myzone").getRule() instanceof RandomRule);
229      }
230      @Test
231      public void testActiveConnectionsLimit() {
232          ConfigurationManager.getConfigInstance().clearProperty("niws.loadbalancer.serverStats.activeRequestsCount.effectiveWindowSeconds");
233          ConfigurationManager.getConfigInstance().setProperty("testlb.ribbon.ActiveConnectionsLimit", 1);
234      	ZoneAwareLoadBalancer balancer = (ZoneAwareLoadBalancer) ClientFactory.getNamedLoadBalancer("testlb");
235          LoadBalancerStats loadBalancerStats = balancer.getLoadBalancerStats();
236          assertNotNull(loadBalancerStats);
237          List<Server> servers = new ArrayList<Server>();        
238          servers.add(createServer(1, "a"));
239          servers.add(createServer(2, "a"));
240          servers.add(createServer(3, "a"));
241          servers.add(createServer(4, "a"));
242          servers.add(createServer(5, "a"));
243          servers.add(createServer(6, "a"));
244          servers.add(createServer(1, "b"));
245          servers.add(createServer(2, "b"));
246          servers.add(createServer(3, "b"));
247          servers.add(createServer(4, "b"));
248          servers.add(createServer(5, "b"));
249          servers.add(createServer(6, "b"));
250          servers.add(createServer(7, "b"));
251          servers.add(createServer(8, "b"));
252          balancer.setServersList(servers);
253          balancer.setUpServerList(servers);
254          Server server = servers.get(0);
255          loadBalancerStats.getSingleServerStat(server).incrementActiveRequestsCount();
256          server = servers.get(8);
257          loadBalancerStats.getSingleServerStat(server).incrementActiveRequestsCount();
258          server = servers.get(servers.size() - 1);
259          for (int j = 0; j < 3; j++) {
260              loadBalancerStats.getSingleServerStat(server).incrementSuccessiveConnectionFailureCount();
261          }
262          Set<Server> expected = new HashSet<Server>();
263          expected.add(createServer(2, "a"));
264          expected.add(createServer(3, "a"));
265          expected.add(createServer(4, "a"));
266          expected.add(createServer(5, "a"));
267          expected.add(createServer(6, "a"));
268          expected.add(createServer(1, "b"));
269          expected.add(createServer(2, "b"));
270          expected.add(createServer(4, "b"));
271          expected.add(createServer(5, "b"));
272          expected.add(createServer(6, "b"));
273          expected.add(createServer(7, "b"));
274          AvailabilityFilteringRule rule = (AvailabilityFilteringRule) balancer.getRule();
275          assertEquals(expected.size(), rule.getAvailableServersCount());
276          AvailabilityFilteringRule rule1 = (AvailabilityFilteringRule) balancer.getLoadBalancer("us-east-1a").getRule();
277          assertEquals(5, rule1.getAvailableServersCount());
278          AvailabilityFilteringRule rule2 = (AvailabilityFilteringRule) balancer.getLoadBalancer("us-east-1b").getRule();
279          assertEquals(6, rule2.getAvailableServersCount());
280          Set<Server> result = new HashSet<Server>();
281          for (int i = 0; i < 100; i++) {            
282              result.add(balancer.chooseServer(null));
283          }
284          assertEquals(expected, result);
285      }
286  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from ribbon-MDEwOlJlcG9zaXRvcnk3NjE2MTU4-flat-ZoneAwareLoadBalancerTest.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from ribbon-MDEwOlJlcG9zaXRvcnk3NjE2MTU4-flat-ZoneAwareLoadBalancerTest.java</div>
                </div>
                <div class="column column_space"><pre><code>107          balancer.setServerListForZones(map);
108          testChooseServer(balancer, "us-east-1a", "us-east-1b", "us-east-1c");
109      }
</pre></code></div>
                <div class="column column_space"><pre><code>125          balancer.setUpServerList(servers);
126          testChooseServer(balancer, "us-east-1a", "us-east-1b", "us-east-1c");        
127          for (int i = 0; i < 3; i++) {
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    