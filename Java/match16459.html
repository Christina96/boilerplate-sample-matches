<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for DefaultHttp2ConnectionEncoderTest.java &amp; OpenSslEngineTest.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for DefaultHttp2ConnectionEncoderTest.java &amp; OpenSslEngineTest.java
      </h3>
<h1 align="center">
        39.9%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>DefaultHttp2ConnectionEncoderTest.java (49.252804%)<th>OpenSslEngineTest.java (33.573853%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(23-83)<td><a href="#" name="0">(18-75)</a><td align="center"><font color="#ff0000">55</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(549-559)<td><a href="#" name="1">(607-632)</a><td align="center"><font color="#7d0000">27</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(465-475)<td><a href="#" name="2">(540-564)</a><td align="center"><font color="#7d0000">27</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(314-331)<td><a href="#" name="3">(649-671)</a><td align="center"><font color="#6f0000">24</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(287-302)<td><a href="#" name="4">(572-593)</a><td align="center"><font color="#6f0000">24</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(804-812)<td><a href="#" name="5">(705-722)</a><td align="center"><font color="#5c0000">20</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(373-382)<td><a href="#" name="6">(301-310)</a><td align="center"><font color="#530000">18</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(265-273)<td><a href="#" name="7">(315-321)</a><td align="center"><font color="#4e0000">17</font>
<tr onclick='openModal("#c58917")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c58917"><font color="#c58917">-</font><td><a href="#" name="8">(587-596)<td><a href="#" name="8">(346-353)</a><td align="center"><font color="#4a0000">16</font>
<tr onclick='openModal("#83a33a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#83a33a"><font color="#83a33a">-</font><td><a href="#" name="9">(780-787)<td><a href="#" name="9">(953-962)</a><td align="center"><font color="#450000">15</font>
<tr onclick='openModal("#ad5910")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ad5910"><font color="#ad5910">-</font><td><a href="#" name="10">(728-735)<td><a href="#" name="10">(794-802)</a><td align="center"><font color="#450000">15</font>
<tr onclick='openModal("#b041ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#b041ff"><font color="#b041ff">-</font><td><a href="#" name="11">(661-668)<td><a href="#" name="11">(1055-1064)</a><td align="center"><font color="#450000">15</font>
<tr onclick='openModal("#571b7e")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#571b7e"><font color="#571b7e">-</font><td><a href="#" name="12">(400-407)<td><a href="#" name="12">(777-785)</a><td align="center"><font color="#400000">14</font>
<tr onclick='openModal("#3b9c9c")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3b9c9c"><font color="#3b9c9c">-</font><td><a href="#" name="13">(334-339)<td><a href="#" name="13">(677-684)</a><td align="center"><font color="#400000">14</font>
<tr onclick='openModal("#842dce")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#842dce"><font color="#842dce">-</font><td><a href="#" name="14">(204-208)<td><a href="#" name="14">(724-740)</a><td align="center"><font color="#400000">14</font>
<tr onclick='openModal("#f52887")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f52887"><font color="#f52887">-</font><td><a href="#" name="15">(429-437)<td><a href="#" name="15">(291-300)</a><td align="center"><font color="#3c0000">13</font>
<tr onclick='openModal("#2981b2")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#2981b2"><font color="#2981b2">-</font><td><a href="#" name="16">(253-259)<td><a href="#" name="16">(356-362)</a><td align="center"><font color="#3c0000">13</font>
<tr onclick='openModal("#3090c7")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3090c7"><font color="#3090c7">-</font><td><a href="#" name="17">(124-128)<td><a href="#" name="17">(820-832)</a><td align="center"><font color="#3c0000">13</font>
<tr onclick='openModal("#800517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#800517"><font color="#800517">-</font><td><a href="#" name="18">(681-688)<td><a href="#" name="18">(878-881)</a><td align="center"><font color="#370000">12</font>
<tr onclick='openModal("#f62817")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f62817"><font color="#f62817">-</font><td><a href="#" name="19">(603-608)<td><a href="#" name="19">(1556-1562)</a><td align="center"><font color="#370000">12</font>
<tr onclick='openModal("#4e9258")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4e9258"><font color="#4e9258">-</font><td><a href="#" name="20">(539-546)<td><a href="#" name="20">(499-506)</a><td align="center"><font color="#370000">12</font>
<tr onclick='openModal("#947010")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#947010"><font color="#947010">-</font><td><a href="#" name="21">(243-250)<td><a href="#" name="21">(868-874)</a><td align="center"><font color="#370000">12</font>
<tr onclick='openModal("#4cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4cc417"><font color="#4cc417">-</font><td><a href="#" name="22">(176-177)<td><a href="#" name="22">(986-994)</a><td align="center"><font color="#370000">12</font>
<tr onclick='openModal("#f660ab")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f660ab"><font color="#f660ab">-</font><td><a href="#" name="23">(135-140)<td><a href="#" name="23">(640-648)</a><td align="center"><font color="#370000">12</font>
<tr onclick='openModal("#79764d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#79764d"><font color="#79764d">-</font><td><a href="#" name="24">(901-905)<td><a href="#" name="24">(940-944)</a><td align="center"><font color="#330000">11</font>
<tr onclick='openModal("#5eac10")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#5eac10"><font color="#5eac10">-</font><td><a href="#" name="25">(840-845)<td><a href="#" name="25">(931-936)</a><td align="center"><font color="#330000">11</font>
<tr onclick='openModal("#68818b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#68818b"><font color="#68818b">-</font><td><a href="#" name="26">(828-833)<td><a href="#" name="26">(859-863)</a><td align="center"><font color="#330000">11</font>
<tr onclick='openModal("#e77471")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#e77471"><font color="#e77471">-</font><td><a href="#" name="27">(817-820)<td><a href="#" name="27">(850-855)</a><td align="center"><font color="#330000">11</font>
<tr onclick='openModal("#717d7d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#717d7d"><font color="#717d7d">-</font><td><a href="#" name="28">(761-767)<td><a href="#" name="28">(78-84)</a><td align="center"><font color="#330000">11</font>
<tr onclick='openModal("#af7a82")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#af7a82"><font color="#af7a82">-</font><td><a href="#" name="29">(621-625)<td><a href="#" name="29">(768-772)</a><td align="center"><font color="#330000">11</font>
<tr onclick='openModal("#ae694a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ae694a"><font color="#ae694a">-</font><td><a href="#" name="30">(598-600)<td><a href="#" name="30">(759-764)</a><td align="center"><font color="#330000">11</font>
<tr onclick='openModal("#3ea99f")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#3ea99f"><font color="#3ea99f">-</font><td><a href="#" name="31">(523-531)<td><a href="#" name="31">(89-97)</a><td align="center"><font color="#330000">11</font>
<tr onclick='openModal("#5b8daf")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#5b8daf"><font color="#5b8daf">-</font><td><a href="#" name="32">(511-513)<td><a href="#" name="32">(686-690)</a><td align="center"><font color="#330000">11</font>
<tr onclick='openModal("#736aff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#736aff"><font color="#736aff">-</font><td><a href="#" name="33">(506-510)<td><a href="#" name="33">(472-475)</a><td align="center"><font color="#330000">11</font>
<tr onclick='openModal("#827d6b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#827d6b"><font color="#827d6b">-</font><td><a href="#" name="34">(438-442)<td><a href="#" name="34">(378-381)</a><td align="center"><font color="#330000">11</font>
<tr onclick='openModal("#41a317")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#41a317"><font color="#41a317">-</font><td><a href="#" name="35">(419-423)<td><a href="#" name="35">(337-340)</a><td align="center"><font color="#330000">11</font>
<tr onclick='openModal("#ff00ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ff00ff"><font color="#ff00ff">-</font><td><a href="#" name="36">(391-395)<td><a href="#" name="36">(281-284)</a><td align="center"><font color="#330000">11</font>
<tr onclick='openModal("#810541")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#810541"><font color="#810541">-</font><td><a href="#" name="37">(362-367)<td><a href="#" name="37">(242-245)</a><td align="center"><font color="#330000">11</font>
<tr onclick='openModal("#348781")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#348781"><font color="#348781">-</font><td><a href="#" name="38">(129-132)<td><a href="#" name="38">(1348-1351)</a><td align="center"><font color="#330000">11</font>
<tr onclick='openModal("#152dc6")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#152dc6"><font color="#152dc6">-</font><td><a href="#" name="39">(891-894)<td><a href="#" name="39">(442-446)</a><td align="center"><font color="#2e0000">10</font>
<tr onclick='openModal("#347235")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#347235"><font color="#347235">-</font><td><a href="#" name="40">(881-884)<td><a href="#" name="40">(423-427)</a><td align="center"><font color="#2e0000">10</font>
<tr onclick='openModal("#f87a17")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f87a17"><font color="#f87a17">-</font><td><a href="#" name="41">(862-865)<td><a href="#" name="41">(371-375)</a><td align="center"><font color="#2e0000">10</font>
<tr onclick='openModal("#c57717")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c57717"><font color="#c57717">-</font><td><a href="#" name="42">(717-723)<td><a href="#" name="42">(791-794)</a><td align="center"><font color="#2e0000">10</font>
<tr onclick='openModal("#c22817")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c22817"><font color="#c22817">-</font><td><a href="#" name="43">(673-675)<td><a href="#" name="43">(330-334)</a><td align="center"><font color="#2e0000">10</font>
<tr onclick='openModal("#a057a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#a057a5"><font color="#a057a5">-</font><td><a href="#" name="44">(651-656)<td><a href="#" name="44">(214-222)</a><td align="center"><font color="#2e0000">10</font>
<tr onclick='openModal("#549748")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#549748"><font color="#549748">-</font><td><a href="#" name="45">(644-647)<td><a href="#" name="45">(274-278)</a><td align="center"><font color="#2e0000">10</font>
<tr onclick='openModal("#668b8b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#668b8b"><font color="#668b8b">-</font><td><a href="#" name="46">(632-634)<td><a href="#" name="46">(235-239)</a><td align="center"><font color="#2e0000">10</font>
<tr onclick='openModal("#d16587")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#d16587"><font color="#d16587">-</font><td><a href="#" name="47">(612-618)<td><a href="#" name="47">(1564-1568)</a><td align="center"><font color="#2e0000">10</font>
<tr onclick='openModal("#c57726")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c57726"><font color="#c57726">-</font><td><a href="#" name="48">(600-603)<td><a href="#" name="48">(1453-1457)</a><td align="center"><font color="#2e0000">10</font>
<tr onclick='openModal("#8e35ef")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8e35ef"><font color="#8e35ef">-</font><td><a href="#" name="49">(514-516)<td><a href="#" name="49">(1237-1251)</a><td align="center"><font color="#2e0000">10</font>
<tr onclick='openModal("#ff0000")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ff0000"><font color="#ff0000">-</font><td><a href="#" name="50">(795-795)<td><a href="#" name="50">(1072-1073)</a><td align="center"><font color="#290000">9</font>
<tr onclick='openModal("#b38481")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#b38481"><font color="#b38481">-</font><td><a href="#" name="51">(769-769)<td><a href="#" name="51">(976-984)</a><td align="center"><font color="#290000">9</font>
<tr onclick='openModal("#2b60de")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#2b60de"><font color="#2b60de">-</font><td><a href="#" name="52">(754-759)<td><a href="#" name="52">(1291-1305)</a><td align="center"><font color="#290000">9</font>
<tr onclick='openModal("#ad5a3d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#ad5a3d"><font color="#ad5a3d">-</font><td><a href="#" name="53">(745-749)<td><a href="#" name="53">(967-975)</a><td align="center"><font color="#290000">9</font>
<tr onclick='openModal("#4e8975")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4e8975"><font color="#4e8975">-</font><td><a href="#" name="54">(693-696)<td><a href="#" name="54">(811-815)</a><td align="center"><font color="#290000">9</font>
<tr onclick='openModal("#4863a0")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#4863a0"><font color="#4863a0">-</font><td><a href="#" name="55">(656-659)<td><a href="#" name="55">(1527-1533)</a><td align="center"><font color="#290000">9</font>
<tr onclick='openModal("#52d017")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#52d017"><font color="#52d017">-</font><td><a href="#" name="56">(350-352)<td><a href="#" name="56">(1102-1106)</a><td align="center"><font color="#290000">9</font>
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="57">(280-287)<td><a href="#" name="57">(1203-1212)</a><td align="center"><font color="#290000">9</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="58">(190-191)<td><a href="#" name="58">(601-606)</a><td align="center"><font color="#290000">9</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="59">(155-156)<td><a href="#" name="59">(478-481)</a><td align="center"><font color="#290000">9</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>DefaultHttp2ConnectionEncoderTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 package io.netty.handler.codec.http2;
2 import io.netty.buffer.ByteBuf;
3 import io.netty.buffer.PooledByteBufAllocator;
4 import io.netty.buffer.Unpooled;
5 <a name="0"></a>import io.netty.buffer.UnpooledByteBufAllocator;
6 import io.netty.channel.Channel;
7 import io.netty.channel.ChannelConfig;
8 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import io.netty.channel.ChannelFuture;
9 import io.netty.channel.ChannelHandlerContext;
10 import io.netty.channel.ChannelMetadata;
11 import io.netty.channel.ChannelPipeline;
12 import io.netty.channel.ChannelPromise;
13 import io.netty.channel.DefaultChannelConfig;
14 import io.netty.channel.DefaultChannelPromise;
15 import io.netty.handler.codec.http.HttpResponseStatus;
16 import io.netty.handler.codec.http2.Http2RemoteFlowController.FlowControlled;
17 import io.netty.util.concurrent.ImmediateEventExecutor;
18 import junit.framework.AssertionFailedError;
19 import org.junit.jupiter.api.BeforeEach;
20 import org.junit.jupiter.api.Test;
21 import org.mockito.ArgumentCaptor;
22 import org.mockito.InOrder;
23 import org.mockito.Mock;
24 import org.mockito.MockitoAnnotations;
25 import org.mockito.invocation.InvocationOnMock;
26 import org.mockito.stubbing.Answer;
27 import java.util.ArrayList;
28 import java.util.List;
29 import static io.netty.buffer.Unpooled.EMPTY_BUFFER;
30 import static io.netty.buffer.Unpooled.wrappedBuffer;
31 import static io.netty.handler.codec.http2.Http2CodecUtil.DEFAULT_PRIORITY_WEIGHT;
32 import static io.netty.handler.codec.http2.Http2Error.PROTOCOL_ERROR;
33 import static io.netty.handler.codec.http2.Http2Stream.State.HALF_CLOSED_REMOTE;
34 import static io.netty.handler.codec.http2.Http2Stream.State.RESERVED_LOCAL;
35 import static io.netty.handler.codec.http2.Http2TestUtil.newVoidPromise;
36 import static io.netty.util.CharsetUtil.UTF_8;
37 import static org.hamcrest.MatcherAssert.assertThat;
38 import static org.hamcrest.CoreMatchers.instanceOf;
39 import static org.junit.jupiter.api.Assertions.assertEquals;
40 import static org.junit.jupiter.api.Assertions.assertFalse;
41 import static org.junit.jupiter.api.Assertions.assertNull;
42 import static org.junit.jupiter.api.Assertions.assertSame;
43 import static org.junit.jupiter.api.Assertions.assertTrue;
44 import static org.junit.jupiter.api.Assertions.fail;
45 import static org.mockito.Mockito.any;
46 import static org.mockito.Mockito.anyBoolean;
47 import static org.mockito.Mockito.anyInt;
48 import static org.mockito.Mockito.anyLong;
49 import static org.mockito.Mockito.anyShort;
50 import static org.mockito.Mockito.doAnswer;
51 import static org.mockito.Mockito.doNothing;
52 import static org.mockito.Mockito.eq;
53 import static org.mockito.Mockito.inOrder;
54 import static org.mockito.Mockito.mock;
55 import static org.mockito.Mockito.never;
56 import static org.mockito.Mockito.times;
57 import static org.mockito.Mockito.verify;
58 import static org.mockito.Mockito.verifyNoMoreInteractions;
59 import static org.mockito.Mockito.when;
60 public class DefaultHttp2ConnectionEncoderTest {
61     private static final int STREAM_ID = 2;
62     private static final int PUSH_STREAM_ID = 4</b></font>;
63     @Mock
64     private Http2RemoteFlowController remoteFlow;
65     @Mock
66     private ChannelHandlerContext ctx;
67     @Mock
68     private Channel channel;
69     @Mock
70     private Channel.Unsafe unsafe;
71     @Mock
72     private ChannelPipeline pipeline;
73     @Mock
74     private Http2FrameWriter writer;
75     @Mock
76     private Http2FrameWriter.Configuration writerConfig;
77     @Mock
78     private Http2FrameSizePolicy frameSizePolicy;
79     @Mock
80     private Http2LifecycleManager lifecycleManager;
81     private DefaultHttp2ConnectionEncoder encoder;
82     private Http2Connection connection;
83     private ArgumentCaptor&lt;Http2RemoteFlowController.FlowControlled&gt; payloadCaptor;
84     private List&lt;String&gt; writtenData;
85     private List&lt;Integer&gt; writtenPadding;
86     private boolean streamClosed;
87     @BeforeEach
88     public void setup() throws Exception {
89 <a name="17"></a>        MockitoAnnotations.initMocks(this);
90         ChannelMetadata metadata = new ChannelMetadata(false, 16);
91         <font color="#3090c7"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>when(channel.isActive()).thenReturn(true);
92         when(channel.pipeline()).thenReturn(pipeline);
93 <a name="38"></a>        when(channel.metadata()).thenReturn(metadata);
94         when(channel.unsafe()).thenReturn(unsafe);
95         ChannelConfig config = new DefaultChannelConfig(channel)</b></font>;
96         <font color="#348781"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>when(channel.config()).thenReturn(config);
97         doAnswer(new Answer&lt;ChannelFuture&gt;() {
98             @Override
99 <a name="23"></a>            public ChannelFuture answer(InvocationOnMock in</b></font>) {
100                 return newPromise().setFailure((Throwable) in.getArgument(0));
101             }
102         }).when(channel).newFailedFuture(<font color="#f660ab"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>any(Throwable.class));
103         when(writer.configuration()).thenReturn(writerConfig);
104         when(writerConfig.frameSizePolicy()).thenReturn(frameSizePolicy);
105         when(frameSizePolicy.maxFrameSize()).thenReturn(64);
106         doAnswer(new Answer&lt;ChannelFuture&gt;() {</b></font>
107             @Override
108             public ChannelFuture answer(InvocationOnMock in) throws Throwable {
109                 return ((ChannelPromise) in.getArguments()[2]).setSuccess();
110             }
111         }).when(writer).writeSettings(eq(ctx), any(Http2Settings.class), any(ChannelPromise.class));
112         doAnswer(new Answer&lt;ChannelFuture&gt;() {
113             @Override
114             public ChannelFuture answer(InvocationOnMock in) throws Throwable {
115                 ((ByteBuf) in.getArguments()[3]).release();
116                 return ((ChannelPromise) in.getArguments()[4]).setSuccess();
117             }
118 <a name="59"></a>        }).when(writer).writeGoAway(eq(ctx), anyInt(), anyInt(), any(ByteBuf.class), any(ChannelPromise.class));
119         writtenData = new ArrayList&lt;String&gt;();
120         writtenPadding = new ArrayList&lt;Integer&gt;();
121         <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>when(writer.writeData(eq(ctx), anyInt(), any(ByteBuf.class), anyInt(), anyBoolean(),
122                 any</b></font>(ChannelPromise.class))).then(new Answer&lt;ChannelFuture&gt;() {
123                     @Override
124                     public ChannelFuture answer(InvocationOnMock in) throws Throwable {
125                         ChannelPromise promise = (ChannelPromise) in.getArguments()[5];
126                         if (streamClosed) {
127                             fail("Stream already closed");
128                         } else {
129                             streamClosed = (Boolean) in.getArguments()[4];
130                         }
131                         writtenPadding.add((Integer) in.getArguments()[3]);
132                         ByteBuf data = (ByteBuf) in.getArguments()[2];
133                         writtenData.add(data.toString(UTF_8));
134                         data.release();
135 <a name="22"></a>                        return promise.setSuccess();
136                     }
137                 });
138         <font color="#4cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>when(writer.writeHeaders(eq(ctx), anyInt(), any(Http2Headers.class), anyInt(), anyShort(), anyBoolean(),
139                 anyInt(), anyBoolean(), any</b></font>(ChannelPromise.class)))
140                 .then(new Answer&lt;ChannelFuture&gt;() {
141                     @Override
142                     public ChannelFuture answer(InvocationOnMock invocationOnMock) {
143                         ChannelPromise promise = invocationOnMock.getArgument(8);
144                         if (streamClosed) {
145                             fail("Stream already closed");
146                         } else {
147                             streamClosed = invocationOnMock.getArgument(5);
148                         }
149 <a name="58"></a>                        return promise.setSuccess();
150                     }
151                 });
152         <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>when(writer.writeHeaders(eq(ctx), anyInt(), any(Http2Headers.class),
153                 anyInt(), anyBoolean(), any</b></font>(ChannelPromise.class)))
154                 .then(new Answer&lt;ChannelFuture&gt;() {
155                     @Override
156                     public ChannelFuture answer(InvocationOnMock invocationOnMock) {
157                         ChannelPromise promise = invocationOnMock.getArgument(5);
158                         if (streamClosed) {
159                             fail("Stream already closed");
160                         } else {
161                             streamClosed = invocationOnMock.getArgument(4);
162                         }
163 <a name="14"></a>                        return promise.setSuccess();
164                     }
165                 });
166         <font color="#842dce"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>payloadCaptor = ArgumentCaptor.forClass(Http2RemoteFlowController.FlowControlled.class);
167         doNothing().when(remoteFlow).addFlowControlled(any(Http2Stream.class), payloadCaptor.capture());
168         when(ctx.alloc()).thenReturn(UnpooledByteBufAllocator.DEFAULT);
169         when(ctx.channel()).thenReturn(channel);
170         doAnswer(new Answer&lt;ChannelPromise&gt;() {</b></font>
171             @Override
172             public ChannelPromise answer(InvocationOnMock in) throws Throwable {
173                 return newPromise();
174             }
175         }).when(ctx).newPromise();
176         doAnswer(new Answer&lt;ChannelFuture&gt;() {
177             @Override
178             public ChannelFuture answer(InvocationOnMock in) throws Throwable {
179                 return newSucceededFuture();
180             }
181         }).when(ctx).newSucceededFuture();
182         when(ctx.flush()).thenThrow(new AssertionFailedError("forbidden"));
183         when(channel.alloc()).thenReturn(PooledByteBufAllocator.DEFAULT);
184         connection = new DefaultHttp2Connection(true);
185         connection.remote().flowController(remoteFlow);
186         encoder = new DefaultHttp2ConnectionEncoder(connection, writer);
187         encoder.lifecycleManager(lifecycleManager);
188     }
189     @Test
190     public void dataWithEndOfStreamWriteShouldSignalThatFrameWasConsumedOnError() throws Exception {
191         dataWriteShouldSignalThatFrameWasConsumedOnError0(true);
192     }
193     @Test
194     public void dataWriteShouldSignalThatFrameWasConsumedOnError() throws Exception {
195         dataWriteShouldSignalThatFrameWasConsumedOnError0(false);
196     }
197 <a name="21"></a>
198     private void dataWriteShouldSignalThatFrameWasConsumedOnError0(boolean endOfStream) throws Exception {
199         createStream(STREAM_ID, false);
200         final ByteBuf data = <font color="#947010"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>dummyData();
201         ChannelPromise p = newPromise();
202         encoder.writeData(ctx, STREAM_ID, data, 0, endOfStream, p);
203         FlowControlled controlled = payloadCaptor.getValue();
204         assertEquals(8, controlled.size());
205         payloadCaptor.getValue().write(ctx, 4);
206 <a name="16"></a>        assertEquals(4, controlled.size</b></font>());
207         Throwable error = new IllegalStateException();
208         <font color="#2981b2"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>payloadCaptor.getValue().error(ctx, error);
209         payloadCaptor.getValue().write(ctx, 8);
210         assertEquals(0, controlled.size());
211         assertEquals("abcd", writtenData.get(0));
212         assertEquals(0, data.refCnt());
213         assertSame(error, p.cause());
214     }</b></font>
215     @Test
216 <a name="7"></a>    public void dataWriteShouldSucceed() throws Exception {
217         createStream(STREAM_ID, false);
218         final ByteBuf data = dummyData();
219         ChannelPromise p = <font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newPromise();
220         encoder.writeData(ctx, STREAM_ID, data, 0, true, p);
221         assertEquals(8, payloadCaptor.getValue().size());
222         payloadCaptor.getValue().write(ctx, 8);
223         assertEquals(0, payloadCaptor.getValue().size());
224         assertEquals("abcdefgh", writtenData.get(0));
225         assertEquals(0, data.refCnt());
226         assertTrue(p.isSuccess());
227     }</b></font>
228     @Test
229     public void dataFramesShouldMerge() throws Exception {
230 <a name="57"></a>        createStream(STREAM_ID, false);
231         final ByteBuf data = dummyData().retain();
232         <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>ChannelPromise promise1 = newPromise();
233         encoder.writeData(ctx, STREAM_ID, data, 0, true, promise1);
234         ChannelPromise promise2 = newPromise();
235         encoder.writeData(ctx, STREAM_ID, data, 0, true, promise2);
236 <a name="4"></a>
237         List&lt;FlowControlled&gt; capturedWrites = payloadCaptor.getAllValues();
238         FlowControlled mergedPayload = <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>capturedWrites.get(0)</b></font>;
239         mergedPayload.merge(ctx, capturedWrites.get(1));
240         assertEquals(16, mergedPayload.size());
241         assertFalse(promise1.isDone());
242         assertFalse(promise2.isDone());
243         mergedPayload.write(ctx, 16);
244         assertEquals(0, mergedPayload.size());
245         assertEquals("abcdefghabcdefgh", writtenData.get(0));
246         assertEquals(0, data.refCnt());
247         assertTrue(promise1.isSuccess());
248         assertTrue(promise2.isSuccess());
249     }
250     @</b></font>Test
251     public void dataFramesShouldMergeUseVoidPromise() throws Exception {
252         createStream(STREAM_ID, false);
253         final ByteBuf data = dummyData().retain();
254         ChannelPromise promise1 = newVoidPromise(channel);
255         encoder.writeData(ctx, STREAM_ID, data, 0, true, promise1);
256         ChannelPromise promise2 = newVoidPromise(channel);
257         encoder.writeData(ctx, STREAM_ID, data, 0, true, promise2);
258 <a name="3"></a>
259         List&lt;FlowControlled&gt; capturedWrites = payloadCaptor.getAllValues();
260         FlowControlled mergedPayload = <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>capturedWrites.get(0);
261         mergedPayload.merge(ctx, capturedWrites.get(1));
262         assertEquals(16, mergedPayload.size());
263         assertFalse(promise1.isSuccess());
264         assertFalse(promise2.isSuccess());
265         mergedPayload.write(ctx, 16);
266         assertEquals(0, mergedPayload.size());
267         assertEquals("abcdefghabcdefgh", writtenData.get(0));
268         assertEquals(0, data.refCnt());
269         assertFalse(promise1.isSuccess());
270         assertFalse(promise2.isSuccess());
271     }
272 <a name="13"></a>    @</b></font>Test
273     public void dataFramesDontMergeWithHeaders() throws Exception {
274         createStream(STREAM_ID, false);
275         final ByteBuf data = <font color="#3b9c9c"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>dummyData().retain();
276         encoder.writeData(ctx, STREAM_ID, data, 0, false, newPromise());
277         when(remoteFlow.hasFlowControlled(any(Http2Stream.class))).thenReturn(true);
278         encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, newPromise());
279         List&lt;FlowControlled&gt; capturedWrites = payloadCaptor.getAllValues();
280         assertFalse(capturedWrites.get(0).merge</b></font>(ctx, capturedWrites.get(1)));
281     }
282     @Test
283     public void emptyFrameShouldSplitPadding() throws Exception {
284         ByteBuf data = Unpooled.buffer(0);
285         assertSplitPaddingOnEmptyBuffer(data);
286         assertEquals(0, data.refCnt());
287 <a name="56"></a>    }
288     @Test
289     public void writeHeadersUsingVoidPromise() throws Exception <font color="#52d017"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>{
290         final Throwable cause = new RuntimeException("fake exception");
291         when(writer.writeHeaders(eq(ctx), eq(STREAM_ID), any</b></font>(Http2Headers.class),
292                                  anyInt(), anyBoolean(), any(ChannelPromise.class)))
293                 .then(new Answer&lt;ChannelFuture&gt;() {
294                     @Override
295                     public ChannelFuture answer(InvocationOnMock invocationOnMock) throws Throwable {
296                         ChannelPromise promise = invocationOnMock.getArgument(5);
297                         assertFalse(promise.isVoid());
298 <a name="37"></a>                        return promise.setFailure(cause);
299                     }
300                 });
301         <font color="#810541"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>createStream(STREAM_ID, false);
302         encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, newVoidPromise(channel));
303         verify(writer).writeHeaders(eq(ctx), eq(STREAM_ID), any(Http2Headers.class),
304                                     anyInt(), anyBoolean(), any</b></font>(ChannelPromise.class));
305         verify(pipeline).fireExceptionCaught(cause);
306 <a name="6"></a>    }
307     private void assertSplitPaddingOnEmptyBuffer(ByteBuf data) throws Exception {
308         <font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>createStream(STREAM_ID, false);
309         when(frameSizePolicy.maxFrameSize()).thenReturn(5);
310         ChannelPromise p = newPromise();
311         encoder.writeData(ctx, STREAM_ID, data, 10, true, p);
312         assertEquals(10, payloadCaptor.getValue().size());
313         payloadCaptor.getValue().write(ctx, 10);
314         assertEquals(1, writtenData.size());
315         assertEquals("", writtenData.get(0));
316         assertEquals(10, (int) writtenPadding.get</b></font>(0));
317         assertEquals(0, data.refCnt());
318         assertTrue(p.isSuccess());
319     }
320     @Test
321 <a name="36"></a>    public void headersWriteForUnknownStreamShouldCreateStream() throws Exception {
322         writeAllFlowControlledFrames();
323         final int streamId = 6;
324         ChannelPromise promise = <font color="#ff00ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newPromise();
325         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise);
326         verify(writer).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE), eq(0),
327                 eq(false), eq(promise));
328         assertTrue</b></font>(promise.isSuccess());
329     }
330 <a name="12"></a>
331     @Test
332     public void headersWriteShouldOpenStreamForPush() throws Exception {
333         <font color="#571b7e"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>writeAllFlowControlledFrames();
334         Http2Stream parent = createStream(STREAM_ID, false);
335         reservePushStream(PUSH_STREAM_ID, parent);
336         ChannelPromise promise = newPromise();
337         encoder.writeHeaders(ctx, PUSH_STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, false, promise);
338         assertEquals(HALF_CLOSED_REMOTE, stream(PUSH_STREAM_ID).state());
339         verify(writer).writeHeaders(eq(ctx), eq</b></font>(PUSH_STREAM_ID), eq(EmptyHttp2Headers.INSTANCE),
340                 eq(0), eq(false), eq(promise));
341     }
342     @Test
343     public void trailersDoNotEndStreamThrows() {
344         writeAllFlowControlledFrames();
345         final int streamId = 6;
346         ChannelPromise promise = newPromise();
347 <a name="35"></a>        encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise);
348         ChannelPromise promise2 = newPromise();
349         ChannelFuture future = <font color="#41a317"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise2);
350         assertTrue(future.isDone());
351         assertFalse(future.isSuccess());
352         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq</b></font>(EmptyHttp2Headers.INSTANCE),
353                 eq(0), eq(false), eq(promise));
354     }
355 <a name="15"></a>
356     @Test
357     public void trailersDoNotEndStreamWithDataThrows() {
358         <font color="#f52887"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>writeAllFlowControlledFrames();
359         final int streamId = 6;
360         ChannelPromise promise = newPromise();
361         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise);
362         Http2Stream stream = connection.stream(streamId);
363 <a name="34"></a>        when(remoteFlow.hasFlowControlled(eq(stream))).thenReturn(true);
364         ChannelPromise promise2 = newPromise</b></font>();
365         ChannelFuture future = <font color="#827d6b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise2);
366         assertTrue(future.isDone());
367         assertFalse(future.isSuccess());
368         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq</b></font>(EmptyHttp2Headers.INSTANCE),
369                 eq(0), eq(false), eq(promise));
370     }
371     @Test
372     public void tooManyHeadersNoEOSThrows() {
373         tooManyHeadersThrows(false);
374     }
375     @Test
376     public void tooManyHeadersEOSThrows() {
377         tooManyHeadersThrows(true);
378     }
379     private void tooManyHeadersThrows(boolean eos) {
380         writeAllFlowControlledFrames();
381         final int streamId = 6;
382         ChannelPromise promise = newPromise();
383         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise);
384         ChannelPromise promise2 = newPromise();
385 <a name="2"></a>        encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, true, promise2);
386         ChannelPromise promise3 = newPromise();
387         ChannelFuture future = <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, eos, promise3);
388         assertTrue(future.isDone());
389         assertFalse(future.isSuccess());
390         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
391                 eq(0), eq(false), eq(promise));
392         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
393                 eq(0), eq(true), eq(promise2));
394     }
395     @</b></font>Test
396     public void infoHeadersAndTrailersAllowed() throws Exception {
397         infoHeadersAndTrailers(true, 1);
398     }
399     @Test
400     public void multipleInfoHeadersAndTrailersAllowed() throws Exception {
401         infoHeadersAndTrailers(true, 10);
402     }
403     @Test
404     public void infoHeadersAndTrailersNoEOSThrows() throws Exception {
405         infoHeadersAndTrailers(false, 1);
406     }
407     @Test
408     public void multipleInfoHeadersAndTrailersNoEOSThrows() throws Exception {
409         infoHeadersAndTrailers(false, 10);
410     }
411     private void infoHeadersAndTrailers(boolean eos, int infoHeaderCount) {
412         writeAllFlowControlledFrames();
413         final int streamId = 6;
414         Http2Headers infoHeaders = informationalHeaders();
415         for (int i = 0; i &lt; infoHeaderCount; ++i) {
416             encoder.writeHeaders(ctx, streamId, infoHeaders, 0, false, newPromise());
417         }
418         ChannelPromise promise2 = newPromise();
419 <a name="33"></a>        encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise2);
420         ChannelPromise promise3 = newPromise();
421         ChannelFuture future = <font color="#736aff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, eos, promise3);
422         assertTrue(future.isDone());
423 <a name="32"></a>        assertEquals(eos, future.isSuccess());
424         verify(writer, times(infoHeaderCount)).writeHeaders(eq(ctx), eq(streamId), eq</b></font>(infoHeaders),
425 <a name="49"></a>                <font color="#5b8daf"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>eq(0), eq(false), any(ChannelPromise.class));
426         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
427                 eq(0), eq</b></font>(false), eq(promise2));
428         if (eos) <font color="#8e35ef"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>{
429             verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
430                     eq(0), eq(true), eq</b></font>(promise3));
431         }
432     }
433 <a name="31"></a>    private static Http2Headers informationalHeaders() {
434         Http2Headers headers = new DefaultHttp2Headers();
435         headers.status(HttpResponseStatus.CONTINUE.codeAsText());
436         <font color="#3ea99f"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>return headers;
437     }
438     @Test
439     public void tooManyHeadersWithDataNoEOSThrows() {
440         tooManyHeadersWithDataThrows(false);
441     }
442     @</b></font>Test
443     public void tooManyHeadersWithDataEOSThrows() {
444         tooManyHeadersWithDataThrows(true);
445     }
446 <a name="20"></a>    private void tooManyHeadersWithDataThrows(boolean eos) {
447         writeAllFlowControlledFrames();
448         final int streamId = 6;
449         <font color="#4e9258"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>ChannelPromise promise = newPromise();
450         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise);
451         Http2Stream stream = connection.stream(streamId);
452         when(remoteFlow.hasFlowControlled(eq(stream))).thenReturn(true);
453         ChannelPromise promise2 = newPromise();
454 <a name="1"></a>        encoder.writeHeaders</b></font>(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, true, promise2);
455         ChannelPromise promise3 = newPromise();
456         ChannelFuture future = <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, eos, promise3);
457         assertTrue(future.isDone());
458         assertFalse(future.isSuccess());
459         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
460                 eq(0), eq(false), eq(promise));
461         verify(writer, times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
462                 eq(0), eq(true), eq(promise2));
463     }
464     @</b></font>Test
465     public void infoHeadersAndTrailersWithDataAllowed() {
466         infoHeadersAndTrailersWithData(true, 1);
467     }
468     @Test
469     public void multipleInfoHeadersAndTrailersWithDataAllowed() {
470         infoHeadersAndTrailersWithData(true, 10);
471     }
472     @Test
473     public void infoHeadersAndTrailersWithDataNoEOSThrows() {
474         infoHeadersAndTrailersWithData(false, 1);
475     }
476     @Test
477     public void multipleInfoHeadersAndTrailersWithDataNoEOSThrows() {
478         infoHeadersAndTrailersWithData(false, 10);
479     }
480     private void infoHeadersAndTrailersWithData(boolean eos, int infoHeaderCount) {
481         writeAllFlowControlledFrames();
482         final int streamId = 6;
483         Http2Headers infoHeaders = informationalHeaders();
484         for (int i = 0; i &lt; infoHeaderCount; ++i) {
485 <a name="8"></a>            encoder.writeHeaders(ctx, streamId, infoHeaders, 0, false, newPromise());
486         }
487         Http2Stream stream = <font color="#c58917"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>connection.stream(streamId);
488         when(remoteFlow.hasFlowControlled(eq(stream))).thenReturn(true);
489         ChannelPromise promise2 = newPromise();
490         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise2);
491         ChannelPromise promise3 = newPromise();
492         ChannelFuture future = encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, eos, promise3);
493 <a name="30"></a>        assertTrue(future.isDone());
494         assertEquals(eos, future.isSuccess</b></font>());
495 <a name="48"></a>
496         <font color="#ae694a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>verify(writer, times(infoHeaderCount)).writeHeaders(eq(ctx), eq(streamId), eq(infoHeaders),
497                 eq(0), eq(false), any(ChannelPromise.class));
498 <a name="19"></a>        verify</b></font>(writer, <font color="#c57726"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>times(1)).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
499                 eq(0), eq(false), eq(promise2));
500         if (eos) {
501             verify(writer, times(1)).writeHeaders</b></font>(<font color="#f62817"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
502                     eq(0), eq(true), eq(promise3));
503         }
504     }
505     @</b></font>Test
506 <a name="47"></a>    public void pushPromiseWriteAfterGoAwayReceivedShouldFail() throws Exception {
507         createStream(STREAM_ID, false);
508         goAwayReceived(0);
509         ChannelFuture future = <font color="#d16587"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>encoder.writePushPromise(ctx, STREAM_ID, PUSH_STREAM_ID, EmptyHttp2Headers.INSTANCE, 0,
510                 newPromise());
511         assertTrue(future.isDone());
512         assertFalse(future.isSuccess());
513     }
514 <a name="29"></a>    @</b></font>Test
515     public void pushPromiseWriteShouldReserveStream() throws Exception {
516         createStream(STREAM_ID, false);
517         ChannelPromise promise = <font color="#af7a82"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newPromise();
518         encoder.writePushPromise(ctx, STREAM_ID, PUSH_STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, promise);
519         assertEquals(RESERVED_LOCAL, stream(PUSH_STREAM_ID).state());
520         verify(writer).writePushPromise(eq(ctx), eq(STREAM_ID), eq(PUSH_STREAM_ID),
521                 eq</b></font>(EmptyHttp2Headers.INSTANCE), eq(0), eq(promise));
522     }
523     @Test
524 <a name="46"></a>    public void priorityWriteAfterGoAwayShouldSucceed() throws Exception {
525         createStream(STREAM_ID, false);
526         goAwayReceived(Integer.MAX_VALUE);
527         ChannelPromise promise = <font color="#668b8b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newPromise();
528         encoder.writePriority(ctx, STREAM_ID, 0, (short) 255, true, promise);
529         verify(writer).writePriority(eq(ctx), eq(STREAM_ID), eq(0), eq((short) 255), eq(true), eq</b></font>(promise));
530     }
531     @Test
532     public void priorityWriteShouldSetPriorityForStream() throws Exception {
533         ChannelPromise promise = newPromise();
534         short weight = 255;
535 <a name="45"></a>        encoder.writePriority(ctx, STREAM_ID, 0, weight, true, promise);
536         Http2Stream stream = <font color="#549748"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>stream(STREAM_ID);
537         assertNull(stream);
538         verify(writer).writePriority(eq(ctx), eq(STREAM_ID), eq(0), eq((short) 255), eq(true), eq</b></font>(promise));
539 <a name="44"></a>    }
540     @Test
541     public void priorityWriteOnPreviouslyExistingStreamShouldSucceed() throws Exception <font color="#a057a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>{
542         createStream(STREAM_ID, false).close();
543 <a name="55"></a>        ChannelPromise promise = newPromise();
544         short weight = 255;
545         encoder.writePriority(ctx, STREAM_ID, 0, weight, true, promise);
546         verify(writer).writePriority(eq</b></font>(ctx), <font color="#4863a0"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>eq(STREAM_ID), eq(0), eq(weight), eq(true), eq(promise));
547     }
548 <a name="11"></a>
549     @</b></font>Test
550     public void priorityWriteOnPreviouslyExistingParentStreamShouldSucceed() throws Exception {
551         <font color="#b041ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>final int parentStreamId = STREAM_ID + 2;
552         createStream(STREAM_ID, false);
553         createStream(parentStreamId, false).close();
554         ChannelPromise promise = newPromise();
555         short weight = 255;
556         encoder.writePriority(ctx, STREAM_ID, parentStreamId, weight, true, promise);
557         verify(writer).writePriority(eq(ctx), eq(STREAM_ID), eq(parentStreamId), eq(weight), eq</b></font>(true), eq(promise));
558     }
559 <a name="43"></a>
560     @Test
561     public void rstStreamWriteForUnknownStreamShouldIgnore() throws Exception {
562         ChannelPromise promise = <font color="#c22817"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newPromise();
563         encoder.writeRstStream(ctx, 5, PROTOCOL_ERROR.code(), promise);
564         verify(writer, never()).writeRstStream(eq(ctx), anyInt(), anyLong(), eq</b></font>(promise));
565     }
566 <a name="18"></a>    @Test
567     public void rstStreamShouldCloseStream() throws Exception {
568         <font color="#800517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>writeAllFlowControlledFrames();
569         encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, newPromise());
570         stream(STREAM_ID);
571         ChannelPromise promise = newPromise();
572         encoder.writeRstStream(ctx, STREAM_ID, PROTOCOL_ERROR.code(), promise);
573         verify(lifecycleManager).resetStream(eq(ctx), eq</b></font>(STREAM_ID), anyLong(), eq(promise));
574     }
575 <a name="54"></a>
576     @Test
577     public void pingWriteAfterGoAwayShouldSucceed() throws Exception {
578         ChannelPromise promise = <font color="#4e8975"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newPromise();
579         goAwayReceived(0);
580         encoder.writePing(ctx, false, 0L, promise);
581         verify(writer).writePing(eq(ctx), eq(false), eq(0L), eq</b></font>(promise));
582     }
583     @Test
584     public void pingWriteShouldSucceed() throws Exception {
585         ChannelPromise promise = newPromise();
586         encoder.writePing(ctx, false, 0L, promise);
587         verify(writer).writePing(eq(ctx), eq(false), eq(0L), eq(promise));
588     }
589     @Test
590     public void settingsWriteAfterGoAwayShouldSucceed() throws Exception {
591         goAwayReceived(0);
592         ChannelPromise promise = newPromise();
593         encoder.writeSettings(ctx, new Http2Settings(), promise);
594         verify(writer).writeSettings(eq(ctx), any(Http2Settings.class), eq(promise));
595     }
596 <a name="42"></a>    @Test
597     public void settingsWriteShouldNotUpdateSettings() throws Exception {
598         Http2Settings settings = new Http2Settings();
599         <font color="#c57717"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>settings.initialWindowSize(100);
600         settings.maxConcurrentStreams(1000);
601         settings.headerTableSize(2000);
602         ChannelPromise promise = newPromise();
603         encoder.writeSettings(ctx, settings, promise);
604         verify(writer).writeSettings(eq(ctx), eq</b></font>(settings), eq(promise));
605     }
606 <a name="10"></a>
607     @Test
608     public void dataWriteShouldCreateHalfClosedStream() throws Exception {
609         <font color="#ad5910"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>writeAllFlowControlledFrames();
610         Http2Stream stream = createStream(STREAM_ID, false);
611         ByteBuf data = dummyData();
612         ChannelPromise promise = newPromise();
613         encoder.writeData(ctx, STREAM_ID, data.retain(), 0, true, promise);
614         assertTrue(promise.isSuccess());
615         verify(remoteFlow).addFlowControlled(eq(stream), any</b></font>(FlowControlled.class));
616         verify(lifecycleManager).closeStreamLocal(stream, promise);
617         assertEquals(data.toString(UTF_8), writtenData.get(0));
618         data.release();
619     }
620     @Test
621 <a name="53"></a>    public void headersWriteShouldHalfCloseStream() throws Exception {
622         writeAllFlowControlledFrames();
623         createStream(STREAM_ID, false);
624         ChannelPromise promise = <font color="#ad5a3d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newPromise();
625         encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, promise);
626         assertTrue(promise.isSuccess());
627         verify(lifecycleManager).closeStreamLocal(eq(stream(STREAM_ID)), eq</b></font>(promise));
628     }
629 <a name="52"></a>
630     @Test
631     public void headersWriteShouldHalfClosePushStream() throws Exception {
632         <font color="#2b60de"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>writeAllFlowControlledFrames();
633         Http2Stream parent = createStream(STREAM_ID, false);
634         Http2Stream stream = reservePushStream(PUSH_STREAM_ID, parent);
635         ChannelPromise promise = newPromise();
636 <a name="28"></a>        encoder.writeHeaders(ctx, PUSH_STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, promise);
637         assertEquals</b></font>(HALF_CLOSED_REMOTE, stream.state());
638         assertTrue(promise.isSuccess());
639         verify(lifecycleManager).closeStreamLocal(<font color="#717d7d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>eq(stream), eq(promise));
640     }
641     @Test
642     public void headersWriteShouldHalfCloseAfterOnErrorForPreCreatedStream() throws Exception {
643 <a name="51"></a>        final ChannelPromise promise = newPromise();
644         final Throwable ex = new</b></font> RuntimeException();
645         <font color="#b38481"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>when(writer.writeHeaders(eq(ctx), eq(STREAM_ID), eq(EmptyHttp2Headers.INSTANCE), eq(0), eq(true), eq</b></font>(promise)))
646             .thenAnswer(new Answer&lt;ChannelFuture&gt;() {
647                 @Override
648                 public ChannelFuture answer(InvocationOnMock invocation) {
649                     promise.setFailure(ex);
650                     return promise;
651                 }
652             });
653 <a name="9"></a>
654         writeAllFlowControlledFrames();
655         Http2Stream stream = createStream(STREAM_ID, false);
656         <font color="#83a33a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, promise);
657         assertTrue(promise.isDone());
658         assertFalse(promise.isSuccess());
659         assertFalse(stream.isHeadersSent());
660         InOrder inOrder = inOrder(lifecycleManager);
661         inOrder.verify(lifecycleManager).onError(eq(ctx), eq(true), eq(ex));
662         inOrder.verify(lifecycleManager).closeStreamLocal</b></font>(eq(stream(STREAM_ID)), eq(promise));
663     }
664     @Test
665     public void headersWriteShouldHalfCloseAfterOnErrorForImplicitlyCreatedStream() throws Exception {
666 <a name="50"></a>        final ChannelPromise promise = newPromise();
667         final Throwable ex = new RuntimeException();
668         <font color="#ff0000"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>when(writer.writeHeaders(eq(ctx), eq(STREAM_ID), eq(EmptyHttp2Headers.INSTANCE), eq(0), eq(true), eq</b></font>(promise)))
669             .thenAnswer(new Answer&lt;ChannelFuture&gt;() {
670                 @Override
671                 public ChannelFuture answer(InvocationOnMock invocation) {
672                     promise.setFailure(ex);
673                     return promise;
674 <a name="5"></a>                }
675             });
676         <font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>writeAllFlowControlledFrames();
677         encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, true, promise);
678         assertTrue(promise.isDone());
679         assertFalse(promise.isSuccess());
680         assertFalse(stream(STREAM_ID).isHeadersSent());
681         InOrder inOrder = inOrder(lifecycleManager);
682         inOrder.verify(lifecycleManager).onError(eq(ctx), eq(true), eq(ex));
683         inOrder.verify(lifecycleManager).closeStreamLocal(eq(stream</b></font>(STREAM_ID)), eq(promise));
684     }
685 <a name="27"></a>
686     @Test
687     public void encoderDelegatesGoAwayToLifeCycleManager() {
688         ChannelPromise promise = <font color="#e77471"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newPromise();
689         encoder.writeGoAway(ctx, STREAM_ID, Http2Error.INTERNAL_ERROR.code(), null, promise);
690         verify(lifecycleManager).goAway(eq(ctx), eq(STREAM_ID), eq(Http2Error.INTERNAL_ERROR.code()),
691                 eq((ByteBuf) null), eq</b></font>(promise));
692         verifyNoMoreInteractions(writer);
693     }
694     @Test
695 <a name="26"></a>    public void dataWriteToClosedStreamShouldFail() throws Exception {
696         createStream(STREAM_ID, false).close();
697         ByteBuf data = mock(ByteBuf.class);
698         ChannelPromise promise = <font color="#68818b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newPromise();
699         encoder.writeData(ctx, STREAM_ID, data, 0, false, promise);
700         assertTrue(promise.isDone());
701         assertFalse(promise.isSuccess());
702         assertThat(promise.cause(), instanceOf(IllegalArgumentException.class));
703         verify</b></font>(data).release();
704     }
705     @Test
706 <a name="25"></a>    public void dataWriteToHalfClosedLocalStreamShouldFail() throws Exception {
707         createStream(STREAM_ID, true);
708         ByteBuf data = mock(ByteBuf.class);
709         ChannelPromise promise = <font color="#5eac10"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newPromise();
710         encoder.writeData(ctx, STREAM_ID, data, 0, false, promise);
711         assertTrue(promise.isDone());
712         assertFalse(promise.isSuccess());
713         assertThat(promise.cause(), instanceOf(IllegalStateException.class));
714         verify</b></font>(data).release();
715     }
716     @Test
717     public void canWriteDataFrameAfterGoAwaySent() throws Exception {
718         Http2Stream stream = createStream(STREAM_ID, false);
719         connection.goAwaySent(0, 0, EMPTY_BUFFER);
720         ByteBuf data = mock(ByteBuf.class);
721         encoder.writeData(ctx, STREAM_ID, data, 0, false, newPromise());
722         verify(remoteFlow).addFlowControlled(eq(stream), any(FlowControlled.class));
723     }
724     @Test
725     public void canWriteHeaderFrameAfterGoAwaySent() throws Exception {
726 <a name="41"></a>        writeAllFlowControlledFrames();
727         createStream(STREAM_ID, false);
728         goAwaySent(0);
729         ChannelPromise promise = <font color="#f87a17"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newPromise();
730         encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, false, promise);
731         verify(writer).writeHeaders(eq(ctx), eq(STREAM_ID), eq(EmptyHttp2Headers.INSTANCE),
732                 eq(0), eq(false), eq</b></font>(promise));
733     }
734     @Test
735     public void canWriteDataFrameAfterGoAwayReceived() throws Exception {
736         Http2Stream stream = createStream(STREAM_ID, false);
737         goAwayReceived(STREAM_ID);
738         ByteBuf data = mock(ByteBuf.class);
739         encoder.writeData(ctx, STREAM_ID, data, 0, false, newPromise());
740         verify(remoteFlow).addFlowControlled(eq(stream), any(FlowControlled.class));
741     }
742     @Test
743 <a name="40"></a>    public void canWriteHeaderFrameAfterGoAwayReceived() throws Http2Exception {
744         writeAllFlowControlledFrames();
745         goAwayReceived(STREAM_ID);
746         ChannelPromise promise = <font color="#347235"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newPromise();
747         encoder.writeHeaders(ctx, STREAM_ID, EmptyHttp2Headers.INSTANCE, 0, false, promise);
748         verify(writer).writeHeaders(eq(ctx), eq(STREAM_ID), eq(EmptyHttp2Headers.INSTANCE),
749                 eq(0), eq(false), eq</b></font>(promise));
750     }
751     @Test
752 <a name="39"></a>    public void headersWithNoPriority() {
753         writeAllFlowControlledFrames();
754         final int streamId = 6;
755         ChannelPromise promise = <font color="#152dc6"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newPromise();
756         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 0, false, promise);
757         verify(writer).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE),
758                 eq(0), eq(false), eq</b></font>(promise));
759     }
760     @Test
761 <a name="24"></a>    public void headersWithPriority() {
762         writeAllFlowControlledFrames();
763         final int streamId = 6;
764         ChannelPromise promise = <font color="#79764d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>newPromise();
765         encoder.writeHeaders(ctx, streamId, EmptyHttp2Headers.INSTANCE, 10, DEFAULT_PRIORITY_WEIGHT,
766                 true, 1, false, promise);
767         verify(writer).writeHeaders(eq(ctx), eq(streamId), eq(EmptyHttp2Headers.INSTANCE), eq(10),
768                 eq(DEFAULT_PRIORITY_WEIGHT), eq(true), eq</b></font>(1), eq(false), eq(promise));
769     }
770     private void writeAllFlowControlledFrames() {
771         doAnswer(new Answer&lt;Void&gt;() {
772             @Override
773             public Void answer(InvocationOnMock invocationOnMock) throws Throwable {
774                 FlowControlled flowControlled = (FlowControlled) invocationOnMock.getArguments()[1];
775                 flowControlled.write(ctx, Integer.MAX_VALUE);
776                 flowControlled.writeComplete();
777                 return null;
778             }
779         }).when(remoteFlow).addFlowControlled(any(Http2Stream.class), payloadCaptor.capture());
780     }
781     private Http2Stream createStream(int streamId, boolean halfClosed) throws Http2Exception {
782         return connection.local().createStream(streamId, halfClosed);
783     }
784     private Http2Stream reservePushStream(int pushStreamId, Http2Stream parent) throws Http2Exception {
785         return connection.local().reservePushStream(pushStreamId, parent);
786     }
787     private Http2Stream stream(int streamId) {
788         return connection.stream(streamId);
789     }
790     private void goAwayReceived(int lastStreamId) throws Http2Exception {
791         connection.goAwayReceived(lastStreamId, 0, EMPTY_BUFFER);
792     }
793     private void goAwaySent(int lastStreamId) throws Http2Exception {
794         connection.goAwaySent(lastStreamId, 0, EMPTY_BUFFER);
795     }
796     private ChannelPromise newPromise() {
797         return new DefaultChannelPromise(channel, ImmediateEventExecutor.INSTANCE);
798     }
799     private ChannelFuture newSucceededFuture() {
800         return newPromise().setSuccess();
801     }
802     private static ByteBuf dummyData() {
803         return wrappedBuffer("abcdefgh".getBytes(UTF_8));
804     }
805 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>OpenSslEngineTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Copyright 2015 The Netty Project
3  *
4  * The Netty Project licenses this file to you under the Apache License,
5  * version 2.0 (the "License"); you may not use this file except in compliance
6  * with the License. You may obtain a copy of the License at:
7  *
8  *   https://www.apache.org/licenses/LICENSE-2.0
9  *
10  * Unless required by applicable law or agreed to in writing, software
11  * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
12  * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
13  * License for the specific language governing permissions and limitations
14  * under the License.
15 <a name="0"></a> */
16 package io.netty.handler.ssl;
17 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import io.netty.buffer.UnpooledByteBufAllocator;
18 import io.netty.handler.ssl.ApplicationProtocolConfig.Protocol;
19 import io.netty.handler.ssl.ApplicationProtocolConfig.SelectedListenerFailureBehavior;
20 import io.netty.handler.ssl.ApplicationProtocolConfig.SelectorFailureBehavior;
21 import io.netty.handler.ssl.util.InsecureTrustManagerFactory;
22 import io.netty.handler.ssl.util.SelfSignedCertificate;
23 import io.netty.internal.tcnative.SSL;
24 import io.netty.util.CharsetUtil;
25 import io.netty.util.internal.EmptyArrays;
26 import io.netty.util.internal.PlatformDependent;
27 import org.junit.AssumptionViolatedException;
28 import org.junit.jupiter.api.AfterEach;
29 import org.junit.jupiter.api.BeforeAll;
30 import org.junit.jupiter.api.function.Executable;
31 import org.junit.jupiter.params.ParameterizedTest;
32 import org.junit.jupiter.params.provider.MethodSource;
33 import javax.crypto.Cipher;
34 import javax.crypto.spec.IvParameterSpec;
35 import javax.crypto.spec.SecretKeySpec;
36 import javax.net.ssl.SSLEngine;
37 import javax.net.ssl.SSLEngineResult;
38 import javax.net.ssl.SSLEngineResult.HandshakeStatus;
39 import javax.net.ssl.SSLException;
40 import javax.net.ssl.SSLHandshakeException;
41 import javax.net.ssl.SSLParameters;
42 import javax.net.ssl.X509ExtendedKeyManager;
43 import java.net.Socket;
44 import java.nio.ByteBuffer;
45 import java.security.AlgorithmConstraints;
46 import java.security.AlgorithmParameters;
47 import java.security.CryptoPrimitive;
48 import java.security.Key;
49 import java.security.Principal;
50 import java.security.PrivateKey;
51 import java.security.cert.X509Certificate;
52 import java.util.ArrayList;
53 import java.util.Arrays;
54 import java.util.List;
55 import java.util.Set;
56 import static io.netty.handler.ssl.OpenSslTestUtils.checkShouldUseKeyManagerFactory;
57 import static io.netty.handler.ssl.ReferenceCountedOpenSslEngine.MAX_PLAINTEXT_LENGTH;
58 import static io.netty.internal.tcnative.SSL.SSL_CVERIFY_IGNORED;
59 import static java.lang.Integer.MAX_VALUE;
60 import static org.junit.jupiter.api.Assertions.assertArrayEquals;
61 import static org.junit.jupiter.api.Assertions.assertEquals;
62 import static org.junit.jupiter.api.Assertions.assertFalse;
63 import static org.junit.jupiter.api.Assertions.assertNotEquals;
64 import static org.junit.jupiter.api.Assertions.assertNull;
65 import static org.junit.jupiter.api.Assertions.assertSame;
66 import static org.junit.jupiter.api.Assertions.assertThrows;
67 import static org.junit.jupiter.api.Assertions.assertTrue;
68 import static org.junit.jupiter.api.Assumptions.assumeTrue;
69 public class OpenSslEngineTest extends SSLEngineTest {
70     private static final String PREFERRED_APPLICATION_LEVEL_PROTOCOL = "my-protocol-http2";
71 <a name="28"></a>    private static final String FALLBACK_APPLICATION_LEVEL_PROTOCOL = "my-protocol-http1_1"</b></font>;
72     public OpenSslEngineTest() {
73         <font color="#717d7d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>super(SslProvider.isTlsv13Supported(SslProvider.OPENSSL));
74     }
75     @Override
76     protected List&lt;SSLEngineTestParam&gt; newTestParams() {
77         List&lt;SSLEngineTestParam&gt; params = super.newTestParams();
78         List&lt;SSLEngineTestParam&gt; testParams = new</b></font> ArrayList&lt;SSLEngineTestParam&gt;();
79         for (SSLEngineTestParam param: params) {
80 <a name="31"></a>            testParams.add(new OpenSslEngineTestParam(true, param));
81             testParams.add(new OpenSslEngineTestParam(false, param));
82         }
83         <font color="#3ea99f"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>return testParams;
84     }
85     @BeforeAll
86     public static void checkOpenSsl() {
87         OpenSsl.ensureAvailability();
88     }
89     @</b></font>AfterEach
90     @Override
91     public void tearDown() throws InterruptedException {
92         super.tearDown();
93         assertEquals(0, SSL.getLastErrorNumber(), "SSL error stack not correctly consumed");
94     }
95     @Override
96     public void testSessionAfterHandshakeKeyManagerFactory(SSLEngineTestParam param) throws Exception {
97         checkShouldUseKeyManagerFactory();
98         super.testSessionAfterHandshakeKeyManagerFactory(param);
99     }
100     @Override
101     public void testSessionAfterHandshakeKeyManagerFactoryMutualAuth(SSLEngineTestParam param) throws Exception {
102         checkShouldUseKeyManagerFactory();
103         super.testSessionAfterHandshakeKeyManagerFactoryMutualAuth(param);
104     }
105     @Override
106     public void testMutualAuthInvalidIntermediateCASucceedWithOptionalClientAuth(SSLEngineTestParam param)
107             throws Exception {
108         checkShouldUseKeyManagerFactory();
109         super.testMutualAuthInvalidIntermediateCASucceedWithOptionalClientAuth(param);
110     }
111     @Override
112     public void testMutualAuthInvalidIntermediateCAFailWithOptionalClientAuth(SSLEngineTestParam param)
113             throws Exception {
114         checkShouldUseKeyManagerFactory();
115         super.testMutualAuthInvalidIntermediateCAFailWithOptionalClientAuth(param);
116     }
117     @Override
118     public void testMutualAuthInvalidIntermediateCAFailWithRequiredClientAuth(SSLEngineTestParam param)
119             throws Exception {
120         checkShouldUseKeyManagerFactory();
121         super.testMutualAuthInvalidIntermediateCAFailWithRequiredClientAuth(param);
122     }
123     @Override
124     public void testMutualAuthValidClientCertChainTooLongFailOptionalClientAuth(SSLEngineTestParam param)
125             throws Exception {
126         checkShouldUseKeyManagerFactory();
127         super.testMutualAuthValidClientCertChainTooLongFailOptionalClientAuth(param);
128     }
129     @Override
130     public void testMutualAuthValidClientCertChainTooLongFailRequireClientAuth(SSLEngineTestParam param)
131             throws Exception {
132         checkShouldUseKeyManagerFactory();
133         super.testMutualAuthValidClientCertChainTooLongFailRequireClientAuth(param);
134     }
135     @Override
136     public void testHandshakeSession(SSLEngineTestParam param) throws Exception {
137         checkShouldUseKeyManagerFactory();
138         super.testHandshakeSession(param);
139     }
140     @Override
141     public void testSupportedSignatureAlgorithms(SSLEngineTestParam param) throws Exception {
142         checkShouldUseKeyManagerFactory();
143         super.testSupportedSignatureAlgorithms(param);
144     }
145     private static boolean isNpnSupported(String versionString) {
146         String[] versionStringParts = versionString.split(" ", -1);
147         if (versionStringParts.length == 2 &amp;&amp; "LibreSSL".equals(versionStringParts[0])) {
148             String[] versionParts = versionStringParts[1].split("\\.", -1);
149             if (versionParts.length == 3) {
150                 int major = Integer.parseInt(versionParts[0]);
151                 if (major &lt; 2) {
152                     return true;
153                 }
154                 if (major &gt; 2) {
155                     return false;
156                 }
157                 int minor = Integer.parseInt(versionParts[1]);
158                 if (minor &lt; 6) {
159                     return true;
160                 }
161                 if (minor &gt; 6) {
162                     return false;
163                 }
164                 int bugfix = Integer.parseInt(versionParts[2]);
165                 if (bugfix &gt; 0) {
166                     return false;
167                 }
168             }
169         }
170         return true;
171     }
172     @MethodSource("newTestParams")
173     @ParameterizedTest
174     public void testNpn(SSLEngineTestParam param) throws Exception {
175         String versionString = OpenSsl.versionString();
176         assumeTrue(isNpnSupported(versionString), "LibreSSL 2.6.1 removed NPN support, detected " + versionString);
177         ApplicationProtocolConfig apn = acceptingNegotiator(Protocol.NPN,
178                 PREFERRED_APPLICATION_LEVEL_PROTOCOL);
179         setupHandlers(param, apn);
180         runTest(PREFERRED_APPLICATION_LEVEL_PROTOCOL);
181     }
182     @MethodSource("newTestParams")
183     @ParameterizedTest
184     public void testAlpn(SSLEngineTestParam param) throws Exception {
185         assumeTrue(OpenSsl.isAlpnSupported());
186         ApplicationProtocolConfig apn = acceptingNegotiator(Protocol.ALPN,
187                 PREFERRED_APPLICATION_LEVEL_PROTOCOL);
188         setupHandlers(param, apn);
189         runTest(PREFERRED_APPLICATION_LEVEL_PROTOCOL);
190     }
191 <a name="44"></a>
192     @MethodSource("newTestParams")
193     @ParameterizedTest
194     public void testAlpnCompatibleProtocolsDifferentClientOrder(SSLEngineTestParam param) throws Exception <font color="#a057a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>{
195         assumeTrue(OpenSsl.isAlpnSupported());
196         ApplicationProtocolConfig clientApn = acceptingNegotiator(Protocol.ALPN,
197                 FALLBACK_APPLICATION_LEVEL_PROTOCOL, PREFERRED_APPLICATION_LEVEL_PROTOCOL);
198         ApplicationProtocolConfig serverApn = acceptingNegotiator(Protocol.ALPN,
199                 PREFERRED_APPLICATION_LEVEL_PROTOCOL, FALLBACK_APPLICATION_LEVEL_PROTOCOL);
200         setupHandlers(param, serverApn, clientApn);
201         assertNull(serverException);
202         runTest</b></font>(PREFERRED_APPLICATION_LEVEL_PROTOCOL);
203     }
204     @MethodSource("newTestParams")
205     @ParameterizedTest
206     public void testEnablingAnAlreadyDisabledSslProtocol(SSLEngineTestParam param) throws Exception {
207         testEnablingAnAlreadyDisabledSslProtocol(param, new String[]{SslProtocols.SSL_v2_HELLO},
208             new String[]{SslProtocols.SSL_v2_HELLO, SslProtocols.TLS_v1_2});
209     }
210 <a name="46"></a>    @MethodSource("newTestParams")
211     @ParameterizedTest
212     public void testWrapBuffersNoWritePendingError(SSLEngineTestParam param) throws Exception {
213         clientSslCtx = <font color="#668b8b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder.forClient()
214                                         .trustManager(InsecureTrustManagerFactory.INSTANCE)
215                                         .sslProvider(sslClientProvider())
216                                         .protocols(param.protocols())
217 <a name="37"></a>                                        .ciphers(param.ciphers</b></font>())
218                                         .build());
219         SelfSignedCertificate ssc = new SelfSignedCertificate();
220         serverSslCtx = <font color="#810541"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey())
221                                         .sslProvider(sslServerProvider())
222                                         .protocols(param.protocols())
223                                         .ciphers(param.ciphers</b></font>())
224                                         .build());
225         SSLEngine clientEngine = null;
226         SSLEngine serverEngine = null;
227         try {
228             clientEngine = wrapEngine(clientSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
229             serverEngine = wrapEngine(serverSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
230             handshake(param.type(), param.delegate(), clientEngine, serverEngine);
231             ByteBuffer src = allocateBuffer(param.type(), 1024 * 10);
232             byte[] data = new byte[src.capacity()];
233             PlatformDependent.threadLocalRandom().nextBytes(data);
234             src.put(data).flip();
235             ByteBuffer dst = allocateBuffer(param.type(), 1);
236             for (int i = 0; i &lt; 100; i++) {
237                 src.position(0);
238                 dst.position(0);
239                 assertSame(SSLEngineResult.Status.BUFFER_OVERFLOW, clientEngine.wrap(src, dst).getStatus());
240             }
241         } finally {
242             cleanupClientSslEngine(clientEngine);
243             cleanupServerSslEngine(serverEngine);
244         }
245     }
246 <a name="45"></a>    @MethodSource("newTestParams")
247     @ParameterizedTest
248     public void testOnlySmallBufferNeededForWrap(SSLEngineTestParam param) throws Exception {
249         clientSslCtx = <font color="#549748"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder.forClient()
250                                         .trustManager(InsecureTrustManagerFactory.INSTANCE)
251                                         .sslProvider(sslClientProvider())
252                                         .protocols(param.protocols())
253 <a name="36"></a>                                        .ciphers(param.ciphers</b></font>())
254                                         .build());
255         SelfSignedCertificate ssc = new SelfSignedCertificate();
256         serverSslCtx = <font color="#ff00ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey())
257                                         .sslProvider(sslServerProvider())
258                                         .protocols(param.protocols())
259                                         .ciphers(param.ciphers</b></font>())
260                                         .build());
261         SSLEngine clientEngine = null;
262         SSLEngine serverEngine = null;
263 <a name="15"></a>        try {
264             clientEngine = wrapEngine(clientSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
265             serverEngine = wrapEngine(serverSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
266             handshake(param.type(), <font color="#f52887"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>param.delegate(), clientEngine, serverEngine);
267             int srcLen = 1024;
268             ByteBuffer src = allocateBuffer(param.type(), srcLen);
269 <a name="6"></a>            ByteBuffer dstTooSmall = allocateBuffer(
270                     param.type(), src.capacity() + unwrapEngine(clientEngine).maxWrapOverhead() - 1);
271             ByteBuffer dst = allocateBuffer</b></font>(
272                     <font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>param.type(), src.capacity() + unwrapEngine(clientEngine).maxWrapOverhead());
273             SSLEngineResult result = clientEngine.wrap(src, dstTooSmall);
274             assertEquals(SSLEngineResult.Status.BUFFER_OVERFLOW, result.getStatus());
275             assertEquals(0, result.bytesConsumed());
276             assertEquals(0, result.bytesProduced());
277             assertEquals(src.remaining(), src.capacity());
278             assertEquals(dst.remaining(), dst.capacity</b></font>());
279 <a name="7"></a>                        result = clientEngine.wrap(src, dst);
280             <font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(SSLEngineResult.Status.OK, result.getStatus());
281             assertEquals(srcLen, result.bytesConsumed());
282             assertEquals(0, src.remaining());
283             assertTrue(result.bytesProduced() &gt; srcLen);
284             assertEquals(src.capacity() - result.bytesConsumed(), src.remaining());
285             assertEquals(dst.capacity() - result.bytesProduced(), dst.remaining());
286         }</b></font> finally {
287             cleanupClientSslEngine(clientEngine);
288             cleanupServerSslEngine(serverEngine);
289         }
290     }
291 <a name="43"></a>    @MethodSource("newTestParams")
292     @ParameterizedTest
293     public void testNeededDstCapacityIsCorrectlyCalculated(SSLEngineTestParam param) throws Exception {
294         clientSslCtx = <font color="#c22817"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder.forClient()
295                                         .trustManager(InsecureTrustManagerFactory.INSTANCE)
296                                         .sslProvider(sslClientProvider())
297                                         .protocols(param.protocols())
298 <a name="35"></a>                                        .ciphers(param.ciphers</b></font>())
299                                         .build());
300         SelfSignedCertificate ssc = new SelfSignedCertificate();
301         serverSslCtx = <font color="#41a317"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey())
302                                         .sslProvider(sslServerProvider())
303                                         .protocols(param.protocols())
304                                         .ciphers(param.ciphers</b></font>())
305                                         .build());
306         SSLEngine clientEngine = null;
307 <a name="8"></a>        SSLEngine serverEngine = null;
308         try {
309             clientEngine = wrapEngine(clientSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
310             serverEngine = <font color="#c58917"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapEngine(serverSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
311             handshake(param.type(), param.delegate(), clientEngine, serverEngine);
312             ByteBuffer src = allocateBuffer(param.type(), 1024);
313             ByteBuffer src2 = src.duplicate();
314             ByteBuffer dst = allocateBuffer(param.type(), src.capacity()
315 <a name="16"></a>                    + unwrapEngine</b></font>(clientEngine).maxWrapOverhead());
316             SSLEngineResult result = clientEngine.wrap(new ByteBuffer[] { src, src2 }, dst);
317             <font color="#2981b2"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(SSLEngineResult.Status.BUFFER_OVERFLOW, result.getStatus());
318             assertEquals(0, src.position());
319             assertEquals(0, src2.position());
320             assertEquals(0, dst.position());
321             assertEquals(0, result.bytesConsumed());
322             assertEquals(0, result.bytesProduced());
323         }</b></font> finally {
324             cleanupClientSslEngine(clientEngine);
325             cleanupServerSslEngine(serverEngine);
326         }
327     }
328 <a name="41"></a>    @MethodSource("newTestParams")
329     @ParameterizedTest
330     public void testSrcsLenOverFlowCorrectlyHandled(SSLEngineTestParam param) throws Exception {
331         clientSslCtx = <font color="#f87a17"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder.forClient()
332                                         .trustManager(InsecureTrustManagerFactory.INSTANCE)
333                                         .sslProvider(sslClientProvider())
334                                         .protocols(param.protocols())
335 <a name="34"></a>                                        .ciphers(param.ciphers</b></font>())
336                                         .build());
337         SelfSignedCertificate ssc = new SelfSignedCertificate();
338         serverSslCtx = <font color="#827d6b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey())
339                                         .sslProvider(sslServerProvider())
340                                         .protocols(param.protocols())
341                                         .ciphers(param.ciphers</b></font>())
342                                         .build());
343         SSLEngine clientEngine = null;
344         SSLEngine serverEngine = null;
345         try {
346             clientEngine = wrapEngine(clientSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
347             serverEngine = wrapEngine(serverSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
348             handshake(param.type(), param.delegate(), clientEngine, serverEngine);
349             ByteBuffer src = allocateBuffer(param.type(), 1024);
350             List&lt;ByteBuffer&gt; srcList = new ArrayList&lt;ByteBuffer&gt;();
351             long srcsLen = 0;
352             long maxLen = ((long) MAX_VALUE) * 2;
353             while (srcsLen &lt; maxLen) {
354                 ByteBuffer dup = src.duplicate();
355                 srcList.add(dup);
356                 srcsLen += dup.capacity();
357             }
358             ByteBuffer[] srcs = srcList.toArray(new ByteBuffer[0]);
359             ByteBuffer dst = allocateBuffer(
360                     param.type(), unwrapEngine(clientEngine).maxEncryptedPacketLength() - 1);
361             SSLEngineResult result = clientEngine.wrap(srcs, dst);
362             assertEquals(SSLEngineResult.Status.BUFFER_OVERFLOW, result.getStatus());
363             for (ByteBuffer buffer : srcs) {
364                 assertEquals(0, buffer.position());
365             }
366             assertEquals(0, dst.position());
367             assertEquals(0, result.bytesConsumed());
368             assertEquals(0, result.bytesProduced());
369         } finally {
370             cleanupClientSslEngine(clientEngine);
371             cleanupServerSslEngine(serverEngine);
372         }
373     }
374 <a name="40"></a>    @MethodSource("newTestParams")
375     @ParameterizedTest
376     public void testCalculateOutNetBufSizeOverflow(SSLEngineTestParam param) throws SSLException {
377         clientSslCtx = <font color="#347235"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder.forClient()
378                                         .trustManager(InsecureTrustManagerFactory.INSTANCE)
379                                         .sslProvider(sslClientProvider())
380                                         .protocols(param.protocols())
381                                         .ciphers(param.ciphers</b></font>())
382                                         .build());
383         SSLEngine clientEngine = null;
384         try {
385             clientEngine = clientSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT);
386             int value = ((ReferenceCountedOpenSslEngine) clientEngine).calculateMaxLengthForWrap(MAX_VALUE, 1);
387             assertTrue(value &gt; 0);
388         } finally {
389             cleanupClientSslEngine(clientEngine);
390         }
391     }
392 <a name="39"></a>    @MethodSource("newTestParams")
393     @ParameterizedTest
394     public void testCalculateOutNetBufSize0(SSLEngineTestParam param) throws SSLException {
395         clientSslCtx = <font color="#152dc6"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder.forClient()
396                                         .trustManager(InsecureTrustManagerFactory.INSTANCE)
397                                         .sslProvider(sslClientProvider())
398                                         .protocols(param.protocols())
399                                         .ciphers(param.ciphers</b></font>())
400                                         .build());
401         SSLEngine clientEngine = null;
402         try {
403             clientEngine = clientSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT);
404             assertTrue(((ReferenceCountedOpenSslEngine) clientEngine).calculateMaxLengthForWrap(0, 1) &gt; 0);
405         } finally {
406             cleanupClientSslEngine(clientEngine);
407         }
408     }
409     @MethodSource("newTestParams")
410     @ParameterizedTest
411     public void testCorrectlyCalculateSpaceForAlert(SSLEngineTestParam param) throws Exception {
412         testCorrectlyCalculateSpaceForAlert(param, true);
413     }
414     @MethodSource("newTestParams")
415     @ParameterizedTest
416     public void testCorrectlyCalculateSpaceForAlertJDKCompatabilityModeOff(SSLEngineTestParam param) throws Exception {
417         testCorrectlyCalculateSpaceForAlert(param, false);
418     }
419 <a name="33"></a>    private void testCorrectlyCalculateSpaceForAlert(SSLEngineTestParam param, boolean jdkCompatabilityMode)
420             throws Exception {
421         SelfSignedCertificate ssc = new SelfSignedCertificate();
422         serverSslCtx = <font color="#736aff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey())
423                                         .sslProvider(sslServerProvider())
424                                         .protocols(param.protocols())
425 <a name="59"></a>                                        .ciphers(param.ciphers</b></font>())
426                                         .build());
427         clientSslCtx = <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder.forClient()
428                                         .trustManager(InsecureTrustManagerFactory.INSTANCE)
429                                         .sslProvider(sslClientProvider())
430                                         .protocols(param.protocols</b></font>())
431                                         .ciphers(param.ciphers())
432                                         .build());
433         SSLEngine clientEngine = null;
434         SSLEngine serverEngine = null;
435         try {
436             if (jdkCompatabilityMode) {
437                 clientEngine = wrapEngine(clientSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
438                 serverEngine = wrapEngine(serverSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
439             } else {
440                 clientEngine = wrapEngine(clientSslCtx.newHandler(UnpooledByteBufAllocator.DEFAULT).engine());
441                 serverEngine = wrapEngine(serverSslCtx.newHandler(UnpooledByteBufAllocator.DEFAULT).engine());
442             }
443             handshake(param.type(), param.delegate(), clientEngine, serverEngine);
444 <a name="20"></a>                        clientEngine.closeOutbound();
445             <font color="#4e9258"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>ByteBuffer empty = allocateBuffer(param.type(), 0);
446             ByteBuffer dst = allocateBuffer(param.type(), clientEngine.getSession().getPacketBufferSize());
447             dst.limit(1);
448             SSLEngineResult result = clientEngine.wrap(empty, dst);
449             assertEquals</b></font>(SSLEngineResult.Status.BUFFER_OVERFLOW, result.getStatus());
450             dst.limit(dst.capacity());
451             result = clientEngine.wrap(empty, dst);
452             assertEquals(SSLEngineResult.Status.CLOSED, result.getStatus());
453             dst.flip();
454             int length = SslUtils.getEncryptedPacketLength(new ByteBuffer[] { dst }, 0);
455             assertEquals(length, dst.remaining());
456         } finally {
457             cleanupClientSslEngine(clientEngine);
458             cleanupServerSslEngine(serverEngine);
459             ssc.delete();
460         }
461     }
462     @Override
463     protected void mySetupMutualAuthServerInitSslHandler(SslHandler handler) {
464         ReferenceCountedOpenSslEngine engine = (ReferenceCountedOpenSslEngine) handler.engine();
465         engine.setVerify(SSL_CVERIFY_IGNORED, 1);
466     }
467     @MethodSource("newTestParams")
468     @ParameterizedTest
469     public void testWrapWithDifferentSizesTLSv1(SSLEngineTestParam param) throws Exception {
470         clientSslCtx = wrapContext(param, SslContextBuilder.forClient()
471                                         .trustManager(InsecureTrustManagerFactory.INSTANCE)
472 <a name="2"></a>                                        .sslProvider(sslClientProvider())
473                                         .build());
474         SelfSignedCertificate ssc = new SelfSignedCertificate();
475         serverSslCtx = wrapContext(param, <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey())
476                                         .sslProvider(sslServerProvider())
477                                         .build());
478         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1, "AES128-SHA");
479         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1, "ECDHE-RSA-AES128-SHA");
480         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1, "DES-CBC3-SHA");
481         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1, "AECDH-DES-CBC3-SHA");
482         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1, "CAMELLIA128-SHA");
483         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1, "SEED-SHA");
484         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1, "RC4-MD5");
485         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1, "AES256-SHA");
486         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1, "ADH-DES-CBC3-SHA");
487         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1, "EDH-RSA-DES-CBC3-SHA");
488         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1, "ADH-RC4-MD5");
489         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1, "IDEA-CBC-SHA");
490         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1, "RC4-SHA");
491         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1, "CAMELLIA256-SHA");
492         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1, "AECDH-RC4-SHA");
493         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1, "ECDHE-RSA-DES-CBC3-SHA");
494         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1, "ECDHE-RSA-AES256-SHA");
495         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1, "ECDHE-RSA-RC4-SHA");
496     }
497     @</b></font>MethodSource("newTestParams")
498     @ParameterizedTest
499     public void testWrapWithDifferentSizesTLSv1_1(SSLEngineTestParam param) throws Exception {
500         clientSslCtx = wrapContext(param, SslContextBuilder.forClient()
501                                         .trustManager(InsecureTrustManagerFactory.INSTANCE)
502 <a name="4"></a>                                        .sslProvider(sslClientProvider())
503                                         .build());
504         SelfSignedCertificate ssc = new SelfSignedCertificate();
505         serverSslCtx = wrapContext(param, <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey())
506                                         .sslProvider(sslServerProvider())
507                                         .build());
508         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_1, "ECDHE-RSA-AES256-SHA");
509         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_1, "AES256-SHA");
510         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_1, "CAMELLIA256-SHA");
511         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_1, "ECDHE-RSA-AES256-SHA");
512         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_1, "SEED-SHA");
513         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_1, "CAMELLIA128-SHA");
514         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_1, "IDEA-CBC-SHA");
515         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_1, "AECDH-RC4-SHA");
516         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_1, "ADH-RC4-MD5");
517         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_1, "RC4-SHA");
518         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_1, "ECDHE-RSA-DES-CBC3-SHA");
519         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_1, "EDH-RSA-DES-CBC3-SHA");
520         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_1, "AECDH-DES-CBC3-SHA");
521         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_1, "ADH-DES-CBC3-SHA");
522         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_1, "DES-CBC3-SHA");
523     }
524     @</b></font>MethodSource("newTestParams")
525     @ParameterizedTest
526     public void testWrapWithDifferentSizesTLSv1_2(SSLEngineTestParam param) throws Exception {
527         clientSslCtx = wrapContext(param, SslContextBuilder.forClient()
528                 .trustManager(InsecureTrustManagerFactory.INSTANCE)
529 <a name="58"></a>                .sslProvider(sslClientProvider())
530                 .build());
531         SelfSignedCertificate ssc = new SelfSignedCertificate();
532         serverSslCtx = <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey())
533                 .sslProvider(sslServerProvider())
534                 .build());
535 <a name="1"></a>
536         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "AES128-SHA");
537         testWrapWithDifferentSizes</b></font>(param, SslProtocols.TLS_v1_2, "ECDHE-RSA-AES128-SHA");
538         <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "DES-CBC3-SHA");
539         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "AES128-GCM-SHA256");
540         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "ECDHE-RSA-AES256-SHA384");
541         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "AECDH-DES-CBC3-SHA");
542         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "AES256-GCM-SHA384");
543         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "AES256-SHA256");
544         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "ECDHE-RSA-AES128-GCM-SHA256");
545         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "ECDHE-RSA-AES128-SHA256");
546         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "CAMELLIA128-SHA");
547         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "SEED-SHA");
548         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "RC4-MD5");
549         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "AES256-SHA");
550         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "ADH-DES-CBC3-SHA");
551         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "EDH-RSA-DES-CBC3-SHA");
552         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "ADH-RC4-MD5");
553         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "RC4-SHA");
554         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "CAMELLIA256-SHA");
555         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "AES128-SHA256");
556         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "AECDH-RC4-SHA");
557         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "ECDHE-RSA-DES-CBC3-SHA");
558         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "ECDHE-RSA-AES256-GCM-SHA384");
559         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "ECDHE-RSA-AES256-SHA");
560         testWrapWithDifferentSizes(param, SslProtocols.TLS_v1_2, "ECDHE-RSA-RC4-SHA");
561     }
562     @</b></font>MethodSource("newTestParams")
563     @ParameterizedTest
564     public void testWrapWithDifferentSizesSSLv3(SSLEngineTestParam param) throws Exception {
565         clientSslCtx = wrapContext(param, SslContextBuilder.forClient()
566                 .trustManager(InsecureTrustManagerFactory.INSTANCE)
567 <a name="23"></a>                .sslProvider(sslClientProvider())
568                 .build());
569         SelfSignedCertificate ssc = new SelfSignedCertificate();
570         serverSslCtx = <font color="#f660ab"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey())
571                 .sslProvider(sslServerProvider())
572                 .build());
573         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "ADH-AES128-SHA");
574         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "ADH-CAMELLIA128-SHA");
575 <a name="3"></a>        testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "AECDH-AES128-SHA");
576         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "AECDH-DES-CBC3-SHA");
577         testWrapWithDifferentSizes</b></font>(param, SslProtocols.SSL_v3, "CAMELLIA128-SHA");
578         <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "DHE-RSA-AES256-SHA");
579         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "SEED-SHA");
580         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "RC4-MD5");
581         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "ADH-AES256-SHA");
582         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "ADH-SEED-SHA");
583         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "ADH-DES-CBC3-SHA");
584         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "EDH-RSA-DES-CBC3-SHA");
585         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "ADH-RC4-MD5");
586         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "IDEA-CBC-SHA");
587         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "DHE-RSA-AES128-SHA");
588         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "RC4-SHA");
589         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "CAMELLIA256-SHA");
590         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "AECDH-RC4-SHA");
591         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "DHE-RSA-SEED-SHA");
592         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "AECDH-AES256-SHA");
593         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "ECDHE-RSA-DES-CBC3-SHA");
594         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "ADH-CAMELLIA256-SHA");
595         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "DHE-RSA-CAMELLIA256-SHA");
596         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "DHE-RSA-CAMELLIA128-SHA");
597         testWrapWithDifferentSizes(param, SslProtocols.SSL_v3, "ECDHE-RSA-RC4-SHA");
598     }
599     @</b></font>MethodSource("newTestParams")
600     @ParameterizedTest
601     public void testMultipleRecordsInOneBufferWithNonZeroPositionJDKCompatabilityModeOff(SSLEngineTestParam param)
602 <a name="13"></a>            throws Exception {
603         SelfSignedCertificate cert = new SelfSignedCertificate();
604         clientSslCtx = wrapContext(param, <font color="#3b9c9c"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>SslContextBuilder
605                 .forClient()
606                 .trustManager(cert.cert())
607                 .sslProvider(sslClientProvider())
608                 .protocols(param.protocols())
609                 .ciphers(param.ciphers())
610 <a name="32"></a>                .build());
611         SSLEngine client = wrapEngine(clientSslCtx.newHandler</b></font>(UnpooledByteBufAllocator.DEFAULT).engine());
612         serverSslCtx = <font color="#5b8daf"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder
613                 .forServer(cert.certificate(), cert.privateKey())
614                 .sslProvider(sslServerProvider())
615                 .protocols(param.protocols())
616                 .ciphers(param.ciphers</b></font>())
617                 .build());
618         SSLEngine server = wrapEngine(serverSslCtx.newHandler(UnpooledByteBufAllocator.DEFAULT).engine());
619         try {
620             final int plainClientOutLen = 1024;
621             ByteBuffer plainClientOut = allocateBuffer(param.type(), plainClientOutLen);
622             ByteBuffer plainServerOut = allocateBuffer(param.type(), server.getSession().getApplicationBufferSize());
623             ByteBuffer encClientToServer = allocateBuffer(param.type(), client.getSession().getPacketBufferSize());
624 <a name="5"></a>
625             int positionOffset = 1;
626             ByteBuffer combinedEncClientToServer = <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>allocateBuffer(
627                     param.type(), encClientToServer.capacity() * 2 + positionOffset);
628             combinedEncClientToServer.position(positionOffset);
629             handshake(param.type(), param.delegate(), client, server);
630             plainClientOut.limit(plainClientOut.capacity());
631             SSLEngineResult result = client.wrap(plainClientOut, encClientToServer);
632             assertEquals(plainClientOut.capacity(), result.bytesConsumed());
633             assertTrue(result.bytesProduced() &gt; 0);
634             encClientToServer.flip();
635             combinedEncClientToServer.put(encClientToServer);
636 <a name="14"></a>            plainClientOut.clear();
637             encClientToServer.clear</b></font>();
638             <font color="#842dce"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>result = client.wrap(plainClientOut, encClientToServer);
639             assertEquals(plainClientOut.capacity(), result.bytesConsumed());
640             assertTrue(result.bytesProduced() &gt; 0);
641             encClientToServer.flip();
642             combinedEncClientToServer.put(encClientToServer);
643             encClientToServer.clear();
644             combinedEncClientToServer.flip();
645             combinedEncClientToServer.position(positionOffset);
646             combinedEncClientToServer.limit(
647                     combinedEncClientToServer.limit</b></font>() - positionOffset);
648             final int combinedEncClientToServerLen = combinedEncClientToServer.remaining();
649             result = server.unwrap(combinedEncClientToServer, plainServerOut);
650             assertEquals(0, combinedEncClientToServer.remaining());
651             assertEquals(combinedEncClientToServerLen, result.bytesConsumed());
652             assertEquals(plainClientOutLen, result.bytesProduced());
653         } finally {
654             cert.delete();
655             cleanupClientSslEngine(client);
656             cleanupServerSslEngine(server);
657         }
658     }
659     @MethodSource("newTestParams")
660     @ParameterizedTest
661 <a name="30"></a>    public void testInputTooBigAndFillsUpBuffersJDKCompatabilityModeOff(SSLEngineTestParam param) throws Exception {
662         SelfSignedCertificate cert = new SelfSignedCertificate();
663         clientSslCtx = <font color="#ae694a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder
664                 .forClient()
665                 .trustManager(cert.cert())
666                 .sslProvider(sslClientProvider())
667                 .protocols(param.protocols())
668                 .ciphers(param.ciphers</b></font>())
669 <a name="29"></a>                .build());
670         SSLEngine client = wrapEngine(clientSslCtx.newHandler(UnpooledByteBufAllocator.DEFAULT).engine());
671         serverSslCtx = <font color="#af7a82"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder
672                 .forServer(cert.certificate(), cert.privateKey())
673                 .sslProvider(sslServerProvider())
674                 .protocols(param.protocols())
675                 .ciphers(param.ciphers</b></font>())
676                 .build());
677 <a name="12"></a>        SSLEngine server = wrapEngine(serverSslCtx.newHandler(UnpooledByteBufAllocator.DEFAULT).engine());
678         try {
679             ByteBuffer plainClient = allocateBuffer(<font color="#571b7e"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>param.type(), MAX_PLAINTEXT_LENGTH + 100);
680             ByteBuffer plainClient2 = allocateBuffer(param.type(), 512);
681             ByteBuffer plainClientTotal =
682                     allocateBuffer(param.type(), plainClient.capacity() + plainClient2.capacity());
683             plainClientTotal.put(plainClient);
684             plainClientTotal.put(plainClient2);
685             plainClient.clear();
686             plainClient2.clear();
687             plainClientTotal.flip</b></font>();
688 <a name="42"></a>            ByteBuffer encClientToServerTooSmall = allocateBuffer(param.type(), MAX_PLAINTEXT_LENGTH + 28);
689             ByteBuffer encClientToServer = allocateBuffer(param.type(), client.getSession().getApplicationBufferSize());
690             ByteBuffer encClientToServerTotal =
691 <a name="10"></a>                    allocateBuffer(<font color="#c57717"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>param.type(), client.getSession().getApplicationBufferSize() &lt;&lt; 1);
692             ByteBuffer plainServer = allocateBuffer(param.type(), server.getSession().getApplicationBufferSize() &lt;&lt; 1);
693             handshake(param.type</b></font>(), <font color="#ad5910"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>param.delegate(), client, server);
694             int plainClientRemaining = plainClient.remaining();
695             int encClientToServerTooSmallRemaining = encClientToServerTooSmall.remaining();
696             SSLEngineResult result = client.wrap(plainClient, encClientToServerTooSmall);
697             assertEquals(SSLEngineResult.Status.OK, result.getStatus());
698             assertEquals(plainClientRemaining - plainClient.remaining(), result.bytesConsumed());
699             assertEquals(encClientToServerTooSmallRemaining - encClientToServerTooSmall.remaining(),
700                     result.bytesProduced</b></font>());
701             result = client.wrap(plainClient, encClientToServerTooSmall);
702             assertEquals(SSLEngineResult.Status.BUFFER_OVERFLOW, result.getStatus());
703             assertEquals(0, result.bytesConsumed());
704             assertEquals(0, result.bytesProduced());
705 <a name="54"></a>
706             plainClientRemaining = plainClient.remaining();
707             int encClientToServerRemaining = encClientToServer.remaining();
708             result = <font color="#4e8975"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>client.wrap(plainClient, encClientToServer);
709             assertEquals(SSLEngineResult.Status.OK, result.getStatus());
710             assertEquals(plainClientRemaining, result.bytesConsumed());
711             assertEquals(encClientToServerRemaining - encClientToServer.remaining(), result.bytesProduced());
712             assertEquals</b></font>(0, plainClient.remaining());
713 <a name="17"></a>            final int plainClient2Remaining = plainClient2.remaining();
714             encClientToServerRemaining = encClientToServer.remaining();
715             result = client.wrap(plainClient2, encClientToServer);
716             <font color="#3090c7"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(SSLEngineResult.Status.OK, result.getStatus());
717             assertEquals(plainClient2Remaining, result.bytesConsumed());
718             assertEquals(encClientToServerRemaining - encClientToServer.remaining(), result.bytesProduced());
719             encClientToServerTooSmall.flip();
720             encClientToServer.flip();
721             encClientToServerTotal.put(encClientToServerTooSmall);
722             encClientToServerTotal.put(encClientToServer);
723             encClientToServerTotal.flip();
724             final int encClientToServerTotalRemaining = encClientToServerTotal.remaining()</b></font>;
725             result = server.unwrap(encClientToServerTotal, plainServer);
726             assertEquals(SSLEngineResult.Status.OK, result.getStatus());
727             assertEquals(encClientToServerTotalRemaining, result.bytesConsumed());
728             plainServer.flip();
729             assertEquals(plainClientTotal, plainServer);
730         } finally {
731             cert.delete();
732             cleanupClientSslEngine(client);
733             cleanupServerSslEngine(server);
734         }
735     }
736     @MethodSource("newTestParams")
737     @ParameterizedTest
738 <a name="27"></a>    public void testPartialPacketUnwrapJDKCompatabilityModeOff(SSLEngineTestParam param) throws Exception {
739         SelfSignedCertificate cert = new SelfSignedCertificate();
740         clientSslCtx = <font color="#e77471"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder
741                 .forClient()
742                 .trustManager(cert.cert())
743                 .sslProvider(sslClientProvider())
744                 .protocols(param.protocols())
745                 .ciphers(param.ciphers</b></font>())
746 <a name="26"></a>                .build());
747         SSLEngine client = wrapEngine(clientSslCtx.newHandler(UnpooledByteBufAllocator.DEFAULT).engine());
748         serverSslCtx = <font color="#68818b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder
749                 .forServer(cert.certificate(), cert.privateKey())
750                 .sslProvider(sslServerProvider())
751                 .protocols(param.protocols())
752                 .ciphers(param.ciphers</b></font>())
753                 .build());
754 <a name="21"></a>        SSLEngine server = wrapEngine(serverSslCtx.newHandler(UnpooledByteBufAllocator.DEFAULT).engine());
755         try {
756             ByteBuffer plainClient = allocateBuffer(<font color="#947010"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>param.type(), 1024);
757             ByteBuffer plainClient2 = allocateBuffer(param.type(), 512);
758             ByteBuffer plainClientTotal =
759                     allocateBuffer(param.type(), plainClient.capacity() + plainClient2.capacity());
760             plainClientTotal.put(plainClient);
761             plainClientTotal.put(plainClient2);
762             plainClient.clear</b></font>();
763 <a name="18"></a>            plainClient2.clear();
764             plainClientTotal.flip();
765             ByteBuffer encClientToServer = <font color="#800517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>allocateBuffer(param.type(), client.getSession().getPacketBufferSize());
766             ByteBuffer plainServer = allocateBuffer(param.type(), server.getSession().getApplicationBufferSize());
767             handshake(param.type(), param.delegate</b></font>(), client, server);
768             SSLEngineResult result = client.wrap(plainClient, encClientToServer);
769             assertEquals(SSLEngineResult.Status.OK, result.getStatus());
770             assertEquals(result.bytesConsumed(), plainClient.capacity());
771             final int encClientLen = result.bytesProduced();
772             result = client.wrap(plainClient2, encClientToServer);
773             assertEquals(SSLEngineResult.Status.OK, result.getStatus());
774             assertEquals(result.bytesConsumed(), plainClient2.capacity());
775             final int encClientLen2 = result.bytesProduced();
776             encClientToServer.flip();
777             ByteBuffer encClientFirstHalf = encClientToServer.duplicate();
778             encClientFirstHalf.limit(encClientLen / 2);
779             result = server.unwrap(encClientFirstHalf, plainServer);
780             assertEquals(SSLEngineResult.Status.OK, result.getStatus());
781             assertEquals(result.bytesConsumed(), encClientLen / 2);
782             encClientToServer.position(result.bytesConsumed());
783             ByteBuffer encClientAllButLastByte = encClientToServer.duplicate();
784             final int encClientAllButLastByteLen = encClientAllButLastByte.remaining() - 1;
785             encClientAllButLastByte.limit(encClientAllButLastByte.limit() - 1);
786             result = server.unwrap(encClientAllButLastByte, plainServer);
787             assertEquals(SSLEngineResult.Status.OK, result.getStatus());
788             assertEquals(result.bytesConsumed(), encClientAllButLastByteLen);
789             encClientToServer.position(encClientToServer.position() + result.bytesConsumed());
790             result = server.unwrap(encClientToServer, plainServer);
791             assertEquals(SSLEngineResult.Status.OK, result.getStatus());
792             assertEquals(result.bytesConsumed(), 1);
793             plainServer.flip();
794             assertEquals(plainClientTotal, plainServer);
795         } finally {
796             cert.delete();
797             cleanupClientSslEngine(client);
798             cleanupServerSslEngine(server);
799         }
800     }
801     @MethodSource("newTestParams")
802     @ParameterizedTest
803 <a name="25"></a>    public void testBufferUnderFlowAvoidedIfJDKCompatabilityModeOff(SSLEngineTestParam param) throws Exception {
804         SelfSignedCertificate cert = new SelfSignedCertificate();
805         clientSslCtx = <font color="#5eac10"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder
806                 .forClient()
807                 .trustManager(cert.cert())
808                 .sslProvider(sslClientProvider())
809                 .protocols(param.protocols())
810                 .ciphers(param.ciphers</b></font>())
811 <a name="24"></a>                .build());
812         SSLEngine client = wrapEngine(clientSslCtx.newHandler(UnpooledByteBufAllocator.DEFAULT).engine());
813         serverSslCtx = <font color="#79764d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder
814                 .forServer(cert.certificate(), cert.privateKey())
815                 .sslProvider(sslServerProvider())
816                 .protocols(param.protocols())
817                 .ciphers(param.ciphers</b></font>())
818                 .build());
819         SSLEngine server = wrapEngine(serverSslCtx.newHandler(UnpooledByteBufAllocator.DEFAULT).engine());
820         try {
821             ByteBuffer plainClient = allocateBuffer(param.type(), 1024);
822 <a name="9"></a>            plainClient.limit(plainClient.capacity());
823             ByteBuffer encClientToServer = allocateBuffer(param.type(), client.getSession().getPacketBufferSize());
824             ByteBuffer plainServer = <font color="#83a33a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>allocateBuffer(param.type(), server.getSession().getApplicationBufferSize());
825             handshake(param.type(), param.delegate(), client, server);
826             SSLEngineResult result = client.wrap(plainClient, encClientToServer);
827             assertEquals(SSLEngineResult.Status.OK, result.getStatus());
828             assertEquals(result.bytesConsumed(), plainClient.capacity());
829             encClientToServer.flip</b></font>();
830             int remaining = encClientToServer.remaining();
831 <a name="53"></a>
832             encClientToServer.limit(SslUtils.SSL_RECORD_HEADER_LENGTH - 1);
833             result = <font color="#ad5a3d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>server.unwrap(encClientToServer, plainServer);
834             assertEquals(SSLEngineResult.Status.OK, result.getStatus());
835             assertEquals(SslUtils.SSL_RECORD_HEADER_LENGTH - 1, result.bytesConsumed());
836             assertEquals(0, result.bytesProduced());
837             remaining -= result.bytesConsumed();
838 <a name="51"></a>                        encClientToServer.limit</b></font>(SslUtils.SSL_RECORD_HEADER_LENGTH);
839             result = <font color="#b38481"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>server.unwrap(encClientToServer, plainServer);
840             assertEquals(SSLEngineResult.Status.OK, result.getStatus());
841             assertEquals(1, result.bytesConsumed());
842             assertEquals(0, result.bytesProduced());
843             remaining -= result.bytesConsumed();
844 <a name="22"></a>                        encClientToServer.limit</b></font>(
845                     SslUtils.SSL_RECORD_HEADER_LENGTH  + remaining - 1 - SslUtils.SSL_RECORD_HEADER_LENGTH);
846             result = <font color="#4cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>server.unwrap(encClientToServer, plainServer);
847             assertEquals(SSLEngineResult.Status.OK, result.getStatus());
848             assertEquals(encClientToServer.limit() - SslUtils.SSL_RECORD_HEADER_LENGTH, result.bytesConsumed());
849             assertEquals(0, result.bytesProduced());
850             remaining -= result.bytesConsumed();
851             encClientToServer.limit(remaining);
852             assertEquals(0, encClientToServer.remaining</b></font>());
853             result = server.unwrap(encClientToServer, plainServer);
854             assertEquals(SSLEngineResult.Status.BUFFER_UNDERFLOW, result.getStatus());
855             assertEquals(0, result.bytesConsumed());
856             assertEquals(0, result.bytesProduced());
857             encClientToServer.position(0);
858             result = server.unwrap(encClientToServer, plainServer);
859             assertEquals(SSLEngineResult.Status.OK, result.getStatus());
860             assertEquals(remaining, result.bytesConsumed());
861             assertEquals(0, result.bytesProduced());
862         } finally {
863             cert.delete();
864             cleanupClientSslEngine(client);
865             cleanupServerSslEngine(server);
866         }
867     }
868     private void testWrapWithDifferentSizes(SSLEngineTestParam param, String protocol, String cipher) throws Exception {
869         assumeTrue(OpenSsl.SUPPORTED_PROTOCOLS_SET.contains(protocol));
870         if (!OpenSsl.isCipherSuiteAvailable(cipher)) {
871             return;
872         }
873         SSLEngine clientEngine = null;
874         SSLEngine serverEngine = null;
875         try {
876             clientEngine = wrapEngine(clientSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
877             serverEngine = wrapEngine(serverSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
878             clientEngine.setEnabledCipherSuites(new String[] { cipher });
879             clientEngine.setEnabledProtocols(new String[] { protocol });
880             serverEngine.setEnabledCipherSuites(new String[] { cipher });
881             serverEngine.setEnabledProtocols(new String[] { protocol });
882             try {
883                 handshake(param.type(), param.delegate(), clientEngine, serverEngine);
884             } catch (SSLException e) {
885                 if (e.getMessage().contains("unsupported protocol") ||
886                         e.getMessage().contains("no protocols available")) {
887                     throw new AssumptionViolatedException(protocol + " not supported with cipher " + cipher, e);
888                 }
889                 throw e;
890             }
891             int srcLen = 64;
892             do {
893                 testWrapDstBigEnough(param.type(), clientEngine, srcLen);
894                 srcLen += 64;
895             } while (srcLen &lt; MAX_PLAINTEXT_LENGTH);
896             testWrapDstBigEnough(param.type(), clientEngine, MAX_PLAINTEXT_LENGTH);
897         } finally {
898             cleanupClientSslEngine(clientEngine);
899             cleanupServerSslEngine(serverEngine);
900         }
901     }
902     private void testWrapDstBigEnough(BufferType type, SSLEngine engine, int srcLen) throws SSLException {
903 <a name="11"></a>        ByteBuffer src = allocateBuffer(type, srcLen);
904         ByteBuffer dst = allocateBuffer(type, srcLen + unwrapEngine(engine).maxWrapOverhead());
905         <font color="#b041ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>SSLEngineResult result = engine.wrap(src, dst);
906         assertEquals(SSLEngineResult.Status.OK, result.getStatus());
907         int consumed = result.bytesConsumed();
908         int produced = result.bytesProduced();
909         assertEquals(srcLen, consumed);
910         assertTrue(produced &gt; consumed);
911         dst.flip();
912         assertEquals(produced, dst.remaining());
913         assertFalse(src.hasRemaining</b></font>());
914     }
915     @MethodSource("newTestParams")
916     @ParameterizedTest
917 <a name="50"></a>    public void testSNIMatchersDoesNotThrow(SSLEngineTestParam param) throws Exception {
918         assumeTrue(PlatformDependent.javaVersion() &gt;= 8);
919         SelfSignedCertificate ssc = new SelfSignedCertificate();
920         serverSslCtx = <font color="#ff0000"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey())
921                                         .sslProvider(sslServerProvider</b></font>())
922                                         .protocols(param.protocols())
923                                         .ciphers(param.ciphers())
924                                         .build());
925         SSLEngine engine = wrapEngine(serverSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
926         try {
927             SSLParameters parameters = new SSLParameters();
928             Java8SslTestUtils.setSNIMatcher(parameters, EmptyArrays.EMPTY_BYTES);
929             engine.setSSLParameters(parameters);
930         } finally {
931             cleanupServerSslEngine(engine);
932             ssc.delete();
933         }
934     }
935     @MethodSource("newTestParams")
936     @ParameterizedTest
937     public void testSNIMatchersWithSNINameWithUnderscore(SSLEngineTestParam param) throws Exception {
938         assumeTrue(PlatformDependent.javaVersion() &gt;= 8);
939         byte[] name = "rb8hx3pww30y3tvw0mwy.v1_1".getBytes(CharsetUtil.UTF_8);
940         SelfSignedCertificate ssc = new SelfSignedCertificate();
941         serverSslCtx = wrapContext(param, SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey())
942                                         .sslProvider(sslServerProvider())
943                                         .protocols(param.protocols())
944                                         .ciphers(param.ciphers())
945 <a name="56"></a>                                        .build());
946         SSLEngine engine = wrapEngine(serverSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
947         try <font color="#52d017"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>{
948             SSLParameters parameters = new SSLParameters();
949             Java8SslTestUtils.setSNIMatcher(parameters, name);
950             engine.setSSLParameters(parameters);
951             assertFalse(unwrapEngine(engine).checkSniHostnameMatch("other".getBytes</b></font>(CharsetUtil.UTF_8)));
952         } finally {
953             cleanupServerSslEngine(engine);
954             ssc.delete();
955         }
956     }
957     @MethodSource("newTestParams")
958     @ParameterizedTest
959     public void testAlgorithmConstraintsThrows(SSLEngineTestParam param) throws Exception {
960         SelfSignedCertificate ssc = new SelfSignedCertificate();
961         serverSslCtx = wrapContext(param, SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey())
962                                         .sslProvider(sslServerProvider())
963                                         .protocols(param.protocols())
964                                         .ciphers(param.ciphers())
965                                         .build());
966         final SSLEngine engine = wrapEngine(serverSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
967         final SSLParameters parameters = new SSLParameters();
968         parameters.setAlgorithmConstraints(new AlgorithmConstraints() {
969             @Override
970             public boolean permits(
971                     Set&lt;CryptoPrimitive&gt; primitives, String algorithm, AlgorithmParameters parameters) {
972                 return false;
973             }
974             @Override
975             public boolean permits(Set&lt;CryptoPrimitive&gt; primitives, Key key) {
976                 return false;
977             }
978             @Override
979             public boolean permits(
980                     Set&lt;CryptoPrimitive&gt; primitives, String algorithm, Key key, AlgorithmParameters parameters) {
981                 return false;
982             }
983         });
984         try {
985             assertThrows(IllegalArgumentException.class, new Executable() {
986                 @Override
987                 public void execute() throws Throwable {
988                     engine.setSSLParameters(parameters);
989                 }
990             });
991         } finally {
992             cleanupServerSslEngine(engine);
993             ssc.delete();
994         }
995     }
996     private static void runTasksIfNeeded(SSLEngine engine) {
997         if (engine.getHandshakeStatus() == HandshakeStatus.NEED_TASK) {
998             for (;;) {
999                 Runnable task = engine.getDelegatedTask();
1000                 if (task == null) {
1001                     assertNotEquals(HandshakeStatus.NEED_TASK, engine.getHandshakeStatus());
1002                     break;
1003                 }
1004                 task.run();
1005             }
1006         }
1007     }
1008     @MethodSource("newTestParams")
1009     @ParameterizedTest
1010     public void testExtractMasterkeyWorksCorrectly(SSLEngineTestParam param) throws Exception {
1011         if (param.combo() != ProtocolCipherCombo.tlsv12()) {
1012             return;
1013         }
1014         SelfSignedCertificate cert = new SelfSignedCertificate();
1015         serverSslCtx = wrapContext(param, SslContextBuilder.forServer(cert.key(), cert.cert())
1016                 .protocols(param.protocols())
1017                 .ciphers(param.ciphers())
1018                 .sslProvider(SslProvider.OPENSSL).build());
1019         final SSLEngine serverEngine =
1020                 wrapEngine(serverSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
1021         clientSslCtx = wrapContext(param, SslContextBuilder.forClient()
1022                 .trustManager(cert.certificate())
1023                 .protocols(param.protocols())
1024                 .ciphers(param.ciphers())
1025                 .sslProvider(SslProvider.OPENSSL).build());
1026         final SSLEngine clientEngine =
1027                 wrapEngine(clientSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
1028         final String enabledCipher = "TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256";
1029         try {
1030             //lets set the cipher suite to a specific one with DHE
1031             assumeTrue(Arrays.asList(clientEngine.getSupportedCipherSuites()).contains(enabledCipher),
1032                     "The diffie hellman cipher is not supported on your runtime.");
1033             //https://www.ietf.org/rfc/rfc5289.txt
1034             //For cipher suites ending with _SHA256, the PRF is the TLS PRF
1035             //[RFC5246] with SHA-256 as the hash function.  The MAC is HMAC
1036             //[RFC2104] with SHA-256 as the hash function.
1037 <a name="57"></a>            clientEngine.setEnabledCipherSuites(new String[] { enabledCipher });
1038             serverEngine.setEnabledCipherSuites(new String[] { enabledCipher });
1039             <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>int appBufferMax = clientEngine.getSession().getApplicationBufferSize();
1040             int netBufferMax = clientEngine.getSession().getPacketBufferSize();
1041             /*
1042              * We'll make the input buffers a bit bigger than the max needed
1043              * size, so that unwrap()s following a successful data transfer
1044              * won't generate BUFFER_OVERFLOWS.
1045              */
1046             ByteBuffer clientIn = ByteBuffer.allocate(appBufferMax + 50);
1047             ByteBuffer serverIn = ByteBuffer.allocate(appBufferMax + 50)</b></font>;
1048             ByteBuffer cTOs = ByteBuffer.allocate(netBufferMax);
1049             ByteBuffer sTOc = ByteBuffer.allocate(netBufferMax);
1050             ByteBuffer clientOut = ByteBuffer.wrap("Hi Server, I'm Client".getBytes(CharsetUtil.US_ASCII));
1051             ByteBuffer serverOut = ByteBuffer.wrap("Hello Client, I'm Server".getBytes(CharsetUtil.US_ASCII));
1052 <a name="49"></a>
1053             //set a for loop; instead of a while loop to guarantee we quit out eventually
1054             boolean asserted = false;
1055             for (int i = 0; i &lt; 1000; i++) <font color="#8e35ef"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>{
1056                 clientEngine.wrap(clientOut, cTOs);
1057                 serverEngine.wrap(serverOut, sTOc);
1058                 cTOs.flip();
1059                 sTOc.flip();
1060                 runTasksIfNeeded(clientEngine);
1061                 runTasksIfNeeded(serverEngine);
1062                 clientEngine.unwrap(sTOc, clientIn);
1063                 serverEngine.unwrap(cTOs, serverIn);
1064                 runTasksIfNeeded</b></font>(clientEngine);
1065                 runTasksIfNeeded(serverEngine);
1066                 if ((clientOut.limit() == serverIn.position()) &amp;&amp;
1067                         (serverOut.limit() == clientIn.position())) {
1068                     byte[] serverRandom = SSL.getServerRandom(unwrapEngine(serverEngine).sslPointer());
1069                     byte[] clientRandom = SSL.getClientRandom(unwrapEngine(clientEngine).sslPointer());
1070                     byte[] serverMasterKey = SSL.getMasterKey(unwrapEngine(serverEngine).sslPointer());
1071                     byte[] clientMasterKey = SSL.getMasterKey(unwrapEngine(clientEngine).sslPointer());
1072                     asserted = true;
1073                     assertArrayEquals(serverMasterKey, clientMasterKey);
1074                     cTOs.flip();
1075                     sTOc.flip();
1076                     //
1077                     int keySize = 16;                     int macSize = 32;                     int keyBlockSize = (2 * keySize) + (2 * macSize);
1078                     byte[] seed = new byte[serverRandom.length + clientRandom.length];
1079                     System.arraycopy(serverRandom, 0, seed, 0, serverRandom.length);
1080                     System.arraycopy(clientRandom, 0, seed, serverRandom.length, clientRandom.length);
1081                     byte[] keyBlock = PseudoRandomFunction.hash(serverMasterKey,
1082 <a name="52"></a>                            "key expansion".getBytes(CharsetUtil.US_ASCII), seed, keyBlockSize, "HmacSha256");
1083                     int offset = 0;
1084                     byte[] clientWriteMac = <font color="#2b60de"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>Arrays.copyOfRange(keyBlock, offset, offset + macSize);
1085                     offset += macSize;
1086                     byte[] serverWriteMac = Arrays.copyOfRange(keyBlock, offset, offset + macSize);
1087                     offset += macSize;
1088                     byte[] clientWriteKey = Arrays.copyOfRange(keyBlock, offset, offset + keySize);
1089                     offset += keySize;
1090                     byte[] serverWriteKey = Arrays.copyOfRange(keyBlock, offset, offset + keySize);
1091                     offset += keySize;
1092                     //advance the cipher text by 5
1093                     //to take into account the TLS Record Header
1094                     cTOs.position(cTOs.position</b></font>() + 5);
1095                     byte[] ciphertext = new byte[cTOs.remaining()];
1096                     cTOs.get(ciphertext);
1097                     //the initialization vector is the first 16 bytes (128 bits) of the payload
1098                     byte[] clientWriteIV = Arrays.copyOfRange(ciphertext, 0, 16);
1099                     ciphertext = Arrays.copyOfRange(ciphertext, 16, ciphertext.length);
1100                     SecretKeySpec secretKey = new SecretKeySpec(clientWriteKey, "AES");
1101                     final IvParameterSpec ivForCBC = new IvParameterSpec(clientWriteIV);
1102                     Cipher cipher = Cipher.getInstance("AES/CBC/NoPadding");
1103                     cipher.init(Cipher.DECRYPT_MODE, secretKey, ivForCBC);
1104                     byte[] plaintext = cipher.doFinal(ciphertext);
1105                     assertTrue(new String(plaintext).startsWith("Hi Server, I'm Client"));
1106                     break;
1107                 } else {
1108                     cTOs.compact();
1109                     sTOc.compact();
1110                 }
1111             }
1112             assertTrue(asserted, "The assertions were never executed.");
1113         } finally {
1114             cleanupClientSslEngine(clientEngine);
1115             cleanupServerSslEngine(serverEngine);
1116             cert.delete();
1117         }
1118     }
1119     @MethodSource("newTestParams")
1120     @ParameterizedTest
1121     public void testNoKeyFound(final SSLEngineTestParam param) throws Exception {
1122         checkShouldUseKeyManagerFactory();
1123         clientSslCtx = wrapContext(param, SslContextBuilder
1124                 .forClient()
1125                 .trustManager(InsecureTrustManagerFactory.INSTANCE)
1126                 .sslProvider(sslClientProvider())
1127                 .protocols(param.protocols())
1128                 .ciphers(param.ciphers())
1129 <a name="38"></a>                .build());
1130         final SSLEngine client = wrapEngine(clientSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
1131         serverSslCtx = <font color="#348781"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>wrapContext(param, SslContextBuilder
1132                 .forServer(new X509ExtendedKeyManager() {
1133                     @Override
1134                     public String[] getClientAliases(String keyType</b></font>, Principal[] issuers) {
1135                         return new String[0];
1136                     }
1137                     @Override
1138                     public String chooseClientAlias(String[] keyType, Principal[] issuers, Socket socket) {
1139                         return null;
1140                     }
1141                     @Override
1142                     public String[] getServerAliases(String keyType, Principal[] issuers) {
1143                         return new String[0];
1144                     }
1145                     @Override
1146                     public String chooseServerAlias(String keyType, Principal[] issuers, Socket socket) {
1147                         return null;
1148                     }
1149                     @Override
1150                     public X509Certificate[] getCertificateChain(String alias) {
1151                         return new X509Certificate[0];
1152                     }
1153                     @Override
1154                     public PrivateKey getPrivateKey(String alias) {
1155                         return null;
1156                     }
1157                 })
1158                 .sslProvider(sslServerProvider())
1159                 .protocols(param.protocols())
1160                 .ciphers(param.ciphers())
1161                 .build());
1162         final SSLEngine server = wrapEngine(serverSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
1163         try {
1164             assertThrows(SSLException.class, new Executable() {
1165                 @Override
1166                 public void execute() throws Throwable {
1167                     handshake(param.type(), param.delegate(), client, server);
1168                 }
1169             });
1170         } finally {
1171             cleanupClientSslEngine(client);
1172             cleanupServerSslEngine(server);
1173         }
1174     }
1175     @MethodSource("newTestParams")
1176     @ParameterizedTest
1177     @Override
1178     public void testSessionLocalWhenNonMutualWithKeyManager(SSLEngineTestParam param) throws Exception {
1179         checkShouldUseKeyManagerFactory();
1180         super.testSessionLocalWhenNonMutualWithKeyManager(param);
1181     }
1182     @MethodSource("newTestParams")
1183     @ParameterizedTest
1184     @Override
1185     public void testSessionLocalWhenNonMutualWithoutKeyManager(SSLEngineTestParam param) throws Exception {
1186         assumeTrue(OpenSsl.supportsKeyManagerFactory());
1187         super.testSessionLocalWhenNonMutualWithoutKeyManager(param);
1188     }
1189     @MethodSource("newTestParams")
1190     @ParameterizedTest
1191     public void testDefaultTLS1NotAcceptedByDefaultServer(SSLEngineTestParam param) throws Exception {
1192         testDefaultTLS1NotAcceptedByDefault(param, null, SslProtocols.TLS_v1);
1193     }
1194     @MethodSource("newTestParams")
1195     @ParameterizedTest
1196     public void testDefaultTLS11NotAcceptedByDefaultServer(SSLEngineTestParam param) throws Exception {
1197         testDefaultTLS1NotAcceptedByDefault(param, null, SslProtocols.TLS_v1_1);
1198     }
1199     @MethodSource("newTestParams")
1200     @ParameterizedTest
1201     public void testDefaultTLS1NotAcceptedByDefaultClient(SSLEngineTestParam param) throws Exception {
1202         testDefaultTLS1NotAcceptedByDefault(param, SslProtocols.TLS_v1, null);
1203     }
1204     @MethodSource("newTestParams")
1205     @ParameterizedTest
1206     public void testDefaultTLS11NotAcceptedByDefaultClient(SSLEngineTestParam param) throws Exception {
1207         testDefaultTLS1NotAcceptedByDefault(param, SslProtocols.TLS_v1_1, null);
1208     }
1209     private void testDefaultTLS1NotAcceptedByDefault(final SSLEngineTestParam param,
1210                                                      String clientProtocol, String serverProtocol) throws Exception {
1211         SslContextBuilder clientCtxBuilder = SslContextBuilder.forClient()
1212                 .trustManager(InsecureTrustManagerFactory.INSTANCE)
1213                 .sslProvider(sslClientProvider())
1214                 .sslContextProvider(clientSslContextProvider());
1215         if (clientProtocol != null) {
1216             clientCtxBuilder.protocols(clientProtocol);
1217         }
1218 <a name="48"></a>        clientSslCtx = wrapContext(param, clientCtxBuilder.build());
1219         SelfSignedCertificate ssc = new SelfSignedCertificate();
1220         SslContextBuilder serverCtxBuilder = <font color="#c57726"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey())
1221                 .sslProvider(sslServerProvider())
1222                 .sslContextProvider(serverSslContextProvider());
1223         if (serverProtocol != null) {
1224             serverCtxBuilder.protocols</b></font>(serverProtocol);
1225         }
1226         serverSslCtx = wrapContext(param, serverCtxBuilder.build());
1227         final SSLEngine client = wrapEngine(clientSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
1228         final SSLEngine server = wrapEngine(serverSslCtx.newEngine(UnpooledByteBufAllocator.DEFAULT));
1229         try {
1230             assertThrows(SSLHandshakeException.class, new Executable() {
1231                 @Override
1232                 public void execute() throws Throwable {
1233                     handshake(param.type(), param.delegate(), client, server);
1234                 }
1235             });
1236         } finally {
1237             cleanupClientSslEngine(client);
1238             cleanupServerSslEngine(server);
1239             ssc.delete();
1240         }
1241     }
1242     @Override
1243     protected SslProvider sslClientProvider() {
1244         return SslProvider.OPENSSL;
1245     }
1246     @Override
1247     protected SslProvider sslServerProvider() {
1248         return SslProvider.OPENSSL;
1249     }
1250     private static ApplicationProtocolConfig acceptingNegotiator(Protocol protocol,
1251             String... supportedProtocols) {
1252         return new ApplicationProtocolConfig(protocol,
1253                 SelectorFailureBehavior.NO_ADVERTISE,
1254                 SelectedListenerFailureBehavior.ACCEPT,
1255                 supportedProtocols);
1256     }
1257     @Override
1258     protected SSLEngine wrapEngine(SSLEngine engine) {
1259         if (PlatformDependent.javaVersion() &gt;= 8) {
1260             return Java8SslTestUtils.wrapSSLEngineForTesting(engine);
1261         }
1262         return engine;
1263     }
1264     ReferenceCountedOpenSslEngine unwrapEngine(SSLEngine engine) {
1265         if (engine instanceof JdkSslEngine) {
1266             return (ReferenceCountedOpenSslEngine) ((JdkSslEngine) engine).getWrappedEngine();
1267         }
1268         return (ReferenceCountedOpenSslEngine) engine;
1269     }
1270     @SuppressWarnings("deprecation")
1271     @Override
1272     protected SslContext wrapContext(SSLEngineTestParam param, SslContext context) {
1273         if (context instanceof OpenSslContext) {
1274             if (param instanceof OpenSslEngineTestParam) {
1275                 ((OpenSslContext) context).setUseTasks(((OpenSslEngineTestParam) param).useTasks);
1276             }
1277             ((OpenSslContext) context).sessionContext().setSessionCacheEnabled(true);
1278         }
1279         return context;
1280     }
1281     @MethodSource("newTestParams")
1282 <a name="55"></a>    @ParameterizedTest
1283     @Override
1284     public void testSessionCache(SSLEngineTestParam param) throws Exception {
1285         <font color="#4863a0"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assumeTrue(OpenSsl.isSessionCacheSupported());
1286         super.testSessionCache(param);
1287         assertSessionContext(clientSslCtx);
1288         assertSessionContext(serverSslCtx);
1289     }
1290     @</b></font>MethodSource("newTestParams")
1291     @ParameterizedTest
1292     @Override
1293     public void testSessionCacheTimeout(SSLEngineTestParam param) throws Exception {
1294         assumeTrue(OpenSsl.isSessionCacheSupported());
1295         super.testSessionCacheTimeout(param);
1296     }
1297     @MethodSource("newTestParams")
1298     @ParameterizedTest
1299     @Override
1300     public void testSessionCacheSize(SSLEngineTestParam param) throws Exception {
1301         assumeTrue(OpenSsl.isSessionCacheSupported());
1302         super.testSessionCacheSize(param);
1303     }
1304     private static void assertSessionContext(SslContext context) {
1305         if (context == null) {
1306             return;
1307         }
1308 <a name="19"></a>        OpenSslSessionContext serverSessionCtx = (OpenSslSessionContext) context.sessionContext();
1309         assertTrue(serverSessionCtx.isSessionCacheEnabled());
1310         if (serverSessionCtx.getIds().hasMoreElements()) {
1311             <font color="#f62817"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>serverSessionCtx.setSessionCacheEnabled(false);
1312             assertFalse(serverSessionCtx.getIds().hasMoreElements());
1313             assertFalse(serverSessionCtx.isSessionCacheEnabled());
1314         }
1315     }
1316 <a name="47"></a>
1317     @</b></font>Override
1318     protected void assertSessionReusedForEngine(SSLEngine clientEngine, SSLEngine serverEngine, boolean reuse) {
1319         <font color="#d16587"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(reuse, unwrapEngine(clientEngine).isSessionReused());
1320         assertEquals(reuse, unwrapEngine(serverEngine).isSessionReused());
1321     }
1322     @</b></font>Override
1323     protected boolean isSessionMaybeReused(SSLEngine engine) {
1324         return unwrapEngine(engine).isSessionReused();
1325     }
1326     @MethodSource("newTestParams")
1327     @ParameterizedTest
1328     @Override
1329     public void testRSASSAPSS(SSLEngineTestParam param) throws Exception {
1330         checkShouldUseKeyManagerFactory();
1331         super.testRSASSAPSS(param);
1332     }
1333 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
