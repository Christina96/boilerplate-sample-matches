
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 14, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-StreamsCommandsTest.java</h3>
            <pre><code>1  package redis.clients.jedis.commands.jedis;
2  import static java.util.Collections.singletonMap;
3  import static org.junit.Assert.assertEquals;
4  import static org.junit.Assert.assertFalse;
5  import static org.junit.Assert.assertNotNull;
6  import static org.junit.Assert.assertNull;
7  import static org.junit.Assert.assertTrue;
8  import static org.junit.Assert.fail;
9  import java.time.Duration;
10  import java.util.HashMap;
11  import java.util.LinkedHashMap;
12  import java.util.List;
13  import java.util.Map;
14  import java.util.Map.Entry;
15  import java.util.concurrent.atomic.AtomicReference;
16  import org.hamcrest.MatcherAssert;
17  import org.hamcrest.Matchers;
18  import org.junit.Test;
19  import redis.clients.jedis.BuilderFactory;
20  import redis.clients.jedis.Jedis;
21  import redis.clients.jedis.Pipeline;
22  import redis.clients.jedis.Response;
23  import redis.clients.jedis.StreamEntryID;
24  import redis.clients.jedis.Transaction;
25  import redis.clients.jedis.exceptions.JedisDataException;
26  import redis.clients.jedis.exceptions.JedisException;
27  import redis.clients.jedis.params.*;
28  import redis.clients.jedis.resps.*;
29  import redis.clients.jedis.util.SafeEncoder;
30  public class StreamsCommandsTest extends JedisCommandsTestBase {
31    @Test
32    public void xadd() {
33      try {
34        Map<String, String> map1 = new HashMap<>();
35        jedis.xadd("stream1", (StreamEntryID) null, map1);
36        fail();
37      } catch (JedisDataException expected) {
38        assertTrue(expected.getMessage().contains("wrong number of arguments"));
39      }
40      Map<String, String> map1 = new HashMap<>();
41      map1.put("f1", "v1");
42      StreamEntryID id1 = jedis.xadd("xadd-stream1", (StreamEntryID) null, map1);
43      assertNotNull(id1);
44      Map<String, String> map2 = new HashMap<>();
45      map2.put("f1", "v1");
46      map2.put("f2", "v2");
47      StreamEntryID id2 = jedis.xadd("xadd-stream1", (StreamEntryID) null, map2);
48      assertTrue(id2.compareTo(id1) > 0);
49      Map<String, String> map3 = new HashMap<>();
50      map3.put("f2", "v2");
51      map3.put("f3", "v3");
52      StreamEntryID id3 = jedis.xadd("xadd-stream2", (StreamEntryID) null, map3);
53      Map<String, String> map4 = new HashMap<>();
54      map4.put("f2", "v2");
55      map4.put("f3", "v3");
56      StreamEntryID idIn = new StreamEntryID(id3.getTime() + 1, 1L);
57      StreamEntryID id4 = jedis.xadd("xadd-stream2", idIn, map4);
58      assertEquals(idIn, id4);
59      assertTrue(id4.compareTo(id3) > 0);
60      Map<String, String> map5 = new HashMap<>();
61      map5.put("f4", "v4");
62      map5.put("f5", "v5");
63      StreamEntryID id5 = jedis.xadd("xadd-stream2", (StreamEntryID) null, map5);
64      assertTrue(id5.compareTo(id4) > 0);
65      Map<String, String> map6 = new HashMap<>();
66      map6.put("f4", "v4");
67      map6.put("f5", "v5");
68      StreamEntryID id6 = jedis.xadd("xadd-stream2", map6, XAddParams.xAddParams().maxLen(3));
69      assertTrue(id6.compareTo(id5) > 0);
70      assertEquals(3L, jedis.xlen("xadd-stream2"));
71    }
72    @Test
73    public void xaddWithParams() {
74      try {
75        jedis.xadd("stream1", new HashMap<>(), XAddParams.xAddParams());
76        fail();
77      } catch (JedisDataException expected) {
78        assertTrue(expected.getMessage().contains("wrong number of arguments"));
79      }
80      try {
81        jedis.xadd("stream1", XAddParams.xAddParams(), new HashMap<>());
82        fail();
83      } catch (JedisDataException expected) {
84        assertTrue(expected.getMessage().contains("wrong number of arguments"));
85      }
86      StreamEntryID id1 = jedis.xadd("xadd-stream1", (StreamEntryID) null, singletonMap("f1", "v1"));
87      assertNotNull(id1);
88      Map<String, String> map2 = new HashMap<>();
89      map2.put("f1", "v1");
90      map2.put("f2", "v2");
91      StreamEntryID id2 = jedis.xadd("xadd-stream1", map2, XAddParams.xAddParams());
92      assertTrue(id2.compareTo(id1) > 0);
93      Map<String, String> map3 = new HashMap<>();
94      map3.put("f2", "v2");
95      map3.put("f3", "v3");
96      StreamEntryID id3 = jedis.xadd("xadd-stream2", XAddParams.xAddParams(), map3);
97      Map<String, String> map4 = new HashMap<>();
98      map4.put("f2", "v2");
99      map4.put("f3", "v3");
100      StreamEntryID idIn = new StreamEntryID(id3.getTime() + 1, 1L);
101      StreamEntryID id4 = jedis.xadd("xadd-stream2", map4, XAddParams.xAddParams().id(idIn));
102      assertEquals(idIn, id4);
103      assertTrue(id4.compareTo(id3) > 0);
104      Map<String, String> map5 = new HashMap<>();
105      map5.put("f4", "v4");
106      map5.put("f5", "v5");
107      StreamEntryID id5 = jedis.xadd("xadd-stream2", XAddParams.xAddParams(), map5);
108      assertTrue(id5.compareTo(id4) > 0);
109      Map<String, String> map6 = new HashMap<>();
110      map6.put("f4", "v4");
111      map6.put("f5", "v5");
112      StreamEntryID id6 = jedis.xadd("xadd-stream2", map6, XAddParams.xAddParams().maxLen(3).exactTrimming());
113      assertTrue(id6.compareTo(id5) > 0);
114      assertEquals(3L, jedis.xlen("xadd-stream2"));
115      StreamEntryID id7 = jedis.xadd("xadd-stream3", XAddParams.xAddParams().noMkStream().maxLen(3).exactTrimming(), map6);
116      assertNull(id7);
117      assertFalse(jedis.exists("xadd-stream3"));
118      jedis.xadd("xadd-stream3", map6, XAddParams.xAddParams().minId("2").id(new StreamEntryID(2)));
119      assertEquals(1L, jedis.xlen("xadd-stream3"));
120      jedis.xadd("xadd-stream3", XAddParams.xAddParams().minId("4").id(new StreamEntryID(3)), map6);
121      assertEquals(0L, jedis.xlen("xadd-stream3"));
122    }
123    @Test
124    public void xaddParamsId() {
125      StreamEntryID id;
126      String key = "kk";
127      Map<String, String> map = singletonMap("ff", "vv");
128      id = jedis.xadd(key, XAddParams.xAddParams().id(new StreamEntryID(0, 1)), map);
129      assertNotNull(id);
130      assertEquals("0-1", id.toString());
131      assertEquals(0, id.getTime());
132      assertEquals(1, id.getSequence());
133      id = jedis.xadd(key, XAddParams.xAddParams().id(2, 3), map);
134      assertNotNull(id);
135      assertEquals(2, id.getTime());
136      assertEquals(3, id.getSequence());
137      id = jedis.xadd(key, XAddParams.xAddParams().id(4), map);
138      assertNotNull(id);
139      assertEquals(4, id.getTime());
140      assertEquals(0, id.getSequence());
141      id = jedis.xadd(key, XAddParams.xAddParams().id("5-6"), map);
142      assertNotNull(id);
143      assertEquals(5, id.getTime());
144      assertEquals(6, id.getSequence());
145      id = jedis.xadd(key, XAddParams.xAddParams().id("7-8".getBytes()), map);
146      assertNotNull(id);
147      assertEquals(7, id.getTime());
148      assertEquals(8, id.getSequence());
149      id = jedis.xadd(key, XAddParams.xAddParams(), map);
150      assertNotNull(id);
151    }
152    @Test
153    public void xdel() {
154      Map<String, String> map1 = new HashMap<>();
155      map1.put("f1", "v1");
156      StreamEntryID id1 = jedis.xadd("xdel-stream", (StreamEntryID) null, map1);
157      assertNotNull(id1);
158      StreamEntryID id2 = jedis.xadd("xdel-stream", (StreamEntryID) null, map1);
159      assertNotNull(id2);
160      assertEquals(2L, jedis.xlen("xdel-stream"));
161      assertEquals(1L, jedis.xdel("xdel-stream", id1));
162      assertEquals(1L, jedis.xlen("xdel-stream"));
163    }
164    @Test
165    public void xlen() {
166      assertEquals(0L, jedis.xlen("xlen-stream"));
167      Map<String, String> map = new HashMap<>();
168      map.put("f1", "v1");
169      jedis.xadd("xlen-stream", (StreamEntryID) null, map);
170      assertEquals(1L, jedis.xlen("xlen-stream"));
171      jedis.xadd("xlen-stream", (StreamEntryID) null, map);
172      assertEquals(2L, jedis.xlen("xlen-stream"));
173    }
174    @Test
175    public void xrange() {
176      List<StreamEntry> range = jedis.xrange("xrange-stream", (StreamEntryID) null,
177        (StreamEntryID) null, Integer.MAX_VALUE);
178      assertEquals(0, range.size());
179      Map<String, String> map = new HashMap<>();
180      map.put("f1", "v1");
181      StreamEntryID id1 = jedis.xadd("xrange-stream", (StreamEntryID) null, map);
182      StreamEntryID id2 = jedis.xadd("xrange-stream", (StreamEntryID) null, map);
183      List<StreamEntry> range2 = jedis.xrange("xrange-stream", (StreamEntryID) null,
184        (StreamEntryID) null, 3);
185      assertEquals(2, range2.size());
186      assertEquals(range2.get(0).toString(), id1 + " " + map);
187      List<StreamEntry> range3 = jedis.xrange("xrange-stream", id1, null, 2);
188      assertEquals(2, range3.size());
189      List<StreamEntry> range4 = jedis.xrange("xrange-stream", id1, id2, 2);
190      assertEquals(2, range4.size());
191      List<StreamEntry> range5 = jedis.xrange("xrange-stream", id1, id2, 1);
192      assertEquals(1, range5.size());
193      List<StreamEntry> range6 = jedis.xrange("xrange-stream", id2, null, 4);
194      assertEquals(1, range6.size());
195      StreamEntryID id3 = jedis.xadd("xrange-stream", (StreamEntryID) null, map);
196      List<StreamEntry> range7 = jedis.xrange("xrange-stream", id3, id3, 4);
197      assertEquals(1, range7.size());
198      List<StreamEntry> range8 = jedis.xrange("xrange-stream", (StreamEntryID) null, (StreamEntryID) null);
199      assertEquals(3, range8.size());
200      range8 = jedis.xrange("xrange-stream", StreamEntryID.MINIMUM_ID, StreamEntryID.MAXIMUM_ID);
201      assertEquals(3, range8.size());
202    }
203    @Test
204    public void xrangeExclusive() {
205      Map<String, String> map = new HashMap<>();
206      map.put("f1", "v1");
207      String id1 = jedis.xadd("xrange-stream", (StreamEntryID) null, map).toString();
208      jedis.xadd("xrange-stream", (StreamEntryID) null, map);
209      List<StreamEntry> range2 = jedis.xrange("xrange-stream", id1, "+", 2);
210      assertEquals(2, range2.size());
211      List<StreamEntry> range3 = jedis.xrange("xrange-stream", "(" + id1, "+", 2);
212      assertEquals(1, range3.size());
213    }
214    @Test
215    public void xreadWithParams() {
216      Map<String, StreamEntryID> streamQeury1 = singletonMap("xread-stream1", new StreamEntryID());
217      assertNull(jedis.xread(XReadParams.xReadParams().block(1), streamQeury1));
218      assertNull(jedis.xread(XReadParams.xReadParams(), streamQeury1));
219      Map<String, String> map = new HashMap<>();
220      map.put("f1", "v1");
221      StreamEntryID id1 = jedis.xadd("xread-stream1", (StreamEntryID) null, map);
222      StreamEntryID id2 = jedis.xadd("xread-stream2", (StreamEntryID) null, map);
223      List<Entry<String, List<StreamEntry>>> streams1 = jedis.xread(XReadParams.xReadParams().count(1).block(1), streamQeury1);
224      assertEquals(1, streams1.size());
225      assertEquals("xread-stream1", streams1.get(0).getKey());
226      assertEquals(1, streams1.get(0).getValue().size());
227      assertEquals(id1, streams1.get(0).getValue().get(0).getID());
228      assertEquals(map, streams1.get(0).getValue().get(0).getFields());
229      assertNull(jedis.xread(XReadParams.xReadParams().block(1), singletonMap("xread-stream1", id1)));
230      assertNull(jedis.xread(XReadParams.xReadParams(), singletonMap("xread-stream1", id1)));
231      Map<String, StreamEntryID> streamQuery23 = new LinkedHashMap<>();
232      streamQuery23.put("xread-stream1", new StreamEntryID());
233      streamQuery23.put("xread-stream2", new StreamEntryID());
234      List<Entry<String, List<StreamEntry>>> streams2 = jedis.xread(XReadParams.xReadParams().count(2).block(1), streamQuery23);
235      assertEquals(2, streams2.size());
236    }
237    @Test
238    public void xreadBlockZero() throws InterruptedException {
239      final AtomicReference<StreamEntryID> readId = new AtomicReference<>();
240      Thread t = new Thread(new Runnable() {
241        @Override
242        public void run() {
243          try (Jedis blockJedis = createJedis()) {
244            long startTime = System.currentTimeMillis();
245            List<Entry<String, List<StreamEntry>>> read = blockJedis.xread(XReadParams.xReadParams().block(0),
246                singletonMap("block0-stream", new StreamEntryID()));
247            long endTime = System.currentTimeMillis();
248            assertTrue(endTime - startTime > 500);
249            assertNotNull(read);
250            readId.set(read.get(0).getValue().get(0).getID());
251          }
252        }
253      }, "xread-block-0-thread");
254      t.start();
255      Thread.sleep(1000);
256      StreamEntryID addedId = jedis.xadd("block0-stream", (StreamEntryID) null, singletonMap("foo", "bar"));
257      t.join();
258      assertEquals(addedId, readId.get());
259    }
260    @Test
261    public void xtrim() {
262      Map<String, String> map1 = new HashMap<String, String>();
263      map1.put("f1", "v1");
264      for (int i = 1; i <= 5; i++) {
265        jedis.xadd("xtrim-stream", (StreamEntryID) null, map1);
266      }
267      assertEquals(5L, jedis.xlen("xtrim-stream"));
268      jedis.xtrim("xtrim-stream", 3, false);
269      assertEquals(3L, jedis.xlen("xtrim-stream"));
270    }
271    @Test
272    public void xtrimWithParams() {
273      Map<String, String> map1 = new HashMap<>();
274      map1.put("f1", "v1");
275      for (int i = 1; i <= 5; i++) {
276        jedis.xadd("xtrim-stream", new StreamEntryID("0-" + i), map1);
277      }
278      assertEquals(5L, jedis.xlen("xtrim-stream"));
279      jedis.xtrim("xtrim-stream", XTrimParams.xTrimParams().maxLen(3).exactTrimming());
280      assertEquals(3L, jedis.xlen("xtrim-stream"));
281      jedis.xtrim("xtrim-stream", XTrimParams.xTrimParams().minId("0-4").exactTrimming());
282      assertEquals(2L, jedis.xlen("xtrim-stream"));
283    }
284    @Test
285    public void xrevrange() {
286      List<StreamEntry> range = jedis.xrevrange("xrevrange-stream", (StreamEntryID) null,
287        (StreamEntryID) null, Integer.MAX_VALUE);
288      assertEquals(0, range.size());
289      Map<String, String> map = new HashMap<>();
290      map.put("f1", "v1");
291      StreamEntryID id1 = jedis.xadd("xrevrange-stream", (StreamEntryID) null, map);
292      StreamEntryID id2 = jedis.xadd("xrevrange-stream", (StreamEntryID) null, map);
293      List<StreamEntry> range2 = jedis.xrange("xrevrange-stream", (StreamEntryID) null,
294        (StreamEntryID) null, 3);
295      assertEquals(2, range2.size());
296      List<StreamEntry> range3 = jedis.xrevrange("xrevrange-stream", null, id1, 2);
297      assertEquals(2, range3.size());
298      List<StreamEntry> range4 = jedis.xrevrange("xrevrange-stream", id2, id1, 2);
299      assertEquals(2, range4.size());
300      List<StreamEntry> range5 = jedis.xrevrange("xrevrange-stream", id2, id1, 1);
301      assertEquals(1, range5.size());
302      List<StreamEntry> range6 = jedis.xrevrange("xrevrange-stream", null, id2, 4);
303      assertEquals(1, range6.size());
304      StreamEntryID id3 = jedis.xadd("xrevrange-stream", (StreamEntryID) null, map);
305      List<StreamEntry> range7 = jedis.xrevrange("xrevrange-stream", id3, id3, 4);
306      assertEquals(1, range7.size());
307      List<StreamEntry> range8 = jedis.xrevrange("xrevrange-stream", (StreamEntryID) null, (StreamEntryID) null);
308      assertEquals(3, range8.size());
309      range8 = jedis.xrevrange("xrevrange-stream", StreamEntryID.MAXIMUM_ID, StreamEntryID.MINIMUM_ID);
310      assertEquals(3, range8.size());
311    }
312    @Test
313    public void xrevrangeExclusive() {
314      Map<String, String> map = new HashMap<>();
315      map.put("f1", "v1");
316      String id1 = jedis.xadd("xrange-stream", (StreamEntryID) null, map).toString();
317      jedis.xadd("xrange-stream", (StreamEntryID) null, map);
318      List<StreamEntry> range2 = jedis.xrevrange("xrange-stream", "+", id1, 2);
319      assertEquals(2, range2.size());
320      List<StreamEntry> range3 = jedis.xrevrange("xrange-stream", "+", "(" + id1, 2);
321      assertEquals(1, range3.size());
322    }
323    @Test
324    public void xgroup() {
325      Map<String, String> map = new HashMap<String, String>();
326      map.put("f1", "v1");
327      StreamEntryID id1 = jedis.xadd("xgroup-stream", (StreamEntryID) null, map);
328      assertEquals("OK", jedis.xgroupCreate("xgroup-stream", "consumer-group-name", null, false));
329      assertEquals("OK", jedis.xgroupSetID("xgroup-stream", "consumer-group-name", id1));
330      assertEquals("OK", jedis.xgroupCreate("xgroup-stream", "consumer-group-name1", StreamEntryID.LAST_ENTRY, false));
331      jedis.xgroupDestroy("xgroup-stream", "consumer-group-name");
332      assertEquals(0L, jedis.xgroupDelConsumer("xgroup-stream", "consumer-group-name1","myconsumer1"));
333      assertTrue(jedis.xgroupCreateConsumer("xgroup-stream", "consumer-group-name1","myconsumer2"));
334      assertEquals(0L, jedis.xgroupDelConsumer("xgroup-stream", "consumer-group-name1","myconsumer2"));
335    }
336    @Test
337    public void xreadGroupWithParams() {
338      Map<String, String> map = new HashMap<>();
339      map.put("f1", "v1");
340      jedis.xadd("xreadGroup-stream1", (StreamEntryID) null, map);
341      jedis.xgroupCreate("xreadGroup-stream1", "xreadGroup-group", null, false);
342      Map<String, StreamEntryID> streamQeury1 = singletonMap("xreadGroup-stream1", StreamEntryID.UNRECEIVED_ENTRY);
343      List<Entry<String, List<StreamEntry>>> range = jedis.xreadGroup("xreadGroup-group", "xreadGroup-consumer",
344          XReadGroupParams.xReadGroupParams().count(1).noAck(), streamQeury1);
345      assertEquals(1, range.size());
346      assertEquals(1, range.get(0).getValue().size());
347      jedis.xadd("xreadGroup-stream1", (StreamEntryID) null, map);
348      jedis.xadd("xreadGroup-stream2", (StreamEntryID) null, map);
349      jedis.xgroupCreate("xreadGroup-stream2", "xreadGroup-group", null, false);
350      Map<String, StreamEntryID> streamQeury11 = singletonMap("xreadGroup-stream1", StreamEntryID.UNRECEIVED_ENTRY);
351      List<Entry<String, List<StreamEntry>>> streams1 = jedis.xreadGroup("xreadGroup-group", "xreadGroup-consumer",
352          XReadGroupParams.xReadGroupParams().count(1).block(1).noAck(), streamQeury11);
353      assertEquals(1, streams1.size());
354      assertEquals(1, streams1.get(0).getValue().size());
355      Map<String, StreamEntryID> streamQuery23 = new LinkedHashMap<>();
356      streamQuery23.put("xreadGroup-stream1", new StreamEntryID());
357      streamQuery23.put("xreadGroup-stream2", new StreamEntryID());
358      List<Entry<String, List<StreamEntry>>> streams2 = jedis.xreadGroup("xreadGroup-group", "xreadGroup-consumer",
359          XReadGroupParams.xReadGroupParams().count(1).block(1).noAck(), streamQuery23);
360      assertEquals(2, streams2.size());
361      StreamEntryID id4 = jedis.xadd("xreadGroup-stream1", (StreamEntryID) null, map);
362      Map<String, StreamEntryID> streamQeuryFresh = singletonMap("xreadGroup-stream1", StreamEntryID.UNRECEIVED_ENTRY);
363      List<Entry<String, List<StreamEntry>>> streams3 = jedis.xreadGroup("xreadGroup-group", "xreadGroup-consumer",
364          XReadGroupParams.xReadGroupParams().count(4).block(100).noAck(), streamQeuryFresh);
365      assertEquals(1, streams3.size());
366      assertEquals(id4, streams3.get(0).getValue().get(0).getID());
367    }
368    @Test
369    public void xreadGroupWithParamsWhenPendingMessageIsDiscarded() {
370      Map<String, String> map1 = new HashMap<>();
371      map1.put("f1", "v1");
372      Map<String, String> map2 = new HashMap<>();
373      map2.put("f2", "v2");
374      XAddParams xAddParams = XAddParams.xAddParams().id(StreamEntryID.NEW_ENTRY).maxLen(2);
375      StreamEntryID firstMessageEntryId = jedis.xadd("xreadGroup-discard-stream1", xAddParams, map1);
376      jedis.xadd("xreadGroup-discard-stream1", xAddParams, map2);
377      jedis.xgroupCreate("xreadGroup-discard-stream1", "xreadGroup-group", null, false);
378      Map<String, StreamEntryID> streamQuery1 = singletonMap("xreadGroup-discard-stream1", StreamEntryID.UNRECEIVED_ENTRY);
379      List<Entry<String, List<StreamEntry>>> range = jedis.xreadGroup("xreadGroup-group", "xreadGroup-consumer",
380              XReadGroupParams.xReadGroupParams().count(1), streamQuery1);
381      assertEquals(1, range.size());
382      assertEquals(1, range.get(0).getValue().size());
383      assertEquals(firstMessageEntryId, range.get(0).getValue().get(0).getID());
384      assertEquals(map1, range.get(0).getValue().get(0).getFields());
385      Map<String, String> map3 = new HashMap<>();
386      map3.put("f3", "v3");
387      jedis.xadd("xreadGroup-discard-stream1", xAddParams, map3);
388      Map<String, StreamEntryID> streamQueryPending = singletonMap("xreadGroup-discard-stream1", new StreamEntryID());
389      List<Entry<String, List<StreamEntry>>> pendingMessages = jedis.xreadGroup("xreadGroup-group", "xreadGroup-consumer",
390              XReadGroupParams.xReadGroupParams().count(1).noAck(), streamQueryPending);
391      assertEquals(1, pendingMessages.size());
392      assertEquals(1, pendingMessages.get(0).getValue().size());
393      assertEquals(firstMessageEntryId, pendingMessages.get(0).getValue().get(0).getID());
394      assertNull(pendingMessages.get(0).getValue().get(0).getFields());
395    }
396    @Test
397    public void xack() {
398      Map<String, String> map = new HashMap<>();
399      map.put("f1", "v1");
400      jedis.xadd("xack-stream", (StreamEntryID) null, map);
401      jedis.xgroupCreate("xack-stream", "xack-group", null, false);
402      Map<String, StreamEntryID> streamQeury1 = singletonMap(
403          "xack-stream", StreamEntryID.UNRECEIVED_ENTRY);
404      List<Entry<String, List<StreamEntry>>> range = jedis.xreadGroup("xack-group", "xack-consumer",
405          XReadGroupParams.xReadGroupParams().count(1).block(1), streamQeury1);
406      assertEquals(1, range.size());
407      assertEquals(1L,
408        jedis.xack("xack-stream", "xack-group", range.get(0).getValue().get(0).getID()));
409    }
410    @Test
411    public void xpendingWithParams() {
412      Map<String, String> map = new HashMap<>();
413      map.put("f1", "v1");
414      StreamEntryID id1 = jedis.xadd("xpendeing-stream", (StreamEntryID) null, map);
415      assertEquals("OK", jedis.xgroupCreate("xpendeing-stream", "xpendeing-group", null, false));
416      Map<String, StreamEntryID> streamQeury1 = singletonMap(
417              "xpendeing-stream", StreamEntryID.UNRECEIVED_ENTRY);
418      List<Entry<String, List<StreamEntry>>> range = jedis.xreadGroup("xpendeing-group",
419              "xpendeing-consumer", XReadGroupParams.xReadGroupParams().count(1).block(1), streamQeury1);
420      assertEquals(1, range.size());
421      assertEquals(1, range.get(0).getValue().size());
422      assertEquals(map, range.get(0).getValue().get(0).getFields());
423      List<StreamPendingEntry> pendingRange = jedis.xpending("xpendeing-stream", "xpendeing-group",
424              new XPendingParams().count(3).consumer("xpendeing-consumer"));
425      assertEquals(1, pendingRange.size());
426      assertEquals(id1, pendingRange.get(0).getID());
427      assertEquals(1, pendingRange.get(0).getDeliveredTimes());
428      assertEquals("xpendeing-consumer", pendingRange.get(0).getConsumerName());
429      assertTrue(pendingRange.get(0).toString().contains("xpendeing-consumer"));
430      pendingRange = jedis.xpending("xpendeing-stream", "xpendeing-group", new XPendingParams().count(3));
431      assertEquals(1, pendingRange.size());
432      assertEquals(id1, pendingRange.get(0).getID());
433      assertEquals(1, pendingRange.get(0).getDeliveredTimes());
434      assertEquals("xpendeing-consumer", pendingRange.get(0).getConsumerName());
435      pendingRange = jedis.xpending("xpendeing-stream", "xpendeing-group",
436        new XPendingParams().idle(Duration.ofMinutes(1).toMillis()).count(3));
437      assertEquals(0, pendingRange.size());
438    }
439    @Test
440    public void xpendingRange() {
441      Map<String, String> map = new HashMap<>();
442      map.put("foo", "bar");
443      StreamEntryID m1 = jedis.xadd("xpendeing-stream", (StreamEntryID) null, map);
444      StreamEntryID m2 = jedis.xadd("xpendeing-stream", (StreamEntryID) null, map);
445      jedis.xgroupCreate("xpendeing-stream", "xpendeing-group", null, false);
446      Map<String, StreamEntryID> streamQeury = singletonMap(
447          "xpendeing-stream", StreamEntryID.UNRECEIVED_ENTRY);
448      jedis.xreadGroup("xpendeing-group", "consumer1", XReadGroupParams.xReadGroupParams().count(1), streamQeury);
449      jedis.xreadGroup("xpendeing-group", "consumer2", XReadGroupParams.xReadGroupParams().count(1), streamQeury);
450      List<StreamPendingEntry> response = jedis.xpending("xpendeing-stream", "xpendeing-group",
451          XPendingParams.xPendingParams("(0", "+", 5));
452      assertEquals(2, response.size());
453      assertEquals(m1, response.get(0).getID());
454      assertEquals("consumer1", response.get(0).getConsumerName());
455      assertEquals(m2, response.get(1).getID());
456      assertEquals("consumer2", response.get(1).getConsumerName());
457      response = jedis.xpending("xpendeing-stream", "xpendeing-group",
458          XPendingParams.xPendingParams(StreamEntryID.MINIMUM_ID, StreamEntryID.MAXIMUM_ID, 5));
459      assertEquals(2, response.size());
460      assertEquals(m1, response.get(0).getID());
461      assertEquals("consumer1", response.get(0).getConsumerName());
462      assertEquals(m2, response.get(1).getID());
463      assertEquals("consumer2", response.get(1).getConsumerName());
464    }
465    @Test
466    public void xclaimWithParams() {
467      Map<String, String> map = new HashMap<>();
468      map.put("f1", "v1");
469      jedis.xadd("xpendeing-stream", (StreamEntryID) null, map);
470      assertEquals("OK", jedis.xgroupCreate("xpendeing-stream", "xpendeing-group", null, false));
471      jedis.xreadGroup("xpendeing-group", "xpendeing-consumer", XReadGroupParams.xReadGroupParams().count(1).block(1),
472              singletonMap("xpendeing-stream", StreamEntryID.UNRECEIVED_ENTRY));
473      List<StreamPendingEntry> pendingRange = jedis.xpending("xpendeing-stream", "xpendeing-group",
474          XPendingParams.xPendingParams().count(3).consumer("xpendeing-consumer"));
475      try {
476        Thread.sleep(100);
477      } catch (InterruptedException e) {
478        e.printStackTrace();
479      }
480      List<StreamEntry> streamEntrys = jedis.xclaim("xpendeing-stream", "xpendeing-group",
481              "xpendeing-consumer2", 50, XClaimParams.xClaimParams().idle(0).retryCount(0),
482              pendingRange.get(0).getID());
483      assertEquals(1, streamEntrys.size());
484      assertEquals(pendingRange.get(0).getID(), streamEntrys.get(0).getID());
485      assertEquals("v1", streamEntrys.get(0).getFields().get("f1"));
486    }
487    @Test
488    public void xclaimJustId() {
489      Map<String, String> map = new HashMap<>();
490      map.put("f1", "v1");
491      jedis.xadd("xpendeing-stream", (StreamEntryID) null, map);
492      assertEquals("OK", jedis.xgroupCreate("xpendeing-stream", "xpendeing-group", null, false));
493      jedis.xreadGroup("xpendeing-group", "xpendeing-consumer", XReadGroupParams.xReadGroupParams().count(1).block(1),
494          singletonMap("xpendeing-stream", StreamEntryID.UNRECEIVED_ENTRY));
495      List<StreamPendingEntry> pendingRange = jedis.xpending("xpendeing-stream", "xpendeing-group",
496          XPendingParams.xPendingParams().count(3).consumer("xpendeing-consumer"));
497      try {
<span onclick='openModal()' class='match'>498        Thread.sleep(100);
499      } catch (InterruptedException e) {
500        e.printStackTrace();
</span>501      }
502      List<StreamEntryID> streamEntryIDS = jedis.xclaimJustId("xpendeing-stream", "xpendeing-group",
503        "xpendeing-consumer2", 50, XClaimParams.xClaimParams().idle(0).retryCount(0),
504        pendingRange.get(0).getID());
505      assertEquals(1, streamEntryIDS.size());
506      assertEquals(pendingRange.get(0).getID(), streamEntryIDS.get(0));
507    }
508    @Test
509    public void xautoclaim() {
510      Map<String, String> map = new HashMap<>();
511      map.put("f1", "v1");
512      jedis.xadd("xpending-stream", (StreamEntryID) null, map);
513      assertEquals("OK", jedis.xgroupCreate("xpending-stream", "xpending-group", null, false));
514      jedis.xreadGroup("xpending-group", "xpending-consumer", XReadGroupParams.xReadGroupParams().count(1).block(1),
515          singletonMap("xpending-stream", StreamEntryID.UNRECEIVED_ENTRY));
516      List<StreamPendingEntry> pendingRange = jedis.xpending("xpending-stream", "xpending-group",
517          XPendingParams.xPendingParams().count(3).consumer("xpending-consumer"));
518      try {
519        Thread.sleep(100);
520      } catch (InterruptedException e) {
521        e.printStackTrace();
522      }
523      Map.Entry<StreamEntryID, List<StreamEntry>> streamEntrys = jedis.xautoclaim("xpending-stream", "xpending-group",
524              "xpending-consumer2", 50, new StreamEntryID(), new XAutoClaimParams().count(1));
525      assertEquals(1, streamEntrys.getValue().size());
526      assertEquals(pendingRange.get(0).getID(), streamEntrys.getValue().get(0).getID());
527      assertEquals("v1", streamEntrys.getValue().get(0).getFields().get("f1"));
528    }
529    @Test
530    public void xautoclaimBinary() {
531      Map<String, String> map = new HashMap<>();
532      map.put("f1", "v1");
533      jedis.xadd("xpending-stream", XAddParams.xAddParams(), map);
534      assertEquals("OK", jedis.xgroupCreate("xpending-stream", "xpending-group", null, false));
535      jedis.xreadGroup("xpending-group", "xpending-consumer", XReadGroupParams.xReadGroupParams().count(1).block(1),
536          singletonMap("xpending-stream", StreamEntryID.UNRECEIVED_ENTRY));
537      List<StreamPendingEntry> pendingRange = jedis.xpending("xpending-stream", "xpending-group",
538          XPendingParams.xPendingParams().count(3).consumer("xpending-consumer"));
539      try {
540        Thread.sleep(100);
541      } catch (InterruptedException e) {
542        e.printStackTrace();
543      }
544      List<Object> streamEntrys = jedis.xautoclaim(SafeEncoder.encode("xpending-stream"),
545              SafeEncoder.encode("xpending-group"), SafeEncoder.encode("xpending-consumer2"),
546              50, SafeEncoder.encode(new StreamEntryID().toString()), new XAutoClaimParams().count(1));
547      Map.Entry<StreamEntryID, List<StreamEntry>> res = BuilderFactory.STREAM_AUTO_CLAIM_RESPONSE.build(streamEntrys);
548      assertEquals(1, res.getValue().size());
549      assertEquals(pendingRange.get(0).getID(), res.getValue().get(0).getID());
550      assertEquals("v1", res.getValue().get(0).getFields().get("f1"));
551    }
552    @Test
553    public void xautoclaimJustId() {
554      Map<String, String> map = new HashMap<>();
555      map.put("f1", "v1");
556      jedis.xadd("xpending-stream", (StreamEntryID) null, map);
557      assertEquals("OK", jedis.xgroupCreate("xpending-stream", "xpending-group", null, false));
558      jedis.xreadGroup("xpending-group", "xpending-consumer", XReadGroupParams.xReadGroupParams().count(1).block(1),
559          singletonMap("xpending-stream", StreamEntryID.UNRECEIVED_ENTRY));
560      List<StreamPendingEntry> pendingRange = jedis.xpending("xpending-stream", "xpending-group",
561          XPendingParams.xPendingParams().count(3).consumer("xpending-consumer"));
562      try {
563        Thread.sleep(100);
564      } catch (InterruptedException e) {
565        e.printStackTrace();
566      }
567      Map.Entry<StreamEntryID, List<StreamEntryID>> streamEntrys = jedis.xautoclaimJustId("xpending-stream", "xpending-group",
568              "xpending-consumer2", 50, new StreamEntryID(), new XAutoClaimParams().count(1));
569      assertEquals(1, streamEntrys.getValue().size());
570      assertEquals(pendingRange.get(0).getID().getTime(), streamEntrys.getValue().get(0).getTime());
571      assertEquals(pendingRange.get(0).getID().getSequence(), streamEntrys.getValue().get(0).getSequence());
572    }
573    @Test
574    public void xautoclaimJustIdBinary() {
575      Map<String, String> map = new HashMap<>();
576      map.put("f1", "v1");
577      jedis.xadd("xpending-stream", XAddParams.xAddParams(), map);
578      assertEquals("OK", jedis.xgroupCreate("xpending-stream", "xpending-group", null, false));
579      jedis.xreadGroup("xpending-group", "xpending-consumer", XReadGroupParams.xReadGroupParams().count(1).block(1),
580          singletonMap("xpending-stream", StreamEntryID.UNRECEIVED_ENTRY));
581      List<StreamPendingEntry> pendingRange = jedis.xpending("xpending-stream", "xpending-group",
582          XPendingParams.xPendingParams().count(3).consumer("xpending-consumer"));
583      try {
584        Thread.sleep(100);
585      } catch (InterruptedException e) {
586        e.printStackTrace();
587      }
588      List<Object> streamEntrys = jedis.xautoclaimJustId(SafeEncoder.encode("xpending-stream"),
589              SafeEncoder.encode("xpending-group"), SafeEncoder.encode("xpending-consumer2"),
590              50, SafeEncoder.encode(new StreamEntryID().toString()), new XAutoClaimParams().count(1));
591      Map.Entry<StreamEntryID, List<StreamEntryID>> res = BuilderFactory.STREAM_AUTO_CLAIM_JUSTID_RESPONSE.build(streamEntrys);
592      assertEquals(1, res.getValue().size());
593      assertEquals(pendingRange.get(0).getID().getTime(), res.getValue().get(0).getTime());
594      assertEquals(pendingRange.get(0).getID().getSequence(), res.getValue().get(0).getSequence());
595    }
596    @Test
597    public void xinfo() throws InterruptedException {
598      final String STREAM_NAME = "xadd-stream1";
599      final String F1 = "f1";
600      final String V1 = "v1";
601      final String V2 = "v2";
602      final String G1 = "G1";
603      final String G2 = "G2";
604      final String MY_CONSUMER = "myConsumer";
605      final String MY_CONSUMER2 = "myConsumer2";
606      Map<String, String> map1 = new HashMap<>();
607      map1.put(F1, V1);
608      StreamEntryID id1 = jedis.xadd(STREAM_NAME, (StreamEntryID) null, map1);
609      map1.put(F1, V2);
610      StreamEntryID id2 = jedis.xadd(STREAM_NAME, (StreamEntryID) null, map1);
611      assertNotNull(id1);
612      StreamInfo streamInfo = jedis.xinfoStream(STREAM_NAME);
613      assertNotNull(id2);
614      jedis.xgroupCreate(STREAM_NAME, G1, StreamEntryID.LAST_ENTRY, false);
615      Map<String, StreamEntryID> streamQeury11 = singletonMap(
616          STREAM_NAME, new StreamEntryID("0-0"));
617      jedis.xreadGroup(G1, MY_CONSUMER, XReadGroupParams.xReadGroupParams().count(1), streamQeury11);
618      Thread.sleep(1);
619      List<StreamGroupInfo> groupInfo = jedis.xinfoGroups(STREAM_NAME);
620      List<StreamConsumersInfo> consumersInfo = jedis.xinfoConsumers(STREAM_NAME, G1);
621      List<StreamConsumerInfo> consumerInfo = jedis.xinfoConsumers2(STREAM_NAME, G1);
622      assertEquals(2L, streamInfo.getStreamInfo().get(StreamInfo.LENGTH));
623      assertEquals(1L, streamInfo.getStreamInfo().get(StreamInfo.RADIX_TREE_KEYS));
624      assertEquals(2L, streamInfo.getStreamInfo().get(StreamInfo.RADIX_TREE_NODES));
625      assertEquals(0L, streamInfo.getStreamInfo().get(StreamInfo.GROUPS));
626      assertEquals(V1, ((StreamEntry) streamInfo.getStreamInfo().get(StreamInfo.FIRST_ENTRY)).getFields().get(F1));
627      assertEquals(V2, ((StreamEntry) streamInfo.getStreamInfo().get(StreamInfo.LAST_ENTRY)).getFields().get(F1));
628      assertEquals(id2, streamInfo.getStreamInfo().get(StreamInfo.LAST_GENERATED_ID));
629      assertEquals(2, streamInfo.getLength());
630      assertEquals(1, streamInfo.getRadixTreeKeys());
631      assertEquals(2, streamInfo.getRadixTreeNodes());
632      assertEquals(0, streamInfo.getGroups());
633      assertEquals(V1, streamInfo.getFirstEntry().getFields().get(F1));
634      assertEquals(V2, streamInfo.getLastEntry().getFields().get(F1));
635      assertEquals(id2, streamInfo.getLastGeneratedId());
636      assertEquals(1, groupInfo.size());
637      assertEquals(G1, groupInfo.get(0).getGroupInfo().get(StreamGroupInfo.NAME));
638      assertEquals(1L, groupInfo.get(0).getGroupInfo().get(StreamGroupInfo.CONSUMERS));
639      assertEquals(0L, groupInfo.get(0).getGroupInfo().get(StreamGroupInfo.PENDING));
640      assertEquals(id2, groupInfo.get(0).getGroupInfo().get(StreamGroupInfo.LAST_DELIVERED));
641      assertEquals(1, groupInfo.size());
642      assertEquals(G1, groupInfo.get(0).getName());
643      assertEquals(1, groupInfo.get(0).getConsumers());
644      assertEquals(0, groupInfo.get(0).getPending());
645      assertEquals(id2, groupInfo.get(0).getLastDeliveredId());
646      assertEquals(MY_CONSUMER,
647        consumersInfo.get(0).getConsumerInfo().get(StreamConsumersInfo.NAME));
648      assertEquals(0L, consumersInfo.get(0).getConsumerInfo().get(StreamConsumersInfo.PENDING));
649      assertTrue((Long) consumersInfo.get(0).getConsumerInfo().get(StreamConsumersInfo.IDLE) > 0);
650      assertEquals(MY_CONSUMER, consumersInfo.get(0).getName());
651      assertEquals(0L, consumersInfo.get(0).getPending());
652      MatcherAssert.assertThat(consumersInfo.get(0).getIdle(), Matchers.greaterThanOrEqualTo(0L));
653      MatcherAssert.assertThat(consumersInfo.get(0).getInactive(), Matchers.any(Long.class));
654      assertEquals(MY_CONSUMER,
655        consumerInfo.get(0).getConsumerInfo().get(StreamConsumerInfo.NAME));
656      assertEquals(0L, consumerInfo.get(0).getConsumerInfo().get(StreamConsumerInfo.PENDING));
657      assertTrue((Long) consumerInfo.get(0).getConsumerInfo().get(StreamConsumerInfo.IDLE) > 0);
658      assertEquals(MY_CONSUMER, consumerInfo.get(0).getName());
659      assertEquals(0L, consumerInfo.get(0).getPending());
660      MatcherAssert.assertThat(consumerInfo.get(0).getIdle(), Matchers.greaterThanOrEqualTo(0L));
661      MatcherAssert.assertThat(consumerInfo.get(0).getInactive(), Matchers.any(Long.class));
662      jedis.xgroupCreate(STREAM_NAME, G2, StreamEntryID.LAST_ENTRY, false);
663      jedis.xreadGroup(G1, MY_CONSUMER2, XReadGroupParams.xReadGroupParams().count(1), streamQeury11);
664      jedis.xreadGroup(G2, MY_CONSUMER, XReadGroupParams.xReadGroupParams().count(1), streamQeury11);
665      jedis.xreadGroup(G2, MY_CONSUMER2, XReadGroupParams.xReadGroupParams().count(1), streamQeury11);
666      List<StreamGroupInfo> manyGroupsInfo = jedis.xinfoGroups(STREAM_NAME);
667      List<StreamConsumersInfo> manyConsumersInfo = jedis.xinfoConsumers(STREAM_NAME, G2);
668      List<StreamConsumerInfo> manyConsumerInfo = jedis.xinfoConsumers2(STREAM_NAME, G2);
669      assertEquals(2, manyGroupsInfo.size());
670      assertEquals(2, manyConsumersInfo.size());
671      assertEquals(2, manyConsumerInfo.size());
672      StreamFullInfo streamInfoFull = jedis.xinfoStreamFull(STREAM_NAME);
673      assertEquals(2, streamInfoFull.getEntries().size());
674      assertEquals(2, streamInfoFull.getGroups().size());
675      assertEquals(2, streamInfoFull.getLength());
676      assertEquals(1, streamInfoFull.getRadixTreeKeys());
677      assertEquals(2, streamInfoFull.getRadixTreeNodes());
678      assertEquals(0, streamInfo.getGroups());
679      assertEquals(G1, streamInfoFull.getGroups().get(0).getName());
680      assertEquals(G2, streamInfoFull.getGroups().get(1).getName());
681      assertEquals(V1, streamInfoFull.getEntries().get(0).getFields().get(F1));
682      assertEquals(V2, streamInfoFull.getEntries().get(1).getFields().get(F1));
683      assertEquals(id2, streamInfoFull.getLastGeneratedId());
684      streamInfoFull = jedis.xinfoStreamFull(STREAM_NAME, 10);
685      assertEquals(G1, streamInfoFull.getGroups().get(0).getName());
686      assertEquals(G2, streamInfoFull.getGroups().get(1).getName());
687      assertEquals(V1, streamInfoFull.getEntries().get(0).getFields().get(F1));
688      assertEquals(V2, streamInfoFull.getEntries().get(1).getFields().get(F1));
689      assertEquals(id2, streamInfoFull.getLastGeneratedId());
690      try {
691        jedis.xinfoStream("random");
692        fail("Command should fail");
693      } catch (JedisException e) {
694        assertEquals("ERR no such key", e.getMessage());
695      }
696    }
697    @Test
698    public void xinfoStreamFullWithPending() {
699      Map<String, String> map = singletonMap("f1", "v1");
700      StreamEntryID id1 = jedis.xadd("streamfull2", (StreamEntryID) null, map);
701      StreamEntryID id2 = jedis.xadd("streamfull2", (StreamEntryID) null, map);
702      jedis.xgroupCreate("streamfull2", "xreadGroup-group", null, false);
703      Map<String, StreamEntryID> streamQeury1 = singletonMap("streamfull2", StreamEntryID.UNRECEIVED_ENTRY);
704      List<Entry<String, List<StreamEntry>>> range = jedis.xreadGroup("xreadGroup-group", "xreadGroup-consumer",
705          XReadGroupParams.xReadGroupParams().count(1), streamQeury1);
706      assertEquals(1, range.size());
707      assertEquals(1, range.get(0).getValue().size());
708      StreamFullInfo full = jedis.xinfoStreamFull("streamfull2");
709      assertEquals(1, full.getGroups().size());
710      StreamGroupFullInfo group = full.getGroups().get(0);
711      assertEquals("xreadGroup-group", group.getName());
712      assertEquals(1, group.getPending().size());
713      List<Object> groupPendingEntry = group.getPending().get(0);
714      assertEquals(id1, groupPendingEntry.get(0));
715      assertEquals("xreadGroup-consumer", groupPendingEntry.get(1));
716      assertEquals(1, group.getConsumers().size());
717      StreamConsumerFullInfo consumer = group.getConsumers().get(0);
718      assertEquals("xreadGroup-consumer", consumer.getName());
719      MatcherAssert.assertThat(consumer.getSeenTime(), Matchers.greaterThanOrEqualTo(0L));
720      MatcherAssert.assertThat(consumer.getActiveTime(), Matchers.greaterThanOrEqualTo(0L));
721      assertEquals(1, consumer.getPending().size());
722      List<Object> consumerPendingEntry = consumer.getPending().get(0);
723      assertEquals(id1, consumerPendingEntry.get(0));
724    }
725    @Test
726    public void pipeline() {
727      Map<String, String> map = new HashMap<>();
728      map.put("a", "b");
729      Pipeline p = jedis.pipelined();
730      Response<StreamEntryID> id1 = p.xadd("stream1", StreamEntryID.NEW_ENTRY, map);
731      Response<StreamEntryID> id2 = p.xadd("stream1", StreamEntryID.NEW_ENTRY, map);
732      Response<List<StreamEntry>> results = p.xrange("stream1", (StreamEntryID) null, (StreamEntryID) null, 2);
733      p.sync();
734      List<StreamEntry> entries = results.get();
735      assertEquals(2, entries.size());
736      assertEquals(id1.get(), entries.get(0).getID());
737      assertEquals(map, entries.get(0).getFields());
738      assertEquals(id2.get(), entries.get(1).getID());
739      assertEquals(map, entries.get(1).getFields());
740      p = jedis.pipelined();
741      Response<List<StreamEntry>> results2 = p.xrevrange("stream1", null, id1.get(), 2);
742      p.sync();
743      assertEquals(2, results2.get().size());
744    }
745    @Test
746    public void transaction() {
747      Map<String, String> map = new HashMap<>();
748      map.put("a", "b");
749      Transaction t = jedis.multi();
750      Response<StreamEntryID> id1 = t.xadd("stream1", StreamEntryID.NEW_ENTRY, map);
751      Response<StreamEntryID> id2 = t.xadd("stream1", StreamEntryID.NEW_ENTRY, map);
752      Response<List<StreamEntry>> results = t.xrange("stream1", (StreamEntryID) null, (StreamEntryID) null, 2);
753      t.exec();
754      List<StreamEntry> entries = results.get();
755      assertEquals(2, entries.size());
756      assertEquals(id1.get(), entries.get(0).getID());
757      assertEquals(map, entries.get(0).getFields());
758      assertEquals(id2.get(), entries.get(1).getID());
759      assertEquals(map, entries.get(1).getFields());
760    }
761  }
</code></pre>
        </div>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-ListCommandsTestBase.java</h3>
            <pre><code>1  package redis.clients.jedis.commands.unified;
2  import static org.junit.Assert.assertArrayEquals;
3  import static org.junit.Assert.assertEquals;
4  import static org.junit.Assert.assertNotNull;
5  import static org.junit.Assert.assertNull;
6  import static org.junit.Assert.assertTrue;
7  import static org.junit.Assert.fail;
8  import static redis.clients.jedis.util.AssertUtil.assertByteArrayListEquals;
9  import java.util.ArrayList;
10  import java.util.Arrays;
11  import java.util.Collections;
12  import java.util.List;
13  import org.junit.Test;
14  import org.slf4j.Logger;
15  import org.slf4j.LoggerFactory;
16  import redis.clients.jedis.args.ListPosition;
17  import redis.clients.jedis.args.ListDirection;
18  import redis.clients.jedis.exceptions.JedisDataException;
19  import redis.clients.jedis.params.LPosParams;
20  import redis.clients.jedis.util.KeyValue;
21  public abstract class ListCommandsTestBase extends UnifiedJedisCommandsTestBase {
22    private final Logger logger = LoggerFactory.getLogger(getClass());
23    protected final byte[] bfoo = { 0x01, 0x02, 0x03, 0x04 };
24    protected final byte[] bfoo1 = { 0x01, 0x02, 0x03, 0x04, 0x05 };
25    protected final byte[] bbar = { 0x05, 0x06, 0x07, 0x08 };
26    protected final byte[] bcar = { 0x09, 0x0A, 0x0B, 0x0C };
27    protected final byte[] bA = { 0x0A };
28    protected final byte[] bB = { 0x0B };
29    protected final byte[] bC = { 0x0C };
30    protected final byte[] b1 = { 0x01 };
31    protected final byte[] b2 = { 0x02 };
32    protected final byte[] b3 = { 0x03 };
33    protected final byte[] bhello = { 0x04, 0x02 };
34    protected final byte[] bx = { 0x02, 0x04 };
35    protected final byte[] bdst = { 0x11, 0x12, 0x13, 0x14 };
36    @Test
37    public void rpush() {
38      assertEquals(1, jedis.rpush("foo", "bar"));
39      assertEquals(2, jedis.rpush("foo", "foo"));
40      assertEquals(4, jedis.rpush("foo", "bar", "foo"));
41      assertEquals(1, jedis.rpush(bfoo, bbar));
42      assertEquals(2, jedis.rpush(bfoo, bfoo));
43      assertEquals(4, jedis.rpush(bfoo, bbar, bfoo));
44    }
45    @Test
46    public void lpush() {
47      assertEquals(1, jedis.lpush("foo", "bar"));
48      assertEquals(2, jedis.lpush("foo", "foo"));
49      assertEquals(4, jedis.lpush("foo", "bar", "foo"));
50      assertEquals(1, jedis.lpush(bfoo, bbar));
51      assertEquals(2, jedis.lpush(bfoo, bfoo));
52      assertEquals(4, jedis.lpush(bfoo, bbar, bfoo));
53    }
54    @Test
55    public void llen() {
56      assertEquals(0, jedis.llen("foo"));
57      jedis.lpush("foo", "bar");
58      jedis.lpush("foo", "car");
59      assertEquals(2, jedis.llen("foo"));
60      assertEquals(0, jedis.llen(bfoo));
61      jedis.lpush(bfoo, bbar);
62      jedis.lpush(bfoo, bcar);
63      assertEquals(2, jedis.llen(bfoo));
64    }
65    @Test
66    public void llenNotOnList() {
67      try {
68        jedis.set("foo", "bar");
69        jedis.llen("foo");
70        fail("JedisDataException expected");
71      } catch (final JedisDataException e) {
72      }
73      try {
74        jedis.set(bfoo, bbar);
75        jedis.llen(bfoo);
76        fail("JedisDataException expected");
77      } catch (final JedisDataException e) {
78      }
79    }
80    @Test
81    public void lrange() {
82      jedis.rpush("foo", "a");
83      jedis.rpush("foo", "b");
84      jedis.rpush("foo", "c");
85      List<String> expected = new ArrayList<String>();
86      expected.add("a");
87      expected.add("b");
88      expected.add("c");
89      List<String> range = jedis.lrange("foo", 0, 2);
90      assertEquals(expected, range);
91      range = jedis.lrange("foo", 0, 20);
92      assertEquals(expected, range);
93      expected = new ArrayList<String>();
94      expected.add("b");
95      expected.add("c");
96      range = jedis.lrange("foo", 1, 2);
97      assertEquals(expected, range);
98      range = jedis.lrange("foo", 2, 1);
99      assertEquals(Collections.<String> emptyList(), range);
100      jedis.rpush(bfoo, bA);
101      jedis.rpush(bfoo, bB);
102      jedis.rpush(bfoo, bC);
103      List<byte[]> bexpected = new ArrayList<byte[]>();
104      bexpected.add(bA);
105      bexpected.add(bB);
106      bexpected.add(bC);
107      List<byte[]> brange = jedis.lrange(bfoo, 0, 2);
108      assertByteArrayListEquals(bexpected, brange);
109      brange = jedis.lrange(bfoo, 0, 20);
110      assertByteArrayListEquals(bexpected, brange);
111      bexpected = new ArrayList<byte[]>();
112      bexpected.add(bB);
113      bexpected.add(bC);
114      brange = jedis.lrange(bfoo, 1, 2);
115      assertByteArrayListEquals(bexpected, brange);
116      brange = jedis.lrange(bfoo, 2, 1);
117      assertByteArrayListEquals(Collections.<byte[]> emptyList(), brange);
118    }
119    @Test
120    public void ltrim() {
121      jedis.lpush("foo", "1");
122      jedis.lpush("foo", "2");
123      jedis.lpush("foo", "3");
124      String status = jedis.ltrim("foo", 0, 1);
125      List<String> expected = new ArrayList<String>();
126      expected.add("3");
127      expected.add("2");
128      assertEquals("OK", status);
129      assertEquals(2, jedis.llen("foo"));
130      assertEquals(expected, jedis.lrange("foo", 0, 100));
131      jedis.lpush(bfoo, b1);
132      jedis.lpush(bfoo, b2);
133      jedis.lpush(bfoo, b3);
134      String bstatus = jedis.ltrim(bfoo, 0, 1);
135      List<byte[]> bexpected = new ArrayList<byte[]>();
136      bexpected.add(b3);
137      bexpected.add(b2);
138      assertEquals("OK", bstatus);
139      assertEquals(2, jedis.llen(bfoo));
140      assertByteArrayListEquals(bexpected, jedis.lrange(bfoo, 0, 100));
141    }
142    @Test
143    public void lset() {
144      jedis.lpush("foo", "1");
145      jedis.lpush("foo", "2");
146      jedis.lpush("foo", "3");
147      List<String> expected = new ArrayList<String>();
148      expected.add("3");
149      expected.add("bar");
150      expected.add("1");
151      String status = jedis.lset("foo", 1, "bar");
152      assertEquals("OK", status);
153      assertEquals(expected, jedis.lrange("foo", 0, 100));
154      jedis.lpush(bfoo, b1);
155      jedis.lpush(bfoo, b2);
156      jedis.lpush(bfoo, b3);
157      List<byte[]> bexpected = new ArrayList<byte[]>();
158      bexpected.add(b3);
159      bexpected.add(bbar);
160      bexpected.add(b1);
161      String bstatus = jedis.lset(bfoo, 1, bbar);
162      assertEquals("OK", bstatus);
163      assertByteArrayListEquals(bexpected, jedis.lrange(bfoo, 0, 100));
164    }
165    @Test
166    public void lindex() {
167      jedis.lpush("foo", "1");
168      jedis.lpush("foo", "2");
169      jedis.lpush("foo", "3");
170      assertEquals("3", jedis.lindex("foo", 0));
171      assertNull(jedis.lindex("foo", 100));
172      jedis.lpush(bfoo, b1);
173      jedis.lpush(bfoo, b2);
174      jedis.lpush(bfoo, b3);
175      assertArrayEquals(b3, jedis.lindex(bfoo, 0));
176      assertNull(jedis.lindex(bfoo, 100));
177    }
178    @Test
179    public void lrem() {
180      jedis.lpush("foo", "hello");
181      jedis.lpush("foo", "hello");
182      jedis.lpush("foo", "x");
183      jedis.lpush("foo", "hello");
184      jedis.lpush("foo", "c");
185      jedis.lpush("foo", "b");
186      jedis.lpush("foo", "a");
187      List<String> expected = new ArrayList<String>();
188      expected.add("a");
189      expected.add("b");
190      expected.add("c");
191      expected.add("hello");
192      expected.add("x");
193      assertEquals(2, jedis.lrem("foo", -2, "hello"));
194      assertEquals(expected, jedis.lrange("foo", 0, 1000));
195      assertEquals(0, jedis.lrem("bar", 100, "foo"));
196      jedis.lpush(bfoo, bhello);
197      jedis.lpush(bfoo, bhello);
198      jedis.lpush(bfoo, bx);
199      jedis.lpush(bfoo, bhello);
200      jedis.lpush(bfoo, bC);
201      jedis.lpush(bfoo, bB);
202      jedis.lpush(bfoo, bA);
203      List<byte[]> bexpected = new ArrayList<byte[]>();
204      bexpected.add(bA);
205      bexpected.add(bB);
206      bexpected.add(bC);
207      bexpected.add(bhello);
208      bexpected.add(bx);
209      assertEquals(2, jedis.lrem(bfoo, -2, bhello));
210      assertByteArrayListEquals(bexpected, jedis.lrange(bfoo, 0, 1000));
211      assertEquals(0, jedis.lrem(bbar, 100, bfoo));
212    }
213    @Test
214    public void lpop() {
215      assertNull(jedis.lpop("foo"));
216      assertNull(jedis.lpop("foo", 0));
217      jedis.rpush("foo", "a");
218      jedis.rpush("foo", "b");
219      jedis.rpush("foo", "c");
220      assertEquals("a", jedis.lpop("foo"));
221      assertEquals(Arrays.asList("b", "c"), jedis.lpop("foo", 10));
222      assertNull(jedis.lpop("foo"));
223      assertNull(jedis.lpop("foo", 1));
224      assertNull(jedis.lpop(bfoo));
225      assertNull(jedis.lpop(bfoo, 0));
226      jedis.rpush(bfoo, bA);
227      jedis.rpush(bfoo, bB);
228      jedis.rpush(bfoo, bC);
229      assertArrayEquals(bA, jedis.lpop(bfoo));
230      assertByteArrayListEquals(Arrays.asList(bB, bC), jedis.lpop(bfoo, 10));
231      assertNull(jedis.lpop(bfoo));
232      assertNull(jedis.lpop(bfoo, 1));
233    }
234    @Test
235    public void rpop() {
236      assertNull(jedis.rpop("foo"));
237      assertNull(jedis.rpop("foo", 0));
238      jedis.rpush("foo", "a");
239      jedis.rpush("foo", "b");
240      jedis.rpush("foo", "c");
241      assertEquals("c", jedis.rpop("foo"));
242      assertEquals(Arrays.asList("b", "a"), jedis.rpop("foo", 10));
243      assertNull(jedis.rpop("foo"));
244      assertNull(jedis.rpop("foo", 1));
245      assertNull(jedis.rpop(bfoo));
246      assertNull(jedis.rpop(bfoo, 0));
247      jedis.rpush(bfoo, bA);
248      jedis.rpush(bfoo, bB);
249      jedis.rpush(bfoo, bC);
250      assertArrayEquals(bC, jedis.rpop(bfoo));
251      assertByteArrayListEquals(Arrays.asList(bB, bA), jedis.rpop(bfoo, 10));
252      assertNull(jedis.rpop(bfoo));
253      assertNull(jedis.rpop(bfoo, 1));
254    }
255    @Test
256    public void rpoplpush() {
257      jedis.rpush("foo", "a");
258      jedis.rpush("foo", "b");
259      jedis.rpush("foo", "c");
260      jedis.rpush("dst", "foo");
261      jedis.rpush("dst", "bar");
262      String element = jedis.rpoplpush("foo", "dst");
263      assertEquals("c", element);
264      List<String> srcExpected = new ArrayList<String>();
265      srcExpected.add("a");
266      srcExpected.add("b");
267      List<String> dstExpected = new ArrayList<String>();
268      dstExpected.add("c");
269      dstExpected.add("foo");
270      dstExpected.add("bar");
271      assertEquals(srcExpected, jedis.lrange("foo", 0, 1000));
272      assertEquals(dstExpected, jedis.lrange("dst", 0, 1000));
273      jedis.rpush(bfoo, bA);
274      jedis.rpush(bfoo, bB);
275      jedis.rpush(bfoo, bC);
276      jedis.rpush(bdst, bfoo);
277      jedis.rpush(bdst, bbar);
278      byte[] belement = jedis.rpoplpush(bfoo, bdst);
279      assertArrayEquals(bC, belement);
280      List<byte[]> bsrcExpected = new ArrayList<byte[]>();
281      bsrcExpected.add(bA);
282      bsrcExpected.add(bB);
283      List<byte[]> bdstExpected = new ArrayList<byte[]>();
284      bdstExpected.add(bC);
285      bdstExpected.add(bfoo);
286      bdstExpected.add(bbar);
287      assertByteArrayListEquals(bsrcExpected, jedis.lrange(bfoo, 0, 1000));
288      assertByteArrayListEquals(bdstExpected, jedis.lrange(bdst, 0, 1000));
289    }
290    @Test
291    public void blpop() throws InterruptedException {
292      List<String> result = jedis.blpop(1, "foo");
293      assertNull(result);
294      jedis.lpush("foo", "bar");
295      result = jedis.blpop(1, "foo");
296      assertNotNull(result);
297      assertEquals(2, result.size());
298      assertEquals("foo", result.get(0));
299      assertEquals("bar", result.get(1));
300      result = jedis.blpop(1, "foo", "foo1");
301      assertNull(result);
302      jedis.lpush("foo", "bar");
303      jedis.lpush("foo1", "bar1");
304      result = jedis.blpop(1, "foo1", "foo");
305      assertNotNull(result);
306      assertEquals(2, result.size());
307      assertEquals("foo1", result.get(0));
308      assertEquals("bar1", result.get(1));
309      jedis.lpush(bfoo, bbar);
310      List<byte[]> bresult = jedis.blpop(1, bfoo);
311      assertNotNull(bresult);
312      assertEquals(2, bresult.size());
313      assertArrayEquals(bfoo, bresult.get(0));
314      assertArrayEquals(bbar, bresult.get(1));
315      bresult = jedis.blpop(1, bfoo, bfoo1);
316      assertNull(bresult);
317      jedis.lpush(bfoo, bbar);
318      jedis.lpush(bfoo1, bcar);
319      bresult = jedis.blpop(1, bfoo, bfoo1);
320      assertNotNull(bresult);
321      assertEquals(2, bresult.size());
322      assertArrayEquals(bfoo, bresult.get(0));
323      assertArrayEquals(bbar, bresult.get(1));
324    }
325    @Test
326    public void blpopDouble() throws InterruptedException {
327      KeyValue<String, String> result = jedis.blpop(0.1, "foo");
328      assertNull(result);
329      jedis.lpush("foo", "bar");
330      result = jedis.blpop(3.2, "foo");
331      assertNotNull(result);
332      assertEquals("foo", result.getKey());
333      assertEquals("bar", result.getValue());
334      result = jedis.blpop(0.18, "foo", "foo1");
335      assertNull(result);
336      jedis.lpush("foo", "bar");
337      jedis.lpush("foo1", "bar1");
338      result = jedis.blpop(1d, "foo1", "foo");
339      assertNotNull(result);
340      assertEquals("foo1", result.getKey());
341      assertEquals("bar1", result.getValue());
342      jedis.lpush(bfoo, bbar);
343      KeyValue<byte[], byte[]> bresult = jedis.blpop(3.12, bfoo);
344      assertNotNull(bresult);
345      assertArrayEquals(bfoo, bresult.getKey());
346      assertArrayEquals(bbar, bresult.getValue());
347      bresult = jedis.blpop(0.11, bfoo, bfoo1);
348      assertNull(bresult);
349      jedis.lpush(bfoo, bbar);
350      jedis.lpush(bfoo1, bcar);
351      bresult = jedis.blpop(1d, bfoo, bfoo1);
352      assertNotNull(bresult);
353      assertArrayEquals(bfoo, bresult.getKey());
354      assertArrayEquals(bbar, bresult.getValue());
355    }
356    @Test
357    public void blpopDoubleWithSleep() {
358      long startMillis, totalMillis;
359      startMillis = System.currentTimeMillis();
360      KeyValue<String, String> result = jedis.blpop(0.04, "foo");
361      totalMillis = System.currentTimeMillis() - startMillis;
362      assertTrue("TotalMillis=" + totalMillis, totalMillis < 200);
363      assertNull(result);
364      startMillis = System.currentTimeMillis();
365      new Thread(() -> {
366        try {
367          Thread.sleep(30);
368        } catch(InterruptedException e) {
369          logger.error("", e);
370        }
371        jedis.lpush("foo", "bar");
372      }).start();
373      result = jedis.blpop(1.2, "foo");
374      totalMillis = System.currentTimeMillis() - startMillis;
375      assertTrue("TotalMillis=" + totalMillis, totalMillis < 200);
376      assertNotNull(result);
377      assertEquals("foo", result.getKey());
378      assertEquals("bar", result.getValue());
379    }
380    @Test
381    public void brpop() throws InterruptedException {
382      List<String> result = jedis.brpop(1, "foo");
383      assertNull(result);
384      jedis.lpush("foo", "bar");
385      result = jedis.brpop(1, "foo");
386      assertNotNull(result);
387      assertEquals(2, result.size());
388      assertEquals("foo", result.get(0));
389      assertEquals("bar", result.get(1));
390      result = jedis.brpop(1, "foo", "foo1");
391      assertNull(result);
392      jedis.lpush("foo", "bar");
393      jedis.lpush("foo1", "bar1");
394      result = jedis.brpop(1, "foo1", "foo");
395      assertNotNull(result);
396      assertEquals(2, result.size());
397      assertEquals("foo1", result.get(0));
398      assertEquals("bar1", result.get(1));
399      jedis.lpush(bfoo, bbar);
400      List<byte[]> bresult = jedis.brpop(1, bfoo);
401      assertNotNull(bresult);
402      assertEquals(2, bresult.size());
403      assertArrayEquals(bfoo, bresult.get(0));
404      assertArrayEquals(bbar, bresult.get(1));
405      bresult = jedis.brpop(1, bfoo, bfoo1);
406      assertNull(bresult);
407      jedis.lpush(bfoo, bbar);
408      jedis.lpush(bfoo1, bcar);
409      bresult = jedis.brpop(1, bfoo, bfoo1);
410      assertNotNull(bresult);
411      assertEquals(2, bresult.size());
412      assertArrayEquals(bfoo, bresult.get(0));
413      assertArrayEquals(bbar, bresult.get(1));
414    }
415    @Test
416    public void brpopDouble() throws InterruptedException {
417      KeyValue<String, String> result = jedis.brpop(0.1, "foo");
418      assertNull(result);
419      jedis.lpush("foo", "bar");
420      result = jedis.brpop(3.2, "foo");
421      assertNotNull(result);
422      assertEquals("foo", result.getKey());
423      assertEquals("bar", result.getValue());
424      result = jedis.brpop(0.18, "foo", "foo1");
425      assertNull(result);
426      jedis.lpush("foo", "bar");
427      jedis.lpush("foo1", "bar1");
428      result = jedis.brpop(1d, "foo1", "foo");
429      assertNotNull(result);
430      assertEquals("foo1", result.getKey());
431      assertEquals("bar1", result.getValue());
432      jedis.lpush(bfoo, bbar);
433      KeyValue<byte[], byte[]> bresult = jedis.brpop(3.12, bfoo);
434      assertNotNull(bresult);
435      assertArrayEquals(bfoo, bresult.getKey());
436      assertArrayEquals(bbar, bresult.getValue());
437      bresult = jedis.brpop(0.11, bfoo, bfoo1);
438      assertNull(bresult);
439      jedis.lpush(bfoo, bbar);
440      jedis.lpush(bfoo1, bcar);
441      bresult = jedis.brpop(1d, bfoo, bfoo1);
442      assertNotNull(bresult);
443      assertArrayEquals(bfoo, bresult.getKey());
444      assertArrayEquals(bbar, bresult.getValue());
445    }
446    @Test
447    public void brpopDoubleWithSleep() {
448      long startMillis, totalMillis;
449      startMillis = System.currentTimeMillis();
450      KeyValue<String, String> result = jedis.brpop(0.04, "foo");
451      totalMillis = System.currentTimeMillis() - startMillis;
452      assertTrue("TotalMillis=" + totalMillis, totalMillis < 200);
453      assertNull(result);
454      startMillis = System.currentTimeMillis();
455      new Thread(() -> {
456        try {
457          Thread.sleep(30);
458        } catch(InterruptedException e) {
459          logger.error("", e);
460        }
461        jedis.lpush("foo", "bar");
462      }).start();
463      result = jedis.brpop(1.2, "foo");
464      totalMillis = System.currentTimeMillis() - startMillis;
465      assertTrue("TotalMillis=" + totalMillis, totalMillis < 200);
466      assertNotNull(result);
467      assertEquals("foo", result.getKey());
468      assertEquals("bar", result.getValue());
469    }
470    @Test
471    public void lpushx() {
472      assertEquals(0, jedis.lpushx("foo", "bar"));
473      jedis.lpush("foo", "a");
474      assertEquals(2, jedis.lpushx("foo", "b"));
475      assertEquals(0, jedis.lpushx(bfoo, bbar));
476      jedis.lpush(bfoo, bA);
477      assertEquals(2, jedis.lpushx(bfoo, bB));
478    }
479    @Test
480    public void rpushx() {
481      assertEquals(0, jedis.rpushx("foo", "bar"));
482      jedis.lpush("foo", "a");
483      assertEquals(2, jedis.rpushx("foo", "b"));
484      assertEquals(0, jedis.rpushx(bfoo, bbar));
485      jedis.lpush(bfoo, bA);
486      assertEquals(2, jedis.rpushx(bfoo, bB));
487    }
488    @Test
489    public void linsert() {
490      assertEquals(0, jedis.linsert("foo", ListPosition.BEFORE, "bar", "car"));
491      jedis.lpush("foo", "a");
492      assertEquals(2, jedis.linsert("foo", ListPosition.AFTER, "a", "b"));
493      List<String> expected = new ArrayList<String>();
494      expected.add("a");
495      expected.add("b");
496      assertEquals(expected, jedis.lrange("foo", 0, 100));
497      assertEquals(-1, jedis.linsert("foo", ListPosition.BEFORE, "bar", "car"));
498      assertEquals(0, jedis.linsert(bfoo, ListPosition.BEFORE, bbar, bcar));
499      jedis.lpush(bfoo, bA);
500      assertEquals(2, jedis.linsert(bfoo, ListPosition.AFTER, bA, bB));
501      List<byte[]> bexpected = new ArrayList<byte[]>();
502      bexpected.add(bA);
503      bexpected.add(bB);
504      assertByteArrayListEquals(bexpected, jedis.lrange(bfoo, 0, 100));
505      assertEquals(-1, jedis.linsert(bfoo, ListPosition.BEFORE, bbar, bcar));
506    }
507    @Test
508    public void brpoplpush() {
509      new Thread(new Runnable() {
510        @Override
511        public void run() {
512          try {
513            Thread.sleep(100);
514          } catch (InterruptedException e) {
515            logger.error("", e);
516          }
517          jedis.lpush("foo", "a");
518        }
519      }).start();
520      String element = jedis.brpoplpush("foo", "bar", 0);
521      assertEquals("a", element);
522      assertEquals(1, jedis.llen("bar"));
523      assertEquals("a", jedis.lrange("bar", 0, -1).get(0));
524      new Thread(new Runnable() {
525        @Override
526        public void run() {
527          try {
528            Thread.sleep(100);
529          } catch (InterruptedException e) {
530            logger.error("", e);
531          }
532          jedis.lpush(bfoo, bA);
533        }
534      }).start();
535      byte[] belement = jedis.brpoplpush(bfoo, bbar, 0);
536      assertArrayEquals(bA, belement);
537      assertEquals(1, jedis.llen("bar"));
538      assertArrayEquals(bA, jedis.lrange(bbar, 0, -1).get(0));
539    }
540    @Test
541    public void lpos() {
542      jedis.rpush("foo", "a");
543      jedis.rpush("foo", "b");
544      jedis.rpush("foo", "c");
545      Long pos = jedis.lpos("foo", "b");
546      assertEquals(1, pos.intValue());
547      pos = jedis.lpos("foo", "d");
548      assertNull(pos);
549      jedis.rpush("foo", "a");
550      jedis.rpush("foo", "b");
551      jedis.rpush("foo", "b");
552      pos = jedis.lpos("foo", "b", LPosParams.lPosParams());
553      assertEquals(1, pos.intValue());
554      pos = jedis.lpos("foo", "b", LPosParams.lPosParams().rank(3));
555      assertEquals(5, pos.intValue());
556      pos = jedis.lpos("foo", "b", LPosParams.lPosParams().rank(-2));
557      assertEquals(4, pos.intValue());
558      pos = jedis.lpos("foo", "b", LPosParams.lPosParams().rank(-5));
559      assertNull(pos);
560      pos = jedis.lpos("foo", "b", LPosParams.lPosParams().rank(1).maxlen(2));
561      assertEquals(1, pos.intValue());
562      pos = jedis.lpos("foo", "b", LPosParams.lPosParams().rank(2).maxlen(2));
563      assertNull(pos);
564      pos = jedis.lpos("foo", "b", LPosParams.lPosParams().rank(-2).maxlen(2));
565      assertEquals(4, pos.intValue());
566      List<Long> expected = new ArrayList<Long>();
567      expected.add(1L);
568      expected.add(4L);
569      expected.add(5L);
570      List<Long> posList = jedis.lpos("foo", "b", LPosParams.lPosParams(), 2);
571      assertEquals(expected.subList(0, 2), posList);
572      posList = jedis.lpos("foo", "b", LPosParams.lPosParams(), 0);
573      assertEquals(expected, posList);
574      posList = jedis.lpos("foo", "b", LPosParams.lPosParams().rank(2), 0);
575      assertEquals(expected.subList(1, 3), posList);
576      posList = jedis.lpos("foo", "b", LPosParams.lPosParams().rank(2).maxlen(5), 0);
577      assertEquals(expected.subList(1, 2), posList);
578      Collections.reverse(expected);
579      posList = jedis.lpos("foo", "b", LPosParams.lPosParams().rank(-2), 0);
580      assertEquals(expected.subList(1, 3), posList);
581      posList = jedis.lpos("foo", "b", LPosParams.lPosParams().rank(-1).maxlen(5), 2);
582      assertEquals(expected.subList(0, 2), posList);
583      jedis.rpush(bfoo, bA);
584      jedis.rpush(bfoo, bB);
585      jedis.rpush(bfoo, bC);
586      pos = jedis.lpos(bfoo, bB);
587      assertEquals(1, pos.intValue());
588      pos = jedis.lpos(bfoo, b3);
589      assertNull(pos);
590      jedis.rpush(bfoo, bA);
591      jedis.rpush(bfoo, bB);
592      jedis.rpush(bfoo, bA);
593      pos = jedis.lpos(bfoo, bB, LPosParams.lPosParams().rank(2));
594      assertEquals(4, pos.intValue());
595      pos = jedis.lpos(bfoo, bB, LPosParams.lPosParams().rank(-2).maxlen(5));
596      assertEquals(1, pos.intValue());
597      expected.clear();
598      expected.add(0L);
599      expected.add(3L);
600      expected.add(5L);
601      posList = jedis.lpos(bfoo, bA, LPosParams.lPosParams().maxlen(6), 0);
602      assertEquals(expected, posList);
603      posList = jedis.lpos(bfoo, bA, LPosParams.lPosParams().maxlen(6).rank(2), 1);
604      assertEquals(expected.subList(1, 2), posList);
605    }
606    @Test
607    public void lmove() {
608      jedis.rpush("foo", "bar1", "bar2", "bar3");
609      assertEquals("bar3", jedis.lmove("foo", "bar", ListDirection.RIGHT, ListDirection.LEFT));
610      assertEquals(Collections.singletonList("bar3"), jedis.lrange("bar", 0, -1));
611      assertEquals(Arrays.asList("bar1", "bar2"), jedis.lrange("foo", 0, -1));
612      jedis.rpush(bfoo, b1, b2, b3);
613      assertArrayEquals(b3, jedis.lmove(bfoo, bbar, ListDirection.RIGHT, ListDirection.LEFT));
614      assertByteArrayListEquals(Collections.singletonList(b3), jedis.lrange(bbar, 0, -1));
615      assertByteArrayListEquals(Arrays.asList(b1, b2), jedis.lrange(bfoo, 0, -1));
616    }
617    @Test
618    public void blmove() {
619      new Thread(() -> {
620        try {
<span onclick='openModal()' class='match'>621          Thread.sleep(100);
622        } catch (InterruptedException e) {
623          logger.error("", e);
</span>624        }
625        jedis.rpush("foo", "bar1", "bar2", "bar3");
626      }).start();
627      assertEquals("bar3", jedis.blmove("foo", "bar", ListDirection.RIGHT, ListDirection.LEFT, 0));
628      assertEquals(Collections.singletonList("bar3"), jedis.lrange("bar", 0, -1));
629      assertEquals(Arrays.asList("bar1", "bar2"), jedis.lrange("foo", 0, -1));
630      new Thread(() -> {
631        try {
632          Thread.sleep(100);
633        } catch (InterruptedException e) {
634          logger.error("", e);
635        }
636        jedis.rpush(bfoo, b1, b2, b3);
637      }).start();
638      assertArrayEquals(b3, jedis.blmove(bfoo, bbar, ListDirection.RIGHT, ListDirection.LEFT, 0));
639      assertByteArrayListEquals(Collections.singletonList(b3), jedis.lrange(bbar, 0, -1));
640      assertByteArrayListEquals(Arrays.asList(b1, b2), jedis.lrange(bfoo, 0, -1));
641    }
642    @Test
643    public void lmpop() {
644      String mylist1 = "mylist1";
645      String mylist2 = "mylist2";
646      jedis.lpush(mylist1, "one", "two", "three", "four", "five");
647      jedis.lpush(mylist2, "one", "two", "three", "four", "five");
648      KeyValue<String, List<String>> elements = jedis.lmpop(ListDirection.LEFT, mylist1, mylist2);
649      assertEquals(mylist1, elements.getKey());
650      assertEquals(1, elements.getValue().size());
651      elements = jedis.lmpop(ListDirection.LEFT, 5, mylist1, mylist2);
652      assertEquals(mylist1, elements.getKey());
653      assertEquals(4, elements.getValue().size());
654      elements = jedis.lmpop(ListDirection.RIGHT, 100, mylist1, mylist2);
655      assertEquals(mylist2, elements.getKey());
656      assertEquals(5, elements.getValue().size());
657      elements = jedis.lmpop(ListDirection.RIGHT, mylist1, mylist2);
658      assertNull(elements);
659    }
660    @Test
661    public void blmpopSimple() {
662      String mylist1 = "mylist1";
663      String mylist2 = "mylist2";
664      jedis.lpush(mylist1, "one", "two", "three", "four", "five");
665      jedis.lpush(mylist2, "one", "two", "three", "four", "five");
666      KeyValue<String, List<String>> elements = jedis.blmpop(1L, ListDirection.LEFT, mylist1, mylist2);
667      assertEquals(mylist1, elements.getKey());
668      assertEquals(1, elements.getValue().size());
669      elements = jedis.blmpop(1L, ListDirection.LEFT, 5, mylist1, mylist2);
670      assertEquals(mylist1, elements.getKey());
671      assertEquals(4, elements.getValue().size());
672      elements = jedis.blmpop(1L, ListDirection.RIGHT, 100, mylist1, mylist2);
673      assertEquals(mylist2, elements.getKey());
674      assertEquals(5, elements.getValue().size());
675      elements = jedis.blmpop(1L, ListDirection.RIGHT, mylist1, mylist2);
676      assertNull(elements);
677    }
678  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-StreamsCommandsTest.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-ListCommandsTestBase.java</div>
                </div>
                <div class="column column_space"><pre><code>498        Thread.sleep(100);
499      } catch (InterruptedException e) {
500        e.printStackTrace();
</pre></code></div>
                <div class="column column_space"><pre><code>621          Thread.sleep(100);
622        } catch (InterruptedException e) {
623          logger.error("", e);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    