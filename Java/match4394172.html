<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for StringToArrayFunction.java &amp; GroupByAggregateTest.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for StringToArrayFunction.java &amp; GroupByAggregateTest.java
      </h3>
<h1 align="center">
        2.6%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>StringToArrayFunction.java (14.942529%)<th>GroupByAggregateTest.java (1.4309301%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(43-62)<td><a href="#" name="0">(60-67)</a><td align="center"><font color="#ff0000">13</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(22-36)<td><a href="#" name="1">(22-36)</a><td align="center"><font color="#ff0000">13</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>StringToArrayFunction.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>package io.crate.expression.scalar;
2 import io.crate.data.Input;
3 import io.crate.metadata.NodeContext;
4 import io.crate.metadata.Scalar;
5 import io.crate.metadata.TransactionContext;
6 import io.crate.metadata.functions.Signature;
7 import io.crate.types.DataTypes;
8 import javax.annotation.Nonnull;
9 import javax.annotation.Nullable;
10 import java.util.ArrayList;
11 import java.util.Collections;
12 import java.util.List;
13 import</b></font> java.util.Objects;
14 public class StringToArrayFunction extends Scalar&lt;List&lt;String&gt;, String&gt; {
15 <a name="0"></a>    private static final String NAME = "string_to_array";
16     public static void register(ScalarFunctionModule module) {
17         <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>module.register(
18             Signature.scalar(
19                 NAME,
20                 DataTypes.STRING.getTypeSignature(),
21                 DataTypes.STRING.getTypeSignature(),
22                 DataTypes.STRING_ARRAY.getTypeSignature()
23             ),
24             StringToArrayFunction::new
25         );
26         module.register(
27             Signature.scalar(
28                 NAME,
29                 DataTypes.STRING.getTypeSignature(),
30                 DataTypes.STRING.getTypeSignature(),
31                 DataTypes.STRING.getTypeSignature(),
32                 DataTypes.STRING_ARRAY.getTypeSignature()
33             ),
34             StringToArrayFunction::new
35         );
36     }</b></font>
37     private final Signature signature;
38     private final Signature boundSignature;
39     public StringToArrayFunction(Signature signature, Signature boundSignature) {
40         this.signature = signature;
41         this.boundSignature = boundSignature;
42     }
43     @Override
44     public Signature signature() {
45         return signature;
46     }
47     @Override
48     public Signature boundSignature() {
49         return boundSignature;
50     }
51     @Override
52     public List&lt;String&gt; evaluate(TransactionContext txnCtx, NodeContext nodeCtx, Input&lt;String&gt;[] args) {
53         assert args.length == 2 || args.length == 3 : "number of args must be 2 or 3";
54         String str = args[0].value();
55         if (str == null) {
56             return null;
57         }
58         if (str.isEmpty()) {
59             return List.of();
60         }
61         String separator = args[1].value();
62         String nullStr = null;
63         if (args.length == 3) {
64             nullStr = args[2].value();
65         }
66         return split(str, separator, nullStr);
67     }
68     private static List&lt;String&gt; split(@Nonnull String str, @Nullable String separator, @Nullable String nullStr) {
69         if (separator == null) {
70             ArrayList&lt;String&gt; subStrings = new ArrayList&lt;&gt;(str.length());
71             for (int i = 0; i &lt; str.length(); i++) {
72                 String subStr = String.valueOf(str.charAt(i));
73                 subStrings.add(setToNullIfMatch(subStr, nullStr));
74             }
75             return subStrings;
76         } else if (separator.isEmpty()) {
77             return Collections.singletonList(setToNullIfMatch(str, nullStr));
78         } else {
79             ArrayList&lt;String&gt; subStrings = new ArrayList&lt;&gt;();
80             int start = 0;                                  int pos = str.indexOf(separator);   
81             while (pos &gt;= start) {
82                 String subStr;
83                 if (pos &gt; start) {
84                     subStr = str.substring(start, pos);
85                 } else {
86                     subStr = "";
87                 }
88                 start = pos + separator.length();
89                 pos = str.indexOf(separator, start);
90                 subStrings.add(setToNullIfMatch(subStr, nullStr));
91             }
92             String subStr = str.substring(start);
93             subStrings.add(setToNullIfMatch(subStr, nullStr));
94             return subStrings;
95         }
96     }
97     @Nullable
98     private static String setToNullIfMatch(String subStr, String nullStr) {
99         if (Objects.equals(subStr, nullStr)) {
100             return null;
101         }
102         return subStr;
103     }
104 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>GroupByAggregateTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>package io.crate.integrationtests;
2 import io.crate.data.ArrayBucket;
3 import io.crate.data.Paging;
4 import io.crate.testing.SQLResponse;
5 import io.crate.testing.TestingHelpers;
6 import io.crate.testing.UseJdbc;
7 import org.elasticsearch.test.ESIntegTestCase;
8 import org.hamcrest.Matchers;
9 import org.hamcrest.core.Is;
10 import org.junit.Before;
11 import org.junit.Test;
12 import org.junit.jupiter.api.Assertions;
13 import</b></font> java.util.Arrays;
14 import static com.carrotsearch.randomizedtesting.RandomizedTest.randomAsciiLettersOfLength;
15 import static io.crate.testing.TestingHelpers.printedTable;
16 import static org.hamcrest.CoreMatchers.is;
17 import static org.hamcrest.Matchers.closeTo;
18 import static org.hamcrest.Matchers.isIn;
19 import static org.hamcrest.Matchers.not;
20 @ESIntegTestCase.ClusterScope(numDataNodes = 2, numClientNodes = 0, supportsDedicatedMasters = false)
21 public class GroupByAggregateTest extends SQLIntegrationTestCase {
22     private Setup setup = new Setup(sqlExecutor);
23     @Before
24     public void initTestData() {
25         setup.setUpEmployees();
26     }
27     @Test
28     public void selectGroupByAggregateMinInteger() throws Exception {
29 <a name="0"></a>        this.setup.groupBySetup("integer");
30         execute("select min(age) as minage, gender from characters group by gender order by gender");
31         assertArrayEquals(new String[]{"minage", "gender"}, <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>response.cols());
32         assertEquals(2L, response.rowCount());
33         assertEquals("female", response.rows()[0][1]);
34         assertEquals(32, response.rows()[0][0]);
35         assertEquals("male", response.rows()[1][1]);
36         assertEquals(34, response.rows()[1][0]);
37     }</b></font>
38     @Test
39     public void testSelectDistinctWithPaging() throws Exception {
40         Paging.PAGE_SIZE = 2;
41         execute("create table t (name string) with (number_of_replicas = 0)");
42         ensureYellow();
43         execute("insert into t (name) values ('Marvin'), ('Trillian'), ('Ford'), ('Arthur')");
44         execute("refresh table t");
45         execute("select distinct name from t");
46     }
47     @Test
48     public void testNonDistributedGroupByWithManyKeysNoOrderByAndLimit() throws Exception {
49         execute("create table t (name string, x int) clustered by (name) with (number_of_replicas = 0)");
50         ensureYellow();
51         execute("insert into t (name, x) values ('Marvin', 1), ('Trillian', 1), ('Ford', 1), ('Arthur', 1)");
52         execute("refresh table t");
53         execute("select count(*), name from t group by name, x limit 2");
54         assertThat(response.rowCount(), is(2L));
55     }
56     @Test
57     public void testGroupByOnClusteredByColumnPartOfPrimaryKey() {
58         execute("CREATE TABLE tickets ( " +
59                 " pk1 long, " +
60                 " pk2 integer, " +
61                 " pk3 timestamp with time zone," +
62                 " value string," +
63                 " primary key(pk1, pk2, pk3)) " +
64                 "CLUSTERED BY (pk2) INTO 3 SHARDS " +
65                 "PARTITIONED BY (pk3) " +
66                 "WITH (column_policy = 'strict', number_of_replicas=0)");
67         ensureYellow();
68         execute("insert into tickets (pk1, pk2, pk3, value) values (?, ?, ?, ?)",
69             new Object[][]{
70                 {1L, 42, 1425168000000L, "foo"},
71                 {2L, 43, 0L, "bar"},
72                 {3L, 44, 1425168000000L, "baz"},
73                 {4L, 45, 499651200000L, null},
74                 {5L, 42, 0L, "foo"}
75             });
76         ensureYellow();
77         refresh();
78         execute("select pk2, count(pk2) from tickets group by pk2 order by pk2 limit 100");
79         assertThat(printedTable(response.rows()), is(
80             "42| 2\n" +             "43| 1\n" +
81             "44| 1\n" +
82             "45| 1\n"));
83         execute("create table tickets_export (c2 int, c long) with (number_of_replicas = 0)");
84         ensureYellow();
85         execute("insert into tickets_export (c2, c) (select pk2, count(pk2) from tickets group by pk2)");
86         execute("refresh table tickets_export");
87         execute("select c2, c from tickets_export order by 1");
88         assertThat(printedTable(response.rows()), is(
89             "42| 2\n" +             "43| 1\n" +
90             "44| 1\n" +
91             "45| 1\n"));
92     }
93     @Test
94     public void selectGroupByAggregateMinFloat() throws Exception {
95         this.setup.groupBySetup("float");
96         execute("select min(age), gender from characters group by gender order by gender");
97         String expected = "32.0| female\n34.0| male\n";
98         assertEquals("min(age)", response.cols()[0]);
99         assertEquals(expected, printedTable(response.rows()));
100     }
101     @Test
102     public void selectGroupByAggregateMinDouble() throws Exception {
103         this.setup.groupBySetup("double");
104         execute("select min(age) as minAge, gender from characters group by gender order by gender");
105         assertEquals(2L, response.rowCount());
106         assertEquals(32.0d, response.rows()[0][0]);
107         assertEquals(34.0d, response.rows()[1][0]);
108     }
109     @Test
110     public void testCountDistinctGlobal() throws Exception {
111         execute("select count(distinct department), count(*) from employees");
112         assertEquals(1L, response.rowCount());
113         assertEquals(4L, response.rows()[0][0]);
114         assertEquals(6L, response.rows()[0][1]);
115     }
116     @Test
117     public void testCountDistinctGroupBy() throws Exception {
118         this.setup.groupBySetup("integer");
119         execute("select count(distinct gender), count(*), race from characters group by race order by count(*) desc");
120         assertEquals(3L, response.rowCount());
121         assertEquals(2L, response.rows()[0][0]);
122         assertEquals(4L, response.rows()[0][1]);
123         assertEquals("Human", response.rows()[0][2]);
124         assertEquals(1L, response.rows()[1][0]);
125         assertEquals(2L, response.rows()[1][1]);
126         assertEquals("Vogon", response.rows()[1][2]);
127         assertEquals(1L, response.rows()[2][0]);
128         assertEquals(1L, response.rows()[2][1]);
129         assertEquals("Android", response.rows()[2][2]);
130     }
131     @Test
132     public void testCountDistinctGroupByOrderByCountDistinct() throws Exception {
133         this.setup.groupBySetup("integer");
134         execute("select count(distinct gender), count(*), race from characters group by race order by count(distinct gender) desc");
135         assertEquals(3L, response.rowCount());
136         assertEquals(2L, response.rows()[0][0]);
137     }
138     @Test
139     public void testCountDistinctManySame() throws Exception {
140         this.setup.groupBySetup("integer");
141         execute("select race, count(distinct gender), count(*), count(distinct gender) " +
142                 "from characters group by race order by count(distinct gender) desc, " +
143                 "count(*) desc");
144         assertEquals(3L, response.rowCount());
145         assertEquals("Human", response.rows()[0][0]);
146         assertEquals(2L, response.rows()[0][1]);
147         assertEquals(4L, response.rows()[0][2]);
148         assertEquals(2L, response.rows()[0][3]);
149         assertEquals("Vogon", response.rows()[1][0]);
150         assertEquals(1L, response.rows()[1][1]);
151         assertEquals(2L, response.rows()[1][2]);
152         assertEquals(1L, response.rows()[1][3]);
153         assertEquals("Android", response.rows()[2][0]);
154         assertEquals(1L, response.rows()[2][1]);
155         assertEquals(1L, response.rows()[2][2]);
156         assertEquals(1L, response.rows()[2][3]);
157     }
158     @Test
159     public void testCountDistinctManyDifferent() throws Exception {
160         this.setup.groupBySetup("integer");
161         execute("select race, count(distinct gender), count(distinct age) " +
162                 "from characters group by race order by count(distinct gender) desc, race desc");
163         assertEquals(3L, response.rowCount());
164         assertEquals("Human", response.rows()[0][0]);
165         assertEquals(2L, response.rows()[0][1]);
166         assertEquals(4L, response.rows()[0][2]);
167         assertEquals("Vogon", response.rows()[1][0]);
168         assertEquals(1L, response.rows()[1][1]);
169         assertEquals(0L, response.rows()[1][2]);
170         assertEquals("Android", response.rows()[2][0]);
171         assertEquals(1L, response.rows()[2][1]);
172         assertEquals(0L, response.rows()[2][2]);
173     }
174     @Test
175     public void selectGroupByAggregateMinOrderByMin() throws Exception {
176         this.setup.groupBySetup("double");
177         execute("select min(age) as minAge, gender from characters group by gender order by minAge desc");
178         assertEquals(2L, response.rowCount());
179         assertEquals("male", response.rows()[0][1]);
180         assertEquals(34.0d, response.rows()[0][0]);
181         assertEquals("female", response.rows()[1][1]);
182         assertEquals(32.0d, response.rows()[1][0]);
183         execute("select min(age), gender from characters group by gender order by min(age) asc");
184         assertEquals(2L, response.rowCount());
185         assertEquals("female", response.rows()[0][1]);
186         assertEquals(32.0d, response.rows()[0][0]);
187         assertEquals("male", response.rows()[1][1]);
188         assertEquals(34.0d, response.rows()[1][0]);
189     }
190     @Test
191     public void selectGroupByAggregateMinLong() throws Exception {
192         this.setup.groupBySetup("long");
193         execute("select min(age) as minAge, gender from characters group by gender order by gender");
194         assertEquals(2L, response.rowCount());
195         assertEquals(32L, response.rows()[0][0]);
196         assertEquals(34L, response.rows()[1][0]);
197     }
198     @Test
199     public void selectGroupByAggregateMinString() throws Exception {
200         this.setup.groupBySetup();
201         execute("select min(name) as minName, gender from characters group by gender order by gender");
202         assertEquals(2L, response.rowCount());
203         assertEquals("Anjie", response.rows()[0][0]);
204         assertEquals("Arthur Dent", response.rows()[1][0]);
205     }
206     @Test
207     public void selectGroupByAggregateMinDate() throws Exception {
208         this.setup.groupBySetup();
209         execute("select min(birthdate) as minBirthdate, gender from characters group by gender " +
210                 "order by gender");
211         assertEquals(2L, response.rowCount());
212         assertEquals("female", response.rows()[0][1]);
213         assertEquals(0L, response.rows()[0][0]);
214         assertEquals("male", response.rows()[1][1]);
215         assertEquals(181353600000L, response.rows()[1][0]);
216     }
217     @Test
218     public void selectGroupByAggregateMaxString() throws Exception {
219         this.setup.groupBySetup();
220         execute("select max(name), gender from characters group by gender order by gender");
221         assertEquals(2L, response.rowCount());
222         assertEquals("Trillian", response.rows()[0][0]);
223         assertEquals("Marving", response.rows()[1][0]);
224     }
225     @Test
226     public void selectGroupByMixedCaseAggregateMaxString() throws Exception {
227         this.setup.groupBySetup();
228         execute("select max(NAME), GENDER from characters group by gender order by gender");
229         assertEquals(2L, response.rowCount());
230         assertEquals("Trillian", response.rows()[0][0]);
231         assertEquals("Marving", response.rows()[1][0]);
232     }
233     @Test
234     public void selectGroupByAggregateMaxLong() throws Exception {
235         this.setup.groupBySetup("long");
236         execute("select max(age), gender from characters group by gender order by gender");
237         assertEquals(2L, response.rowCount());
238         assertEquals(43L, response.rows()[0][0]);
239         assertEquals(112L, response.rows()[1][0]);
240     }
241     @Test
242     public void selectGroupByAggregateMaxDate() throws Exception {
243         execute("select max(hired), department from employees group by department " +
244                 "order by department asc");
245         assertEquals(4L, response.rowCount());
246         assertEquals("HR", response.rows()[0][1]);
247         assertEquals(631152000000L, response.rows()[0][0]);
248         assertEquals("engineering", response.rows()[1][1]);
249         assertEquals(946684800000L, response.rows()[1][0]);
250         assertEquals("internship", response.rows()[2][1]);
251         assertEquals(null, response.rows()[2][0]);
252         assertEquals("management", response.rows()[3][1]);
253         assertEquals(1286668800000L, response.rows()[3][0]);
254     }
255     @Test
256     public void selectGroupByAggregateMaxInteger() throws Exception {
257         this.setup.groupBySetup("integer");
258         execute("select max(age), gender from characters group by gender order by gender");
259         assertArrayEquals(new String[]{"max(age)", "gender"}, response.cols());
260         assertEquals(2L, response.rowCount());
261         assertEquals("female", response.rows()[0][1]);
262         assertEquals(43, response.rows()[0][0]);
263         assertEquals("male", response.rows()[1][1]);
264         assertEquals(112, response.rows()[1][0]);
265     }
266     @Test
267     public void selectGroupByAggregateMaxFloat() throws Exception {
268         this.setup.groupBySetup("float");
269         execute("select max(age), gender from characters group by gender order by gender");
270         assertEquals(2L, response.rowCount());
271         assertEquals("max(age)", response.cols()[0]);
272         assertEquals(43.0f, response.rows()[0][0]);
273         assertEquals(112.0f, response.rows()[1][0]);
274     }
275     @Test
276     public void selectGroupByAggregateMaxDouble() throws Exception {
277         execute("select max(income), department from employees group by department order by department");
278         assertEquals(4L, response.rowCount());
279         assertEquals(999999999.99d, response.rows()[0][0]);
280         assertEquals("HR", response.rows()[0][1]);
281         assertEquals(6000.0d, response.rows()[1][0]);
282         assertEquals("engineering", response.rows()[1][1]);
283         assertEquals(null, response.rows()[2][0]);
284         assertEquals("internship", response.rows()[2][1]);
285         assertEquals(Double.MAX_VALUE, response.rows()[3][0]);
286         assertEquals("management", response.rows()[3][1]);
287     }
288     @Test
289     public void selectGroupByAggregateMaxOrderByMax() throws Exception {
290         this.setup.groupBySetup("double");
291         execute("select max(age) as maxage, gender from characters group by gender order by maxage desc");
292         assertEquals(2L, response.rowCount());
293         assertEquals("male", response.rows()[0][1]);
294         assertEquals(112.0d, response.rows()[0][0]);
295         assertEquals("female", response.rows()[1][1]);
296         assertEquals(43.0d, response.rows()[1][0]);
297         execute("select max(age), gender from characters group by gender order by max(age) asc");
298         assertEquals(2L, response.rowCount());
299         assertEquals("female", response.rows()[0][1]);
300         assertEquals(43.0d, response.rows()[0][0]);
301         assertEquals("male", response.rows()[1][1]);
302         assertEquals(112.0d, response.rows()[1][0]);
303     }
304     @Test
305     public void testGroupByAggSumDouble() throws Exception {
306         execute("select sum(income), department from employees group by department order by sum(income) asc");
307         assertEquals(4, response.rowCount());
308         assertEquals("engineering", response.rows()[0][1]);
309         assertEquals(10000.0, response.rows()[0][0]);
310         assertEquals("HR", response.rows()[1][1]);
311         assertEquals(1000000000.49, response.rows()[1][0]);
312         assertEquals("management", response.rows()[2][1]);
313         assertEquals(Double.MAX_VALUE, response.rows()[2][0]);
314         assertEquals("internship", response.rows()[3][1]);
315         assertNull(response.rows()[3][0]);
316     }
317     @Test
318     public void testGroupByAggSumShort() throws Exception {
319         execute("select sum(age), department from employees group by department order by department asc");
320         assertEquals(4, response.rowCount());
321         assertEquals("HR", response.rows()[0][1]);
322         assertEquals(12L, response.rows()[0][0]);
323         assertEquals("engineering", response.rows()[1][1]);
324         assertEquals(101L, response.rows()[1][0]);
325         assertEquals("internship", response.rows()[2][1]);
326         assertEquals(28L, response.rows()[2][0]);
327         assertEquals("management", response.rows()[3][1]);
328         assertEquals(45L, response.rows()[3][0]);
329     }
330     @Test
331     public void testGroupByAvgDouble() throws Exception {
332         execute("select avg(income), mean(income), department from employees group by department order by department asc");
333         assertEquals(4, response.rowCount());
334         assertEquals(500000000.245d, response.rows()[0][0]);
335         assertEquals(500000000.245d, response.rows()[0][1]);
336         assertEquals("HR", response.rows()[0][2]);
337         assertEquals(5000.0d, response.rows()[1][0]);
338         assertEquals(5000.0d, response.rows()[1][1]);
339         assertEquals("engineering", response.rows()[1][2]);
340         assertEquals(null, response.rows()[2][0]);
341         assertEquals(null, response.rows()[2][1]);
342         assertEquals("internship", response.rows()[2][2]);
343         assertEquals(Double.MAX_VALUE, response.rows()[3][0]);
344         assertEquals(Double.MAX_VALUE, response.rows()[3][1]);
345         assertEquals("management", response.rows()[3][2]);
346     }
347     @Test
348     public void testGroupByAvgMany() throws Exception {
349         execute("select avg(income), avg(age), department from employees group by department order by department asc");
350         assertEquals(4, response.rowCount());
351         assertEquals("HR", response.rows()[0][2]);
352         assertEquals(500000000.245d, response.rows()[0][0]);
353         assertEquals(12.0d, response.rows()[0][1]);
354         assertEquals("engineering", response.rows()[1][2]);
355         assertEquals(5000.0d, response.rows()[1][0]);
356         assertEquals(50.5d, response.rows()[1][1]);
357         assertEquals("internship", response.rows()[2][2]);
358         assertEquals(null, response.rows()[2][0]);
359         assertEquals(28.0d, response.rows()[2][1]);
360         assertEquals("management", response.rows()[3][2]);
361         assertEquals(Double.MAX_VALUE, response.rows()[3][0]);
362         assertEquals(45.0d, response.rows()[3][1]);
363     }
364     @Test
365     public void testGroupByArbitrary() throws Exception {
366         this.setup.groupBySetup();
367         execute("select arbitrary(name), race from characters group by race order by race asc");
368         SQLResponse arbitrary_response = response;
369         assertEquals(3, arbitrary_response.rowCount());
370         assertEquals("Android", arbitrary_response.rows()[0][1]);
371         assertEquals(1,
372             execute("select name from characters where race=? AND name=? ",
373                 new Object[]{"Android", arbitrary_response.rows()[0][0]})
374                 .rowCount()
375         );
376         assertEquals("Human", arbitrary_response.rows()[1][1]);
377         assertEquals(1,
378             execute("select name from characters where race=? AND name=? ",
379                 new Object[]{"Human", arbitrary_response.rows()[1][0]})
380                 .rowCount()
381         );
382         assertEquals("Vogon", arbitrary_response.rows()[2][1]);
383         assertEquals(1,
384             execute("select name from characters where race=? AND name=? ",
385                 new Object[]{"Vogon", arbitrary_response.rows()[2][0]})
386                 .rowCount()
387         );
388     }
389     @Test
390     public void testGlobalAggregateArbitrary() throws Exception {
391         this.setup.groupBySetup();
392         execute("select arbitrary(age) from characters where age is not null");
393         assertEquals(1, response.rowCount());
394         assertEquals(1,
395             execute("select count(*) from characters where age=?",
396                 new Object[]{response.rows()[0][0]})
397                 .rowCount()
398         );
399     }
400     @Test
401     public void testAggregateArbitraryOnBoolean() throws Exception {
402         execute("select arbitrary(good) from employees");
403         assertEquals(1, response.rowCount());
404         assertThat(response.rows()[0][0], isIn(new Object[]{true, false, null}));
405         execute("select arbitrary(good) from employees where name='dilbert'");
406         assertEquals(1, response.rowCount());
407         assertEquals(true, response.rows()[0][0]);
408         execute("select arbitrary(good), department from employees group by department order by department asc");
409         assertEquals(4, response.rowCount());
410         assertEquals("HR", response.rows()[0][1]);
411         assertThat(response.rows()[0][0], isIn(new Object[]{false, null}));
412         assertEquals("engineering", response.rows()[1][1]);
413         assertEquals(true, response.rows()[1][0]);  
414         assertEquals("internship", response.rows()[2][1]);
415         assertNull(response.rows()[2][0]);
416         assertEquals("management", response.rows()[3][1]);
417         assertEquals(false, response.rows()[3][0]);
418     }
419     public void testGroupByCountOnColumn() throws Exception {
420         execute("select department, count(income), count(*) " +
421                 "from employees group by department order by department asc");
422         assertEquals(4, response.rowCount());
423         assertEquals("HR", response.rows()[0][0]);
424         assertEquals(2L, response.rows()[0][1]);
425         assertEquals(2L, response.rows()[0][2]);
426         assertEquals("engineering", response.rows()[1][0]);
427         assertEquals(2L, response.rows()[1][1]);
428         assertEquals(2L, response.rows()[1][2]);
429         assertEquals("internship", response.rows()[2][0]);
430         assertEquals(0L, response.rows()[2][1]);
431         assertEquals(1L, response.rows()[2][2]);
432         assertEquals("management", response.rows()[3][0]);
433         assertEquals(1L, response.rows()[3][1]);
434         assertEquals(1L, response.rows()[3][2]);
435     }
436     @Test
437     public void testCompareCountOnObjectHavingNotNullSubcolumnAndCountDirectlyOnNotNullSubcolumn() {
438         execute("""
439                    create table tbl (
440                         device int not null,
441                         payload object as (
442                             col int,
443                             nested_payload object as (
444                                 col int not null)
445                         ),
446                         nullable_payload object as (
447                             col int
448                         )
449                    )
450                    """);
451         execute("insert into tbl values(1, {col=11, nested_payload={col=111}}, {col=null})");
452         execute("insert into tbl values(1, {col=null, nested_payload={col=111}}, {col=11})");
453         execute("insert into tbl values(1, {col=11, nested_payload={col=111}}, null)");
454         execute("refresh table tbl");
455         execute("select device, count(payload) from tbl group by 1");
456         assertThat(printedTable(response.rows()), is("1| 3\n"));
457         execute("select device, count(payload['nested_payload']) from tbl group by 1");
458         assertThat(printedTable(response.rows()), is("1| 3\n"));
459         execute("select device, count(payload['nested_payload']['col']) from tbl group by 1");
460         assertThat(printedTable(response.rows()), is("1| 3\n"));
461         execute("select device, count(nullable_payload) from tbl group by 1");
462         assertThat(printedTable(response.rows()), is("1| 2\n"));
463         execute("select device, count(payload['col']) from tbl group by 1");
464         assertThat(printedTable(response.rows()), is("1| 2\n"));
465     }
466     @Test
467     public void testGlobalCountOnColumn() throws Exception {
468         execute("select count(*), count(good), count(distinct good) from employees");
469         assertEquals(1, response.rowCount());
470         assertEquals(6L, response.rows()[0][0]);
471         assertEquals(4L, response.rows()[0][1]);
472         assertEquals(2L, response.rows()[0][2]);
473     }
474     @Test
475     public void testGlobalCountDistinct() throws Exception {
476         execute("select count(distinct good) from employees");
477         assertEquals(1, response.rowCount());
478         assertEquals(2L, response.rows()[0][0]);
479     }
480     @Test
481     public void testGlobalCountDistinctColumnReuse() throws Exception {
482         execute("select count(distinct good), count(distinct department), count(distinct good) from employees");
483         assertEquals(1, response.rowCount());
484         assertEquals(2L, response.rows()[0][0]);
485         assertEquals(4L, response.rows()[0][1]);
486         assertEquals(2L, response.rows()[0][2]);
487     }
488     @Test
489     public void testGlobalAggregateOnNestedColumn() throws Exception {
490         this.setup.groupBySetup();
491         waitNoPendingTasksOnAll();
492         execute("select count(details['job']), min(details['job']), max(details['job']), count(distinct details['job']) from characters");
493         assertEquals(1, response.rowCount());
494         assertEquals(2L, response.rows()[0][0]);
495         assertEquals("Mathematician", response.rows()[0][1]);
496         assertEquals("Sandwitch Maker", response.rows()[0][2]);
497         assertEquals(2L, response.rows()[0][3]);
498     }
499     @Test
500     public void testGroupByAggregateOnNestedColumn() throws Exception {
501         this.setup.groupBySetup();
502         waitNoPendingTasksOnAll();
503         execute("select race, count(details['job']) from characters group by race order by race");
504         assertEquals(3, response.rowCount());
505         assertEquals("Android", response.rows()[0][0]);
506         assertEquals(0L, response.rows()[0][1]);
507         assertEquals("Human", response.rows()[1][0]);
508         assertEquals(2L, response.rows()[1][1]);
509         assertEquals("Vogon", response.rows()[2][0]);
510         assertEquals(0L, response.rows()[2][1]);
511     }
512     @Test
513     public void testGroupByAggregateOnNestedColumnOrderBy() throws Exception {
514         this.setup.groupBySetup();
515         waitNoPendingTasksOnAll();
516         execute("select race, count(details['job']) from characters group by race order by count(details['job']) desc limit 1");
517         assertEquals(1, response.rowCount());
518         assertArrayEquals(new String[]{"race", "count(details['job'])"}, response.cols());
519         assertEquals("Human", response.rows()[0][0]);
520         assertEquals(2L, response.rows()[0][1]);
521     }
522     @Test
523     public void testGroupByAggregateOnNestedColumnOrderByAlias() throws Exception {
524         this.setup.groupBySetup();
525         waitNoPendingTasksOnAll();
526         execute("select race, count(details['job']) as job_count from characters group by race order by job_count desc limit 1");
527         assertEquals(1, response.rowCount());
528         assertArrayEquals(new String[]{"race", "job_count"}, response.cols());
529         assertEquals("Human", response.rows()[0][0]);
530         assertEquals(2L, response.rows()[0][1]);
531     }
532     @Test
533     public void testGroupByUnknownResultColumn() throws Exception {
534         this.setup.groupBySetup();
535         Assertions.assertThrows(Exception.class, () -&gt; execute("select details_ignored['lol'] from characters group by race"),
536                                 "'details_ignored['lol']' must appear in the GROUP BY clause");
537     }
538     @Test
539     public void test_group_by_undefined_column_casted() throws Exception {
540         this.setup.groupBySetup();
541         execute("select max(age) from characters group by details_ignored['lol']::String");
542         assertEquals(1, response.rowCount());
543         assertEquals(112, response.rows()[0][0]);
544     }
545     @Test
546     public void testGroupByUnknownWhere() throws Exception {
547         this.setup.groupBySetup();
548         execute("select max(birthdate), race from characters where details_ignored['lol']='funky' group by race");
549         assertEquals(0, response.rowCount());
550     }
551     @Test
552     public void testNonDistributedGroupByNoMatch() throws Exception {
553         execute("create table characters (" +
554                 " details_ignored object(ignored)," +
555                 " race string" +
556                 ") clustered into 1 shards");
557         ensureYellow();
558         execute("select race from characters where details_ignored['lol']='funky' group by race");
559         assertEquals(0, response.rowCount());
560     }
561     @Test
562     public void testGlobalAggregateUnknownWhere() throws Exception {
563         this.setup.groupBySetup();
564         execute("select max(birthdate) from characters where details_ignored['lol']='funky'");
565         assertEquals(1, response.rowCount());
566         assertNull(response.rows()[0][0]);
567     }
568     @Test
569     public void testAggregateNonExistingColumn() throws Exception {
570         this.setup.groupBySetup();
571         execute("select max(details_ignored['lol']), race from characters group by race order by race");
572         assertThat(printedTable(response.rows()), is("NULL| Android\n" +
573                                                      "NULL| Human\n" +
574                                                      "NULL| Vogon\n"));
575     }
576     @Test
577     public void testHavingGlobalAggregation() throws Exception {
578         this.setup.groupBySetup("integer");
579         execute("select min(birthdate), min(age) from characters having min(age) &lt; 33 and max(age) &gt; 100");
580         assertEquals(1L, response.rowCount());
581         assertEquals(2, response.rows()[0].length);
582         assertEquals(0L, response.rows()[0][0]);
583         assertEquals(32, response.rows()[0][1]);
584     }
585     @Test
586     public void testHavingGroupBy() throws Exception {
587         this.setup.groupBySetup("integer");
588         execute("select age from characters group by age having age &gt; 40 order by age");
589         assertEquals(2L, response.rowCount());
590         assertEquals(43, response.rows()[0][0]);
591     }
592     @Test
593     public void testHavingGroupByOnScalar() throws Exception {
594         this.setup.groupBySetup("integer");
595         execute("select date_trunc('week', birthdate) from characters group by 1" +
596                 " having date_trunc('week', birthdate) &gt; 0" +
597                 " order by date_trunc('week', birthdate)");
598         assertEquals(2L, response.rowCount());
599     }
600     @Test
601     public void testHavingOnSameAggregate() throws Exception {
602         this.setup.groupBySetup("integer");
603         execute("select avg(birthdate) from characters group by gender\n" +
604                 "having avg(birthdate) = 181353600000.0");
605         assertThat(response.rowCount(), is(1L));
606         assertThat(printedTable(response.rows()), is("1.813536E11\n"));
607     }
608     @Test
609     public void testHavingOnOtherAggregate() throws Exception {
610         this.setup.groupBySetup("integer");
611         execute("select avg(birthdate) from characters group by gender\n" +
612                 "having min(birthdate) &gt; '1970-01-01'");
613         assertThat(response.rowCount(), is(1L));
614         assertThat(printedTable(response.rows()), is("1.813536E11\n"));
615     }
616     @Test
617     public void testHavingGroupByWithAggSelected() throws Exception {
618         this.setup.groupBySetup("integer");
619         execute("select age, count(*) from characters group by age having age &gt; 40 order by age");
620         assertEquals(2L, response.rowCount());
621         assertEquals(43, response.rows()[0][0]);
622     }
623     @Test
624     public void testHavingGroupByNonDistributed() throws Exception {
625         execute("create table foo (id int, name string, country string) clustered by (country) with (number_of_replicas = 0)");
626         ensureYellow();
627         execute("insert into foo (id, name, country) values (?, ?, ?)", new Object[][]{
628             new Object[]{1, "Arthur", "Austria"},
629             new Object[]{2, "Trillian", "Austria"},
630             new Object[]{3, "Marvin", "Austria"},
631             new Object[]{4, "Jeltz", "German"},
632             new Object[]{5, "Ford", "German"},
633             new Object[]{6, "Slartibardfast", "Italy"},
634         });
635         refresh();
636         execute("select country from foo group by country having country = 'Austria'");
637         assertThat(response.rowCount(), is(1L));
638         assertThat((String) response.rows()[0][0], is("Austria"));
639         execute("select count(*), country from foo group by country having country = 'Austria'");
640         assertThat(response.rowCount(), is(1L));
641         assertThat((Long) response.rows()[0][0], is(3L));
642         assertThat((String) response.rows()[0][1], is("Austria"));
643         execute("select country, min(id) from foo group by country having min(id) &lt; 5 ");
644         assertThat(response.rowCount(), is(2L));
645     }
646     @Test
647     public void testGroupByHavingInsertInto() throws Exception {
648         execute("create table foo (id int, name string, country string) with (number_of_replicas = 0)");
649         execute("create table bar (country string) clustered by (country) with (number_of_replicas = 0)");
650         ensureYellow();
651         execute("insert into foo (id, name, country) values (?, ?, ?)", new Object[][]{
652             new Object[]{1, "Arthur", "Austria"},
653             new Object[]{2, "Trillian", "Austria"},
654             new Object[]{3, "Marvin", "Austria"},
655             new Object[]{4, "Jeltz", "German"},
656             new Object[]{5, "Ford", "German"},
657             new Object[]{6, "Slartibardfast", "Italy"},
658         });
659         refresh();
660         execute("insert into bar(country)(select country from foo group by country having country = 'Austria')");
661         refresh();
662         execute("select country from bar");
663         assertThat(response.rowCount(), is(1L));
664     }
665     @Test
666     public void testGroupByHavingWithAggregate() throws Exception {
667         this.setup.groupBySetup("integer");
668         execute("select gender from characters group by gender having min(age) &lt; 33");
669         assertEquals(1L, response.rowCount());
670     }
671     @Test
672     public void testGroupByOnClusteredByColumn() throws Exception {
673         execute("create table foo (id int, name string, country string) clustered by (country) with (number_of_replicas = 0)");
674         ensureYellow();
675         execute("insert into foo (id, name, country) values (?, ?, ?)", new Object[][]{
676             new Object[]{1, "Arthur", "Austria"},
677             new Object[]{2, "Trillian", "Austria"},
678             new Object[]{3, "Marvin", "Austria"},
679             new Object[]{4, "Jeltz", "Germany"},
680             new Object[]{5, "Ford", "Germany"},
681             new Object[]{6, "Slartibardfast", "Italy"},
682         });
683         refresh();
684         execute("select count(*), country from foo group by country order by count(*) desc");
685         assertThat(response.rowCount(), Is.is(3L));
686         assertThat((String) response.rows()[0][1], Is.is("Austria"));
687         assertThat((String) response.rows()[1][1], Is.is("Germany"));
688         assertThat((String) response.rows()[2][1], Is.is("Italy"));
689     }
690     @Test
691     public void testGroupByOnAllPrimaryKeys() throws Exception {
692         execute("create table foo (id int primary key, name string primary key) with (number_of_replicas = 0)");
693         ensureYellow();
694         execute("insert into foo (id, name) values (?, ?)", new Object[][]{
695             new Object[]{1, "Arthur"},
696             new Object[]{2, "Trillian"},
697             new Object[]{3, "Slartibardfast"},
698             new Object[]{4, "Marvin"},
699         });
700         refresh();
701         execute("select count(*), name from foo group by id, name order by name desc");
702         assertThat(printedTable(response.rows()), is(
703             "1| Trillian\n" +
704             "1| Slartibardfast\n" +
705             "1| Marvin\n" +
706             "1| Arthur\n"));
707     }
708     @Test
709     public void testGroupByEmpty() throws Exception {
710         execute("create table test (col1 string)");
711         ensureYellow();
712         execute("select count(*), col1 from test group by col1");
713         assertEquals(0, response.rowCount());
714     }
715     @Test
716     public void testGroupByOnSysNodes() throws Exception {
717         execute("select count(*), name from sys.nodes group by name");
718         assertThat(response.rowCount(), Is.is(2L));
719         execute("select count(*), hostname from sys.nodes group by hostname");
720         assertThat(response.rowCount(), Is.is(1L));
721     }
722     @Test
723     public void testGroupByCountStringGroupByPrimaryKey() throws Exception {
724         execute("create table rankings (" +
725                 " \"pageURL\" string primary key," +
726                 " \"pageRank\" int," +
727                 " \"avgDuration\" int" +
728                 ") with (number_of_replicas=0)");
729         ensureYellow();
730         for (int i = 0; i &lt; 100; i++) {
731             execute("insert into rankings (\"pageURL\", \"pageRank\", \"avgDuration\") values (?, ?, ?)",
732                 new Object[]{String.valueOf(i), randomIntBetween(i, i * i), randomInt(i)});
733             assertThat(response.rowCount(), is(1L));
734         }
735         execute("refresh table rankings");
736         execute("select count(*), \"pageURL\" from rankings group by \"pageURL\" order by 1 desc limit 100");
737         assertThat(response.rowCount(), is(100L));
738         assertThat(new ArrayBucket(response.rows()), TestingHelpers.hasSortedRows(0, true, null));
739     }
740     @Test
741     public void testGroupByCountString() throws Exception {
742         execute("create table rankings (" +
743                 " \"pageURL\" string," +
744                 " \"pageRank\" int," +
745                 " \"avgDuration\" int" +
746                 ") with (number_of_replicas=0)");
747         ensureYellow();
748         for (int i = 0; i &lt; 100; i++) {
749             execute("insert into rankings (\"pageURL\", \"pageRank\", \"avgDuration\") values (?, ?, ?)",
750                 new Object[]{randomAsciiLettersOfLength(10 + (i % 3)), randomIntBetween(i, i * i), randomInt(i)});
751         }
752         execute("refresh table rankings");
753         execute("select count(*), \"pageURL\" from rankings group by \"pageURL\" order by 1 desc limit 100");
754         assertThat(response.rowCount(), is(100L));
755     }
756     @Test
757     public void testAggregateTwiceOnRoutingColumn() throws Exception {
758         execute("create table twice (" +
759                 "name string, " +
760                 "url string, " +
761                 "score double" +
762                 ") clustered by (url) with (number_of_replicas=0)");
763         ensureYellow();
764         execute("insert into twice (\"name\", \"url\", \"score\") values (?, ?, ?)",
765             new Object[]{
766                 "A",
767                 "https://Ä.com",
768                 99.6d});
769         refresh();
770         execute("select avg(score), url, avg(score) from twice group by url limit 10");
771         assertThat(printedTable(response.rows()), is("99.6| https://Ä.com| 99.6\n"));
772     }
773     @Test
774     public void testGroupByWithHavingAndLimit() throws Exception {
775         execute("create table likes (" +
776                 "   event_id string," +
777                 "   item_id string" +
778                 ") clustered into 2 shards with (number_of_replicas = 0)");
779         ensureYellow();
780         execute("insert into likes (event_id, item_id) values (?, ?)", new Object[][]{
781             new Object[]{"event1", "item1"},
782             new Object[]{"event1", "item1"},
783             new Object[]{"event1", "item2"},
784             new Object[]{"event2", "item1"},
785             new Object[]{"event2", "item2"},
786         });
787         execute("refresh table likes");
788         try {
789             execute("select count(*), item_id from likes where event_id = 'event1' group by 2 having count(*) &gt; 1");
790             assertThat(response.rowCount(), is(1L));
791         } catch (Exception e) {
792             fail(e.getMessage());
793         }
794         try {
795             execute("select count(*), item_id from likes where event_id = 'event1' group by 2 having count(*) &gt; 1 limit 100");
796             assertThat(response.rowCount(), is(1L));
797         } catch (Exception e) {
798             fail(e.getMessage());
799         }
800         try {
801             execute("select item_id, count(*) from likes where event_id = 'event1' group by 1 having count(*) &gt; 1");
802             assertThat(response.rowCount(), is(1L));
803         } catch (Exception e) {
804             fail(e.getMessage());
805         }
806         try {
807             execute("select item_id, count(*) from likes where event_id = 'event1' group by 1 having count(*) &gt; 1 limit 100");
808             assertThat(response.rowCount(), is(1L));
809         } catch (Exception e) {
810             fail(e.getMessage());
811         }
812     }
813     @Test
814     public void testNonDistributedGroupByWithHavingAndLimit() throws Exception {
815         execute("create table likes (" +
816                 "   event_id string," +
817                 "   item_id string" +
818                 ") clustered into 1 shards with (number_of_replicas = 0)");
819         ensureYellow();
820         execute("insert into likes (event_id, item_id) values (?, ?)", new Object[][]{
821             new Object[]{"event1", "item1"},
822             new Object[]{"event1", "item1"},
823             new Object[]{"event1", "item2"},
824             new Object[]{"event2", "item1"},
825             new Object[]{"event2", "item2"},
826         });
827         execute("refresh table likes");
828         try {
829             execute("select count(*), item_id from likes where event_id = 'event1' group by 2 having count(*) &gt; 1");
830             assertThat(response.rowCount(), is(1L));
831         } catch (Exception e) {
832             fail(e.getMessage());
833         }
834         try {
835             execute("select count(*), item_id from likes where event_id = 'event1' group by 2 having count(*) &gt; 1 limit 100");
836             assertThat(response.rowCount(), is(1L));
837         } catch (Exception e) {
838             fail(e.getMessage());
839         }
840         try {
841             execute("select item_id, count(*) from likes where event_id = 'event1' group by 1 having count(*) &gt; 1");
842             assertThat(response.rowCount(), is(1L));
843         } catch (Exception e) {
844             fail(e.getMessage());
845         }
846         try {
847             execute("select item_id, count(*) from likes where event_id = 'event1' group by 1 having count(*) &gt; 1 limit 100");
848             assertThat(response.rowCount(), is(1L));
849         } catch (Exception e) {
850             fail(e.getMessage());
851         }
852         try {
853             execute("select count(*), item_id from likes group by item_id having min(event_id) = 'event1'");
854             assertThat(response.rowCount(), is(2L));
855         } catch (Exception e) {
856             fail(e.getMessage());
857         }
858     }
859     @Test
860     public void groupByAggregateStdDevByte() throws Exception {
861         this.setup.groupBySetup("byte");
862         execute("select stddev(age), gender from characters group by gender order by gender");
863         assertEquals(2L, response.rowCount());
864         assertEquals(5.5d, response.rows()[0][0]);
865         assertEquals(39.0d, response.rows()[1][0]);
866     }
867     @Test
868     public void groupByAggregateVarianceByte() throws Exception {
869         this.setup.groupBySetup("byte");
870         execute("select variance(age), gender from characters group by gender order by gender");
871         assertEquals(2L, response.rowCount());
872         assertEquals(30.25d, response.rows()[0][0]);
873         assertEquals(1521.0d, response.rows()[1][0]);
874     }
875     @Test
876     public void groupByAggregateStdDevDouble() throws Exception {
877         this.setup.groupBySetup("double");
878         execute("select stddev(age), gender from characters group by gender order by gender");
879         assertEquals(2L, response.rowCount());
880         assertEquals(5.5d, response.rows()[0][0]);
881         assertEquals(39.0d, response.rows()[1][0]);
882     }
883     @Test
884     public void groupByStatsAggregatesGlobal() throws Exception {
885         this.setup.groupBySetup("short");
886         execute("select min(age), mean(age), geometric_mean(age), max(age), variance(age), stddev(age) from characters");
887         assertThat((Short) response.rows()[0][0], is((short) 32));
888         assertThat((Double) response.rows()[0][1], is(55.25d));
889         assertThat((Double) response.rows()[0][2], closeTo(47.84415001097868d, 0.0000001));
890         assertThat((Short) response.rows()[0][3], is((short) 112));
891         assertThat((Double) response.rows()[0][4], is(1090.6875d));
892         assertThat((Double) response.rows()[0][5], is(33.025558284456d));
893     }
894     @Test
895     public void testGroupByOnClusteredByColumnPartitioned() throws Exception {
896         execute("CREATE TABLE tickets ( " +
897                 "  ticket_id long, " +
898                 "  tenant_id integer, " +
899                 "  created_month string )" +
900                 "PARTITIONED BY (created_month) " +
901                 "CLUSTERED BY (tenant_id) " +
902                 "WITH (number_of_replicas=0)");
903         ensureYellow();
904         execute("insert into tickets (ticket_id, tenant_id, created_month) values (?, ?, ?)",
905             new Object[][]{
906                 {1L, 42, 1425168000000L},
907                 {2L, 43, 0},
908                 {3L, 44, 1425168000000L},
909                 {4L, 45, 499651200000L},
910                 {5L, 42, 0L},
911             });
912         ensureYellow();
913         refresh();
914         execute("select count(*), tenant_id from tickets group by 2 order by tenant_id limit 100");
915         assertThat(printedTable(response.rows()), is(
916             "2| 42\n" +             "1| 43\n" +
917             "1| 44\n" +
918             "1| 45\n"));
919     }
920     @Test
921     public void testFilterByScore() throws Exception {
922         execute("create table locations (" +
923                 " altitude int," +
924                 " name string," +
925                 " description string index using fulltext" +
926                 ") clustered into 1 shards with (number_of_replicas = 0)");         ensureYellow();
927         execute("insert into locations (altitude, name, description) values (420, 'Crate Dornbirn', 'A nice place in a nice country')");
928         execute("insert into locations (altitude, name, description) values (230, 'Crate Berlin', 'Also very nice place mostly nice in summer')");
929         execute("insert into locations (altitude, name, description) values (70, 'Crate SF', 'A nice place with lot of sunshine')");
930         execute("refresh table locations");
931         execute("select min(altitude) as altitude, name, _score from locations where match(description, 'nice') " +
932                 "and _score &gt;= 1.08 group by name, _score order by name");
933         assertEquals(2L, response.rowCount());
934     }
935     @Test
936     public void testDistinctWithGroupBy() throws Exception {
937         execute("select DISTINCT max(col1), min(col1) from unnest([1,1,1,2,2,2,2,3,3],[1,2,3,1,2,3,4,1,2]) " +
938                 "group by col2 order by 2, 1");
939         assertThat(printedTable(response.rows()), is("2| 1\n" +
940                                                      "3| 1\n" +
941                                                      "2| 2\n"));
942     }
943     @Test
944     public void testDistinctWithGroupByLimitAndOffset() throws Exception {
945         execute("select DISTINCT max(col2), min(col2) from " +
946                 "unnest([1,1,2,2,3,3,4,4,5,5,6,6],[1,2,2,1,2,1,3,4,4,3,5,6]) " +
947                 "group by col1 order by 1 desc, 2 limit 2 offset 1");
948         assertThat(printedTable(response.rows()), is("4| 3\n" +
949                                                      "2| 1\n"));
950     }
951     @Test
952     public void testDistinctOnJoinWithGroupBy() throws Exception {
953         execute("select DISTINCT max(t1.col1), min(t2.col2) from " +
954                 "unnest([1,1,1,2,2,2,2,3,3],[1,2,3,1,2,3,4,1,2]) as t1, " +
955                 "unnest([1,1,1,2,2,2,2,3,3],[1,2,3,1,2,3,4,1,2]) as t2 " +
956                 "where t1.col1=t2.col2 " +
957                 "group by t1.col2 order by 2, 1");
958         assertThat(printedTable(response.rows()), is("2| 1\n" +
959                                                      "3| 1\n" +
960                                                      "2| 2\n"));
961     }
962     @Test
963     public void testDistinctOnSubselectWithGroupBy() throws Exception {
964         execute("select * from (" +
965                 " select distinct max(col1), min(col1) from unnest([1,1,1,2,2,2,2,3,3],[1,2,3,1,2,3,4,1,2]) " +
966                 " group by col2 order by 2, 1 limit 2" +
967                 ") t order by 1 desc limit 1");
968         assertThat(printedTable(response.rows()), is("3| 1\n"));
969     }
970     @Test
971     public void testGroupByOnScalarOnArray() throws Exception {
972         execute("select string_to_array(col1, ' ')[2], count(*) " +
973                 "from unnest([' select foo', 'insert into ', 'select 1']) " +
974                 "group by 1 order by 2 desc");
975         assertThat(printedTable(response.rows()), is("into| 1\n" +
976                                                      "1| 1\n" +
977                                                      "select| 1\n"));
978     }
979     @Test
980     public void testGroupByOnComplexLiterals() throws Exception {
981         execute("select '{coordinates=[[0.0, 0.0], [1.0, 1.0]], type=LineString}', count(*) " +
982                 "from employees group by 1");
983         assertThat(printedTable(response.rows()), is("{coordinates=[[0.0, 0.0], [1.0, 1.0]], type=LineString}| 6\n"));
984         execute("select {id1=1, id2=36}, count(*) " +
985                 "from employees group by 1");
986         assertThat(printedTable(response.rows()), is("{id1=1, id2=36}| 6\n"));
987     }
988     @Test
989     public void testGroupByOnIndexOff() throws Exception {
990         execute("create table t1 (i int index off, s string index off)");
991         execute("insert into t1 (i, s) values (?,?)",
992             new Object[][]{
993                 {1, "foo"},
994                 {2, "bar"},
995                 {1, "foo"}
996         });
997         refresh();
998         execute("select count(*), i, s from t1 group by i, s order by 1");
999         assertThat(printedTable(response.rows()), is("1| 2| bar\n" +
1000                                                      "2| 1| foo\n"));
1001     }
1002     @Test
1003     public void testAggregateOnIndexOff() throws Exception {
1004         execute("create table t1 (i int index off, s string index off)");
1005         execute("insert into t1 (i, s) values (?,?)",
1006             new Object[][]{
1007                 {1, "foo"},
1008                 {2, "foobar"},
1009                 {1, "foo"}
1010         });
1011         refresh();
1012         execute("select sum(i), max(s) from t1");
1013         assertThat(printedTable(response.rows()), is("4| foobar\n"));
1014     }
1015     @Test
1016     public void testGroupBySingleNumberWithNullValues() {
1017         execute("create table t (along long, aint int, ashort short) clustered into 2 shards with (number_of_replicas = 0)");
1018         execute("insert into t (along,aint,ashort) values (1,1,1), (1,1,1), (1,1,1), (2,2,2), (2,2,2), (null,null,null), " +
1019                 "(null,null,null), (null,null,null), (null,null,null)");
1020         execute("refresh table t");
1021         assertThat(
1022             printedTable(execute("select along, count(*) from t group by along order by 2 desc").rows()),
1023             is("NULL| 4\n" +
1024                "1| 3\n" +
1025                "2| 2\n")
1026         );
1027         assertThat(
1028             printedTable(execute("select aint, count(*) from t group by aint order by 2 desc").rows()),
1029             is("NULL| 4\n" +
1030                "1| 3\n" +
1031                "2| 2\n")
1032         );
1033         assertThat(
1034             printedTable(execute("select ashort, count(*) from t group by ashort order by 2 desc").rows()),
1035             is("NULL| 4\n" +
1036                "1| 3\n" +
1037                "2| 2\n")
1038         );
1039     }
1040     @Test
1041     public void testSelectAndGroupBySingleStringKeyForLowCardinalityField() {
1042         execute("create table t (name string) clustered into 1 shards");
1043         execute("insert into t (name) values ('a'), ('b'), ('a'), ('b')");
1044         execute("refresh table t");
1045         execute("select name, count(name) from t group by 1 order by 1");
1046         assertThat(printedTable(response.rows()), is(
1047             "a| 2\n" +
1048             "b| 2\n"));
1049     }
1050     @Test
1051     public void testSelectCollectSetAndGroupBy() {
1052         execute("SELECT\n" +
1053                 "col1,\n" +
1054                 "collect_set(col1)\n" +
1055                 "FROM unnest(ARRAY[1, 2, 2, 3, 4, 5, null]) col1 " +
1056                 "GROUP BY col1 " +
1057                 "ORDER BY col1 NULLS LAST");
1058         assertThat(
1059             printedTable(response.rows()),
1060             Matchers.is("1| [1]\n" +
1061                         "2| [2]\n" +
1062                         "3| [3]\n" +
1063                         "4| [4]\n" +
1064                         "5| [5]\n" +
1065                         "NULL| []\n")
1066         );
1067     }
1068     @Test
1069     public void test_optimized_topn_distinct_returns_2_unique_items() throws Throwable {
1070         execute("create table m.tbl (id int primary key)");
1071         Object[][] ids = new Object[100][];
1072         for (int i = 0; i &lt; ids.length; i++) {
1073             ids[i] = new Object[] { i };
1074         }
1075         execute("insert into m.tbl (id) values (?)", ids);
1076         execute("refresh table m.tbl");
1077         execute("analyze");
1078         execute("explain select distinct id from m.tbl limit 2");
1079         assertThat(
1080             printedTable(response.rows()),
1081             is("TopNDistinct[2::bigint;0 | [id]]\n" +
1082                "  └ Collect[m.tbl | [id] | true]\n")
1083         );
1084         execute("select distinct id from m.tbl limit 2");
1085         assertThat(response.rowCount(), is(2L));
1086         Object firstId = response.rows()[0][0];
1087         Object secondId = response.rows()[1][0];
1088         assertThat(firstId, not(is(secondId)));
1089     }
1090     @Test
1091     public void test_select_distinct_with_limit_and_offset_applies_limit_and_offset_on_distinct_resultset() throws Exception {
1092         execute("create table tbl (x int)");
1093         execute("insert into tbl (x) values (1), (1), (2), (3)");
1094         execute("refresh table tbl");
1095         execute("select distinct x from tbl limit 1 offset 3");
1096         assertThat(response.rowCount(), is(0L));
1097     }
1098     @Test
1099     public void test_group_by_on_subscript_on_object_of_sub_relation() {
1100         execute("create table tbl (obj object as (x int))");
1101         execute("insert into tbl (obj) values ({x=10})");
1102         execute("refresh table tbl");
1103         execute("select obj['x'] from (select obj from tbl) as t group by obj['x']");
1104         assertThat(printedTable(response.rows()), Is.is("10\n"));
1105     }
1106     @Test
1107     public void test_select_same_aggregate_multiple_times() throws Exception {
1108         execute("create table doc.tbl (name text, x int)");
1109         execute("insert into doc.tbl (name, x) values ('Apple', 1), ('Apple', 2), ('Apple', 3)");
1110         execute("refresh table doc.tbl");
1111         execute("explain select name, count(x), count(x) from doc.tbl group by name");
1112         assertThat(
1113             printedTable(response.rows()),
1114             Is.is(
1115                 "Eval[name, count(x), count(x)]\n" +
1116                 "  └ GroupHashAggregate[name | count(x)]\n"+
1117                 "    └ Collect[doc.tbl | [x, name] | true]\n"
1118             )
1119         );
1120         execute("select name, count(x), count(x) from doc.tbl group by name");
1121         assertThat(printedTable(response.rows()), Is.is("Apple| 3| 3\n"));
1122     }
1123     @Test
1124     @UseJdbc(1)
1125     public void test_group_by_on_duplicate_keys() throws Exception {
1126         execute("create table tbl (city text, name text, id text, location geo_point)");
1127         execute(
1128             "insert into tbl (id, name, location, city) values " +
1129             " ('122021430M', 'Rue Penavayre', [2.573609,44.35007], 'Rodez'), " +
1130             " ('013440476U', 'Avenue de Trévoux ', [5.201722,46.20096], 'Saint-Denis-lès-Bourg'), " +
1131             " ('021140050C', 'Rue Paul Doumer ', [3.426928,49.04915], 'Brasles') ");
1132         execute("refresh table tbl");
1133         execute("SELECT DISTINCT id, name, id, location, city FROM tbl");
1134         Arrays.sort(response.rows(), (a, b) -&gt; ((String) a[0]).compareTo((String) b[0]));
1135         assertThat(printedTable(response.rows()), is(
1136             "013440476U| Avenue de Trévoux | 013440476U| Pt(x=5.20172193646431,y=46.200959966517985)| Saint-Denis-lès-Bourg\n" +
1137             "021140050C| Rue Paul Doumer | 021140050C| Pt(x=3.426927952095866,y=49.04914998449385)| Brasles\n" +
1138             "122021430M| Rue Penavayre| 122021430M| Pt(x=2.573608970269561,y=44.35006999410689)| Rodez\n"
1139         ));
1140     }
1141 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
