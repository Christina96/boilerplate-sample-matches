<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for RecoverySourcePruneMergePolicyTests.java &amp; SysShardsTest.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for RecoverySourcePruneMergePolicyTests.java &amp; SysShardsTest.java
      </h3>
<h1 align="center">
        18.7%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>RecoverySourcePruneMergePolicyTests.java (25.825827%)<th>SysShardsTest.java (14.7512865%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(20-52)<td><a href="#" name="0">(22-55)</a><td align="center"><font color="#ff0000">31</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(192-196)<td><a href="#" name="1">(225-229)</a><td align="center"><font color="#730000">14</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(151-154)<td><a href="#" name="2">(97-103)</a><td align="center"><font color="#5a0000">11</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(79-83)<td><a href="#" name="3">(172-198)</a><td align="center"><font color="#5a0000">11</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(146-149)<td><a href="#" name="4">(361-372)</a><td align="center"><font color="#520000">10</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(188-190)<td><a href="#" name="5">(412-414)</a><td align="center"><font color="#4a0000">9</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>RecoverySourcePruneMergePolicyTests.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Licensed to Elasticsearch under one or more contributor
3  * license agreements. See the NOTICE file distributed with
4  * this work for additional information regarding copyright
5  * ownership. Elasticsearch licenses this file to you under
6  * the Apache License, Version 2.0 (the "License"); you may
7  * not use this file except in compliance with the License.
8  * You may obtain a copy of the License at
9  *
10  *    http://www.apache.org/licenses/LICENSE-2.0
11  *
12  * Unless required by applicable law or agreed to in writing,
13  * software distributed under the License is distributed on an
14  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
15  * KIND, either express or implied.  See the License for the
16  * specific language governing permissions and limitations
17 <a name="0"></a> * under the License.
18  */
19 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>package org.elasticsearch.index.engine;
20 import org.apache.lucene.document.Document;
21 import org.apache.lucene.document.Field;
22 import org.apache.lucene.document.NumericDocValuesField;
23 import org.apache.lucene.document.StoredField;
24 import org.apache.lucene.document.StringField;
25 import org.apache.lucene.index.CodecReader;
26 import org.apache.lucene.index.DirectoryReader;
27 import org.apache.lucene.index.IndexWriter;
28 import org.apache.lucene.index.IndexWriterConfig;
29 import org.apache.lucene.index.IndexableField;
30 import org.apache.lucene.index.LeafReader;
31 import org.apache.lucene.index.MergePolicy;
32 import org.apache.lucene.index.NumericDocValues;
33 import org.apache.lucene.index.SegmentCommitInfo;
34 import org.apache.lucene.index.SegmentInfos;
35 import org.apache.lucene.index.ShuffleForcedMergePolicy;
36 import org.apache.lucene.index.StandardDirectoryReader;
37 import org.apache.lucene.index.Term;
38 import org.apache.lucene.search.DocIdSetIterator;
39 import org.apache.lucene.search.MatchAllDocsQuery;
40 import org.apache.lucene.search.MatchNoDocsQuery;
41 import org.apache.lucene.search.TermQuery;
42 import org.apache.lucene.store.Directory;
43 import org.apache.lucene.util.InfoStream;
44 import org.apache.lucene.util.NullInfoStream;
45 import org.elasticsearch.test.ESTestCase;
46 import java.io.IOException;
47 import java.util.Collections;
48 import java.util.Set;
49 import</b></font> java.util.stream.Collectors;
50 public class RecoverySourcePruneMergePolicyTests extends ESTestCase {
51     public void testPruneAll() throws IOException {
52         try (Directory dir = newDirectory()) {
53             IndexWriterConfig iwc = newIndexWriterConfig();
54             RecoverySourcePruneMergePolicy mp = new RecoverySourcePruneMergePolicy(
55                 "extra_source",
56                 MatchNoDocsQuery::new,
57                 newLogMergePolicy()
58             );
59             iwc.setMergePolicy(new ShuffleForcedMergePolicy(mp));
60             try (IndexWriter writer = new IndexWriter(dir, iwc)) {
61                 for (int i = 0; i &lt; 20; i++) {
62                     if (i &gt; 0 &amp;&amp; randomBoolean()) {
63                         writer.flush();
64                     }
65                     Document doc = new Document();
66                     doc.add(new StoredField("source", "hello world"));
67                     doc.add(new StoredField("extra_source", "hello world"));
68                     doc.add(new NumericDocValuesField("extra_source", 1));
69                     writer.addDocument(doc);
70                 }
71 <a name="3"></a>                writer.forceMerge(1);
72                 writer.commit();
73                 try (DirectoryReader reader = DirectoryReader.open(writer)) {
74                     for (int i = 0; i &lt; reader.maxDoc(); i++) <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>{
75                         Document document = reader.document(i);
76                         assertEquals(1, document.getFields().size());
77                         assertEquals("source", document.getFields().get(0).name());
78                     }</b></font>
79                     assertEquals(1, reader.leaves().size());
80                     LeafReader leafReader = reader.leaves().get(0).reader();
81                     NumericDocValues extra_source = leafReader.getNumericDocValues("extra_source");
82                     if (extra_source != null) {
83                         assertEquals(DocIdSetIterator.NO_MORE_DOCS, extra_source.nextDoc());
84                     }
85                     if (leafReader instanceof CodecReader &amp;&amp; reader instanceof StandardDirectoryReader) {
86                         CodecReader codecReader = (CodecReader) leafReader;
87                         StandardDirectoryReader sdr = (StandardDirectoryReader) reader;
88                         SegmentInfos segmentInfos = sdr.getSegmentInfos();
89                         MergePolicy.MergeSpecification forcedMerges = mp.findForcedDeletesMerges(
90                             segmentInfos,
91                             new MergePolicy.MergeContext() {
92                                 @Override
93                                 public int numDeletesToMerge(SegmentCommitInfo info) {
94                                     return info.info.maxDoc() - 1;
95                                 }
96                                 @Override
97                                 public int numDeletedDocs(SegmentCommitInfo info) {
98                                     return info.info.maxDoc() - 1;
99                                 }
100                                 @Override
101                                 public InfoStream getInfoStream() {
102                                     return new NullInfoStream();
103                                 }
104                                 @Override
105                                 public Set&lt;SegmentCommitInfo&gt; getMergingSegments() {
106                                     return Collections.emptySet();
107                                 }
108                             });
109                         assertSame(codecReader, forcedMerges.merges.get(0).wrapForMerge(codecReader));
110                     }
111                 }
112             }
113         }
114     }
115     public void testPruneSome() throws IOException {
116         try (Directory dir = newDirectory()) {
117             IndexWriterConfig iwc = newIndexWriterConfig();
118             iwc.setMergePolicy(new RecoverySourcePruneMergePolicy("extra_source",
119                                                                   () -&gt; new TermQuery(new Term("even", "true")),
120                                                                   iwc.getMergePolicy()));
121             try (IndexWriter writer = new IndexWriter(dir, iwc)) {
122                 for (int i = 0; i &lt; 20; i++) {
123                     if (i &gt; 0 &amp;&amp; randomBoolean()) {
124                         writer.flush();
125                     }
126                     Document doc = new Document();
127                     doc.add(new StringField("even", Boolean.toString(i % 2 == 0), Field.Store.YES));
128                     doc.add(new StoredField("source", "hello world"));
129                     doc.add(new StoredField("extra_source", "hello world"));
130                     doc.add(new NumericDocValuesField("extra_source", 1));
131                     writer.addDocument(doc);
132 <a name="4"></a>                }
133                 writer.forceMerge(1);
134                 writer.commit();
135                 try (DirectoryReader reader = DirectoryReader.open(writer)) <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>{
136                     assertEquals(1, reader.leaves().size());
137 <a name="2"></a>                    NumericDocValues extra_source = reader.leaves().get(0).reader().getNumericDocValues("extra_source");
138                     assertNotNull</b></font>(extra_source);
139                     for (int i = 0; i &lt; reader.maxDoc(); i++) {
140                         Document document = <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>reader.document(i);
141                         Set&lt;String&gt; collect = document.getFields().stream().map(IndexableField::name).collect(Collectors.toSet());
142                         assertTrue(collect.contains("source"));
143                         assertTrue(collect.contains</b></font>("even"));
144                         if (collect.size() == 3) {
145                             assertTrue(collect.contains("extra_source"));
146                             assertEquals("true", document.getField("even").stringValue());
147                             assertEquals(i, extra_source.nextDoc());
148                         } else {
149                             assertEquals(2, document.getFields().size());
150                         }
151                     }
152                     assertEquals(DocIdSetIterator.NO_MORE_DOCS, extra_source.nextDoc());
153                 }
154             }
155         }
156     }
157     public void testPruneNone() throws IOException {
158         try (Directory dir = newDirectory()) {
159             IndexWriterConfig iwc = newIndexWriterConfig();
160             iwc.setMergePolicy(new RecoverySourcePruneMergePolicy("extra_source",
161                                                                   () -&gt; new MatchAllDocsQuery(), iwc.getMergePolicy()));
162             try (IndexWriter writer = new IndexWriter(dir, iwc)) {
163                 for (int i = 0; i &lt; 20; i++) {
164                     if (i &gt; 0 &amp;&amp; randomBoolean()) {
165                         writer.flush();
166                     }
167                     Document doc = new Document();
168                     doc.add(new StoredField("source", "hello world"));
169                     doc.add(new StoredField("extra_source", "hello world"));
170                     doc.add(new NumericDocValuesField("extra_source", 1));
171                     writer.addDocument(doc);
172                 }
173 <a name="5"></a>                writer.forceMerge(1);
174                 writer.commit();
175                 try (DirectoryReader reader = DirectoryReader.open(writer)) {
176                     <font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertEquals(1, reader.leaves().size());
177 <a name="1"></a>                    NumericDocValues extra_source = reader.leaves().get(0).reader().getNumericDocValues("extra_source");
178                     assertNotNull</b></font>(extra_source);
179                     for (int i = 0; i &lt; reader.maxDoc(); i++) {
180                         <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Document document = reader.document(i);
181                         Set&lt;String&gt; collect = document.getFields().stream().map(IndexableField::name).collect(Collectors.toSet());
182                         assertTrue(collect.contains("source"));
183                         assertTrue(collect.contains("extra_source"));
184                         assertEquals(i, extra_source.nextDoc</b></font>());
185                     }
186                     assertEquals(DocIdSetIterator.NO_MORE_DOCS, extra_source.nextDoc());
187                 }
188             }
189         }
190     }
191 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>SysShardsTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Licensed to Crate.io GmbH ("Crate") under one or more contributor
3  * license agreements.  See the NOTICE file distributed with this work for
4  * additional information regarding copyright ownership.  Crate licenses
5  * this file to you under the Apache License, Version 2.0 (the "License");
6  * you may not use this file except in compliance with the License.  You may
7  * obtain a copy of the License at
8  *
9  *   http://www.apache.org/licenses/LICENSE-2.0
10  *
11  * Unless required by applicable law or agreed to in writing, software
12  * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
13  * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
14  * License for the specific language governing permissions and limitations
15  * under the License.
16  *
17  * However, if you have executed another commercial license agreement
18  * with Crate these terms will supersede the license and you may use the
19 <a name="0"></a> * software solely pursuant to the terms of the relevant commercial agreement.
20  */
21 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>package io.crate.integrationtests;
22 import io.crate.exceptions.OperationOnInaccessibleRelationException;
23 import io.crate.metadata.PartitionName;
24 import io.crate.testing.SQLResponse;
25 import io.crate.testing.TestingHelpers;
26 import io.crate.testing.UseJdbc;
27 import org.apache.lucene.util.Version;
28 import org.elasticsearch.cluster.metadata.IndexMetadata;
29 import org.elasticsearch.cluster.metadata.Metadata;
30 import org.elasticsearch.cluster.service.ClusterService;
31 import org.elasticsearch.test.ESIntegTestCase;
32 import org.junit.Before;
33 import org.junit.Test;
34 import java.nio.file.Path;
35 import java.util.Arrays;
36 import java.util.List;
37 import java.util.Map;
38 import java.util.concurrent.TimeUnit;
39 import static io.crate.protocols.postgres.PGErrorStatus.INTERNAL_ERROR;
40 import static io.crate.protocols.postgres.PGErrorStatus.UNDEFINED_COLUMN;
41 import static io.crate.protocols.postgres.PGErrorStatus.UNDEFINED_TABLE;
42 import static io.crate.testing.Asserts.assertThrowsMatches;
43 import static io.crate.testing.SQLErrorMatcher.isSQLError;
44 import static io.crate.testing.TestingHelpers.resolveCanonicalString;
45 import static io.netty.handler.codec.http.HttpResponseStatus.BAD_REQUEST;
46 import static io.netty.handler.codec.http.HttpResponseStatus.NOT_FOUND;
47 import static org.hamcrest.Matchers.arrayContaining;
48 import static org.hamcrest.Matchers.containsString;
49 import static org.hamcrest.Matchers.endsWith;
50 import static org.hamcrest.Matchers.equalTo;
51 import</b></font> static org.hamcrest.Matchers.greaterThan;
52 import static org.hamcrest.Matchers.greaterThanOrEqualTo;
53 import static org.hamcrest.Matchers.instanceOf;
54 import static org.hamcrest.Matchers.is;
55 import static org.hamcrest.Matchers.not;
56 import static org.hamcrest.Matchers.nullValue;
57 @ESIntegTestCase.ClusterScope(numClientNodes = 0, numDataNodes = 2, supportsDedicatedMasters = false)
58 public class SysShardsTest extends SQLIntegrationTestCase {
59     @Before
60     public void initTestData() throws Exception {
61         Setup setup = new Setup(sqlExecutor);
62         setup.groupBySetup();
63         execute("create table quotes (id integer primary key, quote string) with (number_of_replicas=1)");
64         execute("create blob table blobs clustered into 5 shards with (number_of_replicas=1)");
65         ensureGreen();
66     }
67     @Test
68     public void testPathAndBlobPath() throws Exception {
69         Path blobs = createTempDir("blobs");
70         execute("create table t1 (x int) clustered into 1 shards with (number_of_replicas = 0)");
71         execute("create blob table b1 clustered into 1 shards with (number_of_replicas = 0)");
72         execute("create blob table b2 " +
73                 "clustered into 1 shards with (number_of_replicas = 0, blobs_path = '" + blobs.toString() + "')");
74         ensureYellow();
75         execute("select path, blob_path from sys.shards where table_name in ('t1', 'b1', 'b2') " +
76                 "order by table_name asc");
77         assertThat(response.rows()[0][0] + resolveCanonicalString("/blobs"), is(response.rows()[0][1]));
78         ClusterService clusterService = internalCluster().getInstance(ClusterService.class);
79         Metadata metadata = clusterService.state().getMetadata();
80         IndexMetadata index = metadata.index(".blob_b2");
81         String indexUUID = index.getIndexUUID();
82 <a name="2"></a>                String b2Path = (String) response.rows()[1][0];
83         assertThat(b2Path, containsString(resolveCanonicalString("/nodes/")));
84         assertThat(b2Path, endsWith(<font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>resolveCanonicalString("/indices/" + indexUUID + "/0")));
85         String b2BlobPath = (String) response.rows()[1][1];
86         assertThat(b2BlobPath, containsString(resolveCanonicalString("/nodes/")));
87         assertThat(b2BlobPath, endsWith(resolveCanonicalString("/indices/" + indexUUID + "/0/blobs")));
88         assertThat(response.rows</b></font>()[2][1], nullValue());
89     }
90     @Test
91     public void testSelectGroupByWhereTable() throws Exception {
92         SQLResponse response = execute("" +
93                                        "select count(*), num_docs from sys.shards where table_name = 'characters' " +
94                                        "group by num_docs order by count(*)");
95         assertThat(response.rowCount(), greaterThan(0L));
96     }
97     @Test
98     public void testSelectGroupByAllTables() throws Exception {
99         SQLResponse response = execute("select count(*), table_name from sys.shards " +
100                                        "group by table_name order by table_name");
101         assertEquals(3L, response.rowCount());
102         assertEquals(10L, response.rows()[0][0]);
103         assertEquals("blobs", response.rows()[0][1]);
104         assertEquals("characters", response.rows()[1][1]);
105         assertEquals("quotes", response.rows()[2][1]);
106     }
107     @Test
108     public void testGroupByWithLimitUnassignedShards() throws Exception {
109         try {
110             execute("create table t (id int, name string) with (number_of_replicas=2, \"write.wait_for_active_shards\"=1)");
111             ensureYellow();
112             SQLResponse response = execute("select sum(num_docs), table_name, sum(num_docs) from sys.shards group by table_name order by table_name desc limit 1000");
113             assertThat(response.rowCount(), is(4L));
114             assertThat(TestingHelpers.printedTable(response.rows()),
115                 is("0| t| 0\n" +
116                    "0| quotes| 0\n" +
117                    "14| characters| 14\n" +
118                    "0| blobs| 0\n"));
119         } finally {
120             execute("drop table t");
121         }
122     }
123     @Test
124     public void testSelectGroupByWhereNotLike() throws Exception {
125         SQLResponse response = execute("select count(*), table_name from sys.shards " +
126                                        "where table_name not like 'my_table%' group by table_name order by table_name");
127         assertEquals(3L, response.rowCount());
128         assertEquals(10L, response.rows()[0][0]);
129         assertEquals("blobs", response.rows()[0][1]);
130         assertEquals(8L, response.rows()[1][0]);
131         assertEquals("characters", response.rows()[1][1]);
132         assertEquals(8L, response.rows()[2][0]);
133         assertEquals("quotes", response.rows()[2][1]);
134     }
135     @Test
136     public void testSelectWhereTable() throws Exception {
137         SQLResponse response = execute(
138             "select id, size from sys.shards " +
139             "where table_name = 'characters'");
140         assertEquals(8L, response.rowCount());
141     }
142     @Test
143     public void testSelectStarWhereTable() throws Exception {
144         SQLResponse response = execute(
145             "select * from sys.shards where table_name = 'characters'");
146         assertEquals(8L, response.rowCount());
147 <a name="3"></a>    }
148     @Test
149     public void testSelectStarAllTables() throws Exception <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>{
150         SQLResponse response = execute("select * from sys.shards");
151         assertEquals(26L, response.rowCount());
152         assertEquals(21, response.cols().length);
153         assertThat(response.cols(), arrayContaining(
154             "blob_path",
155             "closed",
156             "flush_stats",
157             "id",
158             "min_lucene_version",
159             "node",
160             "num_docs",
161             "orphan_partition",
162             "partition_ident",
163             "path",
164             "primary",
165             "recovery",
166             "relocating_node",
167             "retention_leases",
168             "routing_state",
169             "schema_name",
170             "seq_no_stats",
171             "size",
172             "state",
173             "table_name",
174             "translog_stats"));
175     }</b></font>
176     @Test
177     public void testSelectStarLike() throws Exception {
178         SQLResponse response = execute(
179             "select * from sys.shards where table_name like 'charact%'");
180         assertEquals(8L, response.rowCount());
181     }
182     @Test
183     public void testSelectStarNotLike() throws Exception {
184         SQLResponse response = execute(
185             "select * from sys.shards where table_name not like 'quotes%'");
186         assertEquals(18L, response.rowCount());
187     }
188     @Test
189     public void testSelectStarIn() throws Exception {
190         SQLResponse response = execute(
191             "select * from sys.shards where table_name in ('characters')");
192         assertEquals(8L, response.rowCount());
193     }
194     @Test
195 <a name="1"></a>    public void test_translog_stats_can_be_retrieved() {
196         execute("SELECT translog_stats, translog_stats['size'] FROM sys.shards " +
197                 "WHERE id = 0 AND \"primary\" = true AND table_name = 'characters'");
198         <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>Object[] resultRow = response.rows()[0];
199         Map&lt;String, Object&gt; translogStats = (Map&lt;String, Object&gt;) resultRow[0];
200         assertThat(((Number) translogStats.get("size")).longValue(), is(resultRow[1]));
201         assertThat(((Number) translogStats.get("uncommitted_size")).longValue(), greaterThanOrEqualTo(0L));
202         assertThat(((Number) translogStats.get</b></font>("number_of_operations")).longValue(), greaterThanOrEqualTo(0L));
203         assertThat(((Number) translogStats.get("uncommitted_operations")).longValue(), greaterThanOrEqualTo(0L));
204     }
205     @Test
206     public void testSelectStarMatch() throws Exception {
207         assertThrowsMatches(() -&gt; execute("select * from sys.shards where match(table_name, 'characters')"),
208                      isSQLError(is("Cannot use MATCH on system tables"), INTERNAL_ERROR, BAD_REQUEST, 4004));
209     }
210     @Test
211     public void testSelectOrderBy() throws Exception {
212         SQLResponse response = execute("select table_name, min_lucene_version, * " +
213                                        "from sys.shards order by table_name");
214         assertEquals(26L, response.rowCount());
215         List&lt;String&gt; tableNames = Arrays.asList("blobs", "characters", "quotes");
216         for (Object[] row : response.rows()) {
217             assertThat(tableNames.contains(row[0]), is(true));
218             assertThat(row[1], is(Version.LATEST.toString()));
219         }
220     }
221     @Test
222     public void testSelectGreaterThan() throws Exception {
223         SQLResponse response = execute("select * from sys.shards where num_docs &gt; 0");
224         assertThat(response.rowCount(), greaterThan(0L));
225     }
226     @Test
227     public void testSelectWhereBoolean() throws Exception {
228         SQLResponse response = execute("select * from sys.shards where \"primary\" = false");
229         assertEquals(13L, response.rowCount());
230     }
231     @Test
232     public void testSelectGlobalAggregates() throws Exception {
233         SQLResponse response = execute(
234             "select sum(size), min(size), max(size), avg(size) from sys.shards");
235         assertEquals(1L, response.rowCount());
236         assertEquals(4, response.rows()[0].length);
237         assertNotNull(response.rows()[0][0]);
238         assertNotNull(response.rows()[0][1]);
239         assertNotNull(response.rows()[0][2]);
240         assertNotNull(response.rows()[0][3]);
241     }
242     @Test
243     public void testSelectGlobalCount() throws Exception {
244         SQLResponse response = execute("select count(*) from sys.shards");
245         assertEquals(1L, response.rowCount());
246         assertEquals(26L, response.rows()[0][0]);
247     }
248     @Test
249     public void testSelectGlobalCountAndOthers() throws Exception {
250         SQLResponse response = execute("select count(*), max(table_name) from sys.shards");
251         assertEquals(1L, response.rowCount());
252         assertEquals(26L, response.rows()[0][0]);
253         assertEquals("quotes", response.rows()[0][1]);
254     }
255     @Test
256     public void testGroupByUnknownResultColumn() throws Exception {
257         assertThrowsMatches(() -&gt; execute("select lol from sys.shards group by table_name"),
258                      isSQLError(is("Column lol unknown"), UNDEFINED_COLUMN, NOT_FOUND, 4043));
259     }
260     @Test
261     public void testGroupByUnknownGroupByColumn() throws Exception {
262         assertThrowsMatches(() -&gt; execute("select max(num_docs) from sys.shards group by lol"),
263                      isSQLError(is("Column lol unknown"), UNDEFINED_COLUMN, NOT_FOUND, 4043));
264     }
265     @Test
266     public void testGroupByUnknownOrderBy() throws Exception {
267         assertThrowsMatches(() -&gt; execute(
268             "select sum(num_docs), table_name from sys.shards group by table_name order by lol"),
269                      isSQLError(is("Column lol unknown"), UNDEFINED_COLUMN, NOT_FOUND, 4043));
270     }
271     @Test
272     public void testGroupByUnknownWhere() throws Exception {
273         assertThrowsMatches(() -&gt; execute(
274             "select sum(num_docs), table_name from sys.shards where lol='funky' group by table_name"),
275                      isSQLError(is("Column lol unknown"), UNDEFINED_COLUMN, NOT_FOUND, 4043));
276         ;
277     }
278     @Test
279     public void testGlobalAggregateUnknownWhere() throws Exception {
280         assertThrowsMatches(() -&gt; execute(
281             "select sum(num_docs) from sys.shards where lol='funky'"),
282                      isSQLError(is("Column lol unknown"), UNDEFINED_COLUMN, NOT_FOUND, 4043));
283     }
284     @Test
285     public void testSelectShardIdFromSysNodes() throws Exception {
286         assertThrowsMatches(() -&gt; execute(
287             "select sys.shards.id from sys.nodes"),
288                      isSQLError(is("Relation 'sys.shards' unknown"), UNDEFINED_TABLE, NOT_FOUND, 4041));
289     }
290     @Test
291     public void testSelectWithOrderByColumnNotInOutputs() throws Exception {
292         SQLResponse response = execute("select id from sys.shards order by table_name limit 1");
293         assertThat(response.rowCount(), is(1L));
294         assertThat(response.rows()[0][0], instanceOf(Integer.class));
295     }
296     @Test
297     public void testSelectGroupByHaving() throws Exception {
298         SQLResponse response = execute("select count(*) " +
299                                        "from sys.shards " +
300                                        "group by table_name " +
301                                        "having table_name = 'quotes'");
302         assertThat(TestingHelpers.printedTable(response.rows()), is("8\n"));
303     }
304     @Test
305     public void testSelectNodeSysExpression() throws Exception {
306         SQLResponse response = execute(
307             "select node, node['name'], id from sys.shards order by node['name'], id  limit 1");
308         assertEquals(1L, response.rowCount());
309         Map&lt;String, Object&gt; fullNode = (Map&lt;String, Object&gt;) response.rows()[0][0];
310         String nodeName = response.rows()[0][1].toString();
311         assertEquals("node_s0", nodeName);
312         assertEquals("node_s0", fullNode.get("name"));
313     }
314 <a name="4"></a>
315     @Test
316     public void testOrphanedPartitionExpression() throws Exception {
317         try <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>{
318             execute("create table c.orphan_test (id int primary key, p string primary key) " +
319                     "partitioned by (p) " +
320                     "clustered into 1 shards " +
321                     "with (number_of_replicas = 0)"
322             );
323             execute("insert into c.orphan_test (id, p) values (1, 'foo')");
324             ensureYellow();
325             SQLResponse response = execute(
326                 "select orphan_partition from sys.shards where table_name = 'orphan_test'");
327             assertThat(TestingHelpers.printedTable(response.rows()), is</b></font>("false\n"));
328             client().admin().indices()
329                 .prepareDeleteTemplate(PartitionName.templateName("c", "orphan_test"))
330                 .execute().get(1, TimeUnit.SECONDS);
331             response = execute(
332                 "select orphan_partition from sys.shards where table_name = 'orphan_test'");
333             assertThat(TestingHelpers.printedTable(response.rows()), is("true\n"));
334         } finally {
335             execute("drop table c.orphan_test");
336         }
337     }
338     @Test
339     public void testSelectNodeSysExpressionWithUnassignedShards() throws Exception {
340         try {
341             execute("create table users (id integer primary key, name string) " +
342                     "clustered into 5 shards with (number_of_replicas=2, \"write.wait_for_active_shards\"=1)");
343             ensureYellow();
344             SQLResponse response = execute(
345                 "select node['name'], id from sys.shards where table_name = 'users' order by node['name'] nulls last"
346             );
347             String nodeName = response.rows()[0][0].toString();
348             assertEquals("node_s0", nodeName);
349             assertThat(response.rows()[12][0], is(nullValue()));
350         } finally {
351             execute("drop table users");
352         }
353     }
354     @Test
355     public void testSelectRecoveryExpression() throws Exception {
356         SQLResponse response = execute("select recovery, " +
357                                        "recovery['files'], recovery['files']['used'], recovery['files']['reused'], recovery['files']['recovered'], " +
358                                        "recovery['size'], recovery['size']['used'], recovery['size']['reused'], recovery['size']['recovered'] " +
359                                        "from sys.shards");
360 <a name="5"></a>        for (Object[] row : response.rows()) {
361             Map recovery = (Map) row[0];
362             Map&lt;String, Integer&gt; files = (Map&lt;String, Integer&gt;) row[1];
363             assertThat(((Map&lt;String, Integer&gt;) <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>recovery.get("files")).entrySet(), equalTo(files.entrySet()));
364             Map&lt;String, Long&gt; size = (Map&lt;String, Long&gt;) row[5];
365             assertThat(((Map&lt;String, Long&gt;) recovery.get("size")).entrySet(), equalTo(size.entrySet</b></font>()));
366         }
367     }
368     @Test
369     public void testScalarEvaluatesInErrorOnSysShards() throws Exception {
370         execute("create table t1 (id integer) clustered into 1 shards with (number_of_replicas=0)");
371         ensureYellow();
372         assertThrowsMatches(() -&gt; execute(
373             "select 1/0 from sys.shards"),
374                      isSQLError(is("/ by zero"), INTERNAL_ERROR, BAD_REQUEST, 4000));
375     }
376     @Test
377     public void test_state_for_shards_of_closed_table() throws Exception {
378         execute("create table doc.tbl (x int) clustered into 2 shards with(number_of_replicas=0)");
379         execute("insert into doc.tbl values(1)");
380         logger.info("---&gt; Closing table doc.tbl");
381         execute("alter table doc.tbl close");
382         execute("select id, closed from sys.shards where table_name = 'tbl' order by id asc");
383         assertThat(response.rows()[0][0], is(0));
384         assertThat(response.rows()[0][1], is(true));
385         assertThat(response.rows()[1][0], is(1));
386         assertThat(response.rows()[1][1], is(true));
387     }
388     @UseJdbc(0)
389     @Test
390     public void testSelectFromClosedTableNotAllowed() throws Exception {
391         execute("create table doc.tbl (x int)");
392         execute("insert into doc.tbl values(1)");
393         execute("alter table doc.tbl close");
394         assertThrowsMatches(() -&gt; execute("select * from doc.tbl"),
395                      OperationOnInaccessibleRelationException.class,
396                      "The relation \"doc.tbl\" doesn't support or allow READ operations, as it is currently closed.");
397     }
398     @UseJdbc(0)
399     @Test
400     public void testInsertFromClosedTableNotAllowed() throws Exception {
401         execute("create table doc.tbl (x int)");
402         execute("insert into doc.tbl values(1)");
403         execute("alter table doc.tbl close");
404         assertThrowsMatches(() -&gt; execute("insert into doc.tbl values(2)"),
405                      OperationOnInaccessibleRelationException.class,
406                      "The relation \"doc.tbl\" doesn't support or allow INSERT operations, as it is currently closed.");
407     }
408 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
