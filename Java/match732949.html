<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for RecoverySourcePruneMergePolicyTests.java & SysShardsTest.java</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for RecoverySourcePruneMergePolicyTests.java & SysShardsTest.java
      </h3>
      <h1 align="center">
        18.7%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>RecoverySourcePruneMergePolicyTests.java (25.825827%)<TH>SysShardsTest.java (14.7512865%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match732949-0.html#0',2,'match732949-1.html#0',3)" NAME="0">(20-52)<TD><A HREF="javascript:ZweiFrames('match732949-0.html#0',2,'match732949-1.html#0',3)" NAME="0">(22-55)</A><TD ALIGN=center><FONT COLOR="#ff0000">31</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match732949-0.html#1',2,'match732949-1.html#1',3)" NAME="1">(192-196)<TD><A HREF="javascript:ZweiFrames('match732949-0.html#1',2,'match732949-1.html#1',3)" NAME="1">(225-229)</A><TD ALIGN=center><FONT COLOR="#730000">14</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match732949-0.html#2',2,'match732949-1.html#2',3)" NAME="2">(151-154)<TD><A HREF="javascript:ZweiFrames('match732949-0.html#2',2,'match732949-1.html#2',3)" NAME="2">(97-103)</A><TD ALIGN=center><FONT COLOR="#5a0000">11</FONT>
<TR><TD BGCOLOR="#53858b"><FONT COLOR="#53858b">-</FONT><TD><A HREF="javascript:ZweiFrames('match732949-0.html#3',2,'match732949-1.html#3',3)" NAME="3">(79-83)<TD><A HREF="javascript:ZweiFrames('match732949-0.html#3',2,'match732949-1.html#3',3)" NAME="3">(172-198)</A><TD ALIGN=center><FONT COLOR="#5a0000">11</FONT>
<TR><TD BGCOLOR="#6cc417"><FONT COLOR="#6cc417">-</FONT><TD><A HREF="javascript:ZweiFrames('match732949-0.html#4',2,'match732949-1.html#4',3)" NAME="4">(146-149)<TD><A HREF="javascript:ZweiFrames('match732949-0.html#4',2,'match732949-1.html#4',3)" NAME="4">(361-372)</A><TD ALIGN=center><FONT COLOR="#520000">10</FONT>
<TR><TD BGCOLOR="#151b8d"><FONT COLOR="#151b8d">-</FONT><TD><A HREF="javascript:ZweiFrames('match732949-0.html#5',2,'match732949-1.html#5',3)" NAME="5">(188-190)<TD><A HREF="javascript:ZweiFrames('match732949-0.html#5',2,'match732949-1.html#5',3)" NAME="5">(412-414)</A><TD ALIGN=center><FONT COLOR="#4a0000">9</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>RecoverySourcePruneMergePolicyTests.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Elasticsearch under one or more contributor
 * license agreements. See the NOTICE file distributed with
 * this work for additional information regarding copyright
 * ownership. Elasticsearch licenses this file to you under
 * the Apache License, Version 2.0 (the &quot;License&quot;); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
<A NAME="0"></A> * under the License.
 */

<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match732949-1.html#0',3,'match732949-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>package org.elasticsearch.index.engine;

import org.apache.lucene.document.Document;
import org.apache.lucene.document.Field;
import org.apache.lucene.document.NumericDocValuesField;
import org.apache.lucene.document.StoredField;
import org.apache.lucene.document.StringField;
import org.apache.lucene.index.CodecReader;
import org.apache.lucene.index.DirectoryReader;
import org.apache.lucene.index.IndexWriter;
import org.apache.lucene.index.IndexWriterConfig;
import org.apache.lucene.index.IndexableField;
import org.apache.lucene.index.LeafReader;
import org.apache.lucene.index.MergePolicy;
import org.apache.lucene.index.NumericDocValues;
import org.apache.lucene.index.SegmentCommitInfo;
import org.apache.lucene.index.SegmentInfos;
import org.apache.lucene.index.ShuffleForcedMergePolicy;
import org.apache.lucene.index.StandardDirectoryReader;
import org.apache.lucene.index.Term;
import org.apache.lucene.search.DocIdSetIterator;
import org.apache.lucene.search.MatchAllDocsQuery;
import org.apache.lucene.search.MatchNoDocsQuery;
import org.apache.lucene.search.TermQuery;
import org.apache.lucene.store.Directory;
import org.apache.lucene.util.InfoStream;
import org.apache.lucene.util.NullInfoStream;
import org.elasticsearch.test.ESTestCase;

import java.io.IOException;
import java.util.Collections;
import java.util.Set;
import</B></FONT> java.util.stream.Collectors;

public class RecoverySourcePruneMergePolicyTests extends ESTestCase {

    public void testPruneAll() throws IOException {
        try (Directory dir = newDirectory()) {
            IndexWriterConfig iwc = newIndexWriterConfig();
            RecoverySourcePruneMergePolicy mp = new RecoverySourcePruneMergePolicy(
                &quot;extra_source&quot;,
                MatchNoDocsQuery::new,
                newLogMergePolicy()
            );
            iwc.setMergePolicy(new ShuffleForcedMergePolicy(mp));
            try (IndexWriter writer = new IndexWriter(dir, iwc)) {
                for (int i = 0; i &lt; 20; i++) {
                    if (i &gt; 0 &amp;&amp; randomBoolean()) {
                        writer.flush();
                    }
                    Document doc = new Document();
                    doc.add(new StoredField(&quot;source&quot;, &quot;hello world&quot;));
                    doc.add(new StoredField(&quot;extra_source&quot;, &quot;hello world&quot;));
                    doc.add(new NumericDocValuesField(&quot;extra_source&quot;, 1));
                    writer.addDocument(doc);
                }
<A NAME="3"></A>                writer.forceMerge(1);
                writer.commit();
                try (DirectoryReader reader = DirectoryReader.open(writer)) {
                    for (int i = 0; i &lt; reader.maxDoc(); i++) <FONT color="#53858b"><A HREF="javascript:ZweiFrames('match732949-1.html#3',3,'match732949-top.html#3',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>{
                        Document document = reader.document(i);
                        assertEquals(1, document.getFields().size());
                        assertEquals(&quot;source&quot;, document.getFields().get(0).name());
                    }</B></FONT>
                    assertEquals(1, reader.leaves().size());
                    LeafReader leafReader = reader.leaves().get(0).reader();
                    NumericDocValues extra_source = leafReader.getNumericDocValues(&quot;extra_source&quot;);
                    if (extra_source != null) {
                        assertEquals(DocIdSetIterator.NO_MORE_DOCS, extra_source.nextDoc());
                    }
                    if (leafReader instanceof CodecReader &amp;&amp; reader instanceof StandardDirectoryReader) {
                        CodecReader codecReader = (CodecReader) leafReader;
                        StandardDirectoryReader sdr = (StandardDirectoryReader) reader;
                        SegmentInfos segmentInfos = sdr.getSegmentInfos();
                        MergePolicy.MergeSpecification forcedMerges = mp.findForcedDeletesMerges(
                            segmentInfos,
                            new MergePolicy.MergeContext() {
                                @Override
                                public int numDeletesToMerge(SegmentCommitInfo info) {
                                    return info.info.maxDoc() - 1;
                                }

                                @Override
                                public int numDeletedDocs(SegmentCommitInfo info) {
                                    return info.info.maxDoc() - 1;
                                }

                                @Override
                                public InfoStream getInfoStream() {
                                    return new NullInfoStream();
                                }

                                @Override
                                public Set&lt;SegmentCommitInfo&gt; getMergingSegments() {
                                    return Collections.emptySet();
                                }
                            });
                        // don't wrap if there is nothing to do
                        assertSame(codecReader, forcedMerges.merges.get(0).wrapForMerge(codecReader));
                    }
                }
            }
        }
    }


    public void testPruneSome() throws IOException {
        try (Directory dir = newDirectory()) {
            IndexWriterConfig iwc = newIndexWriterConfig();
            iwc.setMergePolicy(new RecoverySourcePruneMergePolicy(&quot;extra_source&quot;,
                                                                  () -&gt; new TermQuery(new Term(&quot;even&quot;, &quot;true&quot;)),
                                                                  iwc.getMergePolicy()));
            try (IndexWriter writer = new IndexWriter(dir, iwc)) {
                for (int i = 0; i &lt; 20; i++) {
                    if (i &gt; 0 &amp;&amp; randomBoolean()) {
                        writer.flush();
                    }
                    Document doc = new Document();
                    doc.add(new StringField(&quot;even&quot;, Boolean.toString(i % 2 == 0), Field.Store.YES));
                    doc.add(new StoredField(&quot;source&quot;, &quot;hello world&quot;));
                    doc.add(new StoredField(&quot;extra_source&quot;, &quot;hello world&quot;));
                    doc.add(new NumericDocValuesField(&quot;extra_source&quot;, 1));
                    writer.addDocument(doc);
<A NAME="4"></A>                }
                writer.forceMerge(1);
                writer.commit();
                try (DirectoryReader reader = DirectoryReader.open(writer)) <FONT color="#6cc417"><A HREF="javascript:ZweiFrames('match732949-1.html#4',3,'match732949-top.html#4',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>{
                    assertEquals(1, reader.leaves().size());
<A NAME="2"></A>                    NumericDocValues extra_source = reader.leaves().get(0).reader().getNumericDocValues(&quot;extra_source&quot;);
                    assertNotNull</B></FONT>(extra_source);
                    for (int i = 0; i &lt; reader.maxDoc(); i++) {
                        Document document = <FONT color="#980517"><A HREF="javascript:ZweiFrames('match732949-1.html#2',3,'match732949-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>reader.document(i);
                        Set&lt;String&gt; collect = document.getFields().stream().map(IndexableField::name).collect(Collectors.toSet());
                        assertTrue(collect.contains(&quot;source&quot;));
                        assertTrue(collect.contains</B></FONT>(&quot;even&quot;));
                        if (collect.size() == 3) {
                            assertTrue(collect.contains(&quot;extra_source&quot;));
                            assertEquals(&quot;true&quot;, document.getField(&quot;even&quot;).stringValue());
                            assertEquals(i, extra_source.nextDoc());
                        } else {
                            assertEquals(2, document.getFields().size());
                        }
                    }
                    assertEquals(DocIdSetIterator.NO_MORE_DOCS, extra_source.nextDoc());
                }
            }
        }
    }

    public void testPruneNone() throws IOException {
        try (Directory dir = newDirectory()) {
            IndexWriterConfig iwc = newIndexWriterConfig();
            iwc.setMergePolicy(new RecoverySourcePruneMergePolicy(&quot;extra_source&quot;,
                                                                  () -&gt; new MatchAllDocsQuery(), iwc.getMergePolicy()));
            try (IndexWriter writer = new IndexWriter(dir, iwc)) {
                for (int i = 0; i &lt; 20; i++) {
                    if (i &gt; 0 &amp;&amp; randomBoolean()) {
                        writer.flush();
                    }
                    Document doc = new Document();
                    doc.add(new StoredField(&quot;source&quot;, &quot;hello world&quot;));
                    doc.add(new StoredField(&quot;extra_source&quot;, &quot;hello world&quot;));
                    doc.add(new NumericDocValuesField(&quot;extra_source&quot;, 1));
                    writer.addDocument(doc);
                }
<A NAME="5"></A>                writer.forceMerge(1);
                writer.commit();
                try (DirectoryReader reader = DirectoryReader.open(writer)) {
                    <FONT color="#151b8d"><A HREF="javascript:ZweiFrames('match732949-1.html#5',3,'match732949-top.html#5',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertEquals(1, reader.leaves().size());
<A NAME="1"></A>                    NumericDocValues extra_source = reader.leaves().get(0).reader().getNumericDocValues(&quot;extra_source&quot;);
                    assertNotNull</B></FONT>(extra_source);
                    for (int i = 0; i &lt; reader.maxDoc(); i++) {
                        <FONT color="#f63526"><A HREF="javascript:ZweiFrames('match732949-1.html#1',3,'match732949-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>Document document = reader.document(i);
                        Set&lt;String&gt; collect = document.getFields().stream().map(IndexableField::name).collect(Collectors.toSet());
                        assertTrue(collect.contains(&quot;source&quot;));
                        assertTrue(collect.contains(&quot;extra_source&quot;));
                        assertEquals(i, extra_source.nextDoc</B></FONT>());
                    }
                    assertEquals(DocIdSetIterator.NO_MORE_DOCS, extra_source.nextDoc());
                }
            }
        }
    }
}
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>SysShardsTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
<A NAME="0"></A> * software solely pursuant to the terms of the relevant commercial agreement.
 */

<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match732949-0.html#0',2,'match732949-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>package io.crate.integrationtests;

import io.crate.exceptions.OperationOnInaccessibleRelationException;
import io.crate.metadata.PartitionName;
import io.crate.testing.SQLResponse;
import io.crate.testing.TestingHelpers;
import io.crate.testing.UseJdbc;
import org.apache.lucene.util.Version;
import org.elasticsearch.cluster.metadata.IndexMetadata;
import org.elasticsearch.cluster.metadata.Metadata;
import org.elasticsearch.cluster.service.ClusterService;
import org.elasticsearch.test.ESIntegTestCase;
import org.junit.Before;
import org.junit.Test;

import java.nio.file.Path;
import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.concurrent.TimeUnit;

import static io.crate.protocols.postgres.PGErrorStatus.INTERNAL_ERROR;
import static io.crate.protocols.postgres.PGErrorStatus.UNDEFINED_COLUMN;
import static io.crate.protocols.postgres.PGErrorStatus.UNDEFINED_TABLE;
import static io.crate.testing.Asserts.assertThrowsMatches;
import static io.crate.testing.SQLErrorMatcher.isSQLError;
import static io.crate.testing.TestingHelpers.resolveCanonicalString;
import static io.netty.handler.codec.http.HttpResponseStatus.BAD_REQUEST;
import static io.netty.handler.codec.http.HttpResponseStatus.NOT_FOUND;
import static org.hamcrest.Matchers.arrayContaining;
import static org.hamcrest.Matchers.containsString;
import static org.hamcrest.Matchers.endsWith;
import static org.hamcrest.Matchers.equalTo;
import</B></FONT> static org.hamcrest.Matchers.greaterThan;
import static org.hamcrest.Matchers.greaterThanOrEqualTo;
import static org.hamcrest.Matchers.instanceOf;
import static org.hamcrest.Matchers.is;
import static org.hamcrest.Matchers.not;
import static org.hamcrest.Matchers.nullValue;

@ESIntegTestCase.ClusterScope(numClientNodes = 0, numDataNodes = 2, supportsDedicatedMasters = false)
public class SysShardsTest extends SQLIntegrationTestCase {

    @Before
    public void initTestData() throws Exception {
        Setup setup = new Setup(sqlExecutor);
        setup.groupBySetup();
        execute(&quot;create table quotes (id integer primary key, quote string) with (number_of_replicas=1)&quot;);
        execute(&quot;create blob table blobs clustered into 5 shards with (number_of_replicas=1)&quot;);
        ensureGreen();
    }

    @Test
    public void testPathAndBlobPath() throws Exception {
        Path blobs = createTempDir(&quot;blobs&quot;);
        execute(&quot;create table t1 (x int) clustered into 1 shards with (number_of_replicas = 0)&quot;);
        execute(&quot;create blob table b1 clustered into 1 shards with (number_of_replicas = 0)&quot;);
        execute(&quot;create blob table b2 &quot; +
                &quot;clustered into 1 shards with (number_of_replicas = 0, blobs_path = '&quot; + blobs.toString() + &quot;')&quot;);
        ensureYellow();

        execute(&quot;select path, blob_path from sys.shards where table_name in ('t1', 'b1', 'b2') &quot; +
                &quot;order by table_name asc&quot;);
        // b1
        // path + /blobs == blob_path without custom blob path
        assertThat(response.rows()[0][0] + resolveCanonicalString(&quot;/blobs&quot;), is(response.rows()[0][1]));

        ClusterService clusterService = internalCluster().getInstance(ClusterService.class);
        Metadata metadata = clusterService.state().getMetadata();
        IndexMetadata index = metadata.index(&quot;.blob_b2&quot;);
        String indexUUID = index.getIndexUUID();

<A NAME="2"></A>        // b2
        String b2Path = (String) response.rows()[1][0];
        assertThat(b2Path, containsString(resolveCanonicalString(&quot;/nodes/&quot;)));
        assertThat(b2Path, endsWith(<FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match732949-0.html#2',2,'match732949-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>resolveCanonicalString(&quot;/indices/&quot; + indexUUID + &quot;/0&quot;)));

        String b2BlobPath = (String) response.rows()[1][1];
        assertThat(b2BlobPath, containsString(resolveCanonicalString(&quot;/nodes/&quot;)));
        assertThat(b2BlobPath, endsWith(resolveCanonicalString(&quot;/indices/&quot; + indexUUID + &quot;/0/blobs&quot;)));
        // t1
        assertThat(response.rows</B></FONT>()[2][1], nullValue());
    }

    @Test
    public void testSelectGroupByWhereTable() throws Exception {
        SQLResponse response = execute(&quot;&quot; +
                                       &quot;select count(*), num_docs from sys.shards where table_name = 'characters' &quot; +
                                       &quot;group by num_docs order by count(*)&quot;);
        assertThat(response.rowCount(), greaterThan(0L));
    }

    @Test
    public void testSelectGroupByAllTables() throws Exception {
        SQLResponse response = execute(&quot;select count(*), table_name from sys.shards &quot; +
                                       &quot;group by table_name order by table_name&quot;);
        assertEquals(3L, response.rowCount());
        assertEquals(10L, response.rows()[0][0]);
        assertEquals(&quot;blobs&quot;, response.rows()[0][1]);
        assertEquals(&quot;characters&quot;, response.rows()[1][1]);
        assertEquals(&quot;quotes&quot;, response.rows()[2][1]);
    }

    @Test
    public void testGroupByWithLimitUnassignedShards() throws Exception {
        try {
            execute(&quot;create table t (id int, name string) with (number_of_replicas=2, \&quot;write.wait_for_active_shards\&quot;=1)&quot;);
            ensureYellow();

            SQLResponse response = execute(&quot;select sum(num_docs), table_name, sum(num_docs) from sys.shards group by table_name order by table_name desc limit 1000&quot;);
            assertThat(response.rowCount(), is(4L));
            assertThat(TestingHelpers.printedTable(response.rows()),
                is(&quot;0| t| 0\n&quot; +
                   &quot;0| quotes| 0\n&quot; +
                   &quot;14| characters| 14\n&quot; +
                   &quot;0| blobs| 0\n&quot;));
        } finally {
            execute(&quot;drop table t&quot;);
        }
    }

    @Test
    public void testSelectGroupByWhereNotLike() throws Exception {
        SQLResponse response = execute(&quot;select count(*), table_name from sys.shards &quot; +
                                       &quot;where table_name not like 'my_table%' group by table_name order by table_name&quot;);
        assertEquals(3L, response.rowCount());
        assertEquals(10L, response.rows()[0][0]);
        assertEquals(&quot;blobs&quot;, response.rows()[0][1]);
        assertEquals(8L, response.rows()[1][0]);
        assertEquals(&quot;characters&quot;, response.rows()[1][1]);
        assertEquals(8L, response.rows()[2][0]);
        assertEquals(&quot;quotes&quot;, response.rows()[2][1]);
    }

    @Test
    public void testSelectWhereTable() throws Exception {
        SQLResponse response = execute(
            &quot;select id, size from sys.shards &quot; +
            &quot;where table_name = 'characters'&quot;);
        assertEquals(8L, response.rowCount());
    }

    @Test
    public void testSelectStarWhereTable() throws Exception {
        SQLResponse response = execute(
            &quot;select * from sys.shards where table_name = 'characters'&quot;);
        assertEquals(8L, response.rowCount());
<A NAME="3"></A>    }

    @Test
    public void testSelectStarAllTables() throws Exception <FONT color="#53858b"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match732949-0.html#3',2,'match732949-top.html#3',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>{
        SQLResponse response = execute(&quot;select * from sys.shards&quot;);
        assertEquals(26L, response.rowCount());
        assertEquals(21, response.cols().length);
        assertThat(response.cols(), arrayContaining(
            &quot;blob_path&quot;,
            &quot;closed&quot;,
            &quot;flush_stats&quot;,
            &quot;id&quot;,
            &quot;min_lucene_version&quot;,
            &quot;node&quot;,
            &quot;num_docs&quot;,
            &quot;orphan_partition&quot;,
            &quot;partition_ident&quot;,
            &quot;path&quot;,
            &quot;primary&quot;,
            &quot;recovery&quot;,
            &quot;relocating_node&quot;,
            &quot;retention_leases&quot;,
            &quot;routing_state&quot;,
            &quot;schema_name&quot;,
            &quot;seq_no_stats&quot;,
            &quot;size&quot;,
            &quot;state&quot;,
            &quot;table_name&quot;,
            &quot;translog_stats&quot;));
    }</B></FONT>

    @Test
    public void testSelectStarLike() throws Exception {
        SQLResponse response = execute(
            &quot;select * from sys.shards where table_name like 'charact%'&quot;);
        assertEquals(8L, response.rowCount());
    }

    @Test
    public void testSelectStarNotLike() throws Exception {
        SQLResponse response = execute(
            &quot;select * from sys.shards where table_name not like 'quotes%'&quot;);
        assertEquals(18L, response.rowCount());
    }

    @Test
    public void testSelectStarIn() throws Exception {
        SQLResponse response = execute(
            &quot;select * from sys.shards where table_name in ('characters')&quot;);
        assertEquals(8L, response.rowCount());
    }

    @Test
<A NAME="1"></A>    public void test_translog_stats_can_be_retrieved() {
        execute(&quot;SELECT translog_stats, translog_stats['size'] FROM sys.shards &quot; +
                &quot;WHERE id = 0 AND \&quot;primary\&quot; = true AND table_name = 'characters'&quot;);
        <FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match732949-0.html#1',2,'match732949-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>Object[] resultRow = response.rows()[0];
        Map&lt;String, Object&gt; translogStats = (Map&lt;String, Object&gt;) resultRow[0];
        assertThat(((Number) translogStats.get(&quot;size&quot;)).longValue(), is(resultRow[1]));
        assertThat(((Number) translogStats.get(&quot;uncommitted_size&quot;)).longValue(), greaterThanOrEqualTo(0L));
        assertThat(((Number) translogStats.get</B></FONT>(&quot;number_of_operations&quot;)).longValue(), greaterThanOrEqualTo(0L));
        assertThat(((Number) translogStats.get(&quot;uncommitted_operations&quot;)).longValue(), greaterThanOrEqualTo(0L));
    }

    @Test
    public void testSelectStarMatch() throws Exception {
        assertThrowsMatches(() -&gt; execute(&quot;select * from sys.shards where match(table_name, 'characters')&quot;),
                     isSQLError(is(&quot;Cannot use MATCH on system tables&quot;), INTERNAL_ERROR, BAD_REQUEST, 4004));
    }

    @Test
    public void testSelectOrderBy() throws Exception {
        SQLResponse response = execute(&quot;select table_name, min_lucene_version, * &quot; +
                                       &quot;from sys.shards order by table_name&quot;);
        assertEquals(26L, response.rowCount());
        List&lt;String&gt; tableNames = Arrays.asList(&quot;blobs&quot;, &quot;characters&quot;, &quot;quotes&quot;);
        for (Object[] row : response.rows()) {
            assertThat(tableNames.contains(row[0]), is(true));
            assertThat(row[1], is(Version.LATEST.toString()));
        }
    }

    @Test
    public void testSelectGreaterThan() throws Exception {
        SQLResponse response = execute(&quot;select * from sys.shards where num_docs &gt; 0&quot;);
        assertThat(response.rowCount(), greaterThan(0L));
    }

    @Test
    public void testSelectWhereBoolean() throws Exception {
        SQLResponse response = execute(&quot;select * from sys.shards where \&quot;primary\&quot; = false&quot;);
        assertEquals(13L, response.rowCount());
    }

    @Test
    public void testSelectGlobalAggregates() throws Exception {
        SQLResponse response = execute(
            &quot;select sum(size), min(size), max(size), avg(size) from sys.shards&quot;);
        assertEquals(1L, response.rowCount());
        assertEquals(4, response.rows()[0].length);
        assertNotNull(response.rows()[0][0]);
        assertNotNull(response.rows()[0][1]);
        assertNotNull(response.rows()[0][2]);
        assertNotNull(response.rows()[0][3]);
    }

    @Test
    public void testSelectGlobalCount() throws Exception {
        SQLResponse response = execute(&quot;select count(*) from sys.shards&quot;);
        assertEquals(1L, response.rowCount());
        assertEquals(26L, response.rows()[0][0]);
    }

    @Test
    public void testSelectGlobalCountAndOthers() throws Exception {
        SQLResponse response = execute(&quot;select count(*), max(table_name) from sys.shards&quot;);
        assertEquals(1L, response.rowCount());
        assertEquals(26L, response.rows()[0][0]);
        assertEquals(&quot;quotes&quot;, response.rows()[0][1]);
    }

    @Test
    public void testGroupByUnknownResultColumn() throws Exception {
        assertThrowsMatches(() -&gt; execute(&quot;select lol from sys.shards group by table_name&quot;),
                     isSQLError(is(&quot;Column lol unknown&quot;), UNDEFINED_COLUMN, NOT_FOUND, 4043));
    }

    @Test
    public void testGroupByUnknownGroupByColumn() throws Exception {
        assertThrowsMatches(() -&gt; execute(&quot;select max(num_docs) from sys.shards group by lol&quot;),
                     isSQLError(is(&quot;Column lol unknown&quot;), UNDEFINED_COLUMN, NOT_FOUND, 4043));
    }

    @Test
    public void testGroupByUnknownOrderBy() throws Exception {
        assertThrowsMatches(() -&gt; execute(
            &quot;select sum(num_docs), table_name from sys.shards group by table_name order by lol&quot;),
                     isSQLError(is(&quot;Column lol unknown&quot;), UNDEFINED_COLUMN, NOT_FOUND, 4043));
    }

    @Test
    public void testGroupByUnknownWhere() throws Exception {
        assertThrowsMatches(() -&gt; execute(
            &quot;select sum(num_docs), table_name from sys.shards where lol='funky' group by table_name&quot;),
                     isSQLError(is(&quot;Column lol unknown&quot;), UNDEFINED_COLUMN, NOT_FOUND, 4043));
        ;
    }

    @Test
    public void testGlobalAggregateUnknownWhere() throws Exception {
        assertThrowsMatches(() -&gt; execute(
            &quot;select sum(num_docs) from sys.shards where lol='funky'&quot;),
                     isSQLError(is(&quot;Column lol unknown&quot;), UNDEFINED_COLUMN, NOT_FOUND, 4043));
    }

    @Test
    public void testSelectShardIdFromSysNodes() throws Exception {
        assertThrowsMatches(() -&gt; execute(
            &quot;select sys.shards.id from sys.nodes&quot;),
                     isSQLError(is(&quot;Relation 'sys.shards' unknown&quot;), UNDEFINED_TABLE, NOT_FOUND, 4041));
    }

    @Test
    public void testSelectWithOrderByColumnNotInOutputs() throws Exception {
        // regression test... query failed with ArrayOutOfBoundsException due to inputColumn mangling in planner
        SQLResponse response = execute(&quot;select id from sys.shards order by table_name limit 1&quot;);
        assertThat(response.rowCount(), is(1L));
        assertThat(response.rows()[0][0], instanceOf(Integer.class));
    }

    @Test
    public void testSelectGroupByHaving() throws Exception {
        SQLResponse response = execute(&quot;select count(*) &quot; +
                                       &quot;from sys.shards &quot; +
                                       &quot;group by table_name &quot; +
                                       &quot;having table_name = 'quotes'&quot;);
        assertThat(TestingHelpers.printedTable(response.rows()), is(&quot;8\n&quot;));
    }

    @Test
    public void testSelectNodeSysExpression() throws Exception {
        SQLResponse response = execute(
            &quot;select node, node['name'], id from sys.shards order by node['name'], id  limit 1&quot;);
        assertEquals(1L, response.rowCount());
        Map&lt;String, Object&gt; fullNode = (Map&lt;String, Object&gt;) response.rows()[0][0];
        String nodeName = response.rows()[0][1].toString();
        assertEquals(&quot;node_s0&quot;, nodeName);
        assertEquals(&quot;node_s0&quot;, fullNode.get(&quot;name&quot;));
    }
<A NAME="4"></A>
    @Test
    public void testOrphanedPartitionExpression() throws Exception {
        try <FONT color="#6cc417"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match732949-0.html#4',2,'match732949-top.html#4',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>{
            execute(&quot;create table c.orphan_test (id int primary key, p string primary key) &quot; +
                    &quot;partitioned by (p) &quot; +
                    &quot;clustered into 1 shards &quot; +
                    &quot;with (number_of_replicas = 0)&quot;
            );
            execute(&quot;insert into c.orphan_test (id, p) values (1, 'foo')&quot;);
            ensureYellow();

            SQLResponse response = execute(
                &quot;select orphan_partition from sys.shards where table_name = 'orphan_test'&quot;);
            assertThat(TestingHelpers.printedTable(response.rows()), is</B></FONT>(&quot;false\n&quot;));

            client().admin().indices()
                .prepareDeleteTemplate(PartitionName.templateName(&quot;c&quot;, &quot;orphan_test&quot;))
                .execute().get(1, TimeUnit.SECONDS);

            response = execute(
                &quot;select orphan_partition from sys.shards where table_name = 'orphan_test'&quot;);
            assertThat(TestingHelpers.printedTable(response.rows()), is(&quot;true\n&quot;));
        } finally {
            execute(&quot;drop table c.orphan_test&quot;);
        }
    }

    @Test
    public void testSelectNodeSysExpressionWithUnassignedShards() throws Exception {
        try {
            execute(&quot;create table users (id integer primary key, name string) &quot; +
                    &quot;clustered into 5 shards with (number_of_replicas=2, \&quot;write.wait_for_active_shards\&quot;=1)&quot;);
            ensureYellow();
            SQLResponse response = execute(
                &quot;select node['name'], id from sys.shards where table_name = 'users' order by node['name'] nulls last&quot;
            );
            String nodeName = response.rows()[0][0].toString();
            assertEquals(&quot;node_s0&quot;, nodeName);
            assertThat(response.rows()[12][0], is(nullValue()));
        } finally {
            execute(&quot;drop table users&quot;);
        }
    }

    @Test
    public void testSelectRecoveryExpression() throws Exception {
        SQLResponse response = execute(&quot;select recovery, &quot; +
                                       &quot;recovery['files'], recovery['files']['used'], recovery['files']['reused'], recovery['files']['recovered'], &quot; +
                                       &quot;recovery['size'], recovery['size']['used'], recovery['size']['reused'], recovery['size']['recovered'] &quot; +
                                       &quot;from sys.shards&quot;);
<A NAME="5"></A>        for (Object[] row : response.rows()) {
            Map recovery = (Map) row[0];
            Map&lt;String, Integer&gt; files = (Map&lt;String, Integer&gt;) row[1];
            assertThat(((Map&lt;String, Integer&gt;) <FONT color="#151b8d"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match732949-0.html#5',2,'match732949-top.html#5',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>recovery.get(&quot;files&quot;)).entrySet(), equalTo(files.entrySet()));
            Map&lt;String, Long&gt; size = (Map&lt;String, Long&gt;) row[5];
            assertThat(((Map&lt;String, Long&gt;) recovery.get(&quot;size&quot;)).entrySet(), equalTo(size.entrySet</B></FONT>()));
        }
    }

    @Test
    public void testScalarEvaluatesInErrorOnSysShards() throws Exception {
        // we need at least 1 shard, otherwise the table is empty and no evaluation occurs
        execute(&quot;create table t1 (id integer) clustered into 1 shards with (number_of_replicas=0)&quot;);
        ensureYellow();
        assertThrowsMatches(() -&gt; execute(
            &quot;select 1/0 from sys.shards&quot;),
                     isSQLError(is(&quot;/ by zero&quot;), INTERNAL_ERROR, BAD_REQUEST, 4000));
    }

    @Test
    public void test_state_for_shards_of_closed_table() throws Exception {
        execute(&quot;create table doc.tbl (x int) clustered into 2 shards with(number_of_replicas=0)&quot;);
        execute(&quot;insert into doc.tbl values(1)&quot;);
        logger.info(&quot;---&gt; Closing table doc.tbl&quot;);
        execute(&quot;alter table doc.tbl close&quot;);
        execute(&quot;select id, closed from sys.shards where table_name = 'tbl' order by id asc&quot;);
        assertThat(response.rows()[0][0], is(0));
        assertThat(response.rows()[0][1], is(true));
        assertThat(response.rows()[1][0], is(1));
        assertThat(response.rows()[1][1], is(true));
    }

    @UseJdbc(0)
    @Test
    public void testSelectFromClosedTableNotAllowed() throws Exception {
        execute(&quot;create table doc.tbl (x int)&quot;);
        execute(&quot;insert into doc.tbl values(1)&quot;);
        execute(&quot;alter table doc.tbl close&quot;);
        assertThrowsMatches(() -&gt; execute(&quot;select * from doc.tbl&quot;),
                     OperationOnInaccessibleRelationException.class,
                     &quot;The relation \&quot;doc.tbl\&quot; doesn't support or allow READ operations, as it is currently closed.&quot;);
    }

    @UseJdbc(0)
    @Test
    public void testInsertFromClosedTableNotAllowed() throws Exception {
        execute(&quot;create table doc.tbl (x int)&quot;);
        execute(&quot;insert into doc.tbl values(1)&quot;);
        execute(&quot;alter table doc.tbl close&quot;);
        assertThrowsMatches(() -&gt; execute(&quot;insert into doc.tbl values(2)&quot;),
                     OperationOnInaccessibleRelationException.class,
                     &quot;The relation \&quot;doc.tbl\&quot; doesn't support or allow INSERT operations, as it is currently closed.&quot;);
    }
}
</PRE>
</div>
  </div>
</body>
</html>
