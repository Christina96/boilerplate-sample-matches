<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for SslReqHandlerIntegrationTest.java & BlobHttpIntegrationTest.java</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for SslReqHandlerIntegrationTest.java & BlobHttpIntegrationTest.java
      </h3>
      <h1 align="center">
        12.9%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>SslReqHandlerIntegrationTest.java (22.972973%)<TH>BlobHttpIntegrationTest.java (9.018568%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match1534534-0.html#0',2,'match1534534-1.html#0',3)" NAME="0">(22-41)<TD><A HREF="javascript:ZweiFrames('match1534534-0.html#0',2,'match1534534-1.html#0',3)" NAME="0">(22-40)</A><TD ALIGN=center><FONT COLOR="#ff0000">18</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match1534534-0.html#1',2,'match1534534-1.html#1',3)" NAME="1">(100-109)<TD><A HREF="javascript:ZweiFrames('match1534534-0.html#1',2,'match1534534-1.html#1',3)" NAME="1">(100-109)</A><TD ALIGN=center><FONT COLOR="#e20000">16</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>SslReqHandlerIntegrationTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
<A NAME="0"></A> * software solely pursuant to the terms of the relevant commercial agreement.
 */

<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match1534534-1.html#0',3,'match1534534-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>package io.crate.protocols.postgres;

import io.crate.integrationtests.SQLIntegrationTestCase;
import io.crate.protocols.ssl.SslSettings;
import io.crate.testing.SQLResponse;
import io.crate.testing.UseJdbc;
import io.netty.handler.ssl.util.SelfSignedCertificate;
import org.elasticsearch.common.CheckedConsumer;
import org.elasticsearch.common.settings.Settings;
import org.elasticsearch.test.ESIntegTestCase;
import org.junit.BeforeClass;
import org.junit.Test;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.security.KeyStore;
import java.security.cert.Certificate;
import java.util.Locale;
import</B></FONT> java.util.concurrent.TimeUnit;


@UseJdbc(value = 1)
@ESIntegTestCase.ClusterScope(numDataNodes = 1, numClientNodes = 0, supportsDedicatedMasters = false)
public class SslReqHandlerIntegrationTest extends SQLIntegrationTestCase {

    private final static char[] EMPTY_PASS = new char[]{};

    private static SelfSignedCertificate trustedCert;
    private static File keyStoreFile;

    public SslReqHandlerIntegrationTest() {
        super(true);
    }

    public static void forceEnglishLocale() {
        // BouncyCastle is parsing date objects with the system locale while creating self-signed SSL certs
        // This fails for certain locales, e.g. 'ks'.
        // Until this is fixed, we force the english locale.
        // See also https://github.com/bcgit/bc-java/issues/405 (different topic, but same root cause)
        Locale.setDefault(Locale.ENGLISH);
    }

    @BeforeClass
    public static void beforeTest() throws Exception {
        forceEnglishLocale();

        trustedCert = new SelfSignedCertificate();
        keyStoreFile = createTempFile().toFile();

        updateKeyStore(
            keyStoreFile,
            store -&gt; {
                SelfSignedCertificate fakeCert = new SelfSignedCertificate();
                store.setKeyEntry(
                    &quot;key&quot;,
                    trustedCert.key(),
                    EMPTY_PASS,
                    new Certificate[]{fakeCert.cert()});
            });
    }

    private static void updateKeyStore(File keyStoreFile, CheckedConsumer&lt;KeyStore, Exception&gt; consumer)
        throws Exception {
        var keyStore = KeyStore.getInstance(&quot;JKS&quot;);
        try (var is = new FileInputStream(keyStoreFile)) {
            keyStore.load(is, EMPTY_PASS);
        } catch (Exception e) {
            keyStore.load(null);
        }
        consumer.accept(keyStore);
        try (var fs = new FileOutputStream(keyStoreFile)) {
            keyStore.store(fs, EMPTY_PASS);
        }
    }
<A NAME="1"></A>
    @Override
    protected Settings nodeSettings(int nodeOrdinal) {
        return <FONT color="#f63526"><A HREF="javascript:ZweiFrames('match1534534-1.html#1',3,'match1534534-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>Settings.builder()
            .put(super.nodeSettings(nodeOrdinal))
            .put(SslSettings.SSL_PSQL_ENABLED.getKey(), true)
            .put(SslSettings.SSL_KEYSTORE_FILEPATH.getKey(), keyStoreFile.getAbsolutePath())
            .put(SslSettings.SSL_RESOURCE_POLL_INTERVAL.getKey(), &quot;2s&quot;)
            .build();
    }

    @Test
    public void testReloadSslContextOnKeyStoreChange() throws Throwable {</B></FONT>
        try {
            execute(&quot;select name from sys.nodes&quot;);
            fail(&quot;Unknown certificate in the certificate chain&quot;);
        } catch (Exception ignored) {
        }

        updateKeyStore(
            keyStoreFile,
            keyStore -&gt; keyStore.setKeyEntry(
                &quot;key&quot;,
                trustedCert.key(),
                EMPTY_PASS,
                new Certificate[]{trustedCert.cert()}));

        assertBusy(() -&gt; {
            try {
                SQLResponse response = execute(&quot;select name from sys.nodes&quot;);
                assertEquals(1, response.rowCount());
            } catch (Exception e) {
                fail(e.getMessage());
            }
        }, 20, TimeUnit.SECONDS);
    }
}
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>BlobHttpIntegrationTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
<A NAME="0"></A> * software solely pursuant to the terms of the relevant commercial agreement.
 */

<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match1534534-0.html#0',2,'match1534534-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>package io.crate.integrationtests;

import io.crate.blob.BlobTransferStatus;
import io.crate.blob.BlobTransferTarget;
import io.crate.blob.v2.BlobAdminClient;
import io.crate.test.utils.Blobs;
import org.apache.http.Header;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpDelete;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpHead;
import org.apache.http.client.methods.HttpPut;
import org.apache.http.client.methods.HttpUriRequest;
import org.apache.http.client.protocol.HttpClientContext;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.message.BasicHeader;
import</B></FONT> org.apache.http.util.EntityUtils;
import org.apache.lucene.util.IOUtils;
import org.elasticsearch.cluster.metadata.IndexMetadata;
import org.elasticsearch.common.settings.Settings;
import org.elasticsearch.http.HttpServerTransport;
import org.junit.After;
import org.junit.Before;

import java.io.IOException;
import java.lang.reflect.Field;
import java.net.InetSocketAddress;
import java.net.URI;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.UUID;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.TimeUnit;

import static org.hamcrest.Matchers.empty;
import static org.hamcrest.core.Is.is;

public abstract class BlobHttpIntegrationTest extends BlobIntegrationTestBase {

    protected InetSocketAddress dataNode1;
    protected InetSocketAddress dataNode2;
    protected InetSocketAddress randomNode;

    protected CloseableHttpClient httpClient = HttpClients.createDefault();

    static {
        System.setProperty(&quot;tests.short_timeouts&quot;, &quot;true&quot;);
    }


    @Before
    public void setup() throws ExecutionException, InterruptedException {
        randomNode = internalCluster().getInstances(HttpServerTransport.class)
            .iterator().next().boundAddress().publishAddress().address();
        Iterable&lt;HttpServerTransport&gt; transports = internalCluster().getDataNodeInstances(HttpServerTransport.class);
        Iterator&lt;HttpServerTransport&gt; httpTransports = transports.iterator();
        dataNode1 = httpTransports.next().boundAddress().publishAddress().address();
        dataNode2 = httpTransports.next().boundAddress().publishAddress().address();
        BlobAdminClient blobAdminClient = internalCluster().getInstance(BlobAdminClient.class);

        Settings indexSettings = Settings.builder()
            .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0)
            .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, 2)
            // SETTING_AUTO_EXPAND_REPLICAS is enabled by default
            // but for this test it needs to be disabled so we can have 0 replicas
            .put(IndexMetadata.SETTING_AUTO_EXPAND_REPLICAS, &quot;false&quot;)
            .build();
<A NAME="1"></A>        blobAdminClient.createBlobTable(&quot;test&quot;, indexSettings).get();
        blobAdminClient.createBlobTable(&quot;test_blobs2&quot;, indexSettings).get();

        <FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match1534534-0.html#1',2,'match1534534-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>client().admin().indices().prepareCreate(&quot;test_no_blobs&quot;)
            .setSettings(
                Settings.builder()
                    .put(&quot;number_of_shards&quot;, 2)
                    .put(&quot;number_of_replicas&quot;, 0).build()).execute().actionGet();
        ensureGreen();
    }

    @After
    public void assertNoActiveTransfersRemaining() throws Exception {</B></FONT>
        Iterable&lt;BlobTransferTarget&gt; transferTargets = internalCluster().getInstances(BlobTransferTarget.class);
        final Field activeTransfersField = BlobTransferTarget.class.getDeclaredField(&quot;activeTransfers&quot;);
        activeTransfersField.setAccessible(true);
        assertBusy(() -&gt; {
            for (BlobTransferTarget transferTarget : transferTargets) {
                Map&lt;UUID, BlobTransferStatus&gt; activeTransfers = null;
                try {
                    activeTransfers = (Map&lt;UUID, BlobTransferStatus&gt;) activeTransfersField.get(transferTarget);
                    assertThat(activeTransfers.keySet(), empty());
                } catch (IllegalAccessException e) {
                    throw new RuntimeException(e);
                }
            }
        });
    }

    protected String blobUri(String digest) {
        return blobUri(&quot;test&quot;, digest);
    }

    protected String blobUri(String index, String digest) {
        return String.format(Locale.ENGLISH, &quot;%s/%s&quot;, index, digest);
    }

    protected CloseableHttpResponse put(String uri, String body) throws IOException {
        HttpPut httpPut = new HttpPut(Blobs.url(false, randomNode, uri));
        if (body != null) {
            StringEntity bodyEntity = new StringEntity(body);
            httpPut.setEntity(bodyEntity);
        }
        return executeAndDefaultAssertions(httpPut);
    }

    protected CloseableHttpResponse executeAndDefaultAssertions(HttpUriRequest request) throws IOException {
        CloseableHttpResponse resp = httpClient.execute(request);
        assertThat(resp.containsHeader(&quot;Connection&quot;), is(false));
        return resp;
    }

    protected CloseableHttpResponse get(String uri) throws IOException {
        return get(uri, new Header[] { new BasicHeader(&quot;Origin&quot;, &quot;http://example.com&quot;) });
    }

    protected boolean mget(String[] uris, Header[][] headers, final String[] expectedContent) throws Throwable {
        final CountDownLatch latch = new CountDownLatch(uris.length);
        final ConcurrentHashMap&lt;Integer, Boolean&gt; results = new ConcurrentHashMap&lt;&gt;(uris.length);
        for (int i = 0; i &lt; uris.length; i++) {
            final int indexerId = i;
            final String uri = uris[indexerId];
            final Header[] header = headers[indexerId];
            final String expected = expectedContent[indexerId];
            Thread thread = new Thread() {
                @Override
                public void run() {
                    try {
                        CloseableHttpResponse res = get(uri, header);
                        Integer statusCode = res.getStatusLine().getStatusCode();
                        String resultContent = EntityUtils.toString(res.getEntity());
                        if (!resultContent.equals(expected)) {
                            logger.warn(String.format(Locale.ENGLISH, &quot;incorrect response %d -- length: %d expected: %d%n&quot;,
                                indexerId, resultContent.length(), expected.length()));
                        }
                        results.put(indexerId, (statusCode &gt;= 200 &amp;&amp; statusCode &lt; 300 &amp;&amp;
                                                expected.equals(resultContent)));
                    } catch (Exception e) {
                        logger.warn(&quot;**** failed indexing thread {}&quot;, e, indexerId);
                    } finally {
                        latch.countDown();
                    }
                }
            };
            thread.start();
        }
        assertThat(latch.await(30L, TimeUnit.SECONDS), is(true));
        return results.values().stream().allMatch(input -&gt; input);
    }

    protected CloseableHttpResponse get(String uri, Header[] headers) throws IOException {
        HttpGet httpGet = new HttpGet(String.format(Locale.ENGLISH, &quot;http://%s:%s/_blobs/%s&quot;, dataNode1.getHostName(), dataNode1.getPort(), uri));
        if (headers != null) {
            httpGet.setHeaders(headers);
        }
        return executeAndDefaultAssertions(httpGet);
    }

    protected CloseableHttpResponse head(String uri) throws IOException {
        HttpHead httpHead = new HttpHead(String.format(Locale.ENGLISH, &quot;http://%s:%s/_blobs/%s&quot;, dataNode1.getHostName(), dataNode1.getPort(), uri));
        return executeAndDefaultAssertions(httpHead);
    }

    protected CloseableHttpResponse delete(String uri) throws IOException {
        HttpDelete httpDelete = new HttpDelete(String.format(Locale.ENGLISH, &quot;http://%s:%s/_blobs/%s&quot;, dataNode1.getHostName(), dataNode1.getPort(), uri));
        return executeAndDefaultAssertions(httpDelete);
    }

    public static List&lt;String&gt; getRedirectLocations(CloseableHttpClient client, String uri, InetSocketAddress address) throws IOException {
        CloseableHttpResponse response = null;
        try {
            HttpClientContext context = HttpClientContext.create();
            HttpHead httpHead = new HttpHead(String.format(Locale.ENGLISH, &quot;http://%s:%s/_blobs/%s&quot;, address.getHostName(), address.getPort(), uri));
            response = client.execute(httpHead, context);

            List&lt;URI&gt; redirectLocations = context.getRedirectLocations();
            if (redirectLocations == null) {
                // client might not follow redirects automatically
                if (response.containsHeader(&quot;location&quot;)) {
                    List&lt;String&gt; redirects = new ArrayList&lt;&gt;(1);
                    for (Header location : response.getHeaders(&quot;location&quot;)) {
                        redirects.add(location.getValue());
                    }
                    return redirects;
                }
                return Collections.emptyList();
            }

            List&lt;String&gt; redirects = new ArrayList&lt;&gt;(1);
            for (URI redirectLocation : redirectLocations) {
                redirects.add(redirectLocation.toString());
            }
            return redirects;
        } finally {
            if (response != null) {
                IOUtils.closeWhileHandlingException(response);
            }
        }
    }

    public int getNumberOfRedirects(String uri, InetSocketAddress address) throws IOException {
        return getRedirectLocations(httpClient, uri, address).size();
    }

}
</PRE>
</div>
  </div>
</body>
</html>
