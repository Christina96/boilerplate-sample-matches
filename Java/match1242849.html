<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for DateFormatFunction.java &amp; UsersPrivilegesMetadata.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for DateFormatFunction.java &amp; UsersPrivilegesMetadata.java
      </h3>
<h1 align="center">
        14.5%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>DateFormatFunction.java (44.628098%)<th>UsersPrivilegesMetadata.java (8.723748%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(44-71)<td><a href="#" name="0">(316-320)</a><td align="center"><font color="#ff0000">17</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(115-126)<td><a href="#" name="1">(383-394)</a><td align="center"><font color="#e10000">15</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(24-38)<td><a href="#" name="2">(38-51)</a><td align="center"><font color="#b40000">12</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(83-88)<td><a href="#" name="3">(66-79)</a><td align="center"><font color="#960000">10</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>DateFormatFunction.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <a name="2"></a>
2 package io.crate.expression.scalar;
3 <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import io.crate.data.Input;
4 import io.crate.metadata.NodeContext;
5 import io.crate.metadata.Scalar;
6 import io.crate.metadata.TransactionContext;
7 import io.crate.metadata.functions.Signature;
8 import io.crate.types.DataType;
9 import io.crate.types.DataTypes;
10 import org.joda.time.DateTime;
11 import org.joda.time.DateTimeZone;
12 import java.util.List;
13 public class DateFormatFunction extends Scalar&lt;String, Object&gt; {
14     public static final String NAME = "date_format"</b></font>;
15     public static final String DEFAULT_FORMAT = "%Y-%m-%dT%H:%i:%s.%fZ";
16 <a name="0"></a>    public static void register(ScalarFunctionModule module) {
17         List&lt;DataType&lt;?&gt;&gt; supportedTimestampTypes = List.of(
18             DataTypes.TIMESTAMPZ, DataTypes.TIMESTAMP, DataTypes.LONG);
19         for (<font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>DataType&lt;?&gt; dataType : supportedTimestampTypes) {
20             module.register(
21                 Signature.scalar(
22                     NAME,
23                     dataType.getTypeSignature(),
24                     DataTypes.STRING.getTypeSignature()
25                 ), DateFormatFunction::new
26             );
27             module.register(
28                 Signature.scalar(
29                     NAME,
30                     DataTypes.STRING.getTypeSignature(),
31                     dataType.getTypeSignature(),
32                     DataTypes.STRING.getTypeSignature()
33                 ), DateFormatFunction::new
34             );
35             module.register(
36                 Signature.scalar(
37                     NAME,
38                     DataTypes.STRING.getTypeSignature(),
39                     DataTypes.STRING.getTypeSignature(),
40                     dataType.getTypeSignature(),
41                     DataTypes.STRING.getTypeSignature</b></font>()
42                 ), DateFormatFunction::new
43             );
44         }
45     }
46     private final Signature signature;
47     private final Signature boundSignature;
48 <a name="3"></a>    public DateFormatFunction(Signature signature, Signature boundSignature) {
49         this.signature = signature;
50         this.boundSignature = boundSignature;
51     <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>}
52     @Override
53     public String evaluate(TransactionContext txnCtx, NodeContext nodeCtx, Input&lt;Object&gt;... args) {
54         String format;
55         Input&lt;?&gt; timezoneLiteral = null</b></font>;
56         if (args.length == 1) {
57             format = DEFAULT_FORMAT;
58         } else {
59             format = (String) args[0].value();
60             if (format == null) {
61                 return null;
62             }
63             if (args.length == 3) {
64                 timezoneLiteral = args[1];
65             }
66         }
67         Object tsValue = args[args.length - 1].value();
68         if (tsValue == null) {
69             return null;
70         }
71         Long timestamp = DataTypes.TIMESTAMPZ.sanitizeValue(tsValue);
72         DateTimeZone timezone = DateTimeZone.UTC;
73         if (timezoneLiteral != null) {
74             Object timezoneValue = timezoneLiteral.value();
75             if (timezoneValue == null) {
76                 return null;
77             }
78             timezone = TimeZoneParser.parseTimeZone((String) timezoneValue);
79 <a name="1"></a>        }
80         DateTime dateTime = new DateTime(timestamp, timezone);
81         return TimestampFormatter.format(format, dateTime);
82     <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>}
83     @Override
84     public Signature signature() {
85         return signature;
86     }
87     @Override
88     public Signature boundSignature() {
89         return boundSignature;
90     }
91 }</b></font>
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>UsersPrivilegesMetadata.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 package io.crate.user.metadata;
2 import io.crate.common.annotations.VisibleForTesting;
3 import io.crate.user.Privilege;
4 import io.crate.user.Privilege.State;
5 import io.crate.metadata.RelationName;
6 import io.crate.user.PrivilegeIdent;
7 import org.elasticsearch.ElasticsearchParseException;
8 import org.elasticsearch.Version;
9 import org.elasticsearch.cluster.AbstractNamedDiffable;
10 import org.elasticsearch.cluster.metadata.Metadata;
11 import org.elasticsearch.common.io.stream.StreamInput;
12 import org.elasticsearch.common.io.stream.StreamOutput;
13 <a name="2"></a>import org.elasticsearch.common.xcontent.XContentBuilder;
14 import org.elasticsearch.common.xcontent.XContentParser;
15 <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import javax.annotation.Nullable;
16 import java.io.IOException;
17 import java.util.Collection;
18 import java.util.EnumSet;
19 import java.util.HashMap;
20 import java.util.HashSet;
21 import java.util.Iterator;
22 import java.util.Map;
23 import java.util.Objects;
24 import java.util.Set;
25 public class UsersPrivilegesMetadata extends AbstractNamedDiffable&lt;Metadata.Custom&gt; implements Metadata.Custom {
26     public static final String TYPE = "users_privileges"</b></font>;
27     public static UsersPrivilegesMetadata copyOf(@Nullable UsersPrivilegesMetadata oldMetadata) {
28         if (oldMetadata == null) {
29             return new UsersPrivilegesMetadata();
30         }
31         Map&lt;String, Set&lt;Privilege&gt;&gt; userPrivileges = new HashMap&lt;&gt;(oldMetadata.usersPrivileges.size());
32         for (Map.Entry&lt;String, Set&lt;Privilege&gt;&gt; entry : oldMetadata.usersPrivileges.entrySet()) {
33 <a name="3"></a>            userPrivileges.put(entry.getKey(), new HashSet&lt;&gt;(entry.getValue()));
34         }
35         return new UsersPrivilegesMetadata(userPrivileges);
36     <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>}
37     @Nullable
38     public static UsersPrivilegesMetadata maybeCopyAndReplaceTableIdents(UsersPrivilegesMetadata oldMetadata,
39                                                                          String sourceIdent,
40                                                                          String targetIdent) {
41         boolean privilegesChanged = false;
42         Map&lt;String, Set&lt;Privilege&gt;&gt; userPrivileges = new HashMap&lt;&gt;(oldMetadata.usersPrivileges.size())</b></font>;
43         for (Map.Entry&lt;String, Set&lt;Privilege&gt;&gt; entry : oldMetadata.usersPrivileges.entrySet()) {
44             Set&lt;Privilege&gt; privileges = new HashSet&lt;&gt;(entry.getValue().size());
45             for (Privilege privilege : entry.getValue()) {
46                 PrivilegeIdent privilegeIdent = privilege.ident();
47                 if (privilegeIdent.clazz().equals(Privilege.Clazz.TABLE) == false) {
48                     privileges.add(privilege);
49                     continue;
50                 }
51                 String ident = privilegeIdent.ident();
52                 assert ident != null : "ident must not be null for privilege class 'TABLE'";
53                 if (ident.equals(sourceIdent)) {
54                     privileges.add(new Privilege(privilege.state(), privilegeIdent.type(), privilegeIdent.clazz(),
55                         targetIdent, privilege.grantor()));
56                     privilegesChanged = true;
57                 } else {
58                     privileges.add(privilege);
59                 }
60             }
61             userPrivileges.put(entry.getKey(), privileges);
62         }
63         if (privilegesChanged) {
64             return new UsersPrivilegesMetadata(userPrivileges);
65         }
66         return null;
67     }
68     private final Map&lt;String, Set&lt;Privilege&gt;&gt; usersPrivileges;
69     @VisibleForTesting
70     public UsersPrivilegesMetadata() {
71         usersPrivileges = new HashMap&lt;&gt;();
72     }
73     @VisibleForTesting
74     public UsersPrivilegesMetadata(Map&lt;String, Set&lt;Privilege&gt;&gt; usersPrivileges) {
75         this.usersPrivileges = usersPrivileges;
76     }
77     public static UsersPrivilegesMetadata swapPrivileges(UsersPrivilegesMetadata usersPrivileges,
78                                                          RelationName source,
79                                                          RelationName target) {
80         HashMap&lt;String, Set&lt;Privilege&gt;&gt; privilegesByUser = new HashMap&lt;&gt;();
81         for (Map.Entry&lt;String, Set&lt;Privilege&gt;&gt; userPrivileges : usersPrivileges.usersPrivileges.entrySet()) {
82             String user = userPrivileges.getKey();
83             Set&lt;Privilege&gt; privileges = userPrivileges.getValue();
84             Set&lt;Privilege&gt; updatedPrivileges = new HashSet&lt;&gt;();
85             for (Privilege privilege : privileges) {
86                 PrivilegeIdent ident = privilege.ident();
87                 if (ident.clazz() == Privilege.Clazz.TABLE) {
88                     if (source.fqn().equals(ident.ident())) {
89                         updatedPrivileges.add(
90                             new Privilege(privilege.state(), ident.type(), ident.clazz(), target.fqn(), privilege.grantor()));
91                     } else if (target.fqn().equals(ident.ident())) {
92                         updatedPrivileges.add(
93                             new Privilege(privilege.state(), ident.type(), ident.clazz(), source.fqn(), privilege.grantor()));
94                     } else {
95                         updatedPrivileges.add(privilege);
96                     }
97                 } else {
98                     updatedPrivileges.add(privilege);
99                 }
100             }
101             privilegesByUser.put(user, updatedPrivileges);
102         }
103         return new UsersPrivilegesMetadata(privilegesByUser);
104     }
105     public long applyPrivileges(Collection&lt;String&gt; userNames, Iterable&lt;Privilege&gt; newPrivileges) {
106         long affectedPrivileges = 0L;
107         for (String userName : userNames) {
108             affectedPrivileges += applyPrivilegesToUser(userName, newPrivileges);
109         }
110         return affectedPrivileges;
111     }
112     private long applyPrivilegesToUser(String userName, Iterable&lt;Privilege&gt; newPrivileges) {
113         Set&lt;Privilege&gt; userPrivileges = usersPrivileges.get(userName);
114         assert userPrivileges != null : "privileges must not be null for user=" + userName;
115         long affectedCount = 0L;
116         for (Privilege newPrivilege : newPrivileges) {
117             Iterator&lt;Privilege&gt; iterator = userPrivileges.iterator();
118             boolean userHadPrivilegeOnSameObject = false;
119             while (iterator.hasNext()) {
120                 Privilege userPrivilege = iterator.next();
121                 PrivilegeIdent privilegeIdent = userPrivilege.ident();
122                 if (privilegeIdent.equals(newPrivilege.ident())) {
123                     userHadPrivilegeOnSameObject = true;
124                     if (newPrivilege.state().equals(State.REVOKE)) {
125                         iterator.remove();
126                         affectedCount++;
127                         break;
128                     } else {
129                         if (userPrivilege.equals(newPrivilege) == false) {
130                             iterator.remove();
131                             userPrivileges.add(newPrivilege);
132                             affectedCount++;
133                         }
134                         break;
135                     }
136                 }
137             }
138             if (userHadPrivilegeOnSameObject == false &amp;&amp; newPrivilege.state().equals(State.REVOKE) == false) {
139                 affectedCount++;
140                 userPrivileges.add(newPrivilege);
141             }
142         }
143         return affectedCount;
144     }
145     public long dropTableOrViewPrivileges(String tableOrViewIdent) {
146         long affectedPrivileges = 0L;
147         for (Set&lt;Privilege&gt; privileges : usersPrivileges.values()) {
148             Iterator&lt;Privilege&gt; privilegeIterator = privileges.iterator();
149             while (privilegeIterator.hasNext()) {
150                 Privilege privilege = privilegeIterator.next();
151                 PrivilegeIdent privilegeIdent = privilege.ident();
152                 Privilege.Clazz clazz = privilegeIdent.clazz();
153                 if (clazz.equals(Privilege.Clazz.TABLE) == false &amp;&amp; clazz.equals(Privilege.Clazz.VIEW) == false) {
154                     continue;
155                 }
156                 String ident = privilegeIdent.ident();
157                 assert ident != null : "ident must not be null for privilege class 'TABLE'";
158                 if (ident.equals(tableOrViewIdent)) {
159                     privilegeIterator.remove();
160                     affectedPrivileges++;
161                 }
162             }
163         }
164         return affectedPrivileges;
165     }
166     @Nullable
167     public Set&lt;Privilege&gt; getUserPrivileges(String userName) {
168         return usersPrivileges.get(userName);
169     }
170     public void createPrivileges(String userName, Set&lt;Privilege&gt; privileges) {
171         usersPrivileges.put(userName, privileges);
172     }
173     public void dropPrivileges(String userName) {
174         usersPrivileges.remove(userName);
175     }
176     @Override
177     public boolean equals(Object o) {
178         if (this == o) return true;
179         if (o == null || getClass() != o.getClass()) return false;
180         UsersPrivilegesMetadata that = (UsersPrivilegesMetadata) o;
181         return Objects.equals(usersPrivileges, that.usersPrivileges);
182     }
183     @Override
184     public int hashCode() {
185         return Objects.hash(usersPrivileges);
186     }
187     public UsersPrivilegesMetadata(StreamInput in) throws IOException {
188         int numUsersPrivileges = in.readVInt();
189         usersPrivileges = new HashMap&lt;&gt;(numUsersPrivileges);
190         for (int i = 0; i &lt; numUsersPrivileges; i++) {
191             String userName = in.readString();
192             int numPrivileges = in.readVInt();
193             Set&lt;Privilege&gt; privileges = new HashSet&lt;&gt;(numPrivileges);
194             for (int j = 0; j &lt; numPrivileges; j++) {
195                 privileges.add(new Privilege(in));
196             }
197             usersPrivileges.put(userName, privileges);
198         }
199     }
200     @Override
201     public void writeTo(StreamOutput out) throws IOException {
202         out.writeVInt(usersPrivileges.size());
203         for (Map.Entry&lt;String, Set&lt;Privilege&gt;&gt; entry : usersPrivileges.entrySet()) {
204             out.writeString(entry.getKey());
205             out.writeVInt(entry.getValue().size());
206             for (Privilege privilege : entry.getValue()) {
207                 privilege.writeTo(out);
208             }
209         }
210     }
211     @Override
212     public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {
213         for (Map.Entry&lt;String, Set&lt;Privilege&gt;&gt; entry : usersPrivileges.entrySet()) {
214             builder.startArray(entry.getKey());
215             for (Privilege privilege : entry.getValue()) {
216                 privilegeToXContent(privilege, builder);
217             }
218             builder.endArray();
219         }
220         return builder;
221     }
222     public static UsersPrivilegesMetadata fromXContent(XContentParser parser) throws IOException {
223         UsersPrivilegesMetadata metadata = new UsersPrivilegesMetadata();
224         while (parser.nextToken() == XContentParser.Token.FIELD_NAME) {
225             String userName = parser.currentName();
226             Set&lt;Privilege&gt; privileges = metadata.getUserPrivileges(userName);
227             if (privileges == null) {
228                 privileges = new HashSet&lt;&gt;();
229                 metadata.createPrivileges(userName, privileges);
230             }
231             XContentParser.Token token;
232             while ((token = parser.nextToken()) != XContentParser.Token.END_ARRAY) {
233                 if (token == XContentParser.Token.START_OBJECT) {
234                     privilegeFromXContent(parser, privileges);
235                 }
236             }
237         }
238         return metadata;
239     }
240     @Override
241     public EnumSet&lt;Metadata.XContentContext&gt; context() {
242 <a name="0"></a>        return EnumSet.of(Metadata.XContentContext.GATEWAY, Metadata.XContentContext.SNAPSHOT);
243     }
244     private static void privilegeToXContent(Privilege privilege, <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>XContentBuilder builder) throws IOException {
245         builder.startObject()
246             .field("state", privilege.state().ordinal())
247             .field("type", privilege.ident().type().ordinal())
248             .field("class", privilege.ident</b></font>().clazz().ordinal())
249             .field("ident", privilege.ident().ident())
250             .field("grantor", privilege.grantor())
251             .endObject();
252     }
253     private static void privilegeFromXContent(XContentParser parser, Set&lt;Privilege&gt; privileges) throws IOException {
254         XContentParser.Token currentToken;
255         State state = null;
256         Privilege.Type type = null;
257         Privilege.Clazz clazz = null;
258         String ident = null;
259         String grantor = null;
260         while ((currentToken = parser.nextToken()) != XContentParser.Token.END_OBJECT) {
261             if (currentToken == XContentParser.Token.FIELD_NAME) {
262                 String currentFieldName = parser.currentName();
263                 currentToken = parser.nextToken();
264                 switch (currentFieldName) {
265                     case "state":
266                         if (currentToken != XContentParser.Token.VALUE_NUMBER) {
267                             throw new ElasticsearchParseException(
268                                 "failed to parse privilege, 'state' value is not a number [{}]", currentToken);
269                         }
270                         state = State.values()[parser.intValue()];
271                         break;
272                     case "type":
273                         if (currentToken != XContentParser.Token.VALUE_NUMBER) {
274                             throw new ElasticsearchParseException(
275                                 "failed to parse privilege, 'type' value is not a number [{}]", currentToken);
276                         }
277                         type = Privilege.Type.values()[parser.intValue()];
278                         break;
279                     case "class":
280                         if (currentToken != XContentParser.Token.VALUE_NUMBER) {
281                             throw new ElasticsearchParseException(
282                                 "failed to parse privilege, 'class' value is not a number [{}]", currentToken);
283                         }
284                         clazz = Privilege.Clazz.values()[parser.intValue()];
285                         break;
286                     case "ident":
287                         if (currentToken != XContentParser.Token.VALUE_STRING
288                             &amp;&amp; currentToken != XContentParser.Token.VALUE_NULL) {
289                             throw new ElasticsearchParseException(
290                                 "failed to parse privilege, 'ident' value is not a string or null [{}]", currentToken);
291                         }
292                         ident = parser.textOrNull();
293                         break;
294                     case "grantor":
295                         if (currentToken != XContentParser.Token.VALUE_STRING) {
296                             throw new ElasticsearchParseException(
297                                 "failed to parse privilege, 'grantor' value is not a string [{}]", currentToken);
298                         }
299                         grantor = parser.text();
300                         break;
301                     default:
302                         throw new ElasticsearchParseException("failed to parse privilege");
303                 }
304             } else if (currentToken == XContentParser.Token.END_ARRAY) {
305                 return;
306 <a name="1"></a>            }
307         }
308         privileges.add(new Privilege(state, type, clazz, ident, grantor));
309     <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>}
310     @Override
311     public String getWriteableName() {
312         return TYPE;
313     }
314     @Override
315     public Version getMinimalSupportedVersion() {
316         return Version.V_3_0_1;
317     }
318 }</b></font>
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
