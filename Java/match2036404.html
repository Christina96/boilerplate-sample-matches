<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for SysSnapshotsTest.java &amp; LeaderChecker.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for SysSnapshotsTest.java &amp; LeaderChecker.java
      </h3>
<h1 align="center">
        10.7%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>SysSnapshotsTest.java (21.830986%)<th>LeaderChecker.java (7.1264367%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(22-47)<td><a href="#" name="0">(20-42)</a><td align="center"><font color="#ff0000">22</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(87-95)<td><a href="#" name="1">(207-210)</a><td align="center"><font color="#680000">9</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>SysSnapshotsTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>package io.crate.integrationtests;
2 import static org.hamcrest.Matchers.arrayContaining;
3 import static org.hamcrest.Matchers.greaterThanOrEqualTo;
4 import static org.hamcrest.Matchers.is;
5 import static org.hamcrest.Matchers.lessThanOrEqualTo;
6 import java.util.List;
7 import org.elasticsearch.Version;
8 import org.elasticsearch.common.settings.Settings;
9 import org.elasticsearch.snapshots.SnapshotState;
10 import org.elasticsearch.test.ESIntegTestCase;
11 import org.elasticsearch.threadpool.ThreadPool;
12 import org.hamcrest.Matchers;
13 import org.junit.ClassRule;
14 import org.junit.Test;
15 import org.junit.rules.TemporaryFolder;
16 import io.crate.testing.TestingHelpers;
17 import io.crate.testing.UseJdbc;
18 import io.crate.types.ArrayType;
19 import io.crate.types.DataTypes;
20 import io.crate.types.ObjectType;
21 import io.crate.types.StringType;
22 import</b></font> io.crate.types.TimestampType;
23 @ESIntegTestCase.ClusterScope()
24 @UseJdbc(0) public class SysSnapshotsTest extends SQLIntegrationTestCase {
25     @ClassRule
26     public static TemporaryFolder TEMP_FOLDER = new TemporaryFolder();
27     @Override
28     protected Settings nodeSettings(int nodeOrdinal) {
29         return Settings.builder()
30             .put(super.nodeSettings(nodeOrdinal))
31             .put("path.repo", TEMP_FOLDER.getRoot().getAbsolutePath())
32             .put(ThreadPool.ESTIMATED_TIME_INTERVAL_SETTING.getKey(), 0)             .build();
33     }
34     @Test
35     public void testQueryAllColumns() throws Exception {
36         execute("create table tbl (id int primary key) ");
37         Object[][] bulkArgs = new Object[10][];
38         for (int i = 0; i &lt; 10; i++) {
39             bulkArgs[i] = new Object[] { i };
40         }
41         execute("insert into tbl (id) values (?)", bulkArgs);
42         execute("refresh table tbl");
43         ThreadPool threadPool = internalCluster().getInstance(ThreadPool.class);
44         execute(
45             "CREATE REPOSITORY r1 TYPE fs WITH (location = ?, compress = true)",
46             new Object[] { TEMP_FOLDER.newFolder("backup_s1").getAbsolutePath() });
47         long createdTime = threadPool.absoluteTimeInMillis();
48         execute("CREATE SNAPSHOT r1.s1 TABLE tbl WITH (wait_for_completion = true)");
49         long finishedTime = threadPool.absoluteTimeInMillis();
50         execute("select * from sys.snapshots");
51 <a name="1"></a>        assertThat(response.rowCount(), is(1L));
52         assertThat(response.cols(), arrayContaining("concrete_indices", "failures", "finished", "name", "repository", "started", "state", "table_partitions", "tables", "version"));
53         ArrayType&lt;String&gt; stringArray = new ArrayType&lt;&gt;(DataTypes.STRING);
54         <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(response.columnTypes(), arrayContaining(
55             stringArray,
56             stringArray,
57             TimestampType.INSTANCE_WITH_TZ,
58             StringType.INSTANCE,
59             StringType.INSTANCE,
60             TimestampType.INSTANCE_WITH_TZ,
61             StringType.INSTANCE,
62             new ArrayType&lt;&gt;(ObjectType.builder</b></font>()
63                 .setInnerType("values", stringArray)
64                 .setInnerType("table_schema", StringType.INSTANCE)
65                 .setInnerType("table_name", StringType.INSTANCE)
66                 .build()
67             ),
68             stringArray,
69             StringType.INSTANCE
70         ));
71         Object[] firstRow = response.rows()[0];
72         assertThat((List&lt;Object&gt;) firstRow[0], Matchers.contains(getFqn("tbl")));
73         assertThat((List&lt;Object&gt;) firstRow[1], Matchers.empty());
74         assertThat((Long) firstRow[2], lessThanOrEqualTo(finishedTime));
75         assertThat(firstRow[3], is("s1"));
76         assertThat(firstRow[4], is("r1"));
77         assertThat((Long) firstRow[5], greaterThanOrEqualTo(createdTime));
78         assertThat(firstRow[6], is(SnapshotState.SUCCESS.name()));
79         assertThat((List&lt;Object&gt;) firstRow[7], Matchers.empty());
80         assertThat((List&lt;Object&gt;) firstRow[8], Matchers.contains(getFqn("tbl")));
81         assertThat(firstRow[9], is(Version.CURRENT.toString()));
82     }
83     @Test
84     public void test_sys_snapshots_returns_table_partition_information() throws Exception {
85         execute("create table tbl (x int, p int) clustered into 1 shards partitioned by (p)");
86         execute("insert into tbl (x, p) values (1, 1), (2, 2)");
87         execute("refresh table tbl");
88         execute(
89             "CREATE REPOSITORY r1 TYPE fs WITH (location = ?, compress = true)",
90             new Object[] { TEMP_FOLDER.newFolder("backup_s2").getAbsolutePath() });
91         execute("CREATE SNAPSHOT r1.s2 TABLE tbl WITH (wait_for_completion = true)");
92         execute("select x['table_name'], unnest(x['values']::string[]) "
93             + "from (select unnest(table_partitions) from sys.snapshots) t (x) order by 2");
94         assertThat(TestingHelpers.printedTable(response.rows()), is(
95             "tbl| 1\n" +
96             "tbl| 2\n"
97         ));
98     }
99 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>LeaderChecker.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>package org.elasticsearch.cluster.coordination;
2 import org.apache.logging.log4j.LogManager;
3 import org.apache.logging.log4j.Logger;
4 import org.apache.logging.log4j.message.ParameterizedMessage;
5 import org.elasticsearch.ElasticsearchException;
6 import org.elasticsearch.cluster.node.DiscoveryNode;
7 import org.elasticsearch.cluster.node.DiscoveryNodes;
8 import javax.annotation.Nullable;
9 import org.elasticsearch.common.io.stream.StreamInput;
10 import org.elasticsearch.common.io.stream.StreamOutput;
11 import org.elasticsearch.common.lease.Releasable;
12 import org.elasticsearch.common.settings.Setting;
13 import org.elasticsearch.common.settings.Settings;
14 import io.crate.common.unit.TimeValue;
15 import org.elasticsearch.threadpool.ThreadPool.Names;
16 import org.elasticsearch.transport.ConnectTransportException;
17 import org.elasticsearch.transport.Transport;
18 import org.elasticsearch.transport.NodeDisconnectedException;
19 import org.elasticsearch.transport.TransportConnectionListener;
20 import org.elasticsearch.transport.TransportException;
21 import org.elasticsearch.transport.TransportRequest;
22 import</b></font> org.elasticsearch.transport.TransportRequestOptions;
23 import org.elasticsearch.transport.TransportRequestOptions.Type;
24 import org.elasticsearch.transport.TransportResponse;
25 import org.elasticsearch.transport.TransportResponse.Empty;
26 import org.elasticsearch.transport.TransportResponseHandler;
27 import org.elasticsearch.transport.TransportService;
28 import java.io.IOException;
29 import java.util.Objects;
30 import java.util.concurrent.atomic.AtomicBoolean;
31 import java.util.concurrent.atomic.AtomicLong;
32 import java.util.concurrent.atomic.AtomicReference;
33 import java.util.function.Consumer;
34 public class LeaderChecker {
35     private static final Logger LOGGER = LogManager.getLogger(LeaderChecker.class);
36     public static final String LEADER_CHECK_ACTION_NAME = "internal:coordination/fault_detection/leader_check";
37     public static final Setting&lt;TimeValue&gt; LEADER_CHECK_INTERVAL_SETTING =
38         Setting.timeSetting("cluster.fault_detection.leader_check.interval",
39             TimeValue.timeValueMillis(1000), TimeValue.timeValueMillis(100), Setting.Property.NodeScope);
40     public static final Setting&lt;TimeValue&gt; LEADER_CHECK_TIMEOUT_SETTING =
41         Setting.timeSetting("cluster.fault_detection.leader_check.timeout",
42             TimeValue.timeValueMillis(10000), TimeValue.timeValueMillis(1), Setting.Property.NodeScope);
43     public static final Setting&lt;Integer&gt; LEADER_CHECK_RETRY_COUNT_SETTING =
44         Setting.intSetting("cluster.fault_detection.leader_check.retry_count", 3, 1, Setting.Property.NodeScope);
45     private final TimeValue leaderCheckInterval;
46     private final TimeValue leaderCheckTimeout;
47     private final int leaderCheckRetryCount;
48     private final TransportService transportService;
49     private final Consumer&lt;Exception&gt; onLeaderFailure;
50     private AtomicReference&lt;CheckScheduler&gt; currentChecker = new AtomicReference&lt;&gt;();
51     private volatile DiscoveryNodes discoveryNodes;
52     public LeaderChecker(final Settings settings, final TransportService transportService, final Consumer&lt;Exception&gt; onLeaderFailure) {
53         leaderCheckInterval = LEADER_CHECK_INTERVAL_SETTING.get(settings);
54         leaderCheckTimeout = LEADER_CHECK_TIMEOUT_SETTING.get(settings);
55         leaderCheckRetryCount = LEADER_CHECK_RETRY_COUNT_SETTING.get(settings);
56         this.transportService = transportService;
57         this.onLeaderFailure = onLeaderFailure;
58         transportService.registerRequestHandler(LEADER_CHECK_ACTION_NAME, Names.SAME, false, false, LeaderCheckRequest::new,
59             (request, channel) -&gt; {
60                 handleLeaderCheck(request);
61                 channel.sendResponse(Empty.INSTANCE);
62             });
63         transportService.addConnectionListener(new TransportConnectionListener() {
64             @Override
65             public void onNodeDisconnected(DiscoveryNode node, Transport.Connection connection) {
66                 handleDisconnectedNode(node);
67             }
68         });
69     }
70     public DiscoveryNode leader() {
71         CheckScheduler checkScheduler = currentChecker.get();
72         return checkScheduler == null ? null : checkScheduler.leader;
73     }
74     public void updateLeader(@Nullable final DiscoveryNode leader) {
75         assert transportService.getLocalNode().equals(leader) == false;
76         final CheckScheduler checkScheduler;
77         if (leader != null) {
78             checkScheduler = new CheckScheduler(leader);
79         } else {
80             checkScheduler = null;
81         }
82         CheckScheduler previousChecker = currentChecker.getAndSet(checkScheduler);
83         if (previousChecker != null) {
84             previousChecker.close();
85         }
86         if (checkScheduler != null) {
87             checkScheduler.handleWakeUp();
88         }
89     }
90     public void setCurrentNodes(DiscoveryNodes discoveryNodes) {
91         LOGGER.trace("setCurrentNodes: {}", discoveryNodes);
92         this.discoveryNodes = discoveryNodes;
93     }
94     boolean currentNodeIsMaster() {
95         return discoveryNodes.isLocalNodeElectedMaster();
96     }
97     private void handleLeaderCheck(LeaderCheckRequest request) {
98         final DiscoveryNodes discoveryNodes = this.discoveryNodes;
99         assert discoveryNodes != null;
100         if (discoveryNodes.isLocalNodeElectedMaster() == false) {
101             LOGGER.debug("non-master handling {}", request);
102             throw new CoordinationStateRejectedException("non-leader rejecting leader check");
103         } else if (discoveryNodes.nodeExists(request.getSender()) == false) {
104             LOGGER.debug("leader check from unknown node: {}", request);
105             throw new CoordinationStateRejectedException("leader check from unknown node");
106         } else {
107             LOGGER.trace("handling {}", request);
108         }
109     }
110     private void handleDisconnectedNode(DiscoveryNode discoveryNode) {
111         CheckScheduler checkScheduler = currentChecker.get();
112         if (checkScheduler != null) {
113             checkScheduler.handleDisconnectedNode(discoveryNode);
114         } else {
115             LOGGER.trace("disconnect event ignored for {}, no check scheduler", discoveryNode);
116         }
117     }
118     private class CheckScheduler implements Releasable {
119         private final AtomicBoolean isClosed = new AtomicBoolean();
120         private final AtomicLong failureCountSinceLastSuccess = new AtomicLong();
121         private final DiscoveryNode leader;
122         CheckScheduler(final DiscoveryNode leader) {
123             this.leader = leader;
124         }
125         @Override
126         public void close() {
127             if (isClosed.compareAndSet(false, true) == false) {
128                 LOGGER.trace("already closed, doing nothing");
129             } else {
130                 LOGGER.debug("closed");
131             }
132         }
133         void handleWakeUp() {
134             if (isClosed.get()) {
135                 LOGGER.trace("closed check scheduler woken up, doing nothing");
136 <a name="1"></a>                return;
137             }
138             <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>LOGGER.trace("checking {} with [{}] = {}", leader, LEADER_CHECK_TIMEOUT_SETTING.getKey(), leaderCheckTimeout);
139             transportService.sendRequest(leader, LEADER_CHECK_ACTION_NAME, new LeaderCheckRequest(transportService.getLocalNode()),
140                 TransportRequestOptions.builder</b></font>().withTimeout(leaderCheckTimeout).withType(Type.PING).build(),
141                 new TransportResponseHandler&lt;TransportResponse.Empty&gt;() {
142                     @Override
143                     public Empty read(StreamInput in) {
144                         return Empty.INSTANCE;
145                     }
146                     @Override
147                     public void handleResponse(Empty response) {
148                         if (isClosed.get()) {
149                             LOGGER.debug("closed check scheduler received a response, doing nothing");
150                             return;
151                         }
152                         failureCountSinceLastSuccess.set(0);
153                         scheduleNextWakeUp();                     }
154                     @Override
155                     public void handleException(TransportException exp) {
156                         if (isClosed.get()) {
157                             LOGGER.debug("closed check scheduler received a response, doing nothing");
158                             return;
159                         }
160                         if (exp instanceof ConnectTransportException || exp.getCause() instanceof ConnectTransportException) {
161                             LOGGER.debug(new ParameterizedMessage(
162                                 "leader [{}] disconnected during check", leader), exp);
163                             leaderFailed(new ConnectTransportException(leader, "disconnected during check", exp));
164                             return;
165                         }
166                         long failureCount = failureCountSinceLastSuccess.incrementAndGet();
167                         if (failureCount &gt;= leaderCheckRetryCount) {
168                             LOGGER.debug(new ParameterizedMessage(
169                                 "leader [{}] has failed {} consecutive checks (limit [{}] is {}); last failure was:",
170                                 leader, failureCount, LEADER_CHECK_RETRY_COUNT_SETTING.getKey(), leaderCheckRetryCount), exp);
171                             leaderFailed(new ElasticsearchException(
172                                 "node [" + leader + "] failed [" + failureCount + "] consecutive checks", exp));
173                             return;
174                         }
175                         LOGGER.debug(new ParameterizedMessage("{} consecutive failures (limit [{}] is {}) with leader [{}]",
176                             failureCount, LEADER_CHECK_RETRY_COUNT_SETTING.getKey(), leaderCheckRetryCount, leader), exp);
177                         scheduleNextWakeUp();
178                     }
179                     @Override
180                     public String executor() {
181                         return Names.SAME;
182                     }
183                 });
184         }
185         void leaderFailed(Exception e) {
186             if (isClosed.compareAndSet(false, true)) {
187                 transportService.getThreadPool().generic().execute(new Runnable() {
188                     @Override
189                     public void run() {
190                         onLeaderFailure.accept(e);
191                     }
192                     @Override
193                     public String toString() {
194                         return "notification of leader failure: " + e.getMessage();
195                     }
196                 });
197             } else {
198                 LOGGER.trace("already closed, not failing leader");
199             }
200         }
201         void handleDisconnectedNode(DiscoveryNode discoveryNode) {
202             if (discoveryNode.equals(leader)) {
203                 LOGGER.debug("leader [{}] disconnected", leader);
204                 leaderFailed(new NodeDisconnectedException(discoveryNode, "disconnected"));
205             }
206         }
207         private void scheduleNextWakeUp() {
208             LOGGER.trace("scheduling next check of {} for [{}] = {}", leader, LEADER_CHECK_INTERVAL_SETTING.getKey(), leaderCheckInterval);
209             transportService.getThreadPool().schedule(new Runnable() {
210                 @Override
211                 public void run() {
212                     handleWakeUp();
213                 }
214                 @Override
215                 public String toString() {
216                     return "scheduled check of leader " + leader;
217                 }
218             }, leaderCheckInterval, Names.SAME);
219         }
220     }
221     public static class LeaderCheckRequest extends TransportRequest {
222         private final DiscoveryNode sender;
223         public LeaderCheckRequest(final DiscoveryNode sender) {
224             this.sender = sender;
225         }
226         public LeaderCheckRequest(final StreamInput in) throws IOException {
227             super(in);
228             sender = new DiscoveryNode(in);
229         }
230         @Override
231         public void writeTo(final StreamOutput out) throws IOException {
232             super.writeTo(out);
233             sender.writeTo(out);
234         }
235         public DiscoveryNode getSender() {
236             return sender;
237         }
238         @Override
239         public boolean equals(final Object o) {
240             if (this == o) return true;
241             if (o == null || getClass() != o.getClass()) return false;
242             final LeaderCheckRequest that = (LeaderCheckRequest) o;
243             return Objects.equals(sender, that.sender);
244         }
245         @Override
246         public int hashCode() {
247             return Objects.hash(sender);
248         }
249         @Override
250         public String toString() {
251             return "LeaderCheckRequest{" +
252                 "sender=" + sender +
253                 '}';
254         }
255     }
256 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
