<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for ShardStatsTest.java & GeoJSONUtilsTest.java</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for ShardStatsTest.java & GeoJSONUtilsTest.java
      </h3>
      <h1 align="center">
        24.8%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>ShardStatsTest.java (39.84375%)<TH>GeoJSONUtilsTest.java (18.085106%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match367786-0.html#0',2,'match367786-1.html#0',3)" NAME="0">(81-89)<TD><A HREF="javascript:ZweiFrames('match367786-0.html#0',2,'match367786-1.html#0',3)" NAME="0">(116-123)</A><TD ALIGN=center><FONT COLOR="#ff0000">16</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match367786-0.html#1',2,'match367786-1.html#1',3)" NAME="1">(36-47)<TD><A HREF="javascript:ZweiFrames('match367786-0.html#1',2,'match367786-1.html#1',3)" NAME="1">(153-161)</A><TD ALIGN=center><FONT COLOR="#cf0000">13</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match367786-0.html#2',2,'match367786-1.html#2',3)" NAME="2">(96-105)<TD><A HREF="javascript:ZweiFrames('match367786-0.html#2',2,'match367786-1.html#2',3)" NAME="2">(195-209)</A><TD ALIGN=center><FONT COLOR="#bf0000">12</FONT>
<TR><TD BGCOLOR="#53858b"><FONT COLOR="#53858b">-</FONT><TD><A HREF="javascript:ZweiFrames('match367786-0.html#3',2,'match367786-1.html#3',3)" NAME="3">(48-58)<TD><A HREF="javascript:ZweiFrames('match367786-0.html#3',2,'match367786-1.html#3',3)" NAME="3">(167-175)</A><TD ALIGN=center><FONT COLOR="#9f0000">10</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>ShardStatsTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
 * software solely pursuant to the terms of the relevant commercial agreement.
 */

package io.crate.integrationtests;

import org.elasticsearch.test.ESIntegTestCase;
import org.junit.Test;

import static io.crate.testing.TestingHelpers.printedTable;
import static org.hamcrest.Matchers.greaterThanOrEqualTo;
import static org.hamcrest.Matchers.is;

@ESIntegTestCase.ClusterScope(numDataNodes = 2)
public class ShardStatsTest extends SQLIntegrationTestCase {
<A NAME="1"></A>
    @Test
    public void testSelectZeroLimit() throws Exception {
        <FONT color="#f63526"><A HREF="javascript:ZweiFrames('match367786-1.html#1',3,'match367786-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>execute(&quot;create table test (col1 int) clustered into 3 shards with (number_of_replicas=0)&quot;);
        ensureGreen();
        execute(&quot;select * from sys.shards limit 0&quot;);
        assertEquals(0L, response.rowCount());
    }

    @Test
    public void testShardSelect() throws Exception {
        execute(&quot;create table test (col1 int) clustered into 3 shards with (number_of_replicas=0)&quot;);
<A NAME="3"></A>        ensureGreen();

        execute</B></FONT>(&quot;select count(*) from sys.shards where table_name='test'&quot;);
        assertEquals(1, <FONT color="#53858b"><A HREF="javascript:ZweiFrames('match367786-1.html#3',3,'match367786-top.html#3',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>response.rowCount());
        assertEquals(3L, response.rows()[0][0]);
    }

    @Test
    public void testSelectIncludingUnassignedShards() throws Exception {
        execute(&quot;create table locations (id integer primary key, name string) &quot; +
                &quot;clustered into 2 shards &quot; +
                &quot;with (number_of_replicas=2, \&quot;write.wait_for_active_shards\&quot;=1)&quot;);

        assertBusy</B></FONT>(() -&gt; {
            execute(&quot;select state, \&quot;primary\&quot;, recovery['stage'] from sys.shards where table_name = 'locations' order by state, \&quot;primary\&quot;&quot;);
            assertThat(
                printedTable(response.rows()),
                is(&quot;STARTED| false| DONE\n&quot; +
                   &quot;STARTED| false| DONE\n&quot; +
                   &quot;STARTED| true| DONE\n&quot; +
                   &quot;STARTED| true| DONE\n&quot; +
                   &quot;UNASSIGNED| false| NULL\n&quot; +
                   &quot;UNASSIGNED| false| NULL\n&quot;)
            );
        });
    }

    @Test
    public void testSelectGroupByIncludingUnassignedShards() throws Exception {
        execute(&quot;create table locations (id integer primary key, name string) &quot; +
                &quot;clustered into 5 shards &quot; +
                &quot;with(number_of_replicas=2 , \&quot;write.wait_for_active_shards\&quot;=1)&quot;);
        ensureYellow();
<A NAME="0"></A>
        execute(&quot;select count(*), state, \&quot;primary\&quot; from sys.shards &quot; +
                &quot;group by state, \&quot;primary\&quot; order by state desc&quot;);
        assertThat(<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match367786-1.html#0',3,'match367786-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>response.rowCount(), greaterThanOrEqualTo(2L));
        assertEquals(3, response.cols().length);
        assertThat((Long) response.rows()[0][0], greaterThanOrEqualTo(5L));
        assertEquals(&quot;UNASSIGNED&quot;, response.rows()[0][1]);
        assertEquals(false, response.rows()[0][2]);
    }

    @Test
    public void testSelectCountIncludingUnassignedShards() throws Exception {</B></FONT>
        execute(&quot;create table locations (id integer primary key, name string) &quot; +
                &quot;clustered into 5 shards &quot; +
                &quot;with(number_of_replicas=2, \&quot;write.wait_for_active_shards\&quot;=1)&quot;);
<A NAME="2"></A>        ensureYellow();

        execute(&quot;select count(*) from sys.shards where table_name='locations'&quot;);
        assertThat(response.rowCount(), <FONT color="#980517"><A HREF="javascript:ZweiFrames('match367786-1.html#2',3,'match367786-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>is(1L));
        assertThat((Long) response.rows()[0][0], is(15L));
    }

    @Test
    public void testTableNameBlobTable() throws Exception {
        execute(&quot;create blob table blobs clustered into 2 shards with (number_of_replicas=0)&quot;);
        ensureGreen();

        execute</B></FONT>(&quot;select schema_name, table_name from sys.shards where table_name = 'blobs'&quot;);
        assertThat(response.rowCount(), is(2L));
        for (int i = 0; i &lt; response.rowCount(); i++) {
            assertThat((String) response.rows()[i][0], is(&quot;blob&quot;));
            assertThat((String) response.rows()[i][1], is(&quot;blobs&quot;));
        }

        execute(&quot;create blob table sbolb clustered into 4 shards &quot; +
            &quot;with (number_of_replicas=0)&quot;);
        ensureYellow();

        execute(&quot;select schema_name, table_name from sys.shards where table_name = 'sbolb'&quot;);
        assertThat(response.rowCount(), is(4L));
        for (int i = 0; i &lt; response.rowCount(); i++) {
            assertThat((String) response.rows()[i][0], is(&quot;blob&quot;));
            assertThat((String) response.rows()[i][1], is(&quot;sbolb&quot;));
        }
        execute(&quot;select count(*) from sys.shards &quot; +
                &quot;where schema_name='blob' and table_name != 'blobs' &quot; +
                &quot;and table_name != 'sbolb'&quot;);
        assertThat(response.rowCount(), is(1L));
        assertThat((Long) response.rows()[0][0], is(0L));
    }
}
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>GeoJSONUtilsTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
 * software solely pursuant to the terms of the relevant commercial agreement.
 */

package io.crate.geo;

import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.Matchers.hasEntry;
import static org.hamcrest.Matchers.hasKey;
import static org.hamcrest.Matchers.instanceOf;
import static org.hamcrest.core.Is.is;
import static org.junit.jupiter.api.Assertions.assertThrows;

import java.util.List;
import java.util.Map;


import org.junit.Test;
import org.locationtech.jts.geom.Coordinate;
import org.locationtech.jts.geom.GeometryFactory;
import org.locationtech.jts.geom.LineString;
import org.locationtech.jts.geom.LinearRing;
import org.locationtech.jts.geom.MultiPolygon;
import org.locationtech.jts.geom.Point;
import org.locationtech.jts.geom.Polygon;
import org.locationtech.jts.geom.impl.CoordinateArraySequenceFactory;
import org.locationtech.spatial4j.context.jts.JtsSpatialContext;
import org.locationtech.spatial4j.io.WKTWriter;
import org.locationtech.spatial4j.shape.Shape;
import org.locationtech.spatial4j.shape.jts.JtsGeometry;
import org.locationtech.spatial4j.shape.jts.JtsPoint;

public class GeoJSONUtilsTest {

    static {
        ClassLoader.getSystemClassLoader().setDefaultAssertionStatus(true);
    }

    private static final GeometryFactory GEOMETRY_FACTORY = new GeometryFactory(CoordinateArraySequenceFactory.instance());

    public final static List&lt;Shape&gt; SHAPES = List.&lt;Shape&gt;of(
        new JtsGeometry(new Polygon(GEOMETRY_FACTORY.createLinearRing(new Coordinate[]{
            new Coordinate(0.0, 1.0),
            new Coordinate(100.0, 0.1),
            new Coordinate(20.0, 23.567),
            new Coordinate(0.0, 1.0)
        }), new LinearRing[0], GEOMETRY_FACTORY), JtsSpatialContext.GEO, true, true),
        new JtsGeometry(new MultiPolygon(
            new Polygon[]{
                new Polygon(GEOMETRY_FACTORY.createLinearRing(new Coordinate[]{
                    new Coordinate(0.0, 1.0),
                    new Coordinate(0.1, 1.1),
                    new Coordinate(1.1, 60.0),
                    new Coordinate(0.0, 1.0)
                }), new LinearRing[0], GEOMETRY_FACTORY),
                new Polygon(GEOMETRY_FACTORY.createLinearRing(new Coordinate[]{
                    new Coordinate(2.0, 1.0),
                    new Coordinate(2.1, 1.1),
                    new Coordinate(2.1, 70.0),
                    new Coordinate(2.0, 1.0)
                }), new LinearRing[0], GEOMETRY_FACTORY)
            },
            GEOMETRY_FACTORY
        ), JtsSpatialContext.GEO, true, true),
        new JtsGeometry(GEOMETRY_FACTORY.createMultiPointFromCoords(new Coordinate[]{
            new Coordinate(0.0, 0.0),
            new Coordinate(1.0, 1.0)
        }), JtsSpatialContext.GEO, true, true),
        new JtsGeometry(GEOMETRY_FACTORY.createMultiLineString(new LineString[]{
            GEOMETRY_FACTORY.createLineString(new Coordinate[]{
                new Coordinate(0.0, 1.0),
                new Coordinate(0.1, 1.1),
                new Coordinate(1.1, 80.0),
                new Coordinate(0.0, 1.0)
            }),
            GEOMETRY_FACTORY.createLineString(new Coordinate[]{
                new Coordinate(2.0, 1.0),
                new Coordinate(2.1, 1.1),
                new Coordinate(2.1, 60.0),
                new Coordinate(2.0, 1.0)
            })
        }), JtsSpatialContext.GEO, true, true)

    );

    @Test
    public void testShape2Map() throws Exception {
        for (Shape shape : SHAPES) {
            Map&lt;String, Object&gt; map = GeoJSONUtils.shape2Map(shape);
            assertThat(map, hasKey(&quot;type&quot;));
            GeoJSONUtils.validateGeoJson(map);
        }
    }

    @Test
<A NAME="0"></A>    public void testPoint2Map() throws Exception {
        Point point = GEOMETRY_FACTORY.createPoint(new Coordinate(0.0, 0.0));
        Shape shape = new JtsPoint(point, JtsSpatialContext.GEO);
        Map&lt;String, Object&gt; map = <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match367786-0.html#0',2,'match367786-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>GeoJSONUtils.shape2Map(shape);
        assertThat(map, hasEntry(&quot;type&quot;, (Object) &quot;Point&quot;));
        assertThat(map.get(&quot;coordinates&quot;).getClass().isArray(), is(true));
        assertThat(((double[]) map.get(&quot;coordinates&quot;)).length, is(2));
    }

    @Test
    public void testMapFromWktRoundTrip() throws Exception {</B></FONT>
        String wkt = &quot;MULTILINESTRING ((10.05 10.28, 20.95 20.89), (20.95 20.89, 31.92 21.45))&quot;;
        Shape shape = GeoJSONUtils.wkt2Shape(wkt);
        Map&lt;String, Object&gt; map = GeoJSONUtils.shape2Map(shape);

        Map&lt;String, Object&gt; wktMap = GeoJSONUtils.wkt2Map(wkt);
        assertThat(map.get(&quot;type&quot;), is(wktMap.get(&quot;type&quot;)));
        assertThat(map.get(&quot;coordinates&quot;), is(wktMap.get(&quot;coordinates&quot;)));

        Shape mappedShape = GeoJSONUtils.map2Shape(map);
        String wktFromMap = new WKTWriter().toString(mappedShape);
        assertThat(wktFromMap, is(wkt));
    }

    @Test
    public void testInvalidWKT() throws Exception {
        assertThrows(IllegalArgumentException.class,
                     () -&gt; GeoJSONUtils.wkt2Map(
                         &quot;multilinestring (((10.05  10.28  3.4  8.4, 20.95  20.89  4.5  9.5),\n&quot; +
                         &quot; \n&quot; +
                         &quot;( 20.95  20.89  4.5  9.5, 31.92  21.45  3.6  8.6)))&quot;),
                     &quot;Cannot convert WKT \&quot;multilinestring (((10.05  10.28  3.4  8.4, 20.95  20.89  4.5  9.5)&quot;);
    }

    @Test
    public void testMap2Shape() throws Exception {
        Shape shape = GeoJSONUtils.map2Shape(Map.&lt;String, Object&gt;of(
<A NAME="1"></A>            GeoJSONUtils.TYPE_FIELD, GeoJSONUtils.LINE_STRING,
            GeoJSONUtils.COORDINATES_FIELD, new Double[][]{{0.0, 0.1}, {1.0, 1.1}}
        ));
        <FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match367786-0.html#1',2,'match367786-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>assertThat(shape, instanceOf(JtsGeometry.class));
        assertThat(((JtsGeometry) shape).getGeom(), instanceOf(LineString.class));

    }

    @Test
    public void testInvalidMap() throws Exception {
        assertThrows(IllegalArgumentException.class,
                     () -&gt; GeoJSONUtils.map2Shape(Map.&lt;String, Object&gt;of</B></FONT>()),
                     &quot;Cannot convert Map \&quot;{}\&quot; to shape&quot;);
    }
<A NAME="3"></A>
    @Test
    public void testValidateMissingType() throws Exception {
        <FONT color="#53858b"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match367786-0.html#3',2,'match367786-top.html#3',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>assertThrows(IllegalArgumentException.class,
                     () -&gt; GeoJSONUtils.validateGeoJson(Map.of()),
                     &quot;Invalid GeoJSON: type field missing&quot;);
    }

    @Test
    public void testValidateWrongType() throws Exception {
        assertThrows(IllegalArgumentException.class,
                     () -&gt; GeoJSONUtils.validateGeoJson</B></FONT>(Map.of(GeoJSONUtils.TYPE_FIELD, &quot;Foo&quot;)),
                     &quot;Invalid GeoJSON: invalid type&quot;);
    }

    @Test
    public void testValidateMissingCoordinates() throws Exception {
        assertThrows(IllegalArgumentException.class,
                     () -&gt; GeoJSONUtils.validateGeoJson(Map.of(GeoJSONUtils.TYPE_FIELD, GeoJSONUtils.LINE_STRING)),
                     &quot;Invalid GeoJSON: coordinates field missing&quot;);
    }

    @Test
    public void testValidateGeometriesMissing() throws Exception {
        assertThrows(IllegalArgumentException.class,
                     () -&gt; GeoJSONUtils.validateGeoJson(Map.of(GeoJSONUtils.TYPE_FIELD, GeoJSONUtils.GEOMETRY_COLLECTION)),
                     &quot;Invalid GeoJSON: coordinates field missing&quot;);
    }
<A NAME="2"></A>
    @Test
    public void testInvalidGeometryCollection() throws Exception {
        <FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match367786-0.html#2',2,'match367786-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>assertThrows(IllegalArgumentException.class,
                     () -&gt; GeoJSONUtils.validateGeoJson(
                         Map.of(
                             GeoJSONUtils.TYPE_FIELD, GeoJSONUtils.GEOMETRY_COLLECTION,
                             GeoJSONUtils.GEOMETRIES_FIELD, List.&lt;Object&gt;of(&quot;ABC&quot;)
                         )
                     ),
                     &quot;Invalid GeoJSON: invalid GeometryCollection&quot;);
    }

    @Test
    public void testValidateInvalidCoordinates() throws Exception {
        assertThrows(IllegalArgumentException.class,
                     () -&gt; GeoJSONUtils.validateGeoJson(
                         Map.of</B></FONT>(
                             GeoJSONUtils.TYPE_FIELD, GeoJSONUtils.POINT,
                             GeoJSONUtils.COORDINATES_FIELD, &quot;ABC&quot;
                         )
                     ),
                     &quot;Invalid GeoJSON: invalid GeometryCollection&quot;);
    }

    @Test
    public void testInvalidNestedCoordinates() throws Exception {
        assertThrows(IllegalArgumentException.class,
                     () -&gt; GeoJSONUtils.validateGeoJson(
                         Map.of(
                             GeoJSONUtils.TYPE_FIELD, GeoJSONUtils.POINT,
                             GeoJSONUtils.COORDINATES_FIELD, new double[][]{
                                 {0.0, 1.0},
                                 {1.0, 0.0}
                             }
                         )
                     ),
                     &quot;Invalid GeoJSON: invalid coordinate&quot;);
    }

    @Test
    public void testInvalidDepthNestedCoordinates() throws Exception {
        assertThrows(IllegalArgumentException.class,
                     () -&gt; GeoJSONUtils.validateGeoJson(
                         Map.of(
                             GeoJSONUtils.TYPE_FIELD, GeoJSONUtils.POLYGON,
                             GeoJSONUtils.COORDINATES_FIELD, new double[][]{
                                 {0.0, 1.0},
                                 {1.0, 0.0}
                             }
                         )
                     ),
                     &quot;Invalid GeoJSON: invalid coordinate&quot;);
    }
}
</PRE>
</div>
  </div>
</body>
</html>
