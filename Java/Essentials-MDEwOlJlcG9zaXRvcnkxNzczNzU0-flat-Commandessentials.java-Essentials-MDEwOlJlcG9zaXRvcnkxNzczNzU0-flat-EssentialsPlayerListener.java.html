
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 17, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>Essentials-MDEwOlJlcG9zaXRvcnkxNzczNzU0-flat-Commandessentials.java</h3>
            <pre><code>1  package com.earth2me.essentials.commands;
2  import com.earth2me.essentials.CommandSource;
3  import com.earth2me.essentials.EssentialsUpgrade;
4  import static com.earth2me.essentials.I18n.tl;
5  import com.earth2me.essentials.User;
6  import com.earth2me.essentials.UserMap;
7  import com.earth2me.essentials.metrics.Metrics;
8  import com.earth2me.essentials.utils.DateUtil;
9  import com.earth2me.essentials.utils.NumberUtil;
10  import com.google.common.base.Charsets;
11  import java.io.IOException;
12  import java.util.HashMap;
13  import java.util.Locale;
14  import java.util.Map;
15  import java.util.UUID;
16  import org.bukkit.Material;
17  import org.bukkit.Server;
18  import org.bukkit.Sound;
19  import org.bukkit.block.Block;
20  import org.bukkit.entity.Player;
21  public class Commandessentials extends EssentialsCommand
22  {
23  	public Commandessentials()
24  	{
25  		super("essentials");
26  	}
27  	private transient int taskid;
28  	private final transient Map<Player, Block> noteBlocks = new HashMap<Player, Block>();
29  	@Override
30  	public void run(final Server server, final CommandSource sender, final String commandLabel, final String[] args) throws Exception
31  	{
32  		if (args.length == 0)
33  		{
34  			run_disabled(server, sender, commandLabel, args);
35  		}
36  		else if (args[0].equalsIgnoreCase("debug"))
37  		{
38  			run_debug(server, sender, commandLabel, args);
39  		}
40  		else if (args[0].equalsIgnoreCase("nya"))
41  		{
42  			run_nya(server, sender, commandLabel, args);
43  		}
44  		else if (args[0].equalsIgnoreCase("moo"))
45  		{
46  			run_moo(server, sender, commandLabel, args);
47  		}
48  		else if (args[0].equalsIgnoreCase("reset"))
49  		{
50  			run_reset(server, sender, commandLabel, args);
51  		}
52  		else if (args[0].equalsIgnoreCase("opt-out"))
53  		{
54  			run_optout(server, sender, commandLabel, args);
55  		}
56  		else if (args[0].equalsIgnoreCase("cleanup"))
57  		{
58  			run_cleanup(server, sender, commandLabel, args);
59  		}
60  		else if (args[0].equalsIgnoreCase("uuidconvert"))
61  		{
62  			run_uuidconvert(server, sender, commandLabel, args);
63  		}
64  		else if (args[0].equalsIgnoreCase("uuidtest"))
65  		{
66  			run_uuidtest(server, sender, commandLabel, args);
67  		}
68  		else
69  		{
70  			run_reload(server, sender, commandLabel, args);
71  		}
72  	}
73  	private void run_disabled(final Server server, final CommandSource sender, final String commandLabel, final String[] args) throws Exception
74  	{
75  		sender.sendMessage("/<command> <reload/debug>");
76  		final StringBuilder disabledCommands = new StringBuilder();
77  		for (Map.Entry<String, String> entry : ess.getAlternativeCommandsHandler().disabledCommands().entrySet())
78  		{
79  			if (disabledCommands.length() > 0)
80  			{
81  				disabledCommands.append(", ");
82  			}
83  			disabledCommands.append(entry.getKey()).append(" => ").append(entry.getValue());
84  		}
85  		if (disabledCommands.length() > 0)
86  		{
87  			sender.sendMessage(tl("blockList"));
88  			sender.sendMessage(disabledCommands.toString());
89  		}
90  	}
91  	private void run_reset(final Server server, final CommandSource sender, final String commandLabel, final String[] args) throws Exception
92  	{
93  		if (args.length < 2)
94  		{
95  			throw new Exception("/<command> reset <player>");
96  		}
97  		final User user = getPlayer(server, args, 1, true, true);
98  		user.reset();
99  		sender.sendMessage("Reset Essentials userdata for player: " + user.getDisplayName());
100  	}
101  	private void run_debug(final Server server, final CommandSource sender, final String commandLabel, final String[] args) throws Exception
102  	{
103  		ess.getSettings().setDebug(!ess.getSettings().isDebug());
104  		sender.sendMessage("Essentials " + ess.getDescription().getVersion() + " debug mode " + (ess.getSettings().isDebug() ? "enabled" : "disabled"));
105  	}
106  	private void run_reload(final Server server, final CommandSource sender, final String commandLabel, final String[] args) throws Exception
107  	{
108  		ess.reload();
109  		sender.sendMessage(tl("essentialsReload", ess.getDescription().getVersion()));
110  	}
111  	private void run_nya(final Server server, final CommandSource sender, final String commandLabel, final String[] args) throws Exception
112  	{
113  		final Map<String, Float> noteMap = new HashMap<String, Float>();
114  		noteMap.put("1F#", 0.5f);
115  		noteMap.put("1G", 0.53f);
116  		noteMap.put("1G#", 0.56f);
117  		noteMap.put("1A", 0.6f);
118  		noteMap.put("1A#", 0.63f);
119  		noteMap.put("1B", 0.67f);
120  		noteMap.put("1C", 0.7f);
121  		noteMap.put("1C#", 0.76f);
122  		noteMap.put("1D", 0.8f);
123  		noteMap.put("1D#", 0.84f);
124  		noteMap.put("1E", 0.9f);
125  		noteMap.put("1F", 0.94f);
126  		noteMap.put("2F#", 1.0f);
127  		noteMap.put("2G", 1.06f);
128  		noteMap.put("2G#", 1.12f);
129  		noteMap.put("2A", 1.18f);
130  		noteMap.put("2A#", 1.26f);
131  		noteMap.put("2B", 1.34f);
132  		noteMap.put("2C", 1.42f);
133  		noteMap.put("2C#", 1.5f);
134  		noteMap.put("2D", 1.6f);
135  		noteMap.put("2D#", 1.68f);
136  		noteMap.put("2E", 1.78f);
137  		noteMap.put("2F", 1.88f);
138  		final String tuneStr = "1D#,1E,2F#,,2A#,1E,1D#,1E,2F#,2B,2D#,2E,2D#,2A#,2B,,2F#,,1D#,1E,2F#,2B,2C#,2A#,2B,2C#,2E,2D#,2E,2C#,,2F#,,2G#,,1D,1D#,,1C#,1D,1C#,1B,,1B,,1C#,,1D,,1D,1C#,1B,1C#,1D#,2F#,2G#,1D#,2F#,1C#,1D#,1B,1C#,1B,1D#,,2F#,,2G#,1D#,2F#,1C#,1D#,1B,1D,1D#,1D,1C#,1B,1C#,1D,,1B,1C#,1D#,2F#,1C#,1D,1C#,1B,1C#,,1B,,1C#,,2F#,,2G#,,1D,1D#,,1C#,1D,1C#,1B,,1B,,1C#,,1D,,1D,1C#,1B,1C#,1D#,2F#,2G#,1D#,2F#,1C#,1D#,1B,1C#,1B,1D#,,2F#,,2G#,1D#,2F#,1C#,1D#,1B,1D,1D#,1D,1C#,1B,1C#,1D,,1B,1C#,1D#,2F#,1C#,1D,1C#,1B,1C#,,1B,,1B,,1B,,1F#,1G#,1B,,1F#,1G#,1B,1C#,1D#,1B,1E,1D#,1E,2F#,1B,,1B,,1F#,1G#,1B,1E,1D#,1C#,1B,,,,1F#,1B,,1F#,1G#,1B,,1F#,1G#,1B,1B,1C#,1D#,1B,1F#,1G#,1F#,1B,,1B,1A#,1B,1F#,1G#,1B,1E,1D#,1E,2F#,1B,,1A#,,1B,,1F#,1G#,1B,,1F#,1G#,1B,1C#,1D#,1B,1E,1D#,1E,2F#,1B,,1B,,1F#,1G#,1B,1F#,1E,1D#,1C#,1B,,,,1F#,1B,,1F#,1G#,1B,,1F#,1G#,1B,1B,1C#,1D#,1B,1F#,1G#,1F#,1B,,1B,1A#,1B,1F#,1G#,1B,1E,1D#,1E,2F#,1B,,1A#,,1B,,1F#,1G#,1B,,1F#,1G#,1B,1C#,1D#,1B,1E,1D#,1E,2F#,1B,,1B,,1F#,1G#,1B,1F#,1E,1D#,1C#,1B,,,,1F#,1B,,1F#,1G#,1B,,1F#,1G#,1B,1B,1C#,1D#,1B,1F#,1G#,1F#,1B,,1B,1A#,1B,1F#,1G#,1B,1E,1D#,1E,2F#,1B,,1A#,,1B,,1F#,1G#,1B,,1F#,1G#,1B,1C#,1D#,1B,1E,1D#,1E,2F#,1B,,1B,,1F#,1G#,1B,1F#,1E,1D#,1C#,1B,,,,1F#,1B,,1F#,1G#,1B,,1F#,1G#,1B,1B,1C#,1D#,1B,1F#,1G#,1F#,1B,,1B,1A#,1B,1F#,1G#,1B,1E,1D#,1E,2F#,1B,,1A#,,1B,,1F#,1G#,1B,,1F#,1G#,1B,1C#,1D#,1B,1E,1D#,1E,2F#,1B,,1B,,1F#,1G#,1B,1F#,1E,1D#,1C#,1B,,,,1F#,1B,,1F#,1G#,1B,,1F#,1G#,1B,1B,1C#,1D#,1B,1F#,1G#,1F#,1B,,1B,1A#,1B,1F#,1G#,1B,1E,1D#,1E,2F#,1B,,1B,,";
139  		final String[] tune = tuneStr.split(",");
140  		taskid = ess.scheduleSyncRepeatingTask(new Runnable()
141  		{
142  			int i = 0;
143  			@Override
144  			public void run()
145  			{
146  				final String note = tune[i];
147  				i++;
148  				if (i >= tune.length)
149  				{
150  					Commandessentials.this.stopTune();
151  				}
152  				if (note == null || note.isEmpty())
153  				{
154  					return;
155  				}
156  				for (Player onlinePlayer : ess.getOnlinePlayers())
157  				{
158  					onlinePlayer.playSound(onlinePlayer.getLocation(), Sound.NOTE_PIANO, 1, noteMap.get(note));
159  				}
160  			}
161  		}, 20, 2);
162  	}
163  	private void stopTune()
164  	{
165  		ess.getScheduler().cancelTask(taskid);
166  		for (Block block : noteBlocks.values())
167  		{
168  			if (block.getType() == Material.NOTE_BLOCK)
169  			{
170  				block.setType(Material.AIR);
171  			}
172  		}
173  		noteBlocks.clear();
174  	}
175  	private final String[] consoleMoo = new String[]
176  	{
177  		"         (__)",
178  		"         (oo)",
179  		"   /------\\/",
180  		"  / |    ||",
181  		" *  /\\---/\\",
182  		"    ~~   ~~",
183  		"....\"Have you mooed today?\"..."
184  	};
185  	private final String[] playerMoo = new String[]
186  	{
187  		"            (__)",
188  		"            (oo)",
189  		"   /------\\/",
190  		"  /  |      | |",
191  		" *  /\\---/\\",
192  		"    ~~    ~~",
193  		"....\"Have you mooed today?\"..."
194  	};
195  	private void run_moo(final Server server, final CommandSource sender, final String command, final String args[])
196  	{
197  		if (args.length == 2 && args[1].equals("moo"))
198  		{
199  			for (String s : consoleMoo)
200  			{
201  				logger.info(s);
202  			}
203  			for (Player player : ess.getOnlinePlayers())
204  			{
205  				player.sendMessage(playerMoo);
206  				player.playSound(player.getLocation(), Sound.COW_IDLE, 1, 1.0f);
207  			}
208  		}
209  		else
210  		{
211  			if (sender.isPlayer())
212  			{
213  				sender.getSender().sendMessage(playerMoo);
214  				final Player player = sender.getPlayer();
215  				player.playSound(player.getLocation(), Sound.COW_IDLE, 1, 1.0f);
216  			}
217  			else
218  			{
219  				sender.getSender().sendMessage(consoleMoo);
220  			}
221  		}
222  	}
223  	private void run_optout(final Server server, final CommandSource sender, final String command, final String args[])
224  	{
225  		final Metrics metrics = ess.getMetrics();
226  		try
227  		{
228  			sender.sendMessage("Essentials collects simple metrics to highlight which features to concentrate work on in the future.");
229  			if (metrics.isOptOut())
230  			{
231  				metrics.enable();
232  			}
233  			else
234  			{
235  				metrics.disable();
236  			}
237  			sender.sendMessage("Anonymous Metrics are now " + (metrics.isOptOut() ? "disabled" : "enabled") + " for all plugins.");
238  		}
239  		catch (IOException ex)
240  		{
241  			sender.sendMessage("Unable to modify 'plugins/PluginMetrics/config.yml': " + ex.getMessage());
242  		}
243  	}
244  	private void run_cleanup(final Server server, final CommandSource sender, final String command, final String args[]) throws Exception
245  	{
246  		if (args.length < 2 || !NumberUtil.isInt(args[1]))
247  		{
248  			sender.sendMessage("This sub-command will delete users who havent logged in in the last <days> days.");
249  			sender.sendMessage("Optional parameters define the minium amount required to prevent deletion.");
250  			sender.sendMessage("Unless you define larger default values, this command wil ignore people who have more than 0 money/homes.");
251  			throw new Exception("/<command> cleanup <days> [money] [homes]");
252  		}
253  		sender.sendMessage(tl("cleaning"));
254  		final long daysArg = Long.parseLong(args[1]);
255  		final double moneyArg = args.length >= 3 ? Double.parseDouble(args[2].replaceAll("[^0-9\\.]", "")) : 0;
256  		final int homesArg = args.length >= 4 && NumberUtil.isInt(args[3]) ? Integer.parseInt(args[3]) : 0;
257  		final UserMap userMap = ess.getUserMap();
258  		ess.runTaskAsynchronously(new Runnable()
259  		{
260  			@Override
261  			public void run()
262  			{
263  				Long currTime = System.currentTimeMillis();
264  				for (UUID u : userMap.getAllUniqueUsers())
265  				{
266  					final User user = ess.getUserMap().getUser(u);
267  					if (user == null)
268  					{
269  						continue;
270  					}
271  					long lastLog = user.getLastLogout();
272  					if (lastLog == 0)
273  					{
274  						lastLog = user.getLastLogin();
275  					}
276  					if (lastLog == 0)
277  					{
<span onclick='openModal()' class='match'>278  						user.setLastLogin(currTime);
279  					}
280  					if (user.isNPC())
281  					{
282  						continue;
</span>283  					}
284  					long timeDiff = currTime - lastLog;
285  					long milliDays = daysArg * 24L * 60L * 60L * 1000L;
286  					int homeCount = user.getHomes().size();
287  					double moneyCount = user.getMoney().doubleValue();
288  					if ((lastLog == 0) || (timeDiff < milliDays)
289  						|| (homeCount > homesArg) || (moneyCount > moneyArg))
290  					{
291  						continue;
292  					}
293  					if (ess.getSettings().isDebug())
294  					{
295  						ess.getLogger().info("Deleting user: " + user.getName() + " Money: " + moneyCount + " Homes: " + homeCount + " Last seen: " + DateUtil.formatDateDiff(lastLog));
296  					}
297  					user.reset();
298  				}
299  				sender.sendMessage(tl("cleaned"));
300  			}
301  		});
302  	}
303  	private void run_uuidconvert(final Server server, final CommandSource sender, final String commandLabel, final String[] args) throws Exception
304  	{
305  		sender.sendMessage("Starting Essentials UUID userdata conversion, this may lag the server.");
306  		Boolean ignoreUFCache = (args.length > 2 && args[1].toLowerCase(Locale.ENGLISH).contains("ignore"));
307  		EssentialsUpgrade.uuidFileConvert(ess, ignoreUFCache);
308  		sender.sendMessage("UUID conversion complete, check your server log for more information.");
309  	}
310  	private void run_uuidtest(final Server server, final CommandSource sender, final String commandLabel, final String[] args) throws Exception
311  	{
312  		if (args.length < 2)
313  		{
314  			throw new Exception("/<command> uuidtest <name>");
315  		}
316  		String name = args[1];
317  		sender.sendMessage("Looking up UUID for " + name);
318  		UUID onlineUUID = null;
319  		for (Player player : ess.getOnlinePlayers())
320  		{
321  			if (player.getName().equalsIgnoreCase(name))
322  			{
323  				onlineUUID = player.getUniqueId();
324  				break;
325  			}
326  		}
327  		UUID essUUID = ess.getUserMap().getUser(name).getConfigUUID();
328  		org.bukkit.OfflinePlayer player = ess.getServer().getOfflinePlayer(name);
329  		UUID bukkituuid = player.getUniqueId();
330  		sender.sendMessage("Bukkit Lookup: " + bukkituuid.toString());
331  		if (onlineUUID != null && onlineUUID != bukkituuid)
332  		{
333  			sender.sendMessage("Online player: " + onlineUUID.toString());
334  		}
335  		if (essUUID != null && essUUID != bukkituuid)
336  		{
337  			sender.sendMessage("Essentials config: " + essUUID.toString());
338  		}
339  		UUID npcuuid = UUID.nameUUIDFromBytes(("NPC:" + name).getBytes(Charsets.UTF_8));
340  		sender.sendMessage("NPC UUID: " + npcuuid.toString());
341  		UUID offlineuuid = UUID.nameUUIDFromBytes(("OfflinePlayer:" + name).getBytes(Charsets.UTF_8));
342  		sender.sendMessage("Offline Mode UUID: " + offlineuuid.toString());
343  	}
344  }
</code></pre>
        </div>
        <div class="column">
            <h3>Essentials-MDEwOlJlcG9zaXRvcnkxNzczNzU0-flat-EssentialsPlayerListener.java</h3>
            <pre><code>1  package com.earth2me.essentials;
2  import static com.earth2me.essentials.I18n.tl;
3  import com.earth2me.essentials.textreader.IText;
4  import com.earth2me.essentials.textreader.KeywordReplacer;
5  import com.earth2me.essentials.textreader.TextInput;
6  import com.earth2me.essentials.textreader.TextPager;
7  import com.earth2me.essentials.utils.LocationUtil;
8  import java.io.IOException;
9  import java.util.Iterator;
10  import java.util.List;
11  import java.util.Locale;
12  import java.util.logging.Level;
13  import java.util.logging.Logger;
14  import net.ess3.api.IEssentials;
15  import org.bukkit.GameMode;
16  import org.bukkit.Location;
17  import org.bukkit.Material;
18  import org.bukkit.entity.HumanEntity;
19  import org.bukkit.entity.Player;
20  import org.bukkit.event.EventHandler;
21  import org.bukkit.event.EventPriority;
22  import org.bukkit.event.Listener;
23  import org.bukkit.event.inventory.InventoryClickEvent;
24  import org.bukkit.event.inventory.InventoryCloseEvent;
25  import org.bukkit.event.inventory.InventoryType;
26  import org.bukkit.event.player.*;
27  import org.bukkit.event.player.PlayerLoginEvent.Result;
28  import org.bukkit.event.player.PlayerTeleportEvent.TeleportCause;
29  import org.bukkit.inventory.Inventory;
30  import org.bukkit.inventory.InventoryHolder;
31  import org.bukkit.inventory.ItemStack;
32  public class EssentialsPlayerListener implements Listener
33  {
34  	private static final Logger LOGGER = Logger.getLogger("Essentials");
35  	private final transient IEssentials ess;
36  	public EssentialsPlayerListener(final IEssentials parent)
37  	{
38  		this.ess = parent;
39  	}
40  	@EventHandler(priority = EventPriority.NORMAL)
41  	public void onPlayerRespawn(final PlayerRespawnEvent event)
42  	{
43  		final User user = ess.getUser(event.getPlayer());
44  		updateCompass(user);
45  		user.setDisplayNick();
46  		if (ess.getSettings().isTeleportInvulnerability())
47  		{
48  			user.enableInvulnerabilityAfterTeleport();
49  		}
50  	}
51  	@EventHandler(priority = EventPriority.LOWEST)
52  	public void onPlayerChat(final AsyncPlayerChatEvent event)
53  	{
54  		final User user = ess.getUser(event.getPlayer());
55  		if (user.isMuted())
56  		{
57  			event.setCancelled(true);
58  			user.sendMessage(tl("voiceSilenced"));
59  			LOGGER.info(tl("mutedUserSpeaks", user.getName()));
60  		}
61  		try
62  		{
63  			final Iterator<Player> it = event.getRecipients().iterator();
64  			while (it.hasNext())
65  			{
66  				final User u = ess.getUser(it.next());
67  				if (u.isIgnoredPlayer(user))
68  				{
69  					it.remove();
70  				}
71  			}
72  		}
73  		catch (UnsupportedOperationException ex)
74  		{
75  			if (ess.getSettings().isDebug())
76  			{
77  				ess.getLogger().log(Level.INFO, "Ignore could not block chat due to custom chat plugin event.", ex);
78  			}
79  			else
80  			{
81  				ess.getLogger().info("Ignore could not block chat due to custom chat plugin event.");
82  			}
83  		}
84  		user.updateActivity(true);
85  		user.setDisplayNick();
86  	}
87  	@EventHandler(priority = EventPriority.HIGH, ignoreCancelled = true)
88  	public void onPlayerMove(final PlayerMoveEvent event)
89  	{
90  		if (event.getFrom().getBlockX() == event.getTo().getBlockX()
91  			&& event.getFrom().getBlockZ() == event.getTo().getBlockZ()
92  			&& event.getFrom().getBlockY() == event.getTo().getBlockY())
93  		{
94  			return;
95  		}
96  		if (!ess.getSettings().cancelAfkOnMove() && !ess.getSettings().getFreezeAfkPlayers())
97  		{
98  			event.getHandlers().unregister(this);
99  			if (ess.getSettings().isDebug())
100  			{
101  				LOGGER.log(Level.INFO, "Unregistering move listener");
102  			}
103  			return;
104  		}
105  		final User user = ess.getUser(event.getPlayer());
106  		if (user.isAfk() && ess.getSettings().getFreezeAfkPlayers())
107  		{
108  			final Location from = event.getFrom();
109  			final Location origTo = event.getTo();
110  			final Location to = origTo.clone();
111  			if (ess.getSettings().cancelAfkOnMove() && origTo.getY() >= from.getBlockY() + 1)
112  			{
113  				user.updateActivity(true);
114  				return;
115  			}
116  			to.setX(from.getX());
117  			to.setY(from.getY());
118  			to.setZ(from.getZ());
119  			try
120  			{
121  				event.setTo(LocationUtil.getSafeDestination(to));
122  			}
123  			catch (Exception ex)
124  			{
125  				event.setTo(to);
126  			}
127  			return;
128  		}
129  		final Location afk = user.getAfkPosition();
130  		if (afk == null || !event.getTo().getWorld().equals(afk.getWorld()) || afk.distanceSquared(event.getTo()) > 9)
131  		{
132  			user.updateActivity(true);
133  		}
134  	}
135  	@EventHandler(priority = EventPriority.HIGHEST)
136  	public void onPlayerQuit(final PlayerQuitEvent event)
137  	{
138  		final User user = ess.getUser(event.getPlayer());
139  		if (ess.getSettings().allowSilentJoinQuit() && user.isAuthorized("essentials.silentquit"))
140  		{
141  			event.setQuitMessage(null);
142  		}
143  		else if (ess.getSettings().isCustomQuitMessage() && event.getQuitMessage() != null)
144  		{
145  			final Player player = event.getPlayer();
146  			event.setQuitMessage(
147  					ess.getSettings().getCustomQuitMessage()
148  					.replace("{PLAYER}", player.getDisplayName())
149  					.replace("{USERNAME}", player.getName()));
150  		}
151  		if (ess.getSettings().removeGodOnDisconnect() && user.isGodModeEnabled())
152  		{
<span onclick='openModal()' class='match'>153  			user.setGodModeEnabled(false);
154  		}
155  		if (user.isVanished())
156  		{
157  			user.setVanished(false);
</span>158  		}
159  		user.setLogoutLocation();
160  		if (user.isRecipeSee())
161  		{
162  			user.getBase().getOpenInventory().getTopInventory().clear();
163  		}
164  		for (HumanEntity viewer : user.getBase().getInventory().getViewers())
165  		{
166  			if (viewer instanceof Player)
167  			{
168  				User uviewer = ess.getUser((Player)viewer);
169  				if (uviewer.isInvSee())
170  				{
171  					uviewer.getBase().closeInventory();
172  				}
173  			}
174  		}
175  		user.updateActivity(false);
176  		user.dispose();
177  	}
178  	@EventHandler(priority = EventPriority.HIGHEST)
179  	public void onPlayerJoin(final PlayerJoinEvent event)
180  	{
181  		final String joinMessage = event.getJoinMessage();
182  		ess.runTaskAsynchronously(new Runnable()
183  		{
184  			@Override
185  			public void run()
186  			{
187  				delayedJoin(event.getPlayer(), joinMessage);
188  			}
189  		});
190  		if (ess.getSettings().allowSilentJoinQuit() || ess.getSettings().isCustomJoinMessage())
191  		{
192  			event.setJoinMessage(null);
193  		}
194  	}
195  	public void delayedJoin(final Player player, final String message)
196  	{
197  		if (!player.isOnline())
198  		{
199  			return;
200  		}
201  		ess.getBackup().onPlayerJoin();
202  		final User dUser = ess.getUser(player);
203  		if (dUser.isNPC())
204  		{
205  			dUser.setNPC(false);
206  		}
207  		final long currentTime = System.currentTimeMillis();
208  		dUser.checkMuteTimeout(currentTime);
209  		dUser.updateActivity(false);
210  		IText tempInput = null;
211  		if (!ess.getSettings().isCommandDisabled("motd"))
212  		{
213  			try
214  			{
215  				tempInput = new TextInput(dUser.getSource(), "motd", true, ess);
216  			}
217  			catch (IOException ex)
218  			{
219  				if (ess.getSettings().isDebug())
220  				{
221  					LOGGER.log(Level.WARNING, ex.getMessage(), ex);
222  				}
223  				else
224  				{
225  					LOGGER.log(Level.WARNING, ex.getMessage());
226  				}
227  			}
228  		}
229  		final IText input = tempInput;
230  		class DelayJoinTask implements Runnable
231  		{
232  			@Override
233  			public void run()
234  			{
235  				final User user = ess.getUser(player);
236  				if (!user.getBase().isOnline())
237  				{
238  					return;
239  				}
240  				user.startTransaction();
241  				user.setLastAccountName(user.getBase().getName());
242  				user.setLastLogin(currentTime);
243  				user.setDisplayNick();
244  				updateCompass(user);
245  				if (!ess.getVanishedPlayers().isEmpty() && !user.isAuthorized("essentials.vanish.see"))
246  				{
247  					for (String p : ess.getVanishedPlayers())
248  					{
249  						Player toVanish = ess.getServer().getPlayerExact(p);
250  						if (toVanish != null && toVanish.isOnline())
251  						{
252  							user.getBase().hidePlayer(toVanish);
253  						}
254  					}
255  				}
256  				if (user.isAuthorized("essentials.sleepingignored"))
257  				{
258  					user.getBase().setSleepingIgnored(true);
259  				}
260  				if (ess.getSettings().allowSilentJoinQuit() && (user.isAuthorized("essentials.silentjoin") || user.isAuthorized("essentials.silentjoin.vanish")))
261  				{
262  					if (user.isAuthorized("essentials.silentjoin.vanish"))
263  					{
264  						user.setVanished(true);
265  					}
266  				}
267  				else if (message == null)
268  				{
269  				}
270  				else if (ess.getSettings().isCustomJoinMessage())
271  				{
272  					ess.getServer().broadcastMessage(
273  							ess.getSettings().getCustomJoinMessage()
274  							.replace("{PLAYER}", player.getDisplayName())
275  							.replace("{USERNAME}", player.getName()));
276  				}
277  				else if (ess.getSettings().allowSilentJoinQuit())
278  				{
279  					ess.getServer().broadcastMessage(message);
280  				}
281  				if (input != null && user.isAuthorized("essentials.motd"))
282  				{
283  					final IText output = new KeywordReplacer(input, user.getSource(), ess);
284  					final TextPager pager = new TextPager(output, true);
285  					pager.showPage("1", null, "motd", user.getSource());
286  				}
287  				if (!ess.getSettings().isCommandDisabled("mail") && user.isAuthorized("essentials.mail"))
288  				{
289  					final List<String> mail = user.getMails();
290  					if (mail.isEmpty())
291  					{
292  						user.sendMessage(tl("noNewMail"));
293  					}
294  					else
295  					{
296  						user.sendMessage(tl("youHaveNewMail", mail.size()));
297  					}
298  				}
299  				if (user.isAuthorized("essentials.fly.safelogin"))
300  				{
301  					user.getBase().setFallDistance(0);
302  					if (LocationUtil.shouldFly(user.getLocation()))
303  					{
304  						user.getBase().setAllowFlight(true);
305  						user.getBase().setFlying(true);
306  						user.getBase().sendMessage(tl("flyMode", tl("enabled"), user.getDisplayName()));
307  					}
308  				}
309  				if (!user.isAuthorized("essentials.speed"))
310  				{
311  					user.getBase().setFlySpeed(0.1f);
312  					user.getBase().setWalkSpeed(0.2f);
313  				}
314  				user.stopTransaction();
315  			}
316  		}
317  		ess.scheduleSyncDelayedTask(new DelayJoinTask());
318  	}
319  	private void updateCompass(final User user)
320  	{
321  		Location loc = user.getHome(user.getLocation());
322  		if (loc == null)
323  		{
324  			loc = user.getBase().getBedSpawnLocation();
325  		}
326  		if (loc != null)
327  		{
328  			final Location updateLoc = loc;
329  			user.getBase().setCompassTarget(updateLoc);
330  		}
331  	}
332  	@EventHandler(priority = EventPriority.HIGH)
333  	public void onPlayerLogin(final PlayerLoginEvent event)
334  	{
335  		switch (event.getResult())
336  		{
337  		case KICK_FULL:
338  			final User kfuser = ess.getUser(event.getPlayer());
339  			if (kfuser.isAuthorized("essentials.joinfullserver"))
340  			{
341  				event.allow();
342  				return;
343  			}
344  			event.disallow(Result.KICK_FULL, tl("serverFull"));
345  			break;
346  		default:
347  			break;
348  		}
349  	}
350  	@EventHandler(priority = EventPriority.HIGH, ignoreCancelled = true)
351  	public void onPlayerTeleport(final PlayerTeleportEvent event)
352  	{
353  		final boolean backListener = ess.getSettings().registerBackInListener();
354  		final boolean teleportInvulnerability = ess.getSettings().isTeleportInvulnerability();
355  		if (backListener || teleportInvulnerability)
356  		{
357  			final User user = ess.getUser(event.getPlayer());
358  			if (backListener && (event.getCause() == TeleportCause.PLUGIN || event.getCause() == TeleportCause.COMMAND))
359  			{
360  				user.setLastLocation();
361  			}
362  			if (teleportInvulnerability && (event.getCause() == TeleportCause.PLUGIN || event.getCause() == TeleportCause.COMMAND))
363  			{
364  				user.enableInvulnerabilityAfterTeleport();
365  			}
366  		}
367  	}
368  	@EventHandler(priority = EventPriority.HIGH, ignoreCancelled = true)
369  	public void onPlayerEggThrow(final PlayerEggThrowEvent event)
370  	{
371  		final User user = ess.getUser(event.getPlayer());
372  		final ItemStack stack = new ItemStack(Material.EGG, 1);
373  		if (user.hasUnlimited(stack))
374  		{
375  			user.getBase().getInventory().addItem(stack);
376  			user.getBase().updateInventory();
377  		}
378  	}
379  	@EventHandler(priority = EventPriority.HIGH, ignoreCancelled = true)
380  	public void onPlayerBucketEmpty(final PlayerBucketEmptyEvent event)
381  	{
382  		final User user = ess.getUser(event.getPlayer());
383  		if (user.hasUnlimited(new ItemStack(event.getBucket())))
384  		{
385  			event.getItemStack().setType(event.getBucket());
386  			ess.scheduleSyncDelayedTask(new Runnable()
387  			{
388  				@Override
389  				public void run()
390  				{
391  					user.getBase().updateInventory();
392  				}
393  			});
394  		}
395  	}
396  	@EventHandler(priority = EventPriority.MONITOR, ignoreCancelled = true)
397  	public void onPlayerCommandPreprocess(final PlayerCommandPreprocessEvent event)
398  	{
399  		final Player player = event.getPlayer();
400  		final String cmd = event.getMessage().toLowerCase(Locale.ENGLISH).split(" ")[0].replace("/", "").toLowerCase(Locale.ENGLISH);
401  		if (ess.getSettings().getSocialSpyCommands().contains(cmd) || ess.getSettings().getSocialSpyCommands().contains("*"))
402  		{
403  			for (User spyer : ess.getOnlineUsers())
404  			{
405  				if (spyer.isSocialSpyEnabled() && !player.equals(spyer.getBase()))
406  				{
407  					spyer.sendMessage(player.getDisplayName() + " : " + event.getMessage());
408  				}
409  			}
410  		}
411  		else if (!cmd.equalsIgnoreCase("afk"))
412  		{
413  			final User user = ess.getUser(player);
414  			user.updateActivity(true);
415  		}
416  	}
417  	@EventHandler(priority = EventPriority.NORMAL)
418  	public void onPlayerChangedWorldFlyReset(final PlayerChangedWorldEvent event)
419  	{
420  		final User user = ess.getUser(event.getPlayer());
421  		if (user.getBase().getGameMode() != GameMode.CREATIVE && !user.isAuthorized("essentials.fly"))
422  		{
423  			user.getBase().setFallDistance(0f);
424  			user.getBase().setAllowFlight(false);
425  		}
426  		if (!user.isAuthorized("essentials.speed"))
427  		{
428  			user.getBase().setFlySpeed(0.1f);
429  			user.getBase().setWalkSpeed(0.2f);
430  		}
431  		else
432  		{
433  			if (user.getBase().getFlySpeed() > ess.getSettings().getMaxFlySpeed() && !user.isAuthorized("essentials.speed.bypass"))
434  			{
435  				user.getBase().setFlySpeed((float)ess.getSettings().getMaxFlySpeed());
436  			}
437  			else
438  			{
439  				user.getBase().setFlySpeed(user.getBase().getFlySpeed() * 0.99999f);
440  			}
441  			if (user.getBase().getWalkSpeed() > ess.getSettings().getMaxWalkSpeed() && !user.isAuthorized("essentials.speed.bypass"))
442  			{
443  				user.getBase().setWalkSpeed((float)ess.getSettings().getMaxWalkSpeed());
444  			}
445  			else
446  			{
447  				user.getBase().setWalkSpeed(user.getBase().getWalkSpeed() * 0.99999f);
448  			}
449  		}
450  	}
451  	@EventHandler(priority = EventPriority.MONITOR)
452  	public void onPlayerChangedWorld(final PlayerChangedWorldEvent event)
453  	{
454  		final User user = ess.getUser(event.getPlayer());
455  		final String newWorld = event.getPlayer().getLocation().getWorld().getName();
456  		user.setDisplayNick();
457  		updateCompass(user);
458  		if (ess.getSettings().getNoGodWorlds().contains(newWorld) && user.isGodModeEnabledRaw())
459  		{
460  			user.sendMessage(tl("noGodWorldWarning"));
461  		}
462  		if (!user.getWorld().getName().equals(newWorld))
463  		{
464  			user.sendMessage(tl("currentWorld", newWorld));
465  		}
466  		if (user.isVanished())
467  		{
468  			user.setVanished(user.isAuthorized("essentials.vanish"));
469  		}
470  	}
471  	@EventHandler(priority = EventPriority.NORMAL)
472  	public void onPlayerInteract(final PlayerInteractEvent event)
473  	{
474  		switch (event.getAction())
475  		{
476  		case RIGHT_CLICK_BLOCK:
477  			if (!event.isCancelled() && event.getClickedBlock().getType() == Material.BED_BLOCK && ess.getSettings().getUpdateBedAtDaytime())
478  			{
479  				User player = ess.getUser(event.getPlayer());
480  				if (player.isAuthorized("essentials.sethome.bed"))
481  				{
482  					player.getBase().setBedSpawnLocation(event.getClickedBlock().getLocation());
483  					player.sendMessage(tl("bedSet", player.getLocation().getWorld().getName(), player.getLocation().getBlockX(), player.getLocation().getBlockY(), player.getLocation().getBlockZ()));
484  				}
485  			}
486  			break;
487  		case LEFT_CLICK_AIR:
488  			if (event.getPlayer().isFlying())
489  			{
490  				final User user = ess.getUser(event.getPlayer());
491  				if (user.isFlyClickJump())
492  				{
493  					useFlyClickJump(user);
494  					return;
495  				}
496  			}
497  		case LEFT_CLICK_BLOCK:
498  			if (event.getItem() != null && event.getItem().getType() != Material.AIR)
499  			{
500  				final User user = ess.getUser(event.getPlayer());
501  				user.updateActivity(true);
502  				if (user.hasPowerTools() && user.arePowerToolsEnabled() && usePowertools(user, event.getItem().getTypeId()))
503  				{
504  					event.setCancelled(true);
505  				}
506  			}
507  			break;
508  		default:
509  			break;
510  		}
511  	}
512  	private void useFlyClickJump(final User user)
513  	{
514  		try
515  		{
516  			final Location otarget = LocationUtil.getTarget(user.getBase());
517  			class DelayedClickJumpTask implements Runnable
518  			{
519  				@Override
520  				public void run()
521  				{
522  					Location loc = user.getLocation();
523  					loc.setX(otarget.getX());
524  					loc.setZ(otarget.getZ());
525  					while (LocationUtil.isBlockDamaging(loc.getWorld(), loc.getBlockX(), loc.getBlockY() - 1, loc.getBlockZ()))
526  					{
527  						loc.setY(loc.getY() + 1d);
528  					}
529  					user.getBase().teleport(loc, TeleportCause.PLUGIN);
530  				}
531  			}
532  			ess.scheduleSyncDelayedTask(new DelayedClickJumpTask());
533  		}
534  		catch (Exception ex)
535  		{
536  			if (ess.getSettings().isDebug())
537  			{
538  				LOGGER.log(Level.WARNING, ex.getMessage(), ex);
539  			}
540  		}
541  	}
542  	private boolean usePowertools(final User user, final int id)
543  	{
544  		final List<String> commandList = user.getPowertool(id);
545  		if (commandList == null || commandList.isEmpty())
546  		{
547  			return false;
548  		}
549  		boolean used = false;
550  		for (final String command : commandList)
551  		{
552  			if (command.contains("{player}"))
553  			{
554  				continue;
555  			}
556  			else if (command.startsWith("c:"))
557  			{
558  				used = true;
559  				user.getBase().chat(command.substring(2));
560  			}
561  			else
562  			{
563  				used = true;
564  				class PowerToolUseTask implements Runnable
565  				{
566  					@Override
567  					public void run()
568  					{
569  						user.getServer().dispatchCommand(user.getBase(), command);
570  						LOGGER.log(Level.INFO, String.format("[PT] %s issued server command: /%s", user.getName(), command));
571  					}
572  				}
573  				ess.scheduleSyncDelayedTask(new PowerToolUseTask());
574  			}
575  		}
576  		return used;
577  	}
578  	@EventHandler(priority = EventPriority.LOW, ignoreCancelled = true)
579  	public void onPlayerPickupItem(final PlayerPickupItemEvent event)
580  	{
581  		if (ess.getSettings().getDisableItemPickupWhileAfk())
582  		{
583  			if (ess.getUser(event.getPlayer()).isAfk())
584  			{
585  				event.setCancelled(true);
586  			}
587  		}
588  	}
589  	@EventHandler(priority = EventPriority.LOWEST, ignoreCancelled = true)
590  	public void onInventoryClickEvent(final InventoryClickEvent event)
591  	{
592  		Player refreshPlayer = null;
593  		final Inventory top = event.getView().getTopInventory();
594  		final InventoryType type = top.getType();
595  		if (type == InventoryType.PLAYER)
596  		{
597  			final User user = ess.getUser((Player)event.getWhoClicked());
598  			final InventoryHolder invHolder = top.getHolder();
599  			if (invHolder != null && invHolder instanceof HumanEntity)
600  			{
601  				final User invOwner = ess.getUser((Player)invHolder);
602  				if (user.isInvSee() && (!user.isAuthorized("essentials.invsee.modify")
603  										|| invOwner.isAuthorized("essentials.invsee.preventmodify")
604  										|| !invOwner.getBase().isOnline()))
605  				{
606  					event.setCancelled(true);
607  					refreshPlayer = user.getBase();
608  				}
609  			}
610  		}
611  		else if (type == InventoryType.ENDER_CHEST)
612  		{
613  			final User user = ess.getUser((Player)event.getWhoClicked());
614  			if (user.isEnderSee() && (!user.isAuthorized("essentials.enderchest.modify")))
615  			{
616  				event.setCancelled(true);
617  				refreshPlayer = user.getBase();
618  			}
619  		}
620  		else if (type == InventoryType.WORKBENCH)
621  		{
622  			User user = ess.getUser((Player)event.getWhoClicked());
623  			if (user.isRecipeSee())
624  			{
625  				event.setCancelled(true);
626  				refreshPlayer = user.getBase();
627  			}
628  		}
629  		else if (type == InventoryType.CHEST && top.getSize() == 9)
630  		{
631  			final User user = ess.getUser((Player)event.getWhoClicked());
632  			final InventoryHolder invHolder = top.getHolder();
633  			if (invHolder != null && invHolder instanceof HumanEntity && user.isInvSee())
634  			{
635  				event.setCancelled(true);
636  				refreshPlayer = user.getBase();
637  			}
638  		}
639  		if (refreshPlayer != null)
640  		{
641  			final Player player = refreshPlayer;
642  			ess.scheduleSyncDelayedTask(new Runnable()
643  			{
644  				@Override
645  				public void run()
646  				{
647  					player.updateInventory();
648  				}
649  			}, 1);
650  		}
651  	}
652  	@EventHandler(priority = EventPriority.MONITOR)
653  	public void onInventoryCloseEvent(final InventoryCloseEvent event)
654  	{
655  		Player refreshPlayer = null;
656  		final Inventory top = event.getView().getTopInventory();
657  		final InventoryType type = top.getType();
658  		if (type == InventoryType.PLAYER)
659  		{
660  			final User user = ess.getUser((Player)event.getPlayer());
661  			user.setInvSee(false);
662  			refreshPlayer = user.getBase();
663  		}
664  		else if (type == InventoryType.ENDER_CHEST)
665  		{
666  			final User user = ess.getUser((Player)event.getPlayer());
667  			user.setEnderSee(false);
668  			refreshPlayer = user.getBase();
669  		}
670  		else if (type == InventoryType.WORKBENCH)
671  		{
672  			final User user = ess.getUser((Player)event.getPlayer());
673  			if (user.isRecipeSee())
674  			{
675  				user.setRecipeSee(false);
676  				event.getView().getTopInventory().clear();
677  				refreshPlayer = user.getBase();
678  			}
679  		}
680  		else if (type == InventoryType.CHEST && top.getSize() == 9)
681  		{
682  			final InventoryHolder invHolder = top.getHolder();
683  			if (invHolder != null && invHolder instanceof HumanEntity)
684  			{
685  				final User user = ess.getUser((Player)event.getPlayer());
686  				user.setInvSee(false);
687  				refreshPlayer = user.getBase();
688  			}
689  		}
690  		if (refreshPlayer != null)
691  		{
692  			final Player player = refreshPlayer;
693  			ess.scheduleSyncDelayedTask(new Runnable()
694  			{
695  				@Override
696  				public void run()
697  				{
698  					player.updateInventory();
699  				}
700  			}, 1);
701  		}
702  	}
703  	@EventHandler(priority = EventPriority.LOW, ignoreCancelled = true)
704  	public void onPlayerFishEvent(final PlayerFishEvent event)
705  	{
706  		final User user = ess.getUser(event.getPlayer());
707  		user.updateActivity(true);
708  	}
709  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Essentials-MDEwOlJlcG9zaXRvcnkxNzczNzU0-flat-Commandessentials.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Essentials-MDEwOlJlcG9zaXRvcnkxNzczNzU0-flat-EssentialsPlayerListener.java</div>
                </div>
                <div class="column column_space"><pre><code>278  						user.setLastLogin(currTime);
279  					}
280  					if (user.isNPC())
281  					{
282  						continue;
</pre></code></div>
                <div class="column column_space"><pre><code>153  			user.setGodModeEnabled(false);
154  		}
155  		if (user.isVanished())
156  		{
157  			user.setVanished(false);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    