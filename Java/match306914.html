<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
<HEAD><TITLE>Matches for DocIndexMetadataTest.java & InternalEngineTests.java</TITLE>
    <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <style>.modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0, 0, 0);
        background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
        height: 250%;
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 20px;
        font-weight: bold;
    }

    .close:hover, .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    .column {
        float: left;
        width: 50%;
    }

    .row:after {
        content: ;
        display: table;
        clear: both;
    }

    #column1, #column2 {
        white-space: pre-wrap;
    }</style>
</HEAD>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
        <h3 align="center">
            Matches for DocIndexMetadataTest.java & InternalEngineTests.java
        </h3>
        <h1 align="center">
            26.6%
        </h1>
        <center>
            <a href="index.html" target="_top">
                INDEX
            </a>
            <span>-</span>
            <a href="help-en.html" target="_top">
                HELP
            </a>
        </center>
    </div>
    <div>
        <TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TH>
                <TH>DocIndexMetadataTest.java (82.48537%)
                <TH>InternalEngineTests.java (15.857353%)
                <TH>Tokens
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#0',2,'match306914-1.html#0',3)" NAME="0">(24-103)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#0',2,'match306914-1.html#0',3)" NAME="0">(132-209)</A>
                <TD ALIGN=center><FONT COLOR="#ff0000">75</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#1',2,'match306914-1.html#1',3)" NAME="1">(218-277)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#1',2,'match306914-1.html#1',3)" NAME="1">(390-409)</A>
                <TD ALIGN=center><FONT COLOR="#c80000">59</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#2',2,'match306914-1.html#2',3)" NAME="2">(421-468)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#2',2,'match306914-1.html#2',3)" NAME="2">(368-383)</A>
                <TD ALIGN=center><FONT COLOR="#a60000">49</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#53858b"><FONT COLOR="#53858b">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#3',2,'match306914-1.html#3',3)" NAME="3">(163-163)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#3',2,'match306914-1.html#3',3)" NAME="3">(335-347)</A>
                <TD ALIGN=center><FONT COLOR="#8e0000">42</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#6cc417"><FONT COLOR="#6cc417">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#4',2,'match306914-1.html#4',3)" NAME="4">(1295-1295)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#4',2,'match306914-1.html#4',3)" NAME="4">(662-672)</A>
                <TD ALIGN=center><FONT COLOR="#840000">39</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#151b8d"><FONT COLOR="#151b8d">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#5',2,'match306914-1.html#5',3)" NAME="5">(340-340)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#5',2,'match306914-1.html#5',3)" NAME="5">(413-423)</A>
                <TD ALIGN=center><FONT COLOR="#770000">35</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#8c8774"><FONT COLOR="#8c8774">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#6',2,'match306914-1.html#6',3)" NAME="6">(1345-1345)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#6',2,'match306914-1.html#6',3)" NAME="6">(311-319)</A>
                <TD ALIGN=center><FONT COLOR="#6c0000">32</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#38a4a5"><FONT COLOR="#38a4a5">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#7',2,'match306914-1.html#7',3)" NAME="7">(469-479)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#7',2,'match306914-1.html#7',3)" NAME="7">(459-468)</A>
                <TD ALIGN=center><FONT COLOR="#660000">30</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#c58917"><FONT COLOR="#c58917">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#8',2,'match306914-1.html#8',3)" NAME="8">(1273-1286)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#8',2,'match306914-1.html#8',3)" NAME="8">(423-431)</A>
                <TD ALIGN=center><FONT COLOR="#620000">29</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#83a33a"><FONT COLOR="#83a33a">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#9',2,'match306914-1.html#9',3)" NAME="9">(914-937)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#9',2,'match306914-1.html#9',3)" NAME="9">(5212-5221)</A>
                <TD ALIGN=center><FONT COLOR="#5b0000">27</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#ad5910"><FONT COLOR="#ad5910">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#10',2,'match306914-1.html#10',3)" NAME="10">(753-757)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#10',2,'match306914-1.html#10',3)" NAME="10">(437-446)</A>
                <TD ALIGN=center><FONT COLOR="#5b0000">27</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#b041ff"><FONT COLOR="#b041ff">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#11',2,'match306914-1.html#11',3)" NAME="11">(812-837)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#11',2,'match306914-1.html#11',3)" NAME="11">(323-331)</A>
                <TD ALIGN=center><FONT COLOR="#580000">26</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#571b7e"><FONT COLOR="#571b7e">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#12',2,'match306914-1.html#12',3)" NAME="12">(624-624)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#12',2,'match306914-1.html#12',3)" NAME="12">(5162-5171)</A>
                <TD ALIGN=center><FONT COLOR="#580000">26</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#3b9c9c"><FONT COLOR="#3b9c9c">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#13',2,'match306914-1.html#13',3)" NAME="13">(511-512)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#13',2,'match306914-1.html#13',3)" NAME="13">(639-653)</A>
                <TD ALIGN=center><FONT COLOR="#580000">26</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#842dce"><FONT COLOR="#842dce">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#14',2,'match306914-1.html#14',3)" NAME="14">(1502-1502)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#14',2,'match306914-1.html#14',3)" NAME="14">(446-453)</A>
                <TD ALIGN=center><FONT COLOR="#4e0000">23</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#f52887"><FONT COLOR="#f52887">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#15',2,'match306914-1.html#15',3)" NAME="15">(1004-1010)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#15',2,'match306914-1.html#15',3)" NAME="15">(608-615)</A>
                <TD ALIGN=center><FONT COLOR="#4e0000">23</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#2981b2"><FONT COLOR="#2981b2">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#16',2,'match306914-1.html#16',3)" NAME="16">(1226-1245)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#16',2,'match306914-1.html#16',3)" NAME="16">(6129-6136)</A>
                <TD ALIGN=center><FONT COLOR="#470000">21</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#3090c7"><FONT COLOR="#3090c7">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#17',2,'match306914-1.html#17',3)" NAME="17">(880-898)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#17',2,'match306914-1.html#17',3)" NAME="17">(5269-5275)</A>
                <TD ALIGN=center><FONT COLOR="#470000">21</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#800517"><FONT COLOR="#800517">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#18',2,'match306914-1.html#18',3)" NAME="18">(401-410)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#18',2,'match306914-1.html#18',3)" NAME="18">(2454-2459)</A>
                <TD ALIGN=center><FONT COLOR="#470000">21</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#f62817"><FONT COLOR="#f62817">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#19',2,'match306914-1.html#19',3)" NAME="19">(1209-1225)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#19',2,'match306914-1.html#19',3)" NAME="19">(4904-4912)</A>
                <TD ALIGN=center><FONT COLOR="#440000">20</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#4e9258"><FONT COLOR="#4e9258">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#20',2,'match306914-1.html#20',3)" NAME="20">(1172-1175)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#20',2,'match306914-1.html#20',3)" NAME="20">(4651-4658)</A>
                <TD ALIGN=center><FONT COLOR="#440000">20</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#947010"><FONT COLOR="#947010">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#21',2,'match306914-1.html#21',3)" NAME="21">(870-876)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#21',2,'match306914-1.html#21',3)" NAME="21">(1562-1573)</A>
                <TD ALIGN=center><FONT COLOR="#440000">20</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#4cc417"><FONT COLOR="#4cc417">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#22',2,'match306914-1.html#22',3)" NAME="22">(536-556)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#22',2,'match306914-1.html#22',3)" NAME="22">(3965-3975)</A>
                <TD ALIGN=center><FONT COLOR="#440000">20</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#f660ab"><FONT COLOR="#f660ab">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#23',2,'match306914-1.html#23',3)" NAME="23">(134-134)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#23',2,'match306914-1.html#23',3)" NAME="23">(6336-6341)</A>
                <TD ALIGN=center><FONT COLOR="#440000">20</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#79764d"><FONT COLOR="#79764d">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#24',2,'match306914-1.html#24',3)" NAME="24">(966-981)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#24',2,'match306914-1.html#24',3)" NAME="24">(5367-5377)</A>
                <TD ALIGN=center><FONT COLOR="#400000">19</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#5eac10"><FONT COLOR="#5eac10">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#25',2,'match306914-1.html#25',3)" NAME="25">(849-849)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#25',2,'match306914-1.html#25',3)" NAME="25">(2549-2559)</A>
                <TD ALIGN=center><FONT COLOR="#400000">19</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#68818b"><FONT COLOR="#68818b">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#26',2,'match306914-1.html#26',3)" NAME="26">(782-782)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#26',2,'match306914-1.html#26',3)" NAME="26">(2527-2538)</A>
                <TD ALIGN=center><FONT COLOR="#400000">19</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#e77471"><FONT COLOR="#e77471">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#27',2,'match306914-1.html#27',3)" NAME="27">(736-752)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#27',2,'match306914-1.html#27',3)" NAME="27">(5238-5245)</A>
                <TD ALIGN=center><FONT COLOR="#400000">19</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#717d7d"><FONT COLOR="#717d7d">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#28',2,'match306914-1.html#28',3)" NAME="28">(706-706)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#28',2,'match306914-1.html#28',3)" NAME="28">(453-459)</A>
                <TD ALIGN=center><FONT COLOR="#400000">19</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#af7a82"><FONT COLOR="#af7a82">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#29',2,'match306914-1.html#29',3)" NAME="29">(483-483)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#29',2,'match306914-1.html#29',3)" NAME="29">(6179-6184)</A>
                <TD ALIGN=center><FONT COLOR="#400000">19</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#ae694a"><FONT COLOR="#ae694a">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#30',2,'match306914-1.html#30',3)" NAME="30">(1191-1208)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#30',2,'match306914-1.html#30',3)" NAME="30">(575-581)</A>
                <TD ALIGN=center><FONT COLOR="#3d0000">18</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#3ea99f"><FONT COLOR="#3ea99f">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#31',2,'match306914-1.html#31',3)" NAME="31">(842-849)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#31',2,'match306914-1.html#31',3)" NAME="31">(2880-2888)</A>
                <TD ALIGN=center><FONT COLOR="#3d0000">18</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#5b8daf"><FONT COLOR="#5b8daf">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#32',2,'match306914-1.html#32',3)" NAME="32">(1472-1488)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#32',2,'match306914-1.html#32',3)" NAME="32">(3053-3061)</A>
                <TD ALIGN=center><FONT COLOR="#390000">17</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#736aff"><FONT COLOR="#736aff">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#33',2,'match306914-1.html#33',3)" NAME="33">(1423-1428)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#33',2,'match306914-1.html#33',3)" NAME="33">(1225-1230)</A>
                <TD ALIGN=center><FONT COLOR="#390000">17</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#827d6b"><FONT COLOR="#827d6b">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#34',2,'match306914-1.html#34',3)" NAME="34">(1337-1344)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#34',2,'match306914-1.html#34',3)" NAME="34">(5860-5869)</A>
                <TD ALIGN=center><FONT COLOR="#390000">17</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#41a317"><FONT COLOR="#41a317">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#35',2,'match306914-1.html#35',3)" NAME="35">(1287-1294)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#35',2,'match306914-1.html#35',3)" NAME="35">(891-901)</A>
                <TD ALIGN=center><FONT COLOR="#390000">17</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#ff00ff"><FONT COLOR="#ff00ff">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#36',2,'match306914-1.html#36',3)" NAME="36">(1147-1151)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#36',2,'match306914-1.html#36',3)" NAME="36">(3630-3638)</A>
                <TD ALIGN=center><FONT COLOR="#390000">17</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#810541"><FONT COLOR="#810541">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#37',2,'match306914-1.html#37',3)" NAME="37">(1129-1133)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#37',2,'match306914-1.html#37',3)" NAME="37">(3618-3626)</A>
                <TD ALIGN=center><FONT COLOR="#390000">17</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#348781"><FONT COLOR="#348781">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#38',2,'match306914-1.html#38',3)" NAME="38">(721-730)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#38',2,'match306914-1.html#38',3)" NAME="38">(5819-5825)</A>
                <TD ALIGN=center><FONT COLOR="#390000">17</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#152dc6"><FONT COLOR="#152dc6">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#39',2,'match306914-1.html#39',3)" NAME="39">(681-681)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#39',2,'match306914-1.html#39',3)" NAME="39">(5179-5187)</A>
                <TD ALIGN=center><FONT COLOR="#390000">17</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#347235"><FONT COLOR="#347235">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#40',2,'match306914-1.html#40',3)" NAME="40">(656-668)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#40',2,'match306914-1.html#40',3)" NAME="40">(3413-3420)</A>
                <TD ALIGN=center><FONT COLOR="#390000">17</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#f87a17"><FONT COLOR="#f87a17">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#41',2,'match306914-1.html#41',3)" NAME="41">(207-210)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#41',2,'match306914-1.html#41',3)" NAME="41">(4417-4423)</A>
                <TD ALIGN=center><FONT COLOR="#390000">17</FONT>
            <TR onclick='openModal("#c57717")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#c57717"><FONT COLOR="#c57717">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#42',2,'match306914-1.html#42',3)" NAME="42">(1529-1535)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#42',2,'match306914-1.html#42',3)" NAME="42">(1157-1164)</A>
                <TD ALIGN=center><FONT COLOR="#360000">16</FONT>
            <TR onclick='openModal("#c22817")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#c22817"><FONT COLOR="#c22817">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#43',2,'match306914-1.html#43',3)" NAME="43">(1405-1405)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#43',2,'match306914-1.html#43',3)" NAME="43">(2150-2154)</A>
                <TD ALIGN=center><FONT COLOR="#360000">16</FONT>
            <TR onclick='openModal("#a057a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#a057a5"><FONT COLOR="#a057a5">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#44',2,'match306914-1.html#44',3)" NAME="44">(987-987)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#44',2,'match306914-1.html#44',3)" NAME="44">(431-436)</A>
                <TD ALIGN=center><FONT COLOR="#360000">16</FONT>
            <TR onclick='openModal("#549748")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#549748"><FONT COLOR="#549748">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#45',2,'match306914-1.html#45',3)" NAME="45">(949-959)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#45',2,'match306914-1.html#45',3)" NAME="45">(6079-6091)</A>
                <TD ALIGN=center><FONT COLOR="#360000">16</FONT>
            <TR onclick='openModal("#668b8b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#668b8b"><FONT COLOR="#668b8b">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#46',2,'match306914-1.html#46',3)" NAME="46">(938-948)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#46',2,'match306914-1.html#46',3)" NAME="46">(553-560)</A>
                <TD ALIGN=center><FONT COLOR="#360000">16</FONT>
            <TR onclick='openModal("#d16587")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#d16587"><FONT COLOR="#d16587">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#47',2,'match306914-1.html#47',3)" NAME="47">(1156-1157)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#47',2,'match306914-1.html#47',3)" NAME="47">(2717-2730)</A>
                <TD ALIGN=center><FONT COLOR="#330000">15</FONT>
            <TR onclick='openModal("#c57726")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#c57726"><FONT COLOR="#c57726">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#48',2,'match306914-1.html#48',3)" NAME="48">(1072-1084)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#48',2,'match306914-1.html#48',3)" NAME="48">(4698-4703)</A>
                <TD ALIGN=center><FONT COLOR="#330000">15</FONT>
            <TR onclick='openModal("#8e35ef")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#8e35ef"><FONT COLOR="#8e35ef">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#49',2,'match306914-1.html#49',3)" NAME="49">(1016-1032)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#49',2,'match306914-1.html#49',3)" NAME="49">(1766-1775)</A>
                <TD ALIGN=center><FONT COLOR="#330000">15</FONT>
            <TR onclick='openModal("#ff0000")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#ff0000"><FONT COLOR="#ff0000">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#50',2,'match306914-1.html#50',3)" NAME="50">(1544-1558)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#50',2,'match306914-1.html#50',3)" NAME="50">(2964-2972)</A>
                <TD ALIGN=center><FONT COLOR="#2f0000">14</FONT>
            <TR onclick='openModal("#b38481")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#b38481"><FONT COLOR="#b38481">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#51',2,'match306914-1.html#51',3)" NAME="51">(1495-1502)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#51',2,'match306914-1.html#51',3)" NAME="51">(4463-4475)</A>
                <TD ALIGN=center><FONT COLOR="#2f0000">14</FONT>
            <TR onclick='openModal("#2b60de")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#2b60de"><FONT COLOR="#2b60de">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#52',2,'match306914-1.html#52',3)" NAME="52">(1383-1391)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#52',2,'match306914-1.html#52',3)" NAME="52">(1496-1503)</A>
                <TD ALIGN=center><FONT COLOR="#2f0000">14</FONT>
            <TR onclick='openModal("#ad5a3d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#ad5a3d"><FONT COLOR="#ad5a3d">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#53',2,'match306914-1.html#53',3)" NAME="53">(1107-1113)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#53',2,'match306914-1.html#53',3)" NAME="53">(1197-1204)</A>
                <TD ALIGN=center><FONT COLOR="#2f0000">14</FONT>
            <TR onclick='openModal("#4e8975")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#4e8975"><FONT COLOR="#4e8975">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#54',2,'match306914-1.html#54',3)" NAME="54">(900-911)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#54',2,'match306914-1.html#54',3)" NAME="54">(4059-4066)</A>
                <TD ALIGN=center><FONT COLOR="#2f0000">14</FONT>
            <TR onclick='openModal("#4863a0")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#4863a0"><FONT COLOR="#4863a0">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#55',2,'match306914-1.html#55',3)" NAME="55">(804-812)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#55',2,'match306914-1.html#55',3)" NAME="55">(4091-4100)</A>
                <TD ALIGN=center><FONT COLOR="#2f0000">14</FONT>
            <TR onclick='openModal("#52d017")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#52d017"><FONT COLOR="#52d017">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#56',2,'match306914-1.html#56',3)" NAME="56">(700-706)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#56',2,'match306914-1.html#56',3)" NAME="56">(3275-3288)</A>
                <TD ALIGN=center><FONT COLOR="#2f0000">14</FONT>
            <TR onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#57',2,'match306914-1.html#57',3)" NAME="57">(378-384)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#57',2,'match306914-1.html#57',3)" NAME="57">(5205-5211)</A>
                <TD ALIGN=center><FONT COLOR="#2f0000">14</FONT>
            <TR onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#58',2,'match306914-1.html#58',3)" NAME="58">(288-293)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#58',2,'match306914-1.html#58',3)" NAME="58">(4047-4054)</A>
                <TD ALIGN=center><FONT COLOR="#2f0000">14</FONT>
            <TR onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#59',2,'match306914-1.html#59',3)" NAME="59">(1459-1466)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#59',2,'match306914-1.html#59',3)" NAME="59">(1297-1304)</A>
                <TD ALIGN=center><FONT COLOR="#2c0000">13</FONT>
            <TR onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#53858b"><FONT COLOR="#53858b">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#60',2,'match306914-1.html#60',3)" NAME="60">(1452-1458)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#60',2,'match306914-1.html#60',3)" NAME="60">(786-792)</A>
                <TD ALIGN=center><FONT COLOR="#2c0000">13</FONT>
            <TR onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#6cc417"><FONT COLOR="#6cc417">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#61',2,'match306914-1.html#61',3)" NAME="61">(1447-1451)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#61',2,'match306914-1.html#61',3)" NAME="61">(1277-1282)</A>
                <TD ALIGN=center><FONT COLOR="#2c0000">13</FONT>
            <TR onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#151b8d"><FONT COLOR="#151b8d">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#62',2,'match306914-1.html#62',3)" NAME="62">(1431-1433)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#62',2,'match306914-1.html#62',3)" NAME="62">(2402-2413)</A>
                <TD ALIGN=center><FONT COLOR="#2c0000">13</FONT>
            <TR onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#8c8774"><FONT COLOR="#8c8774">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#63',2,'match306914-1.html#63',3)" NAME="63">(1379-1382)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#63',2,'match306914-1.html#63',3)" NAME="63">(6062-6077)</A>
                <TD ALIGN=center><FONT COLOR="#2c0000">13</FONT>
            <TR onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#38a4a5"><FONT COLOR="#38a4a5">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#64',2,'match306914-1.html#64',3)" NAME="64">(1258-1272)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#64',2,'match306914-1.html#64',3)" NAME="64">(5762-5769)</A>
                <TD ALIGN=center><FONT COLOR="#2c0000">13</FONT>
            <TR onclick='openModal("#c58917")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#c58917"><FONT COLOR="#c58917">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#65',2,'match306914-1.html#65',3)" NAME="65">(1254-1257)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#65',2,'match306914-1.html#65',3)" NAME="65">(3497-3513)</A>
                <TD ALIGN=center><FONT COLOR="#2c0000">13</FONT>
            <TR onclick='openModal("#83a33a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#83a33a"><FONT COLOR="#83a33a">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#66',2,'match306914-1.html#66',3)" NAME="66">(1133-1147)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#66',2,'match306914-1.html#66',3)" NAME="66">(1315-1322)</A>
                <TD ALIGN=center><FONT COLOR="#2c0000">13</FONT>
            <TR onclick='openModal("#ad5910")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#ad5910"><FONT COLOR="#ad5910">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#67',2,'match306914-1.html#67',3)" NAME="67">(1046-1052)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#67',2,'match306914-1.html#67',3)" NAME="67">(1468-1475)</A>
                <TD ALIGN=center><FONT COLOR="#2c0000">13</FONT>
            <TR onclick='openModal("#b041ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#b041ff"><FONT COLOR="#b041ff">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#68',2,'match306914-1.html#68',3)" NAME="68">(670-677)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#68',2,'match306914-1.html#68',3)" NAME="68">(2814-2820)</A>
                <TD ALIGN=center><FONT COLOR="#2c0000">13</FONT>
            <TR onclick='openModal("#571b7e")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#571b7e"><FONT COLOR="#571b7e">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#69',2,'match306914-1.html#69',3)" NAME="69">(590-595)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#69',2,'match306914-1.html#69',3)" NAME="69">(5449-5459)</A>
                <TD ALIGN=center><FONT COLOR="#2c0000">13</FONT>
            <TR onclick='openModal("#3b9c9c")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#3b9c9c"><FONT COLOR="#3b9c9c">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#70',2,'match306914-1.html#70',3)" NAME="70">(572-576)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#70',2,'match306914-1.html#70',3)" NAME="70">(5739-5744)</A>
                <TD ALIGN=center><FONT COLOR="#2c0000">13</FONT>
            <TR onclick='openModal("#842dce")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#842dce"><FONT COLOR="#842dce">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#71',2,'match306914-1.html#71',3)" NAME="71">(324-329)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#71',2,'match306914-1.html#71',3)" NAME="71">(5745-5759)</A>
                <TD ALIGN=center><FONT COLOR="#2c0000">13</FONT>
            <TR onclick='openModal("#f52887")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#f52887"><FONT COLOR="#f52887">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#72',2,'match306914-1.html#72',3)" NAME="72">(210-212)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#72',2,'match306914-1.html#72',3)" NAME="72">(3447-3462)</A>
                <TD ALIGN=center><FONT COLOR="#2c0000">13</FONT>
            <TR onclick='openModal("#2981b2")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#2981b2"><FONT COLOR="#2981b2">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#73',2,'match306914-1.html#73',3)" NAME="73">(1466-1472)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#73',2,'match306914-1.html#73',3)" NAME="73">(1332-1338)</A>
                <TD ALIGN=center><FONT COLOR="#280000">12</FONT>
            <TR onclick='openModal("#3090c7")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#3090c7"><FONT COLOR="#3090c7">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#74',2,'match306914-1.html#74',3)" NAME="74">(595-608)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#74',2,'match306914-1.html#74',3)" NAME="74">(6035-6037)</A>
                <TD ALIGN=center><FONT COLOR="#280000">12</FONT>
            <TR onclick='openModal("#800517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#800517"><FONT COLOR="#800517">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#75',2,'match306914-1.html#75',3)" NAME="75">(501-507)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#75',2,'match306914-1.html#75',3)" NAME="75">(3024-3028)</A>
                <TD ALIGN=center><FONT COLOR="#280000">12</FONT>
            <TR onclick='openModal("#f62817")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#f62817"><FONT COLOR="#f62817">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#76',2,'match306914-1.html#76',3)" NAME="76">(278-283)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#76',2,'match306914-1.html#76',3)" NAME="76">(2841-2846)</A>
                <TD ALIGN=center><FONT COLOR="#280000">12</FONT>
            <TR onclick='openModal("#4e9258")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#4e9258"><FONT COLOR="#4e9258">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#77',2,'match306914-1.html#77',3)" NAME="77">(1489-1490)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#77',2,'match306914-1.html#77',3)" NAME="77">(2443-2446)</A>
                <TD ALIGN=center><FONT COLOR="#250000">11</FONT>
            <TR onclick='openModal("#947010")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#947010"><FONT COLOR="#947010">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#78',2,'match306914-1.html#78',3)" NAME="78">(1035-1044)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#78',2,'match306914-1.html#78',3)" NAME="78">(1574-1579)</A>
                <TD ALIGN=center><FONT COLOR="#250000">11</FONT>
            <TR onclick='openModal("#4cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#4cc417"><FONT COLOR="#4cc417">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#79',2,'match306914-1.html#79',3)" NAME="79">(865-869)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#79',2,'match306914-1.html#79',3)" NAME="79">(5494-5496)</A>
                <TD ALIGN=center><FONT COLOR="#250000">11</FONT>
            <TR onclick='openModal("#f660ab")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#f660ab"><FONT COLOR="#f660ab">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#80',2,'match306914-1.html#80',3)" NAME="80">(774-777)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#80',2,'match306914-1.html#80',3)" NAME="80">(385-389)</A>
                <TD ALIGN=center><FONT COLOR="#250000">11</FONT>
            <TR onclick='openModal("#79764d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#79764d"><FONT COLOR="#79764d">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#81',2,'match306914-1.html#81',3)" NAME="81">(649-654)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#81',2,'match306914-1.html#81',3)" NAME="81">(1115-1123)</A>
                <TD ALIGN=center><FONT COLOR="#250000">11</FONT>
            <TR onclick='openModal("#5eac10")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#5eac10"><FONT COLOR="#5eac10">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#82',2,'match306914-1.html#82',3)" NAME="82">(579-583)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#82',2,'match306914-1.html#82',3)" NAME="82">(287-292)</A>
                <TD ALIGN=center><FONT COLOR="#250000">11</FONT>
            <TR onclick='openModal("#68818b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#68818b"><FONT COLOR="#68818b">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#83',2,'match306914-1.html#83',3)" NAME="83">(283-286)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#83',2,'match306914-1.html#83',3)" NAME="83">(269-283)</A>
                <TD ALIGN=center><FONT COLOR="#250000">11</FONT>
            <TR onclick='openModal("#e77471")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#e77471"><FONT COLOR="#e77471">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#84',2,'match306914-1.html#84',3)" NAME="84">(109-118)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#84',2,'match306914-1.html#84',3)" NAME="84">(1167-1171)</A>
                <TD ALIGN=center><FONT COLOR="#250000">11</FONT>
            <TR onclick='openModal("#717d7d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#717d7d"><FONT COLOR="#717d7d">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#85',2,'match306914-1.html#85',3)" NAME="85">(1558-1561)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#85',2,'match306914-1.html#85',3)" NAME="85">(1243-1257)</A>
                <TD ALIGN=center><FONT COLOR="#220000">10</FONT>
            <TR onclick='openModal("#af7a82")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#af7a82"><FONT COLOR="#af7a82">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#86',2,'match306914-1.html#86',3)" NAME="86">(1536-1539)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#86',2,'match306914-1.html#86',3)" NAME="86">(856-859)</A>
                <TD ALIGN=center><FONT COLOR="#220000">10</FONT>
            <TR onclick='openModal("#ae694a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#ae694a"><FONT COLOR="#ae694a">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#87',2,'match306914-1.html#87',3)" NAME="87">(1418-1422)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#87',2,'match306914-1.html#87',3)" NAME="87">(1837-1839)</A>
                <TD ALIGN=center><FONT COLOR="#220000">10</FONT>
            <TR onclick='openModal("#3ea99f")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#3ea99f"><FONT COLOR="#3ea99f">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#88',2,'match306914-1.html#88',3)" NAME="88">(1118-1123)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#88',2,'match306914-1.html#88',3)" NAME="88">(694-700)</A>
                <TD ALIGN=center><FONT COLOR="#220000">10</FONT>
            <TR onclick='openModal("#5b8daf")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#5b8daf"><FONT COLOR="#5b8daf">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#89',2,'match306914-1.html#89',3)" NAME="89">(962-966)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#89',2,'match306914-1.html#89',3)" NAME="89">(862-867)</A>
                <TD ALIGN=center><FONT COLOR="#220000">10</FONT>
            <TR onclick='openModal("#736aff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#736aff"><FONT COLOR="#736aff">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#90',2,'match306914-1.html#90',3)" NAME="90">(959-961)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#90',2,'match306914-1.html#90',3)" NAME="90">(348-360)</A>
                <TD ALIGN=center><FONT COLOR="#220000">10</FONT>
            <TR onclick='openModal("#827d6b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#827d6b"><FONT COLOR="#827d6b">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#91',2,'match306914-1.html#91',3)" NAME="91">(393-397)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#91',2,'match306914-1.html#91',3)" NAME="91">(3202-3210)</A>
                <TD ALIGN=center><FONT COLOR="#220000">10</FONT>
            <TR onclick='openModal("#41a317")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#41a317"><FONT COLOR="#41a317">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#92',2,'match306914-1.html#92',3)" NAME="92">(385-388)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#92',2,'match306914-1.html#92',3)" NAME="92">(5465-5469)</A>
                <TD ALIGN=center><FONT COLOR="#220000">10</FONT>
            <TR onclick='openModal("#ff00ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#ff00ff"><FONT COLOR="#ff00ff">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#93',2,'match306914-1.html#93',3)" NAME="93">(317-320)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#93',2,'match306914-1.html#93',3)" NAME="93">(5091-5094)</A>
                <TD ALIGN=center><FONT COLOR="#220000">10</FONT>
            <TR onclick='openModal("#810541")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#810541"><FONT COLOR="#810541">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#94',2,'match306914-1.html#94',3)" NAME="94">(313-316)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#94',2,'match306914-1.html#94',3)" NAME="94">(3605-3616)</A>
                <TD ALIGN=center><FONT COLOR="#220000">10</FONT>
            <TR onclick='openModal("#348781")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#348781"><FONT COLOR="#348781">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#95',2,'match306914-1.html#95',3)" NAME="95">(309-312)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#95',2,'match306914-1.html#95',3)" NAME="95">(3539-3544)</A>
                <TD ALIGN=center><FONT COLOR="#220000">10</FONT>
            <TR onclick='openModal("#152dc6")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#152dc6"><FONT COLOR="#152dc6">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#96',2,'match306914-1.html#96',3)" NAME="96">(305-308)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#96',2,'match306914-1.html#96',3)" NAME="96">(3526-3531)</A>
                <TD ALIGN=center><FONT COLOR="#220000">10</FONT>
            <TR onclick='openModal("#347235")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#347235"><FONT COLOR="#347235">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#97',2,'match306914-1.html#97',3)" NAME="97">(301-304)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#97',2,'match306914-1.html#97',3)" NAME="97">(2908-2911)</A>
                <TD ALIGN=center><FONT COLOR="#220000">10</FONT>
            <TR onclick='openModal("#f87a17")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#f87a17"><FONT COLOR="#f87a17">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#98',2,'match306914-1.html#98',3)" NAME="98">(297-300)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#98',2,'match306914-1.html#98',3)" NAME="98">(482-486)</A>
                <TD ALIGN=center><FONT COLOR="#220000">10</FONT>
            <TR onclick='openModal("#c57717")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#c57717"><FONT COLOR="#c57717">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#99',2,'match306914-1.html#99',3)" NAME="99">(1525-1528)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#99',2,'match306914-1.html#99',3)" NAME="99">(3129-3131)</A>
                <TD ALIGN=center><FONT COLOR="#1e0000">9</FONT>
            <TR onclick='openModal("#c22817")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#c22817"><FONT COLOR="#c22817">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#100',2,'match306914-1.html#100',3)" NAME="100">(1032-1034)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#100',2,'match306914-1.html#100',3)" NAME="100">(946-951)</A>
                <TD ALIGN=center><FONT COLOR="#1e0000">9</FONT>
            <TR onclick='openModal("#a057a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#a057a5"><FONT COLOR="#a057a5">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#101',2,'match306914-1.html#101',3)" NAME="101">(410-421)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#101',2,'match306914-1.html#101',3)" NAME="101">(5626-5631)</A>
                <TD ALIGN=center><FONT COLOR="#1e0000">9</FONT>
            <TR onclick='openModal("#549748")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#549748"><FONT COLOR="#549748">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#102',2,'match306914-1.html#102',3)" NAME="102">(388-393)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#102',2,'match306914-1.html#102',3)" NAME="102">(2291-2297)</A>
                <TD ALIGN=center><FONT COLOR="#1e0000">9</FONT>
            <TR onclick='openModal("#668b8b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#668b8b"><FONT COLOR="#668b8b">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#103',2,'match306914-1.html#103',3)" NAME="103">(329-340)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#103',2,'match306914-1.html#103',3)" NAME="103">(5230-5235)</A>
                <TD ALIGN=center><FONT COLOR="#1e0000">9</FONT>
            <TR onclick='openModal("#d16587")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#d16587"><FONT COLOR="#d16587">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#104',2,'match306914-1.html#104',3)" NAME="104">(320-324)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#104',2,'match306914-1.html#104',3)" NAME="104">(1948-1959)</A>
                <TD ALIGN=center><FONT COLOR="#1e0000">9</FONT>
            <TR onclick='openModal("#c57726")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#c57726"><FONT COLOR="#c57726">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#105',2,'match306914-1.html#105',3)" NAME="105">(293-296)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#105',2,'match306914-1.html#105',3)" NAME="105">(3755-3756)</A>
                <TD ALIGN=center><FONT COLOR="#1e0000">9</FONT>
            <TR onclick='openModal("#8e35ef")' onmouseleave='this.style.backgroundColor = "#D0D0D0"'
                onmouseover='this.style.backgroundColor = "yellow"'>
                <TD BGCOLOR="#8e35ef"><FONT COLOR="#8e35ef">-</FONT>
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#106',2,'match306914-1.html#106',3)" NAME="106">(154-158)
                <TD><A HREF="javascript:ZweiFrames('match306914-0.html#106',2,'match306914-1.html#106',3)" NAME="106">(1272-1276)</A>
                <TD ALIGN=center><FONT COLOR="#1e0000">9</FONT>
        </TABLE>
    </div>
</div>
<hr>
<div style="display: flex;">
    <div style="flex-grow: 1;">
        <h3>
            <center>
                <span>DocIndexMetadataTest.java</span>
                <span> - </span>
                <span></span>
            </center>
        </h3>
        <HR>
        <PRE>
1 <A NAME="0"></A>
2 package io.crate.metadata.doc;
3 <FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match306914-1.html#0',3,'match306914-top.html#0',1)"><IMG
4         SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>import io.crate.Constants;
5 import io.crate.action.sql.SessionContext;
6 import io.crate.analyze.Analysis;
7 import io.crate.analyze.AnalyzedCreateTable;
8 import io.crate.analyze.BoundCreateTable;
9 import io.crate.analyze.CreateTableStatementAnalyzer;
10 import io.crate.analyze.NumberOfShards;
11 import io.crate.analyze.ParamTypeHints;
12 import io.crate.common.collections.Lists2;
13 import io.crate.data.Row;
14 import io.crate.expression.udf.UserDefinedFunctionService;
15 import io.crate.metadata.ColumnIdent;
16 import io.crate.metadata.CoordinatorTxnCtx;
17 import io.crate.metadata.FulltextAnalyzerResolver;
18 import io.crate.metadata.GeneratedReference;
19 import io.crate.metadata.IndexReference;
20 import io.crate.metadata.NodeContext;
21 import io.crate.metadata.Reference;
22 import io.crate.metadata.RelationName;
23 import io.crate.metadata.Schemas;
24 import io.crate.metadata.view.ViewInfoFactory;
25 import io.crate.planner.node.ddl.CreateTablePlan;
26 import io.crate.planner.operators.SubQueryResults;
27 import io.crate.sql.parser.SqlParser;
28 import io.crate.sql.tree.CheckConstraint;
29 import io.crate.sql.tree.ColumnPolicy;
30 import io.crate.sql.tree.CreateTable;
31 import io.crate.sql.tree.Expression;
32 import io.crate.sql.tree.Statement;
33 import io.crate.test.integration.CrateDummyClusterServiceUnitTest;
34 import io.crate.types.ArrayType;
35 import io.crate.types.DataType;
36 import io.crate.types.DataTypes;
37 import io.crate.types.ObjectType;
38 import io.crate.types.StringType;
39 import org.elasticsearch.cluster.metadata.IndexMetadata;
40 import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;
41 import org.elasticsearch.cluster.metadata.MappingMetadata;
42 import org.elasticsearch.common.bytes.BytesReference;
43 import org.elasticsearch.common.settings.Settings;
44 import org.elasticsearch.common.xcontent.XContentBuilder;
45 import org.elasticsearch.common.xcontent.XContentFactory;
46 import org.elasticsearch.common.xcontent.XContentHelper;
47 import org.elasticsearch.common.xcontent.XContentType;
48 import org.elasticsearch.env.Environment;
49 import org.elasticsearch.index.analysis.AnalysisRegistry;
50 import org.hamcrest.Matchers;
51 import org.junit.Before;
52 import org.junit.Test;
53 import java.io.IOException;
54 import java.nio.file.Path;
55 import java.util.ArrayList;
56 import java.util.Arrays;
57 import java.util.HashMap;
58 import java.util.List;
59 import java.util.Map;
60 import java.util.TreeMap;
61 import java.util.stream.Collectors;
62 import static io.crate.testing.TestingHelpers.createNodeContext;
63 import static io.crate.testing.SymbolMatchers.isFunction;
64 import static io.crate.testing.SymbolMatchers.isLiteral;
65 import static io.crate.testing.SymbolMatchers.isReference;
66 import static java.util.Collections.emptyMap;
67 import static org.hamcrest.Matchers.contains;
68 import static org.hamcrest.Matchers.containsInAnyOrder;
69 import static org.hamcrest.Matchers.equalTo;
70 import static org.hamcrest.Matchers.hasItems;
71 import static org.hamcrest.Matchers.hasKey;
72 import static org.hamcrest.Matchers.instanceOf;
73 import static org.hamcrest.Matchers.is;
74 import static org.hamcrest.Matchers.not;
75 import static org.hamcrest.Matchers.nullValue;
76 import static org.hamcrest.collection.IsCollectionWithSize.hasSize;
77 public class DocIndexMetadataTest extends CrateDummyClusterServiceUnitTest {
78     private UserDefinedFunctionService udfService</B></FONT>;
79     private NodeContext nodeCtx;
80 <A NAME="84"></A>    private IndexMetadata getIndexMetadata(String indexName,
81                                            XContentBuilder builder) throws IOException {
82         Map&lt;String, Object&gt; mappingSource = XContentHelper.convertToMap(BytesReference.bytes(builder), true, XContentType.JSON).v2();
83         mappingSource = <FONT color="#e77471"><A
84                 HREF="javascript:ZweiFrames('match306914-1.html#84',3,'match306914-top.html#84',1)"><IMG
85                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>sortProperties(mappingSource);
86         Settings.Builder settingsBuilder = Settings.builder()
87             .put(&quot;index.number_of_shards&quot;, 1)
88             .put(&quot;index.number_of_replicas&quot;, 0)
89             .put(&quot;index.version.created&quot;, org.elasticsearch.Version.CURRENT);
90         IndexMetadata.Builder mdBuilder = IndexMetadata.builder(indexName)
91             .settings(settingsBuilder)
92             .putMapping(new</B></FONT> MappingMetadata(Constants.DEFAULT_MAPPING_TYPE, mappingSource));
93         return mdBuilder.build();
94     }
95     private DocIndexMetadata newMeta(IndexMetadata metadata, String name) throws IOException {
96         return new DocIndexMetadata(nodeCtx, metadata, new RelationName(Schemas.DOC_SCHEMA_NAME, name)).build();
97     }
98     @Before
99     public void setupUdfService() {
100         nodeCtx = createNodeContext();
101         udfService = new UserDefinedFunctionService(clusterService, nodeCtx);
102     }
103 <A NAME="23"></A>
104     @Test
105     public void testNestedColumnIdent() throws Exception {
106         <FONT color="#f660ab"><A
107                 HREF="javascript:ZweiFrames('match306914-1.html#23',3,'match306914-top.html#23',1)"><IMG
108                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>XContentBuilder builder = XContentFactory.jsonBuilder</B></FONT>()
109             .startObject()
110                 .startObject(&quot;properties&quot;)
111                     .startObject(&quot;person&quot;)
112                         .startObject(&quot;properties&quot;)
113                             .startObject(&quot;addresses&quot;)
114                                 .startObject(&quot;properties&quot;)
115                                     .startObject(&quot;city&quot;)
116                                         .field(&quot;type&quot;, &quot;string&quot;)
117                                     .endObject()
118                                     .startObject(&quot;country&quot;)
119                                         .field(&quot;type&quot;, &quot;string&quot;)
120                                     .endObject()
121                                 .endObject()
122                             .endObject()
123                         .endObject()
124                     .endObject()
125 <A NAME="106"></A>                .endObject()
126             .endObject();
127         IndexMetadata metadata = <FONT color="#8e35ef"><A
128                 HREF="javascript:ZweiFrames('match306914-1.html#106',3,'match306914-top.html#106',1)"><IMG
129                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>getIndexMetadata(&quot;test1&quot;, builder);
130         DocIndexMetadata md = newMeta(metadata, &quot;test1&quot;);
131         Reference reference = md.references().get(new ColumnIdent(&quot;person&quot;, Arrays.asList(&quot;addresses&quot;, &quot;city&quot;)));
132         assertNotNull</B></FONT>(reference);
133     }
134 <A NAME="3"></A>
135     @Test
136     public void testExtractObjectColumnDefinitions() throws Exception {
137         XContentBuilder builder = <FONT color="#53858b"><A
138                 HREF="javascript:ZweiFrames('match306914-1.html#3',3,'match306914-top.html#3',1)"><IMG SRC="forward.gif"
139                                                                                                        ALT="other"
140                                                                                                        BORDER="0"
141                                                                                                        ALIGN="right"></A><B>XContentFactory.jsonBuilder</B></FONT>()
142             .startObject()
143             .startObject(&quot;properties&quot;)
144             .startObject(&quot;implicit_dynamic&quot;)
145             .startObject(&quot;properties&quot;)
146             .startObject(&quot;name&quot;)
147             .field(&quot;type&quot;, &quot;string&quot;)
148             .endObject()
149             .endObject()
150             .endObject()
151             .startObject(&quot;explicit_dynamic&quot;)
152             .field(&quot;dynamic&quot;, &quot;true&quot;)
153             .startObject(&quot;properties&quot;)
154             .startObject(&quot;name&quot;)
155             .field(&quot;type&quot;, &quot;string&quot;)
156             .endObject()
157             .startObject(&quot;age&quot;)
158             .field(&quot;type&quot;, &quot;integer&quot;)
159             .endObject()
160             .endObject()
161             .endObject()
162             .startObject(&quot;ignored&quot;)
163             .field(&quot;dynamic&quot;, &quot;false&quot;)
164             .startObject(&quot;properties&quot;)
165             .startObject(&quot;name&quot;)
166             .field(&quot;type&quot;, &quot;string&quot;)
167             .endObject()
168             .startObject(&quot;age&quot;)
169             .field(&quot;type&quot;, &quot;integer&quot;)
170             .endObject()
171             .endObject()
172             .endObject()
173             .startObject(&quot;strict&quot;)
174             .field(&quot;dynamic&quot;, &quot;strict&quot;)
175             .startObject(&quot;properties&quot;)
176             .startObject(&quot;age&quot;)
177             .field(&quot;type&quot;, &quot;integer&quot;)
178             .endObject()
179             .endObject()
180             .endObject()
181             .endObject()
182 <A NAME="41"></A>            .endObject();
183         IndexMetadata metadata = getIndexMetadata(&quot;test1&quot;, builder);
184         DocIndexMetadata md = newMeta(metadata, &quot;test1&quot;);
185 <A NAME="72"></A>        assertThat(<FONT color="#f87a17"><A
186                 HREF="javascript:ZweiFrames('match306914-1.html#41',3,'match306914-top.html#41',1)"><IMG
187                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>md.columns().size(), is(4));
188         assertThat(md.references().size(), is(20));
189         assertThat(md.references().get(new ColumnIdent(&quot;implicit_dynamic&quot;)).columnPolicy(), is(ColumnPolicy.DYNAMIC));
190         assertThat(md.references</B></FONT>().get(new ColumnIdent(&quot;explicit_dynamic&quot;)).columnPolicy(), <FONT
191                 color="#f52887"><A
192                 HREF="javascript:ZweiFrames('match306914-1.html#72',3,'match306914-top.html#72',1)"><IMG
193                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>is(ColumnPolicy.DYNAMIC));
194         assertThat(md.references().get(new ColumnIdent(&quot;ignored&quot;)).columnPolicy(), is(ColumnPolicy.IGNORED));
195         assertThat(md.references().get(new ColumnIdent(&quot;strict&quot;)).columnPolicy(), is</B></FONT>(ColumnPolicy.STRICT));
196     }
197 <A NAME="1"></A>    @Test
198     public void testExtractColumnDefinitions() throws Exception {
199         XContentBuilder builder = <FONT color="#f63526"><A
200                 HREF="javascript:ZweiFrames('match306914-1.html#1',3,'match306914-top.html#1',1)"><IMG SRC="forward.gif"
201                                                                                                        ALT="other"
202                                                                                                        BORDER="0"
203                                                                                                        ALIGN="right"></A><B>XContentFactory.jsonBuilder()
204             .startObject()
205                 .startObject(&quot;_meta&quot;)
206                     .field(&quot;primary_keys&quot;, &quot;integerIndexed&quot;)
207                 .endObject()
208                 .startObject(&quot;properties&quot;)
209                     .startObject(&quot;integerIndexed&quot;)
210                         .field(&quot;type&quot;, &quot;integer&quot;)
211                     .endObject()
212                     .startObject(&quot;integerIndexedBWC&quot;)
213                         .field(&quot;type&quot;, &quot;integer&quot;)
214                         .field(&quot;index&quot;, &quot;not_analyzed&quot;)
215                     .endObject()
216                     .startObject(&quot;integerNotIndexed&quot;)
217                         .field(&quot;type&quot;, &quot;integer&quot;)
218                         .field(&quot;index&quot;, &quot;false&quot;)
219                     .endObject()
220                     .startObject(&quot;integerNotIndexedBWC&quot;)
221                         .field(&quot;type&quot;, &quot;integer&quot;)
222                         .field(&quot;index&quot;, &quot;no&quot;)
223                     .endObject()
224                     .startObject(&quot;stringNotIndexed&quot;)
225                         .field(&quot;type&quot;, &quot;string&quot;)
226                         .field(&quot;index&quot;, &quot;false&quot;)
227                     .endObject()
228                     .startObject(&quot;stringNotIndexedBWC&quot;)
229                         .field(&quot;type&quot;, &quot;string&quot;)
230                         .field(&quot;index&quot;, &quot;no&quot;)
231                     .endObject()
232                     .startObject(&quot;stringNotAnalyzed&quot;)
233                         .field(&quot;type&quot;, &quot;keyword&quot;)
234                     .endObject()
235                     .startObject(&quot;stringNotAnalyzedBWC&quot;)
236                         .field(&quot;type&quot;, &quot;string&quot;)
237                         .field(&quot;index&quot;, &quot;not_analyzed&quot;)
238                     .endObject()
239                     .startObject(&quot;stringAnalyzed&quot;)
240                         .field(&quot;type&quot;, &quot;text&quot;)
241                         .field(&quot;analyzer&quot;, &quot;standard&quot;)
242                     .endObject()
243                     .startObject(&quot;stringAnalyzedBWC&quot;)
244                         .field(&quot;type&quot;, &quot;string&quot;)
245                         .field(&quot;index&quot;, &quot;analyzed&quot;)
246                         .field(&quot;analyzer&quot;, &quot;standard&quot;)
247                     .endObject()
248                     .startObject(&quot;person&quot;)
249                         .startObject(&quot;properties&quot;)
250                             .startObject(&quot;first_name&quot;)
251                                 .field(&quot;type&quot;, &quot;string&quot;)
252                             .endObject()
253                             .startObject(&quot;birthday&quot;)
254                                 .field(&quot;type&quot;, &quot;date&quot;)
255                             .endObject()
256                         .endObject()
257                     .endObject()
258                 .endObject()
259             .endObject();
260 <A NAME="76"></A>        
261         IndexMetadata metadata = getIndexMetadata</B></FONT>(&quot;test1&quot;, builder);
262         <FONT color="#f62817"><A
263                 HREF="javascript:ZweiFrames('match306914-1.html#76',3,'match306914-top.html#76',1)"><IMG
264                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>DocIndexMetadata md = newMeta(metadata, &quot;test1&quot;);
265 <A NAME="83"></A>        assertThat(md.columns().size(), is(11));
266         assertThat(md.references().size(), is(23));
267         Reference birthday = <FONT color="#68818b"><A
268                     HREF="javascript:ZweiFrames('match306914-1.html#83',3,'match306914-top.html#83',1)"><IMG
269                     SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>md.references().get</B></FONT>(new ColumnIdent(&quot;person&quot;, &quot;birthday&quot;));
270         assertThat(birthday.valueType(), is(DataTypes.TIMESTAMPZ));
271 <A NAME="58"></A>        assertThat(birthday.indexType(), is(Reference.IndexType.PLAIN));
272         assertThat(birthday.defaultExpression(), is</B></FONT>(nullValue()) );
273         Reference integerIndexed = <FONT color="#f63526"><A
274                 HREF="javascript:ZweiFrames('match306914-1.html#58',3,'match306914-top.html#58',1)"><IMG
275                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>md.references().get(new ColumnIdent(&quot;integerIndexed&quot;));
276         assertThat(integerIndexed.indexType(), is(Reference.IndexType.PLAIN));
277 <A NAME="105"></A>        assertThat(integerIndexed.defaultExpression(), is(nullValue()) );
278         Reference integerIndexedBWC = md.references().get(new ColumnIdent(&quot;integerIndexedBWC&quot;));
279         assertThat</B></FONT>(<FONT color="#c57726"><A
280                 HREF="javascript:ZweiFrames('match306914-1.html#105',3,'match306914-top.html#105',1)"><IMG
281                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>integerIndexedBWC.indexType(), is(Reference.IndexType.PLAIN));
282 <A NAME="98"></A>        assertThat(integerIndexedBWC.defaultExpression(), is(nullValue()) );
283         Reference integerNotIndexed = md.references</B></FONT>().get(new ColumnIdent(&quot;integerNotIndexed&quot;));
284         <FONT color="#f87a17"><A
285                 HREF="javascript:ZweiFrames('match306914-1.html#98',3,'match306914-top.html#98',1)"><IMG
286                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertThat(integerNotIndexed.indexType(), is(Reference.IndexType.NONE));
287 <A NAME="97"></A>        assertThat(integerNotIndexed.defaultExpression(), is(nullValue()) );
288         Reference integerNotIndexedBWC = md.references</B></FONT>().get(new ColumnIdent(&quot;integerNotIndexedBWC&quot;));
289         <FONT color="#347235"><A
290                 HREF="javascript:ZweiFrames('match306914-1.html#97',3,'match306914-top.html#97',1)"><IMG
291                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertThat(integerNotIndexedBWC.indexType(), is(Reference.IndexType.NONE));
292 <A NAME="96"></A>        assertThat(integerNotIndexedBWC.defaultExpression(), is(nullValue()) );
293         Reference stringNotIndexed = md.references</B></FONT>().get(new ColumnIdent(&quot;stringNotIndexed&quot;));
294         <FONT color="#152dc6"><A
295                 HREF="javascript:ZweiFrames('match306914-1.html#96',3,'match306914-top.html#96',1)"><IMG
296                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertThat(stringNotIndexed.indexType(), is(Reference.IndexType.NONE));
297 <A NAME="95"></A>        assertThat(stringNotIndexed.defaultExpression(), is(nullValue()) );
298         Reference stringNotIndexedBWC = md.references</B></FONT>().get(new ColumnIdent(&quot;stringNotIndexedBWC&quot;));
299         <FONT color="#348781"><A
300                 HREF="javascript:ZweiFrames('match306914-1.html#95',3,'match306914-top.html#95',1)"><IMG
301                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertThat(stringNotIndexedBWC.indexType(), is(Reference.IndexType.NONE));
302 <A NAME="94"></A>        assertThat(stringNotIndexedBWC.defaultExpression(), is(nullValue()) );
303         Reference stringNotAnalyzed = md.references</B></FONT>().get(new ColumnIdent(&quot;stringNotAnalyzed&quot;));
304         <FONT color="#810541"><A
305                 HREF="javascript:ZweiFrames('match306914-1.html#94',3,'match306914-top.html#94',1)"><IMG
306                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertThat(stringNotAnalyzed.indexType(), is(Reference.IndexType.PLAIN));
307 <A NAME="93"></A>        assertThat(stringNotAnalyzed.defaultExpression(), is(nullValue()) );
308         Reference stringNotAnalyzedBWC = md.references</B></FONT>().get(new ColumnIdent(&quot;stringNotAnalyzedBWC&quot;));
309 <A NAME="104"></A>        <FONT color="#ff00ff"><A
310                 HREF="javascript:ZweiFrames('match306914-1.html#93',3,'match306914-top.html#93',1)"><IMG
311                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertThat(stringNotAnalyzedBWC.indexType(), is(Reference.IndexType.PLAIN));
312         assertThat(stringNotAnalyzedBWC.defaultExpression(), is(nullValue()) );
313         Reference stringAnalyzed = md.references</B></FONT>().get(<FONT color="#d16587"><A
314                 HREF="javascript:ZweiFrames('match306914-1.html#104',3,'match306914-top.html#104',1)"><IMG
315                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>new ColumnIdent(&quot;stringAnalyzed&quot;));
316 <A NAME="71"></A>        assertThat(stringAnalyzed.indexType(), is(Reference.IndexType.FULLTEXT));
317         assertThat(stringAnalyzed.defaultExpression(), is(nullValue()) );
318         Reference stringAnalyzedBWC = <FONT color="#842dce"><A
319                     HREF="javascript:ZweiFrames('match306914-1.html#71',3,'match306914-top.html#71',1)"><IMG
320                     SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>md.references().get(new ColumnIdent(&quot;stringAnalyzedBWC&quot;))</B></FONT>;
321         assertThat(stringAnalyzedBWC.indexType(), is(Reference.IndexType.FULLTEXT));
322 <A NAME="103"></A>        assertThat(stringAnalyzedBWC.defaultExpression(), is(nullValue()) );
323         assertThat(
324             Lists2.map(md.references</B></FONT>().values(), r -&gt; <FONT color="#668b8b"><A
325                 HREF="javascript:ZweiFrames('match306914-1.html#103',3,'match306914-top.html#103',1)"><IMG
326                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>r.column().fqn()),
327             containsInAnyOrder(&quot;_doc&quot;, &quot;_fetchid&quot;, &quot;_id&quot;, &quot;_raw&quot;, &quot;_score&quot;, &quot;_uid&quot;, &quot;_version&quot;, &quot;_docid&quot;, &quot;_seq_no&quot;,
328                 &quot;_primary_term&quot;, &quot;integerIndexed&quot;, &quot;integerIndexedBWC&quot;, &quot;integerNotIndexed&quot;, &quot;integerNotIndexedBWC&quot;,
329                 &quot;person&quot;, &quot;person.birthday&quot;, &quot;person.first_name&quot;,
330                 &quot;stringAnalyzed&quot;, &quot;stringAnalyzedBWC&quot;, &quot;stringNotAnalyzed&quot;, &quot;stringNotAnalyzedBWC&quot;,
331                 &quot;stringNotIndexed&quot;, &quot;stringNotIndexedBWC&quot;));
332     }
333 <A NAME="5"></A>    @Test
334     public void testExtractColumnDefinitionsWithDefaultExpression() throws Exception {
335         XContentBuilder builder = <FONT color="#151b8d"><A
336                     HREF="javascript:ZweiFrames('match306914-1.html#5',3,'match306914-top.html#5',1)"><IMG
337                     SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>XContentFactory.jsonBuilder</B></FONT>()</B></FONT>
338             .startObject()
339                 .startObject(&quot;_meta&quot;)
340                     .field(&quot;primary_keys&quot;, &quot;integerIndexed&quot;)
341                 .endObject()
342                 .startObject(&quot;properties&quot;)
343                     .startObject(&quot;integerIndexed&quot;)
344                         .field(&quot;type&quot;, &quot;integer&quot;)
345                         .field(&quot;default_expr&quot;, &quot;1&quot;)
346                     .endObject()
347                     .startObject(&quot;integerNotIndexed&quot;)
348                         .field(&quot;type&quot;, &quot;integer&quot;)
349                         .field(&quot;index&quot;, &quot;false&quot;)
350                         .field(&quot;default_expr&quot;, &quot;1&quot;)
351                     .endObject()
352                     .startObject(&quot;stringNotIndexed&quot;)
353                         .field(&quot;type&quot;, &quot;string&quot;)
354                         .field(&quot;index&quot;, &quot;false&quot;)
355                         .field(&quot;default_expr&quot;, &quot;'default'&quot;)
356                     .endObject()
357                     .startObject(&quot;stringNotAnalyzed&quot;)
358                         .field(&quot;type&quot;, &quot;keyword&quot;)
359                         .field(&quot;default_expr&quot;, &quot;'default'&quot;)
360                     .endObject()
361                     .startObject(&quot;stringAnalyzed&quot;)
362                         .field(&quot;type&quot;, &quot;text&quot;)
363                         .field(&quot;analyzer&quot;, &quot;standard&quot;)
364                         .field(&quot;default_expr&quot;, &quot;'default'&quot;)
365                     .endObject()
366                     .startObject(&quot;birthday&quot;)
367                         .field(&quot;type&quot;, &quot;date&quot;)
368                         .field(&quot;default_expr&quot;, &quot;current_timestamp(3)&quot;)
369                     .endObject()
370                 .endObject()
371 <A NAME="57"></A>            .endObject();
372         IndexMetadata metadata = <FONT color="#0000ff"><A
373                 HREF="javascript:ZweiFrames('match306914-1.html#57',3,'match306914-top.html#57',1)"><IMG
374                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>getIndexMetadata(&quot;test1&quot;, builder);
375         DocIndexMetadata md = newMeta(metadata, &quot;test1&quot;);
376         assertThat(md.columns().size(), is(6));
377 <A NAME="92"></A>        assertThat(md.references().size(), is(16));
378         Reference birthday = md.references</B></FONT>().get(new ColumnIdent(&quot;birthday&quot;));
379 <A NAME="102"></A>        <FONT color="#41a317"><A
380                 HREF="javascript:ZweiFrames('match306914-1.html#92',3,'match306914-top.html#92',1)"><IMG
381                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertThat(birthday.valueType(), is(DataTypes.TIMESTAMPZ));
382         assertThat(birthday.defaultExpression(), isFunction(&quot;current_timestamp&quot;, List.of(DataTypes.INTEGER)));
383         Reference integerIndexed = md.references</B></FONT>().get(<FONT color="#549748"><A
384                 HREF="javascript:ZweiFrames('match306914-1.html#102',3,'match306914-top.html#102',1)"><IMG
385                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>new ColumnIdent(&quot;integerIndexed&quot;));
386         assertThat(integerIndexed.indexType(), is(Reference.IndexType.PLAIN));
387 <A NAME="91"></A>        assertThat(integerIndexed.defaultExpression(), isLiteral(1));
388         Reference integerNotIndexed = <FONT color="#827d6b"><A
389                     HREF="javascript:ZweiFrames('match306914-1.html#91',3,'match306914-top.html#91',1)"><IMG
390                     SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>md.references().get</B></FONT>(new ColumnIdent(&quot;integerNotIndexed&quot;));
391         assertThat(integerNotIndexed.indexType(), is(Reference.IndexType.NONE));
392         assertThat(integerNotIndexed.defaultExpression(), isLiteral(1));
393         Reference stringNotIndexed = md.references().get</B></FONT>(new ColumnIdent(&quot;stringNotIndexed&quot;));
394 <A NAME="18"></A>        assertThat(stringNotIndexed.indexType(), is(Reference.IndexType.NONE));
395         assertThat(stringNotIndexed.defaultExpression(), isLiteral(&quot;default&quot;));
396         Reference stringNotAnalyzed = <FONT color="#800517"><A
397                 HREF="javascript:ZweiFrames('match306914-1.html#18',3,'match306914-top.html#18',1)"><IMG
398                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>md.references().get(new ColumnIdent(&quot;stringNotAnalyzed&quot;));
399         assertThat(stringNotAnalyzed.indexType(), is(Reference.IndexType.PLAIN));
400         assertThat(stringNotAnalyzed.defaultExpression(), isLiteral(&quot;default&quot;));
401         Reference stringAnalyzed = md.references().get(new ColumnIdent(&quot;stringAnalyzed&quot;));
402         assertThat(stringAnalyzed.indexType(), is(Reference.IndexType.FULLTEXT));
403 <A NAME="101"></A>        assertThat(stringAnalyzed.defaultExpression(), isLiteral(&quot;default&quot;));
404         assertThat(
405             Lists2.map</B></FONT>(md.references().values(), r -&gt; <FONT color="#a057a5"><A
406                 HREF="javascript:ZweiFrames('match306914-1.html#101',3,'match306914-top.html#101',1)"><IMG
407                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>r.column().fqn()),
408             containsInAnyOrder(
409                 &quot;_raw&quot;, &quot;_doc&quot;, &quot;_seq_no&quot;, &quot;_version&quot;, &quot;_id&quot;, &quot;_uid&quot;,
410                 &quot;_score&quot;, &quot;_fetchid&quot;, &quot;_primary_term&quot;, &quot;_docid&quot;,
411                 &quot;birthday&quot;, &quot;integerIndexed&quot;, &quot;integerNotIndexed&quot;,
412                 &quot;stringAnalyzed&quot;, &quot;stringNotAnalyzed&quot;, &quot;stringNotIndexed&quot;));
413     }
414 <A NAME="2"></A>    @Test
415     public void testExtractPartitionedByColumns() throws Exception {
416         XContentBuilder builder = <FONT color="#980517"><A
417                     HREF="javascript:ZweiFrames('match306914-1.html#2',3,'match306914-top.html#2',1)"><IMG
418                     SRC="forward.gif" ALT="other" BORDER="0"
419                     ALIGN="right"></A><B>XContentFactory.jsonBuilder()</B></FONT>
420             .startObject()
421             .startObject(&quot;_meta&quot;)
422                 .field(&quot;primary_keys&quot;, &quot;id&quot;)
423                 .startArray(&quot;partitioned_by&quot;)
424                     .startArray()
425                     .value(&quot;datum&quot;).value(&quot;date&quot;)
426                     .endArray()
427                 .endArray()
428             .endObject()
429             .startObject(&quot;properties&quot;)
430                 .startObject(&quot;id&quot;)
431                     .field(&quot;type&quot;, &quot;integer&quot;)
432                 .endObject()
433                 .startObject(&quot;title&quot;)
434                     .field(&quot;type&quot;, &quot;string&quot;)
435                     .field(&quot;index&quot;, &quot;false&quot;)
436                 .endObject()
437                 .startObject(&quot;datum&quot;)
438                     .field(&quot;type&quot;, &quot;date&quot;)
439                 .endObject()
440                 .startObject(&quot;content&quot;)
441                     .field(&quot;type&quot;, &quot;string&quot;)
442                     .field(&quot;index&quot;, &quot;true&quot;)
443                     .field(&quot;analyzer&quot;, &quot;standard&quot;)
444                 .endObject()
445                 .startObject(&quot;person&quot;)
446                     .startObject(&quot;properties&quot;)
447                         .startObject(&quot;first_name&quot;)
448                             .field(&quot;type&quot;, &quot;string&quot;)
449                         .endObject()
450                         .startObject(&quot;birthday&quot;)
451                             .field(&quot;type&quot;, &quot;date&quot;)
452                         .endObject()
453                     .endObject()
454                 .endObject()
455                 .startObject(&quot;nested&quot;)
456                     .field(&quot;type&quot;, &quot;nested&quot;)
457                     .startObject(&quot;properties&quot;)
458                         .startObject(&quot;inner_nested&quot;)
459                             .field(&quot;type&quot;, &quot;date&quot;)
460                         .endObject()
461                     .endObject()
462                 .endObject()
463             .endObject()
464 <A NAME="7"></A>            .endObject();
465         IndexMetadata metadata = getIndexMetadata</B></FONT>(&quot;test1&quot;, builder);
466         DocIndexMetadata md = <FONT color="#38a4a5"><A
467                 HREF="javascript:ZweiFrames('match306914-1.html#7',3,'match306914-top.html#7',1)"><IMG SRC="forward.gif"
468                                                                                                        ALT="other"
469                                                                                                        BORDER="0"
470                                                                                                        ALIGN="right"></A><B>newMeta(metadata, &quot;test1&quot;);
471         assertEquals(6, md.columns().size());
472         assertEquals(19, md.references().size());
473         assertEquals(1, md.partitionedByColumns().size());
474         assertEquals(DataTypes.TIMESTAMPZ, md.partitionedByColumns().get(0).valueType());
475         assertThat(md.partitionedByColumns().get(0).column().fqn(), is(&quot;datum&quot;));
476         assertThat(md.partitionedBy().size(), is(1));
477         assertThat(md.partitionedBy().get(0), is(ColumnIdent.fromPath(&quot;datum&quot;)));
478     }</B></FONT>
479 <A NAME="29"></A>
480     @Test
481     public void testExtractPartitionedByWithPartitionedByInColumns() throws Exception {
482         <FONT color="#af7a82"><A
483                 HREF="javascript:ZweiFrames('match306914-1.html#29',3,'match306914-top.html#29',1)"><IMG
484                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>XContentBuilder builder = XContentFactory.jsonBuilder()</B></FONT>
485             .startObject()
486             .startObject(&quot;_meta&quot;)
487             .startArray(&quot;partitioned_by&quot;)
488             .startArray()
489             .value(&quot;datum&quot;).value(&quot;date&quot;)
490             .endArray()
491             .endArray()
492             .endObject()
493             .startObject(&quot;properties&quot;)
494             .startObject(&quot;id&quot;)
495             .field(&quot;type&quot;, &quot;integer&quot;)
496             .endObject()
497             .startObject(&quot;datum&quot;)
498             .field(&quot;type&quot;, &quot;date&quot;)
499 <A NAME="75"></A>            .endObject()
500             .endObject()
501             .endObject();
502         IndexMetadata metadata = <FONT color="#800517"><A
503                 HREF="javascript:ZweiFrames('match306914-1.html#75',3,'match306914-top.html#75',1)"><IMG
504                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>getIndexMetadata(&quot;test1&quot;, builder);
505         DocIndexMetadata md = newMeta(metadata, &quot;test1&quot;);
506         assertEquals(2, md.columns().size());
507         assertEquals(12, md.references().size());
508         assertEquals(1, md.partitionedByColumns</B></FONT>().size());
509 <A NAME="13"></A>    }
510     @Test
511     public void testExtractPartitionedByWithNestedPartitionedByInColumns() throws Exception <FONT color="#3b9c9c"><A
512                 HREF="javascript:ZweiFrames('match306914-1.html#13',3,'match306914-top.html#13',1)"><IMG
513                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>{
514         XContentBuilder builder = XContentFactory.jsonBuilder</B></FONT>()
515             .startObject()
516             .startObject(&quot;_meta&quot;)
517             .startArray(&quot;partitioned_by&quot;)
518             .startArray()
519             .value(&quot;nested.datum&quot;).value(&quot;date&quot;)
520             .endArray()
521             .endArray()
522             .endObject()
523             .startObject(&quot;properties&quot;)
524             .startObject(&quot;id&quot;)
525             .field(&quot;type&quot;, &quot;integer&quot;)
526             .endObject()
527             .startObject(&quot;nested&quot;)
528             .field(&quot;type&quot;, &quot;nested&quot;)
529             .startObject(&quot;properties&quot;)
530             .startObject(&quot;datum&quot;)
531             .field(&quot;type&quot;, &quot;date&quot;)
532             .endObject()
533             .endObject()
534             .endObject()
535 <A NAME="22"></A>            .endObject()
536             .endObject();
537         IndexMetadata metadata = getIndexMetadata(&quot;test1&quot;, builder);
538         DocIndexMetadata md = <FONT color="#4cc417"><A
539                 HREF="javascript:ZweiFrames('match306914-1.html#22',3,'match306914-top.html#22',1)"><IMG
540                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>newMeta(metadata, &quot;test1&quot;);
541         assertEquals(2, md.columns().size());
542         assertEquals(13, md.references().size());
543         assertEquals(1, md.partitionedByColumns().size());
544     }
545     private Map&lt;String, Object&gt; sortProperties(Map&lt;String, Object&gt; mappingSource) {
546         return sortProperties(mappingSource, false);
547     }
548     @SuppressWarni</B></FONT>ngs(&quot;unchecked&quot;)
549     private Map&lt;String, Object&gt; sortProperties(Map&lt;String, Object&gt; mappingSource, boolean doSort) {
550         Map&lt;String, Object&gt; map;
551         if (doSort) {
552             map = new TreeMap&lt;&gt;();
553         } else {
554             map = new HashMap&lt;&gt;();
555         }
556         boolean sortNext;
557         Object value;
558         for (Map.Entry&lt;String, Object&gt; entry : mappingSource.entrySet()) {
559             value = entry.getValue();
560 <A NAME="70"></A>            sortNext = entry.getKey().equals(&quot;properties&quot;);
561             if (value instanceof Map) {
562                 <FONT color="#3b9c9c"><A
563                         HREF="javascript:ZweiFrames('match306914-1.html#70',3,'match306914-top.html#70',1)"><IMG
564                         SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>map.put(entry.getKey(), sortProperties((Map) entry.getValue(), sortNext));
565             } else {
566                 map.put(entry.getKey(), entry.getValue());
567             }
568 <A NAME="82"></A>        }</B></FONT>
569         return map;
570     <FONT color="#5eac10"><A HREF="javascript:ZweiFrames('match306914-1.html#82',3,'match306914-top.html#82',1)"><IMG
571             SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>}
572     @Test
573     public void testExtractColumnDefinitionsFromEmptyIndex() throws Exception {
574         XContentBuilder builder = XContentFactory.jsonBuilder</B></FONT>()
575             .startObject()
576             .startObject(Constants.DEFAULT_MAPPING_TYPE)
577             .endObject()
578 <A NAME="69"></A>            .endObject();
579         IndexMetadata metadata = getIndexMetadata(&quot;test2&quot;, builder);
580         DocIndexMetadata md = newMeta(metadata, &quot;test2&quot;);
581         <FONT color="#571b7e"><A
582                 HREF="javascript:ZweiFrames('match306914-1.html#69',3,'match306914-top.html#69',1)"><IMG
583                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertThat(md.columns(), hasSize(0));
584     }
585 <A NAME="74"></A>
586     @Test
587     public void testDocSysColumnReferences() throws Exception {
588         XContentBuilder builder = <FONT color="#3090c7"><A
589                     HREF="javascript:ZweiFrames('match306914-1.html#74',3,'match306914-top.html#74',1)"><IMG
590                     SRC="forward.gif" ALT="other" BORDER="0"
591                     ALIGN="right"></A><B>XContentFactory.jsonBuilder()</B></FONT>
592             .startObject()
593             .startObject(Constants.DEFAULT_MAPPING_TYPE)
594             .startObject(&quot;properties&quot;)
595             .startObject(&quot;content&quot;)
596             .field(&quot;type&quot;, &quot;string&quot;)
597             .endObject()
598             .endObject()
599             .endObject()
600             .endObject();
601         DocIndexMetadata metadata = newMeta(getIndexMetadata(&quot;test&quot;, builder), &quot;test&quot;);
602         Map&lt;ColumnIdent,Reference&gt; references = metadata.references();
603         Reference id = references.get</B></FONT>(new ColumnIdent(&quot;_id&quot;));
604         assertNotNull(id);
605         Reference version = references.get(new ColumnIdent(&quot;_version&quot;));
606         assertNotNull(version);
607         Reference score = references.get(new ColumnIdent(&quot;_score&quot;));
608         assertNotNull(score);
609         Reference docId = references.get(new ColumnIdent(&quot;_docid&quot;));
610         assertNotNull(docId);
611     }
612 <A NAME="12"></A>    @Test
613     public void testExtractPrimaryKey() throws Exception {
614         <FONT color="#571b7e"><A
615                 HREF="javascript:ZweiFrames('match306914-1.html#12',3,'match306914-top.html#12',1)"><IMG
616                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>XContentBuilder builder = XContentFactory.jsonBuilder</B></FONT>()
617             .startObject()
618             .startObject(Constants.DEFAULT_MAPPING_TYPE)
619             .startObject(&quot;_meta&quot;)
620             .field(&quot;primary_keys&quot;, &quot;id&quot;)
621             .endObject()
622             .startObject(&quot;properties&quot;)
623             .startObject(&quot;id&quot;)
624             .field(&quot;type&quot;, &quot;integer&quot;)
625             .endObject()
626             .startObject(&quot;title&quot;)
627             .field(&quot;type&quot;, &quot;string&quot;)
628             .field(&quot;index&quot;, &quot;false&quot;)
629             .endObject()
630             .startObject(&quot;datum&quot;)
631             .field(&quot;type&quot;, &quot;date&quot;)
632             .endObject()
633             .startObject(&quot;content&quot;)
634             .field(&quot;type&quot;, &quot;string&quot;)
635             .field(&quot;index&quot;, &quot;true&quot;)
636             .field(&quot;analyzer&quot;, &quot;standard&quot;)
637             .endObject()
638 <A NAME="81"></A>            .endObject()
639             .endObject()
640             .endObject();
641         IndexMetadata metadata = <FONT color="#79764d"><A
642                 HREF="javascript:ZweiFrames('match306914-1.html#81',3,'match306914-top.html#81',1)"><IMG
643                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>getIndexMetadata(&quot;test3&quot;, builder);
644         DocIndexMetadata md = newMeta(metadata, &quot;test3&quot;);
645 <A NAME="40"></A>        assertThat(md.primaryKey().size(), is(1));
646         assertThat(md.primaryKey(), contains(new</B></FONT> ColumnIdent(&quot;id&quot;)));
647         builder = <FONT color="#347235"><A
648                 HREF="javascript:ZweiFrames('match306914-1.html#40',3,'match306914-top.html#40',1)"><IMG
649                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>XContentFactory.jsonBuilder()
650             .startObject()
651             .startObject(Constants.DEFAULT_MAPPING_TYPE)
652             .startObject(&quot;properties&quot;)
653             .startObject(&quot;content&quot;)
654             .field(&quot;type&quot;, &quot;string&quot;)
655             .endObject()
656             .endObject()
657             .endObject()
658             .endObject();
659 <A NAME="68"></A>        md = newMeta(getIndexMetadata(&quot;test4&quot;, builder), &quot;test4&quot;);
660         assertThat(md.primaryKey().size(), is</B></FONT>(1)); 
661         builder = <FONT color="#b041ff"><A
662                 HREF="javascript:ZweiFrames('match306914-1.html#68',3,'match306914-top.html#68',1)"><IMG
663                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>XContentFactory.jsonBuilder()
664             .startObject()
665             .startObject(Constants.DEFAULT_MAPPING_TYPE)
666             .endObject()
667             .endObject();
668         md = newMeta(getIndexMetadata(&quot;test5&quot;, builder), &quot;test5&quot;);
669         assertThat(md.primaryKey().size(), is(1));
670     }</B></FONT>
671 <A NAME="39"></A>
672     @Test
673     public void testExtractMultiplePrimaryKeys() throws Exception {
674         <FONT color="#152dc6"><A
675                 HREF="javascript:ZweiFrames('match306914-1.html#39',3,'match306914-top.html#39',1)"><IMG
676                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>XContentBuilder builder = XContentFactory.jsonBuilder()</B></FONT>
677             .startObject()
678             .startObject(Constants.DEFAULT_MAPPING_TYPE)
679             .startObject(&quot;_meta&quot;)
680             .array(&quot;primary_keys&quot;, &quot;id&quot;, &quot;title&quot;)
681             .endObject()
682             .startObject(&quot;properties&quot;)
683             .startObject(&quot;id&quot;)
684             .field(&quot;type&quot;, &quot;integer&quot;)
685             .endObject()
686             .startObject(&quot;title&quot;)
687             .field(&quot;type&quot;, &quot;string&quot;)
688             .field(&quot;index&quot;, &quot;false&quot;)
689             .endObject()
690             .endObject()
691             .endObject()
692 <A NAME="56"></A>            .endObject();
693         IndexMetadata metadata = getIndexMetadata(&quot;test_multi_pk&quot;, builder);
694         DocIndexMetadata md = newMeta(metadata, &quot;test_multi_pk&quot;);
695         assertThat(<FONT color="#52d017"><A
696                 HREF="javascript:ZweiFrames('match306914-1.html#56',3,'match306914-top.html#56',1)"><IMG
697                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>md.primaryKey().size(), is(2));
698         assertThat(md.primaryKey(), hasItems(ColumnIdent.fromPath(&quot;id&quot;), ColumnIdent.fromPath(&quot;title&quot;)));
699     }
700 <A NAME="28"></A>
701     @Test
702     public void testExtractCheckConstraints() throws Exception {
703         XContentBuilder builder = <FONT color="#717d7d"><A
704                     HREF="javascript:ZweiFrames('match306914-1.html#28',3,'match306914-top.html#28',1)"><IMG
705                     SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>XContentFactory.jsonBuilder</B></FONT>()</B></FONT>
706             .startObject()
707             .startObject(Constants.DEFAULT_MAPPING_TYPE)
708             .startObject(&quot;_meta&quot;)
709             .startObject(&quot;check_constraints&quot;)
710             .field(&quot;test3_check_1&quot;, &quot;id &gt;= 0&quot;)
711             .field(&quot;test3_check_2&quot;, &quot;title != 'Programming Clojure'&quot;)
712             .endObject()
713             .endObject()
714             .startObject(&quot;properties&quot;)
715             .startObject(&quot;id&quot;).field(&quot;type&quot;, &quot;integer&quot;).endObject()
716             .startObject(&quot;title&quot;).field(&quot;type&quot;, &quot;string&quot;).endObject()
717 <A NAME="38"></A>            .endObject()
718             .endObject()
719             .endObject();
720         <FONT color="#348781"><A
721                 HREF="javascript:ZweiFrames('match306914-1.html#38',3,'match306914-top.html#38',1)"><IMG
722                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>IndexMetadata metadata = getIndexMetadata(&quot;test3&quot;, builder);
723         DocIndexMetadata md = newMeta(metadata, &quot;test3&quot;);
724         assertThat(md.checkConstraints().size(), is(2));
725         assertThat(md.checkConstraints()
726                        .stream()
727                        .map(CheckConstraint::expressionStr)
728                        .collect(Collectors.toList()),
729                    containsInAnyOrder(
730                        equalTo(&quot;id &gt;= 0&quot;),
731                        equalTo</B></FONT>(&quot;title != 'Programming Clojure'&quot;)
732         ));
733     }
734 <A NAME="27"></A>
735     @Test
736     public void testExtractNoPrimaryKey() throws Exception {
737         <FONT color="#e77471"><A
738                 HREF="javascript:ZweiFrames('match306914-1.html#27',3,'match306914-top.html#27',1)"><IMG
739                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>XContentBuilder builder = XContentFactory.jsonBuilder()
740             .startObject()
741             .startObject(Constants.DEFAULT_MAPPING_TYPE)
742             .startObject(&quot;_meta&quot;)
743             .endObject()
744             .startObject(&quot;properties&quot;)
745             .startObject(&quot;id&quot;)
746             .field(&quot;type&quot;, &quot;integer&quot;)
747             .endObject()
748             .startObject(&quot;title&quot;)
749             .field(&quot;type&quot;, &quot;string&quot;)
750             .field(&quot;index&quot;, &quot;false&quot;)
751             .endObject()
752             .endObject()
753 <A NAME="10"></A>            .endObject()
754             .endObject();
755         IndexMetadata metadata = getIndexMetadata</B></FONT>(&quot;test_no_pk&quot;, builder);
756         DocIndexMetadata md = <FONT color="#ad5910"><A
757                 HREF="javascript:ZweiFrames('match306914-1.html#10',3,'match306914-top.html#10',1)"><IMG
758                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>newMeta(metadata, &quot;test_no_pk&quot;);
759         assertThat(md.primaryKey().size(), is(1));
760         assertThat(md.primaryKey(), hasItems(ColumnIdent.fromPath(&quot;_id&quot;)));
761         builder = XContentFactory.jsonBuilder</B></FONT>()
762             .startObject()
763             .startObject(Constants.DEFAULT_MAPPING_TYPE)
764             .startObject(&quot;_meta&quot;)
765             .array(&quot;primary_keys&quot;)             .endObject()
766             .startObject(&quot;properties&quot;)
767             .startObject(&quot;id&quot;)
768             .field(&quot;type&quot;, &quot;integer&quot;)
769             .endObject()
770             .startObject(&quot;title&quot;)
771             .field(&quot;type&quot;, &quot;string&quot;)
772             .field(&quot;index&quot;, &quot;false&quot;)
773             .endObject()
774 <A NAME="80"></A>            .endObject()
775             .endObject()
776             .endObject();
777         metadata = <FONT color="#f660ab"><A
778                 HREF="javascript:ZweiFrames('match306914-1.html#80',3,'match306914-top.html#80',1)"><IMG
779                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>getIndexMetadata(&quot;test_no_pk2&quot;, builder);
780         md = newMeta(metadata, &quot;test_no_pk2&quot;);
781         assertThat(md.primaryKey().size(), is(1));
782         assertThat(md.primaryKey(), hasItems(ColumnIdent.fromPath</B></FONT>(&quot;_id&quot;)));
783     }
784 <A NAME="26"></A>
785     @Test
786     public void testSchemaWithNotNullColumns() throws Exception {
787         XContentBuilder builder = <FONT color="#68818b"><A
788                 HREF="javascript:ZweiFrames('match306914-1.html#26',3,'match306914-top.html#26',1)"><IMG
789                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>XContentFactory.jsonBuilder</B></FONT>()
790             .startObject()
791             .startObject(Constants.DEFAULT_MAPPING_TYPE)
792             .startObject(&quot;_meta&quot;)
793             .startObject(&quot;constraints&quot;)
794             .array(&quot;not_null&quot;, &quot;id&quot;, &quot;title&quot;)
795             .endObject()
796             .endObject()
797             .startObject(&quot;properties&quot;)
798             .startObject(&quot;id&quot;)
799             .field(&quot;type&quot;, &quot;integer&quot;)
800             .endObject()
801             .startObject(&quot;title&quot;)
802             .field(&quot;type&quot;, &quot;string&quot;)
803             .field(&quot;index&quot;, &quot;false&quot;)
804             .endObject()
805             .endObject()
806             .endObject()
807             .endObject();
808 <A NAME="55"></A>        IndexMetadata metadata = getIndexMetadata(&quot;test_notnull_columns&quot;, builder);
809         DocIndexMetadata md = newMeta(metadata, &quot;test_notnull_columns&quot;);
810         <FONT color="#4863a0"><A
811                 HREF="javascript:ZweiFrames('match306914-1.html#55',3,'match306914-top.html#55',1)"><IMG
812                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertThat(
813             md.columns().stream().map(Reference::isNullable).collect(Collectors.toList()),
814             contains(false, false)
815         );
816     }
817 <A NAME="11"></A>
818     @Test
819     public void testSchemaWithNotNullNestedColumns() throws Exception {
820         XContentBuilder builder = <FONT color="#b041ff"><A
821                     HREF="javascript:ZweiFrames('match306914-1.html#11',3,'match306914-top.html#11',1)"><IMG
822                     SRC="forward.gif" ALT="other" BORDER="0"
823                     ALIGN="right"></A><B>XContentFactory.jsonBuilder()</B></FONT>
824         .startObject()
825             .startObject(Constants.DEFAULT_MAPPING_TYPE)
826                 .startObject(&quot;_meta&quot;)
827                     .startObject(&quot;constraints&quot;)
828                         .array(&quot;not_null&quot;, &quot;nested.level1&quot;, &quot;nested.level1.level2&quot;)
829                     .endObject()
830                 .endObject()
831                 .startObject(&quot;properties&quot;)
832                     .startObject(&quot;nested&quot;)
833                         .field(&quot;type&quot;, &quot;object&quot;)
834                             .startObject(&quot;properties&quot;)
835                                 .startObject(&quot;level1&quot;)
836                                     .field(&quot;type&quot;, &quot;object&quot;)
837                                     .startObject(&quot;properties&quot;)
838                                         .startObject(&quot;level2&quot;)
839                                             .field(&quot;type&quot;, &quot;string&quot;)
840                                         .endObject()
841                                     .endObject()
842                                 .endObject()
843                              .endObject()
844                     .endObject()
845                 .endObject()
846             .endObject()
847         .endObject();
848         IndexMetadata metadata = getIndexMetadata</B></FONT>(&quot;test_notnull_columns&quot;, builder);
849         DocIndexMetadata md = newMeta(metadata, &quot;test_notnull_columns&quot;);
850 <A NAME="31"></A>
851         ColumnIdent level1 = new ColumnIdent(&quot;nested&quot;, &quot;level1&quot;);
852         ColumnIdent level2 = new ColumnIdent(&quot;nested&quot;, Arrays.asList(&quot;level1&quot;, &quot;level2&quot;));
853         assertThat(<FONT color="#3ea99f"><A
854                 HREF="javascript:ZweiFrames('match306914-1.html#31',3,'match306914-top.html#31',1)"><IMG
855                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>md.notNullColumns(), containsInAnyOrder(level1, level2));
856         assertThat(md.references().get(level1).isNullable(), is(false));
857         assertThat(md.references().get(level2).isNullable(), is(false));
858     }
859 <A NAME="25"></A>
860     @Test
861     public void testSchemaWithNotNullGeneratedColumn() throws Exception {
862         XContentBuilder builder = <FONT color="#5eac10"><A
863                     HREF="javascript:ZweiFrames('match306914-1.html#25',3,'match306914-top.html#25',1)"><IMG
864                     SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>XContentFactory.jsonBuilder</B></FONT>()</B></FONT>
865             .startObject()
866                 .startObject(&quot;_meta&quot;)
867                     .startObject(&quot;generated_columns&quot;)
868                         .field(&quot;week&quot;, &quot;date_trunc('week', ts)&quot;)
869                     .endObject()
870                     .startObject(&quot;constraints&quot;)
871                         .array(&quot;not_null&quot;, &quot;week&quot;)
872                     .endObject()
873                 .endObject()
874                 .startObject(&quot;properties&quot;)
875                     .startObject(&quot;ts&quot;).field(&quot;type&quot;, &quot;date&quot;).endObject()
876                     .startObject(&quot;week&quot;).field(&quot;type&quot;, &quot;long&quot;).endObject()
877 <A NAME="79"></A>                .endObject()
878             .endObject();
879         <FONT color="#4cc417"><A
880                 HREF="javascript:ZweiFrames('match306914-1.html#79',3,'match306914-top.html#79',1)"><IMG
881                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>IndexMetadata metadata = getIndexMetadata(&quot;test1&quot;, builder);
882         DocIndexMetadata md = newMeta(metadata, &quot;test1&quot;);
883 <A NAME="21"></A>
884         assertThat(md.columns().size(), is(2));
885         Reference week = md.references</B></FONT>().get(new ColumnIdent(&quot;week&quot;));
886         <FONT color="#947010"><A
887                 HREF="javascript:ZweiFrames('match306914-1.html#21',3,'match306914-top.html#21',1)"><IMG
888                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertThat(week, Matchers.notNullValue());
889         assertThat(week.isNullable(), is(false));
890         assertThat(week, instanceOf(GeneratedReference.class));
891         assertThat(((GeneratedReference) week).formattedGeneratedExpression(), is(&quot;date_trunc('week', ts)&quot;));
892         assertThat(((GeneratedReference) week).generatedExpression(), isFunction(&quot;date_trunc&quot;, isLiteral(&quot;week&quot;), isReference(&quot;ts&quot;)));
893         assertThat(((GeneratedReference) week).referencedReferences(), contains(isReference(&quot;ts&quot;)));
894     }</B></FONT>
895 <A NAME="17"></A>
896     @Test
897     public void extractRoutingColumn() throws Exception {
898         <FONT color="#3090c7"><A
899                 HREF="javascript:ZweiFrames('match306914-1.html#17',3,'match306914-top.html#17',1)"><IMG
900                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>XContentBuilder builder = XContentFactory.jsonBuilder()
901             .startObject()
902             .startObject(Constants.DEFAULT_MAPPING_TYPE)
903             .startObject(&quot;_meta&quot;)
904             .field(&quot;primary_keys&quot;, &quot;id&quot;)
905             .endObject()
906             .startObject(&quot;properties&quot;)
907             .startObject(&quot;id&quot;)
908             .field(&quot;type&quot;, &quot;integer&quot;)
909             .endObject()
910             .startObject(&quot;datum&quot;)
911             .field(&quot;type&quot;, &quot;date&quot;)
912             .endObject()
913             .endObject()
914             .endObject()
915             .endObject();
916 <A NAME="54"></A>        DocIndexMetadata md = newMeta(getIndexMetadata(&quot;test8&quot;, builder), &quot;test8&quot;);
917         assertThat</B></FONT>(md.routingCol(), is(new ColumnIdent(&quot;id&quot;)));
918         <FONT color="#4e8975"><A
919                 HREF="javascript:ZweiFrames('match306914-1.html#54',3,'match306914-top.html#54',1)"><IMG
920                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>builder = XContentFactory.jsonBuilder()
921             .startObject()
922             .startObject(Constants.DEFAULT_MAPPING_TYPE)
923             .startObject(&quot;properties&quot;)
924             .startObject(&quot;content&quot;)
925             .field(&quot;type&quot;, &quot;string&quot;)
926             .endObject()
927             .endObject()
928             .endObject()
929             .endObject();
930 <A NAME="9"></A>        md = newMeta(getIndexMetadata</B></FONT>(&quot;test9&quot;, builder), &quot;test8&quot;);
931         assertThat(md.routingCol(), is(new ColumnIdent(&quot;_id&quot;)));
932         builder = <FONT color="#83a33a"><A
933                 HREF="javascript:ZweiFrames('match306914-1.html#9',3,'match306914-top.html#9',1)"><IMG SRC="forward.gif"
934                                                                                                        ALT="other"
935                                                                                                        BORDER="0"
936                                                                                                        ALIGN="right"></A><B>XContentFactory.jsonBuilder()
937             .startObject()
938             .startObject(Constants.DEFAULT_MAPPING_TYPE)
939             .startObject(&quot;_meta&quot;)
940             .array(&quot;primary_keys&quot;, &quot;id&quot;, &quot;num&quot;)
941             .field(&quot;routing&quot;, &quot;num&quot;)
942             .endObject()
943             .startObject(&quot;properties&quot;)
944             .startObject(&quot;id&quot;)
945             .field(&quot;type&quot;, &quot;integer&quot;)
946             .endObject()
947             .startObject(&quot;num&quot;)
948             .field(&quot;type&quot;, &quot;long&quot;)
949             .endObject()
950             .startObject(&quot;content&quot;)
951             .field(&quot;type&quot;, &quot;string&quot;)
952             .field(&quot;index&quot;, &quot;false&quot;)
953             .endObject()
954             .endObject()
955             .endObject()
956             .endObject();
957 <A NAME="46"></A>
958         md = newMeta(getIndexMetadata(&quot;test10&quot;, builder), &quot;test10&quot;);
959         assertThat(md.routingCol(), is</B></FONT>(new ColumnIdent(&quot;num&quot;)));
960     <FONT color="#668b8b"><A HREF="javascript:ZweiFrames('match306914-1.html#46',3,'match306914-top.html#46',1)"><IMG
961             SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>}
962     @Test
963     public void extractRoutingColumnFromEmptyIndex() throws Exception {
964         XContentBuilder builder = XContentFactory.jsonBuilder()
965             .startObject()
966             .startObject(Constants.DEFAULT_MAPPING_TYPE)
967             .endObject()
968 <A NAME="45"></A>            .endObject();
969         DocIndexMetadata md = newMeta(getIndexMetadata(&quot;test11&quot;, builder), &quot;test11&quot;);
970         assertThat(md.routingCol</B></FONT>(), is(new ColumnIdent(&quot;_id&quot;)));
971     <FONT color="#549748"><A HREF="javascript:ZweiFrames('match306914-1.html#45',3,'match306914-top.html#45',1)"><IMG
972             SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>}
973     @Test
974     public void testAutogeneratedPrimaryKey() throws Exception {
975         XContentBuilder builder = XContentFactory.jsonBuilder()
976             .startObject()
977             .startObject(Constants.DEFAULT_MAPPING_TYPE)
978 <A NAME="90"></A>            .endObject()
979             .endObject();
980         DocIndexMetadata md = newMeta(getIndexMetadata(&quot;test11&quot;, builder), &quot;test11&quot;);
981 <A NAME="89"></A>        assertThat(<FONT color="#736aff"><A
982                 HREF="javascript:ZweiFrames('match306914-1.html#90',3,'match306914-top.html#90',1)"><IMG
983                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>md.primaryKey().size</B></FONT>(), is(1));
984         assertThat(md.primaryKey().get(0), is(new ColumnIdent(&quot;_id&quot;)));
985         assertThat(md.hasAutoGeneratedPrimaryKey(), is</B></FONT>(true));
986     <FONT color="#5b8daf"><A HREF="javascript:ZweiFrames('match306914-1.html#89',3,'match306914-top.html#89',1)"><IMG
987             SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>}
988 <A NAME="24"></A>
989     @Test
990     public void testNoAutogeneratedPrimaryKey() throws Exception {
991         XContentBuilder builder = <FONT color="#79764d"><A
992                 HREF="javascript:ZweiFrames('match306914-1.html#24',3,'match306914-top.html#24',1)"><IMG
993                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>XContentFactory.jsonBuilder()</B></FONT>
994             .startObject()
995                 .startObject(Constants.DEFAULT_MAPPING_TYPE)
996                     .startObject(&quot;_meta&quot;)
997                         .field(&quot;primary_keys&quot;, &quot;id&quot;)
998                     .endObject()
999                     .startObject(&quot;properties&quot;)
1000                         .startObject(&quot;id&quot;)
1001                             .field(&quot;type&quot;, &quot;integer&quot;)
1002                         .endObject()
1003                     .endObject()
1004                 .endObject()
1005             .endObject();
1006         DocIndexMetadata md = newMeta(getIndexMetadata(&quot;test11&quot;, builder), &quot;test11&quot;);
1007         assertThat(md.primaryKey().size(), is(1));
1008         assertThat(md.primaryKey().get(0), is</B></FONT>(new ColumnIdent(&quot;id&quot;)));
1009         assertThat(md.hasAutoGeneratedPrimaryKey(), is(false));
1010     }
1011 <A NAME="44"></A>
1012     @Test
1013     public void testAnalyzedColumnWithAnalyzer() throws Exception {
1014         XContentBuilder builder = <FONT color="#a057a5"><A
1015                 HREF="javascript:ZweiFrames('match306914-1.html#44',3,'match306914-top.html#44',1)"><IMG
1016                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>XContentFactory.jsonBuilder</B></FONT>()
1017             .startObject()
1018                 .startObject(Constants.DEFAULT_MAPPING_TYPE)
1019                     .startObject(&quot;properties&quot;)
1020                         .startObject(&quot;content_de&quot;)
1021                             .field(&quot;type&quot;, &quot;text&quot;)
1022                             .field(&quot;index&quot;, &quot;true&quot;)
1023                             .field(&quot;analyzer&quot;, &quot;german&quot;)
1024                         .endObject()
1025                         .startObject(&quot;content_en&quot;)
1026                             .field(&quot;type&quot;, &quot;text&quot;)
1027                             .field(&quot;analyzer&quot;, &quot;english&quot;)
1028                         .endObject()
1029                     .endObject()
1030 <A NAME="15"></A>                .endObject()
1031             .endObject();
1032         DocIndexMetadata md = newMeta(getIndexMetadata(&quot;test_analyzer&quot;, builder), &quot;test_analyzer&quot;);
1033         List&lt;Reference&gt; columns = new ArrayList&lt;&gt;(<FONT color="#f52887"><A
1034                 HREF="javascript:ZweiFrames('match306914-1.html#15',3,'match306914-top.html#15',1)"><IMG
1035                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>md.columns());
1036         assertThat(columns.size(), is(2));
1037         assertThat(columns.get(0).indexType(), is(Reference.IndexType.FULLTEXT));
1038         assertThat(columns.get(0).column().fqn(), is(&quot;content_de&quot;));
1039         assertThat(columns.get(1).indexType(), is(Reference.IndexType.FULLTEXT));
1040         assertThat(columns.get(1).column().fqn(), is(&quot;content_en&quot;));
1041     }</B></FONT>
1042     @Test
1043 <A NAME="49"></A>    public void testGeoPointType() throws Exception {
1044         DocIndexMetadata md = getDocIndexMetadataFromStatement(&quot;create table foo (p geo_point)&quot;);
1045         assertThat(md.columns().size(), is(1));
1046         Reference reference = <FONT color="#8e35ef"><A
1047                 HREF="javascript:ZweiFrames('match306914-1.html#49',3,'match306914-top.html#49',1)"><IMG
1048                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>md.columns().iterator().next();
1049         assertThat(reference.valueType(), equalTo(DataTypes.GEO_POINT));
1050     }
1051     @Test
1052     public void testCreateTableMappingGenerationAndParsingCompat() throws Exception {
1053         DocIndexMetadata md = getDocIndexMetadataFromStatement(&quot;create table foo (&quot; +
1054                                                                &quot;id int primary key,&quot; +
1055                                                                &quot;tags array(string),&quot; +
1056                                                                &quot;o object as (&quot; +
1057                                                                &quot;   age int,&quot; +
1058                                                                &quot;   name string&quot; +
1059                                                                &quot;),&quot; +
1060 <A NAME="100"></A>                                                               &quot;date timestamp with time zone primary key&quot; +
1061                                                                &quot;) partitioned by (date)&quot;);
1062 <A NAME="78"></A>        assertThat(<FONT color="#c22817"><A
1063                     HREF="javascript:ZweiFrames('match306914-1.html#100',3,'match306914-top.html#100',1)"><IMG
1064                     SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>md.columns().size</B></FONT>(), is(4));
1065         assertThat(md.primaryKey(), Matchers.contains(new ColumnIdent(&quot;id&quot;), new ColumnIdent(&quot;date&quot;)));
1066         assertThat(md.references().get(new ColumnIdent(&quot;tags&quot;)).valueType</B></FONT>(), is(new ArrayType(DataTypes.STRING)));
1067     <FONT color="#947010"><A HREF="javascript:ZweiFrames('match306914-1.html#78',3,'match306914-top.html#78',1)"><IMG
1068             SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>}
1069     @Test
1070     public void testCreateTableMappingGenerationAndParsingArrayInsideObject() throws Exception {
1071         DocIndexMetadata md = getDocIndexMetadataFromStatement(
1072             &quot;create table t1 (&quot; +
1073             &quot;id int primary key,&quot; +
1074             &quot;details object as (names array(string))&quot; +
1075 <A NAME="67"></A>            &quot;) with (number_of_replicas=0)&quot;);
1076         DataType type = md.references</B></FONT>().get(new ColumnIdent(&quot;details&quot;, &quot;names&quot;)).valueType();
1077         assertThat(type, Matchers.equalTo(new ArrayType(DataTypes.STRING)));
1078     <FONT color="#ad5910"><A HREF="javascript:ZweiFrames('match306914-1.html#67',3,'match306914-top.html#67',1)"><IMG
1079             SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>}
1080     @Test
1081     public void testCreateTableMappingGenerationAndParsingCompatNoMeta() throws Exception {
1082         DocIndexMetadata md = getDocIndexMetadataFromStatement(&quot;create table foo (id int, name string)&quot;);
1083         assertThat(md.columns().size(), is(2));
1084         assertThat(md.hasAutoGeneratedPrimaryKey</B></FONT>(), is(true));
1085     }
1086     private DocIndexMetadata getDocIndexMetadataFromStatement(String stmt) throws IOException {
1087         Statement statement = SqlParser.createStatement(stmt);
1088         DocTableInfoFactory docTableInfoFactory = new InternalDocTableInfoFactory(
1089             nodeCtx,
1090             new IndexNameExpressionResolver()
1091         );
1092         ViewInfoFactory viewInfoFactory = (ident, state) -&gt; null;
1093         DocSchemaInfo docSchemaInfo = new DocSchemaInfo(Schemas.DOC_SCHEMA_NAME, clusterService, nodeCtx, udfService, viewInfoFactory, docTableInfoFactory );
1094         Path homeDir = createTempDir();
1095         Schemas schemas = new Schemas(
1096                 Map.of(&quot;doc&quot;, docSchemaInfo),
1097                 clusterService,
1098                 new DocSchemaInfoFactory(docTableInfoFactory, viewInfoFactory, nodeCtx, udfService));
1099 <A NAME="48"></A>        FulltextAnalyzerResolver fulltextAnalyzerResolver = new FulltextAnalyzerResolver(
1100             clusterService,
1101             new AnalysisRegistry(
1102                 <FONT color="#c57726"><A
1103                         HREF="javascript:ZweiFrames('match306914-1.html#48',3,'match306914-top.html#48',1)"><IMG
1104                         SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>new Environment(Settings.builder()
1105                     .put(Environment.PATH_HOME_SETTING.getKey(), homeDir.toString())
1106                     .build(),
1107                     homeDir.resolve(&quot;config&quot;)
1108                 ),
1109                 emptyMap(),
1110                 emptyMap(),
1111                 emptyMap(),
1112                 emptyMap(),
1113                 emptyMap(),
1114                 emptyMap(),
1115                 emptyMap(),
1116                 emptyMap</B></FONT>(),
1117                 emptyMap()
1118             ));
1119         CreateTableStatementAnalyzer analyzer = new CreateTableStatementAnalyzer(nodeCtx);
1120         Analysis analysis = new Analysis(new CoordinatorTxnCtx(SessionContext.systemSessionContext()), ParamTypeHints.EMPTY);
1121         CoordinatorTxnCtx txnCtx = new CoordinatorTxnCtx(SessionContext.systemSessionContext());
1122         AnalyzedCreateTable analyzedCreateTable = analyzer.analyze(
1123             (CreateTable&lt;Expression&gt;) statement,
1124             analysis.paramTypeHints(),
1125             analysis.transactionContext());
1126         BoundCreateTable analyzedStatement = CreateTablePlan.bind(
1127             analyzedCreateTable,
1128             txnCtx,
1129             nodeCtx,
1130             Row.EMPTY,
1131             SubQueryResults.EMPTY,
1132             new NumberOfShards(clusterService),
1133             schemas,
1134 <A NAME="53"></A>            fulltextAnalyzerResolver
1135         );
1136         Settings.Builder settingsBuilder = <FONT color="#ad5a3d"><A
1137                 HREF="javascript:ZweiFrames('match306914-1.html#53',3,'match306914-top.html#53',1)"><IMG
1138                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>Settings.builder()
1139             .put(&quot;index.number_of_shards&quot;, 1)
1140             .put(&quot;index.number_of_replicas&quot;, 0)
1141             .put(&quot;index.version.created&quot;, org.elasticsearch.Version.CURRENT)
1142             .put(analyzedStatement.tableParameter().settings());
1143         IndexMetadata indexMetadata = IndexMetadata.builder(analyzedStatement.tableIdent</B></FONT>().name())
1144             .settings(settingsBuilder)
1145 <A NAME="88"></A>            .putMapping(new MappingMetadata(Constants.DEFAULT_MAPPING_TYPE, analyzedStatement.mapping()))
1146             .build();
1147         return <FONT color="#3ea99f"><A
1148                 HREF="javascript:ZweiFrames('match306914-1.html#88',3,'match306914-top.html#88',1)"><IMG
1149                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>newMeta(indexMetadata, analyzedStatement.tableIdent().name());
1150     }
1151     @Test
1152     public void testCompoundIndexColumn() throws Exception {
1153         DocIndexMetadata md = getDocIndexMetadataFromStatement</B></FONT>(&quot;create table t (&quot; +
1154                                                                &quot;  id integer primary key,&quot; +
1155                                                                &quot;  name string,&quot; +
1156 <A NAME="37"></A>                                                               &quot;  fun string index off,&quot; +
1157                                                                &quot;  INDEX fun_name_ft using fulltext(name, fun)&quot; +
1158                                                                &quot;)&quot;);
1159         assertThat(<FONT color="#810541"><A
1160                 HREF="javascript:ZweiFrames('match306914-1.html#37',3,'match306914-top.html#37',1)"><IMG
1161                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>md.indices().size(), is(1));
1162 <A NAME="66"></A>        assertThat(md.columns().size(), is(3));
1163         assertThat(md.indices().get(ColumnIdent.fromPath(&quot;fun_name_ft&quot;)), instanceOf(IndexReference.class));
1164         IndexReference indexInfo = md.indices().get(ColumnIdent.fromPath(&quot;fun_name_ft&quot;));
1165         assertThat</B></FONT>(indexInfo.indexType(), <FONT color="#83a33a"><A
1166                 HREF="javascript:ZweiFrames('match306914-1.html#66',3,'match306914-top.html#66',1)"><IMG
1167                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>is(Reference.IndexType.FULLTEXT));
1168         assertThat(indexInfo.column().fqn(), is(&quot;fun_name_ft&quot;));
1169     }
1170     @Test
1171     public void testCompoundIndexColumnNested() throws Exception {
1172         DocIndexMetadata md = getDocIndexMetadataFromStatement(&quot;create table t (&quot; +
1173                                                                &quot;  id integer primary key,&quot; +
1174                                                                &quot;  name string,&quot; +
1175                                                                &quot;  o object as (&quot; +
1176                                                                &quot;    fun string&quot; +
1177 <A NAME="36"></A>                                                               &quot;  ),&quot; +
1178                                                                &quot;  INDEX fun_name_ft using fulltext(name, o['fun'])&quot; +
1179                                                                &quot;)&quot;);
1180         assertThat</B></FONT>(<FONT color="#ff00ff"><A
1181                 HREF="javascript:ZweiFrames('match306914-1.html#36',3,'match306914-top.html#36',1)"><IMG
1182                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>md.indices().size(), is(1));
1183         assertThat(md.columns().size(), is(3));
1184         assertThat(md.indices().get(ColumnIdent.fromPath(&quot;fun_name_ft&quot;)), instanceOf(IndexReference.class));
1185         IndexReference indexInfo = md.indices().get(ColumnIdent.fromPath(&quot;fun_name_ft&quot;));
1186         assertThat</B></FONT>(indexInfo.indexType(), is(Reference.IndexType.FULLTEXT));
1187         assertThat(indexInfo.column().fqn(), is(&quot;fun_name_ft&quot;));
1188 <A NAME="47"></A>    }
1189     @Test
1190     public void testExtractColumnPolicy() throws Exception <FONT color="#d16587"><A
1191                 HREF="javascript:ZweiFrames('match306914-1.html#47',3,'match306914-top.html#47',1)"><IMG
1192                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>{
1193         XContentBuilder ignoredBuilder = XContentFactory.jsonBuilder()</B></FONT>
1194             .startObject()
1195             .startObject(Constants.DEFAULT_MAPPING_TYPE)
1196             .field(&quot;dynamic&quot;, false)
1197             .startObject(&quot;properties&quot;)
1198             .startObject(&quot;id&quot;)
1199             .field(&quot;type&quot;, &quot;integer&quot;)
1200             .endObject()
1201             .startObject(&quot;content&quot;)
1202             .field(&quot;type&quot;, &quot;string&quot;)
1203             .field(&quot;index&quot;, &quot;false&quot;)
1204             .endObject()
1205 <A NAME="20"></A>            .endObject()
1206             .endObject()
1207             .endObject();
1208         DocIndexMetadata mdIgnored = <FONT color="#4e9258"><A
1209                 HREF="javascript:ZweiFrames('match306914-1.html#20',3,'match306914-top.html#20',1)"><IMG
1210                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>newMeta(getIndexMetadata(&quot;test_ignored&quot;, ignoredBuilder), &quot;test_ignored&quot;);
1211         assertThat(mdIgnored.columnPolicy(), is(ColumnPolicy.IGNORED));
1212         XContentBuilder strictBuilder = XContentFactory.jsonBuilder()</B></FONT>
1213             .startObject()
1214             .startObject(Constants.DEFAULT_MAPPING_TYPE)
1215             .field(&quot;dynamic&quot;, &quot;strict&quot;)
1216             .startObject(&quot;properties&quot;)
1217             .startObject(&quot;id&quot;)
1218             .field(&quot;type&quot;, &quot;integer&quot;)
1219             .endObject()
1220             .startObject(&quot;content&quot;)
1221             .field(&quot;type&quot;, &quot;string&quot;)
1222             .field(&quot;index&quot;, &quot;false&quot;)
1223             .endObject()
1224             .endObject()
1225 <A NAME="30"></A>            .endObject()
1226             .endObject();
1227         DocIndexMetadata mdStrict = newMeta(getIndexMetadata(&quot;test_strict&quot;, strictBuilder), &quot;test_strict&quot;);
1228         assertThat(mdStrict.columnPolicy(), <FONT color="#ae694a"><A
1229                 HREF="javascript:ZweiFrames('match306914-1.html#30',3,'match306914-top.html#30',1)"><IMG
1230                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>is(ColumnPolicy.STRICT));
1231         XContentBuilder dynamicBuilder = XContentFactory.jsonBuilder()
1232             .startObject()
1233             .startObject(Constants.DEFAULT_MAPPING_TYPE)
1234             .field(&quot;dynamic&quot;, true)
1235             .startObject(&quot;properties&quot;)
1236             .startObject(&quot;id&quot;)
1237             .field(&quot;type&quot;, &quot;integer&quot;)
1238             .endObject()
1239             .startObject(&quot;content&quot;)
1240             .field(&quot;type&quot;, &quot;string&quot;)
1241             .field(&quot;index&quot;, &quot;false&quot;)
1242             .endObject()
1243             .endObject()
1244 <A NAME="19"></A>            .endObject()
1245             .endObject();
1246         DocIndexMetadata mdDynamic = newMeta(getIndexMetadata(&quot;test_dynamic&quot;, dynamicBuilder), &quot;test_dynamic&quot;)</B></FONT>;
1247         <FONT color="#f62817"><A
1248                 HREF="javascript:ZweiFrames('match306914-1.html#19',3,'match306914-top.html#19',1)"><IMG
1249                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertThat(mdDynamic.columnPolicy(), is(ColumnPolicy.DYNAMIC));
1250         XContentBuilder missingBuilder = XContentFactory.jsonBuilder()
1251             .startObject()
1252             .startObject(Constants.DEFAULT_MAPPING_TYPE)
1253             .startObject(&quot;properties&quot;)
1254             .startObject(&quot;id&quot;)
1255             .field(&quot;type&quot;, &quot;integer&quot;)
1256             .endObject()
1257             .startObject(&quot;content&quot;)
1258             .field(&quot;type&quot;, &quot;string&quot;)
1259             .field(&quot;index&quot;, &quot;false&quot;)
1260             .endObject()
1261             .endObject()
1262 <A NAME="16"></A>            .endObject()
1263             .endObject();
1264         DocIndexMetadata mdMissing = newMeta</B></FONT>(getIndexMetadata(&quot;test_missing&quot;, missingBuilder), &quot;test_missing&quot;);
1265         assertThat(mdMissing.columnPolicy(), <FONT color="#2981b2"><A
1266                 HREF="javascript:ZweiFrames('match306914-1.html#16',3,'match306914-top.html#16',1)"><IMG
1267                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>is(ColumnPolicy.DYNAMIC));
1268         XContentBuilder wrongBuilder = XContentFactory.jsonBuilder()
1269             .startObject()
1270             .startObject(Constants.DEFAULT_MAPPING_TYPE)
1271             .field(&quot;dynamic&quot;, &quot;wrong&quot;)
1272             .startObject(&quot;properties&quot;)
1273             .startObject(&quot;id&quot;)
1274             .field(&quot;type&quot;, &quot;integer&quot;)
1275             .endObject()
1276             .startObject(&quot;content&quot;)
1277             .field(&quot;type&quot;, &quot;string&quot;)
1278             .field(&quot;index&quot;, &quot;false&quot;)
1279             .endObject()
1280             .endObject()
1281             .endObject()
1282             .endObject();
1283         expectedException.expectMessage(&quot;Invalid column policy: wrong&quot;);
1284         newMeta(getIndexMetadata(&quot;test_wrong&quot;, wrongBuilder), &quot;test_wrong&quot;);
1285     }</B></FONT>
1286     @Test
1287     public void testCreateArrayMapping() throws Exception {
1288         DocIndexMetadata md = getDocIndexMetadataFromStatement(&quot;create table t (&quot; +
1289                                                                &quot;  id integer primary key,&quot; +
1290 <A NAME="65"></A>                                                               &quot;  tags array(string),&quot; +
1291                                                                &quot;  scores array(short)&quot; +
1292                                                                &quot;)&quot;);
1293         <FONT color="#c58917"><A
1294                 HREF="javascript:ZweiFrames('match306914-1.html#65',3,'match306914-top.html#65',1)"><IMG
1295                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertThat(md.references().get(ColumnIdent.fromPath(&quot;tags&quot;)).valueType(),
1296 <A NAME="64"></A>            is(new ArrayType(DataTypes.STRING)));
1297         assertThat(md.references().get(ColumnIdent.fromPath(&quot;scores&quot;)).valueType(),
1298             is</B></FONT>(new ArrayType(DataTypes.SHORT)));
1299     <FONT color="#38a4a5"><A HREF="javascript:ZweiFrames('match306914-1.html#64',3,'match306914-top.html#64',1)"><IMG
1300             SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>}
1301     @Test
1302     public void testCreateObjectArrayMapping() throws Exception {
1303         DocIndexMetadata md = getDocIndexMetadataFromStatement(&quot;create table t (&quot; +
1304                                                                &quot;  id integer primary key,&quot; +
1305                                                                &quot;  tags array(object(strict) as (&quot; +
1306                                                                &quot;    size double index off,&quot; +
1307                                                                &quot;    numbers array(integer),&quot; +
1308                                                                &quot;    quote string index using fulltext&quot; +
1309                                                                &quot;  ))&quot; +
1310                                                                &quot;)&quot;);
1311 <A NAME="8"></A>        assertThat(
1312             md.references().get(ColumnIdent.fromPath(&quot;tags&quot;)).valueType(),
1313             is</B></FONT>(new ArrayType&lt;&gt;(
1314                 <FONT color="#c58917"><A
1315                         HREF="javascript:ZweiFrames('match306914-1.html#8',3,'match306914-top.html#8',1)"><IMG
1316                         SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>ObjectType.builder()
1317                     .setInnerType(&quot;size&quot;, DataTypes.DOUBLE)
1318                     .setInnerType(&quot;numbers&quot;, DataTypes.INTEGER_ARRAY)
1319                     .setInnerType(&quot;quote&quot;, DataTypes.STRING)
1320                     .build()))
1321         );
1322         assertThat(md.references().get(ColumnIdent.fromPath(&quot;tags&quot;)).columnPolicy(),
1323             is(ColumnPolicy.STRICT));
1324         assertThat(md.references().get(ColumnIdent.fromPath(&quot;tags.size&quot;)).valueType(),
1325             is(DataTypes.DOUBLE));
1326         assertThat(md.references().get(ColumnIdent.fromPath(&quot;tags.size&quot;)).indexType(),
1327 <A NAME="35"></A>            is(Reference.IndexType.NONE));
1328         assertThat(md.references().get(ColumnIdent.fromPath(&quot;tags.numbers&quot;)).valueType(),
1329             is</B></FONT>(new ArrayType&lt;&gt;(DataTypes.INTEGER)));
1330         <FONT color="#41a317"><A
1331                 HREF="javascript:ZweiFrames('match306914-1.html#35',3,'match306914-top.html#35',1)"><IMG
1332                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertThat(md.references().get(ColumnIdent.fromPath(&quot;tags.quote&quot;)).valueType(),
1333             is(DataTypes.STRING));
1334         assertThat(md.references().get(ColumnIdent.fromPath(&quot;tags.quote&quot;)).indexType(),
1335             is(Reference.IndexType.FULLTEXT));
1336     }
1337 <A NAME="4"></A>
1338     @Test
1339     public void testNoBackwardCompatibleArrayMapping() throws Exception {</B></FONT>
1340         <FONT color="#6cc417"><A HREF="javascript:ZweiFrames('match306914-1.html#4',3,'match306914-top.html#4',1)"><IMG
1341                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>XContentBuilder builder = XContentFactory.jsonBuilder</B></FONT>()
1342             .startObject()
1343             .startObject(&quot;_meta&quot;)
1344             .field(&quot;primary_keys&quot;, &quot;id&quot;)
1345             .startObject(&quot;columns&quot;)
1346             .startObject(&quot;array_col&quot;)
1347             .field(&quot;collection_type&quot;, &quot;array&quot;)
1348             .endObject()
1349             .startObject(&quot;nested&quot;)
1350             .startObject(&quot;properties&quot;)
1351             .startObject(&quot;inner_nested&quot;)
1352             .field(&quot;collection_type&quot;, &quot;array&quot;)
1353             .endObject()
1354             .endObject()
1355             .endObject()
1356             .endObject()
1357             .endObject()
1358             .startObject(&quot;properties&quot;)
1359             .startObject(&quot;id&quot;)
1360             .field(&quot;type&quot;, &quot;integer&quot;)
1361             .endObject()
1362             .startObject(&quot;title&quot;)
1363             .field(&quot;type&quot;, &quot;string&quot;)
1364             .field(&quot;index&quot;, &quot;false&quot;)
1365             .endObject()
1366             .startObject(&quot;array_col&quot;)
1367             .field(&quot;type&quot;, &quot;ip&quot;)
1368             .endObject()
1369             .startObject(&quot;nested&quot;)
1370             .field(&quot;type&quot;, &quot;nested&quot;)
1371             .startObject(&quot;properties&quot;)
1372             .startObject(&quot;inner_nested&quot;)
1373             .field(&quot;type&quot;, &quot;date&quot;)
1374             .endObject()
1375             .endObject()
1376             .endObject()
1377             .endObject()
1378             .endObject();
1379         IndexMetadata indexMetadata = getIndexMetadata(&quot;test1&quot;, builder);
1380 <A NAME="34"></A>        DocIndexMetadata docIndexMetadata = newMeta(indexMetadata, &quot;test1&quot;);
1381         <FONT color="#827d6b"><A
1382                 HREF="javascript:ZweiFrames('match306914-1.html#34',3,'match306914-top.html#34',1)"><IMG
1383                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertThat(docIndexMetadata.references().get(ColumnIdent.fromPath(&quot;array_col&quot;)).valueType(),
1384             is(DataTypes.IP));
1385         assertThat(docIndexMetadata.references().get(ColumnIdent.fromPath(&quot;nested.inner_nested&quot;)).valueType(),
1386             is(DataTypes.TIMESTAMPZ));
1387     }
1388 <A NAME="6"></A>
1389     @Test
1390     public void testNewArrayMapping() throws Exception {</B></FONT>
1391         XContentBuilder builder = <FONT color="#8c8774"><A
1392                 HREF="javascript:ZweiFrames('match306914-1.html#6',3,'match306914-top.html#6',1)"><IMG SRC="forward.gif"
1393                                                                                                        ALT="other"
1394                                                                                                        BORDER="0"
1395                                                                                                        ALIGN="right"></A><B>XContentFactory.jsonBuilder</B></FONT>()
1396             .startObject()
1397             .startObject(&quot;_meta&quot;)
1398             .field(&quot;primary_keys&quot;, &quot;id&quot;)
1399             .endObject()
1400             .startObject(&quot;properties&quot;)
1401             .startObject(&quot;id&quot;)
1402             .field(&quot;type&quot;, &quot;integer&quot;)
1403             .endObject()
1404             .startObject(&quot;title&quot;)
1405             .field(&quot;type&quot;, &quot;string&quot;)
1406             .field(&quot;index&quot;, &quot;false&quot;)
1407             .endObject()
1408             .startObject(&quot;array_col&quot;)
1409             .field(&quot;type&quot;, &quot;array&quot;)
1410             .startObject(&quot;inner&quot;)
1411             .field(&quot;type&quot;, &quot;ip&quot;)
1412             .endObject()
1413             .endObject()
1414             .startObject(&quot;nested&quot;)
1415             .field(&quot;type&quot;, &quot;object&quot;)
1416             .startObject(&quot;properties&quot;)
1417             .startObject(&quot;inner_nested&quot;)
1418             .field(&quot;type&quot;, &quot;array&quot;)
1419             .startObject(&quot;inner&quot;)
1420             .field(&quot;type&quot;, &quot;date&quot;)
1421             .endObject()
1422             .endObject()
1423             .endObject()
1424             .endObject()
1425             .endObject()
1426 <A NAME="63"></A>            .endObject();
1427         IndexMetadata indexMetadata = getIndexMetadata(&quot;test1&quot;, builder);
1428         DocIndexMetadata docIndexMetadata = newMeta(indexMetadata, &quot;test1&quot;);
1429         <FONT color="#8c8774"><A
1430                 HREF="javascript:ZweiFrames('match306914-1.html#63',3,'match306914-top.html#63',1)"><IMG
1431                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertThat(docIndexMetadata.references().get(ColumnIdent.fromPath(&quot;array_col&quot;)).valueType(),
1432 <A NAME="52"></A>            is(new ArrayType(DataTypes.IP)));
1433         assertThat(docIndexMetadata.references().get(ColumnIdent.fromPath(&quot;nested.inner_nested&quot;)).valueType(),
1434             is</B></FONT>(new ArrayType(DataTypes.TIMESTAMPZ)));
1435     <FONT color="#2b60de"><A HREF="javascript:ZweiFrames('match306914-1.html#52',3,'match306914-top.html#52',1)"><IMG
1436             SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>}
1437     @Test
1438     public void testStringArrayWithFulltextIndex() throws Exception {
1439         DocIndexMetadata metadata = getDocIndexMetadataFromStatement(
1440             &quot;create table t (tags array(string) index using fulltext)&quot;);
1441         Reference reference = metadata.columns().iterator().next();
1442         assertThat(reference.valueType(), equalTo</B></FONT>(new ArrayType(DataTypes.STRING)));
1443     }
1444     @Test
1445     public void testCreateTableWithNestedPrimaryKey() throws Exception {
1446         DocIndexMetadata metadata = getDocIndexMetadataFromStatement(&quot;create table t (o object as (x int primary key))&quot;);
1447         assertThat(metadata.primaryKey(), contains(new ColumnIdent(&quot;o&quot;, &quot;x&quot;)));
1448         metadata = getDocIndexMetadataFromStatement(&quot;create table t (x object as (y object as (z int primary key)))&quot;);
1449         assertThat(metadata.primaryKey(), contains(new ColumnIdent(&quot;x&quot;, Arrays.asList(&quot;y&quot;, &quot;z&quot;))));
1450     }
1451 <A NAME="43"></A>
1452     @Test
1453     public void testSchemaWithGeneratedColumn() throws Exception {
1454         XContentBuilder builder = <FONT color="#c22817"><A
1455                 HREF="javascript:ZweiFrames('match306914-1.html#43',3,'match306914-top.html#43',1)"><IMG
1456                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>XContentFactory.jsonBuilder</B></FONT>()
1457             .startObject()
1458                 .startObject(&quot;_meta&quot;)
1459                     .startObject(&quot;generated_columns&quot;)
1460                         .field(&quot;week&quot;, &quot;date_trunc('week', ts)&quot;)
1461                     .endObject()
1462                 .endObject()
1463                 .startObject(&quot;properties&quot;)
1464                     .startObject(&quot;ts&quot;).field(&quot;type&quot;, &quot;date&quot;).endObject()
1465                     .startObject(&quot;week&quot;).field(&quot;type&quot;, &quot;long&quot;).endObject()
1466 <A NAME="87"></A>                .endObject()
1467             .endObject();
1468         IndexMetadata metadata = <FONT color="#ae694a"><A
1469                 HREF="javascript:ZweiFrames('match306914-1.html#87',3,'match306914-top.html#87',1)"><IMG
1470                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>getIndexMetadata(&quot;test1&quot;, builder);
1471         DocIndexMetadata md = newMeta(metadata, &quot;test1&quot;);
1472 <A NAME="33"></A>
1473         assertThat(md.columns().size(), is(2));
1474         Reference week = md.references</B></FONT>().get(new ColumnIdent(&quot;week&quot;));
1475         <FONT color="#736aff"><A
1476                 HREF="javascript:ZweiFrames('match306914-1.html#33',3,'match306914-top.html#33',1)"><IMG
1477                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertThat(week, Matchers.notNullValue());
1478         assertThat(week, instanceOf(GeneratedReference.class));
1479         assertThat(((GeneratedReference) week).formattedGeneratedExpression(), is(&quot;date_trunc('week', ts)&quot;));
1480         assertThat(((GeneratedReference) week).generatedExpression(), isFunction(&quot;date_trunc&quot;, isLiteral(&quot;week&quot;), isReference(&quot;ts&quot;)));
1481         assertThat(((GeneratedReference) week).referencedReferences(), contains(isReference(&quot;ts&quot;)));
1482 <A NAME="62"></A>    }</B></FONT>
1483     @Test
1484     public void testCopyToWithoutMetaIndices() throws Exception <FONT color="#151b8d"><A
1485                 HREF="javascript:ZweiFrames('match306914-1.html#62',3,'match306914-top.html#62',1)"><IMG
1486                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>{
1487         XContentBuilder builder = XContentFactory.jsonBuilder()</B></FONT>
1488             .startObject()
1489             .startObject(&quot;properties&quot;)
1490             .startObject(&quot;description&quot;)
1491             .field(&quot;type&quot;, &quot;string&quot;)
1492             .array(&quot;copy_to&quot;, &quot;description_ft&quot;)
1493             .endObject()
1494             .startObject(&quot;description_ft&quot;)
1495             .field(&quot;type&quot;, &quot;string&quot;)
1496             .field(&quot;analyzer&quot;, &quot;english&quot;)
1497             .endObject()
1498 <A NAME="61"></A>            .endObject()
1499             .endObject();
1500         IndexMetadata metadata = <FONT color="#6cc417"><A
1501                 HREF="javascript:ZweiFrames('match306914-1.html#61',3,'match306914-top.html#61',1)"><IMG
1502                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>getIndexMetadata(&quot;test1&quot;, builder);
1503         DocIndexMetadata md = newMeta(metadata, &quot;test1&quot;);
1504 <A NAME="60"></A>
1505         assertThat(md.indices().size(), is(1));
1506         assertThat(md.indices().keySet().iterator().next(), is</B></FONT>(new ColumnIdent(&quot;description_ft&quot;)));
1507     <FONT color="#53858b"><A HREF="javascript:ZweiFrames('match306914-1.html#60',3,'match306914-top.html#60',1)"><IMG
1508             SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>}
1509     @Test
1510     public void testArrayAsGeneratedColumn() throws Exception {
1511 <A NAME="59"></A>        DocIndexMetadata md = getDocIndexMetadataFromStatement(&quot;create table t1 (x as ([10, 20]))&quot;);
1512         GeneratedReference generatedReference = md.generatedColumnReferences().get(0);
1513         assertThat(generatedReference.valueType(), is</B></FONT>(new ArrayType&lt;&gt;(DataTypes.INTEGER)));
1514     <FONT color="#980517"><A HREF="javascript:ZweiFrames('match306914-1.html#59',3,'match306914-top.html#59',1)"><IMG
1515             SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>}
1516     @Test
1517     public void testColumnWithDefaultExpression() throws Exception {
1518 <A NAME="73"></A>        DocIndexMetadata md = getDocIndexMetadataFromStatement(&quot;create table t1 (&quot; +
1519                                                                &quot; ts timestamp with time zone default current_timestamp)&quot;);
1520         Reference reference = md.references().get(new ColumnIdent(&quot;ts&quot;));
1521         assertThat(reference.valueType</B></FONT>(), <FONT color="#2981b2"><A
1522                 HREF="javascript:ZweiFrames('match306914-1.html#73',3,'match306914-top.html#73',1)"><IMG
1523                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>is(DataTypes.TIMESTAMPZ));
1524         assertThat(reference.defaultExpression(), isFunction(&quot;current_timestamp&quot;));
1525     }
1526 <A NAME="32"></A>
1527     @Test
1528     public void testTimestampColumnReferences() throws Exception {
1529         XContentBuilder builder = <FONT color="#5b8daf"><A
1530                     HREF="javascript:ZweiFrames('match306914-1.html#32',3,'match306914-top.html#32',1)"><IMG
1531                     SRC="forward.gif" ALT="other" BORDER="0"
1532                     ALIGN="right"></A><B>XContentFactory.jsonBuilder()</B></FONT>
1533             .startObject()
1534                 .startObject(Constants.DEFAULT_MAPPING_TYPE)
1535                     .startObject(&quot;properties&quot;)
1536                         .startObject(&quot;tz&quot;)
1537                             .field(&quot;type&quot;, &quot;date&quot;)
1538                         .endObject()
1539                         .startObject(&quot;t&quot;)
1540                             .field(&quot;type&quot;, &quot;date&quot;)
1541                             .field(&quot;ignore_timezone&quot;, true)
1542                         .endObject()
1543                     .endObject()
1544                 .endObject()
1545             .endObject();
1546 <A NAME="77"></A>        DocIndexMetadata md = newMeta(getIndexMetadata(&quot;test&quot;, builder), &quot;test&quot;);
1547         assertThat(md.columns</B></FONT>().size(), is(2));
1548         assertThat(<FONT color="#4e9258"><A
1549                 HREF="javascript:ZweiFrames('match306914-1.html#77',3,'match306914-top.html#77',1)"><IMG
1550                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>md.references().get(new ColumnIdent(&quot;tz&quot;)).valueType(), is(DataTypes.TIMESTAMPZ));
1551         assertThat(md.references().get(new ColumnIdent(&quot;t&quot;)).valueType(), is</B></FONT>(DataTypes.TIMESTAMP));
1552     }
1553 <A NAME="51"></A>
1554     @Test
1555     public void testColumnStoreBooleanIsParsedCorrectly() throws Exception {
1556         <FONT color="#b38481"><A
1557                 HREF="javascript:ZweiFrames('match306914-1.html#51',3,'match306914-top.html#51',1)"><IMG
1558                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>DocIndexMetadata md = getDocIndexMetadataFromStatement(
1559             &quot;create table t1 (x string STORAGE WITH (columnstore = false))&quot;);
1560         assertThat(md.columns().iterator().next().hasDocValues(), is(false));
1561     }
1562 <A NAME="14"></A>
1563     @Test
1564     public void test_resolve_inner_object_types() throws Exception {
1565         XContentBuilder builder = <FONT color="#842dce"><A
1566                     HREF="javascript:ZweiFrames('match306914-1.html#14',3,'match306914-top.html#14',1)"><IMG
1567                     SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>XContentFactory.jsonBuilder</B></FONT>()</B></FONT>
1568         .startObject()
1569             .startObject(Constants.DEFAULT_MAPPING_TYPE)
1570                 .startObject(&quot;properties&quot;)
1571                     .startObject(&quot;object&quot;)
1572                         .field(&quot;type&quot;, &quot;object&quot;)
1573                             .startObject(&quot;properties&quot;)
1574                                 .startObject(&quot;nestedObject&quot;)
1575                                     .field(&quot;type&quot;, &quot;object&quot;)
1576                                     .startObject(&quot;properties&quot;)
1577                                         .startObject(&quot;nestedNestedString&quot;)
1578                                             .field(&quot;type&quot;, &quot;string&quot;)
1579                                         .endObject()
1580                                     .endObject()
1581                                 .endObject()
1582                                 .startObject(&quot;nestedString&quot;)
1583                                     .field(&quot;type&quot;, &quot;string&quot;)
1584                                 .endObject()
1585                              .endObject()
1586                     .endObject()
1587 <A NAME="99"></A>                .endObject()
1588             .endObject()
1589         .endObject();
1590         <FONT color="#c57717"><A
1591                 HREF="javascript:ZweiFrames('match306914-1.html#99',3,'match306914-top.html#99',1)"><IMG
1592                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>IndexMetadata metadata = getIndexMetadata(&quot;test&quot;, builder);
1593 <A NAME="42"></A>        DocIndexMetadata md = newMeta(metadata, &quot;test&quot;);
1594         ObjectType objectType = (ObjectType) md.references().get(new</B></FONT> ColumnIdent(&quot;object&quot;)).valueType();
1595         assertThat(objectType.resolveInnerType(<FONT color="#c57717"><A
1596                 HREF="javascript:ZweiFrames('match306914-1.html#42',3,'match306914-top.html#42',1)"><IMG
1597                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>List.of(&quot;nestedString&quot;)), is(DataTypes.STRING));
1598         assertThat(objectType.resolveInnerType(List.of(&quot;nestedObject&quot;)).id(), is(ObjectType.ID));
1599         assertThat(objectType.resolveInnerType(List.of(&quot;nestedObject&quot;, &quot;nestedNestedString&quot;)), is(DataTypes.STRING));
1600     }
1601 <A NAME="86"></A>
1602     @Test
1603     public void test_nested_geo_shape_column_is_not_added_as_top_level_column() throws Exception {</B></FONT>
1604         <FONT color="#af7a82"><A
1605                 HREF="javascript:ZweiFrames('match306914-1.html#86',3,'match306914-top.html#86',1)"><IMG
1606                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>DocIndexMetadata md = getDocIndexMetadataFromStatement(
1607             &quot;create table tbl (x int, y object as (z geo_shape))&quot;);
1608         assertThat(md.columns(), contains(isReference(&quot;x&quot;), isReference(&quot;y&quot;)));
1609         assertThat(md.references(), hasKey</B></FONT>(new ColumnIdent(&quot;y&quot;, &quot;z&quot;)));
1610     }
1611 <A NAME="50"></A>
1612     @Test
1613     public void test_resolve_string_type_with_length_from_mappings_with_text_and_keyword_types() throws Exception {
1614         XContentBuilder builder = <FONT color="#ff0000"><A
1615                 HREF="javascript:ZweiFrames('match306914-1.html#50',3,'match306914-top.html#50',1)"><IMG
1616                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>XContentFactory.jsonBuilder()
1617             .startObject()
1618                 .startObject(Constants.DEFAULT_MAPPING_TYPE)
1619                     .startObject(&quot;properties&quot;)
1620                         .startObject(&quot;col&quot;)
1621                             .field(&quot;type&quot;, &quot;keyword&quot;)
1622                             .field(&quot;length_limit&quot;, 10)
1623                             .field(&quot;index&quot;, &quot;false&quot;)
1624                         .endObject()
1625                     .endObject()
1626                 .endObject()
1627 <A NAME="85"></A>            .endObject();
1628         var docIndexMetadata = newMeta(getIndexMetadata(&quot;test&quot;, builder), &quot;test&quot;);
1629         var column = docIndexMetadata.references</B></FONT>().get(<FONT color="#717d7d"><A
1630                 HREF="javascript:ZweiFrames('match306914-1.html#85',3,'match306914-top.html#85',1)"><IMG
1631                 SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>new ColumnIdent(&quot;col&quot;));
1632         assertThat(column, is(not(nullValue())));
1633         assertThat(column.valueType(), is(StringType.of(10)));
1634     }</B></FONT>
1635 }
</PRE>
    </div>
    <div style="flex-grow: 1;">
        <h3>
            <center>
                <span>InternalEngineTests.java</span>
                <span> - </span>
                <span></span>
            </center>
        </h3>
        <HR>
        <PRE>
1 package org.elasticsearch.index.engine;
2 import static java.util.Collections.shuffle;
3 import static org.elasticsearch.index.engine.Engine.Operation.Origin.LOCAL_RESET;
4 import static org.elasticsearch.index.engine.Engine.Operation.Origin.LOCAL_TRANSLOG_RECOVERY;
5 import static org.elasticsearch.index.engine.Engine.Operation.Origin.PEER_RECOVERY;
6 import static org.elasticsearch.index.engine.Engine.Operation.Origin.PRIMARY;
7 import static org.elasticsearch.index.engine.Engine.Operation.Origin.REPLICA;
8 import static org.elasticsearch.index.seqno.SequenceNumbers.NO_OPS_PERFORMED;
9 import static org.elasticsearch.index.seqno.SequenceNumbers.UNASSIGNED_PRIMARY_TERM;
10 import static org.elasticsearch.index.seqno.SequenceNumbers.UNASSIGNED_SEQ_NO;
11 import static org.elasticsearch.index.translog.TranslogDeletionPolicies.createTranslogDeletionPolicy;
12 import static org.hamcrest.CoreMatchers.instanceOf;
13 import static org.hamcrest.CoreMatchers.is;
14 import static org.hamcrest.Matchers.contains;
15 import static org.hamcrest.Matchers.containsInAnyOrder;
16 import static org.hamcrest.Matchers.containsString;
17 import static org.hamcrest.Matchers.empty;
18 import static org.hamcrest.Matchers.equalTo;
19 import static org.hamcrest.Matchers.greaterThan;
20 import static org.hamcrest.Matchers.greaterThanOrEqualTo;
21 import static org.hamcrest.Matchers.hasItem;
22 import static org.hamcrest.Matchers.hasKey;
23 import static org.hamcrest.Matchers.hasSize;
24 import static org.hamcrest.Matchers.isIn;
25 import static org.hamcrest.Matchers.lessThanOrEqualTo;
26 import static org.hamcrest.Matchers.not;
27 import static org.hamcrest.Matchers.notNullValue;
28 import static org.hamcrest.Matchers.nullValue;
29 import static org.hamcrest.Matchers.sameInstance;
30 import static org.mockito.Mockito.spy;
31 import static org.mockito.Mockito.when;
32 import java.io.Closeable;
33 import java.io.IOException;
34 import java.io.UncheckedIOException;
35 import java.nio.charset.Charset;
36 import java.nio.file.Files;
37 import java.nio.file.Path;
38 import java.util.ArrayList;
39 import java.util.Arrays;
40 import java.util.Base64;
41 import java.util.Collections;
42 import java.util.Comparator;
43 import java.util.HashMap;
44 import java.util.HashSet;
45 import java.util.Iterator;
46 import java.util.LinkedHashMap;
47 import java.util.List;
48 import java.util.Map;
49 import java.util.Queue;
50 import java.util.Set;
51 import java.util.concurrent.BrokenBarrierException;
52 import java.util.concurrent.CountDownLatch;
53 import java.util.concurrent.CyclicBarrier;
54 import java.util.concurrent.Phaser;
55 import java.util.concurrent.TimeUnit;
56 import java.util.concurrent.atomic.AtomicBoolean;
57 import java.util.concurrent.atomic.AtomicInteger;
58 import java.util.concurrent.atomic.AtomicLong;
59 import java.util.concurrent.atomic.AtomicReference;
60 import java.util.function.BiFunction;
61 import java.util.function.Function;
62 import java.util.function.IntSupplier;
63 import java.util.function.LongSupplier;
64 import java.util.function.Supplier;
65 import java.util.function.ToLongBiFunction;
66 import java.util.stream.Collectors;
67 import java.util.stream.LongStream;
68 import com.carrotsearch.randomizedtesting.generators.RandomNumbers;
69 import org.apache.logging.log4j.Level;
70 import org.apache.logging.log4j.LogManager;
71 import org.apache.logging.log4j.Logger;
72 import org.apache.logging.log4j.core.LogEvent;
73 import org.apache.logging.log4j.core.appender.AbstractAppender;
74 import org.apache.logging.log4j.core.filter.RegexFilter;
75 import org.apache.lucene.codecs.lucene87.Lucene87StoredFieldsFormat;
76 import org.apache.lucene.document.Field;
77 import org.apache.lucene.document.LongPoint;
78 import org.apache.lucene.document.NumericDocValuesField;
79 import org.apache.lucene.document.StoredField;
80 import org.apache.lucene.document.TextField;
81 import org.apache.lucene.index.DirectoryReader;
82 import org.apache.lucene.index.IndexCommit;
83 import org.apache.lucene.index.IndexReader;
84 import org.apache.lucene.index.IndexWriter;
85 import org.apache.lucene.index.IndexWriterConfig;
86 import org.apache.lucene.index.IndexableField;
87 import org.apache.lucene.index.LeafReader;
88 import org.apache.lucene.index.LeafReaderContext;
89 import org.apache.lucene.index.LiveIndexWriterConfig;
90 import org.apache.lucene.index.LogByteSizeMergePolicy;
91 import org.apache.lucene.index.LogDocMergePolicy;
92 import org.apache.lucene.index.MergePolicy;
93 import org.apache.lucene.index.NoMergePolicy;
94 import org.apache.lucene.index.NumericDocValues;
95 import org.apache.lucene.index.PointValues;
96 import org.apache.lucene.index.SegmentInfos;
97 import org.apache.lucene.index.SoftDeletesRetentionMergePolicy;
98 import org.apache.lucene.index.Term;
99 import org.apache.lucene.index.Terms;
100 import org.apache.lucene.index.TermsEnum;
101 import org.apache.lucene.index.TieredMergePolicy;
102 import org.apache.lucene.search.IndexSearcher;
103 import org.apache.lucene.search.MatchAllDocsQuery;
104 import org.apache.lucene.search.ReferenceManager;
105 import org.apache.lucene.search.TermQuery;
106 <A NAME="0"></A>import org.apache.lucene.search.TopDocs;
107 import org.apache.lucene.search.TotalHitCountCollector;
108 import org.apache.lucene.store.AlreadyClosedException;
109 <FONT color="#0000ff"><div style="position:absolute;left:0"><A
110         HREF="javascript:ZweiFrames('match306914-0.html#0',2,'match306914-top.html#0',1)"><IMG SRC="back.gif"
111                                                                                                ALT="other" BORDER="0"
112                                                                                                ALIGN="left"></A></div><B>import org.apache.lucene.store.Directory;
113 import org.apache.lucene.store.Lock;
114 import org.apache.lucene.store.MockDirectoryWrapper;
115 import org.apache.lucene.util.Bits;
116 import org.apache.lucene.util.BytesRef;
117 import org.apache.lucene.util.FixedBitSet;
118 import org.elasticsearch.ElasticsearchException;
119 import org.elasticsearch.Version;
120 import org.elasticsearch.action.ActionListener;
121 import org.elasticsearch.action.support.TransportActions;
122 import org.elasticsearch.cluster.metadata.IndexMetadata;
123 import org.elasticsearch.cluster.routing.IndexShardRoutingTable;
124 import org.elasticsearch.cluster.routing.ShardRouting;
125 import org.elasticsearch.cluster.routing.ShardRoutingState;
126 import org.elasticsearch.cluster.routing.TestShardRouting;
127 import org.elasticsearch.common.CheckedBiConsumer;
128 import org.elasticsearch.common.CheckedRunnable;
129 import org.elasticsearch.common.Randomness;
130 import org.elasticsearch.common.Strings;
131 import org.elasticsearch.common.TriFunction;
132 import org.elasticsearch.common.UUIDs;
133 import org.elasticsearch.common.bytes.BytesArray;
134 import org.elasticsearch.common.bytes.BytesReference;
135 import org.elasticsearch.common.logging.Loggers;
136 import org.elasticsearch.common.lucene.Lucene;
137 import org.elasticsearch.common.lucene.index.ElasticsearchDirectoryReader;
138 import org.elasticsearch.common.lucene.index.SequentialStoredFieldsLeafReader;
139 import org.elasticsearch.common.lucene.uid.Versions;
140 import org.elasticsearch.common.lucene.uid.VersionsAndSeqNoResolver;
141 import org.elasticsearch.common.lucene.uid.VersionsAndSeqNoResolver.DocIdAndSeqNo;
142 import org.elasticsearch.common.settings.Settings;
143 import org.elasticsearch.common.unit.ByteSizeValue;
144 import org.elasticsearch.common.util.BigArrays;
145 import org.elasticsearch.common.util.concurrent.AbstractRunnable;
146 import org.elasticsearch.common.util.concurrent.ConcurrentCollections;
147 import org.elasticsearch.index.IndexSettings;
148 import org.elasticsearch.index.VersionType;
149 import org.elasticsearch.index.codec.CodecService;
150 import org.elasticsearch.index.engine.Engine.Searcher;
151 import org.elasticsearch.index.fieldvisitor.FieldsVisitor;
152 import org.elasticsearch.index.mapper.IdFieldMapper;
153 import org.elasticsearch.index.mapper.MapperService;
154 import org.elasticsearch.index.mapper.ParseContext;
155 import org.elasticsearch.index.mapper.ParseContext.Document;
156 import org.elasticsearch.index.mapper.ParsedDocument;
157 import org.elasticsearch.index.mapper.SeqNoFieldMapper;
158 import org.elasticsearch.index.mapper.SourceFieldMapper;
159 import org.elasticsearch.index.mapper.Uid;
160 import org.elasticsearch.index.mapper.VersionFieldMapper;
161 import org.elasticsearch.index.seqno.LocalCheckpointTracker;
162 import org.elasticsearch.index.seqno.ReplicationTracker;
163 import org.elasticsearch.index.seqno.RetentionLease;
164 import org.elasticsearch.index.seqno.RetentionLeases;
165 import org.elasticsearch.index.seqno.SeqNoStats;
166 import org.elasticsearch.index.seqno.SequenceNumbers;
167 import org.elasticsearch.index.shard.ShardId;
168 import org.elasticsearch.index.shard.ShardUtils;
169 import org.elasticsearch.index.store.Store;
170 import org.elasticsearch.index.translog.SnapshotMatchers;
171 import org.elasticsearch.index.translog.TestTranslog;
172 import org.elasticsearch.index.translog.Translog;
173 import org.elasticsearch.index.translog.TranslogConfig;
174 import org.elasticsearch.indices.breaker.NoneCircuitBreakerService;
175 import org.elasticsearch.test.IndexSettingsModule;
176 import org.elasticsearch.test.VersionUtils;
177 import org.elasticsearch.threadpool.ThreadPool;
178 import org.hamcrest.Matcher;
179 import org.hamcrest.MatcherAssert;
180 import org.hamcrest.Matchers;
181 import org.junit.Test;
182 import io.crate.common.collections.Tuple;
183 import io.crate.common.io.IOUtils;
184 import io.crate.common.unit.TimeValue;
185 public class InternalEngineTests extends EngineTestCase {
186     static final long UNSET_AUTO_GENERATED_TIMESTAMP = -1L</B></FONT>;
187     @Test
188     public void testVersionMapAfterAutoIDDocument() throws IOException {
189         engine.refresh(&quot;warm_up&quot;);
190         ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(&quot;test&quot;),
191                                                 new BytesArray(&quot;{}&quot;.getBytes(Charset.defaultCharset())), null);
192         Engine.Index operation = randomBoolean() ?
193             appendOnlyPrimary(doc, false, 1)
194             : appendOnlyReplica(doc, false, 1, randomIntBetween(0, 5));
195         engine.index(operation);
196         assertFalse(engine.isSafeAccessRequired());
197         doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(&quot;updated&quot;),
198                                  new BytesArray(&quot;{}&quot;.getBytes(Charset.defaultCharset())), null);
199         Engine.Index update = indexForDoc(doc);
200         engine.index(update);
201         assertTrue(engine.isSafeAccessRequired());
202         assertThat(engine.getVersionMap().values(), hasSize(1));
203         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
204             assertEquals(0, searcher.getIndexReader().numDocs());
205         }
206         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.INTERNAL)) {
207             assertEquals(1, searcher.getIndexReader().numDocs());
208             TopDocs search = searcher.search(new MatchAllDocsQuery(), 1);
209             org.apache.lucene.document.Document luceneDoc = searcher.doc(search.scoreDocs[0].doc);
210             assertEquals(&quot;test&quot;, luceneDoc.get(&quot;value&quot;));
211         }
212         engine.refresh(&quot;test&quot;);
213         if (randomBoolean()) {             engine.refresh(&quot;test&quot;);
214         }
215         assertTrue(&quot;safe access should be required we carried it over&quot;, engine.isSafeAccessRequired());
216         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
217             assertEquals(1, searcher.getIndexReader().numDocs());
218             TopDocs search = searcher.search(new MatchAllDocsQuery(), 1);
219             org.apache.lucene.document.Document luceneDoc = searcher.doc(search.scoreDocs[0].doc);
220             assertEquals(&quot;updated&quot;, luceneDoc.get(&quot;value&quot;));
221         }
222         doc = testParsedDocument(&quot;2&quot;, null, testDocumentWithTextField(&quot;test&quot;),
223                                  new BytesArray(&quot;{}&quot;.getBytes(Charset.defaultCharset())), null);
224         operation = randomBoolean() ?
225             appendOnlyPrimary(doc, false, 1)
226             : appendOnlyReplica(doc, false, 1, generateNewSeqNo(engine));
227         engine.index(operation);
228         assertTrue(&quot;safe access should be required&quot;, engine.isSafeAccessRequired());
229         assertThat(engine.getVersionMap().values(), hasSize(1));         engine.refresh(&quot;test&quot;);
230         if (randomBoolean()) {             engine.refresh(&quot;test&quot;);
231         }
232         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
233             assertEquals(2, searcher.getIndexReader().numDocs());
234         }
235 <A NAME="83"></A>        if (operation.origin() == PRIMARY) {
236             assertFalse(&quot;safe access should NOT be required last indexing round was only append only&quot;, engine.isSafeAccessRequired());
237         }
238         <FONT color="#68818b"><div style="position:absolute;left:0"><A
239                 HREF="javascript:ZweiFrames('match306914-0.html#83',2,'match306914-top.html#83',1)"><IMG SRC="back.gif"
240                                                                                                          ALT="other"
241                                                                                                          BORDER="0"
242                                                                                                          ALIGN="left"></A></div><B>engine.delete(new Engine.Delete(
243             operation.id(),
244             operation.uid(),
245             UNASSIGNED_SEQ_NO,
246             primaryTerm.get(),
247             Versions.MATCH_ANY,
248             VersionType.INTERNAL,
249             Engine.Operation.Origin.PRIMARY,
250             System.nanoTime(),
251             UNASSIGNED_SEQ_NO,
252             0
253         ));
254         assertTrue(&quot;safe access should be required&quot;, engine.isSafeAccessRequired());
255         engine.refresh(&quot;test&quot;);
256         assertTrue(&quot;safe access should be required&quot;, engine.isSafeAccessRequired</B></FONT>());
257 <A NAME="82"></A>        try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
258             assertEquals(1, searcher.getIndexReader().numDocs());
259         }
260     <FONT color="#5eac10"><div style="position:absolute;left:0"><A
261             HREF="javascript:ZweiFrames('match306914-0.html#82',2,'match306914-top.html#82',1)"><IMG SRC="back.gif"
262                                                                                                      ALT="other"
263                                                                                                      BORDER="0"
264                                                                                                      ALIGN="left"></A></div><B>}
265     @Test
266     public void testSegmentsWithoutSoftDeletes() throws Exception {
267         Settings settings = Settings.builder()
268             .put(defaultSettings.getSettings</B></FONT>())
269             .put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), false).build();
270         IndexSettings indexSettings = IndexSettingsModule.newIndexSettings(
271             IndexMetadata.builder(defaultSettings.getIndexMetadata()).settings(settings).build());
272         try (Store store = createStore();
273              InternalEngine engine = createEngine(config(indexSettings, store, createTempDir(), NoMergePolicy.INSTANCE, null))) {
274             List&lt;Segment&gt; segments = engine.segments(false);
275             assertThat(segments.isEmpty(), equalTo(true));
276             ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(), B_1, null);
277             Engine.Index first = indexForDoc(doc);
278             Engine.IndexResult firstResult = engine.index(first);
279             ParsedDocument doc2 = testParsedDocument(&quot;2&quot;, null, testDocumentWithTextField(), B_2, null);
280             Engine.Index second = indexForDoc(doc2);
281             Engine.IndexResult secondResult = engine.index(second);
282 <A NAME="6"></A>            assertThat(secondResult.getTranslogLocation(), greaterThan(firstResult.getTranslogLocation()));
283             engine.refresh(&quot;test&quot;);
284             segments = <FONT color="#8c8774"><div style="position:absolute;left:0"><A
285                 HREF="javascript:ZweiFrames('match306914-0.html#6',2,'match306914-top.html#6',1)"><IMG SRC="back.gif"
286                                                                                                        ALT="other"
287                                                                                                        BORDER="0"
288                                                                                                        ALIGN="left"></A></div><B>engine.segments(false);
289             assertThat(segments.size(), equalTo(1));
290             assertThat(segments.get(0).isCommitted(), equalTo(false));
291             assertThat(segments.get(0).isSearch(), equalTo(true));
292             assertThat(segments.get(0).getNumDocs(), equalTo(2));
293             assertThat(segments.get(0).getDeletedDocs(), equalTo(0));
294             assertThat(segments.get(0).isCompound(), equalTo(true));
295             assertThat(segments.get(0).ramTree, nullValue());
296             assertThat(segments.get(0).getAttributes().keySet(), Matchers.contains</B></FONT>(Lucene87StoredFieldsFormat.MODE_KEY));
297 <A NAME="11"></A>
298             engine.flush();
299             segments = <FONT color="#b041ff"><div style="position:absolute;left:0"><A
300                 HREF="javascript:ZweiFrames('match306914-0.html#11',2,'match306914-top.html#11',1)"><IMG SRC="back.gif"
301                                                                                                          ALT="other"
302                                                                                                          BORDER="0"
303                                                                                                          ALIGN="left"></A></div><B>engine.segments(false);
304             assertThat(segments.size(), equalTo(1));
305             assertThat(segments.get(0).isCommitted(), equalTo(true));
306             assertThat(segments.get(0).isSearch(), equalTo(true));
307             assertThat(segments.get(0).getNumDocs(), equalTo(2));
308             assertThat(segments.get(0).getDeletedDocs(), equalTo(0));
309             assertThat(segments.get(0).isCompound(), equalTo(true));
310             ParsedDocument doc3 = testParsedDocument</B></FONT>(&quot;3&quot;, null, testDocumentWithTextField(), B_3, null);
311 <A NAME="3"></A>            engine.index(indexForDoc(doc3));
312             engine.refresh(&quot;test&quot;);
313             segments = <FONT color="#53858b"><div style="position:absolute;left:0"><A
314                 HREF="javascript:ZweiFrames('match306914-0.html#3',2,'match306914-top.html#3',1)"><IMG SRC="back.gif"
315                                                                                                        ALT="other"
316                                                                                                        BORDER="0"
317                                                                                                        ALIGN="left"></A></div><B>engine.segments(false);
318             assertThat(segments.size(), equalTo(2));
319             assertThat(segments.get(0).getGeneration() &lt; segments.get(1).getGeneration(), equalTo(true));
320             assertThat(segments.get(0).isCommitted(), equalTo(true));
321             assertThat(segments.get(0).isSearch(), equalTo(true));
322             assertThat(segments.get(0).getNumDocs(), equalTo(2));
323             assertThat(segments.get(0).getDeletedDocs(), equalTo(0));
324             assertThat(segments.get(0).isCompound(), equalTo(true));
325 <A NAME="90"></A>            assertThat(segments.get(1).isCommitted(), equalTo(false));
326             assertThat(segments.get(1).isSearch(), equalTo(true));
327             assertThat(segments.get(1).getNumDocs(), equalTo</B></FONT>(1));
328             assertThat(segments.get(1).getDeletedDocs(), <FONT color="#736aff"><div style="position:absolute;left:0"><A
329                 HREF="javascript:ZweiFrames('match306914-0.html#90',2,'match306914-top.html#90',1)"><IMG SRC="back.gif"
330                                                                                                          ALT="other"
331                                                                                                          BORDER="0"
332                                                                                                          ALIGN="left"></A></div><B>equalTo(0));
333             assertThat(segments.get(1).isCompound(), equalTo(true));
334             engine.delete(new Engine.Delete(
335                 &quot;1&quot;,
336                 newUid(doc),
337                 UNASSIGNED_SEQ_NO,
338                 primaryTerm.get(),
339                 Versions.MATCH_ANY,
340                 VersionType.INTERNAL,
341                 Engine.Operation.Origin.PRIMARY,
342                 System.nanoTime</B></FONT>(),
343                 UNASSIGNED_SEQ_NO,
344                 0
345             ));
346             engine.refresh(&quot;test&quot;);
347 <A NAME="2"></A>
348             segments = engine.segments(false);
349             assertThat(segments.size(), equalTo(2));
350             assertThat(segments.get(0).getGeneration() &lt; <FONT color="#980517"><div style="position:absolute;left:0"><A
351                 HREF="javascript:ZweiFrames('match306914-0.html#2',2,'match306914-top.html#2',1)"><IMG SRC="back.gif"
352                                                                                                        ALT="other"
353                                                                                                        BORDER="0"
354                                                                                                        ALIGN="left"></A></div><B>segments.get(1).getGeneration(), equalTo(true));
355             assertThat(segments.get(0).isCommitted(), equalTo(true));
356             assertThat(segments.get(0).isSearch(), equalTo(true));
357             assertThat(segments.get(0).getNumDocs(), equalTo(1));
358             assertThat(segments.get(0).getDeletedDocs(), equalTo(1));
359             assertThat(segments.get(0).isCompound(), equalTo(true));
360             assertThat(segments.get(1).isCommitted(), equalTo(false));
361             assertThat(segments.get(1).isSearch(), equalTo(true));
362             assertThat(segments.get(1).getNumDocs(), equalTo(1));
363             assertThat(segments.get(1).getDeletedDocs(), equalTo(0));
364             assertThat(segments.get(1).isCompound(), equalTo(true));
365             engine.onSettingsChanged(indexSettings.getTranslogRetentionAge(), indexSettings.getTranslogRetentionSize(),
366 <A NAME="80"></A>                                     indexSettings.getSoftDeleteRetentionOperations());
367             ParsedDocument doc4 = testParsedDocument</B></FONT>(&quot;4&quot;, null, testDocumentWithTextField(), B_3, null);
368             engine.index(indexForDoc(doc4));
369             <FONT color="#f660ab"><div style="position:absolute;left:0"><A
370                     HREF="javascript:ZweiFrames('match306914-0.html#80',2,'match306914-top.html#80',1)"><IMG
371                     SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>engine.refresh(&quot;test&quot;);
372 <A NAME="1"></A>            segments = engine.segments(false);
373             assertThat(segments.size(), equalTo(3));
374             assertThat(segments.get(0).getGeneration() &lt; segments.get</B></FONT>(1).getGeneration(), equalTo(true));
375             assertThat(segments.get(0).isCommitted(), <FONT color="#f63526"><div style="position:absolute;left:0"><A
376                 HREF="javascript:ZweiFrames('match306914-0.html#1',2,'match306914-top.html#1',1)"><IMG SRC="back.gif"
377                                                                                                        ALT="other"
378                                                                                                        BORDER="0"
379                                                                                                        ALIGN="left"></A></div><B>equalTo(true));
380             assertThat(segments.get(0).isSearch(), equalTo(true));
381             assertThat(segments.get(0).getNumDocs(), equalTo(1));
382             assertThat(segments.get(0).getDeletedDocs(), equalTo(1));
383             assertThat(segments.get(0).isCompound(), equalTo(true));
384             assertThat(segments.get(1).isCommitted(), equalTo(false));
385             assertThat(segments.get(1).isSearch(), equalTo(true));
386             assertThat(segments.get(1).getNumDocs(), equalTo(1));
387             assertThat(segments.get(1).getDeletedDocs(), equalTo(0));
388             assertThat(segments.get(1).isCompound(), equalTo(true));
389             assertThat(segments.get(2).isCommitted(), equalTo(false));
390             assertThat(segments.get(2).isSearch(), equalTo(true));
391             assertThat(segments.get(2).getNumDocs(), equalTo(1));
392             assertThat(segments.get(2).getDeletedDocs(), equalTo(0));
393             assertThat(segments.get(2).isCompound(), equalTo(true));
394             ParsedDocument doc5 = testParsedDocument</B></FONT>(&quot;5&quot;, null, testDocumentWithTextField(), B_3, null);
395 <A NAME="5"></A>            engine.index(indexForDoc(doc5));
396             engine.refresh(&quot;test&quot;, Engine.SearcherScope.INTERNAL, true);
397             segments = <FONT color="#151b8d"><div style="position:absolute;left:0"><A
398                 HREF="javascript:ZweiFrames('match306914-0.html#5',2,'match306914-top.html#5',1)"><IMG SRC="back.gif"
399                                                                                                        ALT="other"
400                                                                                                        BORDER="0"
401                                                                                                        ALIGN="left"></A></div><B>engine.segments(false);
402             assertThat(segments.size(), equalTo(4));
403             assertThat(segments.get(0).getGeneration() &lt; segments.get(1).getGeneration(), equalTo(true));
404             assertThat(segments.get(0).isCommitted(), equalTo(true));
405             assertThat(segments.get(0).isSearch(), equalTo(true));
406             assertThat(segments.get(0).getNumDocs(), equalTo(1));
407             assertThat(segments.get(0).getDeletedDocs(), equalTo(1));
408 <A NAME="8"></A>            assertThat(segments.get(0).isCompound(), equalTo(true));
409             assertThat(segments.get(1).isCommitted(), equalTo(false));
410             assertThat</B></FONT>(<FONT color="#c58917"><div style="position:absolute;left:0"><A
411                 HREF="javascript:ZweiFrames('match306914-0.html#8',2,'match306914-top.html#8',1)"><IMG SRC="back.gif"
412                                                                                                        ALT="other"
413                                                                                                        BORDER="0"
414                                                                                                        ALIGN="left"></A></div><B>segments.get(1).isSearch(), equalTo(true));
415             assertThat(segments.get(1).getNumDocs(), equalTo(1));
416             assertThat(segments.get(1).getDeletedDocs(), equalTo(0));
417             assertThat(segments.get(1).isCompound(), equalTo(true));
418 <A NAME="44"></A>            assertThat(segments.get(2).isCommitted(), equalTo(false));
419             assertThat(segments.get(2).isSearch(), equalTo(true));
420             assertThat(segments.get(2).getNumDocs(), equalTo(1));
421             assertThat(<FONT color="#a057a5"><div style="position:absolute;left:0"><A
422                     HREF="javascript:ZweiFrames('match306914-0.html#44',2,'match306914-top.html#44',1)"><IMG
423                     SRC="back.gif" ALT="other" BORDER="0"
424                     ALIGN="left"></A></div><B>segments.get(2).getDeletedDocs</B></FONT>(), equalTo(0));
425             assertThat(segments.get(2).isCompound(), equalTo(true));
426 <A NAME="10"></A>            assertThat(segments.get(3).isCommitted(), equalTo(false));
427             assertThat(segments.get(3).isSearch(), equalTo(false));
428             assertThat(segments.get(3).getNumDocs</B></FONT>(), equalTo(1));
429             <FONT color="#ad5910"><div style="position:absolute;left:0"><A
430                     HREF="javascript:ZweiFrames('match306914-0.html#10',2,'match306914-top.html#10',1)"><IMG
431                     SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>assertThat(segments.get(3).getDeletedDocs(), equalTo(0));
432             assertThat(segments.get(3).isCompound(), equalTo(true));
433             engine.refresh(&quot;test&quot;);
434             segments = engine.segments(false);
435 <A NAME="14"></A>            assertThat(segments.size(), equalTo(4));
436             assertThat(segments.get(0).getGeneration() &lt; segments.get(1).getGeneration(), equalTo(true));
437             assertThat(segments.get(0).isCommitted(), equalTo(true));
438             assertThat(segments.get</B></FONT>(0).isSearch(), <FONT color="#842dce"><div
439                 style="position:absolute;left:0"><A
440                 HREF="javascript:ZweiFrames('match306914-0.html#14',2,'match306914-top.html#14',1)"><IMG SRC="back.gif"
441                                                                                                          ALT="other"
442                                                                                                          BORDER="0"
443                                                                                                          ALIGN="left"></A></div><B>equalTo(true));
444             assertThat(segments.get(0).getNumDocs(), equalTo(1));
445             assertThat(segments.get(0).getDeletedDocs(), equalTo(1));
446             assertThat(segments.get(0).isCompound(), equalTo(true));
447 <A NAME="28"></A>
448             assertThat(segments.get(1).isCommitted(), equalTo(false));
449             assertThat(segments.get(1).isSearch(), equalTo(true));
450             assertThat(<FONT color="#717d7d"><div style="position:absolute;left:0"><A
451                     HREF="javascript:ZweiFrames('match306914-0.html#28',2,'match306914-top.html#28',1)"><IMG
452                     SRC="back.gif" ALT="other" BORDER="0"
453                     ALIGN="left"></A></div><B>segments.get(1).getNumDocs</B></FONT>(), equalTo(1));
454             assertThat(segments.get(1).getDeletedDocs(), equalTo(0));
455             assertThat(segments.get(1).isCompound(), equalTo(true));
456 <A NAME="7"></A>
457             assertThat(segments.get(2).isCommitted(), equalTo(false));
458             assertThat(segments.get(2).isSearch(), equalTo(true));
459             assertThat</B></FONT>(segments.get(2).getNumDocs(), <FONT color="#38a4a5"><div
460                 style="position:absolute;left:0"><A
461                 HREF="javascript:ZweiFrames('match306914-0.html#7',2,'match306914-top.html#7',1)"><IMG SRC="back.gif"
462                                                                                                        ALT="other"
463                                                                                                        BORDER="0"
464                                                                                                        ALIGN="left"></A></div><B>equalTo(1));
465             assertThat(segments.get(2).getDeletedDocs(), equalTo(0));
466             assertThat(segments.get(2).isCompound(), equalTo(true));
467             assertThat(segments.get(3).isCommitted(), equalTo(false));
468             assertThat(segments.get(3).isSearch(), equalTo(true));
469             assertThat(segments.get(3).getNumDocs(), equalTo(1));
470             assertThat(segments.get(3).getDeletedDocs(), equalTo(0));
471             assertThat(segments.get(3).isCompound(), equalTo(true));
472         }</B></FONT>
473     }
474     @Test
475     public void testVerboseSegments() throws Exception {
476         try (Store store = createStore();
477              Engine engine = createEngine(defaultSettings, store, createTempDir(), NoMergePolicy.INSTANCE)) {
478             List&lt;Segment&gt; segments = engine.segments(true);
479             assertThat(segments.isEmpty(), equalTo(true));
480             ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(), B_1, null);
481 <A NAME="98"></A>            engine.index(indexForDoc(doc));
482             engine.refresh(&quot;test&quot;);
483             segments = <FONT color="#f87a17"><div style="position:absolute;left:0"><A
484                 HREF="javascript:ZweiFrames('match306914-0.html#98',2,'match306914-top.html#98',1)"><IMG SRC="back.gif"
485                                                                                                          ALT="other"
486                                                                                                          BORDER="0"
487                                                                                                          ALIGN="left"></A></div><B>engine.segments(true);
488             assertThat(segments.size(), equalTo(1));
489             assertThat(segments.get(0).ramTree, notNullValue());
490             ParsedDocument doc2 = testParsedDocument(&quot;2&quot;, null, testDocumentWithTextField</B></FONT>(), B_2, null);
491             engine.index(indexForDoc(doc2));
492             engine.refresh(&quot;test&quot;);
493             ParsedDocument doc3 = testParsedDocument(&quot;3&quot;, null, testDocumentWithTextField(), B_3, null);
494             engine.index(indexForDoc(doc3));
495             engine.refresh(&quot;test&quot;);
496             segments = engine.segments(true);
497             assertThat(segments.size(), equalTo(3));
498             assertThat(segments.get(0).ramTree, notNullValue());
499             assertThat(segments.get(1).ramTree, notNullValue());
500             assertThat(segments.get(2).ramTree, notNullValue());
501         }
502     }
503     @Test
504     public void testSegmentsWithMergeFlag() throws Exception {
505         try (Store store = createStore();
506              Engine engine = createEngine(defaultSettings, store, createTempDir(), new TieredMergePolicy())) {
507             ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocument(), B_1, null);
508             Engine.Index index = indexForDoc(doc);
509             engine.index(index);
510             engine.flush();
511             assertThat(engine.segments(false).size(), equalTo(1));
512             index = indexForDoc(testParsedDocument(&quot;2&quot;, null, testDocument(), B_1, null));
513             engine.index(index);
514             engine.flush();
515             List&lt;Segment&gt; segments = engine.segments(false);
516             assertThat(segments.size(), equalTo(2));
517             for (Segment segment : segments) {
518                 assertThat(segment.getMergeId(), nullValue());
519             }
520             index = indexForDoc(testParsedDocument(&quot;3&quot;, null, testDocument(), B_1, null));
521             engine.index(index);
522             engine.flush();
523             segments = engine.segments(false);
524             assertThat(segments.size(), equalTo(3));
525             for (Segment segment : segments) {
526                 assertThat(segment.getMergeId(), nullValue());
527             }
528             index = indexForDoc(doc);
529             engine.index(index);
530             engine.flush();
531             final long gen1 = store.readLastCommittedSegmentsInfo().getGeneration();
532             engine.forceMerge(true, 1, false, false, false, UUIDs.randomBase64UUID());
533             for (Segment segment : engine.segments(false)) {
534                 assertThat(segment.getMergeId(), nullValue());
535             }
536             assertTrue(store.readLastCommittedSegmentsInfo().getGeneration() &gt; gen1);
537             final boolean flush = randomBoolean();
538             final long gen2 = store.readLastCommittedSegmentsInfo().getGeneration();
539             engine.forceMerge(flush, 1, false, false, false, UUIDs.randomBase64UUID());
540             for (Segment segment : engine.segments(false)) {
541                 assertThat(segment.getMergeId(), nullValue());
542             }
543             if (flush) {
544 <A NAME="46"></A>                assertEquals(gen2, store.readLastCommittedSegmentsInfo().getLastGeneration());
545             }
546         }
547     <FONT color="#668b8b"><div style="position:absolute;left:0"><A
548             HREF="javascript:ZweiFrames('match306914-0.html#46',2,'match306914-top.html#46',1)"><IMG SRC="back.gif"
549                                                                                                      ALT="other"
550                                                                                                      BORDER="0"
551                                                                                                      ALIGN="left"></A></div><B>}
552     @Test
553     public void testSegmentsWithSoftDeletes() throws Exception {
554         Settings.Builder settings = Settings.builder()
555             .put(defaultSettings.getSettings())
556             .put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), true);
557         final IndexMetadata indexMetadata = IndexMetadata.builder(defaultSettings.getIndexMetadata</B></FONT>()).settings(settings).build();
558         final IndexSettings indexSettings = IndexSettingsModule.newIndexSettings(indexMetadata);
559         final AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
560         try (Store store = createStore();
561              InternalEngine engine = createEngine(config(indexSettings, store, createTempDir(), NoMergePolicy.INSTANCE, null,
562                                                          null, globalCheckpoint::get))) {
563             assertThat(engine.segments(false), empty());
564             int numDocsFirstSegment = randomIntBetween(5, 50);
565             Set&lt;String&gt; liveDocsFirstSegment = new HashSet&lt;&gt;();
566             for (int i = 0; i &lt; numDocsFirstSegment; i++) {
567                 String id = Integer.toString(i);
568                 ParsedDocument doc = testParsedDocument(id, null, testDocument(), B_1, null);
569 <A NAME="30"></A>                engine.index(indexForDoc(doc));
570                 liveDocsFirstSegment.add(id);
571             }
572             <FONT color="#ae694a"><div style="position:absolute;left:0"><A
573                     HREF="javascript:ZweiFrames('match306914-0.html#30',2,'match306914-top.html#30',1)"><IMG
574                     SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>engine.refresh(&quot;test&quot;);
575             List&lt;Segment&gt; segments = engine.segments(randomBoolean());
576             assertThat(segments, hasSize(1));
577             assertThat(segments.get(0).getNumDocs(), equalTo(liveDocsFirstSegment.size()));
578             assertThat(segments.get(0).getDeletedDocs(), equalTo(0));
579             assertFalse(segments.get(0).committed);
580             int deletes = 0</B></FONT>;
581             int updates = 0;
582             int appends = 0;
583             int iterations = scaledRandomIntBetween(1, 50);
584             for (int i = 0; i &lt; iterations &amp;&amp; liveDocsFirstSegment.isEmpty() == false; i++) {
585                 String idToUpdate = randomFrom(liveDocsFirstSegment);
586                 liveDocsFirstSegment.remove(idToUpdate);
587                 ParsedDocument doc = testParsedDocument(idToUpdate, null, testDocument(), B_1, null);
588                 if (randomBoolean()) {
589                     engine.delete(new Engine.Delete(doc.id(), newUid(doc), primaryTerm.get()));
590                     deletes++;
591                 } else {
592                     engine.index(indexForDoc(doc));
593                     updates++;
594                 }
595                 if (randomBoolean()) {
596                     engine.index(indexForDoc(testParsedDocument(UUIDs.randomBase64UUID(), null, testDocument(), B_1, null)));
597                     appends++;
598                 }
599             }
600             boolean committed = randomBoolean();
601             if (committed) {
602                 engine.flush();
603             }
604 <A NAME="15"></A>            engine.refresh(&quot;test&quot;);
605             segments = engine.segments(randomBoolean());
606             assertThat(segments, hasSize(2));
607             assertThat(<FONT color="#f52887"><div style="position:absolute;left:0"><A
608                 HREF="javascript:ZweiFrames('match306914-0.html#15',2,'match306914-top.html#15',1)"><IMG SRC="back.gif"
609                                                                                                          ALT="other"
610                                                                                                          BORDER="0"
611                                                                                                          ALIGN="left"></A></div><B>segments.get(0).getNumDocs(), equalTo(liveDocsFirstSegment.size()));
612             assertThat(segments.get(0).getDeletedDocs(), equalTo(updates + deletes));
613             assertThat(segments.get(0).committed, equalTo(committed));
614             assertThat(segments.get(1).getNumDocs(), equalTo(updates + appends));
615             assertThat(segments.get(1).getDeletedDocs(), equalTo(deletes));             assertThat(segments.get(1).committed, equalTo(committed));
616         }</B></FONT>
617     }
618     @Test
619     public void testCommitStats() throws IOException {
620         final AtomicLong maxSeqNo = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
621         final AtomicLong localCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
622         final AtomicLong globalCheckpoint = new AtomicLong(UNASSIGNED_SEQ_NO);
623         try (
624             Store store = createStore();
625             InternalEngine engine = createEngine(store, createTempDir(), (maxSeq, localCP) -&gt; new LocalCheckpointTracker(
626                                                      maxSeq,
627                                                      localCP) {
628                                                      @Override
629                                                      public long getMaxSeqNo() {
630                                                          return maxSeqNo.get();
631                                                      }
632                                                      @Override
633                                                      public long getProcessedCheckpoint() {
634 <A NAME="13"></A>                                                         return localCheckpoint.get();
635                                                      }
636                     }
637             )) <FONT color="#3b9c9c"><div style="position:absolute;left:0"><A
638                 HREF="javascript:ZweiFrames('match306914-0.html#13',2,'match306914-top.html#13',1)"><IMG SRC="back.gif"
639                                                                                                          ALT="other"
640                                                                                                          BORDER="0"
641                                                                                                          ALIGN="left"></A></div><B>{
642             CommitStats stats1 = engine.commitStats();
643             assertThat(stats1.getGeneration(), greaterThan(0L));
644             assertThat(stats1.getId(), notNullValue());
645             assertThat(stats1.getUserData(), hasKey(SequenceNumbers.LOCAL_CHECKPOINT_KEY));
646             assertThat(
647                 Long.parseLong(stats1.getUserData().get(SequenceNumbers.LOCAL_CHECKPOINT_KEY)),
648                 equalTo(SequenceNumbers.NO_OPS_PERFORMED));
649             assertThat(stats1.getUserData(), hasKey(SequenceNumbers.MAX_SEQ_NO));
650             assertThat(
651                 Long.parseLong(stats1.getUserData().get(SequenceNumbers.MAX_SEQ_NO)),
652                 equalTo(SequenceNumbers.NO_OPS_PERFORMED));
653             maxSeqNo.set</B></FONT>(rarely() ? SequenceNumbers.NO_OPS_PERFORMED : randomIntBetween(0, 1024));
654             localCheckpoint.set(
655                 rarely() || maxSeqNo.get() == SequenceNumbers.NO_OPS_PERFORMED ?
656                     SequenceNumbers.NO_OPS_PERFORMED : randomIntBetween(0, 1024));
657             globalCheckpoint.set(rarely() || localCheckpoint.get() == SequenceNumbers.NO_OPS_PERFORMED ?
658                                      UNASSIGNED_SEQ_NO : randomIntBetween(0, (int) localCheckpoint.get()));
659 <A NAME="4"></A>
660             final Engine.CommitId commitId = engine.flush(true, true);
661             <FONT color="#6cc417"><div style="position:absolute;left:0"><A
662                     HREF="javascript:ZweiFrames('match306914-0.html#4',2,'match306914-top.html#4',1)"><IMG
663                     SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>CommitStats stats2 = engine.commitStats();
664             assertThat(stats2.getRawCommitId(), equalTo(commitId));
665             assertThat(stats2.getGeneration(), greaterThan(stats1.getGeneration()));
666             assertThat(stats2.getId(), notNullValue());
667             assertThat(stats2.getId(), not(equalTo(stats1.getId())));
668             assertThat(stats2.getUserData(), hasKey(Translog.TRANSLOG_UUID_KEY));
669             assertThat(stats2.getUserData().get(Translog.TRANSLOG_UUID_KEY),
670                        equalTo(stats1.getUserData().get(Translog.TRANSLOG_UUID_KEY)));
671             assertThat(Long.parseLong(stats2.getUserData().get(SequenceNumbers.LOCAL_CHECKPOINT_KEY)), equalTo(localCheckpoint.get()));
672             assertThat(stats2.getUserData(), hasKey(SequenceNumbers.MAX_SEQ_NO));
673             assertThat(Long.parseLong(stats2.getUserData</B></FONT>().get(SequenceNumbers.MAX_SEQ_NO)), equalTo(maxSeqNo.get()));
674         }
675     }
676     @Test
677     public void testFlushIsDisabledDuringTranslogRecovery() throws IOException {
678         engine.ensureCanFlush();         ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(), SOURCE, null);
679         engine.index(indexForDoc(doc));
680         engine.close();
681         engine = new InternalEngine(engine.config());
682         expectThrows(IllegalStateException.class, engine::ensureCanFlush);
683         expectThrows(IllegalStateException.class, () -&gt; engine.flush(true, true));
684         if (randomBoolean()) {
685             engine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
686         } else {
687             engine.skipTranslogRecovery();
688         }
689 <A NAME="88"></A>        engine.ensureCanFlush(); 
690         doc = testParsedDocument(&quot;2&quot;, null, testDocumentWithTextField(), SOURCE, null);
691         <FONT color="#3ea99f"><div style="position:absolute;left:0"><A
692                 HREF="javascript:ZweiFrames('match306914-0.html#88',2,'match306914-top.html#88',1)"><IMG SRC="back.gif"
693                                                                                                          ALT="other"
694                                                                                                          BORDER="0"
695                                                                                                          ALIGN="left"></A></div><B>engine.index(indexForDoc(doc));
696         engine.flush();
697     }
698     @Test
699     public void testTranslogMultipleOperationsSameDocument() throws IOException {
700         final int ops = randomIntBetween</B></FONT>(1, 32);
701         Engine initialEngine;
702         final List&lt;Engine.Operation&gt; operations = new ArrayList&lt;&gt;();
703         try {
704             initialEngine = engine;
705             for (int i = 0; i &lt; ops; i++) {
706                 final ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(), SOURCE, null);
707                 if (randomBoolean()) {
708                         final Engine.Index operation = new Engine.Index(
709                             newUid(doc),
710                             doc,
711                             UNASSIGNED_SEQ_NO,
712                             0,
713                             i,
714                             VersionType.EXTERNAL,
715                             Engine.Operation.Origin.PRIMARY,
716                             System.nanoTime(),
717                             -1,
718                             false,
719                             UNASSIGNED_SEQ_NO,
720                             0
721                         );
722                     operations.add(operation);
723                     initialEngine.index(operation);
724                 } else {
725                     final Engine.Delete operation = new Engine.Delete(
726                         &quot;1&quot;,
727                         newUid(doc),
728                         UNASSIGNED_SEQ_NO,
729                         0,
730                         i,
731                         VersionType.EXTERNAL,
732                         Engine.Operation.Origin.PRIMARY,
733                         System.nanoTime(),
734                         UNASSIGNED_SEQ_NO,
735                         0
736                     );
737                     operations.add(operation);
738                     initialEngine.delete(operation);
739                 }
740             }
741         } finally {
742             IOUtils.close(engine);
743         }
744         try (Engine recoveringEngine = new InternalEngine(engine.config())) {
745             recoveringEngine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
746             recoveringEngine.refresh(&quot;test&quot;);
747             try (Engine.Searcher searcher = recoveringEngine.acquireSearcher(&quot;test&quot;)) {
748                 final TotalHitCountCollector collector = new TotalHitCountCollector();
749                 searcher.search(new MatchAllDocsQuery(), collector);
750                 assertThat(collector.getTotalHits(), equalTo(operations.get(operations.size() - 1) instanceof Engine.Delete ? 0 : 1));
751             }
752         }
753     }
754     @Test
755     public void testTranslogRecoveryDoesNotReplayIntoTranslog() throws IOException {
756         final int docs = randomIntBetween(1, 32);
757         Engine initialEngine = null;
758         try {
759             initialEngine = engine;
760             for (int i = 0; i &lt; docs; i++) {
761                 final String id = Integer.toString(i);
762                 final ParsedDocument doc = testParsedDocument(id, null, testDocumentWithTextField(), SOURCE, null);
763                 initialEngine.index(indexForDoc(doc));
764             }
765         } finally {
766             IOUtils.close(initialEngine);
767         }
768         Engine recoveringEngine = null;
769         try {
770             final AtomicBoolean committed = new AtomicBoolean();
771             recoveringEngine = new InternalEngine(initialEngine.config()) {
772                 @Override
773                 protected void commitIndexWriter(IndexWriter writer, Translog translog, String syncId) throws IOException {
774                     committed.set(true);
775                     super.commitIndexWriter(writer, translog, syncId);
776                 }
777             };
778             recoveringEngine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
779             assertTrue(committed.get());
780 <A NAME="60"></A>        } finally {
781             IOUtils.close(recoveringEngine);
782         }
783     <FONT color="#53858b"><div style="position:absolute;left:0"><A
784             HREF="javascript:ZweiFrames('match306914-0.html#60',2,'match306914-top.html#60',1)"><IMG SRC="back.gif"
785                                                                                                      ALT="other"
786                                                                                                      BORDER="0"
787                                                                                                      ALIGN="left"></A></div><B>}
788     @Test
789     public void testTranslogRecoveryWithMultipleGenerations() throws IOException {
790         final int docs = randomIntBetween(1, 4096);
791         final List&lt;Long&gt; seqNos = LongStream.range(0, docs).boxed().collect(Collectors.toList());
792         Randomness.shuffle</B></FONT>(seqNos);
793         Engine initialEngine = null;
794         Engine recoveringEngine = null;
795         Store store = createStore();
796         final AtomicInteger counter = new AtomicInteger();
797         try {
798             initialEngine = createEngine(
799                 store,
800                 createTempDir(),
801                 LocalCheckpointTracker::new,
802                 (engine, operation) -&gt; seqNos.get(counter.getAndIncrement()));
803             for (int i = 0; i &lt; docs; i++) {
804                 final String id = Integer.toString(i);
805                 final ParsedDocument doc = testParsedDocument(id, null, testDocumentWithTextField(), SOURCE, null);
806                 initialEngine.index(indexForDoc(doc));
807                 if (rarely()) {
808                     getTranslog(initialEngine).rollGeneration();
809                 } else if (rarely()) {
810                     initialEngine.flush();
811                 }
812             }
813             initialEngine.close();
814             recoveringEngine = new InternalEngine(initialEngine.config());
815             recoveringEngine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
816             recoveringEngine.refresh(&quot;test&quot;);
817             try (Engine.Searcher searcher = recoveringEngine.acquireSearcher(&quot;test&quot;)) {
818                 TopDocs topDocs = searcher.search(new MatchAllDocsQuery(), docs);
819                 assertEquals(docs, topDocs.totalHits.value);
820             }
821         } finally {
822             IOUtils.close(initialEngine, recoveringEngine, store);
823         }
824     }
825     @Test
826     public void testRecoveryFromTranslogUpToSeqNo() throws IOException {
827         final AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
828         try (Store store = createStore()) {
829             EngineConfig config = config(defaultSettings, store, createTempDir(), newMergePolicy(),
830                                          null, null, globalCheckpoint::get);
831             final long maxSeqNo;
832             try (InternalEngine engine = createEngine(config)) {
833                 final int docs = randomIntBetween(1, 100);
834                 for (int i = 0; i &lt; docs; i++) {
835                     final String id = Integer.toString(i);
836                     final ParsedDocument doc = testParsedDocument(id, null, testDocumentWithTextField(),
837                                                                   SOURCE, null);
838                     engine.index(indexForDoc(doc));
839                     if (rarely()) {
840                         engine.rollTranslogGeneration();
841                     } else if (rarely()) {
842                         engine.flush(randomBoolean(), true);
843                     }
844                 }
845                 maxSeqNo = engine.getLocalCheckpointTracker().getMaxSeqNo();
846                 globalCheckpoint.set(randomLongBetween(globalCheckpoint.get(), engine.getProcessedLocalCheckpoint()));
847                 engine.syncTranslog();
848             }
849             try (InternalEngine engine = new InternalEngine(config)) {
850                 engine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
851                 assertThat(engine.getProcessedLocalCheckpoint(), equalTo(maxSeqNo));
852 <A NAME="86"></A>                assertThat(engine.getLocalCheckpointTracker().getMaxSeqNo(), equalTo(maxSeqNo));
853             }
854             try (InternalEngine engine = new InternalEngine(config)) {
855                 <FONT color="#af7a82"><div style="position:absolute;left:0"><A
856                         HREF="javascript:ZweiFrames('match306914-0.html#86',2,'match306914-top.html#86',1)"><IMG
857                         SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>long upToSeqNo = randomLongBetween(globalCheckpoint.get(), maxSeqNo);
858                 engine.recoverFromTranslog(translogHandler, upToSeqNo);
859                 assertThat(engine.getProcessedLocalCheckpoint(), equalTo(upToSeqNo));
860 <A NAME="89"></A>                assertThat(engine.getLocalCheckpointTracker</B></FONT>().getMaxSeqNo(), equalTo(upToSeqNo));
861             }
862         }
863     <FONT color="#5b8daf"><div style="position:absolute;left:0"><A
864             HREF="javascript:ZweiFrames('match306914-0.html#89',2,'match306914-top.html#89',1)"><IMG SRC="back.gif"
865                                                                                                      ALT="other"
866                                                                                                      BORDER="0"
867                                                                                                      ALIGN="left"></A></div><B>}
868     @Test
869     public void testConcurrentGetAndFlush() throws Exception {
870         ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(), B_1, null);
871         engine.index(indexForDoc</B></FONT>(doc));
872         final AtomicReference&lt;Engine.GetResult&gt; latestGetResult = new AtomicReference&lt;&gt;();
873         final BiFunction&lt;String, Engine.SearcherScope, Searcher&gt; searcherFactory = engine::acquireSearcher;
874         latestGetResult.set(engine.get(newGet(doc), searcherFactory));
875         final AtomicBoolean flushFinished = new AtomicBoolean(false);
876         final CyclicBarrier barrier = new CyclicBarrier(2);
877         Thread getThread = new Thread(() -&gt; {
878             try {
879                 barrier.await();
880             } catch (InterruptedException | BrokenBarrierException e) {
881                 throw new RuntimeException(e);
882             }
883             while (flushFinished.get() == false) {
884                 Engine.GetResult previousGetResult = latestGetResult.get();
885                 if (previousGetResult != null) {
886                     previousGetResult.close();
887                 }
888                 latestGetResult.set(engine.get(newGet(doc), searcherFactory));
889                 if (latestGetResult.get().docIdAndVersion() == null) {
890                     break;
891 <A NAME="35"></A>                }
892             }
893         });
894         <FONT color="#41a317"><div style="position:absolute;left:0"><A
895                 HREF="javascript:ZweiFrames('match306914-0.html#35',2,'match306914-top.html#35',1)"><IMG SRC="back.gif"
896                                                                                                          ALT="other"
897                                                                                                          BORDER="0"
898                                                                                                          ALIGN="left"></A></div><B>getThread.start();
899         barrier.await();
900         engine.flush();
901         flushFinished.set(true);
902         getThread.join();
903         assertThat(latestGetResult.get().docIdAndVersion(), is(notNullValue()));
904         latestGetResult.get().close();
905     }
906     @Test
907     public void testSimpleOperations() throws Exception {</B></FONT>
908         engine.refresh(&quot;warm_up&quot;);
909         Engine.Searcher searchResult = engine.acquireSearcher(&quot;test&quot;);
910         MatcherAssert.assertThat(searchResult, EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(0));
911         searchResult.close();
912         final BiFunction&lt;String, Engine.SearcherScope, Searcher&gt; searcherFactory = engine::acquireSearcher;
913         Document document = testDocumentWithTextField();
914         document.add(new Field(SourceFieldMapper.NAME, BytesReference.toBytes(B_1), SourceFieldMapper.Defaults.FIELD_TYPE));
915         ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, document, B_1, null);
916         engine.index(indexForDoc(doc));
917         searchResult = engine.acquireSearcher(&quot;test&quot;);
918         MatcherAssert.assertThat(searchResult, EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(0));
919         MatcherAssert.assertThat(searchResult,
920                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term(&quot;value&quot;, &quot;test&quot;)), 0));
921         searchResult.close();
922         try (Engine.GetResult getResult = engine.get(newGet(doc), searcherFactory)) {
923             assertThat(getResult.docIdAndVersion(), is(notNullValue()));
924         }
925         engine.refresh(&quot;test&quot;);
926         searchResult = engine.acquireSearcher(&quot;test&quot;);
927         MatcherAssert.assertThat(searchResult, EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(1));
928         MatcherAssert.assertThat(searchResult,
929                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term(&quot;value&quot;, &quot;test&quot;)), 1));
930         searchResult.close();
931         document = testDocument();
932         document.add(new TextField(&quot;value&quot;, &quot;test1&quot;, Field.Store.YES));
933         document.add(new Field(SourceFieldMapper.NAME, BytesReference.toBytes(B_2), SourceFieldMapper.Defaults.FIELD_TYPE));
934         doc = testParsedDocument(&quot;1&quot;, null, document, B_2, null);
935 <A NAME="100"></A>        engine.index(indexForDoc(doc));
936         searchResult = <FONT color="#c22817"><div style="position:absolute;left:0"><A
937                 HREF="javascript:ZweiFrames('match306914-0.html#100',2,'match306914-top.html#100',1)"><IMG
938                 SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>engine.acquireSearcher(&quot;test&quot;);
939         MatcherAssert.assertThat(searchResult, EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(1));
940         MatcherAssert.assertThat(searchResult,
941                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term(&quot;value&quot;, &quot;test&quot;)), 1));
942         MatcherAssert.assertThat(searchResult,
943                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits</B></FONT>(new TermQuery(new Term(&quot;value&quot;, &quot;test1&quot;)), 0));
944         searchResult.close();
945         try (Engine.GetResult getResult = engine.get(newGet(doc), searcherFactory)) {
946             assertThat(getResult.docIdAndVersion(), is(notNullValue()));
947         }
948         engine.refresh(&quot;test&quot;);
949         searchResult = engine.acquireSearcher(&quot;test&quot;);
950         MatcherAssert.assertThat(searchResult, EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(1));
951         MatcherAssert.assertThat(searchResult,
952                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term(&quot;value&quot;, &quot;test&quot;)), 0));
953         MatcherAssert.assertThat(searchResult,
954                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term(&quot;value&quot;, &quot;test1&quot;)), 1));
955         searchResult.close();
956         engine.delete(new Engine.Delete(
957             &quot;1&quot;,
958             newUid(doc),
959             UNASSIGNED_SEQ_NO,
960             primaryTerm.get(),
961             Versions.MATCH_ANY,
962             VersionType.INTERNAL,
963             Engine.Operation.Origin.PRIMARY,
964             System.nanoTime(),
965             UNASSIGNED_SEQ_NO,
966             0
967         ));
968         searchResult = engine.acquireSearcher(&quot;test&quot;);
969         MatcherAssert.assertThat(searchResult, EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(1));
970         MatcherAssert.assertThat(searchResult,
971                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term(&quot;value&quot;, &quot;test&quot;)), 0));
972         MatcherAssert.assertThat(searchResult,
973                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term(&quot;value&quot;, &quot;test1&quot;)), 1));
974         searchResult.close();
975         try (Engine.GetResult getResult = engine.get(newGet(doc), searcherFactory)) {
976             assertThat(getResult.docIdAndVersion(), is(nullValue()));
977         }
978         engine.refresh(&quot;test&quot;);
979         searchResult = engine.acquireSearcher(&quot;test&quot;);
980         MatcherAssert.assertThat(searchResult, EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(0));
981         MatcherAssert.assertThat(searchResult,
982                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term(&quot;value&quot;, &quot;test&quot;)), 0));
983         MatcherAssert.assertThat(searchResult,
984                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term(&quot;value&quot;, &quot;test1&quot;)), 0));
985         searchResult.close();
986         document = testDocumentWithTextField();
987         document.add(new Field(SourceFieldMapper.NAME, BytesReference.toBytes(B_1), SourceFieldMapper.Defaults.FIELD_TYPE));
988         doc = testParsedDocument(&quot;1&quot;, null, document, B_1, null);
989         engine.index(new Engine.Index(
990             newUid(doc), doc, UNASSIGNED_SEQ_NO, primaryTerm.get(),
991             Versions.MATCH_DELETED, VersionType.INTERNAL,
992             Engine.Operation.Origin.PRIMARY, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0));
993         searchResult = engine.acquireSearcher(&quot;test&quot;);
994         MatcherAssert.assertThat(searchResult, EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(0));
995         MatcherAssert.assertThat(searchResult,
996                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term(&quot;value&quot;, &quot;test&quot;)), 0));
997         MatcherAssert.assertThat(searchResult,
998                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term(&quot;value&quot;, &quot;test1&quot;)), 0));
999         searchResult.close();
1000         engine.refresh(&quot;test&quot;);
1001         searchResult = engine.acquireSearcher(&quot;test&quot;);
1002         MatcherAssert.assertThat(searchResult, EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(1));
1003         MatcherAssert.assertThat(searchResult,
1004                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term(&quot;value&quot;, &quot;test&quot;)), 1));
1005         MatcherAssert.assertThat(searchResult,
1006                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term(&quot;value&quot;, &quot;test1&quot;)), 0));
1007         searchResult.close();
1008         engine.flush();
1009         try (Engine.GetResult getResult = engine.get(newGet(doc), searcherFactory)) {
1010             assertThat(getResult.docIdAndVersion(), is(notNullValue()));
1011         }
1012         document = testDocument();
1013         document.add(new TextField(&quot;value&quot;, &quot;test1&quot;, Field.Store.YES));
1014         doc = testParsedDocument(&quot;1&quot;, null, document, B_1, null);
1015         engine.index(indexForDoc(doc));
1016         searchResult = engine.acquireSearcher(&quot;test&quot;);
1017         MatcherAssert.assertThat(searchResult, EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(1));
1018         MatcherAssert.assertThat(searchResult,
1019                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term(&quot;value&quot;, &quot;test&quot;)), 1));
1020         MatcherAssert.assertThat(searchResult,
1021                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term(&quot;value&quot;, &quot;test1&quot;)), 0));
1022         searchResult.close();
1023         engine.refresh(&quot;test&quot;);
1024         searchResult = engine.acquireSearcher(&quot;test&quot;);
1025         MatcherAssert.assertThat(searchResult, EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(1));
1026         MatcherAssert.assertThat(searchResult,
1027                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term(&quot;value&quot;, &quot;test&quot;)), 0));
1028         MatcherAssert.assertThat(searchResult,
1029                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term(&quot;value&quot;, &quot;test1&quot;)), 1));
1030         searchResult.close();
1031     }
1032     public void testSearchResultRelease() throws Exception {
1033         engine.refresh(&quot;warm_up&quot;);
1034         Engine.Searcher searchResult = engine.acquireSearcher(&quot;test&quot;);
1035         MatcherAssert.assertThat(searchResult, EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(0));
1036         searchResult.close();
1037         ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(), B_1, null);
1038         engine.index(indexForDoc(doc));
1039         searchResult = engine.acquireSearcher(&quot;test&quot;);
1040         MatcherAssert.assertThat(searchResult, EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(0));
1041         MatcherAssert.assertThat(searchResult,
1042                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term(&quot;value&quot;, &quot;test&quot;)), 0));
1043         searchResult.close();
1044         engine.refresh(&quot;test&quot;);
1045         searchResult = engine.acquireSearcher(&quot;test&quot;);
1046         MatcherAssert.assertThat(searchResult, EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(1));
1047         MatcherAssert.assertThat(searchResult,
1048                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term(&quot;value&quot;, &quot;test&quot;)), 1));
1049         engine.delete(new Engine.Delete(
1050             &quot;1&quot;,
1051             newUid(doc),
1052             UNASSIGNED_SEQ_NO,
1053             primaryTerm.get(),
1054             Versions.MATCH_ANY,
1055             VersionType.INTERNAL,
1056             Engine.Operation.Origin.PRIMARY,
1057             System.nanoTime(),
1058 <A NAME="81"></A>            UNASSIGNED_SEQ_NO,
1059             0
1060         ));
1061         <FONT color="#79764d"><div style="position:absolute;left:0"><A
1062                 HREF="javascript:ZweiFrames('match306914-0.html#81',2,'match306914-top.html#81',1)"><IMG SRC="back.gif"
1063                                                                                                          ALT="other"
1064                                                                                                          BORDER="0"
1065                                                                                                          ALIGN="left"></A></div><B>engine.refresh(&quot;test&quot;);
1066         Engine.Searcher updateSearchResult = engine.acquireSearcher(&quot;test&quot;);
1067         MatcherAssert.assertThat(updateSearchResult, EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(0));
1068         updateSearchResult.close();
1069         MatcherAssert.assertThat(searchResult, EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(1));
1070         MatcherAssert.assertThat(searchResult,
1071                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new</B></FONT> TermQuery(new Term(&quot;value&quot;, &quot;test&quot;)), 1));
1072         searchResult.close();
1073     }
1074     @Test
1075     public void testCommitAdvancesMinTranslogForRecovery() throws IOException {
1076         IOUtils.close(engine, store);
1077         final Path translogPath = createTempDir();
1078         store = createStore();
1079         final AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
1080         final LongSupplier globalCheckpointSupplier = () -&gt; globalCheckpoint.get();
1081         engine = createEngine(config(defaultSettings, store, translogPath, newMergePolicy(), null, null,
1082             globalCheckpointSupplier));
1083         engine.onSettingsChanged(TimeValue.MINUS_ONE, ByteSizeValue.ZERO, randomNonNegativeLong());
1084         ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(), B_1, null);
1085         engine.index(indexForDoc(doc));
1086         boolean inSync = randomBoolean();
1087         if (inSync) {
1088             engine.syncTranslog();             globalCheckpoint.set(engine.getPersistedLocalCheckpoint());
1089         }
1090         engine.flush();
1091         assertThat(engine.getTranslog().currentFileGeneration(), equalTo(3L));
1092         assertThat(engine.getTranslog().getMinFileGeneration(), equalTo(inSync ? 3L : 2L));
1093         engine.flush();
1094         assertThat(engine.getTranslog().currentFileGeneration(), equalTo(3L));
1095         assertThat(engine.getTranslog().getMinFileGeneration(), equalTo(inSync ? 3L : 2L));
1096         engine.flush(true, true);
1097 <A NAME="42"></A>        assertThat(engine.getTranslog().currentFileGeneration(), equalTo(3L));
1098         assertThat(engine.getTranslog().getMinFileGeneration(), equalTo(inSync ? 3L : 2L));
1099         <FONT color="#c57717"><div style="position:absolute;left:0"><A
1100                 HREF="javascript:ZweiFrames('match306914-0.html#42',2,'match306914-top.html#42',1)"><IMG SRC="back.gif"
1101                                                                                                          ALT="other"
1102                                                                                                          BORDER="0"
1103                                                                                                          ALIGN="left"></A></div><B>globalCheckpoint.set(engine.getPersistedLocalCheckpoint());
1104         engine.flush(true, true);
1105         assertThat(engine.getTranslog().currentFileGeneration(), equalTo(3L));
1106         assertThat(engine.getTranslog().getMinFileGeneration(), equalTo(3L));
1107     }
1108     @Test
1109 <A NAME="84"></A>    public void testSyncedFlush() throws IOException {</B></FONT>
1110         try (Store store = createStore();
1111              Engine engine = createEngine(defaultSettings, store, createTempDir(), new LogByteSizeMergePolicy(), null)) {
1112             final String syncId = <FONT color="#e77471"><div style="position:absolute;left:0"><A
1113                 HREF="javascript:ZweiFrames('match306914-0.html#84',2,'match306914-top.html#84',1)"><IMG SRC="back.gif"
1114                                                                                                          ALT="other"
1115                                                                                                          BORDER="0"
1116                                                                                                          ALIGN="left"></A></div><B>randomUnicodeOfCodepointLengthBetween(10, 20);
1117             ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(), B_1, null);
1118             engine.index(indexForDoc(doc));
1119             Engine.CommitId commitID = engine.flush();
1120             assertThat(commitID, equalTo(new</B></FONT> Engine.CommitId(store.readLastCommittedSegmentsInfo().getId())));
1121             byte[] wrongBytes = Base64.getDecoder().decode(commitID.toString());
1122             wrongBytes[0] = (byte) ~wrongBytes[0];
1123             Engine.CommitId wrongId = new Engine.CommitId(wrongBytes);
1124             assertEquals(&quot;should fail to sync flush with wrong id (but no docs)&quot;, engine.syncFlush(syncId + &quot;1&quot;, wrongId),
1125                          Engine.SyncedFlushResult.COMMIT_MISMATCH);
1126             engine.index(indexForDoc(doc));
1127             assertEquals(&quot;should fail to sync flush with right id but pending doc&quot;,
1128                          engine.syncFlush(syncId + &quot;2&quot;, commitID), Engine.SyncedFlushResult.PENDING_OPERATIONS);
1129             commitID = engine.flush();
1130             assertEquals(&quot;should succeed to flush commit with right id and no pending doc&quot;, engine.syncFlush(syncId, commitID),
1131                          Engine.SyncedFlushResult.SUCCESS);
1132             assertEquals(store.readLastCommittedSegmentsInfo().getUserData().get(Engine.SYNC_COMMIT_ID), syncId);
1133             assertEquals(engine.getLastCommittedSegmentInfos().getUserData().get(Engine.SYNC_COMMIT_ID), syncId);
1134         }
1135     }
1136     @Test
1137     public void testRenewSyncFlush() throws Exception {
1138         final int iters = randomIntBetween(2, 5);         for (int i = 0; i &lt; iters; i++) {
1139             try (Store store = createStore();
1140                  InternalEngine engine =
1141 <A NAME="53"></A>                     createEngine(config(defaultSettings, store, createTempDir(), new LogDocMergePolicy(), null))) {
1142                 final String syncId = randomUnicodeOfCodepointLengthBetween(10, 20);
1143                 Engine.Index doc1 =
1144                     indexForDoc(<FONT color="#ad5a3d"><div style="position:absolute;left:0"><A
1145                 HREF="javascript:ZweiFrames('match306914-0.html#53',2,'match306914-top.html#53',1)"><IMG SRC="back.gif"
1146                                                                                                          ALT="other"
1147                                                                                                          BORDER="0"
1148                                                                                                          ALIGN="left"></A></div><B>testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(), B_1, null));
1149                 engine.index(doc1);
1150                 assertEquals(engine.getLastWriteNanos(), doc1.startTime());
1151                 engine.flush();
1152                 Engine.Index doc2 =
1153                     indexForDoc(testParsedDocument(&quot;2&quot;, null, testDocumentWithTextField(), B_1, null));
1154                 engine.index(doc2);
1155                 assertEquals(engine.getLastWriteNanos</B></FONT>(), doc2.startTime());
1156                 engine.flush();
1157                 final boolean forceMergeFlushes = randomBoolean();
1158                 final ParsedDocument parsedDoc3 =
1159                     testParsedDocument(&quot;3&quot;, null, testDocumentWithTextField(), B_1, null);
1160                 if (forceMergeFlushes) {
1161                     engine.index(new Engine.Index(newUid(parsedDoc3), parsedDoc3, UNASSIGNED_SEQ_NO, 0,
1162                                                   Versions.MATCH_ANY, VersionType.INTERNAL, Engine.Operation.Origin.PRIMARY,
1163                                                   System.nanoTime() - engine.engineConfig.getFlushMergesAfter().nanos(),
1164                                                   -1, false, UNASSIGNED_SEQ_NO, 0));
1165                 } else {
1166                     engine.index(indexForDoc(parsedDoc3));
1167                 }
1168                 Engine.CommitId commitID = engine.flush();
1169                 assertEquals(&quot;should succeed to flush commit with right id and no pending doc&quot;, engine.syncFlush(syncId, commitID),
1170                              Engine.SyncedFlushResult.SUCCESS);
1171                 assertEquals(3, engine.segments(false).size());
1172 <A NAME="33"></A>                engine.forceMerge(forceMergeFlushes, 1, false, false, false, UUIDs.randomBase64UUID());
1173                 if (forceMergeFlushes == false) {
1174                     engine.refresh(&quot;make all segments visible&quot;);
1175                     <FONT color="#736aff"><div style="position:absolute;left:0"><A
1176                             HREF="javascript:ZweiFrames('match306914-0.html#33',2,'match306914-top.html#33',1)"><IMG
1177                             SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>assertEquals(4, engine.segments(false).size());
1178                     assertEquals(store.readLastCommittedSegmentsInfo().getUserData().get(Engine.SYNC_COMMIT_ID), syncId);
1179                     assertEquals(engine.getLastCommittedSegmentInfos().getUserData().get(Engine.SYNC_COMMIT_ID), syncId);
1180                     assertTrue(engine.tryRenewSyncCommit());
1181                     assertEquals(1, engine.segments(false).size());
1182                 }</B></FONT> else {
1183                     engine.refresh(&quot;test&quot;);
1184                     assertBusy(() -&gt; assertEquals(1, engine.segments(false).size()));
1185                 }
1186                 assertEquals(store.readLastCommittedSegmentsInfo().getUserData().get(Engine.SYNC_COMMIT_ID), syncId);
1187                 assertEquals(engine.getLastCommittedSegmentInfos().getUserData().get(Engine.SYNC_COMMIT_ID), syncId);
1188                 if (randomBoolean()) {
1189                     Engine.Index doc4 =
1190                         indexForDoc(testParsedDocument(&quot;4&quot;, null, testDocumentWithTextField(), B_1, null));
1191 <A NAME="85"></A>                    engine.index(doc4);
1192                     assertEquals(engine.getLastWriteNanos(), doc4.startTime());
1193                 } else {
1194                     Engine.Delete delete = <FONT color="#717d7d"><div style="position:absolute;left:0"><A
1195                 HREF="javascript:ZweiFrames('match306914-0.html#85',2,'match306914-top.html#85',1)"><IMG SRC="back.gif"
1196                                                                                                          ALT="other"
1197                                                                                                          BORDER="0"
1198                                                                                                          ALIGN="left"></A></div><B>new Engine.Delete(
1199                         doc1.id(),
1200                         doc1.uid(),
1201                         UNASSIGNED_SEQ_NO,
1202                         primaryTerm.get(),
1203                         Versions.MATCH_ANY,
1204                         VersionType.INTERNAL,
1205                         Engine.Operation.Origin.PRIMARY,
1206                         System.nanoTime(),
1207                         UNASSIGNED_SEQ_NO,
1208                         0
1209                     );
1210                     engine.delete(delete);
1211                     assertEquals(engine.getLastWriteNanos(), delete.startTime());
1212                 }</B></FONT>
1213                 assertFalse(engine.tryRenewSyncCommit());
1214                 engine.flush(false, true);
1215                 assertNull(store.readLastCommittedSegmentsInfo().getUserData().get(Engine.SYNC_COMMIT_ID));
1216                 assertNull(engine.getLastCommittedSegmentInfos().getUserData().get(Engine.SYNC_COMMIT_ID));
1217             }
1218         }
1219     }
1220     @Test
1221     public void testSyncedFlushSurvivesEngineRestart() throws IOException {
1222 <A NAME="106"></A>        final AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
1223         IOUtils.close(store, engine);
1224         store = createStore();
1225         engine = <FONT color="#8e35ef"><div style="position:absolute;left:0"><A
1226                 HREF="javascript:ZweiFrames('match306914-0.html#106',2,'match306914-top.html#106',1)"><IMG
1227                 SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>createEngine(store, primaryTranslogDir, globalCheckpoint::get);
1228         final String syncId = randomUnicodeOfCodepointLengthBetween(10, 20);
1229 <A NAME="61"></A>        ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(),
1230                                                 new BytesArray(&quot;{}&quot;), null);
1231         engine.index(indexForDoc</B></FONT>(doc));
1232         <FONT color="#6cc417"><div style="position:absolute;left:0"><A
1233                 HREF="javascript:ZweiFrames('match306914-0.html#61',2,'match306914-top.html#61',1)"><IMG SRC="back.gif"
1234                                                                                                          ALT="other"
1235                                                                                                          BORDER="0"
1236                                                                                                          ALIGN="left"></A></div><B>globalCheckpoint.set(0L);
1237         final Engine.CommitId commitID = engine.flush();
1238         assertEquals(&quot;should succeed to flush commit with right id and no pending doc&quot;, engine.syncFlush(syncId, commitID),
1239                      Engine.SyncedFlushResult.SUCCESS);
1240         assertEquals(store.readLastCommittedSegmentsInfo().getUserData().get(Engine.SYNC_COMMIT_ID), syncId);
1241         assertEquals(engine.getLastCommittedSegmentInfos</B></FONT>().getUserData().get(Engine.SYNC_COMMIT_ID), syncId);
1242         EngineConfig config = engine.config();
1243         if (randomBoolean()) {
1244             engine.close();
1245         } else {
1246             engine.flushAndClose();
1247         }
1248         if (randomBoolean()) {
1249             final String translogUUID = Translog.createEmptyTranslog(config.getTranslogConfig().getTranslogPath(),
1250                                                                      UNASSIGNED_SEQ_NO, shardId, primaryTerm.get());
1251             store.associateIndexWithNewTranslog(translogUUID);
1252         }
1253 <A NAME="59"></A>        engine = new InternalEngine(config);
1254         engine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
1255         assertEquals(engine.getLastCommittedSegmentInfos().getUserData().get(Engine.SYNC_COMMIT_ID), syncId);
1256     <FONT color="#980517"><div style="position:absolute;left:0"><A
1257             HREF="javascript:ZweiFrames('match306914-0.html#59',2,'match306914-top.html#59',1)"><IMG SRC="back.gif"
1258                                                                                                      ALT="other"
1259                                                                                                      BORDER="0"
1260                                                                                                      ALIGN="left"></A></div><B>}
1261     @Test
1262     public void testSyncedFlushVanishesOnReplay() throws IOException {
1263         final String syncId = randomUnicodeOfCodepointLengthBetween(10, 20);
1264         ParsedDocument doc = testParsedDocument(&quot;1&quot;, null,
1265                                                 testDocumentWithTextField(), new BytesArray(&quot;{}&quot;), null);
1266         engine.index(indexForDoc</B></FONT>(doc));
1267         final Engine.CommitId commitID = engine.flush();
1268         assertEquals(&quot;should succeed to flush commit with right id and no pending doc&quot;, engine.syncFlush(syncId, commitID),
1269                      Engine.SyncedFlushResult.SUCCESS);
1270         assertEquals(store.readLastCommittedSegmentsInfo().getUserData().get(Engine.SYNC_COMMIT_ID), syncId);
1271         assertEquals(engine.getLastCommittedSegmentInfos().getUserData().get(Engine.SYNC_COMMIT_ID), syncId);
1272         doc = testParsedDocument(&quot;2&quot;, null, testDocumentWithTextField(), new BytesArray(&quot;{}&quot;), null);
1273         engine.index(indexForDoc(doc));
1274 <A NAME="66"></A>        EngineConfig config = engine.config();
1275         engine.close();
1276         engine = new InternalEngine(config);
1277         <FONT color="#83a33a"><div style="position:absolute;left:0"><A
1278                 HREF="javascript:ZweiFrames('match306914-0.html#66',2,'match306914-top.html#66',1)"><IMG SRC="back.gif"
1279                                                                                                          ALT="other"
1280                                                                                                          BORDER="0"
1281                                                                                                          ALIGN="left"></A></div><B>engine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
1282         assertNull(&quot;Sync ID must be gone since we have a document to replay&quot;,
1283                    engine.getLastCommittedSegmentInfos().getUserData().get(Engine.SYNC_COMMIT_ID));
1284     }
1285     @Test
1286     public void testVersioningNewCreate() throws IOException {
1287         ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocument</B></FONT>(), B_1, null);
1288         Engine.Index create = new Engine.Index(
1289             newUid(doc), doc, UNASSIGNED_SEQ_NO, primaryTerm.get(),
1290             Versions.MATCH_DELETED, VersionType.INTERNAL,
1291             Engine.Operation.Origin.PRIMARY, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0);
1292         Engine.IndexResult indexResult = engine.index(create);
1293         assertThat(indexResult.getVersion(), equalTo(1L));
1294 <A NAME="73"></A>
1295         create = new Engine.Index(newUid(doc), doc, indexResult.getSeqNo(), create.primaryTerm(), indexResult.getVersion(),
1296                                   null, REPLICA, 0, -1, false, UNASSIGNED_SEQ_NO, 0);
1297         indexResult = <FONT color="#2981b2"><div style="position:absolute;left:0"><A
1298                 HREF="javascript:ZweiFrames('match306914-0.html#73',2,'match306914-top.html#73',1)"><IMG SRC="back.gif"
1299                                                                                                          ALT="other"
1300                                                                                                          BORDER="0"
1301                                                                                                          ALIGN="left"></A></div><B>replicaEngine.index(create);
1302         assertThat(indexResult.getVersion(), equalTo(1L));
1303     }
1304     @Test
1305     public void testReplicatedVersioningWithFlush() throws IOException {
1306         ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocument</B></FONT>(), B_1, null);
1307         Engine.Index create = new Engine.Index(
1308             newUid(doc), doc, UNASSIGNED_SEQ_NO, primaryTerm.get(),
1309             Versions.MATCH_DELETED, VersionType.INTERNAL,
1310             Engine.Operation.Origin.PRIMARY, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0);
1311         Engine.IndexResult indexResult = engine.index(create);
1312         assertThat(indexResult.getVersion(), equalTo(1L));
1313         assertTrue(indexResult.isCreated());
1314         create = new Engine.Index(newUid(doc), doc, indexResult.getSeqNo(), create.primaryTerm(), indexResult.getVersion(),
1315                                   null, REPLICA, 0, -1, false, UNASSIGNED_SEQ_NO, 0);
1316         indexResult = replicaEngine.index(create);
1317         assertThat(indexResult.getVersion(), equalTo(1L));
1318         assertTrue(indexResult.isCreated());
1319         if (randomBoolean()) {
1320             engine.flush();
1321         }
1322         if (randomBoolean()) {
1323             replicaEngine.flush();
1324         }
1325         Engine.Index update = new Engine.Index(
1326             newUid(doc), doc, UNASSIGNED_SEQ_NO, primaryTerm.get(),
1327             1, VersionType.INTERNAL,
1328             Engine.Operation.Origin.PRIMARY, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0);
1329         Engine.IndexResult updateResult = engine.index(update);
1330         assertThat(updateResult.getVersion(), equalTo(2L));
1331         assertFalse(updateResult.isCreated());
1332         update = new Engine.Index(newUid(doc), doc, updateResult.getSeqNo(), update.primaryTerm(), updateResult.getVersion(),
1333                                   null, REPLICA, 0, -1, false, UNASSIGNED_SEQ_NO, 0);
1334         updateResult = replicaEngine.index(update);
1335         assertThat(updateResult.getVersion(), equalTo(2L));
1336         assertFalse(updateResult.isCreated());
1337         replicaEngine.refresh(&quot;test&quot;);
1338         try (Searcher searcher = replicaEngine.acquireSearcher(&quot;test&quot;)) {
1339             assertEquals(1, searcher.getDirectoryReader().numDocs());
1340         }
1341         engine.refresh(&quot;test&quot;);
1342         try (Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
1343             assertEquals(1, searcher.getDirectoryReader().numDocs());
1344         }
1345     }
1346     @Test
1347     public void testVersionedUpdate() throws IOException {
1348         final BiFunction&lt;String, Engine.SearcherScope, Searcher&gt; searcherFactory = engine::acquireSearcher;
1349         ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocument(), B_1, null);
1350         Engine.Index create = new Engine.Index(
1351             newUid(doc), doc, UNASSIGNED_SEQ_NO, primaryTerm.get(),
1352             Versions.MATCH_DELETED, VersionType.INTERNAL,
1353             Engine.Operation.Origin.PRIMARY, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0);
1354         Engine.IndexResult indexResult = engine.index(create);
1355         assertThat(indexResult.getVersion(), equalTo(1L));
1356         try (Engine.GetResult get = engine.get(new Engine.Get(doc.id(), create.uid()), searcherFactory)) {
1357             assertEquals(1, get.docIdAndVersion().version);
1358         }
1359         Engine.Index update_1 = new Engine.Index(
1360             newUid(doc), doc, UNASSIGNED_SEQ_NO, primaryTerm.get(),
1361             1, VersionType.INTERNAL,
1362             Engine.Operation.Origin.PRIMARY, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0);
1363         Engine.IndexResult update_1_result = engine.index(update_1);
1364         assertThat(update_1_result.getVersion(), equalTo(2L));
1365         try (Engine.GetResult get = engine.get(new Engine.Get(doc.id(), create.uid()), searcherFactory)) {
1366             assertEquals(2, get.docIdAndVersion().version);
1367         }
1368         Engine.Index update_2 = new Engine.Index(
1369             newUid(doc), doc, UNASSIGNED_SEQ_NO, primaryTerm.get(),
1370             2, VersionType.INTERNAL,
1371             Engine.Operation.Origin.PRIMARY, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0);
1372         Engine.IndexResult update_2_result = engine.index(update_2);
1373         assertThat(update_2_result.getVersion(), equalTo(3L));
1374         try (Engine.GetResult get = engine.get(new Engine.Get(doc.id(), create.uid()), searcherFactory)) {
1375             assertEquals(3, get.docIdAndVersion().version);
1376         }
1377     }
1378     @Test
1379     public void testVersioningNewIndex() throws IOException {
1380         ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocument(), B_1, null);
1381         Engine.Index index = indexForDoc(doc);
1382         Engine.IndexResult indexResult = engine.index(index);
1383         assertThat(indexResult.getVersion(), equalTo(1L));
1384         index = new Engine.Index(newUid(doc), doc, indexResult.getSeqNo(), index.primaryTerm(), indexResult.getVersion(),
1385                                  null, REPLICA, 0, -1, false, UNASSIGNED_SEQ_NO, 0);
1386         indexResult = replicaEngine.index(index);
1387         assertThat(indexResult.getVersion(), equalTo(1L));
1388     }
1389     @Test
1390     public void testLookupVersionWithPrunedAwayIds() throws IOException {
1391         try (Directory dir = newDirectory()) {
1392             IndexWriterConfig indexWriterConfig = new IndexWriterConfig(Lucene.STANDARD_ANALYZER);
1393             indexWriterConfig.setSoftDeletesField(Lucene.SOFT_DELETES_FIELD);
1394             try (IndexWriter writer = new IndexWriter(dir,
1395                                                       indexWriterConfig.setMergePolicy(new SoftDeletesRetentionMergePolicy(Lucene.SOFT_DELETES_FIELD,
1396                                                                                                                            MatchAllDocsQuery::new, new PrunePostingsMergePolicy(indexWriterConfig.getMergePolicy(), &quot;_id&quot;))))) {
1397                 org.apache.lucene.document.Document doc = new org.apache.lucene.document.Document();
1398                 doc.add(new Field(IdFieldMapper.NAME, &quot;1&quot;, IdFieldMapper.Defaults.FIELD_TYPE));
1399                 doc.add(new NumericDocValuesField(VersionFieldMapper.NAME, -1));
1400                 doc.add(new NumericDocValuesField(SeqNoFieldMapper.NAME, 1));
1401                 doc.add(new NumericDocValuesField(SeqNoFieldMapper.PRIMARY_TERM_NAME, 1));
1402                 writer.addDocument(doc);
1403                 writer.flush();
1404                 writer.softUpdateDocument(new Term(IdFieldMapper.NAME, &quot;1&quot;), doc, new NumericDocValuesField(Lucene.SOFT_DELETES_FIELD, 1));
1405                 writer.updateNumericDocValue(new Term(IdFieldMapper.NAME, &quot;1&quot;), Lucene.SOFT_DELETES_FIELD, 1);
1406                 writer.forceMerge(1);
1407                 try (DirectoryReader reader = DirectoryReader.open(writer)) {
1408                     assertEquals(1, reader.leaves().size());
1409                     assertNull(VersionsAndSeqNoResolver.loadDocIdAndVersion(reader, new Term(IdFieldMapper.NAME, &quot;1&quot;), false));
1410 <A NAME="67"></A>                }
1411             }
1412         }
1413     <FONT color="#ad5910"><div style="position:absolute;left:0"><A
1414             HREF="javascript:ZweiFrames('match306914-0.html#67',2,'match306914-top.html#67',1)"><IMG SRC="back.gif"
1415                                                                                                      ALT="other"
1416                                                                                                      BORDER="0"
1417                                                                                                      ALIGN="left"></A></div><B>}
1418     @Test
1419     public void testUpdateWithFullyDeletedSegments() throws IOException {
1420         Settings.Builder settings = Settings.builder()
1421             .put(defaultSettings.getSettings())
1422             .put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), true)
1423             .put(IndexSettings.INDEX_SOFT_DELETES_RETENTION_OPERATIONS_SETTING.getKey</B></FONT>(), Integer.MAX_VALUE);
1424         final IndexMetadata indexMetadata = IndexMetadata.builder(defaultSettings.getIndexMetadata()).settings(settings).build();
1425         final IndexSettings indexSettings = IndexSettingsModule.newIndexSettings(indexMetadata);
1426         final AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
1427         final Set&lt;String&gt; liveDocs = new HashSet&lt;&gt;();
1428         try (Store store = createStore();
1429              InternalEngine engine = createEngine(config(indexSettings, store, createTempDir(), newMergePolicy(), null,
1430                                                          null, globalCheckpoint::get))) {
1431             int numDocs = scaledRandomIntBetween(10, 100);
1432             for (int i = 0; i &lt; numDocs; i++) {
1433                 ParsedDocument doc = testParsedDocument(Integer.toString(i), null, testDocument(), B_1, null);
1434                 engine.index(indexForDoc(doc));
1435                 liveDocs.add(doc.id());
1436             }
1437             for (int i = 0; i &lt; numDocs; i++) {
1438                 ParsedDocument doc = testParsedDocument(Integer.toString(i), null, testDocument(), B_1, null);
1439                 engine.index(indexForDoc(doc));
1440 <A NAME="52"></A>                liveDocs.add(doc.id());
1441             }
1442         }
1443     <FONT color="#2b60de"><div style="position:absolute;left:0"><A
1444             HREF="javascript:ZweiFrames('match306914-0.html#52',2,'match306914-top.html#52',1)"><IMG SRC="back.gif"
1445                                                                                                      ALT="other"
1446                                                                                                      BORDER="0"
1447                                                                                                      ALIGN="left"></A></div><B>}
1448     @Test
1449     public void testForceMergeWithSoftDeletesRetention() throws Exception {
1450         final long retainedExtraOps = randomLongBetween(0, 10);
1451         Settings.Builder settings = Settings.builder()
1452             .put(defaultSettings.getSettings())
1453             .put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey</B></FONT>(), true)
1454             .put(IndexSettings.INDEX_SOFT_DELETES_RETENTION_OPERATIONS_SETTING.getKey(), retainedExtraOps);
1455         final IndexMetadata indexMetadata = IndexMetadata.builder(defaultSettings.getIndexMetadata()).settings(settings).build();
1456         final IndexSettings indexSettings = IndexSettingsModule.newIndexSettings(indexMetadata);
1457         final AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
1458         final MapperService mapperService = createMapperService(&quot;test&quot;);
1459         final Set&lt;String&gt; liveDocs = new HashSet&lt;&gt;();
1460         try (Store store = createStore();
1461              InternalEngine engine = createEngine(config(indexSettings, store, createTempDir(), newMergePolicy(), null,
1462                                                          null, globalCheckpoint::get))) {
1463             int numDocs = scaledRandomIntBetween(10, 100);
1464             for (int i = 0; i &lt; numDocs; i++) {
1465                 ParsedDocument doc = testParsedDocument(Integer.toString(i), null, testDocument(), B_1, null);
1466                 engine.index(indexForDoc(doc));
1467                 liveDocs.add(doc.id());
1468             }
1469             for (int i = 0; i &lt; numDocs; i++) {
1470                 ParsedDocument doc = testParsedDocument(Integer.toString(i), null, testDocument(), B_1, null);
1471                 if (randomBoolean()) {
1472                     engine.delete(new Engine.Delete(doc.id(), newUid(doc.id()), primaryTerm.get()));
1473                     liveDocs.remove(doc.id());
1474                 }
1475                 if (randomBoolean()) {
1476                     engine.index(indexForDoc(doc));
1477                     liveDocs.add(doc.id());
1478                 }
1479                 if (randomBoolean()) {
1480                     engine.flush(randomBoolean(), true);
1481                 }
1482             }
1483             engine.flush();
1484             long localCheckpoint = engine.getProcessedLocalCheckpoint();
1485             globalCheckpoint.set(randomLongBetween(0, localCheckpoint));
1486             engine.syncTranslog();
1487             final long safeCommitCheckpoint;
1488             try (Engine.IndexCommitRef safeCommit = engine.acquireSafeIndexCommit()) {
1489                 safeCommitCheckpoint = Long.parseLong(safeCommit.getIndexCommit().getUserData().get(SequenceNumbers.LOCAL_CHECKPOINT_KEY));
1490             }
1491             engine.forceMerge(true, 1, false, false, false, UUIDs.randomBase64UUID());
1492             assertConsistentHistoryBetweenTranslogAndLuceneIndex(engine, mapperService);
1493             Map&lt;Long, Translog.Operation&gt; ops = readAllOperationsInLucene(engine, mapperService)
1494                 .stream().collect(Collectors.toMap(Translog.Operation::seqNo, Function.identity()));
1495             for (long seqno = 0; seqno &lt;= localCheckpoint; seqno++) {
1496                 long minSeqNoToRetain = Math.min(globalCheckpoint.get() + 1 - retainedExtraOps,
1497                                                  safeCommitCheckpoint + 1);
1498                 String msg = &quot;seq# [&quot; + seqno + &quot;], global checkpoint [&quot; + globalCheckpoint + &quot;], retained-ops [&quot; +
1499                              retainedExtraOps + &quot;]&quot;;
1500                 if (seqno &lt; minSeqNoToRetain) {
1501                     Translog.Operation op = ops.get(seqno);
1502                     if (op != null) {
1503                         assertThat(op, instanceOf(Translog.Index.class));
1504                         assertThat(msg, ((Translog.Index) op).id(), isIn(liveDocs));
1505                         assertEquals(msg, ((Translog.Index) op).source(), B_1);
1506                     }
1507                 } else {
1508 <A NAME="21"></A>                    assertThat(msg, ops.get(seqno), notNullValue());
1509                 }
1510             }
1511             settings.put(<FONT color="#947010"><div style="position:absolute;left:0"><A
1512                 HREF="javascript:ZweiFrames('match306914-0.html#21',2,'match306914-top.html#21',1)"><IMG SRC="back.gif"
1513                                                                                                          ALT="other"
1514                                                                                                          BORDER="0"
1515                                                                                                          ALIGN="left"></A></div><B>IndexSettings.INDEX_SOFT_DELETES_RETENTION_OPERATIONS_SETTING.getKey(), 0);
1516             indexSettings.updateIndexMetadata(IndexMetadata.builder(defaultSettings.getIndexMetadata()).settings(
1517                 settings).build());
1518             engine.onSettingsChanged(indexSettings.getTranslogRetentionAge(), indexSettings.getTranslogRetentionSize(),
1519                                      indexSettings.getSoftDeleteRetentionOperations());
1520             globalCheckpoint.set(localCheckpoint);
1521             engine.syncTranslog();
1522             engine.forceMerge(true, 1, false, false, false, UUIDs.randomBase64UUID());
1523 <A NAME="78"></A>            assertConsistentHistoryBetweenTranslogAndLuceneIndex(engine, mapperService);
1524             assertThat(readAllOperationsInLucene(engine, mapperService), hasSize(liveDocs.size()));
1525         }</B></FONT>
1526     <FONT color="#947010"><div style="position:absolute;left:0"><A
1527             HREF="javascript:ZweiFrames('match306914-0.html#78',2,'match306914-top.html#78',1)"><IMG SRC="back.gif"
1528                                                                                                      ALT="other"
1529                                                                                                      BORDER="0"
1530                                                                                                      ALIGN="left"></A></div><B>}
1531     @Test
1532     public void testForceMergeWithSoftDeletesRetentionAndRecoverySource() throws Exception {
1533         final long retainedExtraOps = randomLongBetween(0, 10);
1534         Settings.Builder settings = Settings.builder()</B></FONT>
1535             .put(defaultSettings.getSettings())
1536             .put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), true)
1537             .put(IndexSettings.INDEX_SOFT_DELETES_RETENTION_OPERATIONS_SETTING.getKey(), retainedExtraOps);
1538         final IndexMetadata indexMetadata = IndexMetadata.builder(defaultSettings.getIndexMetadata()).settings(settings).build();
1539         final IndexSettings indexSettings = IndexSettingsModule.newIndexSettings(indexMetadata);
1540         final AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
1541         final MapperService mapperService = createMapperService(&quot;test&quot;);
1542         final boolean omitSourceAllTheTime = randomBoolean();
1543         final Set&lt;String&gt; liveDocs = new HashSet&lt;&gt;();
1544         final Set&lt;String&gt; liveDocsWithSource = new HashSet&lt;&gt;();
1545         try (Store store = createStore();
1546              InternalEngine engine = createEngine(config(indexSettings, store, createTempDir(), newMergePolicy(), null,
1547                                                          null,
1548                                                          globalCheckpoint::get))) {
1549             int numDocs = scaledRandomIntBetween(10, 100);
1550             for (int i = 0; i &lt; numDocs; i++) {
1551                 boolean useRecoverySource = randomBoolean() || omitSourceAllTheTime;
1552                 ParsedDocument doc = testParsedDocument(Integer.toString(i), null, testDocument(), B_1, null,
1553                                                         useRecoverySource);
1554                 engine.index(indexForDoc(doc));
1555                 liveDocs.add(doc.id());
1556                 if (useRecoverySource == false) {
1557                     liveDocsWithSource.add(Integer.toString(i));
1558                 }
1559             }
1560             for (int i = 0; i &lt; numDocs; i++) {
1561                 boolean useRecoverySource = randomBoolean() || omitSourceAllTheTime;
1562                 ParsedDocument doc = testParsedDocument(Integer.toString(i), null, testDocument(), B_1, null,
1563                                                         useRecoverySource);
1564                 if (randomBoolean()) {
1565                     engine.delete(new Engine.Delete(doc.id(), newUid(doc.id()), primaryTerm.get()));
1566                     liveDocs.remove(doc.id());
1567                     liveDocsWithSource.remove(doc.id());
1568                 }
1569                 if (randomBoolean()) {
1570                     engine.index(indexForDoc(doc));
1571                     liveDocs.add(doc.id());
1572                     if (useRecoverySource == false) {
1573                         liveDocsWithSource.add(doc.id());
1574                     } else {
1575                         liveDocsWithSource.remove(doc.id());
1576                     }
1577                 }
1578                 if (randomBoolean()) {
1579                     engine.flush(randomBoolean(), true);
1580                 }
1581             }
1582             engine.flush();
1583             globalCheckpoint.set(randomLongBetween(0, engine.getPersistedLocalCheckpoint()));
1584             engine.syncTranslog();
1585             final long minSeqNoToRetain;
1586             try (Engine.IndexCommitRef safeCommit = engine.acquireSafeIndexCommit()) {
1587                 long safeCommitLocalCheckpoint = Long.parseLong(
1588                     safeCommit.getIndexCommit().getUserData().get(SequenceNumbers.LOCAL_CHECKPOINT_KEY));
1589                 minSeqNoToRetain = Math.min(globalCheckpoint.get() + 1 - retainedExtraOps,
1590                                             safeCommitLocalCheckpoint + 1);
1591             }
1592             engine.forceMerge(true, 1, false, false, false, UUIDs.randomBase64UUID());
1593             assertConsistentHistoryBetweenTranslogAndLuceneIndex(engine, mapperService);
1594             Map&lt;Long, Translog.Operation&gt; ops = readAllOperationsInLucene(engine, mapperService)
1595                 .stream().collect(Collectors.toMap(Translog.Operation::seqNo, Function.identity()));
1596             for (long seqno = 0; seqno &lt;= engine.getPersistedLocalCheckpoint(); seqno++) {
1597                 String msg = &quot;seq# [&quot; + seqno + &quot;], global checkpoint [&quot; + globalCheckpoint + &quot;], retained-ops [&quot; +
1598                              retainedExtraOps + &quot;]&quot;;
1599                 if (seqno &lt; minSeqNoToRetain) {
1600                     Translog.Operation op = ops.get(seqno);
1601                     if (op != null) {
1602                         assertThat(op, instanceOf(Translog.Index.class));
1603                         assertThat(msg, ((Translog.Index) op).id(), isIn(liveDocs));
1604                     }
1605                 } else {
1606                     Translog.Operation op = ops.get(seqno);
1607                     assertThat(msg, op, notNullValue());
1608                     if (op instanceof Translog.Index) {
1609                         assertEquals(msg, ((Translog.Index) op).source(), B_1);
1610                     }
1611                 }
1612             }
1613             settings.put(IndexSettings.INDEX_SOFT_DELETES_RETENTION_OPERATIONS_SETTING.getKey(), 0);
1614             indexSettings.updateIndexMetadata(IndexMetadata.builder(defaultSettings.getIndexMetadata()).settings(
1615                 settings).build());
1616             engine.onSettingsChanged(indexSettings.getTranslogRetentionAge(), indexSettings.getTranslogRetentionSize(),
1617                                      indexSettings.getSoftDeleteRetentionOperations());
1618             final int numSegments;
1619             try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.INTERNAL)) {
1620                 numSegments = searcher.getDirectoryReader().leaves().size();
1621             }
1622             if (numSegments == 1) {
1623                 boolean useRecoverySource = randomBoolean() || omitSourceAllTheTime;
1624                 ParsedDocument doc = testParsedDocument(&quot;dummy&quot;, null, testDocument(), B_1, null, useRecoverySource);
1625                 engine.index(indexForDoc(doc));
1626                 if (useRecoverySource == false) {
1627                     liveDocsWithSource.add(doc.id());
1628                 }
1629                 engine.syncTranslog();
1630                 globalCheckpoint.set(engine.getPersistedLocalCheckpoint());
1631                 engine.flush(randomBoolean(), true);
1632             } else {
1633                 globalCheckpoint.set(engine.getPersistedLocalCheckpoint());
1634                 engine.syncTranslog();
1635             }
1636             engine.forceMerge(true, 1, false, false, false, UUIDs.randomBase64UUID());
1637             assertConsistentHistoryBetweenTranslogAndLuceneIndex(engine, mapperService);
1638             assertThat(readAllOperationsInLucene(engine, mapperService), hasSize(liveDocsWithSource.size()));
1639         }
1640     }
1641     @Test
1642     public void testForceMergeAndClose() throws IOException, InterruptedException {
1643         int numIters = randomIntBetween(2, 10);
1644         for (int j = 0; j &lt; numIters; j++) {
1645             try (Store store = createStore()) {
1646                 final InternalEngine engine = createEngine(store, createTempDir());
1647                 final CountDownLatch startGun = new CountDownLatch(1);
1648                 final CountDownLatch indexed = new CountDownLatch(1);
1649                 Thread thread = new Thread() {
1650                     @Override
1651                     public void run() {
1652                         try {
1653                             try {
1654                                 startGun.await();
1655                             } catch (InterruptedException e) {
1656                                 throw new RuntimeException(e);
1657                             }
1658                             int i = 0;
1659                             while (true) {
1660                                 int numDocs = randomIntBetween(1, 20);
1661                                 for (int j = 0; j &lt; numDocs; j++) {
1662                                     i++;
1663                                     ParsedDocument doc = testParsedDocument(Integer.toString(i), null, testDocument(), B_1,
1664                                                                             null);
1665                                     Engine.Index index = indexForDoc(doc);
1666                                     engine.index(index);
1667                                 }
1668                                 engine.refresh(&quot;test&quot;);
1669                                 indexed.countDown();
1670                                 try {
1671                                     engine.forceMerge(
1672                                         randomBoolean(),
1673                                         1,
1674                                         false,
1675                                         randomBoolean(),
1676                                         randomBoolean(),
1677                                         UUIDs.randomBase64UUID()
1678                                     );
1679                                 } catch (IOException e) {
1680                                     return;
1681                                 }
1682                             }
1683                         } catch (AlreadyClosedException ex) {
1684                         } catch (IOException e) {
1685                             throw new AssertionError(e);
1686                         }
1687                     }
1688                 };
1689                 thread.start();
1690                 startGun.countDown();
1691                 int someIters = randomIntBetween(1, 10);
1692                 for (int i = 0; i &lt; someIters; i++) {
1693                     engine.forceMerge(randomBoolean(), 1, false, randomBoolean(), randomBoolean(), UUIDs.randomBase64UUID());
1694                 }
1695                 indexed.await();
1696                 IOUtils.close(engine);
1697                 thread.join();
1698             }
1699         }
1700     }
1701     @Test
1702     public void testVersioningCreateExistsException() throws IOException {
1703         ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocument(), B_1, null);
1704         Engine.Index create = new Engine.Index(newUid(doc), doc, UNASSIGNED_SEQ_NO, 1,
1705                                                Versions.MATCH_DELETED, VersionType.INTERNAL, PRIMARY, 0, -1, false, UNASSIGNED_SEQ_NO, 0);
1706         Engine.IndexResult indexResult = engine.index(create);
1707         assertThat(indexResult.getVersion(), equalTo(1L));
1708 <A NAME="49"></A>        create = new Engine.Index(newUid(doc), doc, UNASSIGNED_SEQ_NO, 1, Versions.MATCH_DELETED,
1709                                   VersionType.INTERNAL, PRIMARY, 0, -1, false, UNASSIGNED_SEQ_NO, 0);
1710         indexResult = engine.index(create);
1711         <FONT color="#8e35ef"><div style="position:absolute;left:0"><A
1712                 HREF="javascript:ZweiFrames('match306914-0.html#49',2,'match306914-top.html#49',1)"><IMG SRC="back.gif"
1713                                                                                                          ALT="other"
1714                                                                                                          BORDER="0"
1715                                                                                                          ALIGN="left"></A></div><B>assertThat(indexResult.getResultType(), equalTo(Engine.Result.Type.FAILURE));
1716         assertThat(indexResult.getFailure(), instanceOf(VersionConflictEngineException.class));
1717     }
1718     @Test
1719     public void testOutOfOrderDocsOnReplica() throws IOException {
1720         final List&lt;Engine.Operation&gt; ops = generateSingleDocHistory(
1721             true, randomFrom(VersionType.INTERNAL, VersionType.EXTERNAL, VersionType.EXTERNAL_GTE),
1722             2, 2, 20, &quot;1&quot;);
1723         assertOpsOnReplica</B></FONT>(ops, replicaEngine, true, logger);
1724     }
1725     @Test
1726     public void testConcurrentOutOfOrderDocsOnReplica() throws IOException, InterruptedException {
1727         final List&lt;Engine.Operation&gt; opsDoc1 = generateSingleDocHistory(
1728             true, randomFrom(VersionType.INTERNAL, VersionType.EXTERNAL), 2, 100, 300, &quot;1&quot;);
1729         final Engine.Operation lastOpDoc1 = opsDoc1.get(opsDoc1.size() - 1);
1730         final String lastFieldValueDoc1;
1731         if (lastOpDoc1 instanceof Engine.Index) {
1732             Engine.Index index = (Engine.Index) lastOpDoc1;
1733             lastFieldValueDoc1 = index.docs().get(0).get(&quot;value&quot;);
1734         } else {
1735             lastFieldValueDoc1 = null;
1736         }
1737         final List&lt;Engine.Operation&gt; opsDoc2 =
1738             generateSingleDocHistory(
1739                 true, randomFrom(VersionType.INTERNAL, VersionType.EXTERNAL), 2, 100, 300, &quot;2&quot;);
1740         final Engine.Operation lastOpDoc2 = opsDoc2.get(opsDoc2.size() - 1);
1741         final String lastFieldValueDoc2;
1742         if (lastOpDoc2 instanceof Engine.Index) {
1743             Engine.Index index = (Engine.Index) lastOpDoc2;
1744             lastFieldValueDoc2 = index.docs().get(0).get(&quot;value&quot;);
1745         } else {
1746             lastFieldValueDoc2 = null;
1747         }
1748         final AtomicLong seqNoGenerator = new AtomicLong();
1749         BiFunction&lt;Engine.Operation, Long, Engine.Operation&gt; seqNoUpdater = (operation, newSeqNo) -&gt; {
1750             if (operation instanceof Engine.Index) {
1751                 Engine.Index index = (Engine.Index) operation;
1752                 Document doc = testDocumentWithTextField(index.docs().get(0).get(&quot;value&quot;));
1753                 ParsedDocument parsedDocument = testParsedDocument(index.id(), index.routing(), doc, index.source(), null);
1754                 return new Engine.Index(index.uid(), parsedDocument, newSeqNo, index.primaryTerm(), index.version(),
1755                                         index.versionType(), index.origin(), index.startTime(), index.getAutoGeneratedIdTimestamp(), index.isRetry(),
1756                                         UNASSIGNED_SEQ_NO, 0);
1757             } else {
1758                 Engine.Delete delete = (Engine.Delete) operation;
1759                 return new Engine.Delete(
1760                     delete.id(),
1761                     delete.uid(),
1762                     newSeqNo,
1763                     delete.primaryTerm(),
1764                     delete.version(),
1765                     delete.versionType(),
1766                     delete.origin(),
1767                     delete.startTime(),
1768                     UNASSIGNED_SEQ_NO,
1769                     0
1770                 );
1771             }
1772         };
1773         final List&lt;Engine.Operation&gt; allOps = new ArrayList&lt;&gt;();
1774         Iterator&lt;Engine.Operation&gt; iter1 = opsDoc1.iterator();
1775         Iterator&lt;Engine.Operation&gt; iter2 = opsDoc2.iterator();
1776         while (iter1.hasNext() &amp;&amp; iter2.hasNext()) {
1777             final Engine.Operation next = randomBoolean() ? iter1.next() : iter2.next();
1778 <A NAME="87"></A>            allOps.add(seqNoUpdater.apply(next, seqNoGenerator.getAndIncrement()));
1779         }
1780         iter1.forEachRemaining(o -&gt; allOps.add(seqNoUpdater.apply(o, seqNoGenerator.getAndIncrement())));
1781         <FONT color="#ae694a"><div style="position:absolute;left:0"><A
1782                 HREF="javascript:ZweiFrames('match306914-0.html#87',2,'match306914-top.html#87',1)"><IMG SRC="back.gif"
1783                                                                                                          ALT="other"
1784                                                                                                          BORDER="0"
1785                                                                                                          ALIGN="left"></A></div><B>iter2.forEachRemaining(o -&gt; allOps.add(seqNoUpdater.apply(o, seqNoGenerator.getAndIncrement())));
1786         randomSubsetOf(allOps).forEach(op -&gt; allOps.add(seqNoUpdater.apply</B></FONT>(op, op.seqNo())));
1787         shuffle(allOps, random());
1788         concurrentlyApplyOps(allOps, engine);
1789         engine.refresh(&quot;test&quot;);
1790         if (lastFieldValueDoc1 != null) {
1791             try (Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
1792                 final TotalHitCountCollector collector = new TotalHitCountCollector();
1793                 searcher.search(new TermQuery(new Term(&quot;value&quot;, lastFieldValueDoc1)), collector);
1794                 assertThat(collector.getTotalHits(), equalTo(1));
1795             }
1796         }
1797         if (lastFieldValueDoc2 != null) {
1798             try (Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
1799                 final TotalHitCountCollector collector = new TotalHitCountCollector();
1800                 searcher.search(new TermQuery(new Term(&quot;value&quot;, lastFieldValueDoc2)), collector);
1801                 assertThat(collector.getTotalHits(), equalTo(1));
1802             }
1803         }
1804         int totalExpectedOps = 0;
1805         if (lastFieldValueDoc1 != null) {
1806             totalExpectedOps++;
1807         }
1808         if (lastFieldValueDoc2 != null) {
1809             totalExpectedOps++;
1810         }
1811         assertVisibleCount(engine, totalExpectedOps);
1812     }
1813     @Test
1814     public void testInternalVersioningOnPrimary() throws IOException {
1815         final List&lt;Engine.Operation&gt; ops = generateSingleDocHistory(
1816             false, VersionType.INTERNAL, 2, 2, 20, &quot;1&quot;);
1817         assertOpsOnPrimary(ops, Versions.NOT_FOUND, true, engine);
1818     }
1819     @Test
1820     public void testVersionOnPrimaryWithConcurrentRefresh() throws Exception {
1821         List&lt;Engine.Operation&gt; ops = generateSingleDocHistory(
1822             false, VersionType.INTERNAL, 2, 10, 100, &quot;1&quot;);
1823         CountDownLatch latch = new CountDownLatch(1);
1824         AtomicBoolean running = new AtomicBoolean(true);
1825         Thread refreshThread = new Thread(() -&gt; {
1826             latch.countDown();
1827             while (running.get()) {
1828                 engine.refresh(&quot;test&quot;);
1829             }
1830         });
1831         refreshThread.start();
1832         try {
1833             latch.await();
1834             assertOpsOnPrimary(ops, Versions.NOT_FOUND, true, engine);
1835         } finally {
1836             running.set(false);
1837             refreshThread.join();
1838         }
1839     }
1840     private int assertOpsOnPrimary(List&lt;Engine.Operation&gt; ops,
1841                                    long currentOpVersion,
1842                                    boolean docDeleted,
1843                                    InternalEngine engine)
1844         throws IOException {
1845         String lastFieldValue = null;
1846         int opsPerformed = 0;
1847         long lastOpVersion = currentOpVersion;
1848         long lastOpSeqNo = UNASSIGNED_SEQ_NO;
1849         long lastOpTerm = UNASSIGNED_PRIMARY_TERM;
1850         PrimaryTermSupplier currentTerm = (PrimaryTermSupplier) engine.engineConfig.getPrimaryTermSupplier();
1851         BiFunction&lt;Long, Engine.Index, Engine.Index&gt; indexWithVersion = (version, index) -&gt; new Engine.Index(
1852             index.uid(),
1853             index.parsedDoc(),
1854             UNASSIGNED_SEQ_NO,
1855             currentTerm.get(),
1856             version,
1857             index.versionType(),
1858             index.origin(),
1859             index.startTime(),
1860             index.getAutoGeneratedIdTimestamp(),
1861             index.isRetry(),
1862             UNASSIGNED_SEQ_NO,
1863             0);
1864         BiFunction&lt;Long, Engine.Delete, Engine.Delete&gt; delWithVersion = (version, delete) -&gt; new Engine.Delete(
1865             delete.id(),
1866             delete.uid(),
1867             UNASSIGNED_SEQ_NO,
1868             currentTerm.get(),
1869             version,
1870             delete.versionType(),
1871             delete.origin(),
1872             delete.startTime(),
1873             UNASSIGNED_SEQ_NO,
1874             0);
1875         TriFunction&lt;Long, Long, Engine.Index, Engine.Index&gt; indexWithSeq = (seqNo, term, index) -&gt; new Engine.Index(
1876             index.uid(),
1877             index.parsedDoc(),
1878             UNASSIGNED_SEQ_NO,
1879             currentTerm.get(),
1880             index.version(),
1881             index.versionType(),
1882             index.origin(),
1883             index.startTime(),
1884             index.getAutoGeneratedIdTimestamp(),
1885 <A NAME="104"></A>            index.isRetry(),
1886             seqNo,
1887             term);
1888         TriFunction&lt;Long, Long, Engine.Delete, Engine.Delete&gt; delWithSeq = (seqNo, term, delete) -&gt; <FONT
1889                 color="#d16587"><div style="position:absolute;left:0"><A
1890                 HREF="javascript:ZweiFrames('match306914-0.html#104',2,'match306914-top.html#104',1)"><IMG
1891                 SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>new Engine.Delete(
1892             delete.id(),
1893             delete.uid(),
1894             UNASSIGNED_SEQ_NO,
1895             currentTerm.get(),
1896             delete.version(),
1897             delete.versionType(),
1898             delete.origin(),
1899             delete.startTime(),
1900             seqNo,
1901             term);
1902         Function&lt;Engine.Index, Engine.Index&gt; indexWithCurrentTerm = index -&gt; new Engine.Index(</B></FONT>
1903             index.uid(),
1904             index.parsedDoc(),
1905             UNASSIGNED_SEQ_NO,
1906             currentTerm.get(),
1907             index.version(),
1908             index.versionType(),
1909             index.origin(),
1910             index.startTime(),
1911             index.getAutoGeneratedIdTimestamp(),
1912             index.isRetry(),
1913             index.getIfSeqNo(),
1914             index.getIfPrimaryTerm());
1915         Function&lt;Engine.Delete, Engine.Delete&gt; deleteWithCurrentTerm = delete -&gt; new Engine.Delete(
1916             delete.id(),
1917             delete.uid(),
1918             UNASSIGNED_SEQ_NO,
1919             currentTerm.get(),
1920             delete.version(),
1921             delete.versionType(),
1922             delete.origin(),
1923             delete.startTime(),
1924             delete.getIfSeqNo(),
1925             delete.getIfPrimaryTerm());
1926         for (Engine.Operation op : ops) {
1927             final boolean versionConflict = rarely();
1928             final boolean versionedOp = versionConflict || randomBoolean();
1929             final long conflictingVersion = docDeleted || randomBoolean() ?
1930                 lastOpVersion + (randomBoolean() ? 1 : -1) :
1931                 Versions.MATCH_DELETED;
1932             final long conflictingSeqNo = lastOpSeqNo == UNASSIGNED_SEQ_NO  || randomBoolean() ?
1933                 lastOpSeqNo + 5 :                 lastOpSeqNo;
1934             final long conflictingTerm = conflictingSeqNo == lastOpSeqNo || randomBoolean() ? lastOpTerm + 1 : lastOpTerm;
1935             if (rarely()) {
1936                 currentTerm.set(currentTerm.get() + 1L);
1937                 engine.rollTranslogGeneration();
1938             }
1939             final long correctVersion = docDeleted ? Versions.MATCH_DELETED : lastOpVersion;
1940             logger.info(&quot;performing [{}]{}{}&quot;,
1941                         op.operationType().name().charAt(0),
1942                         versionConflict ? &quot; (conflict &quot; + conflictingVersion + &quot;)&quot; : &quot;&quot;,
1943                         versionedOp ? &quot; (versioned &quot; + correctVersion + &quot;, seqNo &quot; + lastOpSeqNo + &quot;, term &quot; + lastOpTerm + &quot; )&quot; : &quot;&quot;);
1944             if (op instanceof Engine.Index) {
1945                 final Engine.Index index = (Engine.Index) op;
1946                 if (versionConflict) {
1947                     final Engine.IndexResult result;
1948                     if (randomBoolean()) {
1949                         result = engine.index(indexWithSeq.apply(conflictingSeqNo, conflictingTerm, index));
1950                     } else {
1951                         result = engine.index(indexWithVersion.apply(conflictingVersion, index));
1952                     }
1953                     assertThat(result.isCreated(), equalTo(false));
1954                     assertThat(result.getVersion(), equalTo(lastOpVersion));
1955                     assertThat(result.getResultType(), equalTo(Engine.Result.Type.FAILURE));
1956                     assertThat(result.getFailure(), instanceOf(VersionConflictEngineException.class));
1957                 } else {
1958                     final Engine.IndexResult result;
1959                     if (versionedOp) {
1960                         if (randomBoolean() &amp;&amp; lastOpSeqNo != SequenceNumbers.UNASSIGNED_SEQ_NO &amp;&amp; docDeleted == false) {
1961                             result = engine.index(indexWithSeq.apply(lastOpSeqNo, lastOpTerm, index));
1962                         } else {
1963                             result = engine.index(indexWithVersion.apply(correctVersion, index));
1964                         }
1965                     } else {
1966                         result = engine.index(indexWithCurrentTerm.apply(index));
1967                     }
1968                     assertThat(result.isCreated(), equalTo(docDeleted));
1969                     assertThat(result.getVersion(), equalTo(Math.max(lastOpVersion + 1, 1)));
1970                     assertThat(result.getResultType(), equalTo(Engine.Result.Type.SUCCESS));
1971                     assertThat(result.getFailure(), nullValue());
1972                     lastFieldValue = index.docs().get(0).get(&quot;value&quot;);
1973                     assert lastFieldValue != null : &quot;lastFieldValue is null after getting it from index docs&quot;;
1974                     docDeleted = false;
1975                     lastOpVersion = result.getVersion();
1976                     lastOpSeqNo = result.getSeqNo();
1977                     lastOpTerm = result.getTerm();
1978                     opsPerformed++;
1979                 }
1980             } else {
1981                 final Engine.Delete delete = (Engine.Delete) op;
1982                 if (versionConflict) {
1983                     Engine.DeleteResult result;
1984                     if (randomBoolean()) {
1985                         result = engine.delete(delWithSeq.apply(conflictingSeqNo, conflictingTerm, delete));
1986                     } else {
1987                         result = engine.delete(delWithVersion.apply(conflictingVersion, delete));
1988                     }
1989                     assertThat(result.isFound(), equalTo(docDeleted == false));
1990                     assertThat(result.getVersion(), equalTo(lastOpVersion));
1991                     assertThat(result.getResultType(), equalTo(Engine.Result.Type.FAILURE));
1992                     assertThat(result.getFailure(), instanceOf(VersionConflictEngineException.class));
1993                 } else {
1994                     final Engine.DeleteResult result;
1995                     long correctSeqNo = docDeleted ? UNASSIGNED_SEQ_NO : lastOpSeqNo;
1996                     if (versionedOp &amp;&amp; lastOpSeqNo != UNASSIGNED_SEQ_NO &amp;&amp; randomBoolean()) {
1997                         result = engine.delete(delWithSeq.apply(correctSeqNo, lastOpTerm, delete));
1998                     } else if (versionedOp) {
1999                         result = engine.delete(delWithVersion.apply(correctVersion, delete));
2000                     } else {
2001                         result = engine.delete(deleteWithCurrentTerm.apply(delete));
2002                     }
2003                     assertThat(result.isFound(), equalTo(docDeleted == false));
2004                     assertThat(result.getVersion(), equalTo(Math.max(lastOpVersion + 1, 1)));
2005                     assertThat(result.getResultType(), equalTo(Engine.Result.Type.SUCCESS));
2006                     assertThat(result.getFailure(), nullValue());
2007                     docDeleted = true;
2008                     lastOpVersion = result.getVersion();
2009                     lastOpSeqNo = result.getSeqNo();
2010                     lastOpTerm = result.getTerm();
2011                     opsPerformed++;
2012                 }
2013             }
2014             if (randomBoolean()) {
2015                 assertVisibleCount(engine, docDeleted ? 0 : 1);
2016                 if (docDeleted == false &amp;&amp; lastFieldValue != null) {
2017                     try (Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
2018                         final TotalHitCountCollector collector = new TotalHitCountCollector();
2019                         searcher.search(new TermQuery(new Term(&quot;value&quot;, lastFieldValue)), collector);
2020                         assertThat(collector.getTotalHits(), equalTo(1));
2021                     }
2022                 }
2023             }
2024             if (randomBoolean()) {
2025                 engine.flush();
2026                 engine.refresh(&quot;test&quot;);
2027             }
2028             if (rarely()) {
2029                 engine.refresh(&quot;gc_simulation&quot;, Engine.SearcherScope.INTERNAL, true);
2030                 engine.clearDeletedTombstones();
2031                 if (docDeleted) {
2032                     lastOpVersion = Versions.NOT_FOUND;
2033                     lastOpSeqNo = UNASSIGNED_SEQ_NO;
2034                     lastOpTerm = UNASSIGNED_PRIMARY_TERM;
2035                 }
2036             }
2037         }
2038         assertVisibleCount(engine, docDeleted ? 0 : 1);
2039         if (docDeleted == false) {
2040             try (Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
2041                 final TotalHitCountCollector collector = new TotalHitCountCollector();
2042                 if (lastFieldValue != null) {
2043                     searcher.search(new TermQuery(new Term(&quot;value&quot;, lastFieldValue)), collector);
2044                     assertThat(collector.getTotalHits(), equalTo(1));
2045                 }
2046             }
2047         }
2048         return opsPerformed;
2049     }
2050     @Test
2051     public void testNonInternalVersioningOnPrimary() throws IOException {
2052         final Set&lt;VersionType&gt; nonInternalVersioning = new HashSet&lt;&gt;(Arrays.asList(VersionType.values()));
2053         nonInternalVersioning.remove(VersionType.INTERNAL);
2054         final VersionType versionType = randomFrom(nonInternalVersioning);
2055         final List&lt;Engine.Operation&gt; ops = generateSingleDocHistory(
2056             false, versionType, 2, 2, 20, &quot;1&quot;);
2057         final Engine.Operation lastOp = ops.get(ops.size() - 1);
2058         final String lastFieldValue;
2059         if (lastOp instanceof Engine.Index) {
2060             Engine.Index index = (Engine.Index) lastOp;
2061             lastFieldValue = index.docs().get(0).get(&quot;value&quot;);
2062         } else {
2063             lastFieldValue = null;
2064         }
2065         if (versionType == VersionType.EXTERNAL) {
2066             shuffle(ops, random());
2067         }
2068         long highestOpVersion = Versions.NOT_FOUND;
2069         long seqNo = -1;
2070         boolean docDeleted = true;
2071         for (Engine.Operation op : ops) {
2072             logger.info(&quot;performing [{}], v [{}], seq# [{}], term [{}]&quot;,
2073                         op.operationType().name().charAt(0), op.version(), op.seqNo(), op.primaryTerm());
2074             if (op instanceof Engine.Index) {
2075                 final Engine.Index index = (Engine.Index) op;
2076 <A NAME="43"></A>                Engine.IndexResult result = engine.index(index);
2077                 if (op.versionType().isVersionConflictForWrites(highestOpVersion, op.version(), docDeleted) == false) {
2078                     seqNo++;
2079                     <FONT color="#c22817"><div style="position:absolute;left:0"><A
2080                             HREF="javascript:ZweiFrames('match306914-0.html#43',2,'match306914-top.html#43',1)"><IMG
2081                             SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>assertThat(result.getSeqNo(), equalTo(seqNo));
2082                     assertThat(result.isCreated(), equalTo(docDeleted));
2083                     assertThat(result.getVersion(), equalTo(op.version()));
2084                     assertThat(result.getResultType(), equalTo(Engine.Result.Type.SUCCESS));
2085                     assertThat(result.getFailure(), nullValue</B></FONT>());
2086                     docDeleted = false;
2087                     highestOpVersion = op.version();
2088                 } else {
2089                     assertThat(result.isCreated(), equalTo(false));
2090                     assertThat(result.getVersion(), equalTo(highestOpVersion));
2091                     assertThat(result.getResultType(), equalTo(Engine.Result.Type.FAILURE));
2092                     assertThat(result.getFailure(), instanceOf(VersionConflictEngineException.class));
2093                 }
2094             } else {
2095                 final Engine.Delete delete = (Engine.Delete) op;
2096                 Engine.DeleteResult result = engine.delete(delete);
2097                 if (op.versionType().isVersionConflictForWrites(highestOpVersion, op.version(), docDeleted) == false) {
2098                     seqNo++;
2099                     assertThat(result.getSeqNo(), equalTo(seqNo));
2100                     assertThat(result.isFound(), equalTo(docDeleted == false));
2101                     assertThat(result.getVersion(), equalTo(op.version()));
2102                     assertThat(result.getResultType(), equalTo(Engine.Result.Type.SUCCESS));
2103                     assertThat(result.getFailure(), nullValue());
2104                     docDeleted = true;
2105                     highestOpVersion = op.version();
2106                 } else {
2107                     assertThat(result.isFound(), equalTo(docDeleted == false));
2108                     assertThat(result.getVersion(), equalTo(highestOpVersion));
2109                     assertThat(result.getResultType(), equalTo(Engine.Result.Type.FAILURE));
2110                     assertThat(result.getFailure(), instanceOf(VersionConflictEngineException.class));
2111                 }
2112             }
2113             if (randomBoolean()) {
2114                 engine.refresh(&quot;test&quot;);
2115             }
2116             if (randomBoolean()) {
2117                 engine.flush();
2118                 engine.refresh(&quot;test&quot;);
2119             }
2120         }
2121         assertVisibleCount(engine, docDeleted ? 0 : 1);
2122         if (docDeleted == false) {
2123             logger.info(&quot;searching for [{}]&quot;, lastFieldValue);
2124             try (Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
2125                 final TotalHitCountCollector collector = new TotalHitCountCollector();
2126                 searcher.search(new TermQuery(new Term(&quot;value&quot;, lastFieldValue)), collector);
2127                 assertThat(collector.getTotalHits(), equalTo(1));
2128             }
2129         }
2130     }
2131     @Test
2132     public void testVersioningPromotedReplica() throws IOException {
2133         final List&lt;Engine.Operation&gt; replicaOps = generateSingleDocHistory(
2134             true, VersionType.INTERNAL, 1, 2, 20, &quot;1&quot;);
2135         List&lt;Engine.Operation&gt; primaryOps = generateSingleDocHistory(
2136             false, VersionType.INTERNAL, 2, 2, 20, &quot;1&quot;);
2137         Engine.Operation lastReplicaOp = replicaOps.get(replicaOps.size() - 1);
2138         final boolean deletedOnReplica = lastReplicaOp instanceof Engine.Delete;
2139         final long finalReplicaVersion = lastReplicaOp.version();
2140         final long finalReplicaSeqNo = lastReplicaOp.seqNo();
2141         assertOpsOnReplica(replicaOps, replicaEngine, true, logger);
2142         final int opsOnPrimary = assertOpsOnPrimary(primaryOps, finalReplicaVersion, deletedOnReplica, replicaEngine);
2143         final long currentSeqNo = getSequenceID(
2144             replicaEngine,
2145             new Engine.Get(lastReplicaOp.uid().text(), lastReplicaOp.uid())).v1();
2146         try (Searcher searcher = engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.INTERNAL)) {
2147             final TotalHitCountCollector collector = new TotalHitCountCollector();
2148             searcher.search(new MatchAllDocsQuery(), collector);
2149             if (collector.getTotalHits() &gt; 0) {
2150                 assertThat(currentSeqNo, equalTo(finalReplicaSeqNo + opsOnPrimary));
2151             }
2152         }
2153     }
2154     @Test
2155     public void testConcurrentExternalVersioningOnPrimary() throws IOException, InterruptedException {
2156         final List&lt;Engine.Operation&gt; ops = generateSingleDocHistory(
2157             false, VersionType.EXTERNAL, 2, 100, 300, &quot;1&quot;);
2158         final Engine.Operation lastOp = ops.get(ops.size() - 1);
2159         final String lastFieldValue;
2160         if (lastOp instanceof Engine.Index) {
2161             Engine.Index index = (Engine.Index) lastOp;
2162             lastFieldValue = index.docs().get(0).get(&quot;value&quot;);
2163         } else {
2164             lastFieldValue = null;
2165         }
2166         shuffle(ops, random());
2167         concurrentlyApplyOps(ops, engine);
2168         assertVisibleCount(engine, lastFieldValue == null ? 0 : 1);
2169         if (lastFieldValue != null) {
2170             try (Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
2171                 final TotalHitCountCollector collector = new TotalHitCountCollector();
2172                 searcher.search(new TermQuery(new Term(&quot;value&quot;, lastFieldValue)), collector);
2173                 assertThat(collector.getTotalHits(), equalTo(1));
2174             }
2175         }
2176     }
2177     @Test
2178     public void testConcurrentGetAndSetOnPrimary() throws IOException, InterruptedException {
2179         Thread[] thread = new Thread[randomIntBetween(3, 5)];
2180         CountDownLatch startGun = new CountDownLatch(thread.length);
2181         final int opsPerThread = randomIntBetween(10, 20);
2182         class OpAndVersion {
2183             final long version;
2184             final String removed;
2185             final String added;
2186             OpAndVersion(long version, String removed, String added) {
2187                 this.version = version;
2188                 this.removed = removed;
2189                 this.added = added;
2190             }
2191         }
2192         final AtomicInteger idGenerator = new AtomicInteger();
2193         final Queue&lt;OpAndVersion&gt; history = ConcurrentCollections.newQueue();
2194         ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocument(), bytesArray(&quot;&quot;), null);
2195         final Term uidTerm = newUid(doc);
2196         engine.index(indexForDoc(doc));
2197         final BiFunction&lt;String, Engine.SearcherScope, Searcher&gt; searcherFactory = engine::acquireSearcher;
2198         for (int i = 0; i &lt; thread.length; i++) {
2199             thread[i] = new Thread(() -&gt; {
2200                 startGun.countDown();
2201                 try {
2202                     startGun.await();
2203                 } catch (InterruptedException e) {
2204                     throw new AssertionError(e);
2205                 }
2206                 for (int op = 0; op &lt; opsPerThread; op++) {
2207                     try (Engine.GetResult get = engine.get(new Engine.Get(doc.id(), uidTerm), searcherFactory)) {
2208                         FieldsVisitor visitor = new FieldsVisitor(true);
2209                         get.docIdAndVersion().reader.document(get.docIdAndVersion().docId, visitor);
2210                         List&lt;String&gt; values = new ArrayList&lt;&gt;(Strings.commaDelimitedListToSet(visitor.source().utf8ToString()));
2211 <A NAME="102"></A>                        String removed = op % 3 == 0 &amp;&amp; values.size() &gt; 0 ? values.remove(0) : null;
2212                         String added = &quot;v_&quot; + idGenerator.incrementAndGet();
2213                         values.add(added);
2214                         Engine.Index index = <FONT color="#549748"><div style="position:absolute;left:0"><A
2215                 HREF="javascript:ZweiFrames('match306914-0.html#102',2,'match306914-top.html#102',1)"><IMG
2216                 SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>new Engine.Index(uidTerm,
2217                                                               testParsedDocument(&quot;1&quot;, null, testDocument(),
2218                                                                                  bytesArray(Strings.collectionToCommaDelimitedString(values)), null),
2219                                                               UNASSIGNED_SEQ_NO, 2,
2220                                                               get.docIdAndVersion().version, VersionType.INTERNAL,
2221                                                               PRIMARY, System.currentTimeMillis(), -1, false, UNASSIGNED_SEQ_NO, 0);
2222                         Engine.IndexResult indexResult = engine.index</B></FONT>(index);
2223                         if (indexResult.getResultType() == Engine.Result.Type.SUCCESS) {
2224                             history.add(new OpAndVersion(indexResult.getVersion(), removed, added));
2225                         }
2226                     } catch (IOException e) {
2227                         throw new AssertionError(e);
2228                     }
2229                 }
2230             });
2231             thread[i].start();
2232         }
2233         for (int i = 0; i &lt; thread.length; i++) {
2234             thread[i].join();
2235         }
2236         List&lt;OpAndVersion&gt; sortedHistory = new ArrayList&lt;&gt;(history);
2237         sortedHistory.sort(Comparator.comparing(o -&gt; o.version));
2238         Set&lt;String&gt; currentValues = new HashSet&lt;&gt;();
2239         for (int i = 0; i &lt; sortedHistory.size(); i++) {
2240             OpAndVersion op = sortedHistory.get(i);
2241             if (i &gt; 0) {
2242                 assertThat(&quot;duplicate version&quot;, op.version, not(equalTo(sortedHistory.get(i - 1).version)));
2243             }
2244             boolean exists = op.removed == null ? true : currentValues.remove(op.removed);
2245             assertTrue(op.removed + &quot; should exist&quot;, exists);
2246             exists = currentValues.add(op.added);
2247             assertTrue(op.added + &quot; should not exist&quot;, exists);
2248         }
2249         try (Engine.GetResult get = engine.get(new Engine.Get(doc.id(), uidTerm), searcherFactory)) {
2250             FieldsVisitor visitor = new FieldsVisitor(true);
2251             get.docIdAndVersion().reader.document(get.docIdAndVersion().docId, visitor);
2252             List&lt;String&gt; values = Arrays.asList(Strings.commaDelimitedListToStringArray(visitor.source().utf8ToString()));
2253             assertThat(currentValues, equalTo(new HashSet&lt;&gt;(values)));
2254         }
2255     }
2256     @Test
2257     public void testBasicCreatedFlag() throws IOException {
2258         ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocument(), B_1, null);
2259         Engine.Index index = indexForDoc(doc);
2260         Engine.IndexResult indexResult = engine.index(index);
2261         assertTrue(indexResult.isCreated());
2262         index = indexForDoc(doc);
2263         indexResult = engine.index(index);
2264         assertFalse(indexResult.isCreated());
2265         engine.delete(new Engine.Delete(
2266             &quot;1&quot;,
2267             newUid(doc),
2268             UNASSIGNED_SEQ_NO,
2269             primaryTerm.get(),
2270             Versions.MATCH_ANY,
2271             VersionType.INTERNAL,
2272             Engine.Operation.Origin.PRIMARY,
2273             System.nanoTime(),
2274             UNASSIGNED_SEQ_NO,
2275             0
2276         ));
2277         index = indexForDoc(doc);
2278         indexResult = engine.index(index);
2279         assertTrue(indexResult.isCreated());
2280     }
2281     private static class MockAppender extends AbstractAppender {
2282         public boolean sawIndexWriterMessage;
2283         public boolean sawIndexWriterIFDMessage;
2284         MockAppender(final String name) throws IllegalAccessException {
2285             super(name, RegexFilter.createFilter(&quot;.*(\n.*)*&quot;, new String[0],
2286                                                  false, null, null), null);
2287         }
2288         @Override
2289         public void append(LogEvent event) {
2290             final String formattedMessage = event.getMessage().getFormattedMessage();
2291             if (event.getLevel() == Level.TRACE &amp;&amp; event.getMarker().getName().contains(&quot;[index][0]&quot;)) {
2292                 if (event.getLoggerName().endsWith(&quot;.IW&quot;) &amp;&amp;
2293                     formattedMessage.contains(&quot;IW: now apply all deletes&quot;)) {
2294                     sawIndexWriterMessage = true;
2295                 }
2296                 if (event.getLoggerName().endsWith(&quot;.IFD&quot;)) {
2297                     sawIndexWriterIFDMessage = true;
2298                 }
2299             }
2300         }
2301     }
2302     @Test
2303     public void testIndexWriterInfoStream() throws IllegalAccessException, IOException {
2304         assumeFalse(&quot;who tests the tester?&quot;, VERBOSE);
2305         MockAppender mockAppender = new MockAppender(&quot;testIndexWriterInfoStream&quot;);
2306         mockAppender.start();
2307         Logger rootLogger = LogManager.getRootLogger();
2308         Level savedLevel = rootLogger.getLevel();
2309         Loggers.addAppender(rootLogger, mockAppender);
2310 <A NAME="62"></A>        Loggers.setLevel(rootLogger, Level.DEBUG);
2311         rootLogger = LogManager.getRootLogger();
2312         try <FONT color="#151b8d"><div style="position:absolute;left:0"><A
2313                 HREF="javascript:ZweiFrames('match306914-0.html#62',2,'match306914-top.html#62',1)"><IMG SRC="back.gif"
2314                                                                                                          ALT="other"
2315                                                                                                          BORDER="0"
2316                                                                                                          ALIGN="left"></A></div><B>{
2317             ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(), B_1, null);
2318             engine.index(indexForDoc(doc));
2319             engine.flush();
2320             assertFalse(mockAppender.sawIndexWriterMessage);
2321             Loggers.setLevel(rootLogger, Level.TRACE);
2322             engine.index(indexForDoc(doc));
2323             engine.flush();
2324             assertTrue</B></FONT>(mockAppender.sawIndexWriterMessage);
2325         } finally {
2326             Loggers.removeAppender(rootLogger, mockAppender);
2327             mockAppender.stop();
2328             Loggers.setLevel(rootLogger, savedLevel);
2329         }
2330     }
2331     @Test
2332     public void testSeqNoAndCheckpoints() throws IOException, InterruptedException {
2333         final int opCount = randomIntBetween(1, 256);
2334         long primarySeqNo = SequenceNumbers.NO_OPS_PERFORMED;
2335         final String[] ids = new String[]{&quot;1&quot;, &quot;2&quot;, &quot;3&quot;};
2336         final Set&lt;String&gt; indexedIds = new HashSet&lt;&gt;();
2337         long localCheckpoint = SequenceNumbers.NO_OPS_PERFORMED;
2338         long replicaLocalCheckpoint = SequenceNumbers.NO_OPS_PERFORMED;
2339         final long globalCheckpoint;
2340         long maxSeqNo = SequenceNumbers.NO_OPS_PERFORMED;
2341         IOUtils.close(store, engine);
2342         store = createStore();
2343         InternalEngine initialEngine = null;
2344         try {
2345             initialEngine = createEngine(defaultSettings, store, createTempDir(), newLogMergePolicy(), null);
2346             final ShardRouting primary = TestShardRouting.newShardRouting(&quot;test&quot;,
2347                                                                           shardId.id(), &quot;node1&quot;, null, true,
2348 <A NAME="77"></A>                                                                          ShardRoutingState.STARTED, allocationId);
2349             final ShardRouting initializingReplica =
2350                 TestShardRouting.newShardRouting(shardId, &quot;node2&quot;, false, ShardRoutingState.INITIALIZING);
2351             ReplicationTracker gcpTracker = (ReplicationTracker) <FONT color="#4e9258"><div
2352                 style="position:absolute;left:0"><A
2353                 HREF="javascript:ZweiFrames('match306914-0.html#77',2,'match306914-top.html#77',1)"><IMG SRC="back.gif"
2354                                                                                                          ALT="other"
2355                                                                                                          BORDER="0"
2356                                                                                                          ALIGN="left"></A></div><B>initialEngine.config().getGlobalCheckpointSupplier();
2357             gcpTracker.updateFromMaster(1L, new HashSet&lt;&gt;(Collections.singletonList(primary.allocationId().getId())),
2358                 new IndexShardRoutingTable.Builder(shardId).addShard(primary).build());
2359             gcpTracker.activatePrimaryMode</B></FONT>(primarySeqNo);
2360             if (defaultSettings.isSoftDeleteEnabled()) {
2361                 final CountDownLatch countDownLatch = new CountDownLatch(1);
2362                 gcpTracker.addPeerRecoveryRetentionLease(initializingReplica.currentNodeId(),
2363                     SequenceNumbers.NO_OPS_PERFORMED, ActionListener.wrap(countDownLatch::countDown));
2364 <A NAME="18"></A>                countDownLatch.await(5, TimeUnit.SECONDS);
2365             }
2366             gcpTracker.updateFromMaster(2L, new HashSet&lt;&gt;(Collections.singletonList(primary.allocationId().getId())),
2367                 <FONT color="#800517"><div style="position:absolute;left:0"><A
2368                         HREF="javascript:ZweiFrames('match306914-0.html#18',2,'match306914-top.html#18',1)"><IMG
2369                         SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>new IndexShardRoutingTable.Builder(shardId).addShard(primary).addShard(initializingReplica).build());
2370             gcpTracker.initiateTracking(initializingReplica.allocationId().getId());
2371             gcpTracker.markAllocationIdAsInSync(initializingReplica.allocationId().getId(), replicaLocalCheckpoint);
2372             final ShardRouting replica = initializingReplica.moveToStarted();
2373             gcpTracker.updateFromMaster(3L, new HashSet&lt;&gt;(Arrays.asList(primary.allocationId().getId(), replica.allocationId().getId())),
2374                 new IndexShardRoutingTable.Builder(shardId).addShard</B></FONT>(primary).addShard(replica).build());
2375             for (int op = 0; op &lt; opCount; op++) {
2376                 final String id;
2377                 if (rarely() &amp;&amp; indexedIds.isEmpty() == false) {
2378                     id = randomFrom(indexedIds);
2379                     final Engine.Delete delete = new Engine.Delete(
2380                         id,
2381                         newUid(id),
2382                         UNASSIGNED_SEQ_NO,
2383                         primaryTerm.get(),
2384                         rarely() ? 100 : Versions.MATCH_ANY,
2385                         VersionType.INTERNAL,
2386                         PRIMARY,
2387                         System.nanoTime(),
2388                         UNASSIGNED_SEQ_NO,
2389                         0
2390                     );
2391                     final Engine.DeleteResult result = initialEngine.delete(delete);
2392                     if (result.getResultType() == Engine.Result.Type.SUCCESS) {
2393                         assertThat(result.getSeqNo(), equalTo(primarySeqNo + 1));
2394                         assertThat(initialEngine.getSeqNoStats(-1).getMaxSeqNo(), equalTo(primarySeqNo + 1));
2395                         indexedIds.remove(id);
2396                         primarySeqNo++;
2397                     } else {
2398                         assertThat(result.getSeqNo(), equalTo(UNASSIGNED_SEQ_NO));
2399                         assertThat(initialEngine.getSeqNoStats(-1).getMaxSeqNo(), equalTo(primarySeqNo));
2400                     }
2401                 } else {
2402                     id = randomFrom(ids);
2403                     ParsedDocument doc = testParsedDocument(id, null, testDocumentWithTextField(), SOURCE, null);
2404                     final Engine.Index index = new Engine.Index(newUid(doc), doc,
2405                                                                 UNASSIGNED_SEQ_NO, primaryTerm.get(),
2406                                                                 rarely() ? 100 : Versions.MATCH_ANY, VersionType.INTERNAL,
2407                                                                 PRIMARY, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0);
2408                     final Engine.IndexResult result = initialEngine.index(index);
2409                     if (result.getResultType() == Engine.Result.Type.SUCCESS) {
2410                         assertThat(result.getSeqNo(), equalTo(primarySeqNo + 1));
2411                         assertThat(initialEngine.getSeqNoStats(-1).getMaxSeqNo(), equalTo(primarySeqNo + 1));
2412                         indexedIds.add(id);
2413                         primarySeqNo++;
2414                     } else {
2415                         assertThat(result.getSeqNo(), equalTo(UNASSIGNED_SEQ_NO));
2416                         assertThat(initialEngine.getSeqNoStats(-1).getMaxSeqNo(), equalTo(primarySeqNo));
2417                     }
2418                 }
2419                 initialEngine.syncTranslog(); 
2420                 if (randomInt(10) &lt; 3) {
2421                     replicaLocalCheckpoint = randomIntBetween(Math.toIntExact(replicaLocalCheckpoint), Math.toIntExact(primarySeqNo));
2422                 }
2423                 gcpTracker.updateLocalCheckpoint(primary.allocationId().getId(),
2424                     initialEngine.getPersistedLocalCheckpoint());
2425                 gcpTracker.updateLocalCheckpoint(initializingReplica.allocationId().getId(), replicaLocalCheckpoint);
2426                 if (rarely()) {
2427                     localCheckpoint = primarySeqNo;
2428                     maxSeqNo = primarySeqNo;
2429                     initialEngine.flush(true, true);
2430                 }
2431 <A NAME="26"></A>            }
2432             logger.info(&quot;localcheckpoint {}, global {}&quot;, replicaLocalCheckpoint, primarySeqNo);
2433             globalCheckpoint = <FONT color="#68818b"><div style="position:absolute;left:0"><A
2434                 HREF="javascript:ZweiFrames('match306914-0.html#26',2,'match306914-top.html#26',1)"><IMG SRC="back.gif"
2435                                                                                                          ALT="other"
2436                                                                                                          BORDER="0"
2437                                                                                                          ALIGN="left"></A></div><B>gcpTracker.getGlobalCheckpoint();
2438             assertEquals(primarySeqNo, initialEngine.getSeqNoStats(-1).getMaxSeqNo());
2439             assertEquals(primarySeqNo, initialEngine.getPersistedLocalCheckpoint());
2440             assertThat(globalCheckpoint, equalTo(replicaLocalCheckpoint));
2441             assertThat(
2442                 Long.parseLong(initialEngine.commitStats().getUserData().get(SequenceNumbers.LOCAL_CHECKPOINT_KEY)),
2443                 equalTo(localCheckpoint));
2444             initialEngine.getTranslog().sync();             assertThat(
2445                 initialEngine.getTranslog</B></FONT>().getLastSyncedGlobalCheckpoint(),
2446                 equalTo(globalCheckpoint));
2447             assertThat(
2448                 Long.parseLong(initialEngine.commitStats().getUserData().get(SequenceNumbers.MAX_SEQ_NO)),
2449                 equalTo(maxSeqNo));
2450         } finally {
2451             IOUtils.close(initialEngine);
2452 <A NAME="25"></A>        }
2453         try (InternalEngine recoveringEngine = new InternalEngine(initialEngine.config())) {
2454             <FONT color="#5eac10"><div style="position:absolute;left:0"><A
2455                     HREF="javascript:ZweiFrames('match306914-0.html#25',2,'match306914-top.html#25',1)"><IMG
2456                     SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>recoveringEngine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
2457             assertEquals(primarySeqNo, recoveringEngine.getSeqNoStats(-1).getMaxSeqNo());
2458             assertThat(
2459                 Long.parseLong(recoveringEngine.commitStats().getUserData().get(SequenceNumbers.LOCAL_CHECKPOINT_KEY)),
2460                 equalTo(primarySeqNo));
2461             assertThat(
2462                 recoveringEngine.getTranslog().getLastSyncedGlobalCheckpoint(),
2463                 equalTo(globalCheckpoint));
2464             assertThat(
2465                 Long.parseLong(recoveringEngine.commitStats</B></FONT>().getUserData().get(SequenceNumbers.MAX_SEQ_NO)),
2466                 equalTo(primarySeqNo));
2467             assertThat(recoveringEngine.getProcessedLocalCheckpoint(), equalTo(primarySeqNo));
2468             assertThat(recoveringEngine.getPersistedLocalCheckpoint(), equalTo(primarySeqNo));
2469             assertThat(recoveringEngine.getSeqNoStats(-1).getMaxSeqNo(), equalTo(primarySeqNo));
2470             assertThat(generateNewSeqNo(recoveringEngine), equalTo(primarySeqNo + 1));
2471         }
2472     }
2473     @Test
2474     public void testConcurrentWritesAndCommits() throws Exception {
2475         List&lt;Engine.IndexCommitRef&gt; commits = new ArrayList&lt;&gt;();
2476         try (Store store = createStore();
2477              InternalEngine engine = createEngine(config(defaultSettings, store, createTempDir(), newMergePolicy(), null))) {
2478             final int numIndexingThreads = scaledRandomIntBetween(2, 4);
2479             final int numDocsPerThread = randomIntBetween(500, 1000);
2480             final CyclicBarrier barrier = new CyclicBarrier(numIndexingThreads + 1);
2481             final List&lt;Thread&gt; indexingThreads = new ArrayList&lt;&gt;();
2482             final CountDownLatch doneLatch = new CountDownLatch(numIndexingThreads);
2483             for (int threadNum = 0; threadNum &lt; numIndexingThreads; threadNum++) {
2484                 final int threadIdx = threadNum;
2485                 Thread indexingThread = new Thread(() -&gt; {
2486                     try {
2487                         barrier.await();                         for (int i = 0; i &lt; numDocsPerThread; i++) {
2488                             final String id = &quot;thread&quot; + threadIdx + &quot;#&quot; + i;
2489                             ParsedDocument doc = testParsedDocument(id, null, testDocument(), B_1, null);
2490                             engine.index(indexForDoc(doc));
2491                         }
2492                     } catch (Exception e) {
2493                         throw new RuntimeException(e);
2494                     } finally {
2495                         doneLatch.countDown();
2496                     }
2497                 });
2498                 indexingThreads.add(indexingThread);
2499             }
2500             for (Thread thread : indexingThreads) {
2501                 thread.start();
2502             }
2503             barrier.await();             int commitLimit = randomIntBetween(10, 20);
2504             long sleepTime = 1;
2505             boolean doneIndexing;
2506             do {
2507                 doneIndexing = doneLatch.await(sleepTime, TimeUnit.MILLISECONDS);
2508                 commits.add(engine.acquireLastIndexCommit(true));
2509                 if (commits.size() &gt; commitLimit) {                     IOUtils.close(commits.remove(randomIntBetween(0, commits.size()-1)));
2510                     sleepTime = sleepTime * 2;
2511                 }
2512             } while (doneIndexing == false);
2513             long prevLocalCheckpoint = SequenceNumbers.NO_OPS_PERFORMED;
2514             long prevMaxSeqNo = SequenceNumbers.NO_OPS_PERFORMED;
2515             for (Engine.IndexCommitRef commitRef : commits) {
2516                 final IndexCommit commit = commitRef.getIndexCommit();
2517                 Map&lt;String, String&gt; userData = commit.getUserData();
2518                 long localCheckpoint = userData.containsKey(SequenceNumbers.LOCAL_CHECKPOINT_KEY) ?
2519                     Long.parseLong(userData.get(SequenceNumbers.LOCAL_CHECKPOINT_KEY)) :
2520                     SequenceNumbers.NO_OPS_PERFORMED;
2521                 long maxSeqNo = userData.containsKey(SequenceNumbers.MAX_SEQ_NO) ?
2522                     Long.parseLong(userData.get(SequenceNumbers.MAX_SEQ_NO)) :
2523                     UNASSIGNED_SEQ_NO;
2524                 assertThat(localCheckpoint, greaterThanOrEqualTo(prevLocalCheckpoint));
2525                 assertThat(maxSeqNo, greaterThanOrEqualTo(prevMaxSeqNo));
2526                 try (IndexReader reader = DirectoryReader.open(commit)) {
2527                     Long highest = getHighestSeqNo(reader);
2528                     final long highestSeqNo;
2529                     if (highest != null) {
2530                         highestSeqNo = highest.longValue();
2531                     } else {
2532                         highestSeqNo = SequenceNumbers.NO_OPS_PERFORMED;
2533                     }
2534                     assertThat(highestSeqNo, greaterThanOrEqualTo(localCheckpoint));
2535                     assertThat(highestSeqNo, lessThanOrEqualTo(maxSeqNo));
2536                     FixedBitSet seqNosBitSet = getSeqNosSet(reader, highestSeqNo);
2537                     for (int i = 0; i &lt;= localCheckpoint; i++) {
2538                         assertTrue(&quot;local checkpoint [&quot; + localCheckpoint + &quot;], _seq_no [&quot; + i + &quot;] should be indexed&quot;,
2539                                    seqNosBitSet.get(i));
2540                     }
2541                 }
2542                 prevLocalCheckpoint = localCheckpoint;
2543                 prevMaxSeqNo = maxSeqNo;
2544             }
2545         }
2546     }
2547     private static Long getHighestSeqNo(final IndexReader reader) throws IOException {
2548         final String fieldName = SeqNoFieldMapper.NAME;
2549         long size = PointValues.size(reader, fieldName);
2550         if (size == 0) {
2551             return null;
2552         }
2553         byte[] max = PointValues.getMaxPackedValue(reader, fieldName);
2554         return LongPoint.decodeDimension(max, 0);
2555     }
2556     private static FixedBitSet getSeqNosSet(final IndexReader reader, final long highestSeqNo) throws IOException {
2557         final FixedBitSet bitSet = new FixedBitSet((int) highestSeqNo + 1);
2558         final List&lt;LeafReaderContext&gt; leaves = reader.leaves();
2559         if (leaves.isEmpty()) {
2560             return bitSet;
2561         }
2562         for (int i = 0; i &lt; leaves.size(); i++) {
2563             final LeafReader leaf = leaves.get(i).reader();
2564             final NumericDocValues values = leaf.getNumericDocValues(SeqNoFieldMapper.NAME);
2565             if (values == null) {
2566                 continue;
2567             }
2568             final Bits bits = leaf.getLiveDocs();
2569             for (int docID = 0; docID &lt; leaf.maxDoc(); docID++) {
2570                 if (bits == null || bits.get(docID)) {
2571                     if (values.advanceExact(docID) == false) {
2572                         throw new AssertionError(&quot;Document does not have a seq number: &quot; + docID);
2573                     }
2574                     final long seqNo = values.longValue();
2575                     assertFalse(&quot;should not have more than one document with the same seq_no[&quot; +
2576                                 seqNo + &quot;]&quot;, bitSet.get((int) seqNo));
2577                     bitSet.set((int) seqNo);
2578                 }
2579             }
2580         }
2581         return bitSet;
2582     }
2583     @Test
2584     public void testIndexWriterIFDInfoStream() throws IllegalAccessException, IOException {
2585         assumeFalse(&quot;who tests the tester?&quot;, VERBOSE);
2586         MockAppender mockAppender = new MockAppender(&quot;testIndexWriterIFDInfoStream&quot;);
2587         mockAppender.start();
2588         final Logger iwIFDLogger = LogManager.getLogger(&quot;org.elasticsearch.index.engine.Engine.IFD&quot;);
2589 <A NAME="47"></A>        Loggers.addAppender(iwIFDLogger, mockAppender);
2590         Loggers.setLevel(iwIFDLogger, Level.DEBUG);
2591         try <FONT color="#d16587"><div style="position:absolute;left:0"><A
2592                 HREF="javascript:ZweiFrames('match306914-0.html#47',2,'match306914-top.html#47',1)"><IMG SRC="back.gif"
2593                                                                                                          ALT="other"
2594                                                                                                          BORDER="0"
2595                                                                                                          ALIGN="left"></A></div><B>{
2596             ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(), B_1, null);
2597             engine.index(indexForDoc(doc));
2598             engine.flush();
2599             assertFalse(mockAppender.sawIndexWriterMessage);
2600             assertFalse(mockAppender.sawIndexWriterIFDMessage);
2601             Loggers.setLevel(iwIFDLogger, Level.TRACE);
2602             engine.index(indexForDoc(doc));
2603             engine.flush();
2604             assertFalse(mockAppender.sawIndexWriterMessage);
2605             assertTrue</B></FONT>(mockAppender.sawIndexWriterIFDMessage);
2606         } finally {
2607             Loggers.removeAppender(iwIFDLogger, mockAppender);
2608             mockAppender.stop();
2609             Loggers.setLevel(iwIFDLogger, (Level) null);
2610         }
2611     }
2612     @Test
2613     public void testEnableGcDeletes() throws Exception {
2614         try (Store store = createStore();
2615              Engine engine = createEngine(config(defaultSettings, store, createTempDir(), newMergePolicy(), null))) {
2616             engine.config().setEnableGcDeletes(false);
2617             final BiFunction&lt;String, Engine.SearcherScope, Searcher&gt; searcherFactory = engine::acquireSearcher;
2618             Document document = testDocument();
2619             document.add(new TextField(&quot;value&quot;, &quot;test1&quot;, Field.Store.YES));
2620             ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, document, B_2, null);
2621             engine.index(new Engine.Index(newUid(doc), doc, UNASSIGNED_SEQ_NO, 0, 1,
2622                                           VersionType.EXTERNAL,
2623                                           Engine.Operation.Origin.PRIMARY, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0));
2624             engine.delete(new Engine.Delete(
2625                 &quot;1&quot;,
2626                 newUid(doc),
2627                 UNASSIGNED_SEQ_NO,
2628                 0,
2629                 10,
2630                 VersionType.EXTERNAL,
2631                 Engine.Operation.Origin.PRIMARY,
2632                 System.nanoTime(),
2633                 UNASSIGNED_SEQ_NO,
2634                 0
2635             ));
2636             Engine.GetResult getResult = engine.get(newGet(doc), searcherFactory);
2637             assertThat(getResult.docIdAndVersion(), is(nullValue()));
2638             Thread.sleep(1000);
2639             if (randomBoolean()) {
2640                 engine.refresh(&quot;test&quot;);
2641             }
2642             engine.delete(new Engine.Delete(
2643                 &quot;2&quot;,
2644                 newUid(&quot;2&quot;),
2645                 UNASSIGNED_SEQ_NO,
2646                 0,
2647                 10,
2648                 VersionType.EXTERNAL,
2649                 Engine.Operation.Origin.PRIMARY,
2650                 System.nanoTime(),
2651                 UNASSIGNED_SEQ_NO,
2652                 0
2653             ));
2654             getResult = engine.get(new Engine.Get(&quot;2&quot;, newUid(&quot;2&quot;)), searcherFactory);
2655             assertThat(getResult.docIdAndVersion(), is(nullValue()));
2656             Engine.Index index = new Engine.Index(newUid(doc), doc, UNASSIGNED_SEQ_NO, 0, 2,
2657                                                   VersionType.EXTERNAL, Engine.Operation.Origin.PRIMARY, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0);
2658             Engine.IndexResult indexResult = engine.index(index);
2659             assertThat(indexResult.getResultType(), equalTo(Engine.Result.Type.FAILURE));
2660             assertThat(indexResult.getFailure(), instanceOf(VersionConflictEngineException.class));
2661             getResult = engine.get(newGet(doc), searcherFactory);
2662             assertThat(getResult.docIdAndVersion(), is(nullValue()));
2663 <A NAME="68"></A>            Engine.Index index1 = new Engine.Index(newUid(doc), doc, UNASSIGNED_SEQ_NO, 0, 2,
2664                                                    VersionType.EXTERNAL, Engine.Operation.Origin.PRIMARY, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0);
2665             indexResult = engine.index(index1);
2666             assertThat(<FONT color="#b041ff"><div style="position:absolute;left:0"><A
2667                 HREF="javascript:ZweiFrames('match306914-0.html#68',2,'match306914-top.html#68',1)"><IMG SRC="back.gif"
2668                                                                                                          ALT="other"
2669                                                                                                          BORDER="0"
2670                                                                                                          ALIGN="left"></A></div><B>indexResult.getResultType(), equalTo(Engine.Result.Type.FAILURE));
2671             assertThat(indexResult.getFailure(), instanceOf(VersionConflictEngineException.class));
2672             getResult = engine.get(newGet(doc), searcherFactory);
2673             assertThat(getResult.docIdAndVersion(), is(nullValue()));
2674         }</B></FONT>
2675     }
2676     @Test
2677     public void testExtractShardId() {
2678         try (Engine.Searcher test = this.engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.INTERNAL)) {
2679             ShardId shardId = ShardUtils.extractShardId(test.getDirectoryReader());
2680             assertNotNull(shardId);
2681             assertEquals(shardId, engine.config().getShardId());
2682         }
2683     }
2684     @Test
2685     public void testFailStart() throws IOException {
2686 <A NAME="76"></A>                final int iters = scaledRandomIntBetween(10, 100);
2687         for (int i = 0; i &lt; iters; i++) {
2688             <FONT color="#f62817"><div style="position:absolute;left:0"><A
2689                     HREF="javascript:ZweiFrames('match306914-0.html#76',2,'match306914-top.html#76',1)"><IMG
2690                     SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>MockDirectoryWrapper wrapper = newMockDirectory();
2691             wrapper.setFailOnOpenInput(randomBoolean());
2692             wrapper.setAllowRandomFileNotFoundException(randomBoolean());
2693             wrapper.setRandomIOExceptionRate(randomDouble());
2694             wrapper.setRandomIOExceptionRateOnOpen(randomDouble());
2695             final Path translogPath = createTempDir</B></FONT>(&quot;testFailStart&quot;);
2696             try (Store store = createStore(wrapper)) {
2697                 int refCount = store.refCount();
2698                 assertTrue(&quot;refCount: &quot; + store.refCount(), store.refCount() &gt; 0);
2699                 InternalEngine holder;
2700                 try {
2701                     holder = createEngine(store, translogPath);
2702                 } catch (EngineCreationFailureException | IOException ex) {
2703                     assertEquals(store.refCount(), refCount);
2704                     continue;
2705                 }
2706                 assertEquals(store.refCount(), refCount + 1);
2707                 final int numStarts = scaledRandomIntBetween(1, 5);
2708                 for (int j = 0; j &lt; numStarts; j++) {
2709                     try {
2710                         assertEquals(store.refCount(), refCount + 1);
2711                         holder.close();
2712                         holder = createEngine(store, translogPath);
2713                         assertEquals(store.refCount(), refCount + 1);
2714                     } catch (EngineCreationFailureException ex) {
2715                         assertEquals(store.refCount(), refCount);
2716                         break;
2717                     }
2718                 }
2719                 holder.close();
2720                 assertEquals(store.refCount(), refCount);
2721             }
2722         }
2723     }
2724 <A NAME="31"></A>    @Test
2725     public void testSettings() {
2726         CodecService codecService = new CodecService(null, logger);
2727         LiveIndexWriterConfig currentIndexWriterConfig = <FONT color="#3ea99f"><div style="position:absolute;left:0"><A
2728                 HREF="javascript:ZweiFrames('match306914-0.html#31',2,'match306914-top.html#31',1)"><IMG SRC="back.gif"
2729                                                                                                          ALT="other"
2730                                                                                                          BORDER="0"
2731                                                                                                          ALIGN="left"></A></div><B>engine.getCurrentIndexWriterConfig();
2732         assertEquals(engine.config().getCodec().getName(), codecService.codec(codecName).getName());
2733         assertEquals(currentIndexWriterConfig.getCodec().getName(), codecService.codec(codecName).getName());
2734     }
2735     @Test
2736     public void testCurrentTranslogIDisCommitted() throws IOException {
2737         final AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED)</B></FONT>;
2738         try (Store store = createStore()) {
2739             EngineConfig config = config(defaultSettings, store, createTempDir(), newMergePolicy(), null, null,
2740                                          globalCheckpoint::get);
2741             {
2742                 store.createEmpty(Version.CURRENT.luceneVersion);
2743                 final String translogUUID =
2744                     Translog.createEmptyTranslog(config.getTranslogConfig().getTranslogPath(),
2745                                                  SequenceNumbers.NO_OPS_PERFORMED, shardId, primaryTerm.get());
2746                 store.associateIndexWithNewTranslog(translogUUID);
2747                 ParsedDocument doc = testParsedDocument(Integer.toString(0), null, testDocument(),
2748                                                         new BytesArray(&quot;{}&quot;), null);
2749                 Engine.Index firstIndexRequest = new Engine.Index(newUid(doc), doc, UNASSIGNED_SEQ_NO, 0,
2750                                                                   Versions.MATCH_DELETED, VersionType.INTERNAL, PRIMARY, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0);
2751 <A NAME="97"></A>                try (InternalEngine engine = createEngine(config)) {
2752                     engine.index(firstIndexRequest);
2753                     engine.syncTranslog();                     <FONT color="#347235"><div
2754                 style="position:absolute;left:0"><A
2755                 HREF="javascript:ZweiFrames('match306914-0.html#97',2,'match306914-top.html#97',1)"><IMG
2756                 SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>assertEquals(engine.getProcessedLocalCheckpoint(), engine.getPersistedLocalCheckpoint());
2757                     globalCheckpoint.set(engine.getPersistedLocalCheckpoint());
2758                     expectThrows(IllegalStateException.class, () -&gt; engine.recoverFromTranslog(translogHandler, Long.MAX_VALUE));
2759                     Map&lt;String, String&gt; userData = engine.getLastCommittedSegmentInfos</B></FONT>().getUserData();
2760                     assertEquals(engine.getTranslog().getTranslogUUID(), userData.get(Translog.TRANSLOG_UUID_KEY));
2761                 }
2762             }
2763             {
2764                 for (int i = 0; i &lt; 2; i++) {
2765                     try (InternalEngine engine = new InternalEngine(config)) {
2766                         expectThrows(IllegalStateException.class, engine::ensureCanFlush);
2767                         Map&lt;String, String&gt; userData = engine.getLastCommittedSegmentInfos().getUserData();
2768                         assertEquals(engine.getTranslog().getTranslogUUID(), userData.get(Translog.TRANSLOG_UUID_KEY));
2769                         engine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
2770                         userData = engine.getLastCommittedSegmentInfos().getUserData();
2771                         assertEquals(engine.getTranslog().getTranslogUUID(), userData.get(Translog.TRANSLOG_UUID_KEY));
2772                     }
2773                 }
2774             }
2775             {
2776                 final String translogUUID =
2777                     Translog.createEmptyTranslog(config.getTranslogConfig().getTranslogPath(),
2778                                                  SequenceNumbers.NO_OPS_PERFORMED, shardId, primaryTerm.get());
2779                 store.associateIndexWithNewTranslog(translogUUID);
2780                 try (InternalEngine engine = new InternalEngine(config)) {
2781                     Map&lt;String, String&gt; userData = engine.getLastCommittedSegmentInfos().getUserData();
2782                     assertEquals(engine.getTranslog().getTranslogUUID(), userData.get(Translog.TRANSLOG_UUID_KEY));
2783                     engine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
2784                     assertEquals(2, engine.getTranslog().currentFileGeneration());
2785                 }
2786             }
2787             {
2788                 for (int i = 0; i &lt; 2; i++) {
2789                     try (InternalEngine engine = new InternalEngine(config)) {
2790                         Map&lt;String, String&gt; userData = engine.getLastCommittedSegmentInfos().getUserData();
2791                         assertEquals(engine.getTranslog().getTranslogUUID(), userData.get(Translog.TRANSLOG_UUID_KEY));
2792                         engine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
2793                         userData = engine.getLastCommittedSegmentInfos().getUserData();
2794                         assertEquals(engine.getTranslog().getTranslogUUID(), userData.get(Translog.TRANSLOG_UUID_KEY));
2795                     }
2796                 }
2797             }
2798         }
2799     }
2800     @Test
2801     public void testMissingTranslog() throws IOException {
2802         engine.close();
2803 <A NAME="50"></A>                final long newPrimaryTerm = randomLongBetween(0L, primaryTerm.get());
2804         final Translog translog = createTranslog(() -&gt; newPrimaryTerm);
2805         long id = <FONT color="#ff0000"><div style="position:absolute;left:0"><A
2806                 HREF="javascript:ZweiFrames('match306914-0.html#50',2,'match306914-top.html#50',1)"><IMG SRC="back.gif"
2807                                                                                                          ALT="other"
2808                                                                                                          BORDER="0"
2809                                                                                                          ALIGN="left"></A></div><B>translog.currentFileGeneration();
2810         translog.close();
2811         IOUtils.rm(translog.location().resolve(Translog.getFilename(id)));
2812         expectThrows(EngineCreationFailureException.class, &quot;engine shouldn't start without a valid translog id&quot;,
2813             () -&gt; createEngine(store, primaryTranslogDir));
2814         final String translogUUID = Translog.createEmptyTranslog(primaryTranslogDir, UNASSIGNED_SEQ_NO, shardId, newPrimaryTerm);
2815         store.associateIndexWithNewTranslog(translogUUID);
2816         EngineConfig config = config(defaultSettings, store, primaryTranslogDir, newMergePolicy</B></FONT>(), null);
2817         engine = new InternalEngine(config);
2818     }
2819     @Test
2820     public void testTranslogReplayWithFailure() throws IOException {
2821         final MockDirectoryWrapper directory = newMockDirectory();
2822         final Path translogPath = createTempDir(&quot;testTranslogReplayWithFailure&quot;);
2823         try (Store store = createStore(directory)) {
2824             final int numDocs = randomIntBetween(1, 10);
2825             try (InternalEngine engine = createEngine(store, translogPath)) {
2826                 for (int i = 0; i &lt; numDocs; i++) {
2827                     ParsedDocument doc = testParsedDocument(Integer.toString(i), null, testDocument(), new BytesArray(&quot;{}&quot;), null);
2828                     Engine.Index firstIndexRequest = new Engine.Index(newUid(doc), doc, UNASSIGNED_SEQ_NO, 0,
2829                                                                       Versions.MATCH_DELETED, VersionType.INTERNAL, PRIMARY, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0);
2830                     Engine.IndexResult indexResult = engine.index(firstIndexRequest);
2831                     assertThat(indexResult.getVersion(), equalTo(1L));
2832                 }
2833                 assertVisibleCount(engine, numDocs);
2834             }
2835             final int numIters = randomIntBetween(3, 5);
2836             for (int i = 0; i &lt; numIters; i++) {
2837                 directory.setRandomIOExceptionRateOnOpen(randomDouble());
2838                 directory.setRandomIOExceptionRate(randomDouble());
2839                 directory.setFailOnOpenInput(randomBoolean());
2840                 directory.setAllowRandomFileNotFoundException(randomBoolean());
2841                 boolean started = false;
2842                 InternalEngine engine = null;
2843                 try {
2844                     engine = createEngine(store, translogPath);
2845                     started = true;
2846                 } catch (EngineException | IOException e) {
2847                     logger.trace(&quot;exception on open&quot;, e);
2848                 }
2849                 directory.setRandomIOExceptionRateOnOpen(0.0);
2850                 directory.setRandomIOExceptionRate(0.0);
2851                 directory.setFailOnOpenInput(false);
2852                 directory.setAllowRandomFileNotFoundException(false);
2853                 if (started) {
2854                     engine.refresh(&quot;warm_up&quot;);
2855                     assertVisibleCount(engine, numDocs, false);
2856                     engine.close();
2857                 }
2858             }
2859         }
2860     }
2861 <A NAME="75"></A>    @Test
2862     public void testTranslogCleanUpPostCommitCrash() throws Exception {
2863         IndexSettings indexSettings = new IndexSettings(defaultSettings.getIndexMetadata(), defaultSettings.getNodeSettings(),
2864                                                         <FONT color="#800517"><div style="position:absolute;left:0"><A
2865                                                                 HREF="javascript:ZweiFrames('match306914-0.html#75',2,'match306914-top.html#75',1)"><IMG
2866                                                                 SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>defaultSettings.getScopedSettings());
2867         IndexMetadata.Builder builder = IndexMetadata.builder(indexSettings.getIndexMetadata());
2868         builder.settings(Settings.builder().put(indexSettings.getSettings())
2869                              .put(IndexSettings.INDEX_TRANSLOG_RETENTION_AGE_SETTING.getKey(), &quot;-1&quot;)
2870                              .put(IndexSettings.INDEX_TRANSLOG_RETENTION_SIZE_SETTING.getKey</B></FONT>(), &quot;-1&quot;)
2871         );
2872         indexSettings.updateIndexMetadata(builder.build());
2873         try (Store store = createStore()) {
2874             AtomicBoolean throwErrorOnCommit = new AtomicBoolean();
2875             final Path translogPath = createTempDir();
2876             final AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
2877             final LongSupplier globalCheckpointSupplier = globalCheckpoint::get;
2878             store.createEmpty(Version.CURRENT.luceneVersion);
2879             final String translogUUID = Translog.createEmptyTranslog(translogPath, globalCheckpoint.get(), shardId, primaryTerm.get());
2880             store.associateIndexWithNewTranslog(translogUUID);
2881             try (InternalEngine engine =
2882                      new InternalEngine(config(indexSettings, store, translogPath, newMergePolicy(), null, null,
2883                                                globalCheckpointSupplier)) {
2884                          @Override
2885                          protected void commitIndexWriter(IndexWriter writer, Translog translog, String syncId) throws IOException {
2886                              super.commitIndexWriter(writer, translog, syncId);
2887                              if (throwErrorOnCommit.get()) {
2888                                  throw new RuntimeException(&quot;power's out&quot;);
2889                              }
2890 <A NAME="32"></A>                         }
2891                      }) {
2892                 engine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
2893                 final ParsedDocument doc1 = <FONT color="#5b8daf"><div style="position:absolute;left:0"><A
2894                 HREF="javascript:ZweiFrames('match306914-0.html#32',2,'match306914-top.html#32',1)"><IMG SRC="back.gif"
2895                                                                                                          ALT="other"
2896                                                                                                          BORDER="0"
2897                                                                                                          ALIGN="left"></A></div><B>testParsedDocument(&quot;1&quot;, null,
2898                                                                testDocumentWithTextField(), SOURCE, null);
2899                 engine.index(indexForDoc(doc1));
2900                 engine.syncTranslog();                 assertEquals(engine.getProcessedLocalCheckpoint(), engine.getPersistedLocalCheckpoint());
2901                 globalCheckpoint.set(engine.getPersistedLocalCheckpoint());
2902                 throwErrorOnCommit.set(true);
2903                 FlushFailedEngineException e = expectThrows(FlushFailedEngineException.class, engine::flush);
2904                 assertThat(e.getCause().getMessage(), equalTo</B></FONT>(&quot;power's out&quot;));
2905             }
2906             try (InternalEngine engine =
2907                      new InternalEngine(config(indexSettings, store, translogPath, newMergePolicy(), null, null,
2908                                                globalCheckpointSupplier))) {
2909                 engine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
2910                 assertVisibleCount(engine, 1);
2911                 final long localCheckpoint = Long.parseLong(
2912                     engine.getLastCommittedSegmentInfos().userData.get(SequenceNumbers.LOCAL_CHECKPOINT_KEY));
2913                 final long committedGen = engine.getTranslog().getMinGenerationForSeqNo(localCheckpoint + 1).translogFileGeneration;
2914                 for (int gen = 1; gen &lt; committedGen; gen++) {
2915                     final Path genFile = translogPath.resolve(Translog.getFilename(gen));
2916                     assertFalse(genFile + &quot; wasn't cleaned up&quot;, Files.exists(genFile));
2917                 }
2918             }
2919         }
2920     }
2921     @Test
2922     public void testSkipTranslogReplay() throws IOException {
2923         final int numDocs = randomIntBetween(1, 10);
2924         for (int i = 0; i &lt; numDocs; i++) {
2925             ParsedDocument doc = testParsedDocument(Integer.toString(i), null, testDocument(), new BytesArray(&quot;{}&quot;), null);
2926             Engine.Index firstIndexRequest = new Engine.Index(newUid(doc), doc, UNASSIGNED_SEQ_NO, 0,
2927                                                               Versions.MATCH_DELETED, VersionType.INTERNAL, PRIMARY, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0);
2928             Engine.IndexResult indexResult = engine.index(firstIndexRequest);
2929             assertThat(indexResult.getVersion(), equalTo(1L));
2930         }
2931         EngineConfig config = engine.config();
2932         assertVisibleCount(engine, numDocs);
2933         engine.close();
2934         try (InternalEngine engine = new InternalEngine(config)) {
2935             engine.skipTranslogRecovery();
2936             try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.INTERNAL)) {
2937                 TopDocs topDocs = searcher.search(new MatchAllDocsQuery(), randomIntBetween(numDocs, numDocs + 10));
2938                 assertThat(topDocs.totalHits.value, equalTo(0L));
2939             }
2940         }
2941     }
2942     @Test
2943     public void testTranslogReplay() throws IOException {
2944         final LongSupplier inSyncGlobalCheckpointSupplier = () -&gt; this.engine.getProcessedLocalCheckpoint();
2945         final int numDocs = randomIntBetween(1, 10);
2946         for (int i = 0; i &lt; numDocs; i++) {
2947             ParsedDocument doc = testParsedDocument(Integer.toString(i), null, testDocument(), new BytesArray(&quot;{}&quot;), null);
2948             Engine.Index firstIndexRequest = new Engine.Index(newUid(doc), doc, UNASSIGNED_SEQ_NO, 1,
2949                                                               Versions.MATCH_DELETED, VersionType.INTERNAL, PRIMARY, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0);
2950             Engine.IndexResult indexResult = engine.index(firstIndexRequest);
2951             assertThat(indexResult.getVersion(), equalTo(1L));
2952         }
2953         assertVisibleCount(engine, numDocs);
2954         translogHandler = createTranslogHandler(engine.engineConfig.getIndexSettings());
2955         engine.close();
2956         engine = new InternalEngine(copy(engine.config(), inSyncGlobalCheckpointSupplier));
2957         engine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
2958         engine.refresh(&quot;warm_up&quot;);
2959         assertVisibleCount(engine, numDocs, false);
2960         engine.close();
2961         translogHandler = createTranslogHandler(engine.engineConfig.getIndexSettings());
2962         engine = createEngine(store, primaryTranslogDir, inSyncGlobalCheckpointSupplier);
2963 <A NAME="99"></A>        engine.refresh(&quot;warm_up&quot;);
2964         assertVisibleCount(engine, numDocs, false);
2965         <FONT color="#c57717"><div style="position:absolute;left:0"><A
2966                 HREF="javascript:ZweiFrames('match306914-0.html#99',2,'match306914-top.html#99',1)"><IMG SRC="back.gif"
2967                                                                                                          ALT="other"
2968                                                                                                          BORDER="0"
2969                                                                                                          ALIGN="left"></A></div><B>final boolean flush = randomBoolean();
2970         int randomId = randomIntBetween(numDocs + 1, numDocs + 10);
2971         ParsedDocument doc = testParsedDocument(Integer.toString(randomId), null, testDocument(), new</B></FONT> BytesArray(&quot;{}&quot;), null);
2972         Engine.Index firstIndexRequest = new Engine.Index(newUid(doc), doc, UNASSIGNED_SEQ_NO, 1, 1,
2973                                                           VersionType.EXTERNAL, PRIMARY, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0);
2974         Engine.IndexResult indexResult = engine.index(firstIndexRequest);
2975         assertThat(indexResult.getVersion(), equalTo(1L));
2976         if (flush) {
2977             engine.flush();
2978             engine.refresh(&quot;test&quot;);
2979         }
2980         doc = testParsedDocument(Integer.toString(randomId), null, testDocument(), new BytesArray(&quot;{}&quot;), null);
2981         Engine.Index idxRequest = new Engine.Index(newUid(doc), doc, UNASSIGNED_SEQ_NO, 1, 2,
2982                                                    VersionType.EXTERNAL, PRIMARY, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0);
2983         Engine.IndexResult result = engine.index(idxRequest);
2984         engine.refresh(&quot;test&quot;);
2985         assertThat(result.getVersion(), equalTo(2L));
2986         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
2987             TopDocs topDocs = searcher.search(new MatchAllDocsQuery(), numDocs + 1);
2988             assertThat(topDocs.totalHits.value, equalTo(numDocs + 1L));
2989         }
2990         engine.close();
2991         translogHandler = createTranslogHandler(engine.engineConfig.getIndexSettings());
2992         engine = createEngine(store, primaryTranslogDir, inSyncGlobalCheckpointSupplier);
2993         engine.refresh(&quot;warm_up&quot;);
2994         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
2995             TopDocs topDocs = searcher.search(new MatchAllDocsQuery(), numDocs + 1);
2996             assertThat(topDocs.totalHits.value, equalTo(numDocs + 1L));
2997         }
2998         engine.delete(new Engine.Delete(
2999             Integer.toString(randomId),
3000             newUid(doc),
3001             UNASSIGNED_SEQ_NO,
3002             primaryTerm.get(),
3003             Versions.MATCH_ANY,
3004             VersionType.INTERNAL,
3005             Engine.Operation.Origin.PRIMARY,
3006             System.nanoTime(),
3007             UNASSIGNED_SEQ_NO,
3008             0
3009         ));
3010         if (randomBoolean()) {
3011             engine.close();
3012             engine = createEngine(store, primaryTranslogDir, inSyncGlobalCheckpointSupplier);
3013         }
3014         engine.refresh(&quot;test&quot;);
3015         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
3016             TopDocs topDocs = searcher.search(new MatchAllDocsQuery(), numDocs);
3017             assertThat(topDocs.totalHits.value, equalTo((long) numDocs));
3018         }
3019     }
3020     @Test
3021     public void testRecoverFromForeignTranslog() throws IOException {
3022         final int numDocs = randomIntBetween(1, 10);
3023         for (int i = 0; i &lt; numDocs; i++) {
3024             ParsedDocument doc = testParsedDocument(Integer.toString(i), null, testDocument(), new BytesArray(&quot;{}&quot;), null);
3025             Engine.Index firstIndexRequest = new Engine.Index(newUid(doc), doc, UNASSIGNED_SEQ_NO, 1,
3026                                                               Versions.MATCH_DELETED, VersionType.INTERNAL, PRIMARY, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0);
3027             Engine.IndexResult index = engine.index(firstIndexRequest);
3028             assertThat(index.getVersion(), equalTo(1L));
3029         }
3030         assertVisibleCount(engine, numDocs);
3031         Translog.TranslogGeneration generation = engine.getTranslog().getGeneration();
3032         engine.close();
3033         final Path badTranslogLog = createTempDir();
3034         final String badUUID = Translog.createEmptyTranslog(badTranslogLog, SequenceNumbers.NO_OPS_PERFORMED, shardId, primaryTerm.get());
3035 <A NAME="91"></A>        Translog translog = new Translog(
3036             new TranslogConfig(shardId, badTranslogLog, INDEX_SETTINGS, BigArrays.NON_RECYCLING_INSTANCE),
3037             badUUID, createTranslogDeletionPolicy(INDEX_SETTINGS), () -&gt; SequenceNumbers.NO_OPS_PERFORMED, primaryTerm::get, seqNo -&gt; {});
3038         <FONT color="#827d6b"><div style="position:absolute;left:0"><A
3039                 HREF="javascript:ZweiFrames('match306914-0.html#91',2,'match306914-top.html#91',1)"><IMG SRC="back.gif"
3040                                                                                                          ALT="other"
3041                                                                                                          BORDER="0"
3042                                                                                                          ALIGN="left"></A></div><B>translog.add(new Translog.Index(
3043             &quot;SomeBogusId&quot;,
3044             0,
3045             primaryTerm.get(),
3046             &quot;{}&quot;.getBytes(Charset.forName(&quot;UTF-8&quot;))));
3047         assertEquals(generation.translogFileGeneration, translog.currentFileGeneration());
3048         translog.close();
3049         EngineConfig config = engine.config</B></FONT>();
3050         TranslogConfig translogConfig = new TranslogConfig(shardId, translog.location(), config.getIndexSettings(),
3051                                                            BigArrays.NON_RECYCLING_INSTANCE);
3052         EngineConfig brokenConfig = new EngineConfig(
3053             shardId,
3054             allocationId.getId(),
3055             threadPool,
3056             config.getIndexSettings(),
3057             store,
3058             newMergePolicy(),
3059             config.getAnalyzer(),
3060             new CodecService(null, logger),
3061             config.getEventListener(),
3062             IndexSearcher.getDefaultQueryCache(),
3063             IndexSearcher.getDefaultQueryCachingPolicy(),
3064             translogConfig,
3065             TimeValue.timeValueMinutes(5),
3066             config.getExternalRefreshListener(),
3067             config.getInternalRefreshListener(),
3068             new NoneCircuitBreakerService(),
3069             () -&gt; UNASSIGNED_SEQ_NO,
3070             () -&gt; RetentionLeases.EMPTY,
3071             primaryTerm::get,
3072             tombstoneDocSupplier()
3073         );
3074         expectThrows(EngineCreationFailureException.class, () -&gt; new InternalEngine(brokenConfig));
3075         engine = createEngine(store, primaryTranslogDir);         assertVisibleCount(engine, numDocs, true);
3076     }
3077     @Test
3078     public void testShardNotAvailableExceptionWhenEngineClosedConcurrently() throws IOException, InterruptedException {
3079         AtomicReference&lt;Exception&gt; exception = new AtomicReference&lt;&gt;();
3080         String operation = randomFrom(&quot;optimize&quot;, &quot;refresh&quot;, &quot;flush&quot;);
3081         Thread mergeThread = new Thread() {
3082             @Override
3083             public void run() {
3084                 boolean stop = false;
3085                 logger.info(&quot;try with {}&quot;, operation);
3086                 while (stop == false) {
3087                     try {
3088                         switch (operation) {
3089                             case &quot;optimize&quot;: {
3090                                 engine.forceMerge(true, 1, false, false, false, UUIDs.randomBase64UUID());
3091                                 break;
3092                             }
3093                             case &quot;refresh&quot;: {
3094                                 engine.refresh(&quot;test refresh&quot;);
3095                                 break;
3096                             }
3097                             case &quot;flush&quot;: {
3098                                 engine.flush(true, false);
3099                                 break;
3100                             }
3101                         }
3102                     } catch (Exception e) {
3103                         exception.set(e);
3104                         stop = true;
3105                     }
3106 <A NAME="56"></A>                }
3107             }
3108         };
3109         <FONT color="#52d017"><div style="position:absolute;left:0"><A
3110                 HREF="javascript:ZweiFrames('match306914-0.html#56',2,'match306914-top.html#56',1)"><IMG SRC="back.gif"
3111                                                                                                          ALT="other"
3112                                                                                                          BORDER="0"
3113                                                                                                          ALIGN="left"></A></div><B>mergeThread.start();
3114         engine.close();
3115         mergeThread.join();
3116         logger.info(&quot;exception caught: &quot;, exception.get());
3117         assertTrue(&quot;expected an Exception that signals shard is not available&quot;,
3118                    TransportActions.isShardNotAvailableException(exception.get()));
3119     }
3120     @Test
3121     public void testConcurrentEngineClosed() throws BrokenBarrierException, InterruptedException {
3122         Thread[] closingThreads = new Thread[3]</B></FONT>;
3123         CyclicBarrier barrier = new CyclicBarrier(1 + closingThreads.length + 1);
3124         Thread failEngine = new Thread(new AbstractRunnable() {
3125             @Override
3126             public void onFailure(Exception e) {
3127                 throw new AssertionError(e);
3128             }
3129             @Override
3130             protected void doRun() throws Exception {
3131                 barrier.await();
3132                 engine.failEngine(&quot;test&quot;, new RuntimeException(&quot;test&quot;));
3133             }
3134         });
3135         failEngine.start();
3136         for (int i = 0;i &lt; closingThreads.length ; i++) {
3137             boolean flushAndClose = randomBoolean();
3138             closingThreads[i] = new Thread(new AbstractRunnable() {
3139                 @Override
3140                 public void onFailure(Exception e) {
3141                     throw new AssertionError(e);
3142                 }
3143                 @Override
3144                 protected void doRun() throws Exception {
3145                     barrier.await();
3146                     if (flushAndClose) {
3147                         engine.flushAndClose();
3148                     } else {
3149                         engine.close();
3150                     }
3151                     synchronized (closingThreads) {
3152                         try (Lock ignored = store.directory().obtainLock(IndexWriter.WRITE_LOCK_NAME)) {
3153                         }
3154                     }
3155                 }
3156             });
3157             closingThreads[i].setName(&quot;closingThread_&quot; + i);
3158             closingThreads[i].start();
3159         }
3160         barrier.await();
3161         failEngine.join();
3162         for (Thread t : closingThreads) {
3163             t.join();
3164         }
3165     }
3166     private static class ThrowingIndexWriter extends IndexWriter {
3167         private AtomicReference&lt;Supplier&lt;Exception&gt;&gt; failureToThrow = new AtomicReference&lt;&gt;();
3168         ThrowingIndexWriter(Directory d, IndexWriterConfig conf) throws IOException {
3169             super(d, conf);
3170         }
3171         @Override
3172         public long addDocument(Iterable&lt;? extends IndexableField&gt; doc) throws IOException {
3173             maybeThrowFailure();
3174             return super.addDocument(doc);
3175         }
3176         private void maybeThrowFailure() throws IOException {
3177             if (failureToThrow.get() != null) {
3178                 Exception failure = failureToThrow.get().get();
3179                 clearFailure();                 if (failure instanceof RuntimeException) {
3180                     throw (RuntimeException) failure;
3181                 } else if (failure instanceof IOException) {
3182                     throw (IOException) failure;
3183                 } else {
3184                     assert false: &quot;unsupported failure class: &quot; + failure.getClass().getCanonicalName();
3185                 }
3186             }
3187         }
3188         @Override
3189         public long softUpdateDocument(Term term, Iterable&lt;? extends IndexableField&gt; doc, Field... softDeletes) throws IOException {
3190             maybeThrowFailure();
3191             return super.softUpdateDocument(term, doc, softDeletes);
3192         }
3193         @Override
3194         public long deleteDocuments(Term... terms) throws IOException {
3195             maybeThrowFailure();
3196             return super.deleteDocuments(terms);
3197         }
3198         public void setThrowFailure(Supplier&lt;Exception&gt; failureSupplier) {
3199             failureToThrow.set(failureSupplier);
3200         }
3201         public void clearFailure() {
3202             failureToThrow.set(null);
3203         }
3204     }
3205     @Test
3206     public void testHandleDocumentFailure() throws Exception {
3207         try (Store store = createStore()) {
3208             final ParsedDocument doc1 = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(), B_1, null);
3209             final ParsedDocument doc2 = testParsedDocument(&quot;2&quot;, null, testDocumentWithTextField(), B_1, null);
3210             final ParsedDocument doc3 = testParsedDocument(&quot;3&quot;, null, testDocumentWithTextField(), B_1, null);
3211             AtomicReference&lt;ThrowingIndexWriter&gt; throwingIndexWriter = new AtomicReference&lt;&gt;();
3212             try (InternalEngine engine = createEngine(
3213                 defaultSettings,
3214                 store,
3215                 createTempDir(),
3216                 NoMergePolicy.INSTANCE,
3217                 (directory, iwc) -&gt; {
3218                     throwingIndexWriter.set(new ThrowingIndexWriter(directory, iwc));
3219                     return throwingIndexWriter.get();
3220                 })
3221             ) {
3222                 if (randomBoolean()) {
3223                     throwingIndexWriter.get().setThrowFailure(() -&gt; new IOException(&quot;simulated&quot;));
3224                 } else {
3225                     throwingIndexWriter.get().setThrowFailure(() -&gt; new IllegalArgumentException(&quot;simulated max token length&quot;));
3226                 }
3227 <A NAME="40"></A>                                Engine.IndexResult indexResult = engine.index(indexForDoc(doc1));
3228                 assertNotNull(indexResult.getFailure());
3229                 <FONT color="#347235"><div style="position:absolute;left:0"><A
3230                         HREF="javascript:ZweiFrames('match306914-0.html#40',2,'match306914-top.html#40',1)"><IMG
3231                         SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>assertThat(indexResult.getSeqNo(), equalTo(0L));
3232                 assertThat(indexResult.getVersion(), equalTo(Versions.MATCH_ANY));
3233                 assertNotNull(indexResult.getTranslogLocation());
3234                 throwingIndexWriter.get().clearFailure();
3235                 indexResult = engine.index(indexForDoc(doc1));
3236                 assertThat(indexResult.getSeqNo(), equalTo(1L));
3237                 assertThat</B></FONT>(indexResult.getVersion(), equalTo(1L));
3238                 assertNull(indexResult.getFailure());
3239                 assertNotNull(indexResult.getTranslogLocation());
3240                 engine.index(indexForDoc(doc2));
3241                 if (randomBoolean()) {
3242                     throwingIndexWriter.get().setThrowFailure(null);
3243                     UncheckedIOException uncheckedIOException = expectThrows(UncheckedIOException.class, () -&gt; {
3244                         Engine.Index index = indexForDoc(doc3);
3245                         index.parsedDoc().rootDoc().add(new StoredField(&quot;foo&quot;, &quot;bar&quot;) {
3246                             @Override
3247                             public BytesRef binaryValue() {
3248                                 throw new UncheckedIOException(new MockDirectoryWrapper.FakeIOException());
3249                             }
3250                         });
3251                         engine.index(index);
3252                     });
3253                     assertTrue(uncheckedIOException.getCause() instanceof MockDirectoryWrapper.FakeIOException);
3254                 } else {
3255 <A NAME="72"></A>                    engine.close();
3256                 }
3257                 <FONT color="#f52887"><div style="position:absolute;left:0"><A
3258                         HREF="javascript:ZweiFrames('match306914-0.html#72',2,'match306914-top.html#72',1)"><IMG
3259                         SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>expectThrows(AlreadyClosedException.class, () -&gt; engine.index(indexForDoc(doc1)));
3260                 expectThrows(AlreadyClosedException.class,
3261                              () -&gt; engine.delete(new Engine.Delete(
3262                                  &quot;1&quot;,
3263                                  newUid(doc1),
3264                                  UNASSIGNED_SEQ_NO,
3265                                  primaryTerm.get(),
3266                                  Versions.MATCH_ANY,
3267                                  VersionType.INTERNAL,
3268                                  Engine.Operation.Origin.PRIMARY,
3269                                  System.nanoTime(),
3270                                  UNASSIGNED_SEQ_NO,
3271                                  0)));
3272                 expectThrows(AlreadyClosedException.class,
3273                              () -&gt; engine.noOp(
3274                                  new Engine.NoOp(engine.getLocalCheckpointTracker().generateSeqNo</B></FONT>(),
3275                                                  engine.config().getPrimaryTermSupplier().getAsLong(),
3276                                                  randomFrom(Engine.Operation.Origin.values()),
3277                                                  randomNonNegativeLong(),
3278                                                  &quot;test&quot;)));
3279             }
3280         }
3281     }
3282     @Test
3283     public void testDeleteWithFatalError() throws Exception {
3284         final IllegalStateException tragicException = new IllegalStateException(&quot;fail to store tombstone&quot;);
3285         try (Store store = createStore()) {
3286             EngineConfig.TombstoneDocSupplier tombstoneDocSupplier = new EngineConfig.TombstoneDocSupplier() {
3287                 @Override
3288                 public ParsedDocument newDeleteTombstoneDoc(String id) {
3289                     ParsedDocument parsedDocument = tombstoneDocSupplier().newDeleteTombstoneDoc(id);
3290                     parsedDocument.rootDoc().add(new StoredField(&quot;foo&quot;, &quot;bar&quot;) {
3291                         @Override
3292                         public BytesRef binaryValue() {
3293                             throw tragicException;
3294                         }
3295                     });
3296                     return parsedDocument;
3297                 }
3298                 @Override
3299                 public ParsedDocument newNoopTombstoneDoc(String reason) {
3300                     return tombstoneDocSupplier().newNoopTombstoneDoc(reason);
3301                 }
3302 <A NAME="65"></A>            };
3303             EngineConfig config = config(this.engine.config(), store, createTempDir(), tombstoneDocSupplier);
3304             try (InternalEngine engine = createEngine(config)) {
3305                 final ParsedDocument doc = <FONT color="#c58917"><div style="position:absolute;left:0"><A
3306                 HREF="javascript:ZweiFrames('match306914-0.html#65',2,'match306914-top.html#65',1)"><IMG SRC="back.gif"
3307                                                                                                          ALT="other"
3308                                                                                                          BORDER="0"
3309                                                                                                          ALIGN="left"></A></div><B>testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(), SOURCE, null);
3310                 engine.index(indexForDoc(doc));
3311                 expectThrows(IllegalStateException.class, () -&gt; engine.delete(
3312                     new Engine.Delete(
3313                         &quot;1&quot;,
3314                         newUid(doc),
3315                         UNASSIGNED_SEQ_NO,
3316                         primaryTerm.get(),
3317                         Versions.MATCH_ANY,
3318                         VersionType.INTERNAL,
3319                         Engine.Operation.Origin.PRIMARY,
3320                         System.nanoTime(),
3321                         UNASSIGNED_SEQ_NO,
3322                         0
3323                     )));
3324                 assertTrue(engine.isClosed.get());
3325                 assertSame</B></FONT>(tragicException, engine.failedEngine.get());
3326             }
3327         }
3328     }
3329     @Test
3330     public void testDoubleDeliveryPrimary() throws IOException {
3331         final ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(),
3332             new BytesArray(&quot;{}&quot;.getBytes(Charset.defaultCharset())), null);
3333         final boolean create = randomBoolean();
3334 <A NAME="96"></A>        Engine.Index operation = appendOnlyPrimary(doc, false, 1, create);
3335         Engine.Index retry = appendOnlyPrimary(doc, true, 1, create);
3336         if (randomBoolean()) {
3337             Engine.IndexResult indexResult = <FONT color="#152dc6"><div style="position:absolute;left:0"><A
3338                 HREF="javascript:ZweiFrames('match306914-0.html#96',2,'match306914-top.html#96',1)"><IMG SRC="back.gif"
3339                                                                                                          ALT="other"
3340                                                                                                          BORDER="0"
3341                                                                                                          ALIGN="left"></A></div><B>engine.index(operation);
3342             assertLuceneOperations(engine, 1, 0, 0);
3343             assertThatIfAssertionEnabled(engine.getNumVersionLookups(), is(0L));
3344             assertNotNull(indexResult.getTranslogLocation());
3345             Engine.IndexResult retryResult = engine.index(retry);
3346             assertLuceneOperations</B></FONT>(engine, 1, create ? 0 : 1, 0);
3347             assertThatIfAssertionEnabled(engine.getNumVersionLookups(), is(1L));
3348             if (create) {
3349                 assertNull(retryResult.getTranslogLocation());
3350             } else {
3351 <A NAME="95"></A>                assertNotNull(retryResult.getTranslogLocation());
3352             }
3353         } else {
3354             Engine.IndexResult retryResult = <FONT color="#348781"><div style="position:absolute;left:0"><A
3355                 HREF="javascript:ZweiFrames('match306914-0.html#95',2,'match306914-top.html#95',1)"><IMG SRC="back.gif"
3356                                                                                                          ALT="other"
3357                                                                                                          BORDER="0"
3358                                                                                                          ALIGN="left"></A></div><B>engine.index(retry);
3359             assertLuceneOperations(engine, 1, 0, 0);
3360             assertThatIfAssertionEnabled(engine.getNumVersionLookups(), is(1L));
3361             assertNotNull(retryResult.getTranslogLocation());
3362             Engine.IndexResult indexResult = engine.index(operation);
3363             assertLuceneOperations</B></FONT>(engine, 1, create ? 0 : 1, 0);
3364             assertThatIfAssertionEnabled(engine.getNumVersionLookups(), is(2L));
3365             assertNotNull(retryResult.getTranslogLocation());
3366             if (create) {
3367                 assertNull(indexResult.getTranslogLocation());
3368             } else {
3369                 assertNotNull(indexResult.getTranslogLocation());
3370             }
3371         }
3372         engine.refresh(&quot;test&quot;);
3373         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
3374             TopDocs topDocs = searcher.search(new MatchAllDocsQuery(), 10);
3375             assertEquals(1, topDocs.totalHits.value);
3376         }
3377         operation = appendOnlyPrimary(doc, false, 1, create);
3378         retry = appendOnlyPrimary(doc, true, 1, create);
3379         if (randomBoolean()) {
3380             Engine.IndexResult indexResult = engine.index(operation);
3381             if (create) {
3382                 assertNull(indexResult.getTranslogLocation());
3383             } else {
3384                 assertNotNull(indexResult.getTranslogLocation());
3385             }
3386             Engine.IndexResult retryResult = engine.index(retry);
3387             if (create) {
3388                 assertNull(retryResult.getTranslogLocation());
3389             } else {
3390                 assertNotNull(retryResult.getTranslogLocation());
3391             }
3392         } else {
3393             Engine.IndexResult retryResult = engine.index(retry);
3394             if (create) {
3395                 assertNull(retryResult.getTranslogLocation());
3396             } else {
3397                 assertNotNull(retryResult.getTranslogLocation());
3398             }
3399             Engine.IndexResult indexResult = engine.index(operation);
3400             if (create) {
3401                 assertNull(indexResult.getTranslogLocation());
3402             } else {
3403                 assertNotNull(indexResult.getTranslogLocation());
3404             }
3405         }
3406         engine.refresh(&quot;test&quot;);
3407         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
3408             TopDocs topDocs = searcher.search(new MatchAllDocsQuery(), 10);
3409             assertEquals(1, topDocs.totalHits.value);
3410         }
3411     }
3412     @Test
3413     public void testDoubleDeliveryReplicaAppendingAndDeleteOnly() throws IOException {
3414         final ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(),
3415                                                       new BytesArray(&quot;{}&quot;.getBytes(Charset.defaultCharset())), null);
3416         Engine.Index operation = appendOnlyReplica(doc, false, 1, randomIntBetween(0, 5));
3417         Engine.Index retry = appendOnlyReplica(doc, true, 1, randomIntBetween(0, 5));
3418 <A NAME="94"></A>        Engine.Delete delete = new Engine.Delete(
3419             operation.id(),
3420             operation.uid(),
3421             <FONT color="#810541"><div style="position:absolute;left:0"><A
3422                     HREF="javascript:ZweiFrames('match306914-0.html#94',2,'match306914-top.html#94',1)"><IMG
3423                     SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>Math.max(retry.seqNo(), operation.seqNo()) + 1,
3424             operation.primaryTerm(),
3425             operation.version() + 1,
3426             operation.versionType(),
3427             REPLICA,
3428             operation.startTime() + 1,
3429             UNASSIGNED_SEQ_NO,
3430             0
3431         );
3432 <A NAME="37"></A>                final boolean sameSeqNo = operation.seqNo() == retry.seqNo</B></FONT>();
3433         if (randomBoolean()) {
3434             Engine.IndexResult indexResult = <FONT color="#810541"><div style="position:absolute;left:0"><A
3435                 HREF="javascript:ZweiFrames('match306914-0.html#37',2,'match306914-top.html#37',1)"><IMG SRC="back.gif"
3436                                                                                                          ALT="other"
3437                                                                                                          BORDER="0"
3438                                                                                                          ALIGN="left"></A></div><B>engine.index(operation);
3439             assertLuceneOperations(engine, 1, 0, 0);
3440             assertThatIfAssertionEnabled(engine.getNumVersionLookups(), is(0L));
3441             assertNotNull(indexResult.getTranslogLocation());
3442             engine.delete(delete);
3443             assertThatIfAssertionEnabled(engine.getNumVersionLookups(), is(1L));
3444             assertLuceneOperations(engine, 1, 0, 1);
3445             Engine.IndexResult retryResult = engine.index(retry);
3446             assertThatIfAssertionEnabled(engine.getNumVersionLookups(), is</B></FONT>(sameSeqNo ? 1L : 2L));
3447 <A NAME="36"></A>            assertNotNull(retryResult.getTranslogLocation());
3448             assertTrue(retryResult.getTranslogLocation().compareTo(indexResult.getTranslogLocation()) &gt; 0);
3449         } else {
3450             Engine.IndexResult retryResult = <FONT color="#ff00ff"><div style="position:absolute;left:0"><A
3451                 HREF="javascript:ZweiFrames('match306914-0.html#36',2,'match306914-top.html#36',1)"><IMG SRC="back.gif"
3452                                                                                                          ALT="other"
3453                                                                                                          BORDER="0"
3454                                                                                                          ALIGN="left"></A></div><B>engine.index(retry);
3455             assertLuceneOperations(engine, 1, 0, 0);
3456             assertThatIfAssertionEnabled(engine.getNumVersionLookups(), is(0L));
3457             assertNotNull(retryResult.getTranslogLocation());
3458             engine.delete(delete);
3459             assertLuceneOperations(engine, 1, 0, 1);
3460             assertThatIfAssertionEnabled(engine.getNumVersionLookups(), is(1L));
3461             Engine.IndexResult indexResult = engine.index(operation);
3462             assertThatIfAssertionEnabled(engine.getNumVersionLookups(), is</B></FONT>(sameSeqNo ? 1L : 2L));
3463             assertNotNull(retryResult.getTranslogLocation());
3464             assertTrue(retryResult.getTranslogLocation().compareTo(indexResult.getTranslogLocation()) &lt; 0);
3465         }
3466         engine.refresh(&quot;test&quot;);
3467         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
3468             TopDocs topDocs = searcher.search(new MatchAllDocsQuery(), 10);
3469             assertEquals(0, topDocs.totalHits.value);
3470         }
3471     }
3472     @Test
3473     public void testDoubleDeliveryReplicaAppendingOnly() throws IOException {
3474         final Supplier&lt;ParsedDocument&gt; doc = () -&gt; testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(),
3475             new BytesArray(&quot;{}&quot;.getBytes(Charset.defaultCharset())), null);
3476         boolean replicaOperationIsRetry = randomBoolean();
3477         Engine.Index operation = appendOnlyReplica(doc.get(), replicaOperationIsRetry, 1, randomIntBetween(0, 5));
3478         Engine.IndexResult result = engine.index(operation);
3479         assertLuceneOperations(engine, 1, 0, 0);
3480         assertEquals(0, engine.getNumVersionLookups());
3481         assertNotNull(result.getTranslogLocation());
3482         engine.refresh(&quot;test&quot;);
3483         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
3484             TopDocs topDocs = searcher.search(new MatchAllDocsQuery(), 10);
3485             assertEquals(1, topDocs.totalHits.value);
3486         }
3487         final boolean create = randomBoolean();
3488         operation = appendOnlyPrimary(doc.get(), false, 1, create);
3489         Engine.Index retry = appendOnlyPrimary(doc.get(), true, 1, create);
3490         if (randomBoolean()) {
3491             if (replicaOperationIsRetry) {
3492                 Engine.IndexResult indexResult = engine.index(operation);
3493                 if (create) {
3494                     assertNull(indexResult.getTranslogLocation());
3495                 } else {
3496                     assertNotNull(indexResult.getTranslogLocation());
3497                 }
3498             }
3499             Engine.IndexResult retryResult = engine.index(retry);
3500             if (create) {
3501                 assertNull(retryResult.getTranslogLocation());
3502             } else {
3503                 assertNotNull(retryResult.getTranslogLocation());
3504             }
3505         } else {
3506             Engine.IndexResult retryResult = engine.index(retry);
3507             if (create) {
3508                 assertNull(retryResult.getTranslogLocation());
3509             } else {
3510                 assertNotNull(retryResult.getTranslogLocation());
3511             }
3512             Engine.IndexResult indexResult = engine.index(operation);
3513             if (create) {
3514                 assertNull(indexResult.getTranslogLocation());
3515             } else {
3516                 assertNotNull(indexResult.getTranslogLocation());
3517             }
3518         }
3519         engine.refresh(&quot;test&quot;);
3520         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
3521             TopDocs topDocs = searcher.search(new MatchAllDocsQuery(), 10);
3522             assertEquals(1, topDocs.totalHits.value);
3523         }
3524     }
3525     @Test
3526     public void testDoubleDeliveryReplica() throws IOException {
3527         final ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(),
3528                                                       new BytesArray(&quot;{}&quot;.getBytes(Charset.defaultCharset())), null);
3529         Engine.Index operation = replicaIndexForDoc(doc, 1, 20, false);
3530         Engine.Index duplicate = replicaIndexForDoc(doc, 1, 20, true);
3531         if (randomBoolean()) {
3532             Engine.IndexResult indexResult = engine.index(operation);
3533             assertLuceneOperations(engine, 1, 0, 0);
3534             assertThatIfAssertionEnabled(engine.getNumVersionLookups(), is(0L));
3535             assertNotNull(indexResult.getTranslogLocation());
3536             if (randomBoolean()) {
3537                 engine.refresh(&quot;test&quot;);
3538             }
3539             Engine.IndexResult retryResult = engine.index(duplicate);
3540             assertLuceneOperations(engine, 1, 0, 0);
3541             assertThatIfAssertionEnabled(engine.getNumVersionLookups(), is(0L));
3542             assertNotNull(retryResult.getTranslogLocation());
3543             assertTrue(retryResult.getTranslogLocation().compareTo(indexResult.getTranslogLocation()) &gt; 0);
3544         } else {
3545             Engine.IndexResult retryResult = engine.index(duplicate);
3546             assertLuceneOperations(engine, 1, 0, 0);
3547             assertThatIfAssertionEnabled(engine.getNumVersionLookups(), is(0L));
3548             assertNotNull(retryResult.getTranslogLocation());
3549             if (randomBoolean()) {
3550                 engine.refresh(&quot;test&quot;);
3551             }
3552             Engine.IndexResult indexResult = engine.index(operation);
3553             assertLuceneOperations(engine, 1, 0, 0);
3554             assertThatIfAssertionEnabled(engine.getNumVersionLookups(), is(0L));
3555             assertNotNull(retryResult.getTranslogLocation());
3556             assertTrue(retryResult.getTranslogLocation().compareTo(indexResult.getTranslogLocation()) &lt; 0);
3557         }
3558         engine.refresh(&quot;test&quot;);
3559         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
3560             TopDocs topDocs = searcher.search(new MatchAllDocsQuery(), 10);
3561             assertEquals(1, topDocs.totalHits.value);
3562         }
3563         engine.refresh(&quot;test&quot;);
3564         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
3565             TopDocs topDocs = searcher.search(new MatchAllDocsQuery(), 10);
3566 <A NAME="105"></A>            assertEquals(1, topDocs.totalHits.value);
3567         }
3568         if (engine.engineConfig.getIndexSettings().isSoftDeleteEnabled()) {
3569             List&lt;Translog.Operation&gt; ops = <FONT color="#c57726"><div style="position:absolute;left:0"><A
3570                 HREF="javascript:ZweiFrames('match306914-0.html#105',2,'match306914-top.html#105',1)"><IMG
3571                 SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>readAllOperationsInLucene(engine, createMapperService(&quot;test&quot;));
3572             assertThat(ops.stream().map(o -&gt; o.seqNo()).collect(Collectors.toList</B></FONT>()), hasItem(20L));
3573         }
3574     }
3575     @Test
3576     public void testRetryWithAutogeneratedIdWorksAndNoDuplicateDocs() throws IOException {
3577         final ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(),
3578                                                       new BytesArray(&quot;{}&quot;.getBytes(Charset.defaultCharset())), null);
3579         boolean isRetry = false;
3580         long autoGeneratedIdTimestamp = 0;
3581         Engine.Index index = new Engine.Index(
3582             newUid(doc),
3583             doc,
3584             UNASSIGNED_SEQ_NO,
3585             1,
3586             randomBoolean() ? Versions.MATCH_DELETED : Versions.MATCH_ANY,
3587             VersionType.INTERNAL,
3588             PRIMARY,
3589             System.nanoTime(),
3590             autoGeneratedIdTimestamp,
3591             isRetry,
3592             UNASSIGNED_SEQ_NO,
3593             0
3594         );
3595         Engine.IndexResult indexResult = engine.index(index);
3596         assertThat(indexResult.getVersion(), equalTo(1L));
3597         index = new Engine.Index(newUid(doc), doc, indexResult.getSeqNo(), index.primaryTerm(), indexResult.getVersion(),
3598                                  null, REPLICA, System.nanoTime(), autoGeneratedIdTimestamp, isRetry, UNASSIGNED_SEQ_NO, 0);
3599         indexResult = replicaEngine.index(index);
3600         assertThat(indexResult.getVersion(), equalTo(1L));
3601         isRetry = true;
3602         index = new Engine.Index(
3603             newUid(doc),
3604             doc,
3605             UNASSIGNED_SEQ_NO,
3606             1,
3607             Versions.MATCH_ANY,
3608             VersionType.INTERNAL,
3609             PRIMARY,
3610             System.nanoTime(),
3611             autoGeneratedIdTimestamp,
3612             isRetry,
3613             UNASSIGNED_SEQ_NO,
3614             0
3615         );
3616         indexResult = engine.index(index);
3617         assertThat(indexResult.getVersion(), equalTo(1L));
3618         assertNotEquals(indexResult.getSeqNo(), UNASSIGNED_SEQ_NO);
3619         engine.refresh(&quot;test&quot;);
3620         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
3621             TopDocs topDocs = searcher.search(new MatchAllDocsQuery(), 10);
3622             assertEquals(1, topDocs.totalHits.value);
3623         }
3624         index = new Engine.Index(newUid(doc), doc, indexResult.getSeqNo(), index.primaryTerm(), indexResult.getVersion(),
3625                                  null, REPLICA, System.nanoTime(), autoGeneratedIdTimestamp, isRetry, UNASSIGNED_SEQ_NO, 0);
3626         indexResult = replicaEngine.index(index);
3627         assertThat(indexResult.getResultType(), equalTo(Engine.Result.Type.SUCCESS));
3628         replicaEngine.refresh(&quot;test&quot;);
3629         try (Engine.Searcher searcher = replicaEngine.acquireSearcher(&quot;test&quot;)) {
3630             TopDocs topDocs = searcher.search(new MatchAllDocsQuery(), 10);
3631             assertEquals(1, topDocs.totalHits.value);
3632         }
3633     }
3634     @Test
3635     public void testRetryWithAutogeneratedIdsAndWrongOrderWorksAndNoDuplicateDocs() throws IOException {
3636         final ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(),
3637                                                       new BytesArray(&quot;{}&quot;.getBytes(Charset.defaultCharset())), null);
3638         boolean isRetry = true;
3639         long autoGeneratedIdTimestamp = 0;
3640         Engine.Index firstIndexRequest = new Engine.Index(
3641             newUid(doc),
3642             doc,
3643             UNASSIGNED_SEQ_NO,
3644             1,
3645             randomBoolean() ? Versions.MATCH_DELETED : Versions.MATCH_ANY,
3646             VersionType.INTERNAL,
3647             PRIMARY,
3648             System.nanoTime(),
3649             autoGeneratedIdTimestamp,
3650             isRetry,
3651             UNASSIGNED_SEQ_NO,
3652             0
3653         );
3654         Engine.IndexResult result = engine.index(firstIndexRequest);
3655         assertThat(result.getVersion(), equalTo(1L));
3656         Engine.Index firstIndexRequestReplica = new Engine.Index(newUid(doc), doc, result.getSeqNo(), firstIndexRequest.primaryTerm(),
3657                                                                  result.getVersion(), null, REPLICA, System.nanoTime(), autoGeneratedIdTimestamp, isRetry, UNASSIGNED_SEQ_NO, 0);
3658         Engine.IndexResult indexReplicaResult = replicaEngine.index(firstIndexRequestReplica);
3659         assertThat(indexReplicaResult.getVersion(), equalTo(1L));
3660         isRetry = false;
3661         Engine.Index secondIndexRequest = new Engine.Index(
3662             newUid(doc),
3663             doc,
3664             UNASSIGNED_SEQ_NO,
3665             1,
3666             Versions.MATCH_DELETED,
3667             VersionType.INTERNAL,
3668             PRIMARY,
3669             System.nanoTime(),
3670             autoGeneratedIdTimestamp,
3671             isRetry,
3672             UNASSIGNED_SEQ_NO,
3673             0);
3674         Engine.IndexResult indexResult = engine.index(secondIndexRequest);
3675         assertFalse(indexResult.isCreated());
3676         engine.refresh(&quot;test&quot;);
3677         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
3678             TopDocs topDocs = searcher.search(new MatchAllDocsQuery(), 10);
3679             assertEquals(1, topDocs.totalHits.value);
3680         }
3681         Engine.Index secondIndexRequestReplica = new Engine.Index(newUid(doc), doc, result.getSeqNo(), secondIndexRequest.primaryTerm(),
3682                                                                   result.getVersion(), null, REPLICA, System.nanoTime(), autoGeneratedIdTimestamp, isRetry, UNASSIGNED_SEQ_NO, 0);
3683         replicaEngine.index(secondIndexRequestReplica);
3684         replicaEngine.refresh(&quot;test&quot;);
3685         try (Engine.Searcher searcher = replicaEngine.acquireSearcher(&quot;test&quot;)) {
3686             TopDocs topDocs = searcher.search(new MatchAllDocsQuery(), 10);
3687             assertEquals(1, topDocs.totalHits.value);
3688         }
3689     }
3690     public Engine.Index randomAppendOnly(ParsedDocument doc, boolean retry, final long autoGeneratedIdTimestamp) {
3691         if (randomBoolean()) {
3692             return appendOnlyPrimary(doc, retry, autoGeneratedIdTimestamp);
3693         } else {
3694             return appendOnlyReplica(doc, retry, autoGeneratedIdTimestamp, 0);
3695         }
3696     }
3697     public Engine.Index appendOnlyPrimary(ParsedDocument doc, boolean retry, final long autoGeneratedIdTimestamp, boolean create) {
3698         return new Engine.Index(newUid(doc), doc, UNASSIGNED_SEQ_NO, 1, create ? Versions.MATCH_DELETED : Versions.MATCH_ANY,
3699             VersionType.INTERNAL, Engine.Operation.Origin.PRIMARY, System.nanoTime(), autoGeneratedIdTimestamp, retry,
3700             UNASSIGNED_SEQ_NO, 0);
3701     }
3702     public Engine.Index appendOnlyPrimary(ParsedDocument doc, boolean retry, final long autoGeneratedIdTimestamp) {
3703         return appendOnlyPrimary(doc, retry, autoGeneratedIdTimestamp, randomBoolean());
3704     }
3705     public Engine.Index appendOnlyReplica(ParsedDocument doc, boolean retry, final long autoGeneratedIdTimestamp, final long seqNo) {
3706         return new Engine.Index(newUid(doc), doc, seqNo, 2, 1, null,
3707                                 Engine.Operation.Origin.REPLICA, System.nanoTime(), autoGeneratedIdTimestamp, retry, UNASSIGNED_SEQ_NO, 0);
3708     }
3709     @Test
3710     public void testAppendConcurrently() throws InterruptedException, IOException {
3711         Thread[] thread = new Thread[randomIntBetween(3, 5)];
3712         int numDocs = randomIntBetween(1000, 10000);
3713         assertEquals(0, engine.getNumVersionLookups());
3714         assertEquals(0, engine.getNumIndexVersionsLookups());
3715         boolean primary = randomBoolean();
3716         List&lt;Engine.Index&gt; docs = new ArrayList&lt;&gt;();
3717         for (int i = 0; i &lt; numDocs; i++) {
3718             final ParsedDocument doc = testParsedDocument(Integer.toString(i), null,
3719                 testDocumentWithTextField(), new BytesArray(&quot;{}&quot;.getBytes(Charset.defaultCharset())), null);
3720             Engine.Index index = primary ? appendOnlyPrimary(doc, false, i) : appendOnlyReplica(doc, false, i, i);
3721             docs.add(index);
3722         }
3723         Collections.shuffle(docs, random());
3724         CountDownLatch startGun = new CountDownLatch(thread.length);
3725         AtomicInteger offset = new AtomicInteger(-1);
3726         for (int i = 0; i &lt; thread.length; i++) {
3727             thread[i] = new Thread() {
3728                 @Override
3729                 public void run() {
3730                     startGun.countDown();
3731                     try {
3732                         startGun.await();
3733                     } catch (InterruptedException e) {
3734                         throw new AssertionError(e);
3735                     }
3736                     assertThat(engine.getVersionMap().values(), empty());
3737                     int docOffset;
3738                     while ((docOffset = offset.incrementAndGet()) &lt; docs.size()) {
3739                         try {
3740                             engine.index(docs.get(docOffset));
3741                         } catch (IOException e) {
3742                             throw new AssertionError(e);
3743                         }
3744                     }
3745                 }
3746             };
3747             thread[i].start();
3748         }
3749         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.INTERNAL)) {
3750             assertEquals(&quot;unexpected refresh&quot;, 0, searcher.getIndexReader().maxDoc());
3751         }
3752         for (int i = 0; i &lt; thread.length; i++) {
3753             thread[i].join();
3754         }
3755         engine.refresh(&quot;test&quot;);
3756         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
3757             int count = searcher.count(new MatchAllDocsQuery());
3758 <A NAME="22"></A>            assertEquals(docs.size(), count);
3759         }
3760         assertEquals(0, engine.getNumVersionLookups());
3761         <FONT color="#4cc417"><div style="position:absolute;left:0"><A
3762                 HREF="javascript:ZweiFrames('match306914-0.html#22',2,'match306914-top.html#22',1)"><IMG SRC="back.gif"
3763                                                                                                          ALT="other"
3764                                                                                                          BORDER="0"
3765                                                                                                          ALIGN="left"></A></div><B>assertEquals(0, engine.getNumIndexVersionsLookups());
3766         assertThat(engine.getMaxSeenAutoIdTimestamp(),
3767             equalTo(docs.stream().mapToLong(Engine.Index::getAutoGeneratedIdTimestamp).max().getAsLong()));
3768         assertLuceneOperations(engine, numDocs, 0, 0);
3769     }
3770     public static long getNumVersionLookups(InternalEngine engine) {         return engine.getNumVersionLookups();
3771     }
3772     public static long getNumI</B></FONT>ndexVersionsLookups(InternalEngine engine) {         return engine.getNumIndexVersionsLookups();
3773     }
3774     @Test
3775     public void testFailEngineOnRandomIO() throws IOException, InterruptedException {
3776         MockDirectoryWrapper wrapper = newMockDirectory();
3777         final Path translogPath = createTempDir(&quot;testFailEngineOnRandomIO&quot;);
3778         try (Store store = createStore(wrapper)) {
3779             CyclicBarrier join = new CyclicBarrier(2);
3780             CountDownLatch start = new CountDownLatch(1);
3781             AtomicInteger controller = new AtomicInteger(0);
3782             EngineConfig config = config(defaultSettings, store, translogPath, newMergePolicy(), new ReferenceManager.RefreshListener() {
3783                     @Override
3784                     public void beforeRefresh() throws IOException {
3785                     }
3786                     @Override
3787                     public void afterRefresh(boolean didRefresh) throws IOException {
3788                         int i = controller.incrementAndGet();
3789                         if (i == 1) {
3790                             throw new MockDirectoryWrapper.FakeIOException();
3791                         } else if (i == 2) {
3792                             try {
3793                                 start.await();
3794                             } catch (InterruptedException e) {
3795                                 throw new AssertionError(e);
3796                             }
3797                             throw new ElasticsearchException(&quot;something completely different&quot;);
3798                         }
3799                     }
3800                 });
3801             InternalEngine internalEngine = createEngine(config);
3802             int docId = 0;
3803             final ParsedDocument doc = testParsedDocument(Integer.toString(docId), null,
3804                                                           testDocumentWithTextField(), new BytesArray(&quot;{}&quot;.getBytes(Charset.defaultCharset())), null);
3805             Engine.Index index = randomBoolean() ? indexForDoc(doc) : randomAppendOnly(doc, false, docId);
3806             internalEngine.index(index);
3807             Runnable r = () -&gt;  {
3808                 try {
3809                     join.await();
3810                 } catch (Exception e) {
3811                     throw new AssertionError(e);
3812                 }
3813                 try {
3814                     internalEngine.refresh(&quot;test&quot;);
3815                     fail();
3816                 } catch (AlreadyClosedException ex) {
3817                     if (ex.getCause() != null) {
3818                         assertTrue(ex.toString(), ex.getCause() instanceof MockDirectoryWrapper.FakeIOException);
3819                     }
3820                 } catch (RefreshFailedEngineException ex) {
3821                 } finally {
3822                     start.countDown();
3823                 }
3824             };
3825             Thread t = new Thread(r);
3826             Thread t1 = new Thread(r);
3827             t.start();
3828             t1.start();
3829             t.join();
3830             t1.join();
3831             assertTrue(internalEngine.isClosed.get());
3832             assertTrue(internalEngine.failedEngine.get() instanceof MockDirectoryWrapper.FakeIOException);
3833         }
3834     }
3835 <A NAME="58"></A>
3836     @Test
3837     public void testSequenceIDs() throws Exception {
3838         Tuple&lt;Long, Long&gt; seqID = <FONT color="#f63526"><div style="position:absolute;left:0"><A
3839                 HREF="javascript:ZweiFrames('match306914-0.html#58',2,'match306914-top.html#58',1)"><IMG SRC="back.gif"
3840                                                                                                          ALT="other"
3841                                                                                                          BORDER="0"
3842                                                                                                          ALIGN="left"></A></div><B>getSequenceID(engine, new Engine.Get(&quot;type&quot;, newUid(&quot;1&quot;)));
3843         assertThat(seqID.v1(), equalTo(UNASSIGNED_SEQ_NO));
3844         assertThat(seqID.v2(), equalTo(0L));
3845         Document document = testDocumentWithTextField();
3846         document.add(new Field(SourceFieldMapper.NAME, BytesReference.toBytes</B></FONT>(B_1), SourceFieldMapper.Defaults.FIELD_TYPE));
3847         ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, document, B_1, null);
3848 <A NAME="54"></A>        engine.index(indexForDoc(doc));
3849         engine.refresh(&quot;test&quot;);
3850         <FONT color="#4e8975"><div style="position:absolute;left:0"><A
3851                 HREF="javascript:ZweiFrames('match306914-0.html#54',2,'match306914-top.html#54',1)"><IMG SRC="back.gif"
3852                                                                                                          ALT="other"
3853                                                                                                          BORDER="0"
3854                                                                                                          ALIGN="left"></A></div><B>seqID = getSequenceID(engine, newGet(doc));
3855         logger.info(&quot;--&gt; got seqID: {}&quot;, seqID);
3856         assertThat(seqID.v1(), equalTo(0L));
3857         assertThat(seqID.v2(), equalTo(primaryTerm.get()));
3858         document = testDocumentWithTextField();
3859         document.add</B></FONT>(new Field(SourceFieldMapper.NAME, BytesReference.toBytes(B_1), SourceFieldMapper.Defaults.FIELD_TYPE));
3860         doc = testParsedDocument(&quot;1&quot;, null, document, B_1, null);
3861         engine.index(indexForDoc(doc));
3862         engine.refresh(&quot;test&quot;);
3863         seqID = getSequenceID(engine, newGet(doc));
3864         logger.info(&quot;--&gt; got seqID: {}&quot;, seqID);
3865         assertThat(seqID.v1(), equalTo(1L));
3866         assertThat(seqID.v2(), equalTo(primaryTerm.get()));
3867         document = testDocumentWithTextField();
3868         document.add(new Field(SourceFieldMapper.NAME, BytesReference.toBytes(B_1), SourceFieldMapper.Defaults.FIELD_TYPE));
3869         doc = testParsedDocument(&quot;1&quot;, null, document, B_1, null);
3870         engine.index(new Engine.Index(newUid(doc), doc, UNASSIGNED_SEQ_NO, 3,
3871                                       Versions.MATCH_ANY, VersionType.INTERNAL, Engine.Operation.Origin.PRIMARY,
3872                                       System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0));
3873         engine.refresh(&quot;test&quot;);
3874         seqID = getSequenceID(engine, newGet(doc));
3875         logger.info(&quot;--&gt; got seqID: {}&quot;, seqID);
3876         assertThat(seqID.v1(), equalTo(2L));
3877 <A NAME="55"></A>        assertThat(seqID.v2(), equalTo(3L));
3878         Engine.Searcher searchResult = <FONT color="#4863a0"><div style="position:absolute;left:0"><A
3879                 HREF="javascript:ZweiFrames('match306914-0.html#55',2,'match306914-top.html#55',1)"><IMG SRC="back.gif"
3880                                                                                                          ALT="other"
3881                                                                                                          BORDER="0"
3882                                                                                                          ALIGN="left"></A></div><B>engine.acquireSearcher(&quot;test&quot;);
3883         MatcherAssert.assertThat(searchResult, EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(1));
3884         MatcherAssert.assertThat(searchResult,
3885                                  EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(LongPoint.newExactQuery(&quot;_seq_no&quot;, 2), 1));
3886         searchResult.close();
3887     }
3888     @Test
3889     public void testLookupSeqNoByIdInLucene() throws Exception {
3890         int numOps = between</B></FONT>(10, 100);
3891         long seqNo = 0;
3892         List&lt;Engine.Operation&gt; operations = new ArrayList&lt;&gt;(numOps);
3893         for (int i = 0; i &lt; numOps; i++) {
3894             String id = Integer.toString(between(1, 50));
3895             boolean isIndexing = randomBoolean();
3896             int copies = frequently() ? 1 : between(2, 4);
3897             for (int c = 0; c &lt; copies; c++) {
3898                 final ParsedDocument doc = EngineTestCase.createParsedDoc(id, null);
3899                 if (isIndexing) {
3900                     operations.add(new Engine.Index(EngineTestCase.newUid(doc), doc, seqNo, primaryTerm.get(),
3901                                                     i, null, Engine.Operation.Origin.REPLICA, threadPool.relativeTimeInMillis(), -1, true,  UNASSIGNED_SEQ_NO, 0L));
3902                 } else {
3903                     operations.add(new Engine.Delete(
3904                         doc.id(),
3905                         EngineTestCase.newUid(doc),
3906                         seqNo,
3907                         primaryTerm.get(),
3908                         i,
3909                         null,
3910                         Engine.Operation.Origin.REPLICA,
3911                         threadPool.relativeTimeInMillis(),
3912                         UNASSIGNED_SEQ_NO,
3913                         0L
3914                     ));
3915                 }
3916             }
3917             seqNo++;
3918             if (rarely()) {
3919                 seqNo++;
3920             }
3921         }
3922         Randomness.shuffle(operations);
3923         Settings.Builder settings = Settings.builder()
3924             .put(defaultSettings.getSettings())
3925             .put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), true);
3926         final IndexMetadata indexMetadata = IndexMetadata.builder(defaultSettings.getIndexMetadata()).settings(settings).build();
3927         final IndexSettings indexSettings = IndexSettingsModule.newIndexSettings(indexMetadata);
3928         Map&lt;String, Engine.Operation&gt; latestOps = new HashMap&lt;&gt;();         try (Store store = createStore();
3929              InternalEngine engine = createEngine(config(indexSettings, store, createTempDir(), newMergePolicy(), null))) {
3930             CheckedRunnable&lt;IOException&gt; lookupAndCheck = () -&gt; {
3931                 try (Searcher searcher = engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.INTERNAL)) {
3932                     Map&lt;String, Long&gt; liveOps = latestOps.entrySet().stream()
3933                         .filter(e -&gt; e.getValue().operationType() == Engine.Operation.TYPE.INDEX)
3934                         .collect(Collectors.toMap(e -&gt; e.getKey(), e -&gt; e.getValue().seqNo()));
3935                     assertThat(getDocIds(engine, true).stream().collect(Collectors.toMap(e -&gt; e.getId(), e -&gt; e.getSeqNo())),
3936                                equalTo(liveOps));
3937                     for (String id : latestOps.keySet()) {
3938                         String msg = &quot;latestOps=&quot; + latestOps + &quot; op=&quot; + id;
3939                         DocIdAndSeqNo docIdAndSeqNo = VersionsAndSeqNoResolver.loadDocIdAndSeqNo(searcher.getIndexReader(), newUid(id));
3940                         if (liveOps.containsKey(id) == false) {
3941                             assertNull(msg, docIdAndSeqNo);
3942                         } else {
3943                             assertNotNull(msg, docIdAndSeqNo);
3944                             assertThat(msg, docIdAndSeqNo.seqNo, equalTo(latestOps.get(id).seqNo()));
3945                         }
3946                     }
3947                     String notFoundId = randomValueOtherThanMany(liveOps::containsKey, () -&gt; Long.toString(randomNonNegativeLong()));
3948                     assertNull(VersionsAndSeqNoResolver.loadDocIdAndSeqNo(searcher.getIndexReader(), newUid(notFoundId)));
3949                 }
3950             };
3951             for (Engine.Operation op : operations) {
3952                 if (op instanceof Engine.Index) {
3953                     engine.index((Engine.Index) op);
3954                     if (latestOps.containsKey(op.id()) == false || latestOps.get(op.id()).seqNo() &lt; op.seqNo()) {
3955                         latestOps.put(op.id(), op);
3956                     }
3957                 } else if (op instanceof Engine.Delete) {
3958                     engine.delete((Engine.Delete) op);
3959                     if (latestOps.containsKey(op.id()) == false || latestOps.get(op.id()).seqNo() &lt; op.seqNo()) {
3960                         latestOps.put(op.id(), op);
3961                     }
3962                 }
3963                 if (randomInt(100) &lt; 10) {
3964                     engine.refresh(&quot;test&quot;);
3965                     lookupAndCheck.run();
3966                 }
3967                 if (rarely()) {
3968                     engine.flush(false, true);
3969                     lookupAndCheck.run();
3970                 }
3971             }
3972             engine.refresh(&quot;test&quot;);
3973             lookupAndCheck.run();
3974         }
3975     }
3976     private ToLongBiFunction&lt;Engine, Engine.Operation&gt; getStallingSeqNoGenerator(
3977         final AtomicReference&lt;CountDownLatch&gt; latchReference,
3978         final CyclicBarrier barrier,
3979         final AtomicBoolean stall,
3980         final AtomicLong expectedLocalCheckpoint) {
3981         return (engine, operation) -&gt; {
3982             final long seqNo = generateNewSeqNo(engine);
3983             final CountDownLatch latch = latchReference.get();
3984             if (stall.get()) {
3985                 try {
3986                     barrier.await();
3987                     latch.await();
3988                 } catch (BrokenBarrierException | InterruptedException e) {
3989                     throw new RuntimeException(e);
3990                 }
3991             } else {
3992                 if (expectedLocalCheckpoint.get() + 1 == seqNo) {
3993                     expectedLocalCheckpoint.set(seqNo);
3994                 }
3995             }
3996             return seqNo;
3997         };
3998     }
3999     @Test
4000     public void testSequenceNumberAdvancesToMaxSeqOnEngineOpenOnPrimary() throws BrokenBarrierException, InterruptedException, IOException {
4001         engine.close();
4002         final int docs = randomIntBetween(1, 32);
4003         InternalEngine initialEngine = null;
4004         try {
4005             final AtomicReference&lt;CountDownLatch&gt; latchReference = new AtomicReference&lt;&gt;(new CountDownLatch(1));
4006             final CyclicBarrier barrier = new CyclicBarrier(2);
4007             final AtomicBoolean stall = new AtomicBoolean();
4008             final AtomicLong expectedLocalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
4009             final List&lt;Thread&gt; threads = new ArrayList&lt;&gt;();
4010             initialEngine =
4011                 createEngine(defaultSettings, store, primaryTranslogDir,
4012                              newMergePolicy(), null, LocalCheckpointTracker::new, null,
4013                              getStallingSeqNoGenerator(latchReference, barrier, stall, expectedLocalCheckpoint));
4014             final InternalEngine finalInitialEngine = initialEngine;
4015             for (int i = 0; i &lt; docs; i++) {
4016                 final String id = Integer.toString(i);
4017                 final ParsedDocument doc = testParsedDocument(id, null, testDocumentWithTextField(), SOURCE, null);
4018                 stall.set(randomBoolean());
4019                 final Thread thread = new Thread(() -&gt; {
4020                     try {
4021                         finalInitialEngine.index(indexForDoc(doc));
4022                     } catch (IOException e) {
4023                         throw new AssertionError(e);
4024                     }
4025                 });
4026                 thread.start();
4027                 if (stall.get()) {
4028                     threads.add(thread);
4029                     barrier.await();
4030                 } else {
4031                     thread.join();
4032                 }
4033             }
4034             assertThat(initialEngine.getProcessedLocalCheckpoint(), equalTo(expectedLocalCheckpoint.get()));
4035             assertThat(initialEngine.getSeqNoStats(-1).getMaxSeqNo(), equalTo((long) (docs - 1)));
4036             initialEngine.flush(true, true);
4037             assertEquals(initialEngine.getProcessedLocalCheckpoint(), initialEngine.getPersistedLocalCheckpoint());
4038             latchReference.get().countDown();
4039             for (final Thread thread : threads) {
4040                 thread.join();
4041             }
4042         } finally {
4043             IOUtils.close(initialEngine);
4044         }
4045         try (var recoveringEngine = new InternalEngine(initialEngine.config())) {
4046             recoveringEngine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
4047             recoveringEngine.fillSeqNoGaps(2);
4048             assertEquals(recoveringEngine.getProcessedLocalCheckpoint(), recoveringEngine.getPersistedLocalCheckpoint());
4049             assertThat(recoveringEngine.getProcessedLocalCheckpoint(), greaterThanOrEqualTo((long) (docs - 1)));
4050         }
4051     }
4052     @Test
4053     public void testOutOfOrderSequenceNumbersWithVersionConflict() throws IOException {
4054         final List&lt;Engine.Operation&gt; operations = new ArrayList&lt;&gt;();
4055         final int numberOfOperations = randomIntBetween(16, 32);
4056         final AtomicLong sequenceNumber = new AtomicLong();
4057         final Engine.Operation.Origin origin = randomFrom(LOCAL_TRANSLOG_RECOVERY, PEER_RECOVERY, PRIMARY, REPLICA);
4058         final LongSupplier sequenceNumberSupplier =
4059             origin == PRIMARY ? () -&gt; UNASSIGNED_SEQ_NO : sequenceNumber::getAndIncrement;
4060         final Supplier&lt;ParsedDocument&gt; doc = () -&gt; {
4061             final Document document = testDocumentWithTextField();
4062             document.add(new Field(SourceFieldMapper.NAME, BytesReference.toBytes(B_1), SourceFieldMapper.Defaults.FIELD_TYPE));
4063             return testParsedDocument(&quot;1&quot;, null, document, B_1, null);
4064         };
4065         final Term uid = newUid(&quot;1&quot;);
4066         final BiFunction&lt;String, Engine.SearcherScope, Searcher&gt; searcherFactory = engine::acquireSearcher;
4067         for (int i = 0; i &lt; numberOfOperations; i++) {
4068             if (randomBoolean()) {
4069                 final Engine.Index index = new Engine.Index(
4070                     uid,
4071                     doc.get(),
4072                     sequenceNumberSupplier.getAsLong(),
4073                     1,
4074                     i,
4075                     origin == PRIMARY ? VersionType.EXTERNAL : null,
4076                     origin,
4077                     System.nanoTime(),
4078                     Translog.UNSET_AUTO_GENERATED_TIMESTAMP,
4079                     false, UNASSIGNED_SEQ_NO, 0);
4080                 operations.add(index);
4081             } else {
4082                 final Engine.Delete delete = new Engine.Delete(
4083                     &quot;1&quot;,
4084                     uid,
4085                     sequenceNumberSupplier.getAsLong(),
4086                     1,
4087                     i,
4088                     origin == PRIMARY ? VersionType.EXTERNAL : null,
4089                     origin,
4090                     System.nanoTime(), UNASSIGNED_SEQ_NO, 0);
4091                 operations.add(delete);
4092             }
4093         }
4094         final boolean exists = operations.get(operations.size() - 1) instanceof Engine.Index;
4095         Randomness.shuffle(operations);
4096         for (final Engine.Operation operation : operations) {
4097             if (operation instanceof Engine.Index) {
4098                 engine.index((Engine.Index) operation);
4099             } else {
4100                 engine.delete((Engine.Delete) operation);
4101             }
4102         }
4103         final long expectedLocalCheckpoint;
4104         if (origin == PRIMARY) {
4105             int count = 0;
4106             long version = -1;
4107             for (int i = 0; i &lt; numberOfOperations; i++) {
4108                 if (operations.get(i).version() &gt;= version) {
4109                     count++;
4110                     version = operations.get(i).version();
4111                 }
4112             }
4113             expectedLocalCheckpoint = count - 1;
4114         } else {
4115             expectedLocalCheckpoint = numberOfOperations - 1;
4116         }
4117         assertThat(engine.getProcessedLocalCheckpoint(), equalTo(expectedLocalCheckpoint));
4118         try (Engine.GetResult result = engine.get(new Engine.Get(&quot;2&quot;, uid), searcherFactory)) {
4119             assertThat(result.docIdAndVersion() != null, equalTo(exists));
4120         }
4121     }
4122     public void testVersionConflictIgnoreDeletedDoc() throws IOException {
4123         ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocument(),
4124             new BytesArray(&quot;{}&quot;.getBytes(Charset.defaultCharset())), null);
4125         engine.delete(new Engine.Delete(&quot;1&quot;, newUid(&quot;1&quot;), 1));
4126         for (long seqNo : new long[]{0, 1, randomNonNegativeLong()}) {
4127             assertDeletedVersionConflict(engine.index(new Engine.Index(newUid(&quot;1&quot;), doc, UNASSIGNED_SEQ_NO, 1,
4128                     Versions.MATCH_ANY, VersionType.INTERNAL,
4129                     PRIMARY, randomNonNegativeLong(), UNSET_AUTO_GENERATED_TIMESTAMP, false, seqNo, 1)),
4130                 &quot;update: &quot; + seqNo);
4131             assertDeletedVersionConflict(engine.delete(new Engine.Delete(&quot;1&quot;, newUid(&quot;1&quot;), UNASSIGNED_SEQ_NO, 1,
4132                     Versions.MATCH_ANY, VersionType.INTERNAL, PRIMARY, randomNonNegativeLong(), seqNo, 1)),
4133                 &quot;delete: &quot; + seqNo);
4134         }
4135     }
4136     private void assertDeletedVersionConflict(Engine.Result result, String operation) {
4137         assertNotNull(&quot;Must have failure for &quot; + operation, result.getFailure());
4138         assertThat(operation, result.getFailure(), Matchers.instanceOf(VersionConflictEngineException.class));
4139         VersionConflictEngineException exception = (VersionConflictEngineException) result.getFailure();
4140         assertThat(operation, exception.getMessage(), containsString(&quot;but no document was found&quot;));
4141     }
4142     @Test
4143     public void testNoOps() throws IOException {
4144         engine.close();
4145         InternalEngine noOpEngine = null;
4146         final int maxSeqNo = randomIntBetween(0, 128);
4147         final int localCheckpoint = randomIntBetween(0, maxSeqNo);
4148         try {
4149             final BiFunction&lt;Long, Long, LocalCheckpointTracker&gt; supplier = (ms, lcp) -&gt; new LocalCheckpointTracker(
4150                 maxSeqNo,
4151                 localCheckpoint);
4152             EngineConfig noopEngineConfig = copy(engine.config(), new SoftDeletesRetentionMergePolicy(Lucene.SOFT_DELETES_FIELD,
4153                                                                                                       () -&gt; new MatchAllDocsQuery(), engine.config().getMergePolicy()));
4154             noOpEngine = new InternalEngine(noopEngineConfig, supplier) {
4155                 @Override
4156                 protected long doGenerateSeqNoForOperation(Operation operation) {
4157                     throw new UnsupportedOperationException();
4158                 }
4159             };
4160 <A NAME="41"></A>            noOpEngine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
4161             final int gapsFilled = noOpEngine.fillSeqNoGaps(primaryTerm.get());
4162             final String reason = &quot;filling gaps&quot;;
4163             noOpEngine.noOp(new Engine.NoOp(maxSeqNo + 1, <FONT color="#f87a17"><div style="position:absolute;left:0"><A
4164                 HREF="javascript:ZweiFrames('match306914-0.html#41',2,'match306914-top.html#41',1)"><IMG SRC="back.gif"
4165                                                                                                          ALT="other"
4166                                                                                                          BORDER="0"
4167                                                                                                          ALIGN="left"></A></div><B>primaryTerm.get(), LOCAL_TRANSLOG_RECOVERY, System.nanoTime(), reason));
4168             assertThat(noOpEngine.getProcessedLocalCheckpoint(), equalTo((long) (maxSeqNo + 1)));
4169             assertThat(noOpEngine.getTranslog().stats().getUncommittedOperations(), equalTo(gapsFilled));
4170             noOpEngine.noOp(
4171                 new Engine.NoOp(maxSeqNo + 2, primaryTerm.get(),
4172                     randomFrom(PRIMARY, REPLICA, PEER_RECOVERY), System.nanoTime(), reason));
4173             assertThat(noOpEngine.getProcessedLocalCheckpoint</B></FONT>(), equalTo((long) (maxSeqNo + 2)));
4174             assertThat(noOpEngine.getTranslog().stats().getUncommittedOperations(), equalTo(gapsFilled + 1));
4175             Translog.Operation op;
4176             Translog.Operation last = null;
4177             try (Translog.Snapshot snapshot = noOpEngine.getTranslog().newSnapshot()) {
4178                 while ((op = snapshot.next()) != null) {
4179                     last = op;
4180                 }
4181             }
4182             assertNotNull(last);
4183             assertThat(last, instanceOf(Translog.NoOp.class));
4184             final Translog.NoOp noOp = (Translog.NoOp) last;
4185             assertThat(noOp.seqNo(), equalTo((long) (maxSeqNo + 2)));
4186             assertThat(noOp.primaryTerm(), equalTo(primaryTerm.get()));
4187             assertThat(noOp.reason(), equalTo(reason));
4188             if (engine.engineConfig.getIndexSettings().isSoftDeleteEnabled()) {
4189                 MapperService mapperService = createMapperService(&quot;test&quot;);
4190                 List&lt;Translog.Operation&gt; operationsFromLucene = readAllOperationsInLucene(noOpEngine, mapperService);
4191                 assertThat(operationsFromLucene, hasSize(maxSeqNo + 2 - localCheckpoint));                 for (int i = 0; i &lt; operationsFromLucene.size(); i++) {
4192                     assertThat(operationsFromLucene.get(i),
4193                                equalTo(new Translog.NoOp(localCheckpoint + 1 + i, primaryTerm.get(), &quot;filling gaps&quot;)));
4194                 }
4195                 assertConsistentHistoryBetweenTranslogAndLuceneIndex(noOpEngine, mapperService);
4196             }
4197         } finally {
4198             IOUtils.close(noOpEngine);
4199         }
4200     }
4201     @Test
4202     public void testSegmentContainsOnlyNoOps() throws Exception {
4203         Engine.NoOpResult noOpResult = engine.noOp(new Engine.NoOp(1, primaryTerm.get(),
4204 <A NAME="51"></A>                                                                   randomFrom(Engine.Operation.Origin.values()), randomNonNegativeLong(), &quot;test&quot;));
4205         assertThat(noOpResult.getFailure(), nullValue());
4206         engine.refresh(&quot;test&quot;);
4207         <FONT color="#b38481"><div style="position:absolute;left:0"><A
4208                 HREF="javascript:ZweiFrames('match306914-0.html#51',2,'match306914-top.html#51',1)"><IMG SRC="back.gif"
4209                                                                                                          ALT="other"
4210                                                                                                          BORDER="0"
4211                                                                                                          ALIGN="left"></A></div><B>Engine.DeleteResult deleteResult = engine.delete(replicaDeleteForDoc(&quot;id&quot;, 1, 2, randomNonNegativeLong()));
4212         assertThat(deleteResult.getFailure(), nullValue());
4213         engine.refresh(&quot;test&quot;);
4214     }
4215     @Test
4216     public void testRandomOperations() throws Exception {
4217         int numOps = between(10, 100)</B></FONT>;
4218         for (int i = 0; i &lt; numOps; i++) {
4219             String id = Integer.toString(randomIntBetween(1, 10));
4220             ParsedDocument doc = createParsedDoc(id, null);
4221             Engine.Operation.TYPE type = randomFrom(Engine.Operation.TYPE.values());
4222             switch (type) {
4223                 case INDEX:
4224                     Engine.IndexResult index = engine.index(replicaIndexForDoc(doc, between(1, 100), i, randomBoolean()));
4225                     assertThat(index.getFailure(), nullValue());
4226                     break;
4227                 case DELETE:
4228                     Engine.DeleteResult delete = engine.delete(replicaDeleteForDoc(doc.id(), between(1, 100), i, randomNonNegativeLong()));
4229                     assertThat(delete.getFailure(), nullValue());
4230                     break;
4231                 case NO_OP:
4232                     Engine.NoOpResult noOp = engine.noOp(new Engine.NoOp(i, primaryTerm.get(),
4233                                                                          randomFrom(Engine.Operation.Origin.values()), randomNonNegativeLong(), &quot;&quot;));
4234                     assertThat(noOp.getFailure(), nullValue());
4235                     break;
4236                 default:
4237                     throw new IllegalStateException(&quot;Invalid op [&quot; + type + &quot;]&quot;);
4238             }
4239             if (randomBoolean()) {
4240                 engine.refresh(&quot;test&quot;);
4241             }
4242             if (randomBoolean()) {
4243                 engine.flush();
4244             }
4245             if (randomBoolean()) {
4246                 engine.forceMerge(randomBoolean(), between(1, 10), randomBoolean(), false, false, UUIDs.randomBase64UUID());
4247             }
4248         }
4249         if (engine.engineConfig.getIndexSettings().isSoftDeleteEnabled()) {
4250             List&lt;Translog.Operation&gt; operations = readAllOperationsInLucene(engine, createMapperService(&quot;test&quot;));
4251             assertThat(operations, hasSize(numOps));
4252         }
4253     }
4254     @Test
4255     public void testMinGenerationForSeqNo() throws IOException, BrokenBarrierException, InterruptedException {
4256         engine.close();
4257         final int numberOfTriplets = randomIntBetween(1, 32);
4258         InternalEngine actualEngine = null;
4259         try {
4260             final AtomicReference&lt;CountDownLatch&gt; latchReference = new AtomicReference&lt;&gt;();
4261             final CyclicBarrier barrier = new CyclicBarrier(2);
4262             final AtomicBoolean stall = new AtomicBoolean();
4263             final AtomicLong expectedLocalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
4264             final Map&lt;Thread, CountDownLatch&gt; threads = new LinkedHashMap&lt;&gt;();
4265             actualEngine =
4266                 createEngine(defaultSettings, store, primaryTranslogDir,
4267                              newMergePolicy(), null, LocalCheckpointTracker::new, null,
4268                              getStallingSeqNoGenerator(latchReference, barrier, stall, expectedLocalCheckpoint));
4269             final InternalEngine finalActualEngine = actualEngine;
4270             final Translog translog = finalActualEngine.getTranslog();
4271             final long generation = finalActualEngine.getTranslog().currentFileGeneration();
4272             for (int i = 0; i &lt; numberOfTriplets; i++) {
4273                 stall.set(false);
4274                 index(finalActualEngine, 3 * i);
4275                 final CountDownLatch latch = new CountDownLatch(1);
4276                 latchReference.set(latch);
4277                 final int skipId = 3 * i + 1;
4278                 stall.set(true);
4279                 final Thread thread = new Thread(() -&gt; {
4280                     try {
4281                         index(finalActualEngine, skipId);
4282                     } catch (IOException e) {
4283                         throw new AssertionError(e);
4284                     }
4285                 });
4286                 thread.start();
4287                 threads.put(thread, latch);
4288                 barrier.await();
4289                 stall.set(false);
4290                 index(finalActualEngine, 3 * i + 2);
4291                 finalActualEngine.flush();
4292                 assertThat(translog.getMinGenerationForSeqNo(3 * i + 1).translogFileGeneration, equalTo(i + generation));
4293             }
4294             int i = 0;
4295             for (final Map.Entry&lt;Thread, CountDownLatch&gt; entry : threads.entrySet()) {
4296                 final Map&lt;String, String&gt; userData = finalActualEngine.commitStats().getUserData();
4297                 assertThat(userData.get(SequenceNumbers.LOCAL_CHECKPOINT_KEY), equalTo(Long.toString(3 * i)));
4298                 entry.getValue().countDown();
4299                 entry.getKey().join();
4300                 finalActualEngine.flush();
4301                 i++;
4302             }
4303         } finally {
4304             IOUtils.close(actualEngine);
4305         }
4306     }
4307     private void index(final InternalEngine engine, final int id) throws IOException {
4308         final String docId = Integer.toString(id);
4309         final ParsedDocument doc =
4310             testParsedDocument(docId, null, testDocumentWithTextField(), SOURCE, null);
4311         engine.index(indexForDoc(doc));
4312     }
4313     private Tuple&lt;Long, Long&gt; getSequenceID(Engine engine, Engine.Get get) throws EngineException {
4314         try (Searcher searcher = engine.acquireSearcher(&quot;get&quot;, Engine.SearcherScope.INTERNAL)) {
4315             final long primaryTerm;
4316             final long seqNo;
4317             DocIdAndSeqNo docIdAndSeqNo = VersionsAndSeqNoResolver.loadDocIdAndSeqNo(searcher.getIndexReader(), get.uid());
4318             if (docIdAndSeqNo == null) {
4319                 primaryTerm = 0;
4320                 seqNo = UNASSIGNED_SEQ_NO;
4321             } else {
4322                 seqNo = docIdAndSeqNo.seqNo;
4323                 NumericDocValues primaryTerms = docIdAndSeqNo.context.reader().getNumericDocValues(SeqNoFieldMapper.PRIMARY_TERM_NAME);
4324                 if (primaryTerms == null || primaryTerms.advanceExact(docIdAndSeqNo.docId) == false) {
4325                     throw new AssertionError(&quot;document does not have primary term [&quot; + docIdAndSeqNo.docId + &quot;]&quot;);
4326                 }
4327                 primaryTerm = primaryTerms.longValue();
4328             }
4329             return new Tuple&lt;&gt;(seqNo, primaryTerm);
4330         } catch (Exception e) {
4331             throw new EngineException(shardId, &quot;unable to retrieve sequence id&quot;, e);
4332         }
4333     }
4334     @Test
4335     public void testRestoreLocalHistoryFromTranslog() throws IOException {
4336         final AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
4337         try (Store store = createStore()) {
4338             final ArrayList&lt;Long&gt; seqNos = new ArrayList&lt;&gt;();
4339             final int numOps = randomIntBetween(0, 1024);
4340             for (int i = 0; i &lt; numOps; i++) {
4341                 if (rarely()) {
4342                     continue;
4343                 }
4344                 seqNos.add((long) i);
4345             }
4346             Randomness.shuffle(seqNos);
4347             final EngineConfig engineConfig;
4348             final SeqNoStats prevSeqNoStats;
4349             final List&lt;DocIdSeqNoAndSource&gt; prevDocs;
4350             try (InternalEngine engine = createEngine(store, createTempDir(), globalCheckpoint::get)) {
4351                 engineConfig = engine.config();
4352                 for (final long seqNo : seqNos) {
4353                     final String id = Long.toString(seqNo);
4354                     final ParsedDocument doc = testParsedDocument(id, null,
4355                                                                   testDocumentWithTextField(), SOURCE, null);
4356                     engine.index(replicaIndexForDoc(doc, 1, seqNo, false));
4357                     if (rarely()) {
4358                         engine.rollTranslogGeneration();
4359                     }
4360                     if (rarely()) {
4361                         engine.flush();
4362                     }
4363                 }
4364                 globalCheckpoint.set(randomLongBetween(SequenceNumbers.NO_OPS_PERFORMED, engine.getPersistedLocalCheckpoint()));
4365                 engine.syncTranslog();
4366                 prevSeqNoStats = engine.getSeqNoStats(globalCheckpoint.get());
4367                 prevDocs = getDocIds(engine, true);
4368 <A NAME="20"></A>            }
4369             try (InternalEngine engine = new InternalEngine(engineConfig)) {
4370                 final long currentTranslogGeneration = engine.getTranslog().currentFileGeneration();
4371                 engine.recoverFromTranslog(translogHandler, <FONT color="#4e9258"><div style="position:absolute;left:0"><A
4372                 HREF="javascript:ZweiFrames('match306914-0.html#20',2,'match306914-top.html#20',1)"><IMG SRC="back.gif"
4373                                                                                                          ALT="other"
4374                                                                                                          BORDER="0"
4375                                                                                                          ALIGN="left"></A></div><B>globalCheckpoint.get());
4376                 engine.restoreLocalHistoryFromTranslog(translogHandler);
4377                 assertThat(getDocIds(engine, true), equalTo(prevDocs));
4378                 SeqNoStats seqNoStats = engine.getSeqNoStats(globalCheckpoint.get());
4379                 assertThat(seqNoStats.getLocalCheckpoint(), equalTo(prevSeqNoStats.getLocalCheckpoint()));
4380                 assertThat(seqNoStats.getMaxSeqNo(), equalTo(prevSeqNoStats.getMaxSeqNo()));
4381                 assertThat(&quot;restore from local translog must not add operations to translog&quot;,
4382                            engine.getTranslog().totalOperationsByMinGen(currentTranslogGeneration), equalTo</B></FONT>(0));
4383             }
4384             assertConsistentHistoryBetweenTranslogAndLuceneIndex(engine, createMapperService(&quot;test&quot;));
4385         }
4386     }
4387     @Test
4388     public void testFillUpSequenceIdGapsOnRecovery() throws IOException {
4389         final int docs = randomIntBetween(1, 32);
4390         int numDocsOnReplica = 0;
4391         long maxSeqIDOnReplica = -1;
4392         long checkpointOnReplica;
4393         try {
4394             for (int i = 0; i &lt; docs; i++) {
4395                 final String docId = Integer.toString(i);
4396                 final ParsedDocument doc =
4397                     testParsedDocument(docId, null, testDocumentWithTextField(), SOURCE, null);
4398                 Engine.Index primaryResponse = indexForDoc(doc);
4399                 Engine.IndexResult indexResult = engine.index(primaryResponse);
4400                 if (randomBoolean()) {
4401                     numDocsOnReplica++;
4402                     maxSeqIDOnReplica = indexResult.getSeqNo();
4403                     replicaEngine.index(replicaIndexForDoc(doc, 1, indexResult.getSeqNo(), false));
4404                 }
4405             }
4406             engine.syncTranslog();             replicaEngine.syncTranslog();             checkpointOnReplica = replicaEngine.getProcessedLocalCheckpoint();
4407         } finally {
4408             IOUtils.close(replicaEngine);
4409         }
4410         boolean flushed = false;
4411         AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
4412         InternalEngine recoveringEngine = null;
4413         try {
4414             assertEquals(docs - 1, engine.getSeqNoStats(-1).getMaxSeqNo());
4415 <A NAME="48"></A>            assertEquals(docs - 1, engine.getProcessedLocalCheckpoint());
4416             assertEquals(maxSeqIDOnReplica, replicaEngine.getSeqNoStats(-1).getMaxSeqNo());
4417             assertEquals(checkpointOnReplica, replicaEngine.getProcessedLocalCheckpoint());
4418             recoveringEngine = <FONT color="#c57726"><div style="position:absolute;left:0"><A
4419                 HREF="javascript:ZweiFrames('match306914-0.html#48',2,'match306914-top.html#48',1)"><IMG SRC="back.gif"
4420                                                                                                          ALT="other"
4421                                                                                                          BORDER="0"
4422                                                                                                          ALIGN="left"></A></div><B>new InternalEngine(copy(replicaEngine.config(), globalCheckpoint::get));
4423             assertEquals(numDocsOnReplica, getTranslog(recoveringEngine).stats().getUncommittedOperations());
4424             recoveringEngine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
4425             assertEquals(maxSeqIDOnReplica, recoveringEngine.getSeqNoStats(-1).getMaxSeqNo());
4426             assertEquals(checkpointOnReplica, recoveringEngine.getProcessedLocalCheckpoint());
4427             assertEquals((maxSeqIDOnReplica + 1) - numDocsOnReplica, recoveringEngine.fillSeqNoGaps</B></FONT>(2));
4428             try (Translog.Snapshot snapshot = getTranslog(recoveringEngine).newSnapshot()) {
4429                 assertTrue((maxSeqIDOnReplica + 1) - numDocsOnReplica &lt;= snapshot.totalOperations());
4430                 Translog.Operation operation;
4431                 while ((operation = snapshot.next()) != null) {
4432                     if (operation.opType() == Translog.Operation.Type.NO_OP) {
4433                         assertEquals(2, operation.primaryTerm());
4434                     } else {
4435                         assertEquals(primaryTerm.get(), operation.primaryTerm());
4436                     }
4437                 }
4438                 assertEquals(maxSeqIDOnReplica, recoveringEngine.getSeqNoStats(-1).getMaxSeqNo());
4439                 assertEquals(maxSeqIDOnReplica, recoveringEngine.getProcessedLocalCheckpoint());
4440                 if ((flushed = randomBoolean())) {
4441                     globalCheckpoint.set(recoveringEngine.getSeqNoStats(-1).getMaxSeqNo());
4442                     getTranslog(recoveringEngine).sync();
4443                     recoveringEngine.flush(true, true);
4444                 }
4445             }
4446         } finally {
4447             IOUtils.close(recoveringEngine);
4448         }
4449         try {
4450             recoveringEngine = new InternalEngine(copy(replicaEngine.config(), globalCheckpoint::get));
4451             if (flushed) {
4452                 assertThat(recoveringEngine.getTranslogStats().getUncommittedOperations(), equalTo(0));
4453             }
4454             recoveringEngine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
4455             assertEquals(maxSeqIDOnReplica, recoveringEngine.getSeqNoStats(-1).getMaxSeqNo());
4456             assertEquals(maxSeqIDOnReplica, recoveringEngine.getProcessedLocalCheckpoint());
4457             assertEquals(0, recoveringEngine.fillSeqNoGaps(3));
4458             assertEquals(maxSeqIDOnReplica, recoveringEngine.getSeqNoStats(-1).getMaxSeqNo());
4459             assertEquals(maxSeqIDOnReplica, recoveringEngine.getProcessedLocalCheckpoint());
4460         } finally {
4461             IOUtils.close(recoveringEngine);
4462         }
4463     }
4464     public void assertSameReader(Searcher left, Searcher right) {
4465         List&lt;LeafReaderContext&gt; leftLeaves = ElasticsearchDirectoryReader.unwrap(left.getDirectoryReader()).leaves();
4466         List&lt;LeafReaderContext&gt; rightLeaves = ElasticsearchDirectoryReader.unwrap(right.getDirectoryReader()).leaves();
4467         assertEquals(rightLeaves.size(), leftLeaves.size());
4468         for (int i = 0; i &lt; leftLeaves.size(); i++) {
4469             assertSame(leftLeaves.get(i).reader(), rightLeaves.get(i).reader());
4470         }
4471     }
4472     public void assertNotSameReader(Searcher left, Searcher right) {
4473         List&lt;LeafReaderContext&gt; leftLeaves = ElasticsearchDirectoryReader.unwrap(left.getDirectoryReader()).leaves();
4474         List&lt;LeafReaderContext&gt; rightLeaves = ElasticsearchDirectoryReader.unwrap(right.getDirectoryReader()).leaves();
4475         if (rightLeaves.size() == leftLeaves.size()) {
4476             for (int i = 0; i &lt; leftLeaves.size(); i++) {
4477                 if (leftLeaves.get(i).reader() != rightLeaves.get(i).reader()) {
4478                     return;                 }
4479             }
4480             fail(&quot;readers are same&quot;);
4481         }
4482     }
4483     @Test
4484     public void testRefreshScopedSearcher() throws IOException {
4485         try (Store store = createStore();
4486              InternalEngine engine =
4487                  createEngine(defaultSettings, store, createTempDir(), NoMergePolicy.INSTANCE)) {
4488             engine.refresh(&quot;warm_up&quot;);
4489             try (Searcher getSearcher = engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.INTERNAL);
4490                  Searcher searchSearcher = engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.EXTERNAL)) {
4491                 assertSameReader(getSearcher, searchSearcher);
4492             }
4493             for (int i = 0; i &lt; 10; i++) {
4494                 final String docId = Integer.toString(i);
4495                 final ParsedDocument doc =
4496                     testParsedDocument(docId, null, testDocumentWithTextField(), SOURCE, null);
4497                 Engine.Index primaryResponse = indexForDoc(doc);
4498                 engine.index(primaryResponse);
4499             }
4500             assertTrue(engine.refreshNeeded());
4501             engine.refresh(&quot;test&quot;, Engine.SearcherScope.INTERNAL, true);
4502             try (Searcher getSearcher = engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.INTERNAL);
4503                  Searcher searchSearcher = engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.EXTERNAL)) {
4504                 assertEquals(10, getSearcher.getIndexReader().numDocs());
4505                 assertEquals(0, searchSearcher.getIndexReader().numDocs());
4506                 assertNotSameReader(getSearcher, searchSearcher);
4507             }
4508             engine.refresh(&quot;test&quot;, Engine.SearcherScope.EXTERNAL, true);
4509             try (Searcher getSearcher = engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.INTERNAL);
4510                  Searcher searchSearcher = engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.EXTERNAL)) {
4511                 assertEquals(10, getSearcher.getIndexReader().numDocs());
4512                 assertEquals(10, searchSearcher.getIndexReader().numDocs());
4513                 assertSameReader(getSearcher, searchSearcher);
4514             }
4515             final String docId = Integer.toString(10);
4516             final ParsedDocument doc =
4517                 testParsedDocument(docId, null, testDocumentWithTextField(), SOURCE, null);
4518             Engine.Index primaryResponse = indexForDoc(doc);
4519             engine.index(primaryResponse);
4520             engine.refresh(&quot;test&quot;, Engine.SearcherScope.EXTERNAL, true);
4521             try (Searcher getSearcher = engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.INTERNAL);
4522                  Searcher searchSearcher = engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.EXTERNAL)) {
4523                 assertEquals(11, getSearcher.getIndexReader().numDocs());
4524                 assertEquals(11, searchSearcher.getIndexReader().numDocs());
4525                 assertSameReader(getSearcher, searchSearcher);
4526             }
4527             try (Searcher searcher = engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.INTERNAL)) {
4528                 engine.refresh(&quot;test&quot;, Engine.SearcherScope.INTERNAL, true);
4529                 try (Searcher nextSearcher = engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.INTERNAL)) {
4530                     assertSame(searcher.getIndexReader(), nextSearcher.getIndexReader());
4531                 }
4532             }
4533             try (Searcher searcher = engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.EXTERNAL)) {
4534                 engine.refresh(&quot;test&quot;, Engine.SearcherScope.EXTERNAL, true);
4535                 try (Searcher nextSearcher = engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.EXTERNAL)) {
4536                     assertSame(searcher.getIndexReader(), nextSearcher.getIndexReader());
4537                 }
4538             }
4539         }
4540     }
4541     @Test
4542     public void testSeqNoGenerator() throws IOException {
4543         engine.close();
4544         final long seqNo = randomIntBetween(Math.toIntExact(SequenceNumbers.NO_OPS_PERFORMED), Integer.MAX_VALUE);
4545         final BiFunction&lt;Long, Long, LocalCheckpointTracker&gt; localCheckpointTrackerSupplier = (ms, lcp) -&gt; new LocalCheckpointTracker(
4546             SequenceNumbers.NO_OPS_PERFORMED,
4547             SequenceNumbers.NO_OPS_PERFORMED);
4548         final AtomicLong seqNoGenerator = new AtomicLong(seqNo);
4549         try (Engine e = createEngine(defaultSettings, store, primaryTranslogDir,
4550                                      newMergePolicy(), null, localCheckpointTrackerSupplier,
4551                                      null, (engine, operation) -&gt; seqNoGenerator.getAndIncrement())) {
4552             final String id = &quot;id&quot;;
4553             final Field uidField = new Field(&quot;_id&quot;, id, IdFieldMapper.Defaults.FIELD_TYPE);
4554             final Field versionField = new NumericDocValuesField(&quot;_version&quot;, 0);
4555             final SeqNoFieldMapper.SequenceIDFields seqID = SeqNoFieldMapper.SequenceIDFields.emptySeqID();
4556             final ParseContext.Document document = new ParseContext.Document();
4557             document.add(uidField);
4558             document.add(versionField);
4559             document.add(seqID.seqNo);
4560             document.add(seqID.seqNoDocValue);
4561             document.add(seqID.primaryTerm);
4562             final BytesReference source = new BytesArray(new byte[]{1});
4563             final ParsedDocument parsedDocument = new ParsedDocument(
4564                 versionField,
4565                 seqID,
4566                 id,
4567                 &quot;routing&quot;,
4568                 Collections.singletonList(document),
4569                 source,
4570                 null);
4571             final Engine.Index index = new Engine.Index(
4572                 new Term(&quot;_id&quot;, parsedDocument.id()),
4573                 parsedDocument,
4574                 UNASSIGNED_SEQ_NO,
4575                 randomIntBetween(1, 8),
4576                 Versions.NOT_FOUND,
4577                 VersionType.INTERNAL,
4578                 Engine.Operation.Origin.PRIMARY,
4579                 System.nanoTime(),
4580                 -1,
4581                 randomBoolean(),
4582                 UNASSIGNED_SEQ_NO,
4583                 0);
4584             final Engine.IndexResult indexResult = e.index(index);
4585             assertThat(indexResult.getSeqNo(), equalTo(seqNo));
4586             assertThat(seqNoGenerator.get(), equalTo(seqNo + 1));
4587             final Engine.Delete delete = new Engine.Delete(
4588                 id,
4589                 new Term(&quot;_id&quot;, parsedDocument.id()),
4590                 UNASSIGNED_SEQ_NO,
4591                 randomIntBetween(1, 8),
4592                 Versions.MATCH_ANY,
4593                 VersionType.INTERNAL,
4594                 Engine.Operation.Origin.PRIMARY,
4595                 System.nanoTime(),
4596                 UNASSIGNED_SEQ_NO,
4597                 0);
4598             final Engine.DeleteResult deleteResult = e.delete(delete);
4599             assertThat(deleteResult.getSeqNo(), equalTo(seqNo + 1));
4600             assertThat(seqNoGenerator.get(), equalTo(seqNo + 2));
4601         }
4602     }
4603 <A NAME="19"></A>    @Test
4604     public void testKeepTranslogAfterGlobalCheckpoint() throws Exception {
4605         IOUtils.close(engine, store);
4606         final IndexSettings indexSettings = new IndexSettings(<FONT color="#f62817"><div
4607                 style="position:absolute;left:0"><A
4608                 HREF="javascript:ZweiFrames('match306914-0.html#19',2,'match306914-top.html#19',1)"><IMG SRC="back.gif"
4609                                                                                                          ALT="other"
4610                                                                                                          BORDER="0"
4611                                                                                                          ALIGN="left"></A></div><B>defaultSettings.getIndexMetadata(), defaultSettings.getNodeSettings(),
4612                                                               defaultSettings.getScopedSettings());
4613         IndexMetadata.Builder builder = IndexMetadata.builder(indexSettings.getIndexMetadata())
4614             .settings(Settings.builder().put(indexSettings.getSettings())
4615                           .put(IndexSettings.INDEX_TRANSLOG_RETENTION_AGE_SETTING.getKey(), randomFrom(&quot;-1&quot;, &quot;100micros&quot;, &quot;30m&quot;))
4616                           .put(IndexSettings.INDEX_TRANSLOG_RETENTION_SIZE_SETTING.getKey(), randomFrom(&quot;-1&quot;, &quot;512b&quot;, &quot;1gb&quot;)));
4617         indexSettings.updateIndexMetadata(builder.build());
4618         final Path translogPath = createTempDir</B></FONT>();
4619         store = createStore();
4620         final AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
4621         store.createEmpty(Version.CURRENT.luceneVersion);
4622         final String translogUUID = Translog.createEmptyTranslog(translogPath, globalCheckpoint.get(), shardId, primaryTerm.get());
4623         store.associateIndexWithNewTranslog(translogUUID);
4624         final EngineConfig engineConfig = config(indexSettings, store, translogPath,
4625                                                  NoMergePolicy.INSTANCE, null, null, () -&gt; globalCheckpoint.get());
4626         final AtomicLong lastSyncedGlobalCheckpointBeforeCommit = new AtomicLong(Translog.readGlobalCheckpoint(translogPath, translogUUID));
4627         try (InternalEngine engine = new InternalEngine(engineConfig) {
4628             @Override
4629             protected void commitIndexWriter(IndexWriter writer, Translog translog, String syncId) throws IOException {
4630                 lastSyncedGlobalCheckpointBeforeCommit.set(Translog.readGlobalCheckpoint(translogPath, translogUUID));
4631                 if (rarely()) {
4632                     globalCheckpoint.set(randomLongBetween(globalCheckpoint.get(), getPersistedLocalCheckpoint()));
4633                 }
4634                 super.commitIndexWriter(writer, translog, syncId);
4635             }
4636         }) {
4637             engine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
4638             int numDocs = scaledRandomIntBetween(10, 100);
4639             for (int docId = 0; docId &lt; numDocs; docId++) {
4640                 ParseContext.Document document = testDocumentWithTextField();
4641                 document.add(new Field(SourceFieldMapper.NAME, BytesReference.toBytes(B_1), SourceFieldMapper.Defaults.FIELD_TYPE));
4642                 engine.index(indexForDoc(testParsedDocument(Integer.toString(docId), null, document, B_1, null)));
4643                 if (frequently()) {
4644                     globalCheckpoint.set(randomLongBetween(globalCheckpoint.get(), engine.getPersistedLocalCheckpoint()));
4645                     engine.syncTranslog();
4646                 }
4647                 if (frequently()) {
4648                     engine.flush(randomBoolean(), true);
4649                     final List&lt;IndexCommit&gt; commits = DirectoryReader.listCommits(store.directory());
4650                     final IndexCommit safeCommit = commits.get(0);
4651                     if (lastSyncedGlobalCheckpointBeforeCommit.get() == UNASSIGNED_SEQ_NO) {
4652                         assertThat(Long.parseLong(safeCommit.getUserData().get(SequenceNumbers.MAX_SEQ_NO)),
4653                                    equalTo(SequenceNumbers.NO_OPS_PERFORMED));
4654                     } else {
4655                         assertThat(Long.parseLong(safeCommit.getUserData().get(SequenceNumbers.MAX_SEQ_NO)),
4656                                    lessThanOrEqualTo(lastSyncedGlobalCheckpointBeforeCommit.get()));
4657                     }
4658                     for (int i = 1; i &lt; commits.size(); i++) {
4659                         assertThat(Long.parseLong(commits.get(i).getUserData().get(SequenceNumbers.MAX_SEQ_NO)),
4660                                    greaterThan(lastSyncedGlobalCheckpointBeforeCommit.get()));
4661                     }
4662                     long localCheckpointFromSafeCommit = Long.parseLong(safeCommit.getUserData().get(SequenceNumbers.LOCAL_CHECKPOINT_KEY));
4663                     try (Translog.Snapshot snapshot = getTranslog(engine).newSnapshot()) {
4664                         assertThat(snapshot, SnapshotMatchers.containsSeqNoRange(localCheckpointFromSafeCommit + 1, docId));
4665                     }
4666                 }
4667             }
4668         }
4669     }
4670     @Test
4671     public void testConcurrentAppendUpdateAndRefresh() throws InterruptedException, IOException {
4672         int numDocs = scaledRandomIntBetween(100, 1000);
4673         CountDownLatch latch = new CountDownLatch(2);
4674         AtomicBoolean done = new AtomicBoolean(false);
4675         AtomicInteger numDeletes = new AtomicInteger();
4676         Thread thread = new Thread(() -&gt; {
4677             try {
4678                 latch.countDown();
4679                 latch.await();
4680                 for (int j = 0; j &lt; numDocs; j++) {
4681                     String docID = Integer.toString(j);
4682                     ParsedDocument doc = testParsedDocument(docID, null, testDocumentWithTextField(),
4683                                                             new BytesArray(&quot;{}&quot;.getBytes(Charset.defaultCharset())), null);
4684                     Engine.Index operation = appendOnlyPrimary(doc, false, 1);
4685                     engine.index(operation);
4686                     if (rarely()) {
4687                         engine.delete(new Engine.Delete(
4688                             operation.id(),
4689                             operation.uid(),
4690                             UNASSIGNED_SEQ_NO,
4691                             primaryTerm.get(),
4692                             Versions.MATCH_ANY,
4693                             VersionType.INTERNAL,
4694                             Engine.Operation.Origin.PRIMARY,
4695                             System.nanoTime(),
4696                             UNASSIGNED_SEQ_NO,
4697                             0
4698                         ));
4699                         numDeletes.incrementAndGet();
4700                     } else {
4701                         doc = testParsedDocument(docID, null, testDocumentWithTextField(&quot;updated&quot;),
4702                                                  new BytesArray(&quot;{}&quot;.getBytes(Charset.defaultCharset())), null);
4703                         Engine.Index update = indexForDoc(doc);
4704                         engine.index(update);
4705                     }
4706                 }
4707             } catch (Exception e) {
4708                 throw new AssertionError(e);
4709             } finally {
4710                 done.set(true);
4711             }
4712         });
4713         thread.start();
4714         latch.countDown();
4715         latch.await();
4716         while (done.get() == false) {
4717             engine.refresh(&quot;test&quot;, Engine.SearcherScope.INTERNAL, true);
4718         }
4719         thread.join();
4720         engine.refresh(&quot;test&quot;, Engine.SearcherScope.INTERNAL, true);
4721         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.INTERNAL)) {
4722             TopDocs search = searcher.search(new MatchAllDocsQuery(), searcher.getIndexReader().numDocs());
4723             for (int i = 0; i &lt; search.scoreDocs.length; i++) {
4724                 org.apache.lucene.document.Document luceneDoc = searcher.doc(search.scoreDocs[i].doc);
4725                 assertEquals(&quot;updated&quot;, luceneDoc.get(&quot;value&quot;));
4726             }
4727             int totalNumDocs = numDocs - numDeletes.get();
4728             assertEquals(totalNumDocs, searcher.getIndexReader().numDocs());
4729         }
4730     }
4731     @Test
4732     public void testAcquireIndexCommit() throws Exception {
4733         IOUtils.close(engine, store);
4734         store = createStore();
4735         final AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
4736         try (InternalEngine engine = createEngine(store, createTempDir(), globalCheckpoint::get)) {
4737             int numDocs = between(1, 20);
4738             for (int i = 0; i &lt; numDocs; i++) {
4739                 index(engine, i);
4740             }
4741             if (randomBoolean()) {
4742                 globalCheckpoint.set(numDocs - 1);
4743             }
4744             final boolean flushFirst = randomBoolean();
4745             final boolean safeCommit = randomBoolean();
4746             final Engine.IndexCommitRef snapshot;
4747             if (safeCommit) {
4748                 snapshot = engine.acquireSafeIndexCommit();
4749             } else {
4750                 snapshot = engine.acquireLastIndexCommit(flushFirst);
4751             }
4752             int moreDocs = between(1, 20);
4753             for (int i = 0; i &lt; moreDocs; i++) {
4754                 index(engine, numDocs + i);
4755             }
4756             globalCheckpoint.set(numDocs + moreDocs - 1);
4757             engine.flush();
4758             try (IndexReader reader = DirectoryReader.open(snapshot.getIndexCommit())) {
4759                 assertThat(reader.numDocs(), equalTo(flushFirst &amp;&amp; safeCommit == false ? numDocs : 0));
4760             }
4761             assertThat(DirectoryReader.listCommits(engine.store.directory()), hasSize(2));
4762             snapshot.close();
4763             engine.flush(true, true);
4764             assertThat(DirectoryReader.listCommits(engine.store.directory()), hasSize(1));
4765         }
4766     }
4767     @Test
4768     public void testCleanUpCommitsWhenGlobalCheckpointAdvanced() throws Exception {
4769         IOUtils.close(engine, store);
4770         final IndexSettings indexSettings = IndexSettingsModule.newIndexSettings(&quot;test&quot;,
4771                                                                                  Settings.builder().put(defaultSettings.getSettings())
4772                                                                                      .put(IndexSettings.INDEX_TRANSLOG_RETENTION_SIZE_SETTING.getKey(), -1)
4773                                                                                      .put(IndexSettings.INDEX_TRANSLOG_RETENTION_AGE_SETTING.getKey(), -1).build());
4774         final AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
4775         try (Store store = createStore();
4776              InternalEngine engine =
4777                  createEngine(config(indexSettings, store, createTempDir(), newMergePolicy(),
4778                                      null, null, globalCheckpoint::get))) {
4779             final int numDocs = scaledRandomIntBetween(10, 100);
4780             for (int docId = 0; docId &lt; numDocs; docId++) {
4781                 index(engine, docId);
4782                 if (rarely()) {
4783 <A NAME="93"></A>                    engine.flush(randomBoolean(), true);
4784                 }
4785             }
4786             <FONT color="#ff00ff"><div style="position:absolute;left:0"><A
4787                     HREF="javascript:ZweiFrames('match306914-0.html#93',2,'match306914-top.html#93',1)"><IMG
4788                     SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>engine.flush(false, randomBoolean());
4789             globalCheckpoint.set(randomLongBetween(globalCheckpoint.get(), engine.getPersistedLocalCheckpoint()));
4790             engine.syncTranslog();
4791             List&lt;IndexCommit&gt; commits = DirectoryReader.listCommits(store.directory</B></FONT>());
4792             assertThat(Long.parseLong(commits.get(0).getUserData().get(SequenceNumbers.MAX_SEQ_NO)),
4793                 lessThanOrEqualTo(globalCheckpoint.get()));
4794             for (int i = 1; i &lt; commits.size(); i++) {
4795                 assertThat(Long.parseLong(commits.get(i).getUserData().get(SequenceNumbers.MAX_SEQ_NO)),
4796                     greaterThan(globalCheckpoint.get()));
4797             }
4798             globalCheckpoint.set(randomLongBetween(engine.getPersistedLocalCheckpoint(), Long.MAX_VALUE));
4799             engine.syncTranslog();
4800             assertThat(DirectoryReader.listCommits(store.directory()), contains(commits.get(commits.size() - 1)));
4801             assertThat(engine.getTranslog().totalOperations(), equalTo(0));
4802         }
4803     }
4804     @Test
4805     public void testCleanupCommitsWhenReleaseSnapshot() throws Exception {
4806         IOUtils.close(engine, store);
4807         store = createStore();
4808         final AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
4809         try (InternalEngine engine = createEngine(store, createTempDir(), globalCheckpoint::get)) {
4810             final int numDocs = scaledRandomIntBetween(10, 100);
4811             for (int docId = 0; docId &lt; numDocs; docId++) {
4812                 index(engine, docId);
4813                 if (frequently()) {
4814                     engine.flush(randomBoolean(), true);
4815                 }
4816             }
4817             engine.flush(false, randomBoolean());
4818             int numSnapshots = between(1, 10);
4819             final List&lt;Engine.IndexCommitRef&gt; snapshots = new ArrayList&lt;&gt;();
4820             for (int i = 0; i &lt; numSnapshots; i++) {
4821                 snapshots.add(engine.acquireSafeIndexCommit());             }
4822             globalCheckpoint.set(engine.getPersistedLocalCheckpoint());
4823             engine.syncTranslog();
4824             final List&lt;IndexCommit&gt; commits = DirectoryReader.listCommits(store.directory());
4825             for (int i = 0; i &lt; numSnapshots - 1; i++) {
4826                 snapshots.get(i).close();
4827                 assertThat(DirectoryReader.listCommits(store.directory()), equalTo(commits));
4828             }
4829             snapshots.get(numSnapshots - 1).close();             assertThat(DirectoryReader.listCommits(store.directory()), hasSize(1));
4830         }
4831     }
4832     @Test
4833     public void testShouldPeriodicallyFlush() throws Exception {
4834         assertThat(&quot;Empty engine does not need flushing&quot;, engine.shouldPeriodicallyFlush(), equalTo(false));
4835         final Translog translog = engine.getTranslog();
4836         final IntSupplier uncommittedTranslogOperationsSinceLastCommit = () -&gt; {
4837             long localCheckpoint = Long.parseLong(engine.getLastCommittedSegmentInfos().userData.get(SequenceNumbers.LOCAL_CHECKPOINT_KEY));
4838             return translog.totalOperationsByMinGen(translog.getMinGenerationForSeqNo(localCheckpoint + 1).translogFileGeneration);
4839         };
4840         final long extraTranslogSizeInNewEngine =
4841             engine.getTranslog().stats().getUncommittedSizeInBytes() - Translog.DEFAULT_HEADER_SIZE_IN_BYTES;
4842         int numDocs = between(10, 100);
4843         for (int id = 0; id &lt; numDocs; id++) {
4844             final ParsedDocument doc =
4845                 testParsedDocument(Integer.toString(id), null, testDocumentWithTextField(), SOURCE, null);
4846             engine.index(indexForDoc(doc));
4847         }
4848         assertThat(&quot;Not exceeded translog flush threshold yet&quot;, engine.shouldPeriodicallyFlush(), equalTo(false));
4849 <A NAME="12"></A>        long flushThreshold = RandomNumbers.randomLongBetween(random(), 120,
4850             engine.getTranslog().stats().getUncommittedSizeInBytes()- extraTranslogSizeInNewEngine);
4851         final IndexSettings indexSettings = engine.config().getIndexSettings();
4852         <FONT color="#571b7e"><div style="position:absolute;left:0"><A
4853                 HREF="javascript:ZweiFrames('match306914-0.html#12',2,'match306914-top.html#12',1)"><IMG SRC="back.gif"
4854                                                                                                          ALT="other"
4855                                                                                                          BORDER="0"
4856                                                                                                          ALIGN="left"></A></div><B>final IndexMetadata indexMetadata = IndexMetadata.builder(indexSettings.getIndexMetadata())
4857             .settings(Settings.builder().put(indexSettings.getSettings())
4858                 .put(IndexSettings.INDEX_TRANSLOG_FLUSH_THRESHOLD_SIZE_SETTING.getKey(), flushThreshold + &quot;b&quot;)).build();
4859         indexSettings.updateIndexMetadata(indexMetadata);
4860         engine.onSettingsChanged(indexSettings.getTranslogRetentionAge(), indexSettings.getTranslogRetentionSize(),
4861             indexSettings.getSoftDeleteRetentionOperations());
4862         assertThat(engine.getTranslog().stats().getUncommittedOperations(), equalTo(numDocs));
4863         assertThat(engine.shouldPeriodicallyFlush(), equalTo(true));
4864         engine.flush();
4865         assertThat(uncommittedTranslogOperationsSinceLastCommit.getAsInt</B></FONT>(), equalTo(0));
4866         for (int id = 0; id &lt; numDocs; id++) {
4867             final ParsedDocument doc =
4868                 testParsedDocument(Integer.toString(id), null, testDocumentWithTextField(), SOURCE, null);
4869 <A NAME="39"></A>            final Engine.IndexResult result = engine.index(replicaIndexForDoc(doc, 1L, id, false));
4870             assertThat(result.isCreated(), equalTo(false));
4871         }
4872         <FONT color="#152dc6"><div style="position:absolute;left:0"><A
4873                 HREF="javascript:ZweiFrames('match306914-0.html#39',2,'match306914-top.html#39',1)"><IMG SRC="back.gif"
4874                                                                                                          ALT="other"
4875                                                                                                          BORDER="0"
4876                                                                                                          ALIGN="left"></A></div><B>SegmentInfos lastCommitInfo = engine.getLastCommittedSegmentInfos();
4877         assertThat(uncommittedTranslogOperationsSinceLastCommit.getAsInt(), equalTo(numDocs));
4878         assertThat(engine.shouldPeriodicallyFlush(), equalTo(true));
4879         engine.flush(false, false);
4880         assertThat(engine.getLastCommittedSegmentInfos(), not(sameInstance(lastCommitInfo)));
4881         assertThat(uncommittedTranslogOperationsSinceLastCommit.getAsInt(), equalTo(0));
4882         generateNewSeqNo</B></FONT>(engine);         for (int id = 0; id &lt; numDocs; id++) {
4883             if (randomBoolean()) {
4884                 translog.rollGeneration();
4885             }
4886             final ParsedDocument doc =
4887                 testParsedDocument(&quot;new&quot; + id, null, testDocumentWithTextField(), SOURCE, null);
4888             engine.index(replicaIndexForDoc(doc, 2L, generateNewSeqNo(engine), false));
4889             if (engine.shouldPeriodicallyFlush()) {
4890                 engine.flush();
4891                 assertThat(engine.getLastCommittedSegmentInfos(), not(sameInstance(lastCommitInfo)));
4892                 assertThat(engine.shouldPeriodicallyFlush(), equalTo(false));
4893             }
4894         }
4895     }
4896 <A NAME="57"></A>
4897     @Test
4898     public void testShouldPeriodicallyFlushAfterMerge() throws Exception {
4899         assertThat(&quot;Empty engine does not need flushing&quot;, engine.shouldPeriodicallyFlush(), <FONT
4900                 color="#0000ff"><div style="position:absolute;left:0"><A
4901                 HREF="javascript:ZweiFrames('match306914-0.html#57',2,'match306914-top.html#57',1)"><IMG SRC="back.gif"
4902                                                                                                          ALT="other"
4903                                                                                                          BORDER="0"
4904                                                                                                          ALIGN="left"></A></div><B>equalTo(false));
4905         ParsedDocument doc =
4906             testParsedDocument(Integer.toString(0), null, testDocumentWithTextField(), SOURCE, null);
4907         engine.index(indexForDoc(doc));
4908 <A NAME="9"></A>        engine.refresh(&quot;test&quot;);
4909         assertThat(&quot;Not exceeded translog flush threshold yet&quot;, engine.shouldPeriodicallyFlush(), equalTo(false));
4910         final IndexSettings indexSettings = engine.config</B></FONT>().getIndexSettings();
4911         final IndexMetadata indexMetadata = <FONT color="#83a33a"><div style="position:absolute;left:0"><A
4912                 HREF="javascript:ZweiFrames('match306914-0.html#9',2,'match306914-top.html#9',1)"><IMG SRC="back.gif"
4913                                                                                                        ALT="other"
4914                                                                                                        BORDER="0"
4915                                                                                                        ALIGN="left"></A></div><B>IndexMetadata.builder(indexSettings.getIndexMetadata())
4916             .settings(Settings.builder().put(indexSettings.getSettings())
4917                           .put(IndexSettings.INDEX_FLUSH_AFTER_MERGE_THRESHOLD_SIZE_SETTING.getKey(),  &quot;0b&quot;)).build();
4918         indexSettings.updateIndexMetadata(indexMetadata);
4919         engine.onSettingsChanged(indexSettings.getTranslogRetentionAge(), indexSettings.getTranslogRetentionSize(),
4920                                  indexSettings.getSoftDeleteRetentionOperations());
4921         assertThat(engine.getTranslog().stats().getUncommittedOperations(), equalTo(1));
4922         assertThat(engine.shouldPeriodicallyFlush(), equalTo(false));
4923         doc = testParsedDocument(Integer.toString(1), null, testDocumentWithTextField(), SOURCE, null);
4924         engine.index(indexForDoc</B></FONT>(doc));
4925         assertThat(engine.getTranslog().stats().getUncommittedOperations(), equalTo(2));
4926         engine.refresh(&quot;test&quot;);
4927         engine.forceMerge(false, 1, false, false, false, UUIDs.randomBase64UUID());
4928         assertBusy(() -&gt; {
4929 <A NAME="103"></A>            assertThat(engine.shouldPeriodicallyFlush(), equalTo(true));
4930         });
4931         engine.flush();
4932         <FONT color="#668b8b"><div style="position:absolute;left:0"><A
4933                 HREF="javascript:ZweiFrames('match306914-0.html#103',2,'match306914-top.html#103',1)"><IMG
4934                 SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>assertThat(engine.shouldPeriodicallyFlush(), equalTo(false));
4935     }
4936     @Test
4937     public void testStressShouldPeriodicallyFlush() throws Exception {
4938 <A NAME="27"></A>        final long flushThreshold = randomLongBetween(120, 5000)</B></FONT>;
4939         final long generationThreshold = randomLongBetween(1000, 5000);
4940         final IndexSettings indexSettings = engine.config().getIndexSettings();
4941         <FONT color="#e77471"><div style="position:absolute;left:0"><A
4942                 HREF="javascript:ZweiFrames('match306914-0.html#27',2,'match306914-top.html#27',1)"><IMG SRC="back.gif"
4943                                                                                                          ALT="other"
4944                                                                                                          BORDER="0"
4945                                                                                                          ALIGN="left"></A></div><B>final IndexMetadata indexMetadata = IndexMetadata.builder(indexSettings.getIndexMetadata())
4946             .settings(Settings.builder().put(indexSettings.getSettings())
4947                           .put(IndexSettings.INDEX_TRANSLOG_GENERATION_THRESHOLD_SIZE_SETTING.getKey(), generationThreshold + &quot;b&quot;)
4948                           .put(IndexSettings.INDEX_TRANSLOG_FLUSH_THRESHOLD_SIZE_SETTING.getKey(), flushThreshold + &quot;b&quot;)).build();
4949         indexSettings.updateIndexMetadata(indexMetadata);
4950         engine.onSettingsChanged(indexSettings.getTranslogRetentionAge(), indexSettings.getTranslogRetentionSize(),
4951             indexSettings.getSoftDeleteRetentionOperations());
4952         final int numOps = scaledRandomIntBetween</B></FONT>(100, 10_000);
4953         for (int i = 0; i &lt; numOps; i++) {
4954             final long localCheckPoint = engine.getProcessedLocalCheckpoint();
4955             final long seqno = randomLongBetween(Math.max(0, localCheckPoint), localCheckPoint + 5);
4956             final ParsedDocument doc =
4957                 testParsedDocument(Long.toString(seqno), null, testDocumentWithTextField(), SOURCE, null);
4958             engine.index(replicaIndexForDoc(doc, 1L, seqno, false));
4959             if (rarely() &amp;&amp; engine.getTranslog().shouldRollGeneration()) {
4960                 engine.rollTranslogGeneration();
4961             }
4962             if (rarely() || engine.shouldPeriodicallyFlush()) {
4963                 engine.flush();
4964                 assertThat(engine.shouldPeriodicallyFlush(), equalTo(false));
4965             }
4966         }
4967     }
4968     @Test
4969     public void testStressUpdateSameDocWhileGettingIt() throws IOException, InterruptedException {
4970         final int iters = randomIntBetween(1, 15);
4971         for (int i = 0; i &lt; iters; i++) {
4972 <A NAME="17"></A>                        try (Store store = createStore(); InternalEngine engine = createEngine(store, createTempDir())) {
4973                 final IndexSettings indexSettings = engine.config().getIndexSettings();
4974                 <FONT color="#3090c7"><div style="position:absolute;left:0"><A
4975                         HREF="javascript:ZweiFrames('match306914-0.html#17',2,'match306914-top.html#17',1)"><IMG
4976                         SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>final IndexMetadata indexMetadata = IndexMetadata.builder(indexSettings.getIndexMetadata())
4977                     .settings(Settings.builder().put(indexSettings.getSettings())
4978                                   .put(IndexSettings.INDEX_GC_DELETES_SETTING.getKey(), TimeValue.timeValueMillis(1))).build();
4979                 engine.engineConfig.getIndexSettings().updateIndexMetadata(indexMetadata);
4980                 engine.onSettingsChanged(indexSettings.getTranslogRetentionAge(), indexSettings.getTranslogRetentionSize(),
4981                     indexSettings.getSoftDeleteRetentionOperations());
4982                 ParsedDocument document = testParsedDocument(Integer.toString(0), null, testDocumentWithTextField</B></FONT>(), SOURCE, null);
4983                 final Engine.Index doc = new Engine.Index(newUid(document), document, UNASSIGNED_SEQ_NO, 0,
4984                     Versions.MATCH_ANY, VersionType.INTERNAL, Engine.Operation.Origin.PRIMARY, System.nanoTime(),
4985                     -1, false, UNASSIGNED_SEQ_NO, 0);
4986                 engine.index(doc);
4987                 engine.delete(new Engine.Delete(
4988                     doc.id(),
4989                     doc.uid(),
4990                     UNASSIGNED_SEQ_NO,
4991                     primaryTerm.get(),
4992                     Versions.MATCH_ANY,
4993                     VersionType.INTERNAL,
4994                     Engine.Operation.Origin.PRIMARY,
4995                     System.nanoTime(),
4996                     UNASSIGNED_SEQ_NO,
4997                     0
4998                 ));
4999                 ParsedDocument document1 = testParsedDocument(Integer.toString(1), null, testDocumentWithTextField(), SOURCE, null);
5000                 engine.index(new Engine.Index(newUid(document1), document1, UNASSIGNED_SEQ_NO, 0, Versions.MATCH_ANY, VersionType.INTERNAL,
5001                     Engine.Operation.Origin.PRIMARY, System.nanoTime(), -1, false,
5002                     UNASSIGNED_SEQ_NO, 0));
5003                 engine.refresh(&quot;test&quot;);
5004                 ParsedDocument document2 = testParsedDocument(Integer.toString(2), null, testDocumentWithTextField(), SOURCE, null);
5005                 engine.index(new Engine.Index(newUid(document2), document2, UNASSIGNED_SEQ_NO, 0, Versions.MATCH_ANY, VersionType.INTERNAL,
5006                     Engine.Operation.Origin.PRIMARY, System.nanoTime(), -1, false,
5007                     UNASSIGNED_SEQ_NO, 0));
5008                 engine.refresh(&quot;test&quot;);
5009                 ParsedDocument document3 = testParsedDocument(Integer.toString(3), null, testDocumentWithTextField(), SOURCE, null);
5010                 final Engine.Index doc3 = new Engine.Index(newUid(document3), document3, UNASSIGNED_SEQ_NO, 0,
5011                     Versions.MATCH_ANY, VersionType.INTERNAL, Engine.Operation.Origin.PRIMARY, System.nanoTime(),
5012                     -1, false, UNASSIGNED_SEQ_NO, 0);
5013                 engine.index(doc3);
5014                 engine.engineConfig.setEnableGcDeletes(true);
5015                 CountDownLatch awaitStarted = new CountDownLatch(1);
5016                 Thread thread = new Thread(() -&gt; {
5017                     awaitStarted.countDown();
5018                     try (Engine.GetResult getResult = engine.get(new Engine.Get(
5019                         doc3.id(), doc3.uid()), engine::acquireSearcher)) {
5020                         assertThat(getResult.docIdAndVersion(), is(notNullValue()));
5021                     }
5022                 });
5023                 thread.start();
5024                 awaitStarted.await();
5025                 try (Engine.GetResult getResult = engine.get(
5026                     new Engine.Get(doc.id(), doc.uid()),
5027                     engine::acquireSearcher)) {
5028                     assertThat(getResult.docIdAndVersion(), is(nullValue()));
5029                 }
5030                 thread.join();
5031             }
5032         }
5033     }
5034     @Test
5035     public void testPruneOnlyDeletesAtMostLocalCheckpoint() throws Exception {
5036         final AtomicLong clock = new AtomicLong(0);
5037         threadPool = spy(threadPool);
5038         when(threadPool.relativeTimeInMillis()).thenAnswer(invocation -&gt; clock.get());
5039         final long gcInterval = randomIntBetween(0, 10);
5040         final IndexSettings indexSettings = engine.config().getIndexSettings();
5041         final IndexMetadata indexMetadata = IndexMetadata.builder(indexSettings.getIndexMetadata())
5042             .settings(Settings.builder().put(indexSettings.getSettings())
5043                           .put(IndexSettings.INDEX_GC_DELETES_SETTING.getKey(), TimeValue.timeValueMillis(gcInterval).getStringRep())).build();
5044         indexSettings.updateIndexMetadata(indexMetadata);
5045         try (Store store = createStore();
5046              InternalEngine engine = createEngine(store, createTempDir())) {
5047             engine.config().setEnableGcDeletes(false);
5048             for (int i = 0, docs = scaledRandomIntBetween(0, 10); i &lt; docs; i++) {
5049                 index(engine, i);
5050             }
5051             final long deleteBatch = between(10, 20);
5052             final long gapSeqNo = randomLongBetween(
5053                 engine.getSeqNoStats(-1).getMaxSeqNo() + 1, engine.getSeqNoStats(-1).getMaxSeqNo() + deleteBatch);
5054             for (int i = 0; i &lt; deleteBatch; i++) {
5055                 final long seqno = generateNewSeqNo(engine);
5056                 if (seqno != gapSeqNo) {
5057                     if (randomBoolean()) {
5058                         clock.incrementAndGet();
5059                     }
5060                     engine.delete(replicaDeleteForDoc(UUIDs.randomBase64UUID(), 1, seqno, threadPool.relativeTimeInMillis()));
5061 <A NAME="24"></A>                }
5062             }
5063             List&lt;DeleteVersionValue&gt; tombstones = new ArrayList&lt;&gt;(<FONT color="#79764d"><div
5064                 style="position:absolute;left:0"><A
5065                 HREF="javascript:ZweiFrames('match306914-0.html#24',2,'match306914-top.html#24',1)"><IMG SRC="back.gif"
5066                                                                                                          ALT="other"
5067                                                                                                          BORDER="0"
5068                                                                                                          ALIGN="left"></A></div><B>tombstonesInVersionMap(engine).values());
5069             engine.config().setEnableGcDeletes(true);
5070             clock.set(randomLongBetween(gcInterval, deleteBatch + gcInterval));
5071             engine.refresh(&quot;test&quot;);
5072             tombstones.removeIf(v -&gt; v.seqNo &lt; gapSeqNo &amp;&amp; v.time &lt; clock.get() - gcInterval);
5073             assertThat(tombstonesInVersionMap(engine).values(), containsInAnyOrder(tombstones.toArray()));
5074             clock.set(randomLongBetween(deleteBatch + gcInterval * 4/3, 100));             engine.refresh(&quot;test&quot;);
5075             tombstones.removeIf</B></FONT>(v -&gt; v.seqNo &lt; gapSeqNo);
5076             assertThat(tombstonesInVersionMap(engine).values(), containsInAnyOrder(tombstones.toArray()));
5077             clock.set(between(0, 100));
5078             if (randomBoolean()) {
5079                 engine.index(replicaIndexForDoc(testParsedDocument(&quot;d&quot;, null, testDocumentWithTextField(),
5080                                                                    SOURCE, null), 1, gapSeqNo, false));
5081             } else {
5082                 engine.delete(replicaDeleteForDoc(UUIDs.randomBase64UUID(), Versions.MATCH_ANY,
5083                                                   gapSeqNo, threadPool.relativeTimeInMillis()));
5084             }
5085             clock.set(randomLongBetween(100 + gcInterval * 4/3, Long.MAX_VALUE));             engine.refresh(&quot;test&quot;);
5086             assertThat(tombstonesInVersionMap(engine).values(), empty());
5087         }
5088     }
5089     @Test
5090     public void testTrimUnsafeCommits() throws Exception {
5091         final AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
5092         final int maxSeqNo = 40;
5093         final List&lt;Long&gt; seqNos = LongStream.rangeClosed(0, maxSeqNo).boxed().collect(Collectors.toList());
5094         Collections.shuffle(seqNos, random());
5095         try (Store store = createStore()) {
5096             EngineConfig config = config(defaultSettings, store, createTempDir(), newMergePolicy(),
5097                                          null, null, globalCheckpoint::get);
5098             final List&lt;Long&gt; commitMaxSeqNo = new ArrayList&lt;&gt;();
5099             final long minTranslogGen;
5100             try (InternalEngine engine = createEngine(config)) {
5101                 for (int i = 0; i &lt; seqNos.size(); i++) {
5102                     ParsedDocument doc = testParsedDocument(Long.toString(seqNos.get(i)), null, testDocument(),
5103                                                             new BytesArray(&quot;{}&quot;), null);
5104                     Engine.Index index = new Engine.Index(newUid(doc), doc, seqNos.get(i), 0,
5105                                                           1, null, REPLICA, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0);
5106                     engine.index(index);
5107                     if (randomBoolean()) {
5108                         engine.flush();
5109                         final Long maxSeqNoInCommit = seqNos.subList(0, i + 1).stream().max(Long::compareTo).orElse(-1L);
5110                         commitMaxSeqNo.add(maxSeqNoInCommit);
5111                     }
5112                 }
5113                 globalCheckpoint.set(randomInt(maxSeqNo));
5114                 engine.syncTranslog();
5115                 minTranslogGen = engine.getTranslog().getMinFileGeneration();
5116             }
5117             store.trimUnsafeCommits(globalCheckpoint.get(), minTranslogGen,config.getIndexSettings().getIndexVersionCreated());
5118             long safeMaxSeqNo =
5119                 commitMaxSeqNo.stream().filter(s -&gt; s &lt;= globalCheckpoint.get())
5120                     .reduce((s1, s2) -&gt; s2)                     .orElse(SequenceNumbers.NO_OPS_PERFORMED);
5121             final List&lt;IndexCommit&gt; commits = DirectoryReader.listCommits(store.directory());
5122             assertThat(commits, hasSize(1));
5123             assertThat(commits.get(0).getUserData().get(SequenceNumbers.MAX_SEQ_NO), equalTo(Long.toString(safeMaxSeqNo)));
5124             try (IndexReader reader = DirectoryReader.open(commits.get(0))) {
5125                 for (LeafReaderContext context: reader.leaves()) {
5126                     final NumericDocValues values = context.reader().getNumericDocValues(SeqNoFieldMapper.NAME);
5127                     if (values != null) {
5128                         for (int docID = 0; docID &lt; context.reader().maxDoc(); docID++) {
5129                             if (values.advanceExact(docID) == false) {
5130                                 throw new AssertionError(&quot;Document does not have a seq number: &quot; + docID);
5131                             }
5132                             assertThat(values.longValue(), lessThanOrEqualTo(globalCheckpoint.get()));
5133                         }
5134                     }
5135                 }
5136             }
5137         }
5138     }
5139 <A NAME="69"></A>
5140     @Test
5141     public void testLuceneHistoryOnPrimary() throws Exception {
5142         final List&lt;Engine.Operation&gt; operations = <FONT color="#571b7e"><div style="position:absolute;left:0"><A
5143                 HREF="javascript:ZweiFrames('match306914-0.html#69',2,'match306914-top.html#69',1)"><IMG SRC="back.gif"
5144                                                                                                          ALT="other"
5145                                                                                                          BORDER="0"
5146                                                                                                          ALIGN="left"></A></div><B>generateSingleDocHistory(
5147             false, randomFrom(VersionType.INTERNAL, VersionType.EXTERNAL), 2, 10, 300, &quot;1&quot;);
5148         assertOperationHistoryInLucene(operations);
5149     }
5150     @Test
5151     public void testLuceneHistoryOnReplica() throws Exception {
5152         final List&lt;Engine.Operation&gt; operations = generateSingleDocHistory(
5153             true, randomFrom(VersionType.INTERNAL, VersionType.EXTERNAL), 2, 10, 300, &quot;2&quot;);
5154         Randomness.shuffle(operations);
5155         assertOperationHistoryInLucene</B></FONT>(operations);
5156     }
5157 <A NAME="92"></A>    private void assertOperationHistoryInLucene(List&lt;Engine.Operation&gt; operations) throws IOException {
5158         final MergePolicy keepSoftDeleteDocsMP = new SoftDeletesRetentionMergePolicy(
5159             Lucene.SOFT_DELETES_FIELD, MatchAllDocsQuery::new, engine.config().getMergePolicy());
5160         Settings.Builder settings = <FONT color="#41a317"><div style="position:absolute;left:0"><A
5161                 HREF="javascript:ZweiFrames('match306914-0.html#92',2,'match306914-top.html#92',1)"><IMG SRC="back.gif"
5162                                                                                                          ALT="other"
5163                                                                                                          BORDER="0"
5164                                                                                                          ALIGN="left"></A></div><B>Settings.builder()
5165             .put(defaultSettings.getSettings())
5166             .put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), true)
5167             .put(IndexSettings.INDEX_SOFT_DELETES_RETENTION_OPERATIONS_SETTING.getKey(), randomLongBetween(0, 10));
5168         final IndexMetadata indexMetadata = IndexMetadata.builder(defaultSettings.getIndexMetadata()).settings</B></FONT>(settings).build();
5169         final IndexSettings indexSettings = IndexSettingsModule.newIndexSettings(indexMetadata);
5170         Set&lt;Long&gt; expectedSeqNos = new HashSet&lt;&gt;();
5171         try (Store store = createStore();
5172              Engine engine = createEngine(config(indexSettings, store, createTempDir(), keepSoftDeleteDocsMP, null))) {
5173             for (Engine.Operation op : operations) {
5174                 if (op instanceof Engine.Index) {
5175                     Engine.IndexResult indexResult = engine.index((Engine.Index) op);
5176                     assertThat(indexResult.getFailure(), nullValue());
5177                     expectedSeqNos.add(indexResult.getSeqNo());
5178                 } else {
5179                     Engine.DeleteResult deleteResult = engine.delete((Engine.Delete) op);
5180                     assertThat(deleteResult.getFailure(), nullValue());
5181                     expectedSeqNos.add(deleteResult.getSeqNo());
5182                 }
5183                 if (rarely()) {
5184                     engine.refresh(&quot;test&quot;);
5185                 }
5186                 if (rarely()) {
5187                     engine.flush();
5188                 }
5189                 if (rarely()) {
5190 <A NAME="79"></A>                    engine.forceMerge(true, 1, false, false, false, UUIDs.randomBase64UUID());
5191                 }
5192             }
5193             <FONT color="#4cc417"><div style="position:absolute;left:0"><A
5194                     HREF="javascript:ZweiFrames('match306914-0.html#79',2,'match306914-top.html#79',1)"><IMG
5195                     SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>MapperService mapperService = createMapperService(&quot;test&quot;);
5196             List&lt;Translog.Operation&gt; actualOps = readAllOperationsInLucene(engine, mapperService);
5197             assertThat(actualOps.stream().map(o -&gt; o.seqNo()).collect(Collectors.toList</B></FONT>()), containsInAnyOrder(expectedSeqNos.toArray()));
5198             assertConsistentHistoryBetweenTranslogAndLuceneIndex(engine, mapperService);
5199         }
5200     }
5201     @Test
5202     public void testKeepMinRetainedSeqNoByMergePolicy() throws IOException {
5203         IOUtils.close(engine, store);
5204         Settings.Builder settings = Settings.builder()
5205             .put(defaultSettings.getSettings())
5206             .put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), true)
5207             .put(IndexSettings.INDEX_SOFT_DELETES_RETENTION_OPERATIONS_SETTING.getKey(), randomLongBetween(0, 10));
5208         final IndexMetadata indexMetadata = IndexMetadata.builder(defaultSettings.getIndexMetadata()).settings(settings).build();
5209         final IndexSettings indexSettings = IndexSettingsModule.newIndexSettings(indexMetadata);
5210         final AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
5211         final long primaryTerm = randomLongBetween(1, Long.MAX_VALUE);
5212         final AtomicLong retentionLeasesVersion = new AtomicLong();
5213         final AtomicReference&lt;RetentionLeases&gt; retentionLeasesHolder = new AtomicReference&lt;&gt;(
5214             new RetentionLeases(primaryTerm, retentionLeasesVersion.get(), Collections.emptyList()));
5215         final List&lt;Engine.Operation&gt; operations = generateSingleDocHistory(
5216             true, randomFrom(VersionType.INTERNAL, VersionType.EXTERNAL), 2, 10, 300, &quot;2&quot;);
5217         Randomness.shuffle(operations);
5218         Set&lt;Long&gt; existingSeqNos = new HashSet&lt;&gt;();
5219         store = createStore();
5220         engine = createEngine(config(
5221             indexSettings,
5222             store,
5223             createTempDir(),
5224             newMergePolicy(),
5225             null,
5226             null,
5227             globalCheckpoint::get,
5228             retentionLeasesHolder::get
5229         ));
5230         assertThat(engine.getMinRetainedSeqNo(), equalTo(0L));
5231         long lastMinRetainedSeqNo = engine.getMinRetainedSeqNo();
5232         for (Engine.Operation op : operations) {
5233             final Engine.Result result;
5234             if (op instanceof Engine.Index) {
5235                 result = engine.index((Engine.Index) op);
5236             } else {
5237                 result = engine.delete((Engine.Delete) op);
5238             }
5239             existingSeqNos.add(result.getSeqNo());
5240             if (randomBoolean()) {
5241                 engine.syncTranslog();                 assertEquals(engine.getProcessedLocalCheckpoint(), engine.getPersistedLocalCheckpoint());
5242                 globalCheckpoint.set(
5243                     randomLongBetween(globalCheckpoint.get(), engine.getLocalCheckpointTracker().getPersistedCheckpoint()));
5244             }
5245             if (randomBoolean()) {
5246                 retentionLeasesVersion.incrementAndGet();
5247                 final int length = randomIntBetween(0, 8);
5248                 final List&lt;RetentionLease&gt; leases = new ArrayList&lt;&gt;(length);
5249                 for (int i = 0; i &lt; length; i++) {
5250                     final String id = randomAlphaOfLength(8);
5251                     final long retainingSequenceNumber = randomLongBetween(0, Math.max(0, globalCheckpoint.get()));
5252                     final long timestamp = randomLongBetween(0L, Long.MAX_VALUE);
5253                     final String source = randomAlphaOfLength(8);
5254                     leases.add(new RetentionLease(id, retainingSequenceNumber, timestamp, source));
5255                 }
5256                 retentionLeasesHolder.set(new RetentionLeases(primaryTerm, retentionLeasesVersion.get(), leases));
5257             }
5258             if (rarely()) {
5259                 settings.put(IndexSettings.INDEX_SOFT_DELETES_RETENTION_OPERATIONS_SETTING.getKey(), randomLongBetween(0, 10));
5260                 indexSettings.updateIndexMetadata(IndexMetadata.builder(defaultSettings.getIndexMetadata()).settings(settings).build());
5261                 engine.onSettingsChanged(indexSettings.getTranslogRetentionAge(), indexSettings.getTranslogRetentionSize(),
5262                     indexSettings.getSoftDeleteRetentionOperations());
5263             }
5264             if (rarely()) {
5265                 engine.refresh(&quot;test&quot;);
5266             }
5267             if (rarely()) {
5268                 engine.flush(true, true);
5269                 assertThat(Long.parseLong(engine.getLastCommittedSegmentInfos().userData.get(Engine.MIN_RETAINED_SEQNO)),
5270                            equalTo(engine.getMinRetainedSeqNo()));
5271             }
5272             if (rarely()) {
5273                 engine.forceMerge(randomBoolean(), 1, false, false, false, UUIDs.randomBase64UUID());
5274             }
5275             try (Closeable ignored = engine.acquireHistoryRetentionLock(Engine.HistorySource.INDEX)) {
5276                 long minRetainSeqNos = engine.getMinRetainedSeqNo();
5277                 assertThat(minRetainSeqNos, lessThanOrEqualTo(globalCheckpoint.get() + 1));
5278                 Long[] expectedOps = existingSeqNos.stream().filter(seqno -&gt; seqno &gt;= minRetainSeqNos).toArray(Long[]::new);
5279                 Set&lt;Long&gt; actualOps = readAllOperationsInLucene(engine, createMapperService(&quot;test&quot;)).stream()
5280                     .map(Translog.Operation::seqNo).collect(Collectors.toSet());
5281                 assertThat(actualOps, containsInAnyOrder(expectedOps));
5282             }
5283             try (Engine.IndexCommitRef commitRef = engine.acquireSafeIndexCommit()) {
5284                 IndexCommit safeCommit = commitRef.getIndexCommit();
5285                 if (safeCommit.getUserData().containsKey(Engine.MIN_RETAINED_SEQNO)) {
5286                     lastMinRetainedSeqNo = Long.parseLong(safeCommit.getUserData().get(Engine.MIN_RETAINED_SEQNO));
5287                 }
5288             }
5289         }
5290         if (randomBoolean()) {
5291             engine.close();
5292         } else {
5293             engine.flushAndClose();
5294         }
5295         try (InternalEngine recoveringEngine = new InternalEngine(engine.config())) {
5296             assertThat(recoveringEngine.getMinRetainedSeqNo(), equalTo(lastMinRetainedSeqNo));
5297         }
5298     }
5299     @Test
5300     public void testLastRefreshCheckpoint() throws Exception {
5301         AtomicBoolean done = new AtomicBoolean();
5302         Thread[] refreshThreads = new Thread[between(1, 8)];
5303         CountDownLatch latch = new CountDownLatch(refreshThreads.length);
5304         for (int i = 0; i &lt; refreshThreads.length; i++) {
5305             latch.countDown();
5306             refreshThreads[i] = new Thread(() -&gt; {
5307                 while (done.get() == false) {
5308                     long checkPointBeforeRefresh = engine.getProcessedLocalCheckpoint();
5309                     engine.refresh(&quot;test&quot;, randomFrom(Engine.SearcherScope.values()), true);
5310                     assertThat(engine.lastRefreshedCheckpoint(), greaterThanOrEqualTo(checkPointBeforeRefresh));
5311                 }
5312             });
5313             refreshThreads[i].start();
5314         }
5315         latch.await();
5316         List&lt;Engine.Operation&gt; ops = generateSingleDocHistory(
5317             true, VersionType.EXTERNAL, 1, 10, 1000, &quot;1&quot;);
5318         concurrentlyApplyOps(ops, engine);
5319         done.set(true);
5320         for (Thread thread : refreshThreads) {
5321 <A NAME="101"></A>            thread.join();
5322         }
5323         engine.refresh(&quot;test&quot;);
5324         assertThat(<FONT color="#a057a5"><div style="position:absolute;left:0"><A
5325                 HREF="javascript:ZweiFrames('match306914-0.html#101',2,'match306914-top.html#101',1)"><IMG
5326                 SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>engine.lastRefreshedCheckpoint(), equalTo(engine.getProcessedLocalCheckpoint()));
5327     }
5328     @Test
5329     public void testLuceneSnapshotRefreshesOnlyOnce() throws Exception {
5330         final MapperService mapperService = createMapperService(&quot;test&quot;)</B></FONT>;
5331         final long maxSeqNo = randomLongBetween(10, 50);
5332         final AtomicLong refreshCounter = new AtomicLong();
5333         final IndexSettings indexSettings = IndexSettingsModule.newIndexSettings(
5334             IndexMetadata.builder(defaultSettings.getIndexMetadata()).settings(Settings.builder().
5335                 put(defaultSettings.getSettings()).put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), true)).build());
5336         try (Store store = createStore();
5337              InternalEngine engine = createEngine(config(indexSettings, store, createTempDir(), newMergePolicy(),
5338                                                          null,
5339                                                          new ReferenceManager.RefreshListener() {
5340                                                              @Override
5341                                                              public void beforeRefresh() {
5342                                                                  refreshCounter.incrementAndGet();
5343                                                              }
5344                                                              @Override
5345                                                              public void afterRefresh(boolean didRefresh) {
5346                                                              }
5347                                                          }, () -&gt; SequenceNumbers.NO_OPS_PERFORMED))) {
5348             for (long seqNo = 0; seqNo &lt;= maxSeqNo; seqNo++) {
5349                 final ParsedDocument doc = testParsedDocument(&quot;id_&quot; + seqNo, null, testDocumentWithTextField(&quot;test&quot;),
5350                                                               new BytesArray(&quot;{}&quot;.getBytes(Charset.defaultCharset())), null);
5351                 engine.index(replicaIndexForDoc(doc, 1, seqNo, randomBoolean()));
5352             }
5353             final long initialRefreshCount = refreshCounter.get();
5354             final Thread[] snapshotThreads = new Thread[between(1, 3)];
5355             CountDownLatch latch = new CountDownLatch(1);
5356             for (int i = 0; i &lt; snapshotThreads.length; i++) {
5357                 final long min = randomLongBetween(0, maxSeqNo - 5);
5358                 final long max = randomLongBetween(min, maxSeqNo);
5359                 snapshotThreads[i] = new Thread(new AbstractRunnable() {
5360                     @Override
5361                     public void onFailure(Exception e) {
5362                         throw new AssertionError(e);
5363                     }
5364                     @Override
5365                     protected void doRun() throws Exception {
5366                         latch.await();
5367                         Translog.Snapshot changes = engine.newChangesSnapshot(&quot;test&quot;, mapperService, min, max, true);
5368                         changes.close();
5369                     }
5370                 });
5371                 snapshotThreads[i].start();
5372             }
5373             latch.countDown();
5374             for (Thread thread : snapshotThreads) {
5375                 thread.join();
5376             }
5377             assertThat(refreshCounter.get(), equalTo(initialRefreshCount + 1L));
5378             assertThat(engine.lastRefreshedCheckpoint(), equalTo(maxSeqNo));
5379         }
5380     }
5381     @Test
5382     public void testAcquireSearcherOnClosingEngine() throws Exception {
5383         engine.close();
5384         expectThrows(AlreadyClosedException.class, () -&gt; engine.acquireSearcher(&quot;test&quot;, Engine.SearcherScope.INTERNAL));
5385     }
5386     @Test
5387     public void testNoOpOnClosingEngine() throws Exception {
5388         engine.close();
5389         Settings settings = Settings.builder()
5390             .put(defaultSettings.getSettings())
5391             .put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), true).build();
5392         IndexSettings indexSettings = IndexSettingsModule.newIndexSettings(
5393             IndexMetadata.builder(defaultSettings.getIndexMetadata()).settings(settings).build());
5394         assertTrue(indexSettings.isSoftDeleteEnabled());
5395         try (Store store = createStore();
5396              InternalEngine engine = createEngine(config(indexSettings, store, createTempDir(), NoMergePolicy.INSTANCE, null))) {
5397             engine.close();
5398             expectThrows(AlreadyClosedException.class, () -&gt; engine.noOp(
5399                 new Engine.NoOp(2, primaryTerm.get(), LOCAL_TRANSLOG_RECOVERY, System.nanoTime(), &quot;reason&quot;)));
5400         }
5401     }
5402     @Test
5403     public void testSoftDeleteOnClosingEngine() throws Exception {
5404         engine.close();
5405         Settings settings = Settings.builder()
5406             .put(defaultSettings.getSettings())
5407             .put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), true).build();
5408         IndexSettings indexSettings = IndexSettingsModule.newIndexSettings(
5409             IndexMetadata.builder(defaultSettings.getIndexMetadata()).settings(settings).build());
5410         assertTrue(indexSettings.isSoftDeleteEnabled());
5411         try (Store store = createStore();
5412              InternalEngine engine = createEngine(config(indexSettings, store, createTempDir(), NoMergePolicy.INSTANCE, null))) {
5413             engine.close();
5414             expectThrows(AlreadyClosedException.class, () -&gt; engine.delete(replicaDeleteForDoc(&quot;test&quot;, 42, 7, System.nanoTime())));
5415         }
5416     }
5417     @Test
5418     public void testTrackMaxSeqNoOfUpdatesOrDeletesOnPrimary() throws Exception {
5419         engine.close();
5420         Set&lt;String&gt; liveDocIds = new HashSet&lt;&gt;();
5421         engine = new InternalEngine(engine.config());
5422         assertThat(engine.getMaxSeqNoOfUpdatesOrDeletes(), equalTo(-1L));
5423         int numOps = between(1, 500);
5424         for (int i = 0; i &lt; numOps; i++) {
5425             long currentMaxSeqNoOfUpdates = engine.getMaxSeqNoOfUpdatesOrDeletes();
5426             ParsedDocument doc = createParsedDoc(Integer.toString(between(1, 100)), null);
5427             if (randomBoolean()) {
5428 <A NAME="70"></A>                Engine.IndexResult result = engine.index(indexForDoc(doc));
5429                 if (liveDocIds.add(doc.id()) == false) {
5430                     assertThat(&quot;update operations on primary must advance max_seq_no_of_updates&quot;,
5431                                <FONT color="#3b9c9c"><div style="position:absolute;left:0"><A
5432                                        HREF="javascript:ZweiFrames('match306914-0.html#70',2,'match306914-top.html#70',1)"><IMG
5433                                        SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>engine.getMaxSeqNoOfUpdatesOrDeletes(), equalTo(Math.max(currentMaxSeqNoOfUpdates, result.getSeqNo())));
5434                 } else {
5435                     assertThat(&quot;append operations should not advance max_seq_no_of_updates&quot;,
5436 <A NAME="71"></A>                               engine.getMaxSeqNoOfUpdatesOrDeletes(), equalTo(currentMaxSeqNoOfUpdates));
5437                 }
5438             }</B></FONT> else {
5439                 Engine.DeleteResult result = <FONT color="#842dce"><div style="position:absolute;left:0"><A
5440                 HREF="javascript:ZweiFrames('match306914-0.html#71',2,'match306914-top.html#71',1)"><IMG SRC="back.gif"
5441                                                                                                          ALT="other"
5442                                                                                                          BORDER="0"
5443                                                                                                          ALIGN="left"></A></div><B>engine.delete(new Engine.Delete(
5444                     doc.id(),
5445                     newUid(doc.id()),
5446                     UNASSIGNED_SEQ_NO,
5447                     primaryTerm.get(),
5448                     Versions.MATCH_ANY,
5449                     VersionType.INTERNAL,
5450                     Engine.Operation.Origin.PRIMARY,
5451                     System.nanoTime(),
5452                     UNASSIGNED_SEQ_NO,
5453                     0
5454                 ));
5455                 liveDocIds.remove(doc.id());
5456                 assertThat(&quot;delete operations on primary must advance max_seq_no_of_updates&quot;,
5457 <A NAME="64"></A>                           engine.getMaxSeqNoOfUpdatesOrDeletes(), equalTo(Math.max</B></FONT>(currentMaxSeqNoOfUpdates, result.getSeqNo())));
5458             }
5459         }
5460     <FONT color="#38a4a5"><div style="position:absolute;left:0"><A
5461             HREF="javascript:ZweiFrames('match306914-0.html#64',2,'match306914-top.html#64',1)"><IMG SRC="back.gif"
5462                                                                                                      ALT="other"
5463                                                                                                      BORDER="0"
5464                                                                                                      ALIGN="left"></A></div><B>}
5465     @Test
5466     public void testRebuildLocalCheckpointTrackerAndVersionMap() throws Exception {
5467         Settings.Builder settings = Settings.builder()
5468             .put(defaultSettings.getSettings())
5469             .put(IndexSettings.INDEX_SOFT_DELETES_RETENTION_OPERATIONS_SETTING.getKey(), 10000)
5470             .put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey</B></FONT>(), true);
5471         final IndexMetadata indexMetadata = IndexMetadata.builder(defaultSettings.getIndexMetadata()).settings(settings).build();
5472         final IndexSettings indexSettings = IndexSettingsModule.newIndexSettings(indexMetadata);
5473         final AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
5474         Path translogPath = createTempDir();
5475         List&lt;Engine.Operation&gt; operations = generateHistoryOnReplica(between(1, 500), randomBoolean(), randomBoolean());
5476         List&lt;List&lt;Engine.Operation&gt;&gt; commits = new ArrayList&lt;&gt;();
5477         commits.add(new ArrayList&lt;&gt;());
5478         try (Store store = createStore()) {
5479             EngineConfig config = config(indexSettings, store, translogPath, NoMergePolicy.INSTANCE, null, null, globalCheckpoint::get);
5480             final List&lt;DocIdSeqNoAndSource&gt; docs;
5481             try (InternalEngine engine = createEngine(config)) {
5482                 List&lt;Engine.Operation&gt; flushedOperations = new ArrayList&lt;&gt;();
5483                 for (Engine.Operation op : operations) {
5484                     flushedOperations.add(op);
5485                     applyOperation(engine, op);
5486                     if (randomBoolean()) {
5487                         engine.syncTranslog();
5488                         globalCheckpoint.set(randomLongBetween(globalCheckpoint.get(), engine.getPersistedLocalCheckpoint()));
5489                     }
5490                     if (randomInt(100) &lt; 10) {
5491                         engine.refresh(&quot;test&quot;);
5492                     }
5493                     if (randomInt(100) &lt; 5) {
5494                         engine.flush(true, true);
5495                         flushedOperations.sort(Comparator.comparing(Engine.Operation::seqNo));
5496                         commits.add(new ArrayList&lt;&gt;(flushedOperations));
5497                     }
5498                 }
5499                 docs = getDocIds(engine, true);
5500             }
5501             List&lt;Engine.Operation&gt; operationsInSafeCommit = null;
5502             for (int i = commits.size() - 1; i &gt;= 0; i--) {
5503                 if (commits.get(i).stream().allMatch(op -&gt; op.seqNo() &lt;= globalCheckpoint.get())) {
5504                     operationsInSafeCommit = commits.get(i);
5505                     break;
5506                 }
5507             }
5508             assertThat(operationsInSafeCommit, notNullValue());
5509             try (InternalEngine engine = new InternalEngine(config)) {                 final Map&lt;BytesRef, Engine.Operation&gt; deletesAfterCheckpoint = new HashMap&lt;&gt;();
5510                 for (Engine.Operation op : operationsInSafeCommit) {
5511                     if (op instanceof Engine.NoOp == false &amp;&amp; op.seqNo() &gt; engine.getPersistedLocalCheckpoint()) {
5512                         deletesAfterCheckpoint.put(new Term(IdFieldMapper.NAME, Uid.encodeId(op.id())).bytes(), op);
5513                     }
5514                 }
5515                 deletesAfterCheckpoint.values().removeIf(o -&gt; o instanceof Engine.Delete == false);
5516 <A NAME="38"></A>                final Map&lt;BytesRef, VersionValue&gt; versionMap = engine.getVersionMap();
5517                 for (BytesRef uid : deletesAfterCheckpoint.keySet()) {
5518                     final VersionValue versionValue = versionMap.get(uid);
5519                     <FONT color="#348781"><div style="position:absolute;left:0"><A
5520                             HREF="javascript:ZweiFrames('match306914-0.html#38',2,'match306914-top.html#38',1)"><IMG
5521                             SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>final Engine.Operation op = deletesAfterCheckpoint.get(uid);
5522                     final String msg = versionValue + &quot; vs &quot; +
5523                         &quot;op[&quot; + op.operationType() + &quot;id=&quot; + op.id() + &quot; seqno=&quot; + op.seqNo() + &quot; term=&quot; + op.primaryTerm() + &quot;]&quot;;
5524                     assertThat(versionValue, instanceOf(DeleteVersionValue.class));
5525                     assertThat(msg, versionValue.seqNo, equalTo(op.seqNo()));
5526                     assertThat(msg, versionValue.term, equalTo(op.primaryTerm()));
5527                     assertThat(msg, versionValue.version, equalTo</B></FONT>(op.version()));
5528                 }
5529                 assertThat(versionMap.keySet(), equalTo(deletesAfterCheckpoint.keySet()));
5530                 final LocalCheckpointTracker tracker = engine.getLocalCheckpointTracker();
5531                 final Set&lt;Long&gt; seqNosInSafeCommit = operationsInSafeCommit.stream().map(op -&gt; op.seqNo()).collect(Collectors.toSet());
5532                 for (Engine.Operation op : operations) {
5533                     assertThat(
5534                         &quot;seq_no=&quot; + op.seqNo() + &quot; max_seq_no=&quot; + tracker.getMaxSeqNo() + &quot; checkpoint=&quot; + tracker.getProcessedCheckpoint(),
5535                         tracker.hasProcessed(op.seqNo()), equalTo(seqNosInSafeCommit.contains(op.seqNo())));
5536                 }
5537                 engine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
5538                 assertThat(getDocIds(engine, true), equalTo(docs));
5539             }
5540         }
5541     }
5542     @Test
5543     public void testRequireSoftDeletesWhenAccessingChangesSnapshot() throws Exception {
5544         try (Store store = createStore()) {
5545             final IndexSettings indexSettings = IndexSettingsModule.newIndexSettings(
5546                 IndexMetadata.builder(defaultSettings.getIndexMetadata()).settings(Settings.builder().
5547                     put(defaultSettings.getSettings()).put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), false)).build());
5548             try (InternalEngine engine = createEngine(config(indexSettings, store, createTempDir(), newMergePolicy(), null))) {
5549                 AssertionError error = expectThrows(AssertionError.class,
5550                                                     () -&gt; engine.newChangesSnapshot(&quot;test&quot;, createMapperService(&quot;test&quot;), 0, randomNonNegativeLong(), randomBoolean()));
5551                 assertThat(error.getMessage(), containsString(&quot;does not have soft-deletes enabled&quot;));
5552             }
5553         }
5554     }
5555     private void assertLuceneOperations(InternalEngine engine,
5556                                         long expectedAppends,
5557 <A NAME="34"></A>                                        long expectedUpdates,
5558                                         long expectedDeletes) {
5559         String message = &quot;Lucene operations mismatched;&quot; +
5560                          &quot; appends [actual:&quot; + <FONT color="#827d6b"><div style="position:absolute;left:0"><A
5561                 HREF="javascript:ZweiFrames('match306914-0.html#34',2,'match306914-top.html#34',1)"><IMG SRC="back.gif"
5562                                                                                                          ALT="other"
5563                                                                                                          BORDER="0"
5564                                                                                                          ALIGN="left"></A></div><B>engine.getNumDocAppends() + &quot;, expected:&quot; + expectedAppends + &quot;],&quot; +
5565                          &quot; updates [actual:&quot; + engine.getNumDocUpdates() + &quot;, expected:&quot; + expectedUpdates + &quot;],&quot; +
5566                          &quot; deletes [actual:&quot; + engine.getNumDocDeletes() + &quot;, expected:&quot; + expectedDeletes + &quot;]&quot;;
5567         assertThat(message, engine.getNumDocAppends(), equalTo(expectedAppends));
5568         assertThat(message, engine.getNumDocUpdates(), equalTo(expectedUpdates));
5569         assertThat(message, engine.getNumDocDeletes(), equalTo(expectedDeletes));
5570     }
5571     @Test
5572     public void testStoreHonorsLuceneVersion() throws IOException {</B></FONT>
5573         for (Version createdVersion : Arrays.asList(
5574                 Version.CURRENT, VersionUtils.getPreviousMinorVersion(), VersionUtils.getFirstVersion())) {
5575             Settings settings = Settings.builder()
5576                     .put(indexSettings())
5577                     .put(IndexMetadata.SETTING_VERSION_CREATED, createdVersion).build();
5578             IndexSettings indexSettings = IndexSettingsModule.newIndexSettings(&quot;test&quot;, settings);
5579             try (Store store = createStore();
5580                     InternalEngine engine = createEngine(config(indexSettings, store, createTempDir(), NoMergePolicy.INSTANCE, null))) {
5581                 ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, new Document(),
5582                         new BytesArray(&quot;{}&quot;.getBytes(&quot;UTF-8&quot;)), null);
5583                 engine.index(appendOnlyPrimary(doc, false, 1));
5584                 engine.refresh(&quot;test&quot;);
5585                 try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
5586                     LeafReader leafReader = getOnlyLeafReader(searcher.getIndexReader());
5587                     assertEquals(createdVersion.luceneVersion.major, leafReader.getMetaData().getCreatedVersionMajor());
5588                 }
5589             }
5590         }
5591     }
5592     @Test
5593     public void testMaxSeqNoInCommitUserData() throws Exception {
5594         AtomicBoolean running = new AtomicBoolean(true);
5595         Thread rollTranslog = new Thread(() -&gt; {
5596             while (running.get() &amp;&amp; engine.getTranslog().currentFileGeneration() &lt; 500) {
5597                 engine.rollTranslogGeneration();             }
5598         });
5599         rollTranslog.start();
5600         Thread indexing = new Thread(() -&gt; {
5601             long seqNo = 0;
5602             while (running.get() &amp;&amp; seqNo &lt;= 1000) {
5603                 try {
5604                     String id = Long.toString(between(1, 50));
5605                     if (randomBoolean()) {
5606                         ParsedDocument doc = testParsedDocument(id, null, testDocumentWithTextField(), SOURCE, null);
5607                         engine.index(replicaIndexForDoc(doc, 1L, seqNo, false));
5608                     } else {
5609                         engine.delete(replicaDeleteForDoc(id, 1L, seqNo, 0L));
5610                     }
5611                     seqNo++;
5612                 } catch (IOException e) {
5613                     throw new AssertionError(e);
5614                 }
5615             }
5616         });
5617         indexing.start();
5618         int numCommits = between(5, 20);
5619         for (int i = 0; i &lt; numCommits; i++) {
5620             engine.flush(false, true);
5621         }
5622         running.set(false);
5623         indexing.join();
5624         rollTranslog.join();
5625         assertMaxSeqNoInCommitUserData(engine);
5626     }
5627     @Test
5628     public void testPruneAwayDeletedButRetainedIds() throws Exception {
5629         IOUtils.close(engine, store);
5630         Settings settings = Settings.builder()
5631             .put(defaultSettings.getSettings())
5632             .put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), true).build();
5633         IndexSettings indexSettings = IndexSettingsModule.newIndexSettings(
5634             IndexMetadata.builder(defaultSettings.getIndexMetadata()).settings(settings).build());
5635         store = createStore(indexSettings, newDirectory());
5636         LogDocMergePolicy policy = new LogDocMergePolicy();
5637         policy.setMinMergeDocs(10000);
5638         try (InternalEngine engine = createEngine(indexSettings, store, createTempDir(), policy)) {
5639             int numDocs = between(1, 20);
5640             logger.info(&quot;&quot; + numDocs);
5641             for (int i = 0; i &lt; numDocs; i++) {
5642                 index(engine, i);
5643             }
5644             engine.forceMerge(true, 1, false, false, false, UUIDs.randomBase64UUID());
5645             engine.delete(new Engine.Delete(&quot;0&quot;, newUid(&quot;0&quot;), primaryTerm.get()));
5646             engine.refresh(&quot;test&quot;);
5647             try (Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
5648                 IndexReader reader = searcher.getIndexReader();
5649                 assertEquals(2, reader.leaves().size());
5650                 LeafReaderContext leafReaderContext = reader.leaves().get(0);
5651                 LeafReader leafReader = leafReaderContext.reader();
5652                 assertEquals(&quot;the delete and the tombstone&quot;, 1, leafReader.numDeletedDocs());
5653                 assertEquals(numDocs, leafReader.maxDoc());
5654                 Terms id = leafReader.terms(&quot;_id&quot;);
5655                 assertNotNull(id);
5656                 assertEquals(&quot;deleted IDs are NOT YET pruned away&quot;, reader.numDocs() + 1, id.size());
5657                 TermsEnum iterator = id.iterator();
5658                 assertTrue(iterator.seekExact(Uid.encodeId(&quot;0&quot;)));
5659             }
5660             engine.forceMerge(true, 1, false, false, false, UUIDs.randomBase64UUID());
5661             engine.refresh(&quot;test&quot;);
5662             try (Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
5663                 IndexReader reader = searcher.getIndexReader();
5664                 assertEquals(1, reader.leaves().size());
5665                 LeafReaderContext leafReaderContext = reader.leaves().get(0);
5666                 LeafReader leafReader = leafReaderContext.reader();
5667                 assertEquals(&quot;the delete and the tombstone&quot;, 2, leafReader.numDeletedDocs());
5668                 assertEquals(numDocs + 1, leafReader.maxDoc());
5669                 Terms id = leafReader.terms(&quot;_id&quot;);
5670                 if (numDocs == 1) {
5671                     assertNull(id);                     assertEquals(0, leafReader.numDocs());
5672                 } else {
5673                     assertNotNull(id);
5674                     assertEquals(&quot;deleted IDs are pruned away&quot;, reader.numDocs(), id.size());
5675                     TermsEnum iterator = id.iterator();
5676                     assertFalse(iterator.seekExact(Uid.encodeId(&quot;0&quot;)));
5677                 }
5678              }
5679          }
5680     }
5681     @Test
5682     public void testRecoverFromLocalTranslog() throws Exception {
5683         final AtomicLong globalCheckpoint = new AtomicLong(SequenceNumbers.NO_OPS_PERFORMED);
5684         Path translogPath = createTempDir();
5685         List&lt;Engine.Operation&gt; operations = generateHistoryOnReplica(between(1, 500), randomBoolean(), randomBoolean());
5686         try (Store store = createStore()) {
5687             EngineConfig config = config(defaultSettings, store, translogPath, newMergePolicy(), null, null, globalCheckpoint::get);
5688             final List&lt;DocIdSeqNoAndSource&gt; docs;
5689             try (InternalEngine engine = createEngine(config)) {
5690                 for (Engine.Operation op : operations) {
5691                     applyOperation(engine, op);
5692                     if (randomBoolean()) {
5693                         engine.syncTranslog();
5694                         globalCheckpoint.set(randomLongBetween(globalCheckpoint.get(), engine.getPersistedLocalCheckpoint()));
5695                     }
5696                     if (randomInt(100) &lt; 10) {
5697                         engine.refresh(&quot;test&quot;);
5698                     }
5699                     if (randomInt(100) &lt; 5) {
5700                         engine.flush();
5701                     }
5702                     if (randomInt(100) &lt; 5) {
5703                         engine.forceMerge(randomBoolean(), 1, false, false, false, UUIDs.randomBase64UUID());
5704                     }
5705                 }
5706                 if (randomBoolean()) {
5707                     engine.syncTranslog();
5708                     globalCheckpoint.set(engine.getPersistedLocalCheckpoint());
5709                     engine.flush();
5710                 }
5711                 docs = getDocIds(engine, true);
5712             }
5713             try (InternalEngine engine = new InternalEngine(config)) {
5714                 engine.onSettingsChanged(TimeValue.MINUS_ONE, ByteSizeValue.ZERO, 0);
5715                 engine.recoverFromTranslog(translogHandler, Long.MAX_VALUE);
5716                 assertThat(getDocIds(engine, randomBoolean()), equalTo(docs));
5717                 if (engine.getSeqNoStats(globalCheckpoint.get()).getMaxSeqNo() == globalCheckpoint.get()) {
5718                     assertThat(&quot;engine should trim all unreferenced translog after recovery&quot;,
5719                         engine.getTranslog().getMinFileGeneration(), equalTo(engine.getTranslog().currentFileGeneration()));
5720                 }
5721             }
5722         }
5723     }
5724 <A NAME="74"></A>
5725     private Map&lt;BytesRef, DeleteVersionValue&gt; tombstonesInVersionMap(InternalEngine engine) {
5726         return <FONT color="#3090c7"><div style="position:absolute;left:0"><A
5727                 HREF="javascript:ZweiFrames('match306914-0.html#74',2,'match306914-top.html#74',1)"><IMG SRC="back.gif"
5728                                                                                                          ALT="other"
5729                                                                                                          BORDER="0"
5730                                                                                                          ALIGN="left"></A></div><B>engine.getVersionMap().entrySet().stream()
5731             .filter(e -&gt; e.getValue() instanceof DeleteVersionValue)
5732             .collect(Collectors.toMap(e -&gt; e.getKey(), e -&gt; (DeleteVersionValue) e.getValue</B></FONT>()));
5733     }
5734     @Test
5735     public void testTreatDocumentFailureAsFatalError() throws Exception {
5736         AtomicReference&lt;IOException&gt; addDocException = new AtomicReference&lt;&gt;();
5737         IndexWriterFactory indexWriterFactory = (dir, iwc) -&gt; new IndexWriter(dir, iwc) {
5738             @Override
5739             public long addDocument(Iterable&lt;? extends IndexableField&gt; doc) throws IOException {
5740                 final IOException ex = addDocException.getAndSet(null);
5741                 if (ex != null) {
5742                     throw ex;
5743                 }
5744                 return super.addDocument(doc);
5745             }
5746         };
5747         try (Store store = createStore();
5748              InternalEngine engine = createEngine(defaultSettings,
5749                                                   store,
5750                                                   createTempDir(),
5751                                                   NoMergePolicy.INSTANCE,
5752                                                   indexWriterFactory)) {
5753 <A NAME="63"></A>            final ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(), SOURCE, null);
5754             Engine.Operation.Origin origin = randomFrom(REPLICA, LOCAL_RESET, PEER_RECOVERY);
5755             Engine.Index index = new Engine.Index(
5756                 <FONT color="#8c8774"><div style="position:absolute;left:0"><A
5757                         HREF="javascript:ZweiFrames('match306914-0.html#63',2,'match306914-top.html#63',1)"><IMG
5758                         SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>newUid(doc),
5759                 doc,
5760                 randomNonNegativeLong(),
5761                 primaryTerm.get(),
5762                 randomNonNegativeLong(),
5763                 null,
5764                 origin,
5765                 System.nanoTime(),
5766                 -1,
5767                 false,
5768                 UNASSIGNED_SEQ_NO,
5769                 UNASSIGNED_PRIMARY_TERM);
5770             addDocException.set(new IOException(&quot;simulated&quot;));
5771             expectThrows(IOException.class, () -&gt; engine.index(index));
5772 <A NAME="45"></A>            assertTrue(engine.isClosed.get());
5773             assertNotNull(engine.failedEngine.get</B></FONT>());
5774         }
5775     <FONT color="#549748"><div style="position:absolute;left:0"><A
5776             HREF="javascript:ZweiFrames('match306914-0.html#45',2,'match306914-top.html#45',1)"><IMG SRC="back.gif"
5777                                                                                                      ALT="other"
5778                                                                                                      BORDER="0"
5779                                                                                                      ALIGN="left"></A></div><B>}
5780     @Test
5781     public void testAlwaysRecordReplicaOrPeerRecoveryOperationsToTranslog() throws Exception {
5782         List&lt;Engine.Operation&gt; operations = generateHistoryOnReplica(between(1, 100), randomBoolean(), randomBoolean());
5783         applyOperations(engine, operations);
5784         Set&lt;Long&gt; seqNos = operations.stream().map(Engine.Operation::seqNo).collect(Collectors.toSet</B></FONT>());
5785         try (Translog.Snapshot snapshot = getTranslog(engine).newSnapshot()) {
5786             assertThat(snapshot.totalOperations(), equalTo(operations.size()));
5787             assertThat(TestTranslog.drainSnapshot(snapshot, false).stream().map(Translog.Operation::seqNo).collect(Collectors.toSet()),
5788                 equalTo(seqNos));
5789         }
5790         primaryTerm.set(randomLongBetween(primaryTerm.get(), Long.MAX_VALUE));
5791         engine.rollTranslogGeneration();
5792         engine.trimOperationsFromTranslog(primaryTerm.get(), NO_OPS_PERFORMED);         try (Translog.Snapshot snapshot = getTranslog(engine).newSnapshot()) {
5793             assertThat(snapshot.totalOperations(), equalTo(0));
5794             assertNull(snapshot.next());
5795         }
5796         applyOperations(engine, operations);
5797         try (Translog.Snapshot snapshot = getTranslog(engine).newSnapshot()) {
5798             assertThat(snapshot.totalOperations(), equalTo(operations.size()));
5799             assertThat(TestTranslog.drainSnapshot(snapshot, false).stream().map(Translog.Operation::seqNo).collect(Collectors.toSet()),
5800                 equalTo(seqNos));
5801         }
5802     }
5803     @Test
5804     public void testNoOpFailure() throws IOException {
5805         engine.close();
5806         final Settings settings = Settings.builder()
5807             .put(defaultSettings.getSettings())
5808             .put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), true).build();
5809         final IndexSettings indexSettings = IndexSettingsModule.newIndexSettings(
5810             IndexMetadata.builder(defaultSettings.getIndexMetadata()).settings(settings).build());
5811         try (Store store = createStore();
5812              Engine engine = createEngine((dir, iwc) -&gt; new IndexWriter(dir, iwc) {
5813                  @Override
5814                  public long addDocument(Iterable&lt;? extends IndexableField&gt; doc) {
5815                      throw new IllegalArgumentException(&quot;fatal&quot;);
5816 <A NAME="16"></A>                 }
5817              }, null, null, config(indexSettings, store, createTempDir(), NoMergePolicy.INSTANCE, null))) {
5818             final Engine.NoOp op = new Engine.NoOp(0, 0, PRIMARY, <FONT color="#2981b2"><div
5819                 style="position:absolute;left:0"><A
5820                 HREF="javascript:ZweiFrames('match306914-0.html#16',2,'match306914-top.html#16',1)"><IMG SRC="back.gif"
5821                                                                                                          ALT="other"
5822                                                                                                          BORDER="0"
5823                                                                                                          ALIGN="left"></A></div><B>System.currentTimeMillis(), &quot;test&quot;);
5824             final IllegalArgumentException e = expectThrows(IllegalArgumentException. class, () -&gt; engine.noOp(op));
5825             assertThat(e.getMessage(), equalTo(&quot;fatal&quot;));
5826             assertTrue(engine.isClosed.get());
5827             assertThat(engine.failedEngine.get(), not(nullValue()));
5828             assertThat(engine.failedEngine.get(), instanceOf(IllegalArgumentException.class));
5829             assertThat(engine.failedEngine.get().getMessage(), equalTo(&quot;fatal&quot;));
5830         }</B></FONT>
5831     }
5832     @Test
5833     public void testDeleteFailureSoftDeletesEnabledDocAlreadyDeleted() throws IOException {
5834         runTestDeleteFailure(true, InternalEngine::delete);
5835     }
5836     @Test
5837     public void testDeleteFailureSoftDeletesEnabled() throws IOException {
5838         runTestDeleteFailure(true, (engine, op) -&gt; {});
5839     }
5840     @Test
5841     public void testDeleteFailureSoftDeletesDisabled() throws IOException {
5842         runTestDeleteFailure(false, (engine, op) -&gt; {});
5843     }
5844     private void runTestDeleteFailure(
5845         final boolean softDeletesEnabled,
5846         final CheckedBiConsumer&lt;InternalEngine, Engine.Delete, IOException&gt; consumer) throws IOException {
5847         engine.close();
5848         final Settings settings = Settings.builder()
5849             .put(defaultSettings.getSettings())
5850             .put(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), softDeletesEnabled).build();
5851         final IndexSettings indexSettings = IndexSettingsModule.newIndexSettings(
5852             IndexMetadata.builder(defaultSettings.getIndexMetadata()).settings(settings).build());
5853         final AtomicReference&lt;ThrowingIndexWriter&gt; iw = new AtomicReference&lt;&gt;();
5854         try (Store store = createStore();
5855              InternalEngine engine = createEngine(
5856                  (dir, iwc) -&gt; {
5857                      iw.set(new ThrowingIndexWriter(dir, iwc));
5858                      return iw.get();
5859                  },
5860                  null,
5861                  null,
5862                  config(indexSettings, store, createTempDir(), NoMergePolicy.INSTANCE, null)
5863             )) {
5864             engine.index(new Engine.Index(newUid(&quot;0&quot;), primaryTerm.get(), InternalEngineTests.createParsedDoc(&quot;0&quot;, null)));
5865 <A NAME="29"></A>            final Engine.Delete op = new Engine.Delete(&quot;0&quot;, newUid(&quot;0&quot;), primaryTerm.get());
5866             consumer.accept(engine, op);
5867             iw.get().setThrowFailure(() -&gt; new IllegalArgumentException(&quot;fatal&quot;));
5868             <FONT color="#af7a82"><div style="position:absolute;left:0"><A
5869                     HREF="javascript:ZweiFrames('match306914-0.html#29',2,'match306914-top.html#29',1)"><IMG
5870                     SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>final IllegalArgumentException e = expectThrows(IllegalArgumentException. class, () -&gt; engine.delete(op));
5871             assertThat(e.getMessage(), equalTo(&quot;fatal&quot;));
5872             assertTrue(engine.isClosed.get());
5873             assertThat(engine.failedEngine.get(), not(nullValue()));
5874             assertThat(engine.failedEngine.get(), instanceOf(IllegalArgumentException.class));
5875             assertThat(engine.failedEngine.get().getMessage(), equalTo</B></FONT>(&quot;fatal&quot;));
5876         }
5877     }
5878     @Test
5879     public void testRealtimeGetOnlyRefreshIfNeeded() throws Exception {
5880         final AtomicInteger refreshCount = new AtomicInteger();
5881         final ReferenceManager.RefreshListener refreshListener = new ReferenceManager.RefreshListener() {
5882             @Override
5883             public void beforeRefresh() {
5884             }
5885             @Override
5886             public void afterRefresh(boolean didRefresh) {
5887                 if (didRefresh) {
5888                     refreshCount.incrementAndGet();
5889                 }
5890             }
5891         };
5892         try (Store store = createStore()) {
5893             final EngineConfig config = config(
5894                 defaultSettings,
5895                 store,
5896                 createTempDir(),
5897                 newMergePolicy(),
5898                 null,
5899                 refreshListener,
5900                 null,
5901                 null
5902             );
5903             try (InternalEngine engine = createEngine(config)) {
5904                 int numDocs = randomIntBetween(10, 100);
5905                 Set&lt;String&gt; ids = new HashSet&lt;&gt;();
5906                 for (int i = 0; i &lt; numDocs; i++) {
5907                     String id = Integer.toString(i);
5908                     engine.index(indexForDoc(createParsedDoc(id, null)));
5909                     ids.add(id);
5910                 }
5911                 final int refreshCountBeforeGet = refreshCount.get();
5912                 Thread[] getters = new Thread[randomIntBetween(1, 4)];
5913                 Phaser phaser = new Phaser(getters.length + 1);
5914                 for (int t = 0; t &lt; getters.length; t++) {
5915                     getters[t] = new Thread(() -&gt; {
5916                         phaser.arriveAndAwaitAdvance();
5917                         int iters = randomIntBetween(1, 10);
5918                         for (int i = 0; i &lt; iters; i++) {
5919                             ParsedDocument doc = createParsedDoc(randomFrom(ids), null);
5920                             try (Engine.GetResult getResult = engine.get(newGet(doc), engine::acquireSearcher)) {
5921                                 assertThat(getResult.docIdAndVersion(), notNullValue());
5922                             }
5923                         }
5924                     });
5925                     getters[t].start();
5926                 }
5927                 phaser.arriveAndAwaitAdvance();
5928                 for (int i = 0; i &lt; numDocs; i++) {
5929                     engine.index(indexForDoc(createParsedDoc(&quot;more-&quot; + i, null)));
5930                 }
5931                 for (Thread getter : getters) {
5932                     getter.join();
5933                 }
5934                 assertThat(refreshCount.get(), lessThanOrEqualTo(refreshCountBeforeGet + 1));
5935             }
5936         }
5937     }
5938     @Test
5939     public void testRefreshDoesNotBlockClosing() throws Exception {
5940         final CountDownLatch refreshStarted = new CountDownLatch(1);
5941         final CountDownLatch engineClosed = new CountDownLatch(1);
5942         final ReferenceManager.RefreshListener refreshListener = new ReferenceManager.RefreshListener() {
5943             @Override
5944             public void beforeRefresh() {
5945                 refreshStarted.countDown();
5946                 try {
5947                     engineClosed.await();
5948                 } catch (InterruptedException e) {
5949                     throw new AssertionError(e);
5950                 }
5951             }
5952             @Override
5953             public void afterRefresh(boolean didRefresh) {
5954                 assertFalse(didRefresh);
5955             }
5956         };
5957         try (Store store = createStore()) {
5958             final EngineConfig config = config(
5959                 defaultSettings,
5960                 store,
5961                 createTempDir(),
5962                 newMergePolicy(),
5963                 null,
5964                 refreshListener,
5965                 null,
5966                 null
5967             );
5968             try (InternalEngine engine = createEngine(config)) {
5969                 if (randomBoolean()) {
5970                     engine.index(indexForDoc(createParsedDoc(&quot;id&quot;, null)));
5971                 }
5972                 threadPool.executor(ThreadPool.Names.REFRESH).execute(() -&gt;
5973                     expectThrows(AlreadyClosedException.class,
5974                         () -&gt; engine.refresh(&quot;test&quot;, randomFrom(Engine.SearcherScope.values()), true)));
5975                 refreshStarted.await();
5976                 engine.close();
5977                 engineClosed.countDown();
5978             }
5979         }
5980     }
5981     @Test
5982     public void testDeleteDocumentFailuresShouldFailEngine() throws IOException {
5983         engine.close();
5984         final Settings settings = Settings.builder()
5985             .put(defaultSettings.getSettings())
5986             .build();
5987         final IndexSettings indexSettings = IndexSettingsModule.newIndexSettings(
5988             IndexMetadata.builder(defaultSettings.getIndexMetadata()).settings(settings).build());
5989         final AtomicReference&lt;ThrowingIndexWriter&gt; iw = new AtomicReference&lt;&gt;();
5990         try (Store store = createStore();
5991              InternalEngine engine = createEngine(
5992                  (dir, iwc) -&gt; {
5993                      iw.set(new ThrowingIndexWriter(dir, iwc));
5994                      return iw.get();
5995                  },
5996                  null,
5997                  null,
5998                  config(indexSettings, store, createTempDir(), NoMergePolicy.INSTANCE, null))) {
5999             engine.index(new Engine.Index(
6000                 newUid(&quot;0&quot;), InternalEngineTests.createParsedDoc(&quot;0&quot;, null), UNASSIGNED_SEQ_NO, primaryTerm.get(),
6001                 Versions.MATCH_DELETED, VersionType.INTERNAL,
6002                 Engine.Operation.Origin.PRIMARY, System.nanoTime(), -1, false, UNASSIGNED_SEQ_NO, 0));
6003             Engine.Delete op = new Engine.Delete(
6004                 &quot;0&quot;,
6005                 newUid(&quot;0&quot;),
6006                 UNASSIGNED_SEQ_NO,
6007                 primaryTerm.get(),
6008                 Versions.MATCH_ANY,
6009                 VersionType.INTERNAL,
6010                 Engine.Operation.Origin.PRIMARY,
6011                 System.nanoTime(),
6012                 UNASSIGNED_SEQ_NO,
6013                 0
6014 <A NAME="23"></A>            );
6015             iw.get().setThrowFailure(() -&gt; new IllegalArgumentException(&quot;fatal&quot;));
6016             <FONT color="#f660ab"><div style="position:absolute;left:0"><A
6017                     HREF="javascript:ZweiFrames('match306914-0.html#23',2,'match306914-top.html#23',1)"><IMG
6018                     SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>final IllegalArgumentException e = expectThrows(IllegalArgumentException.class, () -&gt; engine.delete(op));
6019             assertThat(e.getMessage(), equalTo(&quot;fatal&quot;));
6020             assertThat(engine.isClosed.get(), is(true));
6021             assertThat(engine.failedEngine.get(), not(nullValue()));
6022             assertThat(engine.failedEngine.get(), instanceOf(IllegalArgumentException.class));
6023             assertThat(engine.failedEngine.get().getMessage(), equalTo</B></FONT>(&quot;fatal&quot;));
6024         }
6025     }
6026     public static &lt;T&gt; void assertThatIfAssertionEnabled(T actual, Matcher&lt;? super T&gt; matcher) {
6027         if (InternalEngineTests.class.desiredAssertionStatus()) {
6028             assertThat(actual, matcher);
6029         }
6030     }
6031     @Test
6032     public void testProducesStoredFieldsReader() throws Exception {
6033         ParsedDocument doc = testParsedDocument(&quot;1&quot;, null, testDocumentWithTextField(&quot;test&quot;),
6034                                                 new BytesArray(&quot;{}&quot;.getBytes(Charset.defaultCharset())), null);
6035         Engine.Index operation = randomBoolean() ?
6036             appendOnlyPrimary(doc, false, 1)
6037             : appendOnlyReplica(doc, false, 1, randomIntBetween(0, 5));
6038         engine.index(operation);
6039         engine.refresh(&quot;test&quot;);
6040         try (Engine.Searcher searcher = engine.acquireSearcher(&quot;test&quot;)) {
6041             IndexReader reader = searcher.getIndexReader();
6042             assertThat(reader.leaves().size(), Matchers.greaterThanOrEqualTo(1));
6043             for (LeafReaderContext context: reader.leaves()) {
6044                 assertThat(context.reader(), Matchers.instanceOf(SequentialStoredFieldsLeafReader.class));
6045                 SequentialStoredFieldsLeafReader lf = (SequentialStoredFieldsLeafReader) context.reader();
6046                 assertNotNull(lf.getSequentialStoredFieldsReader());
6047             }
6048         }
6049     }
6050 }
</PRE>
    </div>
</div>
<div class="modal" id="myModal" style="display:none;">
    <div class="modal-content"><span class="close">x</span>
        <p></p>
        <div class="row">
            <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div>
            <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div>
        </div>
        <div class="row">
            <div class="column" id="column1">Column 1</div>
            <div class="column" id="column2">Column 2</div>
        </div>
    </div>
</div>
<script>var modal = document.getElementById("myModal"), span = document.getElementsByClassName("close")[0];
span.onclick = function () {
    modal.style.display = "none"
};
window.onclick = function (a) {
    a.target == modal && (modal.style.display = "none")
};

function openModal(a) {
    console.log("the color is " + a);
    let b = getCodes(a);
    console.log(b);
    var c = document.getElementById("column1");
    c.innerText = b[0];
    var d = document.getElementById("column2");
    d.innerText = b[1];
    c.style.color = a;
    c.style.fontWeight = "bold";
    d.style.fontWeight = "bold";
    d.style.color = a;
    var e = document.getElementById("myModal");
    e.style.display = "block"
}

function getCodes(a) {
    for (var b = document.getElementsByTagName("font"), c = [], d = 0; d < b.length; d++) b[d].attributes.color.nodeValue === a && "-" !== b[d].innerText && c.push(b[d].innerText);
    return c
}</script>
<script>const params = window.location.search;
const urlParams = new URLSearchParams(params);
const searchText = urlParams.get('lines');
let lines = searchText.split(',');
for (let line of lines) {
    const elements = document.getElementsByTagName('td');
    for (let i = 0; i < elements.length; i++) {
        if (elements[i].innerText.includes(line)) {
            elements[i].style.background = 'green';
            break;
        }
    }
}</script>
</body>
</html>
