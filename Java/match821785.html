<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for ColumnsIterableTest.java &amp; AlterTableReroutePlan.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for ColumnsIterableTest.java &amp; AlterTableReroutePlan.java
      </h3>
<h1 align="center">
        17.8%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>ColumnsIterableTest.java (28.571428%)<th>AlterTableReroutePlan.java (12.969283%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(24-45)<td><a href="#" name="0">(46-67)</a><td align="center"><font color="#ff0000">18</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(85-90)<td><a href="#" name="1">(85-97)</a><td align="center"><font color="#9b0000">11</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(93-97)<td><a href="#" name="2">(156-163)</a><td align="center"><font color="#7f0000">9</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>ColumnsIterableTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Licensed to Crate.io GmbH ("Crate") under one or more contributor
3  * license agreements.  See the NOTICE file distributed with this work for
4  * additional information regarding copyright ownership.  Crate licenses
5  * this file to you under the Apache License, Version 2.0 (the "License");
6  * you may not use this file except in compliance with the License.  You may
7  * obtain a copy of the License at
8  *
9  *   http://www.apache.org/licenses/LICENSE-2.0
10  *
11  * Unless required by applicable law or agreed to in writing, software
12  * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
13  * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
14  * License for the specific language governing permissions and limitations
15  * under the License.
16  *
17  * However, if you have executed another commercial license agreement
18  * with Crate these terms will supersede the license and you may use the
19  * software solely pursuant to the terms of the relevant commercial agreement.
20  */
21 <a name="0"></a>
22 package io.crate.execution.engine.collect.sources;
23 <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>import io.crate.expression.reference.information.ColumnContext;
24 import io.crate.metadata.RelationInfo;
25 import io.crate.test.integration.CrateDummyClusterServiceUnitTest;
26 import io.crate.testing.SQLExecutor;
27 import org.hamcrest.Matchers;
28 import org.junit.Before;
29 import org.junit.Test;
30 import java.util.ArrayList;
31 import java.util.List;
32 import java.util.stream.Collectors;
33 import java.util.stream.StreamSupport;
34 import static io.crate.testing.T3.T1;
35 import static io.crate.testing.T3.T1_DEFINITION;
36 import static io.crate.testing.T3.T4;
37 import static io.crate.testing.T3.T4_DEFINITION;
38 import static org.hamcrest.Matchers.is;
39 public class ColumnsIterableTest extends CrateDummyClusterServiceUnitTest {
40     private RelationInfo t1Info</b></font>;
41     private RelationInfo t4Info;
42     @Before
43     public void prepare() throws Exception {
44         SQLExecutor e = SQLExecutor.builder(clusterService)
45             .addTable(T1_DEFINITION)
46             .addTable(T4_DEFINITION)
47             .build();
48         t1Info = e.resolveTableInfo(T1.fqn());
49         t4Info = e.resolveTableInfo(T4.fqn());
50     }
51     @Test
52     public void testColumnsIteratorCanBeMaterializedToList() {
53         InformationSchemaIterables.ColumnsIterable columns = new InformationSchemaIterables.ColumnsIterable(t1Info);
54         List&lt;ColumnContext&gt; contexts = StreamSupport.stream(columns.spliterator(), false)
55             .collect(Collectors.toList());
56         assertThat(
57             contexts.stream().map(c -&gt; c.info.column().name()).collect(Collectors.toList()),
58             Matchers.contains("a", "x", "i"));
59     }
60     @Test
61     public void testColumnsIterableCanBeConsumedTwice() {
62         List&lt;String&gt; names = new ArrayList&lt;&gt;(6);
63         InformationSchemaIterables.ColumnsIterable columns = new InformationSchemaIterables.ColumnsIterable(t1Info);
64         for (ColumnContext column : columns) {
65             names.add(column.info.column().name());
66         }
67         for (ColumnContext column : columns) {
68             names.add(column.info.column().name());
69         }
70         assertThat(names, Matchers.contains("a", "x", "i", "a", "x", "i"));
71     }
72 <a name="1"></a>    @Test
73     public void testOrdinalIsNotNullOnSubColumns() throws Exception {
74         InformationSchemaIterables.ColumnsIterable columns = new InformationSchemaIterables.ColumnsIterable(t4Info);
75         <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>List&lt;ColumnContext&gt; contexts = StreamSupport.stream(columns.spliterator(), false)
76             .collect(Collectors.toList());
77         assertThat(contexts.get(1).info.position(), is(2));
78 <a name="2"></a>        assertThat(contexts.get(2).info.position</b></font>(), is(3));
79         assertThat(contexts.get(3).info.position(), <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>is(4));
80         assertThat(contexts.get(4).info.position(), is(5));
81     }
82     @</b></font>Test
83     public void test_bit_type_has_character_maximum_length_set() throws Exception {
84         SQLExecutor e = SQLExecutor.builder(clusterService)
85             .addTable("create table bit_table (xs bit(12))")
86             .build();
87         var columns = new InformationSchemaIterables.ColumnsIterable(e.resolveTableInfo("bit_table"));
88         var contexts = StreamSupport.stream(columns.spliterator(), false).toList();
89         assertThat(contexts.get(0).characterMaximumLength(), is(12));
90     }
91 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>AlterTableReroutePlan.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 /*
2  * Licensed to Crate.io GmbH ("Crate") under one or more contributor
3  * license agreements.  See the NOTICE file distributed with this work for
4  * additional information regarding copyright ownership.  Crate licenses
5  * this file to you under the Apache License, Version 2.0 (the "License");
6  * you may not use this file except in compliance with the License.  You may
7  * obtain a copy of the License at
8  *
9  *   http://www.apache.org/licenses/LICENSE-2.0
10  *
11  * Unless required by applicable law or agreed to in writing, software
12  * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
13  * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
14  * License for the specific language governing permissions and limitations
15  * under the License.
16  *
17  * However, if you have executed another commercial license agreement
18  * with Crate these terms will supersede the license and you may use the
19  * software solely pursuant to the terms of the relevant commercial agreement.
20  */
21 package io.crate.planner.node.management;
22 import io.crate.analyze.AnalyzedPromoteReplica;
23 import io.crate.analyze.AnalyzedRerouteAllocateReplicaShard;
24 import io.crate.analyze.AnalyzedRerouteCancelShard;
25 import io.crate.analyze.AnalyzedRerouteMoveShard;
26 import io.crate.analyze.AnalyzedStatement;
27 import io.crate.analyze.AnalyzedStatementVisitor;
28 import io.crate.analyze.PartitionPropertiesAnalyzer;
29 import io.crate.analyze.SymbolEvaluator;
30 import io.crate.common.annotations.VisibleForTesting;
31 import io.crate.common.collections.Lists2;
32 import io.crate.data.Row;
33 import io.crate.data.Row1;
34 import io.crate.data.RowConsumer;
35 import io.crate.execution.support.OneRowActionListener;
36 import io.crate.expression.symbol.Symbol;
37 import io.crate.metadata.CoordinatorTxnCtx;
38 import io.crate.metadata.NodeContext;
39 import io.crate.metadata.PartitionName;
40 import io.crate.metadata.doc.DocTableInfo;
41 <a name="0"></a>import io.crate.metadata.table.ShardedTable;
42 import io.crate.planner.DependencyCarrier;
43 import io.crate.planner.Plan;
44 <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>import io.crate.planner.PlannerContext;
45 import io.crate.planner.operators.SubQueryResults;
46 import io.crate.sql.tree.Assignment;
47 import io.crate.sql.tree.GenericProperties;
48 import io.crate.types.DataTypes;
49 import org.elasticsearch.action.admin.cluster.reroute.ClusterRerouteRequest;
50 import org.elasticsearch.cluster.node.DiscoveryNodes;
51 import org.elasticsearch.cluster.routing.allocation.command.AllocateReplicaAllocationCommand;
52 import org.elasticsearch.cluster.routing.allocation.command.AllocateStalePrimaryAllocationCommand;
53 import org.elasticsearch.cluster.routing.allocation.command.AllocationCommand;
54 import org.elasticsearch.cluster.routing.allocation.command.CancelAllocationCommand;
55 import org.elasticsearch.cluster.routing.allocation.command.MoveAllocationCommand;
56 import java.util.List;
57 import java.util.Locale;
58 import java.util.function.Function;
59 import static io.crate.planner.NodeSelection.resolveNodeId;
60 public class AlterTableReroutePlan implements Plan {
61     private static final InnerVisitor REROUTE_STATEMENTS_VISITOR = new InnerVisitor()</b></font>;
62     private final AnalyzedStatement rerouteStatement;
63     public AlterTableReroutePlan(AnalyzedStatement rerouteStatement) {
64         this.rerouteStatement = rerouteStatement;
65     }
66     @Override
67     public StatementType type() {
68         return StatementType.MANAGEMENT;
69     }
70     @Override
71     public void executeOrFail(DependencyCarrier dependencies,
72                               PlannerContext plannerContext,
73 <a name="1"></a>                              RowConsumer consumer,
74                               Row params,
75                               SubQueryResults subQueryResults) {
76         <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>var rerouteCommand = createRerouteCommand(
77             rerouteStatement,
78             plannerContext.transactionContext(),
79             dependencies.nodeContext(),
80             params,
81             subQueryResults,
82             dependencies.clusterService().state().nodes());
83         dependencies
84             .transportActionProvider()
85             .transportClusterRerouteAction()
86             .execute(
87                 new ClusterRerouteRequest().add</b></font>(rerouteCommand),
88                 new OneRowActionListener&lt;&gt;(
89                     consumer, r -&gt; new Row1(r == null ? -1L : 1L)));
90     }
91     @VisibleForTesting
92     public static AllocationCommand createRerouteCommand(AnalyzedStatement reroute,
93                                                          CoordinatorTxnCtx txnCtx,
94                                                          NodeContext nodeCtx,
95                                                          Row parameters,
96                                                          SubQueryResults subQueryResults,
97                                                          DiscoveryNodes nodes) {
98         Function&lt;? super Symbol, Object&gt; eval = x -&gt; SymbolEvaluator.evaluate(
99             txnCtx,
100             nodeCtx,
101             x,
102             parameters,
103             subQueryResults
104         );
105         return reroute.accept(
106             REROUTE_STATEMENTS_VISITOR,
107             new Context(nodes, eval));
108     }
109     private static class Context {
110         private final DiscoveryNodes nodes;
111         private final Function&lt;? super Symbol, Object&gt; eval;
112         Context(DiscoveryNodes nodes,
113                 Function&lt;? super Symbol, Object&gt; eval) {
114             this.nodes = nodes;
115             this.eval = eval;
116         }
117     }
118     private static class InnerVisitor extends AnalyzedStatementVisitor&lt;Context, AllocationCommand&gt; {
119         @Override
120         protected AllocationCommand visitAnalyzedStatement(AnalyzedStatement analyzedStatement, Context context) {
121             throw new UnsupportedOperationException(
122                 String.format(Locale.ENGLISH, "Can't handle \"%s\"", analyzedStatement));
123         }
124         @Override
125         public AllocationCommand visitReroutePromoteReplica(AnalyzedPromoteReplica statement,
126                                                             Context context) {
127             var boundedPromoteReplica = statement.promoteReplica().map(context.eval);
128             String index = getRerouteIndex(
129                 statement.shardedTable(),
130                 Lists2.map(statement.partitionProperties(), x -&gt; x.map(context.eval)));
131             String toNodeId = resolveNodeId(
132                 context.nodes,
133                 DataTypes.STRING.sanitizeValue(boundedPromoteReplica.node()));
134 <a name="2"></a>
135             return new AllocateStalePrimaryAllocationCommand(
136                 index,
137                 <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>DataTypes.INTEGER.sanitizeValue(boundedPromoteReplica.shardId()),
138                 toNodeId,
139                 DataTypes.BOOLEAN.sanitizeValue(context.eval.apply(statement.acceptDataLoss()))
140             );
141         }
142         @</b></font>Override
143         protected AllocationCommand visitRerouteMoveShard(AnalyzedRerouteMoveShard statement,
144                                                           Context context) {
145             var boundedMoveShard = statement.rerouteMoveShard().map(context.eval);
146             String index = getRerouteIndex(
147                 statement.shardedTable(),
148                 Lists2.map(statement.partitionProperties(), x -&gt; x.map(context.eval)));
149             String toNodeId = resolveNodeId(
150                 context.nodes,
151                 DataTypes.STRING.sanitizeValue(boundedMoveShard.toNodeIdOrName()));
152             return new MoveAllocationCommand(
153                 index,
154                 DataTypes.INTEGER.sanitizeValue(boundedMoveShard.shardId()),
155                 DataTypes.STRING.sanitizeValue(boundedMoveShard.fromNodeIdOrName()),
156                 toNodeId
157             );
158         }
159         @Override
160         protected AllocationCommand visitRerouteAllocateReplicaShard(AnalyzedRerouteAllocateReplicaShard statement,
161                                                                      Context context) {
162             var boundedRerouteAllocateReplicaShard = statement
163                 .rerouteAllocateReplicaShard()
164                 .map(context.eval);
165             String index = getRerouteIndex(
166                 statement.shardedTable(),
167                 Lists2.map(statement.partitionProperties(), x -&gt; x.map(context.eval)));
168             String toNodeId = resolveNodeId(
169                 context.nodes,
170                 DataTypes.STRING.sanitizeValue(boundedRerouteAllocateReplicaShard.nodeIdOrName()));
171             return new AllocateReplicaAllocationCommand(
172                 index,
173                 DataTypes.INTEGER.sanitizeValue(boundedRerouteAllocateReplicaShard.shardId()),
174                 toNodeId
175             );
176         }
177         @Override
178         protected AllocationCommand visitRerouteCancelShard(AnalyzedRerouteCancelShard statement,
179                                                             Context context) {
180             var boundedRerouteCancelShard = statement
181                 .rerouteCancelShard()
182                 .map(context.eval);
183             boolean allowPrimary = validateCancelRerouteProperty(
184                 "allow_primary", boundedRerouteCancelShard.properties());
185             String index = getRerouteIndex(
186                 statement.shardedTable(),
187                 Lists2.map(statement.partitionProperties(), x -&gt; x.map(context.eval)));
188             String nodeId = resolveNodeId(
189                 context.nodes,
190                 DataTypes.STRING.sanitizeValue(boundedRerouteCancelShard.nodeIdOrName()));
191             return new CancelAllocationCommand(
192                 index,
193                 DataTypes.INTEGER.sanitizeValue(boundedRerouteCancelShard.shardId()),
194                 nodeId,
195                 allowPrimary
196             );
197         }
198         private static String getRerouteIndex(ShardedTable shardedTable,
199                                               List&lt;Assignment&lt;Object&gt;&gt; partitionsProperties) {
200             if (shardedTable instanceof DocTableInfo) {
201                 DocTableInfo docTableInfo = (DocTableInfo) shardedTable;
202                 String indexName = docTableInfo.ident().indexNameOrAlias();
203                 PartitionName partitionName = PartitionPropertiesAnalyzer
204                     .createPartitionName(partitionsProperties, docTableInfo);
205                 if (partitionName != null) {
206                     indexName = partitionName.asIndexName();
207                 } else if (docTableInfo.isPartitioned()) {
208                     throw new IllegalArgumentException(
209                         "table is partitioned however no partition clause has been specified");
210                 }
211                 return indexName;
212             }
213             assert shardedTable.concreteIndices().length == 1 : "table has to contain only 1 index name";
214             return shardedTable.concreteIndices()[0];
215         }
216         private static boolean validateCancelRerouteProperty(String propertyKey,
217                                                              GenericProperties&lt;Object&gt; properties) {
218             for (String key : properties.keys()) {
219                 if (propertyKey.equals(key)) {
220                     return DataTypes.BOOLEAN.sanitizeValue(properties.get(propertyKey));
221                 } else {
222                     throw new IllegalArgumentException(
223                         String.format(Locale.ENGLISH, "\"%s\" is not a valid setting for CANCEL SHARD", key));
224                 }
225             }
226             return false;
227         }
228     }
229 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
