<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for BasicDatabaseMetricsTest.java & BatchedWriteCommandTest.java</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for BasicDatabaseMetricsTest.java & BatchedWriteCommandTest.java
      </h3>
      <h1 align="center">
        26.6%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>BasicDatabaseMetricsTest.java (31.428572%)<TH>BatchedWriteCommandTest.java (23.076923%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match8338-0.html#0',2,'match8338-1.html#0',3)" NAME="0">(23-53)<TD><A HREF="javascript:ZweiFrames('match8338-0.html#0',2,'match8338-1.html#0',3)" NAME="0">(26-57)</A><TD ALIGN=center><FONT COLOR="#ff0000">18</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match8338-0.html#1',2,'match8338-1.html#1',3)" NAME="1">(71-80)<TD><A HREF="javascript:ZweiFrames('match8338-0.html#1',2,'match8338-1.html#1',3)" NAME="1">(120-128)</A><TD ALIGN=center><FONT COLOR="#d40000">15</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>BasicDatabaseMetricsTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * #%L
 * BasicDatabaseMetricsTest.java - mongodb-async-driver - Allanbank Consulting, Inc.
 * %%
 * Copyright (C) 2011 - 2014 Allanbank Consulting, Inc.
 * %%
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * #L%
 */
<A NAME="0"></A>
package com.allanbank.mongodb.client.metrics.basic;

<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match8338-1.html#0',3,'match8338-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>import static org.easymock.EasyMock.createMock;
import static org.easymock.EasyMock.expect;
import static org.easymock.EasyMock.expectLastCall;
import static org.easymock.EasyMock.replay;
import static org.easymock.EasyMock.verify;
import static org.hamcrest.Matchers.hasKey;
import static org.hamcrest.Matchers.is;
import static org.hamcrest.Matchers.not;
import static org.junit.Assert.assertThat;

import java.io.PrintWriter;
import java.io.StringWriter;
import java.util.concurrent.TimeUnit;

import org.junit.Test;

import com.allanbank.mongodb.client.Message;
import com.allanbank.mongodb.client.message.Reply;

/**
 * BasicDatabaseMetricsTest provides tests for the {@link BasicDatabaseMetrics}
 * class.
 *
 * @copyright 2014, Allanbank Consulting, Inc., All Rights Reserved
 */
public class BasicDatabaseMetricsTest {

    /**
     * Test method for {@link BasicDatabaseMetrics#getName()}.
     */
    @</B></FONT>Test
    public void testGetName() {
        final BasicDatabaseMetrics metrics = new BasicDatabaseMetrics(&quot;db&quot;);

        assertThat(metrics.getName(), is(&quot;db&quot;));

        metrics.close();
    }

    /**
     * Test method for
     * {@link BasicDatabaseMetrics#receive(String, long, Message, Reply, long)}.
     */
    @Test
    public void testReceive() {
<A NAME="1"></A>        final Message mockSentMessage = createMock(Message.class);
        final Reply mockReply = createMock(Reply.class);

        <FONT color="#f63526"><A HREF="javascript:ZweiFrames('match8338-1.html#1',3,'match8338-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>final BasicDatabaseMetrics metrics = new BasicDatabaseMetrics(&quot;db&quot;);

        // One for the DB and one for the collection.
        expect(mockReply.size()).andReturn(202).times(2);
        expect(mockSentMessage.getCollectionName()).andReturn(&quot;collection&quot;);
        expectLastCall();

        replay(mockSentMessage, mockReply);

        assertThat(metrics.getCollectionMetrics(), not(hasKey</B></FONT>(&quot;collection&quot;)));

        metrics.receive(null, 0L, mockSentMessage, mockReply,
                TimeUnit.MILLISECONDS.toNanos(1));

        assertThat(metrics.getCollectionMetrics(), hasKey(&quot;collection&quot;));

        metrics.close();

        verify(mockSentMessage, mockReply);
    }

    /**
     * Test method for {@link BasicDatabaseMetrics#sent(String, long, Message)}.
     */
    @Test
    public void testSent() {
        final Message mockSentMessage = createMock(Message.class);

        final BasicDatabaseMetrics metrics = new BasicDatabaseMetrics(&quot;db&quot;);

        // One for the DB and one for the collection.
        expect(mockSentMessage.size()).andReturn(101).times(4);
        expect(mockSentMessage.getCollectionName()).andReturn(&quot;collection&quot;)
                .times(2);

        replay(mockSentMessage);

        assertThat(metrics.getCollectionMetrics(), not(hasKey(&quot;collection&quot;)));

        metrics.sent(null, 0L, mockSentMessage);
        metrics.sent(null, 0L, mockSentMessage);

        assertThat(metrics.getCollectionMetrics(), hasKey(&quot;collection&quot;));

        metrics.close();

        verify(mockSentMessage);
    }

    /**
     * Test method for {@link BasicDatabaseMetrics#writeTo(java.io.PrintWriter)}
     * .
     */
    @Test
    public void testWriteToPrintWriter() {
        final StringWriter sink = new StringWriter();
        final PrintWriter writer = new PrintWriter(sink);

        final BasicDatabaseMetrics metrics = new BasicDatabaseMetrics(&quot;db&quot;);

        metrics.writeTo(writer);
        assertThat(
                sink.toString(),
                is(&quot;Database[&quot;
                        + &quot;db&quot;
                        + &quot;: sentBytes=0, sentCount=0, receivedBytes=0, receivedCount=0, &quot;
                        + &quot;lastLatency=0 ms, totalLatency=0 ms]&quot;));

        // For Closeable.
        metrics.close();
    }
}
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>BatchedWriteCommandTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * #%L
 * BatchedWriteCommandTest.java - mongodb-async-driver - Allanbank Consulting, Inc.
 * %%
 * Copyright (C) 2011 - 2014 Allanbank Consulting, Inc.
 * %%
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * #L%
 */

package com.allanbank.mongodb.client.message;

<A NAME="0"></A>import static com.allanbank.mongodb.bson.builder.BuilderFactory.d;
import static org.hamcrest.Matchers.is;
import static org.hamcrest.Matchers.sameInstance;
<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match8338-0.html#0',2,'match8338-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertFalse;
import static org.junit.Assert.assertNotSame;
import static org.junit.Assert.assertThat;
import static org.junit.Assert.assertTrue;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import org.junit.Test;

import com.allanbank.mongodb.ReadPreference;
import com.allanbank.mongodb.bson.Document;
import com.allanbank.mongodb.bson.builder.BuilderFactory;
import com.allanbank.mongodb.builder.BatchedWrite;
import com.allanbank.mongodb.client.Client;
import com.allanbank.mongodb.client.Message;

/**
 * BatchedWriteCommandTest provides tests for the {@link BatchedWriteCommand}
 * class.
 *
 * @copyright 2014, Allanbank Consulting, Inc., All Rights Reserved
 */
public class BatchedWriteCommandTest {

    /**
     * Test method for {@link BatchedWriteCommand#equals(Object)} and
     * {@link BatchedWriteCommand#hashCode()} .
     */
    @</B></FONT>SuppressWarnings(&quot;boxing&quot;)
    @Test
    public void testEqualsObject() {
        final List&lt;Message&gt; objs1 = new ArrayList&lt;Message&gt;();
        final List&lt;Message&gt; objs2 = new ArrayList&lt;Message&gt;();

        final Document doc1 = BuilderFactory.start().addInteger(&quot;1&quot;, 0).build();
        final Document doc2 = BuilderFactory.start().addInteger(&quot;1&quot;, 1).build();
        final Document doc3 = BuilderFactory.start().addInteger(&quot;1&quot;, 2).build();

        for (final Document document : Arrays.asList(doc1, doc2, doc3)) {
            for (final String databaseName : Arrays.asList(&quot;n1&quot;, &quot;n2&quot;, &quot;n3&quot;)) {
                for (final String collectionName : Arrays.asList(&quot;n1&quot;, &quot;n2&quot;,
                        &quot;n3&quot;)) {
                    objs1.add(new BatchedWriteCommand(databaseName,
                            collectionName, document));
                    objs2.add(new BatchedWriteCommand(databaseName,
                            collectionName, document));
                }
            }
        }

        // Sanity check.
        assertEquals(objs1.size(), objs2.size());

        for (int i = 0; i &lt; objs1.size(); ++i) {
            final Message obj1 = objs1.get(i);
            Message obj2 = objs2.get(i);

            assertTrue(obj1.equals(obj1));
            assertNotSame(obj1, obj2);
            assertEquals(obj1, obj2);

            assertEquals(obj1.hashCode(), obj2.hashCode());

            for (int j = i + 1; j &lt; objs1.size(); ++j) {
                obj2 = objs2.get(j);

                assertFalse(obj1.equals(obj2));
                assertFalse(obj1.hashCode() == obj2.hashCode());
            }

            assertFalse(obj1.equals(&quot;foo&quot;));
            assertFalse(obj1.equals(null));
            assertFalse(obj1.equals(new IsMaster()));
        }
    }

    /**
     * Test method for {@link BatchedWriteCommand#getBundle()}.
     */
    @Test
    public void testGetBundle() {
        final Document doc = d().build();

        final String databaseName = &quot;db&quot;;
        final String collectionName = &quot;collection&quot;;
        final BatchedWrite write = BatchedWrite.builder().insert(doc)
                .update(doc, doc).delete(doc).build();
        final List&lt;BatchedWrite.Bundle&gt; bundles = write.toBundles(
<A NAME="1"></A>                collectionName, Client.MAX_DOCUMENT_SIZE, 1000);

        for (final BatchedWrite.Bundle bundle : bundles) {
            <FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match8338-0.html#1',2,'match8338-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>final BatchedWriteCommand command = new BatchedWriteCommand(
                    databaseName, collectionName, bundle);

            assertThat(command.getCommand(), is(bundle.getCommand()));
            assertThat(command.getReadPreference(),
                    sameInstance(ReadPreference.PRIMARY));
            assertThat(command.getRequiredVersionRange(),
                    sameInstance(BatchedWriteCommand.REQUIRED_VERSION_RANGE));
            assertThat(command.getBundle(), sameInstance</B></FONT>(bundle));
        }
    }

}
</PRE>
</div>
  </div>
</body>
</html>
