
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 7.9422382671480145%, Tokens: 11</h2>
        <div class="column">
            <h3>motan-MDEwOlJlcG9zaXRvcnk1NjY3OTUyMQ==-flat-ConsulHeartbeatManagerTest.java</h3>
            <pre><code>1  package com.weibo.api.motan.registry.consul;
<span onclick='openModal()' class='match'>2  import static org.junit.Assert.assertTrue;
3  import java.util.HashMap;
4  import java.util.Map;
5  import java.util.Map.Entry;
6  import org.junit.After;
7  import org.junit.Before;
8  import org.junit.Test;
9  import com.weibo.api.motan.util.MotanSwitcherUtil;
10  public class ConsulHeartbeatManagerTest {
11      private ConsulHeartbeatManager heartbeatManager;
12      private MockConsulClient client;
</span>13      @Before
14      public void setUp() throws Exception {
15          client = new MockConsulClient("localhost", 8500);
16          heartbeatManager = new ConsulHeartbeatManager(client);
17          ConsulConstants.HEARTBEAT_CIRCLE = 200;
18          ConsulConstants.SWITCHER_CHECK_CIRCLE = 20;
19      }
20      @After
21      public void tearDown() throws Exception {
22          heartbeatManager = null;
23      }
24      @Test
25      public void testStart() throws InterruptedException {
26          heartbeatManager.start();
27          Map<String, Long> mockServices = new HashMap<String, Long>();
28          int serviceNum = 5;
29          for (int i = 0; i < serviceNum; i++) {
30              String serviceid = "service" + i;
31              mockServices.put(serviceid, 0L);
32              heartbeatManager.addHeartbeatServcieId(serviceid);
33          }
34          setHeartbeatSwitcher(true);
35          checkHeartbeat(mockServices, true, serviceNum);
36          setHeartbeatSwitcher(false);
37          Thread.sleep(100);
38          checkHeartbeat(mockServices, false, serviceNum);
39      }
40      private void checkHeartbeat(Map<String, Long> services, boolean start, int times) throws InterruptedException {
41          for (int i = 0; i < times; i++) {
42              Thread.sleep(ConsulConstants.HEARTBEAT_CIRCLE + 500);
43              for (Entry<String, Long> entry : services.entrySet()) {
44                  long heartbeatTimes = client.getCheckPassTimes(entry.getKey());
45                  long lastHeartbeatTimes = services.get(entry.getKey());
46                  services.put(entry.getKey(), heartbeatTimes);
47                  if (start) { 
48                      assertTrue(heartbeatTimes > lastHeartbeatTimes);
49                  } else {
50                      assertTrue(heartbeatTimes == lastHeartbeatTimes);
51                  }
52              }
53          }
54      }
55      public void setHeartbeatSwitcher(boolean value) {
56          heartbeatManager.setHeartbeatOpen(value);
57      }
58  }
</code></pre>
        </div>
        <div class="column">
            <h3>motan-MDEwOlJlcG9zaXRvcnk1NjY3OTUyMQ==-flat-NettyServerTest.java</h3>
            <pre><code>1  package com.weibo.api.motan.transport.netty4;
2  import com.weibo.api.motan.common.MotanConstants;
3  import com.weibo.api.motan.common.URLParamType;
4  import com.weibo.api.motan.rpc.*;
5  import com.weibo.api.motan.transport.Channel;
6  import com.weibo.api.motan.transport.MessageHandler;
7  import com.weibo.api.motan.util.MotanSwitcherUtil;
8  import com.weibo.api.motan.util.RequestIdGenerator;
9  import org.junit.After;
<span onclick='openModal()' class='match'>10  import org.junit.Assert;
11  import org.junit.Before;
12  import org.junit.Test;
13  import java.util.HashMap;
14  import java.util.HashSet;
15  import java.util.Map;
16  import java.util.Set;
17  import static org.junit.Assert.fail;
18  public class NettyServerTest {
19      private NettyServer nettyServer;
20      private URL url;
</span>21      private String interfaceName = "com.weibo.api.motan.protocol.example.IHello";
22      @Before
23      public void setUp() {
24          Map<String, String> parameters = new HashMap<>();
25          parameters.put("requestTimeout", "500");
26          url = new URL("netty", "localhost", 18080, interfaceName, parameters);
27          url.addParameter(URLParamType.asyncInitConnection.getName(), "false");
28      }
29      @After
30      public void tearDown() {
31          if (nettyServer != null) {
32              nettyServer.close();
33          }
34      }
35      @Test
36      public void testMaxServerConnection() throws InterruptedException {
37          int minClientConnection = 5;
38          int maxServerConnection = 7;
39          url.addParameter(URLParamType.minClientConnection.getName(), String.valueOf(minClientConnection));
40          url.addParameter(URLParamType.maxServerConnection.getName(), String.valueOf(maxServerConnection));
41          url.addParameter(URLParamType.requestTimeout.getName(), "10000");
42          nettyServer = new NettyServer(url, new MessageHandler() {
43              @Override
44              public Object handle(Channel channel, Object message) {
45                  Request request = (Request) message;
46                  DefaultResponse response = new DefaultResponse();
47                  response.setRequestId(request.getRequestId());
48                  response.setValue("method: " + request.getMethodName() + " requestId: " + request.getRequestId());
49                  return response;
50              }
51          });
52          nettyServer.open();
53          Assert.assertEquals(0, nettyServer.channelManage.getChannels().size());
54          NettyClient nettyClient = new NettyClient(url);
55          nettyClient.open();
56          Thread.sleep(100);
57          Assert.assertEquals(minClientConnection, nettyServer.channelManage.getChannels().size());
58          NettyClient nettyClient2 = new NettyClient(url);
59          nettyClient2.open();
60          Thread.sleep(100);
61          Assert.assertTrue(nettyServer.channelManage.getChannels().size() < minClientConnection * 2);
62          nettyClient.close();
63          nettyClient2.close();
64          Thread.sleep(100);
65          Assert.assertEquals(0, nettyServer.channelManage.getChannels().size());
66      }
67      @Test
68      public void testServerTrace() throws InterruptedException {
69          MotanSwitcherUtil.setSwitcherValue(MotanConstants.MOTAN_TRACE_INFO_SWITCHER, true);
70          final Set<String> serverTraceKey = new HashSet<>();
71          serverTraceKey.add(MotanConstants.TRACE_SRECEIVE);
72          serverTraceKey.add(MotanConstants.TRACE_SDECODE);
73          serverTraceKey.add(MotanConstants.TRACE_SEXECUTOR_START);
74          serverTraceKey.add(MotanConstants.TRACE_PROCESS);
75          serverTraceKey.add(MotanConstants.TRACE_SENCODE);
76          serverTraceKey.add(MotanConstants.TRACE_SSEND);
77          nettyServer = new NettyServer(url, new MessageHandler() {
78              @Override
79              public Object handle(Channel channel, Object message) {
80                  final Request request = (Request) message;
81                  if (request instanceof Traceable) {
82                      if (((Traceable) request).getTraceableContext().getReceiveTime() != 0) {
83                          serverTraceKey.remove(MotanConstants.TRACE_SRECEIVE);
84                      }
85                      serverTraceKey.removeAll(((Traceable) request).getTraceableContext().getTraceInfoMap().keySet());
86                  }
87                  final DefaultResponse response = new DefaultResponse();
88                  response.setRequestId(request.getRequestId());
89                  response.setValue("method: " + request.getMethodName() + " requestId: " + request.getRequestId());
90                  response.addFinishCallback(new Runnable() {
91                      @Override
92                      public void run() {
93                          serverTraceKey.removeAll(((Traceable) response).getTraceableContext().getTraceInfoMap().keySet());
94                          if (((Traceable) response).getTraceableContext().getSendTime() != 0) {
95                              serverTraceKey.remove(MotanConstants.TRACE_SSEND);
96                          }
97                      }
98                  }, null);
99                  return response;
100              }
101          });
102          nettyServer.open();
103          DefaultRequest request = new DefaultRequest();
104          request.setRequestId(RequestIdGenerator.getRequestId());
105          request.setInterfaceName(interfaceName);
106          request.setMethodName("hello");
107          request.setParamtersDesc("void");
108          TraceableContext requestTraceableContext = request.getTraceableContext();
109          Assert.assertEquals(0, requestTraceableContext.getSendTime());
110          Assert.assertEquals(0, requestTraceableContext.getReceiveTime());
111          NettyClient nettyClient = new NettyClient(url);
112          nettyClient.open();
113          Response response;
114          try {
115              response = nettyClient.request(request);
116              Object result = response.getValue();
117              Assert.assertEquals("method: " + request.getMethodName() + " requestId: " + request.getRequestId(), result);
118              Assert.assertNotNull(requestTraceableContext.getTraceInfo(MotanConstants.TRACE_CONNECTION));
119              Assert.assertNotNull(requestTraceableContext.getTraceInfo(MotanConstants.TRACE_CENCODE));
120              Assert.assertFalse(0 == requestTraceableContext.getSendTime());
121              if (response instanceof Traceable) {
122                  Assert.assertFalse(0 == ((Traceable) response).getTraceableContext().getReceiveTime());
123                  Assert.assertNotNull(((Traceable) response).getTraceableContext().getTraceInfo(MotanConstants.TRACE_CDECODE));
124              }
125          } catch (Exception e) {
126              fail();
127          }
128          Thread.sleep(100);
129          nettyClient.close();
130          Assert.assertTrue(serverTraceKey.isEmpty());
131      }
132  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from motan-MDEwOlJlcG9zaXRvcnk1NjY3OTUyMQ==-flat-ConsulHeartbeatManagerTest.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from motan-MDEwOlJlcG9zaXRvcnk1NjY3OTUyMQ==-flat-NettyServerTest.java</div>
                </div>
                <div class="column column_space"><pre><code>2  import static org.junit.Assert.assertTrue;
3  import java.util.HashMap;
4  import java.util.Map;
5  import java.util.Map.Entry;
6  import org.junit.After;
7  import org.junit.Before;
8  import org.junit.Test;
9  import com.weibo.api.motan.util.MotanSwitcherUtil;
10  public class ConsulHeartbeatManagerTest {
11      private ConsulHeartbeatManager heartbeatManager;
12      private MockConsulClient client;
</pre></code></div>
                <div class="column column_space"><pre><code>10  import org.junit.Assert;
11  import org.junit.Before;
12  import org.junit.Test;
13  import java.util.HashMap;
14  import java.util.HashSet;
15  import java.util.Map;
16  import java.util.Set;
17  import static org.junit.Assert.fail;
18  public class NettyServerTest {
19      private NettyServer nettyServer;
20      private URL url;
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    