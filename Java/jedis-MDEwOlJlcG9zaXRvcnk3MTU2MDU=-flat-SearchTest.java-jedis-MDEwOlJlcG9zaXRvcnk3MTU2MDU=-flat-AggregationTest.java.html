
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 23, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-SearchTest.java</h3>
            <pre><code>1  package redis.clients.jedis.modules.search;
2  import static org.junit.Assert.*;
3  import java.util.*;
4  import org.hamcrest.Matchers;
5  import org.junit.BeforeClass;
6  import org.junit.Test;
7  import redis.clients.jedis.exceptions.JedisDataException;
8  import redis.clients.jedis.json.Path;
9  import redis.clients.jedis.search.*;
10  import redis.clients.jedis.search.Schema.*;
11  import redis.clients.jedis.modules.RedisModuleCommandsTestBase;
12  import redis.clients.jedis.util.SafeEncoder;
13  public class SearchTest extends RedisModuleCommandsTestBase {
14    private static final String index = "testindex";
15    @BeforeClass
16    public static void prepare() {
17      RedisModuleCommandsTestBase.prepare();
18    }
19    private void addDocument(String key, Map<String, Object> map) {
20      client.hset(key, RediSearchUtil.toStringMap(map));
21    }
22    private static Map<String, Object> toMap(Object... values) {
23      Map<String, Object> map = new HashMap<>();
24      for (int i = 0; i < values.length; i += 2) {
25        map.put((String) values[i], values[i + 1]);
26      }
27      return map;
28    }
29    private static Map<String, String> toMap(String... values) {
30      Map<String, String> map = new HashMap<>();
31      for (int i = 0; i < values.length; i += 2) {
32        map.put(values[i], values[i + 1]);
33      }
34      return map;
35    }
36    @Test
37    public void create() throws Exception {
38      Schema sc = new Schema().addTextField("first", 1.0).addTextField("last", 1.0).addNumericField("age");
39      IndexDefinition rule = new IndexDefinition()
40          .setFilter("@age>16")
41          .setPrefixes(new String[]{"student:", "pupil:"});
42      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions().setDefinition(rule), sc));
43      client.hset("profesor:5555", toMap("first", "Albert", "last", "Blue", "age", "55"));
44      client.hset("student:1111", toMap("first", "Joe", "last", "Dod", "age", "18"));
45      client.hset("pupil:2222", toMap("first", "Jen", "last", "Rod", "age", "14"));
46      client.hset("student:3333", toMap("first", "El", "last", "Mark", "age", "17"));
47      client.hset("pupil:4444", toMap("first", "Pat", "last", "Shu", "age", "21"));
48      client.hset("student:5555", toMap("first", "Joen", "last", "Ko", "age", "20"));
49      client.hset("teacher:6666", toMap("first", "Pat", "last", "Rod", "age", "20"));
50      SearchResult noFilters = client.ftSearch(index, new Query());
51      assertEquals(4, noFilters.getTotalResults());
52      SearchResult res1 = client.ftSearch(index, new Query("@first:Jo*"));
53      assertEquals(2, res1.getTotalResults());
54      SearchResult res2 = client.ftSearch(index, new Query("@first:Pat"));
55      assertEquals(1, res2.getTotalResults());
56      SearchResult res3 = client.ftSearch(index, new Query("@last:Rod"));
57      assertEquals(0, res3.getTotalResults());
58    }
59    @Test
60    public void createNoParams() throws Exception {
61      Schema sc = new Schema().addTextField("first", 1.0).addTextField("last", 1.0).addNumericField("age");
62      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
63      addDocument("student:1111", toMap("first", "Joe", "last", "Dod", "age", 18));
64      addDocument("student:3333", toMap("first", "El", "last", "Mark", "age", 17));
65      addDocument("pupil:4444", toMap("first", "Pat", "last", "Shu", "age", 21));
66      addDocument("student:5555", toMap("first", "Joen", "last", "Ko", "age", 20));
67      SearchResult noFilters = client.ftSearch(index, new Query());
68      assertEquals(4, noFilters.getTotalResults());
69      SearchResult res1 = client.ftSearch(index, new Query("@first:Jo*"));
70      assertEquals(2, res1.getTotalResults());
71      SearchResult res2 = client.ftSearch(index, new Query("@first:Pat"));
72      assertEquals(1, res2.getTotalResults());
73      SearchResult res3 = client.ftSearch(index, new Query("@last:Rod"));
74      assertEquals(0, res3.getTotalResults());
75    }
76    @Test
77    public void createWithFieldNames() throws Exception {
78      Schema sc = new Schema().addField(new TextField(FieldName.of("first").as("given")))
79          .addField(new TextField(FieldName.of("last")));
80      IndexDefinition rule = new IndexDefinition()
81          .setPrefixes(new String[]{"student:", "pupil:"});
82      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions().setDefinition(rule), sc));
83      client.hset("profesor:5555", toMap("first", "Albert", "last", "Blue", "age", "55"));
84      client.hset("student:1111", toMap("first", "Joe", "last", "Dod", "age", "18"));
85      client.hset("pupil:2222", toMap("first", "Jen", "last", "Rod", "age", "14"));
86      client.hset("student:3333", toMap("first", "El", "last", "Mark", "age", "17"));
87      client.hset("pupil:4444", toMap("first", "Pat", "last", "Shu", "age", "21"));
88      client.hset("student:5555", toMap("first", "Joen", "last", "Ko", "age", "20"));
89      client.hset("teacher:6666", toMap("first", "Pat", "last", "Rod", "age", "20"));
90      SearchResult noFilters = client.ftSearch(index, new Query());
91      assertEquals(5, noFilters.getTotalResults());
92      SearchResult asOriginal = client.ftSearch(index, new Query("@first:Jo*"));
93      assertEquals(0, asOriginal.getTotalResults());
94      SearchResult asAttribute = client.ftSearch(index, new Query("@given:Jo*"));
95      assertEquals(2, asAttribute.getTotalResults());
96      SearchResult nonAttribute = client.ftSearch(index, new Query("@last:Rod"));
97      assertEquals(1, nonAttribute.getTotalResults());
98    }
99    @Test
100    public void alterAdd() throws Exception {
101      Schema sc = new Schema().addTextField("title", 1.0);
102      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
103      Map<String, Object> fields = new HashMap<>();
104      fields.put("title", "hello world");
105      for (int i = 0; i < 100; i++) {
106        addDocument(String.format("doc%d", i), fields);
107      }
108      SearchResult res = client.ftSearch(index, new Query("hello world"));
109      assertEquals(100, res.getTotalResults());
110      assertEquals("OK", client.ftAlter(index, new TagField("tags", ","), new TextField("name", 0.5)));
111      for (int i = 0; i < 100; i++) {
112        Map<String, Object> fields2 = new HashMap<>();
113        fields2.put("name", "name" + i);
114        fields2.put("tags", String.format("tagA,tagB,tag%d", i));
115        addDocument(String.format("doc%d", i), fields2);
116      }
117      SearchResult res2 = client.ftSearch(index, new Query("@tags:{tagA}"));
118      assertEquals(100, res2.getTotalResults());
119      Map<String, Object> info = client.ftInfo(index);
120      assertEquals(index, info.get("index_name"));
121      assertEquals("identifier", ((List) ((List) info.get("attributes")).get(1)).get(0));
122      assertEquals("attribute", ((List) ((List) info.get("attributes")).get(1)).get(2));
123    }
124    @Test
125    public void search() throws Exception {
126      Schema sc = new Schema().addTextField("title", 1.0).addTextField("body", 1.0);
127      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
128      Map<String, Object> fields = new HashMap<>();
129      fields.put("title", "hello world");
130      fields.put("body", "lorem ipsum");
131      for (int i = 0; i < 100; i++) {
132        addDocument(String.format("doc%d", i), fields);
133      }
134      SearchResult res = client.ftSearch(index, new Query("hello world").limit(0, 5).setWithScores());
135      assertEquals(100, res.getTotalResults());
136      assertEquals(5, res.getDocuments().size());
137      for (Document d : res.getDocuments()) {
138        assertTrue(d.getId().startsWith("doc"));
139        assertTrue(d.getScore() < 100);
140      }
141      client.del("doc0");
142      res = client.ftSearch(index, new Query("hello world"));
143      assertEquals(99, res.getTotalResults());
144      assertEquals("OK", client.ftDropIndex(index));
145      try {
146        client.ftSearch(index, new Query("hello world"));
147        fail();
148      } catch (JedisDataException e) {
149      }
150    }
151    @Test
152    public void numericFilter() throws Exception {
153      Schema sc = new Schema().addTextField("title", 1.0).addNumericField("price");
154      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
155      Map<String, Object> fields = new HashMap<>();
156      fields.put("title", "hello world");
157      for (int i = 0; i < 100; i++) {
158        fields.put("price", i);
159        addDocument(String.format("doc%d", i), fields);
160      }
161      SearchResult res = client.ftSearch(index, new Query("hello world").
162          addFilter(new Query.NumericFilter("price", 0, 49)));
163      assertEquals(50, res.getTotalResults());
164      assertEquals(10, res.getDocuments().size());
165      for (Document d : res.getDocuments()) {
166        long price = Long.valueOf((String) d.get("price"));
167        assertTrue(price >= 0);
168        assertTrue(price <= 49);
169      }
170      res = client.ftSearch(index, new Query("hello world").
171          addFilter(new Query.NumericFilter("price", 0, true, 49, true)));
172      assertEquals(48, res.getTotalResults());
173      assertEquals(10, res.getDocuments().size());
174      for (Document d : res.getDocuments()) {
175        long price = Long.valueOf((String) d.get("price"));
176        assertTrue(price > 0);
177        assertTrue(price < 49);
178      }
179      res = client.ftSearch(index, new Query("hello world").
180          addFilter(new Query.NumericFilter("price", 50, 100)));
181      assertEquals(50, res.getTotalResults());
182      assertEquals(10, res.getDocuments().size());
183      for (Document d : res.getDocuments()) {
184        long price = Long.valueOf((String) d.get("price"));
185        assertTrue(price >= 50);
186        assertTrue(price <= 100);
187      }
188      res = client.ftSearch(index, new Query("hello world").
189          addFilter(new Query.NumericFilter("price", 20, Double.POSITIVE_INFINITY)));
190      assertEquals(80, res.getTotalResults());
191      assertEquals(10, res.getDocuments().size());
192      res = client.ftSearch(index, new Query("hello world").
193          addFilter(new Query.NumericFilter("price", Double.NEGATIVE_INFINITY, 10)));
194      assertEquals(11, res.getTotalResults());
195      assertEquals(10, res.getDocuments().size());
196    }
197    @Test
198    public void stopwords() throws Exception {
199      Schema sc = new Schema().addTextField("title", 1.0);
200      assertEquals("OK", client.ftCreate(index,
201          IndexOptions.defaultOptions().setStopwords("foo", "bar", "baz"), sc));
202      Map<String, Object> fields = new HashMap<>();
203      fields.put("title", "hello world foo bar");
204      addDocument("doc1", fields);
205      SearchResult res = client.ftSearch(index, new Query("hello world"));
206      assertEquals(1, res.getTotalResults());
207      res = client.ftSearch(index, new Query("foo bar"));
208      assertEquals(0, res.getTotalResults());
209    }
210    @Test
211    public void noStopwords() throws Exception {
212      Schema sc = new Schema().addTextField("title", 1.0);
213      assertEquals("OK", client.ftCreate(index,
214          IndexOptions.defaultOptions().setNoStopwords(), sc));
215      Map<String, Object> fields = new HashMap<>();
216      fields.put("title", "hello world foo bar");
217      fields.put("title", "hello world foo bar to be or not to be");
218      addDocument("doc1", fields);
219      assertEquals(1, client.ftSearch(index, new Query("hello world")).getTotalResults());
220      assertEquals(1, client.ftSearch(index, new Query("foo bar")).getTotalResults());
221      assertEquals(1, client.ftSearch(index, new Query("to be or not to be")).getTotalResults());
222    }
223    @Test
224    public void geoFilter() throws Exception {
225      Schema sc = new Schema().addTextField("title", 1.0).addGeoField("loc");
226      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
227      Map<String, Object> fields = new HashMap<>();
228      fields.put("title", "hello world");
229      fields.put("loc", "-0.441,51.458");
230      addDocument("doc1", fields);
231      fields.put("loc", "-0.1,51.2");
232      addDocument("doc2", fields);
233      SearchResult res = client.ftSearch(index, new Query("hello world").
234          addFilter(
235              new Query.GeoFilter("loc", -0.44, 51.45,
236                  10, Query.GeoFilter.KILOMETERS)
237          ));
238      assertEquals(1, res.getTotalResults());
239      res = client.ftSearch(index, new Query("hello world").
240          addFilter(
241              new Query.GeoFilter("loc", -0.44, 51.45,
242                  100, Query.GeoFilter.KILOMETERS)
243          ));
244      assertEquals(2, res.getTotalResults());
245    }
246    @Test
247    public void geoFilterAndGeoCoordinateObject() throws Exception {
248      Schema schema = new Schema().addTextField("title", 1.0).addGeoField("loc");
249      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), schema));
250      Map<String, Object> fields = new HashMap<>();
251      fields.put("title", "hello world");
252      fields.put("loc", new redis.clients.jedis.GeoCoordinate(-0.441, 51.458));
253      addDocument("doc1", fields);
254      fields.put("loc", new redis.clients.jedis.GeoCoordinate(-0.1, 51.2));
255      addDocument("doc2", fields);
256      SearchResult res = client.ftSearch(index, new Query("hello world").addFilter(
257          new Query.GeoFilter("loc", -0.44, 51.45, 10, Query.GeoFilter.KILOMETERS)));
258      assertEquals(1, res.getTotalResults());
259      res = client.ftSearch(index, new Query("hello world").addFilter(
260          new Query.GeoFilter("loc", -0.44, 51.45, 100, Query.GeoFilter.KILOMETERS)));
261      assertEquals(2, res.getTotalResults());
262    }
263    @Test
264    public void testQueryFlags() throws Exception {
265      Schema sc = new Schema().addTextField("title", 1.0);
266      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
267      Map<String, Object> fields = new HashMap<>();
268      for (int i = 0; i < 100; i++) {
269        fields.put("title", i % 2 != 0 ? "hello worlds" : "hello world");
270        addDocument(String.format("doc%d", i), fields);
271      }
272      Query q = new Query("hello").setWithScores();
273      SearchResult res = client.ftSearch(index, q);
274      assertEquals(100, res.getTotalResults());
275      assertEquals(10, res.getDocuments().size());
276      for (Document d : res.getDocuments()) {
277        assertTrue(d.getId().startsWith("doc"));
278        assertTrue(((String) d.get("title")).startsWith("hello world"));
279      }
<span onclick='openModal()' class='match'>280      q = new Query("hello").setNoContent();
281      res = client.ftSearch(index, q);
282      for (Document d : res.getDocuments()) {
</span>283        assertTrue(d.getId().startsWith("doc"));
284        assertEquals(1.0, d.getScore(), 0);
285        assertNull(d.get("title"));
286      }
287      res = client.ftSearch(index, new Query("hello worlds"));
288      assertEquals(100, res.getTotalResults());
289      res = client.ftSearch(index, new Query("hello worlds").setVerbatim());
290      assertEquals(50, res.getTotalResults());
291      res = client.ftSearch(index, new Query("hello a world").setVerbatim());
292      assertEquals(50, res.getTotalResults());
293      res = client.ftSearch(index, new Query("hello a worlds").setVerbatim());
294      assertEquals(50, res.getTotalResults());
295      res = client.ftSearch(index, new Query("hello a world").setVerbatim().setNoStopwords());
296      assertEquals(0, res.getTotalResults());
297    }
298    @Test
299    public void testQueryParams() {
300      Schema sc = new Schema().addNumericField("numval");
301      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
302      client.hset("1", "numval", "1");
303      client.hset("2", "numval", "2");
304      client.hset("3", "numval", "3");
305      Query query =  new Query("@numval:[$min $max]").addParam("min", 1).addParam("max", 2).dialect(2);
306      assertEquals(2, client.ftSearch(index, query).getTotalResults());
307    }
308    @Test
309    public void testSortQueryFlags() throws Exception {
310      Schema sc = new Schema().addSortableTextField("title", 1.0);
311      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
312      Map<String, Object> fields = new HashMap<>();
313      fields.put("title", "b title");
314      addDocument("doc1", fields);
315      fields.put("title", "a title");
316      addDocument("doc2", fields);
317      fields.put("title", "c title");
318      addDocument("doc3", fields);
319      Query q = new Query("title").setSortBy("title", true);
320      SearchResult res = client.ftSearch(index, q);
321      assertEquals(3, res.getTotalResults());
322      Document doc1 = res.getDocuments().get(0);
323      assertEquals("a title", doc1.get("title"));
324      doc1 = res.getDocuments().get(1);
325      assertEquals("b title", doc1.get("title"));
326      doc1 = res.getDocuments().get(2);
327      assertEquals("c title", doc1.get("title"));
328    }
329    @Test
330    public void testNullField() throws Exception {
331      Schema sc = new Schema()
332          .addTextField("title", 1.0)
333          .addTextField("genre", 1.0)
334          .addTextField("plot", 1.0)
335          .addSortableNumericField("release_year")
336          .addTagField("tag")
337          .addGeoField("loc");
338      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
339      Map<String, Object> fields = new HashMap<>();
340      fields.put("title", "another test with title ");
341      fields.put("genre", "Comedy");
342      fields.put("plot", "this is the plot for the test");
343      fields.put("tag", "fun");
344      fields.put("release_year", 2019);
345      fields.put("loc", "-0.1,51.2");
346      addDocument("doc1", fields);
347      SearchResult res = client.ftSearch(index, new Query("title"));
348      assertEquals(1, res.getTotalResults());
349      fields = new HashMap<>();
350      fields.put("title", "another title another test");
351      fields.put("genre", "Action");
352      fields.put("plot", null);
353      fields.put("tag", null);
354      try {
355        addDocument("doc2", fields);
356        fail("Should throw NullPointerException.");
357      } catch (NullPointerException e) {
358      }
359      res = client.ftSearch(index, new Query("title"));
360      assertEquals(1, res.getTotalResults());
361      fields = new HashMap<>();
362      fields.put("title", "another title another test");
363      fields.put("genre", "Action");
364      fields.put("release_year", null);
365      try {
366        addDocument("doc2", fields);
367        fail("Should throw NullPointerException.");
368      } catch (NullPointerException e) {
369      }
370      res = client.ftSearch(index, new Query("title"));
371      assertEquals(1, res.getTotalResults());
372    }
373    @Test
374    public void testJsonWithAlias() {
375      Schema sc = new Schema()
376              .addTextField("$.name", 1.0).as("name")
377              .addNumericField("$.num").as("num");
378      IndexDefinition definition = new IndexDefinition(IndexDefinition.Type.JSON).setPrefixes("king:");
379      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions().setDefinition(definition), sc));
380      Map<String, Object> king1 = new HashMap<>();
381      king1.put("name", "henry");
382      king1.put("num", 42);
383      client.jsonSet("king:1", Path.ROOT_PATH, king1);
384      Map<String, Object> king2 = new HashMap<>();
385      king2.put("name", "james");
386      king2.put("num", 3.14);
387      client.jsonSet("king:2", Path.ROOT_PATH, king2);
388      SearchResult res = client.ftSearch(index, new Query("@name:henry"));
389      assertEquals(1, res.getTotalResults());
390      assertEquals("king:1", res.getDocuments().get(0).getId());
391      res = client.ftSearch(index, new Query("@num:[0 10]"));
392      assertEquals(1, res.getTotalResults());
393      assertEquals("king:2", res.getDocuments().get(0).getId());
394    }
395    @Test
396    public void dropIndex() throws Exception {
397      Schema sc = new Schema().addTextField("title", 1.0);
398      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
399      Map<String, Object> fields = new HashMap<>();
400      fields.put("title", "hello world");
401      for (int i = 0; i < 100; i++) {
402        addDocument(String.format("doc%d", i), fields);
403      }
404      SearchResult res = client.ftSearch(index, new Query("hello world"));
405      assertEquals(100, res.getTotalResults());
406      assertEquals("OK", client.ftDropIndex(index));
407      try {
408        client.ftSearch(index, new Query("hello world"));
409        fail("Index should not exist.");
410      } catch (JedisDataException de) {
411        assertTrue(de.getMessage().contains("no such index"));
412      }
413      assertEquals(100, client.dbSize());
414    }
415    @Test
416    public void dropIndexDD() throws Exception {
417      Schema sc = new Schema().addTextField("title", 1.0);
418      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
419      Map<String, Object> fields = new HashMap<>();
420      fields.put("title", "hello world");
421      for (int i = 0; i < 100; i++) {
422        addDocument(String.format("doc%d", i), fields);
423      }
424      SearchResult res = client.ftSearch(index, new Query("hello world"));
425      assertEquals(100, res.getTotalResults());
426      assertEquals("OK", client.ftDropIndexDD(index));
427      Set<String> keys = client.keys("*");
428      assertTrue(keys.isEmpty());
429      assertEquals(0, client.dbSize());
430    }
431    @Test
432    public void noStem() throws Exception {
433      Schema sc = new Schema().addTextField("stemmed", 1.0).addField(new Schema.TextField("notStemmed", 1.0, false, true));
434      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
435      Map<String, Object> doc = new HashMap<>();
436      doc.put("stemmed", "located");
437      doc.put("notStemmed", "located");
438      addDocument("doc", doc);
439      SearchResult res = client.ftSearch(index, new Query("@stemmed:location"));
440      assertEquals(1, res.getTotalResults());
441      res = client.ftSearch(index, new Query("@notStemmed:location"));
442      assertEquals(0, res.getTotalResults());
443    }
444    @Test
445    public void phoneticMatch() throws Exception {
446      Schema sc = new Schema()
447          .addTextField("noPhonetic", 1.0)
448          .addField(new Schema.TextField("withPhonetic", 1.0, false, false, false, "dm:en"));
449      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
450      Map<String, Object> doc = new HashMap<>();
451      doc.put("noPhonetic", "morfix");
452      doc.put("withPhonetic", "morfix");
453      addDocument("doc", doc);
454      SearchResult res = client.ftSearch(index, new Query("@withPhonetic:morphix=>{$phonetic:true}"));
455      assertEquals(1, res.getTotalResults());
456      try {
457        client.ftSearch(index, new Query("@noPhonetic:morphix=>{$phonetic:true}"));
458        fail();
459      } catch (JedisDataException e) {&bsol;*field does not support phonetics*/
460      }
461      SearchResult res3 = client.ftSearch(index, new Query("@withPhonetic:morphix=>{$phonetic:false}"));
462      assertEquals(0, res3.getTotalResults());
463    }
464    @Test
465    public void info() throws Exception {
466      String MOVIE_ID = "movie_id";
467      String TITLE = "title";
468      String GENRE = "genre";
469      String VOTES = "votes";
470      String RATING = "rating";
471      String RELEASE_YEAR = "release_year";
472      String PLOT = "plot";
473      String POSTER = "poster";
474      Schema sc = new Schema()
475          .addTextField(TITLE, 5.0)
476          .addSortableTextField(PLOT, 1.0)
477          .addSortableTagField(GENRE, ",")
478          .addSortableNumericField(RELEASE_YEAR)
479          .addSortableNumericField(RATING)
480          .addSortableNumericField(VOTES);
481      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
482      Map<String, Object> info = client.ftInfo(index);
483      assertEquals(index, info.get("index_name"));
484      assertEquals(6, ((List) info.get("attributes")).size());
485      assertEquals("global_idle", ((List) info.get("cursor_stats")).get(0));
486      assertEquals(0L, ((List) info.get("cursor_stats")).get(1));
487    }
488    @Test
489    public void noIndex() throws Exception {
490      Schema sc = new Schema()
491          .addField(new Schema.TextField("f1", 1.0, true, false, true))
492          .addField(new Schema.TextField("f2", 1.0));
493      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
494      Map<String, Object> mm = new HashMap<>();
495      mm.put("f1", "MarkZZ");
496      mm.put("f2", "MarkZZ");
497      addDocument("doc1", mm);
498      mm.clear();
499      mm.put("f1", "MarkAA");
500      mm.put("f2", "MarkBB");
501      addDocument("doc2", mm);
502      SearchResult res = client.ftSearch(index, new Query("@f1:Mark*"));
503      assertEquals(0, res.getTotalResults());
504      res = client.ftSearch(index, new Query("@f2:Mark*"));
505      assertEquals(2, res.getTotalResults());
506      Document[] docs = new Document[2];
507      res = client.ftSearch(index, new Query("@f2:Mark*").setSortBy("f1", false));
508      assertEquals(2, res.getTotalResults());
509      res.getDocuments().toArray(docs);
510      assertEquals("doc1", docs[0].getId());
511      res = client.ftSearch(index, new Query("@f2:Mark*").setSortBy("f1", true));
512      res.getDocuments().toArray(docs);
513      assertEquals("doc2", docs[0].getId());
514    }
515    @Test
516    public void testExplain() throws Exception {
517      Schema sc = new Schema()
518          .addTextField("f1", 1.0)
519          .addTextField("f2", 1.0)
520          .addTextField("f3", 1.0);
521      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
522      String res = client.ftExplain(index, new Query("@f3:f3_val @f2:f2_val @f1:f1_val"));
523      assertNotNull(res);
524      assertFalse(res.isEmpty());
525    }
526    @Test
527    public void testHighlightSummarize() throws Exception {
528      Schema sc = new Schema().addTextField("text", 1.0);
529      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
530      Map<String, Object> doc = new HashMap<>();
531      doc.put("text", "Redis is often referred as a data structures server. What this means is that Redis provides access to mutable data structures via a set of commands, which are sent using a server-client model with TCP sockets and a simple protocol. So different processes can query and modify the same data structures in a shared way");
532      addDocument("foo", doc);
533      Query q = new Query("data").highlightFields().summarizeFields();
534      SearchResult res = client.ftSearch(index, q);
535      assertEquals("is often referred as a <b>data</b> structures server. What this means is that Redis provides... What this means is that Redis provides access to mutable <b>data</b> structures via a set of commands, which are sent using a... So different processes can query and modify the same <b>data</b> structures in a shared... ",
536          res.getDocuments().get(0).get("text"));
537      q = new Query("data").highlightFields(new Query.HighlightTags("<u>", "</u>")).summarizeFields();
538      res = client.ftSearch(index, q);
539      assertEquals("is often referred as a <u>data</u> structures server. What this means is that Redis provides... What this means is that Redis provides access to mutable <u>data</u> structures via a set of commands, which are sent using a... So different processes can query and modify the same <u>data</u> structures in a shared... ",
540          res.getDocuments().get(0).get("text"));
541    }
542    @Test
543    public void getTagField() {
544      Schema sc = new Schema()
545          .addTextField("title", 1.0)
546          .addTagField("category");
547      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
548      Map<String, Object> fields1 = new HashMap<>();
549      fields1.put("title", "hello world");
550      fields1.put("category", "red");
551      addDocument("foo", fields1);
552      Map<String, Object> fields2 = new HashMap<>();
553      fields2.put("title", "hello world");
554      fields2.put("category", "blue");
555      addDocument("bar", fields2);
556      Map<String, Object> fields3 = new HashMap<>();
557      fields3.put("title", "hello world");
558      fields3.put("category", "green,yellow");
559      addDocument("baz", fields3);
560      Map<String, Object> fields4 = new HashMap<>();
561      fields4.put("title", "hello world");
562      fields4.put("category", "orange;purple");
563      addDocument("qux", fields4);
564      assertEquals(1, client.ftSearch(index, new Query("@category:{red}")).getTotalResults());
565      assertEquals(1, client.ftSearch(index, new Query("@category:{blue}")).getTotalResults());
566      assertEquals(1, client.ftSearch(index, new Query("hello @category:{red}")).getTotalResults());
567      assertEquals(1, client.ftSearch(index, new Query("hello @category:{blue}")).getTotalResults());
568      assertEquals(1, client.ftSearch(index, new Query("@category:{yellow}")).getTotalResults());
569      assertEquals(0, client.ftSearch(index, new Query("@category:{purple}")).getTotalResults());
570      assertEquals(1, client.ftSearch(index, new Query("@category:{orange\\;purple}")).getTotalResults());
571      assertEquals(4, client.ftSearch(index, new Query("hello")).getTotalResults());
572      assertEquals(new HashSet<>(Arrays.asList("red", "blue", "green", "yellow", "orange;purple")),
573          client.ftTagVals(index, "category"));
574    }
575    @Test
576    public void testGetTagFieldWithNonDefaultSeparator() {
577      Schema sc = new Schema()
578          .addTextField("title", 1.0)
579          .addTagField("category", ";");
580      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
581      Map<String, Object> fields1 = new HashMap<>();
582      fields1.put("title", "hello world");
583      fields1.put("category", "red");
584      addDocument("foo", fields1);
585      Map<String, Object> fields2 = new HashMap<>();
586      fields2.put("title", "hello world");
587      fields2.put("category", "blue");
588      addDocument("bar", fields2);
589      Map<String, Object> fields3 = new HashMap<>();
590      fields3.put("title", "hello world");
591      fields3.put("category", "green;yellow");
592      addDocument("baz", fields3);
593      Map<String, Object> fields4 = new HashMap<>();
594      fields4.put("title", "hello world");
595      fields4.put("category", "orange,purple");
596      addDocument("qux", fields4);
597      assertEquals(1, client.ftSearch(index, new Query("@category:{red}")).getTotalResults());
598      assertEquals(1, client.ftSearch(index, new Query("@category:{blue}")).getTotalResults());
599      assertEquals(1, client.ftSearch(index, new Query("hello @category:{red}")).getTotalResults());
600      assertEquals(1, client.ftSearch(index, new Query("hello @category:{blue}")).getTotalResults());
601      assertEquals(1, client.ftSearch(index, new Query("hello @category:{yellow}")).getTotalResults());
602      assertEquals(0, client.ftSearch(index, new Query("@category:{purple}")).getTotalResults());
603      assertEquals(1, client.ftSearch(index, new Query("@category:{orange\\,purple}")).getTotalResults());
604      assertEquals(4, client.ftSearch(index, new Query("hello")).getTotalResults());
605      assertEquals(new HashSet<>(Arrays.asList("red", "blue", "green", "yellow", "orange,purple")),
606          client.ftTagVals(index, "category"));
607    }
608    @Test
609    public void caseSensitiveTagField() {
610      Schema sc = new Schema()
611          .addTextField("title", 1.0)
612          .addTagField("category", true &bsol;*casesensitive*/);
613      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
614      Map<String, Object> fields = new HashMap<>();
615      fields.put("title", "hello world");
616      fields.put("category", "RedX");
617      addDocument("foo", fields);
618      assertEquals(0, client.ftSearch(index, new Query("@category:{redx}")).getTotalResults());
619      assertEquals(0, client.ftSearch(index, new Query("@category:{redX}")).getTotalResults());
620      assertEquals(0, client.ftSearch(index, new Query("@category:{Redx}")).getTotalResults());
621      assertEquals(1, client.ftSearch(index, new Query("@category:{RedX}")).getTotalResults());
622      assertEquals(1, client.ftSearch(index, new Query("hello")).getTotalResults());
623    }
624    @Test
625    public void testReturnFields() throws Exception {
626      Schema sc = new Schema().addTextField("field1", 1.0).addTextField("field2", 1.0);
627      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
628      Map<String, Object> doc = new HashMap<>();
629      doc.put("field1", "value1");
630      doc.put("field2", "value2");
631      addDocument("doc", doc);
632      SearchResult res = client.ftSearch(index, new Query("*").returnFields("field1"));
633      assertEquals(1, res.getTotalResults());
634      assertEquals("value1", res.getDocuments().get(0).get("field1"));
635      assertNull(res.getDocuments().get(0).get("field2"));
636    }
637    @Test
638    public void returnWithFieldNames() throws Exception {
639      Schema sc = new Schema().addTextField("a", 1).addTextField("b", 1).addTextField("c", 1);
640      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
641      Map<String, Object> map = new HashMap<>();
642      map.put("a", "value1");
643      map.put("b", "value2");
644      map.put("c", "value3");
645      addDocument("doc", map);
646      SearchResult res = client.ftSearch(index,
647          new Query().returnFields(FieldName.of("a"), FieldName.of("b").as("d")));
648      assertEquals(1, res.getTotalResults());
649      Document doc = res.getDocuments().get(0);
650      assertEquals("value1", doc.get("a"));
651      assertNull(doc.get("b"));
652      assertEquals("value2", doc.get("d"));
653      assertNull(doc.get("c"));
654    }
655    @Test
656    public void inKeys() throws Exception {
657      Schema sc = new Schema().addTextField("field1", 1.0).addTextField("field2", 1.0);
658      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
659      Map<String, Object> doc = new HashMap<>();
660      doc.put("field1", "value");
661      doc.put("field2", "not");
662      addDocument("doc1", doc);
663      addDocument("doc2", doc);
664      SearchResult res = client.ftSearch(index, new Query("value").limitKeys("doc1"));
665      assertEquals(1, res.getTotalResults());
666      assertEquals("doc1", res.getDocuments().get(0).getId());
667      assertEquals("value", res.getDocuments().get(0).get("field1"));
668      assertEquals(null, res.getDocuments().get(0).get("value"));
669    }
670    @Test
671    public void blobField() throws Exception {
672      Schema sc = new Schema().addTextField("field1", 1.0);
673      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
674      byte[] blob = new byte[]{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12};
675      Map<String, Object> doc = new HashMap<>();
676      doc.put("field1", "value");
677      doc.put("field2", blob);
678      addDocument("doc1", doc);
679      SearchResult res = client.ftSearch(SafeEncoder.encode(index), new Query("value"));
680      assertEquals(1, res.getTotalResults());
681      assertEquals("doc1", res.getDocuments().get(0).getId());
682      assertEquals("value", res.getDocuments().get(0).getString("field1"));
683      assertArrayEquals(blob, (byte[]) res.getDocuments().get(0).get("field2"));
684    }
685    @Test
686    public void alias() throws Exception {
687      Schema sc = new Schema().addTextField("field1", 1.0);
688      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
689      Map<String, Object> doc = new HashMap<>();
690      doc.put("field1", "value");
691      addDocument("doc1", doc);
692      assertEquals("OK", client.ftAliasAdd("ALIAS1", index));
693      SearchResult res1 = client.ftSearch("ALIAS1", new Query("*").returnFields("field1"));
694      assertEquals(1, res1.getTotalResults());
695      assertEquals("value", res1.getDocuments().get(0).get("field1"));
696      assertEquals("OK", client.ftAliasUpdate("ALIAS2", index));
697      SearchResult res2 = client.ftSearch("ALIAS2", new Query("*").returnFields("field1"));
698      assertEquals(1, res2.getTotalResults());
699      assertEquals("value", res2.getDocuments().get(0).get("field1"));
700      try {
701        client.ftAliasDel("ALIAS3");
702        fail("Should throw JedisDataException");
703      } catch (JedisDataException e) {
704      }
705      assertEquals("OK", client.ftAliasDel("ALIAS2"));
706      try {
707        client.ftAliasDel("ALIAS2");
708        fail("Should throw JedisDataException");
709      } catch (JedisDataException e) {
710      }
711    }
712    @Test
713    public void synonym() {
714      Schema sc = new Schema().addTextField("name", 1.0).addTextField("addr", 1.0);
715      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
716      long group1 = 345L;
717      long group2 = 789L;
718      String group1_str = Long.toString(group1);
719      String group2_str = Long.toString(group2);
720      assertEquals("OK", client.ftSynUpdate(index, group1_str, "girl", "baby"));
721      assertEquals("OK", client.ftSynUpdate(index, group1_str, "child"));
722      assertEquals("OK", client.ftSynUpdate(index, group2_str, "child"));
723      Map<String, List<String>> dump = client.ftSynDump(index);
724      Map<String, List<String>> expected = new HashMap<>();
725      expected.put("girl", Arrays.asList(group1_str));
726      expected.put("baby", Arrays.asList(group1_str));
727      expected.put("child", Arrays.asList(group1_str, group2_str));
728      assertEquals(expected, dump);
729    }
730    @Test
731    public void slop() {
732      Schema sc = new Schema().addTextField("field1", 1.0).addTextField("field2", 1.0);
733      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
734      Map<String, Object> doc = new HashMap<>();
735      doc.put("field1", "ok hi jedis");
736      addDocument("doc1", doc);
737      SearchResult res = client.ftSearch(index, new Query("ok jedis").slop(0));
738      assertEquals(0, res.getTotalResults());
739      res = client.ftSearch(index, new Query("ok jedis").slop(1));
740      assertEquals(1, res.getTotalResults());
741      assertEquals("doc1", res.getDocuments().get(0).getId());
742      assertEquals("ok hi jedis", res.getDocuments().get(0).get("field1"));
743    }
744    @Test
745    public void timeout() {
746      Schema sc = new Schema().addTextField("field1", 1.0).addTextField("field2", 1.0);
747      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
748      Map<String, String> map = new HashMap<>();
749      map.put("field1", "value");
750      map.put("field2", "not");
751      client.hset("doc1", map);
752      SearchResult res = client.ftSearch(index, new Query("value").timeout(1000));
753      assertEquals(1, res.getTotalResults());
754      assertEquals("doc1", res.getDocuments().get(0).getId());
755      assertEquals("value", res.getDocuments().get(0).get("field1"));
756      assertEquals("not", res.getDocuments().get(0).get("field2"));
757    }
758    @Test
759    public void inOrder() {
760      Schema sc = new Schema().addTextField("field1", 1.0).addTextField("field2", 1.0);
761      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
762      Map<String, String> map = new HashMap<>();
763      map.put("field1", "value");
764      map.put("field2", "not");
765      client.hset("doc2", map);
766      client.hset("doc1", map);
767      SearchResult res = client.ftSearch(index, new Query("value").setInOrder());
768      assertEquals(2, res.getTotalResults());
769      assertEquals("doc2", res.getDocuments().get(0).getId());
770      assertEquals("value", res.getDocuments().get(0).get("field1"));
771      assertEquals("not", res.getDocuments().get(0).get("field2"));
772    }
773    @Test
774    public void testDialectsWithFTExplain() throws Exception {
775      Map<String, Object> attr = new HashMap<>();
776      attr.put("TYPE", "FLOAT32");
777      attr.put("DIM", 2);
778      attr.put("DISTANCE_METRIC", "L2");
779      Schema sc = new Schema()
780          .addFlatVectorField("v", attr)
781          .addTagField("title")
782          .addTextField("t1", 1.0)
783          .addTextField("t2", 1.0)
784          .addNumericField("num");
785      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
786      client.hset("1", "t1", "hello");
787      String q = "(*)";
788      Query query = new Query(q).dialect(1);
789      try {
790        client.ftExplain(index, query);
791        fail();
792      } catch (JedisDataException e) {
793        assertTrue("Should contain 'Syntax error'", e.getMessage().contains("Syntax error"));
794      }
795      query = new Query(q).dialect(2);
796      assertTrue("Should contain 'WILDCARD'", client.ftExplain(index, query).contains("WILDCARD"));
797      q = "$hello";
798      query = new Query(q).dialect(1);
799      try {
800        client.ftExplain(index, query);
801        fail();
802      } catch (JedisDataException e) {
803        assertTrue("Should contain 'Syntax error'", e.getMessage().contains("Syntax error"));
804      }
805      query = new Query(q).dialect(2).addParam("hello", "hello");
806      assertTrue("Should contain 'UNION {\n  hello\n  +hello(expanded)\n}\n'",
807          client.ftExplain(index, query).contains("UNION {\n  hello\n  +hello(expanded)\n}\n"));
808      q = "@title:(@num:[0 10])";
809      query = new Query(q).dialect(1);
810      assertTrue("Should contain 'NUMERIC {0.000000 <= @num <= 10.000000}'",
811          client.ftExplain(index, query).contains("NUMERIC {0.000000 <= @num <= 10.000000}"));
812      query = new Query(q).dialect(2);
813      try {
814        client.ftExplain(index, query);
815        fail();
816      } catch (JedisDataException e) {
817        assertTrue("Should contain 'Syntax error'", e.getMessage().contains("Syntax error"));
818      }
819      q = "@t1:@t2:@t3:hello";
820      query = new Query(q).dialect(1);
821      assertTrue("Should contain '@NULL:UNION {\n  @NULL:hello\n  @NULL:+hello(expanded)\n}\n'",
822          client.ftExplain(index, query).contains("@NULL:UNION {\n  @NULL:hello\n  @NULL:+hello(expanded)\n}\n"));
823      query = new Query(q).dialect(2);
824      try {
825        client.ftExplain(index, query);
826        fail();
827      } catch (JedisDataException e) {
828        assertTrue("Should contain 'Syntax error'", e.getMessage().contains("Syntax error"));
829      }
830      q = "@title:{foo}}}}}";
831      query = new Query(q).dialect(1);
832      assertTrue("Should contain 'TAG:@title {\n  foo\n}\n'",
833          client.ftExplain(index, query).contains("TAG:@title {\n  foo\n}\n"));
834      query = new Query(q).dialect(2);
835      try {
836        client.ftExplain(index, query);
837        fail();
838      } catch (JedisDataException e) {
839        assertTrue("Should contain 'Syntax error'", e.getMessage().contains("Syntax error"));
840      }
841      q = "*=>[KNN 10 @v $BLOB]";
842      query = new Query(q).addParam("BLOB", "aaaa").dialect(1);
843      try {
844        client.ftExplain(index, query);
845        fail();
846      } catch (JedisDataException e) {
847        assertTrue("Should contain 'Syntax error'", e.getMessage().contains("Syntax error"));
848      }
849      query = new Query(q).addParam("BLOB", "aaaa").dialect(2);
850      assertTrue("Should contain '{K=10 nearest vector'", client.ftExplain(index, query).contains("{K=10 nearest vector"));
851      q = "*=>[knn $K @vec_field $BLOB as score]";
852      query = new Query(q).addParam("BLOB", "aaaa").addParam("K", "10").dialect(1);
853      try {
854        client.ftExplain(index, query);
855        fail();
856      } catch (JedisDataException e) {
857        assertTrue("Should contain 'Syntax error'", e.getMessage().contains("Syntax error"));
858      }
859      query = new Query(q).addParam("BLOB", "aaaa").addParam("K", "10").dialect(2);
860      assertTrue("Should contain '{K=10 nearest vector'", client.ftExplain(index, query).contains("{K=10 nearest vector"));
861    }
862    @Test
863    public void testHNSWVVectorSimilarity() {
864      Map<String, Object> attr = new HashMap<>();
865      attr.put("TYPE", "FLOAT32");
866      attr.put("DIM", 2);
867      attr.put("DISTANCE_METRIC", "L2");
868      Schema sc = new Schema().addHNSWVectorField("v", attr);
869      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
870      client.hset("a", "v", "aaaaaaaa");
871      client.hset("b", "v", "aaaabaaa");
872      client.hset("c", "v", "aaaaabaa");
873      Query query = new Query("*=>[KNN 2 @v $vec]")
874          .addParam("vec", "aaaaaaaa")
875          .setSortBy("__v_score", true)
876          .returnFields("__v_score")
877          .dialect(2);
878      Document doc1 = client.ftSearch(index, query).getDocuments().get(0);
879      assertEquals("a", doc1.getId());
880      assertEquals("0", doc1.get("__v_score"));
881      Map.Entry<SearchResult, Map<String, Object>> profile
882          = client.ftProfileSearch(index, FTProfileParams.profileParams(), query);
883      doc1 = profile.getKey().getDocuments().get(0);
884      assertEquals("a", doc1.getId());
885      assertEquals("0", doc1.get("__v_score"));
886      Map<String, Object> iteratorsProfile = (Map<String, Object>) profile.getValue().get("Iterators profile");
887      assertEquals("VECTOR", iteratorsProfile.get("Type"));
888    }
889    @Test
890    public void testFlatVectorSimilarity() {
891      Map<String, Object> attr = new HashMap<>();
892      attr.put("TYPE", "FLOAT32");
893      attr.put("DIM", 2);
894      attr.put("DISTANCE_METRIC", "L2");
895      Schema sc = new Schema().addFlatVectorField("v", attr);
896      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
897      client.hset("a", "v", "aaaaaaaa");
898      client.hset("b", "v", "aaaabaaa");
899      client.hset("c", "v", "aaaaabaa");
900      Query query = new Query("*=>[KNN 2 @v $vec]")
901          .addParam("vec", "aaaaaaaa")
902          .setSortBy("__v_score", true)
903          .returnFields("__v_score")
904          .dialect(2);
905      Document doc1 = client.ftSearch(index, query).getDocuments().get(0);
906      assertEquals("a", doc1.getId());
907      assertEquals("0", doc1.get("__v_score"));
908      Map.Entry<SearchResult, Map<String, Object>> profile
909          = client.ftProfileSearch(index, FTProfileParams.profileParams(), query);
910      doc1 = profile.getKey().getDocuments().get(0);
911      assertEquals("a", doc1.getId());
912      assertEquals("0", doc1.get("__v_score"));
913      Map<String, Object> iteratorsProfile = (Map<String, Object>) profile.getValue().get("Iterators profile");
914      assertEquals("VECTOR", iteratorsProfile.get("Type"));
915    }
916    @Test
917    public void searchProfile() {
918      Schema sc = new Schema().addTextField("t1", 1.0).addTextField("t2", 1.0);
919      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions(), sc));
920      Map<String, String> map = new HashMap<>();
921      map.put("t1", "foo");
922      map.put("t2", "bar");
923      client.hset("doc1", map);
924      Map.Entry<SearchResult, Map<String, Object>> profile = client.ftProfileSearch(index,
925          FTProfileParams.profileParams(), new Query("foo"));
926      Map<String, Object> iteratorsProfile = (Map<String, Object>) profile.getValue().get("Iterators profile");
927      assertEquals("TEXT", iteratorsProfile.get("Type"));
928      assertEquals("foo", iteratorsProfile.get("Term"));
929      assertEquals(1L, iteratorsProfile.get("Counter"));
930      assertEquals(1L, iteratorsProfile.get("Size"));
931      assertSame(Double.class, iteratorsProfile.get("Time").getClass());
932    }
933    @Test
934    public void searchIteration() throws Exception {
935      Schema sc = new Schema().addTextField("first", 1.0).addTextField("last", 1.0).addNumericField("age");
936      IndexDefinition rule = new IndexDefinition();
937      assertEquals("OK", client.ftCreate(index, IndexOptions.defaultOptions().setDefinition(rule), sc));
938      client.hset("profesor:5555", toMap("first", "Albert", "last", "Blue", "age", "55"));
939      client.hset("student:1111", toMap("first", "Joe", "last", "Dod", "age", "18"));
940      client.hset("pupil:2222", toMap("first", "Jen", "last", "Rod", "age", "14"));
941      client.hset("student:3333", toMap("first", "El", "last", "Mark", "age", "17"));
942      client.hset("pupil:4444", toMap("first", "Pat", "last", "Shu", "age", "21"));
943      client.hset("student:5555", toMap("first", "Joen", "last", "Ko", "age", "20"));
944      client.hset("teacher:6666", toMap("first", "Pat", "last", "Rod", "age", "20"));
945      FtSearchIteration search = client.ftSearchIteration(3, index, new Query());
946      int total = 0;
947      while (!search.isIterationCompleted()) {
948        SearchResult result = search.nextBatch();
949        int count = result.getDocuments().size();
950        assertThat(count, Matchers.lessThanOrEqualTo(3));
951        total += count;
952      }
953      assertEquals(7, total);
954    }
955  }
</code></pre>
        </div>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-AggregationTest.java</h3>
            <pre><code>1  package redis.clients.jedis.modules.search;
2  import static org.junit.Assert.assertEquals;
3  import static org.junit.Assert.assertNotNull;
4  import static org.junit.Assert.assertNull;
5  import static org.junit.Assert.assertThat;
6  import static org.junit.Assert.fail;
7  import org.hamcrest.Matchers;
8  import org.junit.BeforeClass;
9  import org.junit.Test;
10  import java.util.ArrayList;
11  import java.util.HashMap;
12  import java.util.LinkedHashMap;
13  import java.util.List;
14  import java.util.Map;
15  import redis.clients.jedis.exceptions.JedisDataException;
16  import redis.clients.jedis.search.Document;
17  import redis.clients.jedis.search.FieldName;
18  import redis.clients.jedis.search.IndexOptions;
19  import redis.clients.jedis.search.Schema;
20  import redis.clients.jedis.search.aggr.AggregationBuilder;
21  import redis.clients.jedis.search.aggr.AggregationResult;
22  import redis.clients.jedis.search.aggr.Reducers;
23  import redis.clients.jedis.search.aggr.Row;
24  import redis.clients.jedis.search.aggr.SortedField;
25  import redis.clients.jedis.modules.RedisModuleCommandsTestBase;
26  import redis.clients.jedis.search.aggr.FtAggregateIteration;
27  import redis.clients.jedis.search.schemafields.NumericField;
28  import redis.clients.jedis.search.schemafields.TextField;
29  public class AggregationTest extends RedisModuleCommandsTestBase {
30    private static final String index = "aggbindex";
31    @BeforeClass
32    public static void prepare() {
33      RedisModuleCommandsTestBase.prepare();
34    }
35    private void addDocument(Document doc) {
36      String key = doc.getId();
37      Map<String, String> map = new LinkedHashMap<>();
38      doc.getProperties().forEach(entry -> map.put(entry.getKey(), String.valueOf(entry.getValue())));
39      client.hset(key, map);
40    }
41    private void addDocument(String key, Map<String, Object> objMap) {
42      Map<String, String> strMap = new HashMap<>();
43      objMap.entrySet().forEach(entry -> strMap.put(entry.getKey(), String.valueOf(entry.getValue())));
44      client.hset(key, strMap);
45    }
46    @Test
47    public void testAggregations() {
48      Schema sc = new Schema();
49      sc.addSortableTextField("name", 1.0);
50      sc.addSortableNumericField("count");
51      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
52      addDocument(new Document("data1").set("name", "abc").set("count", 10));
53      addDocument(new Document("data2").set("name", "def").set("count", 5));
54      addDocument(new Document("data3").set("name", "def").set("count", 25));
55      AggregationBuilder r = new AggregationBuilder()
56          .groupBy("@name", Reducers.sum("@count").as("sum"))
57          .sortBy(10, SortedField.desc("@sum"));
58      AggregationResult res = client.ftAggregate(index, r);
59      assertEquals(2, res.getTotalResults());
60      Row r1 = res.getRow(0);
61      assertNotNull(r1);
62      assertEquals("def", r1.getString("name"));
63      assertEquals(30, r1.getLong("sum"));
64      assertEquals(30., r1.getDouble("sum"), 0);
65      assertEquals(0L, r1.getLong("nosuchcol"));
66      assertEquals(0.0, r1.getDouble("nosuchcol"), 0);
67      assertEquals("", r1.getString("nosuchcol"));
68      Row r2 = res.getRow(1);
69      assertNotNull(r2);
70      assertEquals("abc", r2.getString("name"));
71      assertEquals(10, r2.getLong("sum"));
72    }
73    @Test
74    public void testAggregations2() {
75      Schema sc = new Schema();
76      sc.addSortableTextField("name", 1.0);
77      sc.addSortableNumericField("count");
78      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
79      addDocument(new Document("data1").set("name", "abc").set("count", 10));
80      addDocument(new Document("data2").set("name", "def").set("count", 5));
81      addDocument(new Document("data3").set("name", "def").set("count", 25));
82      AggregationBuilder r = new AggregationBuilder()
83          .groupBy("@name", Reducers.sum("@count").as("sum"))
84          .sortBy(10, SortedField.desc("@sum"));
85      AggregationResult res = client.ftAggregate(index, r);
86      assertEquals(2, res.getTotalResults());
87      List<Row> rows = res.getRows();
88      assertEquals("def", rows.get(0).get("name"));
89      assertEquals("30", rows.get(0).get("sum"));
90      assertNull(rows.get(0).get("nosuchcol"));
91      assertEquals("abc", rows.get(1).get("name"));
92      assertEquals("10", rows.get(1).get("sum"));
93    }
94    @Test
95    public void testAggregationBuilderVerbatim() {
96      Schema sc = new Schema();
97      sc.addSortableTextField("name", 1.0);
98      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
99      addDocument(new Document("data1").set("name", "hello kitty"));
100      AggregationBuilder r = new AggregationBuilder("kitti");
101      AggregationResult res = client.ftAggregate(index, r);
102      assertEquals(1, res.getTotalResults());
<span onclick='openModal()' class='match'>103      r = new AggregationBuilder("kitti")
104              .verbatim();
105      res = client.ftAggregate(index, r);
106      assertEquals(0, res.getTotalResults());
</span>107    }
108    @Test
109    public void testAggregationBuilderTimeout() {
110      Schema sc = new Schema();
111      sc.addSortableTextField("name", 1.0);
112      sc.addSortableNumericField("count");
113      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
114      addDocument(new Document("data1").set("name", "abc").set("count", 10));
115      addDocument(new Document("data2").set("name", "def").set("count", 5));
116      addDocument(new Document("data3").set("name", "def").set("count", 25));
117      AggregationBuilder r = new AggregationBuilder()
118              .groupBy("@name", Reducers.sum("@count").as("sum"))
119              .timeout(5000);
120      AggregationResult res = client.ftAggregate(index, r);
121      assertEquals(2, res.getTotalResults());
122    }
123    @Test
124    public void testAggregationBuilderParamsDialect() {
125      Schema sc = new Schema();
126      sc.addSortableTextField("name", 1.0);
127      sc.addSortableNumericField("count");
128      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
129      addDocument(new Document("data1").set("name", "abc").set("count", 10));
130      addDocument(new Document("data2").set("name", "def").set("count", 5));
131      addDocument(new Document("data3").set("name", "def").set("count", 25));
132      Map<String, Object> params = new HashMap<>();
133      params.put("name", "abc");
134      AggregationBuilder r = new AggregationBuilder("$name")
135              .groupBy("@name", Reducers.sum("@count").as("sum"))
136              .params(params)
137              .dialect(2); 
138      AggregationResult res = client.ftAggregate(index, r);
139      assertEquals(1, res.getTotalResults());
140      Row r1 = res.getRow(0);
141      assertNotNull(r1);
142      assertEquals("abc", r1.getString("name"));
143      assertEquals(10, r1.getLong("sum"));
144    }
145    @Test
146    public void testApplyAndFilterAggregations() {
147      Schema sc = new Schema();
148      sc.addSortableTextField("name", 1.0);
149      sc.addSortableNumericField("subj1");
150      sc.addSortableNumericField("subj2");
151      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
152      addDocument(new Document("data1").set("name", "abc").set("subj1", 20).set("subj2", 70));
153      addDocument(new Document("data2").set("name", "def").set("subj1", 60).set("subj2", 40));
154      addDocument(new Document("data3").set("name", "ghi").set("subj1", 50).set("subj2", 80));
155      addDocument(new Document("data4").set("name", "abc").set("subj1", 30).set("subj2", 20));
156      addDocument(new Document("data5").set("name", "def").set("subj1", 65).set("subj2", 45));
157      addDocument(new Document("data6").set("name", "ghi").set("subj1", 70).set("subj2", 70));
158      AggregationBuilder r = new AggregationBuilder().apply("(@subj1+@subj2)/2", "attemptavg")
159          .groupBy("@name", Reducers.avg("@attemptavg").as("avgscore"))
160          .filter("@avgscore>=50")
161          .sortBy(10, SortedField.asc("@name"));
162      AggregationResult res = client.ftAggregate(index, r);
163      assertEquals(3, res.getTotalResults());
164      Row r1 = res.getRow(0);
165      assertNotNull(r1);
166      assertEquals("def", r1.getString("name"));
167      assertEquals(52.5, r1.getDouble("avgscore"), 0);
168      Row r2 = res.getRow(1);
169      assertNotNull(r2);
170      assertEquals("ghi", r2.getString("name"));
171      assertEquals(67.5, r2.getDouble("avgscore"), 0);
172    }
173    @Test
174    public void load() {
175      Schema sc = new Schema();
176      sc.addSortableTextField("name", 1.0);
177      sc.addSortableNumericField("subj1");
178      sc.addSortableNumericField("subj2");
179      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
180      addDocument(new Document("data1").set("name", "abc").set("subj1", 20).set("subj2", 70));
181      addDocument(new Document("data2").set("name", "def").set("subj1", 60).set("subj2", 40));
182      AggregationBuilder builder = new AggregationBuilder()
183          .load(FieldName.of("@subj1").as("a"), FieldName.of("@subj2").as("b"))
184          .apply("(@a+@b)/2", "avg").sortByDesc("@avg");
185      AggregationResult result = client.ftAggregate(index, builder);
186      assertEquals(50.0, result.getRow(0).getDouble("avg"), 0d);
187      assertEquals(45.0, result.getRow(1).getDouble("avg"), 0d);
188    }
189    @Test
190    public void loadAll() {
191      Schema sc = new Schema();
192      sc.addSortableTextField("name", 1.0);
193      sc.addSortableNumericField("subj1");
194      sc.addSortableNumericField("subj2");
195      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
196      addDocument(new Document("data1").set("name", "abc").set("subj1", 20).set("subj2", 70));
197      addDocument(new Document("data2").set("name", "def").set("subj1", 60).set("subj2", 40));
198      AggregationBuilder builder = new AggregationBuilder()
199          .loadAll()
200          .apply("(@subj1+@subj2)/2", "avg").sortByDesc("@avg");
201      AggregationResult result = client.ftAggregate(index, builder);
202      assertEquals(50.0, result.getRow(0).getDouble("avg"), 0d);
203      assertEquals(45.0, result.getRow(1).getDouble("avg"), 0d);
204    }
205    @Test
206    public void cursor() {
207      Schema sc = new Schema();
208      sc.addSortableTextField("name", 1.0);
209      sc.addSortableNumericField("count");
210      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
211      addDocument(new Document("data1").set("name", "abc").set("count", 10));
212      addDocument(new Document("data2").set("name", "def").set("count", 5));
213      addDocument(new Document("data3").set("name", "def").set("count", 25));
214      AggregationBuilder r = new AggregationBuilder()
215          .groupBy("@name", Reducers.sum("@count").as("sum"))
216          .sortBy(10, SortedField.desc("@sum"))
217          .cursor(1, 3000);
218      AggregationResult res = client.ftAggregate(index, r);
219      assertEquals(2, res.getTotalResults());
220      Row row = res.getRow(0);
221      assertNotNull(row);
222      assertEquals("def", row.getString("name"));
223      assertEquals(30, row.getLong("sum"));
224      assertEquals(30., row.getDouble("sum"), 0);
225      assertEquals(0L, row.getLong("nosuchcol"));
226      assertEquals(0.0, row.getDouble("nosuchcol"), 0);
227      assertEquals("", row.getString("nosuchcol"));
228      res = client.ftCursorRead(index, res.getCursorId(), 1);
229      Row row2 = res.getRow(0);
230      assertNotNull(row2);
231      assertEquals("abc", row2.getString("name"));
232      assertEquals(10, row2.getLong("sum"));
233      assertEquals("OK", client.ftCursorDel(index, res.getCursorId()));
234      try {
235        client.ftCursorRead(index, res.getCursorId(), 1);
236        fail();
237      } catch (JedisDataException e) {
238      }
239    }
240    @Test
241    public void aggregateIteration() {
242      client.ftCreate(index, TextField.of("name").sortable(), NumericField.of("count"));
243      addDocument(new Document("data1").set("name", "abc").set("count", 10));
244      addDocument(new Document("data2").set("name", "def").set("count", 5));
245      addDocument(new Document("data3").set("name", "def").set("count", 25));
246      addDocument(new Document("data4").set("name", "ghi").set("count", 15));
247      addDocument(new Document("data5").set("name", "jkl").set("count", 20));
248      AggregationBuilder agg = new AggregationBuilder()
249          .groupBy("@name", Reducers.sum("@count").as("sum"))
250          .sortBy(10, SortedField.desc("@sum"))
251          .cursor(2, 10000);
252      FtAggregateIteration rr = client.ftAggregateIteration(index, agg);
253      int total = 0;
254      while (!rr.isIterationCompleted()) {
255        AggregationResult res = rr.nextBatch();
256        int count = res.getRows().size();
257        assertThat(count, Matchers.lessThanOrEqualTo(2));
258        total += count;
259      }
260      assertEquals(4, total);
261    }
262    @Test
263    public void aggregateIterationCollect() {
264      client.ftCreate(index, TextField.of("name").sortable(), NumericField.of("count"));
265      addDocument(new Document("data1").set("name", "abc").set("count", 10));
266      addDocument(new Document("data2").set("name", "def").set("count", 5));
267      addDocument(new Document("data3").set("name", "def").set("count", 25));
268      addDocument(new Document("data4").set("name", "ghi").set("count", 15));
269      addDocument(new Document("data5").set("name", "jkl").set("count", 20));
270      AggregationBuilder agg = new AggregationBuilder()
271          .groupBy("@name", Reducers.sum("@count").as("sum"))
272          .sortBy(10, SortedField.desc("@sum"))
273          .cursor(2, 10000);
274      assertEquals(4, client.ftAggregateIteration(index, agg).collect(new ArrayList<>()).size());
275    }
276    @Test
277    public void testWrongAggregation() throws InterruptedException {
278      Schema sc = new Schema()
279          .addTextField("title", 5.0)
280          .addTextField("body", 1.0)
281          .addTextField("state", 1.0)
282          .addNumericField("price");
283      client.ftCreate(index, IndexOptions.defaultOptions(), sc);
284      Map<String, Object> fields = new HashMap<>();
285      fields.put("title", "hello world");
286      fields.put("state", "NY");
287      fields.put("body", "lorem ipsum");
288      fields.put("price", "1337");
289      addDocument("doc1", fields);
290      AggregationBuilder builder = new AggregationBuilder("hello")
291          .apply("@price/1000", "k")
292          .groupBy("@state", Reducers.avg("@k").as("avgprice"))
293          .filter("@avgprice>=2")
294          .sortBy(10, SortedField.asc("@state"));
295      try {
296        client.ftAggregate(index, builder);
297        fail();
298      } catch (JedisDataException e) {
299      }
300    }
301  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-SearchTest.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-AggregationTest.java</div>
                </div>
                <div class="column column_space"><pre><code>280      q = new Query("hello").setNoContent();
281      res = client.ftSearch(index, q);
282      for (Document d : res.getDocuments()) {
</pre></code></div>
                <div class="column column_space"><pre><code>103      r = new AggregationBuilder("kitti")
104              .verbatim();
105      res = client.ftAggregate(index, r);
106      assertEquals(0, res.getTotalResults());
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    