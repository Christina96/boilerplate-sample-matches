
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 9.06148867313916%, Tokens: 14</h2>
        <div class="column">
            <h3>segmentfault-lessons-MDEwOlJlcG9zaXRvcnk5MzE1NzM4MQ==-flat-RepositoryAnnotationProcessor.java</h3>
            <pre><code><span onclick='openModal()' class='match'>1  package com.segementfalut.deep.in.java.annotation.processing;
2  import javax.annotation.processing.*;
3  import javax.lang.model.SourceVersion;
4  import javax.lang.model.element.Element;
5  import javax.lang.model.element.ElementKind;
6  import javax.lang.model.element.Modifier;
7  import javax.lang.model.element.TypeElement;
8  import javax.lang.model.type.DeclaredType;
9  import javax.lang.model.type.TypeMirror;
10  import javax.lang.model.util.Types;
11  import javax.tools.FileObject;
12  import javax.tools.StandardLocation;
13  import java.io.IOException;
14  import java.io.Writer;
</span>15  import java.sql.Wrapper;
16  import java.util.*;
17  @SupportedAnnotationTypes(RepositoryAnnotationProcessor.REPOSITORY_ANNOTATION_CLASS_NAME)
18  @SupportedSourceVersion(SourceVersion.RELEASE_8)
19  public class RepositoryAnnotationProcessor extends AbstractProcessor {
20      public static final String REPOSITORY_ANNOTATION_CLASS_NAME = "com.segementfalut.deep.in.java.reflection.Repository";
21      private static final String CRUD_REPOSITORY_INTERFACE_CLASS_NAME = "com.segementfalut.deep.in.java.reflection.CrudRepository";
22      private Map<String, String> crudRepositoryParameterizedTypesMapping = new HashMap<>();
23      @Override
24      public boolean process(Set<? extends TypeElement> annotations, RoundEnvironment roundEnv) {
25          roundEnv.getRootElements()
26                  .stream()
27                  .filter(this::isRepositoryAnnotationPresent) 
28                  .forEach(this::processRepositoryAnnotatedElement);     
29          if (roundEnv.processingOver()) {
30              try {
31                  generateCrudRepositoryParameterizedTypesMetadata();
32              } catch (IOException e) {
33                  throw new RuntimeException(e);
34              }
35          }
36          return false;
37      }
38      private void generateCrudRepositoryParameterizedTypesMetadata() throws IOException {
39          Filer filer = processingEnv.getFiler();
40          String resourceName = "META-INF/crud-repos-mappings.properties";
41          FileObject fileObject = filer.createResource(StandardLocation.CLASS_OUTPUT, "", resourceName);
42          try (Writer writer = fileObject.openWriter()) {
43              Properties properties = new Properties();
44              properties.putAll(crudRepositoryParameterizedTypesMapping);
45              properties.store(writer, "Generated by RepositoryAnnotationProcessor");
46          }
47      }
48      private void processRepositoryAnnotatedElement(Element element) {
49          if (!isConcreteClass(element) || !isCrudRepositoryType(element)) {
50              return;
51          }
52          System.out.println("CrudRepository 实现类为 ：" + element.toString());
53          TypeMirror crudRepositoryGenericInterfaceType = getGenericInterfaceType(element, CRUD_REPOSITORY_INTERFACE_CLASS_NAME);
54          System.out.println("CrudRepository 实现泛型接口定义为 ：" + crudRepositoryGenericInterfaceType.toString());
55          DeclaredType declaredType = DeclaredType.class.cast(crudRepositoryGenericInterfaceType);
56          List<? extends TypeMirror> parameterizedTypes = declaredType.getTypeArguments();
57          TypeMirror firstArgumentType = parameterizedTypes.get(0);
58          System.out.println("CrudRepository 实现接口的首个泛型参数为 ：" + firstArgumentType.toString());
59          crudRepositoryParameterizedTypesMapping.put(crudRepositoryGenericInterfaceType.toString(), firstArgumentType.toString());
60      }
61      private boolean isConcreteClass(Element element) {
62          return !element.getModifiers().contains(Modifier.ABSTRACT);
63      }
64      private boolean isCrudRepositoryType(Element element) {
65          return getGenericInterfaceType(element, CRUD_REPOSITORY_INTERFACE_CLASS_NAME) != null;
66      }
67      private TypeMirror getGenericInterfaceType(Element element, String interfaceTypeName) {
68          ElementKind kind = element.getKind();
69          if (kind.isClass() && element instanceof TypeElement) {
70              TypeElement typeElement = (TypeElement) element;
71              return typeElement.getInterfaces().stream() 
72                      .filter(interfaceType -> typeEquals(interfaceType, interfaceTypeName))
73                      .findFirst() 
74                      .orElse(null);
75          }
76          return null;
77      }
78      private boolean typeEquals(TypeMirror type, String typeName) {
79          Types types = processingEnv.getTypeUtils();
80          TypeMirror erasedType = types.erasure(type); 
81          return Objects.equals(typeName, erasedType.toString());
82      }
83      private boolean isRepositoryAnnotationPresent(Element element) {
84          return isAnnotationPresent(element, REPOSITORY_ANNOTATION_CLASS_NAME);
85      }
86      private boolean isAnnotationPresent(Element element, String annotationClassName) {
87          return element.getAnnotationMirrors() 
88                  .stream()
89                  .filter(annotation -> Objects.equals(annotationClassName, annotation.getAnnotationType().toString()))
90                  .count() > 0;
91      }
92  }
</code></pre>
        </div>
        <div class="column">
            <h3>ribbon-MDEwOlJlcG9zaXRvcnk3NjE2MTU4-flat-TestExecutionListener.java</h3>
            <pre><code><span onclick='openModal()' class='match'>1  package com.netflix.ribbon.transport.netty.http;
2  import com.netflix.loadbalancer.reactive.ExecutionContext;
3  import com.netflix.loadbalancer.reactive.ExecutionInfo;
4  import com.netflix.loadbalancer.reactive.ExecutionListener;
5  import com.netflix.client.config.IClientConfig;
6  import com.netflix.loadbalancer.Server;
7  import io.netty.buffer.ByteBuf;
8  import io.reactivex.netty.protocol.http.client.HttpClientRequest;
9  import io.reactivex.netty.protocol.http.client.HttpClientResponse;
10  import java.util.List;
11  import java.util.concurrent.CopyOnWriteArrayList;
12  import java.util.concurrent.atomic.AtomicInteger;
13  import static org.junit.Assert.assertEquals;
14  import static org.junit.Assert.assertSame;
</span>15  public class TestExecutionListener<I, O> implements ExecutionListener<HttpClientRequest<I>, HttpClientResponse<O>> {
16      public AtomicInteger executionStartCounter = new AtomicInteger(0);
17      public AtomicInteger startWithServerCounter = new AtomicInteger(0);
18      public AtomicInteger exceptionWithServerCounter = new AtomicInteger(0);
19      public AtomicInteger executionFailedCounter = new AtomicInteger(0);
20      public AtomicInteger executionSuccessCounter = new AtomicInteger(0);
21      private HttpClientRequest<ByteBuf> expectedRequest;
22      private IClientConfig requestConfig;
23      private volatile boolean checkContext = true;
24      private volatile boolean checkExecutionInfo = true;
25      private volatile Throwable finalThrowable;
26      private HttpClientResponse<O> response;
27      private List<Throwable> errors = new CopyOnWriteArrayList<Throwable>();
28      private AtomicInteger numAttemptsOnServer = new AtomicInteger();
29      private AtomicInteger numServers = new AtomicInteger();
30      private volatile Server lastServer;
31      private static final Integer MY_OBJECT = Integer.valueOf(9);
32      private volatile ExecutionContext<HttpClientRequest<I>> context;
33      public TestExecutionListener(HttpClientRequest<ByteBuf> expectedRequest, IClientConfig requestConfig) {
34          this.expectedRequest = expectedRequest;
35          this.requestConfig = requestConfig;
36      }
37      private void checkContext(ExecutionContext<HttpClientRequest<I>> context) {
38          try {
39              assertSame(requestConfig, context.getRequestConfig());
40              assertSame(expectedRequest, context.getRequest());
41              assertEquals(MY_OBJECT, context.get("MyObject"));
42              if (this.context == null) {
43                  this.context = context;
44              } else {
45                  assertSame(this.context, context);
46              }
47          } catch (Throwable e) {
48              e.printStackTrace();
49              checkContext = false;
50          }
51      }
52      private void checkExecutionInfo(ExecutionInfo info) {
53          try {
54              assertEquals(numAttemptsOnServer.get(), info.getNumberOfPastAttemptsOnServer());
55              assertEquals(numServers.get(), info.getNumberOfPastServersAttempted());
56          } catch (Throwable e) {
57              e.printStackTrace();
58              checkExecutionInfo = false;
59          }
60      }
61      @Override
62      public void onExecutionStart(ExecutionContext<HttpClientRequest<I>> context) {
63          context.put("MyObject", MY_OBJECT);
64          checkContext(context);
65          executionStartCounter.incrementAndGet();
66      }
67      @Override
68      public void onStartWithServer(ExecutionContext<HttpClientRequest<I>> context, ExecutionInfo info) {
69          checkContext(context);
70          if (lastServer == null) {
71              lastServer = info.getServer();
72          } else if (!lastServer.equals(info.getServer())) {
73              lastServer = info.getServer();
74              numAttemptsOnServer.set(0);
75              numServers.incrementAndGet();
76          }
77          checkExecutionInfo(info);
78          startWithServerCounter.incrementAndGet();
79      }
80      @Override
81      public void onExceptionWithServer(ExecutionContext<HttpClientRequest<I>> context, Throwable exception, ExecutionInfo info) {
82          checkContext(context);
83          checkExecutionInfo(info);
84          numAttemptsOnServer.incrementAndGet();
85          errors.add(exception);
86          exceptionWithServerCounter.incrementAndGet();
87      }
88      @Override
89      public void onExecutionSuccess(ExecutionContext<HttpClientRequest<I>> context, HttpClientResponse<O> response, ExecutionInfo info) {
90          checkContext(context);
91          checkExecutionInfo(info);
92          this.response = response;
93          executionSuccessCounter.incrementAndGet();
94      }
95      @Override
96      public void onExecutionFailed(ExecutionContext<HttpClientRequest<I>> context, Throwable finalException, ExecutionInfo info) {
97          checkContext(context);
98          checkExecutionInfo(info);
99          executionFailedCounter.incrementAndGet();
100          finalThrowable = finalException;
101      }
102      public boolean isContextChecked() {
103          return checkContext;
104      }
105      public boolean isCheckExecutionInfo() {
106          return checkExecutionInfo;
107      }
108      public Throwable getFinalThrowable() {
109          return finalThrowable;
110      }
111      public HttpClientResponse<O> getResponse() {
112          return response;
113      }
114      public ExecutionContext<HttpClientRequest<I>> getContext() {
115          return this.context;
116      }
117      @Override
118      public String toString() {
119          return "TestExecutionListener{" +
120                  "executionStartCounter=" + executionStartCounter +
121                  ", startWithServerCounter=" + startWithServerCounter +
122                  ", exceptionWithServerCounter=" + exceptionWithServerCounter +
123                  ", executionFailedCounter=" + executionFailedCounter +
124                  ", executionSuccessCounter=" + executionSuccessCounter +
125                  ", expectedRequest=" + expectedRequest +
126                  ", requestConfig=" + requestConfig +
127                  ", checkContext=" + checkContext +
128                  ", checkExecutionInfo=" + checkExecutionInfo +
129                  ", finalThrowable=" + finalThrowable +
130                  ", response=" + response +
131                  ", errors=" + errors +
132                  ", numAttemptsOnServer=" + numAttemptsOnServer +
133                  ", numServers=" + numServers +
134                  ", lastServer=" + lastServer +
135                  ", context=" + context +
136                  '}';
137      }
138  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from segmentfault-lessons-MDEwOlJlcG9zaXRvcnk5MzE1NzM4MQ==-flat-RepositoryAnnotationProcessor.java</div>
                <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from ribbon-MDEwOlJlcG9zaXRvcnk3NjE2MTU4-flat-TestExecutionListener.java</div>
                <div class="column column_space"><pre><code>1  package com.segementfalut.deep.in.java.annotation.processing;
2  import javax.annotation.processing.*;
3  import javax.lang.model.SourceVersion;
4  import javax.lang.model.element.Element;
5  import javax.lang.model.element.ElementKind;
6  import javax.lang.model.element.Modifier;
7  import javax.lang.model.element.TypeElement;
8  import javax.lang.model.type.DeclaredType;
9  import javax.lang.model.type.TypeMirror;
10  import javax.lang.model.util.Types;
11  import javax.tools.FileObject;
12  import javax.tools.StandardLocation;
13  import java.io.IOException;
14  import java.io.Writer;
</pre></code></div>
                <div class="column column_space"><pre><code>1  package com.netflix.ribbon.transport.netty.http;
2  import com.netflix.loadbalancer.reactive.ExecutionContext;
3  import com.netflix.loadbalancer.reactive.ExecutionInfo;
4  import com.netflix.loadbalancer.reactive.ExecutionListener;
5  import com.netflix.client.config.IClientConfig;
6  import com.netflix.loadbalancer.Server;
7  import io.netty.buffer.ByteBuf;
8  import io.reactivex.netty.protocol.http.client.HttpClientRequest;
9  import io.reactivex.netty.protocol.http.client.HttpClientResponse;
10  import java.util.List;
11  import java.util.concurrent.CopyOnWriteArrayList;
12  import java.util.concurrent.atomic.AtomicInteger;
13  import static org.junit.Assert.assertEquals;
14  import static org.junit.Assert.assertSame;
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    