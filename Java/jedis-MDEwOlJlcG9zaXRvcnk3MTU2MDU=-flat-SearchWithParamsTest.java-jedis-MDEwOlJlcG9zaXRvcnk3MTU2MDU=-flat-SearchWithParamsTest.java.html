
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 14, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-SearchWithParamsTest.java</h3>
            <pre><code>1  package redis.clients.jedis.modules.search;
2  import static org.junit.Assert.*;
3  import static redis.clients.jedis.util.AssertUtil.assertOK;
4  import java.util.*;
5  import java.util.stream.Collectors;
6  import org.hamcrest.Matchers;
7  import org.junit.BeforeClass;
8  import org.junit.Test;
9  import redis.clients.jedis.GeoCoordinate;
10  import redis.clients.jedis.args.GeoUnit;
11  import redis.clients.jedis.args.SortingOrder;
12  import redis.clients.jedis.exceptions.JedisDataException;
13  import redis.clients.jedis.json.Path;
14  import redis.clients.jedis.search.*;
15  import redis.clients.jedis.search.schemafields.*;
16  import redis.clients.jedis.search.schemafields.VectorField.VectorAlgorithm;
17  import redis.clients.jedis.modules.RedisModuleCommandsTestBase;
18  public class SearchWithParamsTest extends RedisModuleCommandsTestBase {
19    private static final String index = "testindex";
20    @BeforeClass
21    public static void prepare() {
22      RedisModuleCommandsTestBase.prepare();
23    }
24    private void addDocument(String key, Map<String, Object> map) {
25      client.hset(key, RediSearchUtil.toStringMap(map));
26    }
27    private static Map<String, Object> toMap(Object... values) {
28      Map<String, Object> map = new HashMap<>();
29      for (int i = 0; i < values.length; i += 2) {
30        map.put((String) values[i], values[i + 1]);
31      }
32      return map;
33    }
34    private static Map<String, String> toMap(String... values) {
35      Map<String, String> map = new HashMap<>();
36      for (int i = 0; i < values.length; i += 2) {
37        map.put(values[i], values[i + 1]);
38      }
39      return map;
40    }
41    @Test
42    public void create() {
43      assertOK(client.ftCreate(index,
44          FTCreateParams.createParams()
45              .filter("@age>16")
46              .prefix("student:", "pupil:"),
47          TextField.of("first"), TextField.of("last"), NumericField.of("age")));
48      client.hset("profesor:5555", toMap("first", "Albert", "last", "Blue", "age", "55"));
49      client.hset("student:1111", toMap("first", "Joe", "last", "Dod", "age", "18"));
50      client.hset("pupil:2222", toMap("first", "Jen", "last", "Rod", "age", "14"));
51      client.hset("student:3333", toMap("first", "El", "last", "Mark", "age", "17"));
52      client.hset("pupil:4444", toMap("first", "Pat", "last", "Shu", "age", "21"));
53      client.hset("student:5555", toMap("first", "Joen", "last", "Ko", "age", "20"));
54      client.hset("teacher:6666", toMap("first", "Pat", "last", "Rod", "age", "20"));
55      SearchResult noFilters = client.ftSearch(index);
56      assertEquals(4, noFilters.getTotalResults());
57      SearchResult res1 = client.ftSearch(index, "@first:Jo*");
58      assertEquals(2, res1.getTotalResults());
59      SearchResult res2 = client.ftSearch(index, "@first:Pat");
60      assertEquals(1, res2.getTotalResults());
61      SearchResult res3 = client.ftSearch(index, "@last:Rod");
62      assertEquals(0, res3.getTotalResults());
63    }
64    @Test
65    public void createNoParams() {
66      assertOK(client.ftCreate(index,
67          TextField.of("first").weight(1),
68          TextField.of("last").weight(1),
69          NumericField.of("age")));
70      addDocument("student:1111", toMap("first", "Joe", "last", "Dod", "age", 18));
71      addDocument("student:3333", toMap("first", "El", "last", "Mark", "age", 17));
72      addDocument("pupil:4444", toMap("first", "Pat", "last", "Shu", "age", 21));
73      addDocument("student:5555", toMap("first", "Joen", "last", "Ko", "age", 20));
74      SearchResult noFilters = client.ftSearch(index);
75      assertEquals(4, noFilters.getTotalResults());
76      SearchResult res1 = client.ftSearch(index, "@first:Jo*");
77      assertEquals(2, res1.getTotalResults());
78      SearchResult res2 = client.ftSearch(index, "@first:Pat");
79      assertEquals(1, res2.getTotalResults());
80      SearchResult res3 = client.ftSearch(index, "@last:Rod");
81      assertEquals(0, res3.getTotalResults());
82    }
83    @Test
84    public void createWithFieldNames() {
85      assertOK(client.ftCreate(index,
86          FTCreateParams.createParams()
87              .addPrefix("student:").addPrefix("pupil:"),
88          TextField.of("first").as("given"),
89          TextField.of(FieldName.of("last").as("family"))));
90      client.hset("profesor:5555", toMap("first", "Albert", "last", "Blue", "age", "55"));
91      client.hset("student:1111", toMap("first", "Joe", "last", "Dod", "age", "18"));
92      client.hset("pupil:2222", toMap("first", "Jen", "last", "Rod", "age", "14"));
93      client.hset("student:3333", toMap("first", "El", "last", "Mark", "age", "17"));
94      client.hset("pupil:4444", toMap("first", "Pat", "last", "Shu", "age", "21"));
95      client.hset("student:5555", toMap("first", "Joen", "last", "Ko", "age", "20"));
96      client.hset("teacher:6666", toMap("first", "Pat", "last", "Rod", "age", "20"));
97      SearchResult noFilters = client.ftSearch(index);
98      assertEquals(5, noFilters.getTotalResults());
99      SearchResult asFirst = client.ftSearch(index, "@first:Jo*");
100      assertEquals(0, asFirst.getTotalResults());
101      SearchResult asGiven = client.ftSearch(index, "@given:Jo*");
102      assertEquals(2, asGiven.getTotalResults());
103      SearchResult nonLast = client.ftSearch(index, "@last:Rod");
104      assertEquals(0, nonLast.getTotalResults());
105      SearchResult asFamily = client.ftSearch(index, "@family:Rod");
106      assertEquals(1, asFamily.getTotalResults());
107    }
108    @Test
109    public void alterAdd() {
110      assertOK(client.ftCreate(index, TextField.of("title")));
111      Map<String, Object> fields = new HashMap<>();
112      fields.put("title", "hello world");
113      for (int i = 0; i < 100; i++) {
114        addDocument(String.format("doc%d", i), fields);
115      }
116      SearchResult res = client.ftSearch(index, "hello world");
117      assertEquals(100, res.getTotalResults());
118      assertOK(client.ftAlter(index,
119          TagField.of("tags"),
120          TextField.of("name").weight(0.5)));
121      for (int i = 0; i < 100; i++) {
122        Map<String, Object> fields2 = new HashMap<>();
123        fields2.put("name", "name" + i);
124        fields2.put("tags", String.format("tagA,tagB,tag%d", i));
125        addDocument(String.format("doc%d", i), fields2);
126      }
127      SearchResult res2 = client.ftSearch(index, "@tags:{tagA}");
128      assertEquals(100, res2.getTotalResults());
129      Map<String, Object> info = client.ftInfo(index);
130      assertEquals(index, info.get("index_name"));
131      assertEquals("identifier", ((List) ((List) info.get("attributes")).get(1)).get(0));
132      assertEquals("attribute", ((List) ((List) info.get("attributes")).get(1)).get(2));
133    }
134    @Test
135    public void search() {
136      assertOK(client.ftCreate(index, FTCreateParams.createParams(),
137          TextField.of("title"), TextField.of("body")));
138      Map<String, Object> fields = new HashMap<>();
139      fields.put("title", "hello world");
140      fields.put("body", "lorem ipsum");
141      for (int i = 0; i < 100; i++) {
142        addDocument(String.format("doc%d", i), fields);
143      }
144      SearchResult res = client.ftSearch(index, "hello world",
145          FTSearchParams.searchParams().limit(0, 5).withScores());
146      assertEquals(100, res.getTotalResults());
147      assertEquals(5, res.getDocuments().size());
148      for (Document d : res.getDocuments()) {
149        assertTrue(d.getId().startsWith("doc"));
150        assertTrue(d.getScore() < 100);
151      }
152      client.del("doc0");
153      res = client.ftSearch(index, "hello world");
154      assertEquals(99, res.getTotalResults());
155      assertEquals("OK", client.ftDropIndex(index));
156      try {
157        client.ftSearch(index, "hello world");
158        fail();
159      } catch (JedisDataException e) {
160      }
161    }
162    @Test
163    public void numericFilter() {
164      assertOK(client.ftCreate(index, TextField.of("title"), NumericField.of("price")));
165      Map<String, Object> fields = new HashMap<>();
166      fields.put("title", "hello world");
167      for (int i = 0; i < 100; i++) {
168        fields.put("price", i);
169        addDocument(String.format("doc%d", i), fields);
170      }
171      SearchResult res = client.ftSearch(index, "hello world",
172          FTSearchParams.searchParams().filter("price", 0, 49));
173      assertEquals(50, res.getTotalResults());
174      assertEquals(10, res.getDocuments().size());
175      for (Document d : res.getDocuments()) {
176        long price = Long.valueOf((String) d.get("price"));
177        assertTrue(price >= 0);
178        assertTrue(price <= 49);
179      }
180      res = client.ftSearch(index, "hello world",
181          FTSearchParams.searchParams().filter("price", 0, true, 49, true));
182      assertEquals(48, res.getTotalResults());
183      assertEquals(10, res.getDocuments().size());
184      for (Document d : res.getDocuments()) {
185        long price = Long.valueOf((String) d.get("price"));
186        assertTrue(price > 0);
187        assertTrue(price < 49);
188      }
189      res = client.ftSearch(index, "hello world",
190          FTSearchParams.searchParams().filter("price", 50, 100));
191      assertEquals(50, res.getTotalResults());
192      assertEquals(10, res.getDocuments().size());
193      for (Document d : res.getDocuments()) {
194        long price = Long.valueOf((String) d.get("price"));
195        assertTrue(price >= 50);
196        assertTrue(price <= 100);
197      }
198      res = client.ftSearch(index, "hello world",
199          FTSearchParams.searchParams()
200              .filter("price", 20, Double.POSITIVE_INFINITY));
201      assertEquals(80, res.getTotalResults());
202      assertEquals(10, res.getDocuments().size());
203      res = client.ftSearch(index, "hello world",
204          FTSearchParams.searchParams()
205              .filter("price", Double.NEGATIVE_INFINITY, 10));
206      assertEquals(11, res.getTotalResults());
207      assertEquals(10, res.getDocuments().size());
208    }
209    @Test
210    public void stopwords() {
211      assertOK(client.ftCreate(index,
212          FTCreateParams.createParams()
213              .stopwords("foo", "bar", "baz"),
214          TextField.of("title")));
215      Map<String, Object> fields = new HashMap<>();
216      fields.put("title", "hello world foo bar");
217      addDocument("doc1", fields);
218      SearchResult res = client.ftSearch(index, "hello world");
219      assertEquals(1, res.getTotalResults());
220      res = client.ftSearch(index, "foo bar");
221      assertEquals(0, res.getTotalResults());
222    }
223    @Test
224    public void noStopwords() {
225      assertOK(client.ftCreate(index,
226          FTCreateParams.createParams().noStopwords(),
227          TextField.of("title")));
228      Map<String, Object> fields = new HashMap<>();
229      fields.put("title", "hello world foo bar");
230      fields.put("title", "hello world foo bar to be or not to be");
231      addDocument("doc1", fields);
232      assertEquals(1, client.ftSearch(index, "hello world").getTotalResults());
233      assertEquals(1, client.ftSearch(index, "foo bar").getTotalResults());
234      assertEquals(1, client.ftSearch(index, "to be or not to be").getTotalResults());
235    }
236    @Test
237    public void geoFilter() {
238      assertOK(client.ftCreate(index, TextField.of("title"), GeoField.of("loc")));
239      Map<String, Object> fields = new HashMap<>();
240      fields.put("title", "hello world");
241      fields.put("loc", "-0.441,51.458");
242      addDocument("doc1", fields);
243      fields.put("loc", "-0.1,51.2");
244      addDocument("doc2", fields);
245      SearchResult res = client.ftSearch(index, "hello world",
246          FTSearchParams.searchParams().
247              geoFilter("loc", -0.44, 51.45, 10, GeoUnit.KM));
248      assertEquals(1, res.getTotalResults());
249      res = client.ftSearch(index, "hello world",
250          FTSearchParams.searchParams().
251              geoFilter("loc", -0.44, 51.45, 100, GeoUnit.KM));
252      assertEquals(2, res.getTotalResults());
253    }
254    @Test
255    public void geoFilterAndGeoCoordinateObject() {
256      assertOK(client.ftCreate(index, TextField.of("title"), GeoField.of("loc")));
257      Map<String, Object> fields = new HashMap<>();
258      fields.put("title", "hello world");
259      fields.put("loc", new GeoCoordinate(-0.441, 51.458));
260      addDocument("doc1", fields);
261      fields.put("loc", new GeoCoordinate(-0.1, 51.2));
262      addDocument("doc2", fields);
263      SearchResult res = client.ftSearch(index, "hello world",
264          FTSearchParams.searchParams()
265              .geoFilter(new FTSearchParams.GeoFilter("loc", -0.44, 51.45, 10, GeoUnit.KM)));
266      assertEquals(1, res.getTotalResults());
267      res = client.ftSearch(index, "hello world",
268          FTSearchParams.searchParams()
269              .geoFilter(new FTSearchParams.GeoFilter("loc", -0.44, 51.45, 100, GeoUnit.KM)));
270      assertEquals(2, res.getTotalResults());
271    }
272    @Test
273    public void testQueryFlags() {
274      assertOK(client.ftCreate(index, TextField.of("title")));
275      Map<String, Object> fields = new HashMap<>();
276      for (int i = 0; i < 100; i++) {
277        fields.put("title", i % 2 != 0 ? "hello worlds" : "hello world");
278        addDocument(String.format("doc%d", i), fields);
279      }
280      SearchResult res = client.ftSearch(index, "hello",
281          FTSearchParams.searchParams().withScores());
282      assertEquals(100, res.getTotalResults());
283      assertEquals(10, res.getDocuments().size());
284      for (Document d : res.getDocuments()) {
285        assertTrue(d.getId().startsWith("doc"));
286        assertTrue(((String) d.get("title")).startsWith("hello world"));
287      }
288      res = client.ftSearch(index, "hello",
289          FTSearchParams.searchParams().noContent());
290      for (Document d : res.getDocuments()) {
291        assertTrue(d.getId().startsWith("doc"));
292        assertEquals(1.0, d.getScore(), 0);
293        assertNull(d.get("title"));
294      }
295      res = client.ftSearch(index, "hello worlds");
296      assertEquals(100, res.getTotalResults());
297      res = client.ftSearch(index, "hello worlds", FTSearchParams.searchParams().verbatim());
298      assertEquals(50, res.getTotalResults());
299      res = client.ftSearch(index, "hello a world", FTSearchParams.searchParams().verbatim());
300      assertEquals(50, res.getTotalResults());
301      res = client.ftSearch(index, "hello a worlds", FTSearchParams.searchParams().verbatim());
302      assertEquals(50, res.getTotalResults());
303      res = client.ftSearch(index, "hello a world", FTSearchParams.searchParams().verbatim().noStopwords());
304      assertEquals(0, res.getTotalResults());
305    }
306    @Test
307    public void testQueryParams() {
308      assertOK(client.ftCreate(index, NumericField.of("numval")));
309      client.hset("1", "numval", "1");
310      client.hset("2", "numval", "2");
311      client.hset("3", "numval", "3");
312      assertEquals(2, client.ftSearch(index, "@numval:[$min $max]",
313          FTSearchParams.searchParams().addParam("min", 1).addParam("max", 2)
314              .dialect(2)).getTotalResults());
315      Map<String, Object> paramValues = new HashMap<>();
316      paramValues.put("min", 1);
317      paramValues.put("max", 2);
318      assertEquals(2, client.ftSearch(index, "@numval:[$min $max]",
319          FTSearchParams.searchParams().params(paramValues)
320              .dialect(2)).getTotalResults());
321    }
322    @Test
323    public void testSortQueryFlags() {
324      assertOK(client.ftCreate(index, TextField.of("title").sortable()));
325      Map<String, Object> fields = new HashMap<>();
326      fields.put("title", "b title");
327      addDocument("doc1", fields);
328      fields.put("title", "a title");
329      addDocument("doc2", fields);
330      fields.put("title", "c title");
331      addDocument("doc3", fields);
332      SearchResult res = client.ftSearch(index, "title",
333          FTSearchParams.searchParams().sortBy("title", SortingOrder.ASC));
334      assertEquals(3, res.getTotalResults());
<span onclick='openModal()' class='match'>335      Document doc1 = res.getDocuments().get(0);
336      assertEquals("a title", doc1.get("title"));
</span>337      doc1 = res.getDocuments().get(1);
338      assertEquals("b title", doc1.get("title"));
339      doc1 = res.getDocuments().get(2);
340      assertEquals("c title", doc1.get("title"));
341    }
342    @Test
343    public void testJsonWithAlias() {
344      assertOK(client.ftCreate(index,
345          FTCreateParams.createParams()
346              .on(IndexDataType.JSON)
347              .prefix("king:"),
348          TextField.of("$.name").as("name"),
349          NumericField.of("$.num").as("num")));
350      Map<String, Object> king1 = new HashMap<>();
351      king1.put("name", "henry");
352      king1.put("num", 42);
353      client.jsonSet("king:1", Path.ROOT_PATH, king1);
354      Map<String, Object> king2 = new HashMap<>();
355      king2.put("name", "james");
356      king2.put("num", 3.14);
357      client.jsonSet("king:2", Path.ROOT_PATH, king2);
358      SearchResult res = client.ftSearch(index, "@name:henry");
359      assertEquals(1, res.getTotalResults());
360      assertEquals("king:1", res.getDocuments().get(0).getId());
361      res = client.ftSearch(index, "@num:[0 10]");
362      assertEquals(1, res.getTotalResults());
363      assertEquals("king:2", res.getDocuments().get(0).getId());
364    }
365    @Test
366    public void dropIndex() {
367      assertOK(client.ftCreate(index, TextField.of("title")));
368      Map<String, Object> fields = new HashMap<>();
369      fields.put("title", "hello world");
370      for (int i = 0; i < 100; i++) {
371        addDocument(String.format("doc%d", i), fields);
372      }
373      SearchResult res = client.ftSearch(index, "hello world");
374      assertEquals(100, res.getTotalResults());
375      assertEquals("OK", client.ftDropIndex(index));
376      try {
377        client.ftSearch(index, "hello world");
378        fail("Index should not exist.");
379      } catch (JedisDataException de) {
380        assertTrue(de.getMessage().contains("no such index"));
381      }
382      assertEquals(100, client.dbSize());
383    }
384    @Test
385    public void dropIndexDD() {
386      assertOK(client.ftCreate(index, TextField.of("title")));
387      Map<String, Object> fields = new HashMap<>();
388      fields.put("title", "hello world");
389      for (int i = 0; i < 100; i++) {
390        addDocument(String.format("doc%d", i), fields);
391      }
392      SearchResult res = client.ftSearch(index, "hello world");
393      assertEquals(100, res.getTotalResults());
394      assertEquals("OK", client.ftDropIndexDD(index));
395      Set<String> keys = client.keys("*");
396      assertTrue(keys.isEmpty());
397      assertEquals(0, client.dbSize());
398    }
399    @Test
400    public void noStem() {
401      assertOK(client.ftCreate(index, new TextField("stemmed").weight(1.0),
402          new TextField("notStemmed").weight(1.0).noStem()));
403      Map<String, Object> doc = new HashMap<>();
404      doc.put("stemmed", "located");
405      doc.put("notStemmed", "located");
406      addDocument("doc", doc);
407      SearchResult res = client.ftSearch(index, "@stemmed:location");
408      assertEquals(1, res.getTotalResults());
409      res = client.ftSearch(index, "@notStemmed:location");
410      assertEquals(0, res.getTotalResults());
411    }
412    @Test
413    public void phoneticMatch() {
414      assertOK(client.ftCreate(index, new TextField("noPhonetic").weight(1.0),
415          new TextField("withPhonetic").weight(1.0).phonetic("dm:en")));
416      Map<String, Object> doc = new HashMap<>();
417      doc.put("noPhonetic", "morfix");
418      doc.put("withPhonetic", "morfix");
419      addDocument("doc", doc);
420      SearchResult res = client.ftSearch(index, "@withPhonetic:morphix=>{$phonetic:true}");
421      assertEquals(1, res.getTotalResults());
422      try {
423        client.ftSearch(index, "@noPhonetic:morphix=>{$phonetic:true}");
424        fail();
425      } catch (JedisDataException e) {&bsol;*field does not support phonetics*/
426      }
427      SearchResult res3 = client.ftSearch(index, "@withPhonetic:morphix=>{$phonetic:false}");
428      assertEquals(0, res3.getTotalResults());
429    }
430    @Test
431    public void info() {
432      Collection<SchemaField> sc = new ArrayList<>();
433      sc.add(TextField.of("title").weight(5));
434      sc.add(TextField.of("plot").sortable());
435      sc.add(TagField.of("genre").separator(',').sortable());
436      sc.add(NumericField.of("release_year").sortable());
437      sc.add(NumericField.of("rating").sortable());
438      sc.add(NumericField.of("votes").sortable());
439      assertOK(client.ftCreate(index, sc));
440      Map<String, Object> info = client.ftInfo(index);
441      assertEquals(index, info.get("index_name"));
442      assertEquals(6, ((List) info.get("attributes")).size());
443      assertEquals("global_idle", ((List) info.get("cursor_stats")).get(0));
444      assertEquals(0L, ((List) info.get("cursor_stats")).get(1));
445    }
446    @Test
447    public void noIndexAndSortBy() {
448      assertOK(client.ftCreate(index, TextField.of("f1").sortable().noIndex(), TextField.of("f2")));
449      Map<String, Object> mm = new HashMap<>();
450      mm.put("f1", "MarkZZ");
451      mm.put("f2", "MarkZZ");
452      addDocument("doc1", mm);
453      mm.clear();
454      mm.put("f1", "MarkAA");
455      mm.put("f2", "MarkBB");
456      addDocument("doc2", mm);
457      SearchResult res = client.ftSearch(index, "@f1:Mark*");
458      assertEquals(0, res.getTotalResults());
459      res = client.ftSearch(index, "@f2:Mark*");
460      assertEquals(2, res.getTotalResults());
461      res = client.ftSearch(index, "@f2:Mark*",
462          FTSearchParams.searchParams().sortBy("f1", SortingOrder.DESC));
463      assertEquals(2, res.getTotalResults());
464      assertEquals("doc1", res.getDocuments().get(0).getId());
465      res = client.ftSearch(index, "@f2:Mark*",
466          FTSearchParams.searchParams().sortBy("f1", SortingOrder.ASC));
467      assertEquals("doc2", res.getDocuments().get(0).getId());
468    }
469    @Test
470    public void testHighlightSummarize() {
471      assertOK(client.ftCreate(index, TextField.of("text").weight(1)));
472      Map<String, Object> doc = new HashMap<>();
473      doc.put("text", "Redis is often referred as a data structures server. What this means is that "
474          + "Redis provides access to mutable data structures via a set of commands, which are sent "
475          + "using a server-client model with TCP sockets and a simple protocol. So different "
476          + "processes can query and modify the same data structures in a shared way");
477      addDocument("foo", doc);
478      SearchResult res = client.ftSearch(index, "data", FTSearchParams.searchParams().highlight().summarize());
479      assertEquals("is often referred as a <b>data</b> structures server. What this means is that "
480          + "Redis provides... What this means is that Redis provides access to mutable <b>data</b> "
481          + "structures via a set of commands, which are sent using a... So different processes can "
482          + "query and modify the same <b>data</b> structures in a shared... ",
483          res.getDocuments().get(0).get("text"));
484      res = client.ftSearch(index, "data", FTSearchParams.searchParams()
485          .highlight(FTSearchParams.highlightParams().tags("<u>", "</u>"))
486          .summarize());
487      assertEquals("is often referred as a <u>data</u> structures server. What this means is that "
488          + "Redis provides... What this means is that Redis provides access to mutable <u>data</u> "
489          + "structures via a set of commands, which are sent using a... So different processes can "
490          + "query and modify the same <u>data</u> structures in a shared... ",
491          res.getDocuments().get(0).get("text"));
492    }
493    @Test
494    public void getTagField() {
495      assertOK(client.ftCreate(index, TextField.of("title"), TagField.of("category")));
496      Map<String, Object> fields1 = new HashMap<>();
497      fields1.put("title", "hello world");
498      fields1.put("category", "red");
499      addDocument("foo", fields1);
500      Map<String, Object> fields2 = new HashMap<>();
501      fields2.put("title", "hello world");
502      fields2.put("category", "blue");
503      addDocument("bar", fields2);
504      Map<String, Object> fields3 = new HashMap<>();
505      fields3.put("title", "hello world");
506      fields3.put("category", "green,yellow");
507      addDocument("baz", fields3);
508      Map<String, Object> fields4 = new HashMap<>();
509      fields4.put("title", "hello world");
510      fields4.put("category", "orange;purple");
511      addDocument("qux", fields4);
512      assertEquals(1, client.ftSearch(index, "@category:{red}").getTotalResults());
513      assertEquals(1, client.ftSearch(index, "@category:{blue}").getTotalResults());
514      assertEquals(1, client.ftSearch(index, "hello @category:{red}").getTotalResults());
515      assertEquals(1, client.ftSearch(index, "hello @category:{blue}").getTotalResults());
516      assertEquals(1, client.ftSearch(index, "@category:{yellow}").getTotalResults());
517      assertEquals(0, client.ftSearch(index, "@category:{purple}").getTotalResults());
518      assertEquals(1, client.ftSearch(index, "@category:{orange\\;purple}").getTotalResults());
519      assertEquals(4, client.ftSearch(index, "hello").getTotalResults());
520      assertEquals(new HashSet<>(Arrays.asList("red", "blue", "green", "yellow", "orange;purple")),
521          client.ftTagVals(index, "category"));
522    }
523    @Test
524    public void testGetTagFieldWithNonDefaultSeparator() {
525      assertOK(client.ftCreate(index,
526          TextField.of("title"),
527          TagField.of("category").separator(';')));
528      Map<String, Object> fields1 = new HashMap<>();
529      fields1.put("title", "hello world");
530      fields1.put("category", "red");
531      addDocument("foo", fields1);
532      Map<String, Object> fields2 = new HashMap<>();
533      fields2.put("title", "hello world");
534      fields2.put("category", "blue");
535      addDocument("bar", fields2);
536      Map<String, Object> fields3 = new HashMap<>();
537      fields3.put("title", "hello world");
538      fields3.put("category", "green;yellow");
539      addDocument("baz", fields3);
540      Map<String, Object> fields4 = new HashMap<>();
541      fields4.put("title", "hello world");
542      fields4.put("category", "orange,purple");
543      addDocument("qux", fields4);
544      assertEquals(1, client.ftSearch(index, "@category:{red}").getTotalResults());
545      assertEquals(1, client.ftSearch(index, "@category:{blue}").getTotalResults());
546      assertEquals(1, client.ftSearch(index, "hello @category:{red}").getTotalResults());
547      assertEquals(1, client.ftSearch(index, "hello @category:{blue}").getTotalResults());
548      assertEquals(1, client.ftSearch(index, "hello @category:{yellow}").getTotalResults());
549      assertEquals(0, client.ftSearch(index, "@category:{purple}").getTotalResults());
550      assertEquals(1, client.ftSearch(index, "@category:{orange\\,purple}").getTotalResults());
551      assertEquals(4, client.ftSearch(index, "hello").getTotalResults());
552      assertEquals(new HashSet<>(Arrays.asList("red", "blue", "green", "yellow", "orange,purple")),
553          client.ftTagVals(index, "category"));
554    }
555    @Test
556    public void caseSensitiveTagField() {
557      assertOK(client.ftCreate(index,
558          TextField.of("title"),
559          TagField.of("category").caseSensitive()));
560      Map<String, Object> fields = new HashMap<>();
561      fields.put("title", "hello world");
562      fields.put("category", "RedX");
563      addDocument("foo", fields);
564      assertEquals(0, client.ftSearch(index, "@category:{redx}").getTotalResults());
565      assertEquals(0, client.ftSearch(index, "@category:{redX}").getTotalResults());
566      assertEquals(0, client.ftSearch(index, "@category:{Redx}").getTotalResults());
567      assertEquals(1, client.ftSearch(index, "@category:{RedX}").getTotalResults());
568      assertEquals(1, client.ftSearch(index, "hello").getTotalResults());
569    }
570    @Test
571    public void testReturnFields() {
572      assertOK(client.ftCreate(index, TextField.of("field1"), TextField.of("field2")));
573      Map<String, Object> doc = new HashMap<>();
574      doc.put("field1", "value1");
575      doc.put("field2", "value2");
576      addDocument("doc", doc);
577      SearchResult res = client.ftSearch(index, "*",
578          FTSearchParams.searchParams().returnFields("field1"));
579      assertEquals(1, res.getTotalResults());
580      Document ret = res.getDocuments().get(0);
581      assertEquals("value1", ret.get("field1"));
582      assertNull(ret.get("field2"));
583    }
584    @Test
585    public void returnWithFieldNames() {
586      assertOK(client.ftCreate(index, TextField.of("a"), TextField.of("b"), TextField.of("c")));
587      Map<String, Object> map = new HashMap<>();
588      map.put("a", "value1");
589      map.put("b", "value2");
590      map.put("c", "value3");
591      addDocument("doc", map);
592      SearchResult res = client.ftSearch(index, "*",
593          FTSearchParams.searchParams().returnFields(
594              FieldName.of("a"), FieldName.of("b").as("d")));
595      assertEquals(1, res.getTotalResults());
596      Document doc = res.getDocuments().get(0);
597      assertEquals("value1", doc.get("a"));
598      assertNull(doc.get("b"));
599      assertEquals("value2", doc.get("d"));
600      assertNull(doc.get("c"));
601    }
602    @Test
603    public void inKeys() {
604      assertOK(client.ftCreate(index, TextField.of("field1"), TextField.of("field2")));
605      Map<String, Object> doc = new HashMap<>();
606      doc.put("field1", "value");
607      doc.put("field2", "not");
608      addDocument("doc1", doc);
609      addDocument("doc2", doc);
610      SearchResult res = client.ftSearch(index, "value",
611          FTSearchParams.searchParams().inKeys("doc1"));
612      assertEquals(1, res.getTotalResults());
613      assertEquals("doc1", res.getDocuments().get(0).getId());
614      assertEquals("value", res.getDocuments().get(0).get("field1"));
615      assertEquals(null, res.getDocuments().get(0).get("value"));
616    }
617    @Test
618    public void alias() {
619      assertOK(client.ftCreate(index, TextField.of("field1")));
620      Map<String, Object> doc = new HashMap<>();
621      doc.put("field1", "value");
622      addDocument("doc1", doc);
623      assertEquals("OK", client.ftAliasAdd("ALIAS1", index));
624      SearchResult res1 = client.ftSearch("ALIAS1", "*",
625          FTSearchParams.searchParams().returnFields("field1"));
626      assertEquals(1, res1.getTotalResults());
627      assertEquals("value", res1.getDocuments().get(0).get("field1"));
628      assertEquals("OK", client.ftAliasUpdate("ALIAS2", index));
629      SearchResult res2 = client.ftSearch("ALIAS2", "*",
630          FTSearchParams.searchParams().returnFields("field1"));
631      assertEquals(1, res2.getTotalResults());
632      assertEquals("value", res2.getDocuments().get(0).get("field1"));
633      try {
634        client.ftAliasDel("ALIAS3");
635        fail("Should throw JedisDataException");
636      } catch (JedisDataException e) {
637      }
638      assertEquals("OK", client.ftAliasDel("ALIAS2"));
639      try {
640        client.ftAliasDel("ALIAS2");
641        fail("Should throw JedisDataException");
642      } catch (JedisDataException e) {
643      }
644    }
645    @Test
646    public void synonym() {
647      assertOK(client.ftCreate(index, TextField.of("name").weight(1), TextField.of("addr").weight(1)));
648      long group1 = 345L;
649      long group2 = 789L;
650      String group1_str = Long.toString(group1);
651      String group2_str = Long.toString(group2);
652      assertEquals("OK", client.ftSynUpdate(index, group1_str, "girl", "baby"));
653      assertEquals("OK", client.ftSynUpdate(index, group1_str, "child"));
654      assertEquals("OK", client.ftSynUpdate(index, group2_str, "child"));
655      Map<String, List<String>> dump = client.ftSynDump(index);
656      Map<String, List<String>> expected = new HashMap<>();
657      expected.put("girl", Arrays.asList(group1_str));
658      expected.put("baby", Arrays.asList(group1_str));
659      expected.put("child", Arrays.asList(group1_str, group2_str));
660      assertEquals(expected, dump);
661    }
662    @Test
663    public void slop() {
664      assertOK(client.ftCreate(index, TextField.of("field1"), TextField.of("field2")));
665      Map<String, Object> doc = new HashMap<>();
666      doc.put("field1", "ok hi jedis");
667      addDocument("doc1", doc);
668      SearchResult res = client.ftSearch(index, "ok jedis", FTSearchParams.searchParams().slop(0));
669      assertEquals(0, res.getTotalResults());
670      res = client.ftSearch(index, "ok jedis", FTSearchParams.searchParams().slop(1));
671      assertEquals(1, res.getTotalResults());
672      assertEquals("doc1", res.getDocuments().get(0).getId());
673      assertEquals("ok hi jedis", res.getDocuments().get(0).get("field1"));
674    }
675    @Test
676    public void timeout() {
677      assertOK(client.ftCreate(index, TextField.of("field1"), TextField.of("field2")));
678      Map<String, String> map = new HashMap<>();
679      map.put("field1", "value");
680      map.put("field2", "not");
681      client.hset("doc1", map);
682      SearchResult res = client.ftSearch(index, "value", FTSearchParams.searchParams().timeout(1000));
683      assertEquals(1, res.getTotalResults());
684      assertEquals("doc1", res.getDocuments().get(0).getId());
685      assertEquals("value", res.getDocuments().get(0).get("field1"));
686      assertEquals("not", res.getDocuments().get(0).get("field2"));
687    }
688    @Test
689    public void inOrder() {
690      assertOK(client.ftCreate(index, TextField.of("field1"), TextField.of("field2")));
691      Map<String, String> map = new HashMap<>();
692      map.put("field1", "value");
693      map.put("field2", "not");
694      client.hset("doc2", map);
695      client.hset("doc1", map);
696      SearchResult res = client.ftSearch(index, "value", FTSearchParams.searchParams().inOrder());
697      assertEquals(2, res.getTotalResults());
698      assertEquals("doc2", res.getDocuments().get(0).getId());
699      assertEquals("value", res.getDocuments().get(0).get("field1"));
700      assertEquals("not", res.getDocuments().get(0).get("field2"));
701    }
702    @Test
703    public void testHNSWVVectorSimilarity() {
704      Map<String, Object> attr = new HashMap<>();
705      attr.put("TYPE", "FLOAT32");
706      attr.put("DIM", 2);
707      attr.put("DISTANCE_METRIC", "L2");
708      assertOK(client.ftCreate(index, VectorField.builder().fieldName("v")
709          .algorithm(VectorField.VectorAlgorithm.HNSW).attributes(attr).build()));
710      client.hset("a", "v", "aaaaaaaa");
711      client.hset("b", "v", "aaaabaaa");
712      client.hset("c", "v", "aaaaabaa");
713      FTSearchParams searchParams = FTSearchParams.searchParams()
714          .addParam("vec", "aaaaaaaa")
715          .sortBy("__v_score", SortingOrder.ASC)
716          .returnFields("__v_score")
717          .dialect(2);
718      Document doc1 = client.ftSearch(index, "*=>[KNN 2 @v $vec]", searchParams).getDocuments().get(0);
719      assertEquals("a", doc1.getId());
720      assertEquals("0", doc1.get("__v_score"));
721    }
722    @Test
723    public void testFlatVectorSimilarity() {
724      assertOK(client.ftCreate(index,
725          VectorField.builder().fieldName("v")
726              .algorithm(VectorField.VectorAlgorithm.FLAT)
727              .addAttribute("TYPE", "FLOAT32")
728              .addAttribute("DIM", 2)
729              .addAttribute("DISTANCE_METRIC", "L2")
730              .build()
731      ));
732      client.hset("a", "v", "aaaaaaaa");
733      client.hset("b", "v", "aaaabaaa");
734      client.hset("c", "v", "aaaaabaa");
735      FTSearchParams searchParams = FTSearchParams.searchParams()
736          .addParam("vec", "aaaaaaaa")
737          .sortBy("__v_score", SortingOrder.ASC)
738          .returnFields("__v_score")
739          .dialect(2);
740      Document doc1 = client.ftSearch(index, "*=>[KNN 2 @v $vec]", searchParams).getDocuments().get(0);
741      assertEquals("a", doc1.getId());
742      assertEquals("0", doc1.get("__v_score"));
743    }
744    @Test
745    public void searchProfile() {
746      assertOK(client.ftCreate(index, TextField.of("t1"), TextField.of("t2")));
747      Map<String, String> map = new HashMap<>();
748      map.put("t1", "foo");
749      map.put("t2", "bar");
750      client.hset("doc1", map);
751      Map.Entry<SearchResult, Map<String, Object>> profile = client.ftProfileSearch(index,
752          FTProfileParams.profileParams(), "foo", FTSearchParams.searchParams());
753      Map<String, Object> iteratorsProfile = (Map<String, Object>) profile.getValue().get("Iterators profile");
754      assertEquals("TEXT", iteratorsProfile.get("Type"));
755      assertEquals("foo", iteratorsProfile.get("Term"));
756      assertEquals(1L, iteratorsProfile.get("Counter"));
757      assertEquals(1L, iteratorsProfile.get("Size"));
758      assertSame(Double.class, iteratorsProfile.get("Time").getClass());
759    }
760    @Test
761    public void vectorSearchProfile() {
762      assertOK(client.ftCreate(index, VectorField.builder().fieldName("v")
763          .algorithm(VectorAlgorithm.FLAT).addAttribute("TYPE", "FLOAT32")
764          .addAttribute("DIM", 2).addAttribute("DISTANCE_METRIC", "L2").build(),
765          TextField.of("t")));
766      client.hset("1", toMap("v", "bababaca", "t", "hello"));
767      client.hset("2", toMap("v", "babababa", "t", "hello"));
768      client.hset("3", toMap("v", "aabbaabb", "t", "hello"));
769      client.hset("4", toMap("v", "bbaabbaa", "t", "hello world"));
770      client.hset("5", toMap("v", "aaaabbbb", "t", "hello world"));
771      FTSearchParams searchParams = FTSearchParams.searchParams().addParam("vec", "aaaaaaaa")
772          .sortBy("__v_score", SortingOrder.ASC).noContent().dialect(2);
773      Map.Entry<SearchResult, Map<String, Object>> profile = client.ftProfileSearch(index,
774          FTProfileParams.profileParams(), "*=>[KNN 3 @v $vec]", searchParams);
775      assertEquals(3, profile.getKey().getTotalResults());
776      assertEquals(Arrays.asList(4, 2, 1).toString(), profile.getKey().getDocuments()
777          .stream().map(Document::getId).collect(Collectors.toList()).toString());
778      Map<String, Object> iteratorsProfile = (Map<String, Object>) profile.getValue().get("Iterators profile");
779      assertEquals("VECTOR", iteratorsProfile.get("Type"));
780      assertEquals(3L, iteratorsProfile.get("Counter"));
781      List<Map<String, Object>> resultProcessorsProfile = (List<Map<String, Object>>) profile.getValue().get("Result processors profile");
782      assertEquals(3l, resultProcessorsProfile.get(1).get("Counter"));
783    }
784    @Test
785    public void maxPrefixExpansionSearchProfile() {
786      final String configParam = "MAXPREFIXEXPANSIONS";
787      String configValue = client.ftConfigGet(configParam).get(configParam);
788      client.ftConfigSet(configParam, "2");
789      assertOK(client.ftCreate(index, TextField.of("t")));
790      client.hset("1", Collections.singletonMap("t", "foo1"));
791      client.hset("2", Collections.singletonMap("t", "foo2"));
792      client.hset("3", Collections.singletonMap("t", "foo3"));
793      Map.Entry<SearchResult, Map<String, Object>> profile = client.ftProfileSearch(index,
794          FTProfileParams.profileParams(), "foo*", FTSearchParams.searchParams().limit(0, 0));
795      Map<String, Object> iteratorsProfile = (Map<String, Object>) profile.getValue().get("Iterators profile");
796      assertEquals("Max prefix expansion reached", iteratorsProfile.get("Warning"));
797      client.ftConfigSet(configParam, configValue);
798    }
799    @Test
800    public void notIteratorSearchProfile() {
801      assertOK(client.ftCreate(index, TextField.of("t")));
802      client.hset("1", Collections.singletonMap("t", "foo"));
803      client.hset("2", Collections.singletonMap("t", "bar"));
804      Map.Entry<SearchResult, Map<String, Object>> profile = client.ftProfileSearch(index,
805          FTProfileParams.profileParams(), "foo -@t:baz", FTSearchParams.searchParams().noContent());
806      Map<String, Object> depth0 = (Map<String, Object>) profile.getValue().get("Iterators profile");
807      assertEquals("INTERSECT", depth0.get("Type"));
808      List<Map<String, Object>> depth0_children = (List<Map<String, Object>>) depth0.get("Child iterators");
809      assertEquals("TEXT", depth0_children.get(0).get("Type"));
810      Map<String, Object> depth1 = depth0_children.get(1);
811      assertEquals("NOT", depth1.get("Type"));
812      List<Map<String, Object>> depth1_children = (List<Map<String, Object>>) depth1.get("Child iterators");
813      assertEquals(1, depth1_children.size());
814      assertEquals("EMPTY", depth1_children.get(0).get("Type"));
815    }
816    @Test
817    public void deepReplySearchProfile() {
818      assertOK(client.ftCreate(index, TextField.of("t")));
819      client.hset("1", Collections.singletonMap("t", "hello"));
820      client.hset("2", Collections.singletonMap("t", "world"));
821      Map.Entry<SearchResult, Map<String, Object>> profile
822          = client.ftProfileSearch(index, FTProfileParams.profileParams(),
823              "hello(hello(hello(hello(hello(hello)))))", FTSearchParams.searchParams().noContent());
824      Map<String, Object> depth0 = (Map<String, Object>) profile.getValue().get("Iterators profile");
825      assertEquals("INTERSECT", depth0.get("Type"));
826      List<Map<String, Object>> depth0_children = (List<Map<String, Object>>) depth0.get("Child iterators");
827      assertEquals("TEXT", depth0_children.get(0).get("Type"));
828      Map<String, Object> depth1 = depth0_children.get(1);
829      assertEquals("INTERSECT", depth1.get("Type"));
830      List<Map<String, Object>> depth1_children = (List<Map<String, Object>>) depth1.get("Child iterators");
831      assertEquals("TEXT", depth1_children.get(0).get("Type"));
832      Map<String, Object> depth2 = depth1_children.get(1);
833      assertEquals("INTERSECT", depth2.get("Type"));
834      List<Map<String, Object>> depth2_children = (List<Map<String, Object>>) depth2.get("Child iterators");
835      assertEquals("TEXT", depth2_children.get(0).get("Type"));
836      Map<String, Object> depth3 = depth2_children.get(1);
837      assertEquals("INTERSECT", depth3.get("Type"));
838      List<Map<String, Object>> depth3_children = (List<Map<String, Object>>) depth3.get("Child iterators");
839      assertEquals("TEXT", depth3_children.get(0).get("Type"));
840      Map<String, Object> depth4 = depth3_children.get(1);
841      assertEquals("INTERSECT", depth4.get("Type"));
842      List<Map<String, Object>> depth4_children = (List<Map<String, Object>>) depth4.get("Child iterators");
843      assertEquals("TEXT", depth4_children.get(0).get("Type"));
844      Map<String, Object> depth5 = depth4_children.get(1);
845      assertEquals("TEXT", depth5.get("Type"));
846      assertNull(depth5.get("Child iterators"));
847    }
848    @Test
849    public void limitedSearchProfile() {
850      assertOK(client.ftCreate(index, TextField.of("t")));
851      client.hset("1", Collections.singletonMap("t", "hello"));
852      client.hset("2", Collections.singletonMap("t", "hell"));
853      client.hset("3", Collections.singletonMap("t", "help"));
854      client.hset("4", Collections.singletonMap("t", "helowa"));
855      Map.Entry<SearchResult, Map<String, Object>> profile = client.ftProfileSearch(index,
856          FTProfileParams.profileParams().limited(), "%hell% hel*", FTSearchParams.searchParams().noContent());
857      Map<String, Object> depth0 = (Map<String, Object>) profile.getValue().get("Iterators profile");
858      assertEquals("INTERSECT", depth0.get("Type"));
859      assertEquals(3L, depth0.get("Counter"));
860      List<Map<String, Object>> depth0_children = (List<Map<String, Object>>) depth0.get("Child iterators");
861      assertFalse(depth0_children.isEmpty());
862      for (Map<String, Object> depth1 : depth0_children) {
863        assertEquals("UNION", depth1.get("Type"));
864        assertNotNull(depth1.get("Query type"));
865        List depth1_children = (List) depth1.get("Child iterators");
866        assertEquals(1, depth1_children.size());
867        assertSame(String.class, depth1_children.get(0).getClass());
868      }
869    }
870    @Test
871    public void list() {
872      assertEquals(Collections.emptyList(), client.ftList());
873      final int count = 20;
874      Set<String> names = new HashSet<>();
875      for (int i = 0; i < count; i++) {
876        final String name = "idx" + i;
877        assertOK(client.ftCreate(name, TextField.of("t" + i)));
878        names.add(name);
879      }
880      assertEquals(names, new HashSet<>(client.ftList()));
881    }
882    @Test
883    public void broadcast() {
884      String reply = client.ftCreate(index, TextField.of("t"));
885      assertOK(reply);
886    }
887    @Test
888    public void searchIteration() {
889      assertOK(client.ftCreate(index, FTCreateParams.createParams(),
890          TextField.of("first"), TextField.of("last"), NumericField.of("age")));
891      client.hset("profesor:5555", toMap("first", "Albert", "last", "Blue", "age", "55"));
892      client.hset("student:1111", toMap("first", "Joe", "last", "Dod", "age", "18"));
893      client.hset("pupil:2222", toMap("first", "Jen", "last", "Rod", "age", "14"));
894      client.hset("student:3333", toMap("first", "El", "last", "Mark", "age", "17"));
895      client.hset("pupil:4444", toMap("first", "Pat", "last", "Shu", "age", "21"));
896      client.hset("student:5555", toMap("first", "Joen", "last", "Ko", "age", "20"));
897      client.hset("teacher:6666", toMap("first", "Pat", "last", "Rod", "age", "20"));
898      FtSearchIteration search = client.ftSearchIteration(3, index, "*", FTSearchParams.searchParams());
899      int total = 0;
900      while (!search.isIterationCompleted()) {
901        SearchResult result = search.nextBatch();
902        int count = result.getDocuments().size();
903        assertThat(count, Matchers.lessThanOrEqualTo(3));
904        total += count;
905      }
906      assertEquals(7, total);
907    }
908    @Test
909    public void searchIterationCollect() {
910      assertOK(client.ftCreate(index, FTCreateParams.createParams(),
911          TextField.of("first"), TextField.of("last"), NumericField.of("age")));
912      client.hset("profesor:5555", toMap("first", "Albert", "last", "Blue", "age", "55"));
913      client.hset("student:1111", toMap("first", "Joe", "last", "Dod", "age", "18"));
914      client.hset("pupil:2222", toMap("first", "Jen", "last", "Rod", "age", "14"));
915      client.hset("student:3333", toMap("first", "El", "last", "Mark", "age", "17"));
916      client.hset("pupil:4444", toMap("first", "Pat", "last", "Shu", "age", "21"));
917      client.hset("student:5555", toMap("first", "Joen", "last", "Ko", "age", "20"));
918      client.hset("teacher:6666", toMap("first", "Pat", "last", "Rod", "age", "20"));
919      ArrayList<Document> collect = new ArrayList<>();
920      client.ftSearchIteration(3, index, "*", FTSearchParams.searchParams()).collect(collect);
921      assertEquals(7, collect.size());
922      assertEquals(Arrays.asList("profesor:5555", "student:1111", "pupil:2222", "student:3333",
923          "pupil:4444", "student:5555", "teacher:6666").stream().collect(Collectors.toSet()),
924          collect.stream().map(Document::getId).collect(Collectors.toSet()));
925    }
926  }
</code></pre>
        </div>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-SearchWithParamsTest.java</h3>
            <pre><code>1  package redis.clients.jedis.modules.search;
2  import static org.junit.Assert.*;
3  import static redis.clients.jedis.util.AssertUtil.assertOK;
4  import java.util.*;
5  import java.util.stream.Collectors;
6  import org.hamcrest.Matchers;
7  import org.junit.BeforeClass;
8  import org.junit.Test;
9  import redis.clients.jedis.GeoCoordinate;
10  import redis.clients.jedis.args.GeoUnit;
11  import redis.clients.jedis.args.SortingOrder;
12  import redis.clients.jedis.exceptions.JedisDataException;
13  import redis.clients.jedis.json.Path;
14  import redis.clients.jedis.search.*;
15  import redis.clients.jedis.search.schemafields.*;
16  import redis.clients.jedis.search.schemafields.VectorField.VectorAlgorithm;
17  import redis.clients.jedis.modules.RedisModuleCommandsTestBase;
18  public class SearchWithParamsTest extends RedisModuleCommandsTestBase {
19    private static final String index = "testindex";
20    @BeforeClass
21    public static void prepare() {
22      RedisModuleCommandsTestBase.prepare();
23    }
24    private void addDocument(String key, Map<String, Object> map) {
25      client.hset(key, RediSearchUtil.toStringMap(map));
26    }
27    private static Map<String, Object> toMap(Object... values) {
28      Map<String, Object> map = new HashMap<>();
29      for (int i = 0; i < values.length; i += 2) {
30        map.put((String) values[i], values[i + 1]);
31      }
32      return map;
33    }
34    private static Map<String, String> toMap(String... values) {
35      Map<String, String> map = new HashMap<>();
36      for (int i = 0; i < values.length; i += 2) {
37        map.put(values[i], values[i + 1]);
38      }
39      return map;
40    }
41    @Test
42    public void create() {
43      assertOK(client.ftCreate(index,
44          FTCreateParams.createParams()
45              .filter("@age>16")
46              .prefix("student:", "pupil:"),
47          TextField.of("first"), TextField.of("last"), NumericField.of("age")));
48      client.hset("profesor:5555", toMap("first", "Albert", "last", "Blue", "age", "55"));
49      client.hset("student:1111", toMap("first", "Joe", "last", "Dod", "age", "18"));
50      client.hset("pupil:2222", toMap("first", "Jen", "last", "Rod", "age", "14"));
51      client.hset("student:3333", toMap("first", "El", "last", "Mark", "age", "17"));
52      client.hset("pupil:4444", toMap("first", "Pat", "last", "Shu", "age", "21"));
53      client.hset("student:5555", toMap("first", "Joen", "last", "Ko", "age", "20"));
54      client.hset("teacher:6666", toMap("first", "Pat", "last", "Rod", "age", "20"));
55      SearchResult noFilters = client.ftSearch(index);
56      assertEquals(4, noFilters.getTotalResults());
57      SearchResult res1 = client.ftSearch(index, "@first:Jo*");
58      assertEquals(2, res1.getTotalResults());
59      SearchResult res2 = client.ftSearch(index, "@first:Pat");
60      assertEquals(1, res2.getTotalResults());
61      SearchResult res3 = client.ftSearch(index, "@last:Rod");
62      assertEquals(0, res3.getTotalResults());
63    }
64    @Test
65    public void createNoParams() {
66      assertOK(client.ftCreate(index,
67          TextField.of("first").weight(1),
68          TextField.of("last").weight(1),
69          NumericField.of("age")));
70      addDocument("student:1111", toMap("first", "Joe", "last", "Dod", "age", 18));
71      addDocument("student:3333", toMap("first", "El", "last", "Mark", "age", 17));
72      addDocument("pupil:4444", toMap("first", "Pat", "last", "Shu", "age", 21));
73      addDocument("student:5555", toMap("first", "Joen", "last", "Ko", "age", 20));
74      SearchResult noFilters = client.ftSearch(index);
75      assertEquals(4, noFilters.getTotalResults());
76      SearchResult res1 = client.ftSearch(index, "@first:Jo*");
77      assertEquals(2, res1.getTotalResults());
78      SearchResult res2 = client.ftSearch(index, "@first:Pat");
79      assertEquals(1, res2.getTotalResults());
80      SearchResult res3 = client.ftSearch(index, "@last:Rod");
81      assertEquals(0, res3.getTotalResults());
82    }
83    @Test
84    public void createWithFieldNames() {
85      assertOK(client.ftCreate(index,
86          FTCreateParams.createParams()
87              .addPrefix("student:").addPrefix("pupil:"),
88          TextField.of("first").as("given"),
89          TextField.of(FieldName.of("last").as("family"))));
90      client.hset("profesor:5555", toMap("first", "Albert", "last", "Blue", "age", "55"));
91      client.hset("student:1111", toMap("first", "Joe", "last", "Dod", "age", "18"));
92      client.hset("pupil:2222", toMap("first", "Jen", "last", "Rod", "age", "14"));
93      client.hset("student:3333", toMap("first", "El", "last", "Mark", "age", "17"));
94      client.hset("pupil:4444", toMap("first", "Pat", "last", "Shu", "age", "21"));
95      client.hset("student:5555", toMap("first", "Joen", "last", "Ko", "age", "20"));
96      client.hset("teacher:6666", toMap("first", "Pat", "last", "Rod", "age", "20"));
97      SearchResult noFilters = client.ftSearch(index);
98      assertEquals(5, noFilters.getTotalResults());
99      SearchResult asFirst = client.ftSearch(index, "@first:Jo*");
100      assertEquals(0, asFirst.getTotalResults());
101      SearchResult asGiven = client.ftSearch(index, "@given:Jo*");
102      assertEquals(2, asGiven.getTotalResults());
103      SearchResult nonLast = client.ftSearch(index, "@last:Rod");
104      assertEquals(0, nonLast.getTotalResults());
105      SearchResult asFamily = client.ftSearch(index, "@family:Rod");
106      assertEquals(1, asFamily.getTotalResults());
107    }
108    @Test
109    public void alterAdd() {
110      assertOK(client.ftCreate(index, TextField.of("title")));
111      Map<String, Object> fields = new HashMap<>();
112      fields.put("title", "hello world");
113      for (int i = 0; i < 100; i++) {
114        addDocument(String.format("doc%d", i), fields);
115      }
116      SearchResult res = client.ftSearch(index, "hello world");
117      assertEquals(100, res.getTotalResults());
118      assertOK(client.ftAlter(index,
119          TagField.of("tags"),
120          TextField.of("name").weight(0.5)));
121      for (int i = 0; i < 100; i++) {
122        Map<String, Object> fields2 = new HashMap<>();
123        fields2.put("name", "name" + i);
124        fields2.put("tags", String.format("tagA,tagB,tag%d", i));
125        addDocument(String.format("doc%d", i), fields2);
126      }
127      SearchResult res2 = client.ftSearch(index, "@tags:{tagA}");
128      assertEquals(100, res2.getTotalResults());
129      Map<String, Object> info = client.ftInfo(index);
130      assertEquals(index, info.get("index_name"));
131      assertEquals("identifier", ((List) ((List) info.get("attributes")).get(1)).get(0));
132      assertEquals("attribute", ((List) ((List) info.get("attributes")).get(1)).get(2));
133    }
134    @Test
135    public void search() {
136      assertOK(client.ftCreate(index, FTCreateParams.createParams(),
137          TextField.of("title"), TextField.of("body")));
138      Map<String, Object> fields = new HashMap<>();
139      fields.put("title", "hello world");
140      fields.put("body", "lorem ipsum");
141      for (int i = 0; i < 100; i++) {
142        addDocument(String.format("doc%d", i), fields);
143      }
144      SearchResult res = client.ftSearch(index, "hello world",
145          FTSearchParams.searchParams().limit(0, 5).withScores());
146      assertEquals(100, res.getTotalResults());
147      assertEquals(5, res.getDocuments().size());
148      for (Document d : res.getDocuments()) {
149        assertTrue(d.getId().startsWith("doc"));
150        assertTrue(d.getScore() < 100);
151      }
152      client.del("doc0");
153      res = client.ftSearch(index, "hello world");
154      assertEquals(99, res.getTotalResults());
155      assertEquals("OK", client.ftDropIndex(index));
156      try {
157        client.ftSearch(index, "hello world");
158        fail();
159      } catch (JedisDataException e) {
160      }
161    }
162    @Test
163    public void numericFilter() {
164      assertOK(client.ftCreate(index, TextField.of("title"), NumericField.of("price")));
165      Map<String, Object> fields = new HashMap<>();
166      fields.put("title", "hello world");
167      for (int i = 0; i < 100; i++) {
168        fields.put("price", i);
169        addDocument(String.format("doc%d", i), fields);
170      }
171      SearchResult res = client.ftSearch(index, "hello world",
172          FTSearchParams.searchParams().filter("price", 0, 49));
173      assertEquals(50, res.getTotalResults());
174      assertEquals(10, res.getDocuments().size());
175      for (Document d : res.getDocuments()) {
176        long price = Long.valueOf((String) d.get("price"));
177        assertTrue(price >= 0);
178        assertTrue(price <= 49);
179      }
180      res = client.ftSearch(index, "hello world",
181          FTSearchParams.searchParams().filter("price", 0, true, 49, true));
182      assertEquals(48, res.getTotalResults());
183      assertEquals(10, res.getDocuments().size());
184      for (Document d : res.getDocuments()) {
185        long price = Long.valueOf((String) d.get("price"));
186        assertTrue(price > 0);
187        assertTrue(price < 49);
188      }
189      res = client.ftSearch(index, "hello world",
190          FTSearchParams.searchParams().filter("price", 50, 100));
191      assertEquals(50, res.getTotalResults());
192      assertEquals(10, res.getDocuments().size());
193      for (Document d : res.getDocuments()) {
194        long price = Long.valueOf((String) d.get("price"));
195        assertTrue(price >= 50);
196        assertTrue(price <= 100);
197      }
198      res = client.ftSearch(index, "hello world",
199          FTSearchParams.searchParams()
200              .filter("price", 20, Double.POSITIVE_INFINITY));
201      assertEquals(80, res.getTotalResults());
202      assertEquals(10, res.getDocuments().size());
203      res = client.ftSearch(index, "hello world",
204          FTSearchParams.searchParams()
205              .filter("price", Double.NEGATIVE_INFINITY, 10));
206      assertEquals(11, res.getTotalResults());
207      assertEquals(10, res.getDocuments().size());
208    }
209    @Test
210    public void stopwords() {
211      assertOK(client.ftCreate(index,
212          FTCreateParams.createParams()
213              .stopwords("foo", "bar", "baz"),
214          TextField.of("title")));
215      Map<String, Object> fields = new HashMap<>();
216      fields.put("title", "hello world foo bar");
217      addDocument("doc1", fields);
218      SearchResult res = client.ftSearch(index, "hello world");
219      assertEquals(1, res.getTotalResults());
220      res = client.ftSearch(index, "foo bar");
221      assertEquals(0, res.getTotalResults());
222    }
223    @Test
224    public void noStopwords() {
225      assertOK(client.ftCreate(index,
226          FTCreateParams.createParams().noStopwords(),
227          TextField.of("title")));
228      Map<String, Object> fields = new HashMap<>();
229      fields.put("title", "hello world foo bar");
230      fields.put("title", "hello world foo bar to be or not to be");
231      addDocument("doc1", fields);
232      assertEquals(1, client.ftSearch(index, "hello world").getTotalResults());
233      assertEquals(1, client.ftSearch(index, "foo bar").getTotalResults());
234      assertEquals(1, client.ftSearch(index, "to be or not to be").getTotalResults());
235    }
236    @Test
237    public void geoFilter() {
238      assertOK(client.ftCreate(index, TextField.of("title"), GeoField.of("loc")));
239      Map<String, Object> fields = new HashMap<>();
240      fields.put("title", "hello world");
241      fields.put("loc", "-0.441,51.458");
242      addDocument("doc1", fields);
243      fields.put("loc", "-0.1,51.2");
244      addDocument("doc2", fields);
245      SearchResult res = client.ftSearch(index, "hello world",
246          FTSearchParams.searchParams().
247              geoFilter("loc", -0.44, 51.45, 10, GeoUnit.KM));
248      assertEquals(1, res.getTotalResults());
249      res = client.ftSearch(index, "hello world",
250          FTSearchParams.searchParams().
251              geoFilter("loc", -0.44, 51.45, 100, GeoUnit.KM));
252      assertEquals(2, res.getTotalResults());
253    }
254    @Test
255    public void geoFilterAndGeoCoordinateObject() {
256      assertOK(client.ftCreate(index, TextField.of("title"), GeoField.of("loc")));
257      Map<String, Object> fields = new HashMap<>();
258      fields.put("title", "hello world");
259      fields.put("loc", new GeoCoordinate(-0.441, 51.458));
260      addDocument("doc1", fields);
261      fields.put("loc", new GeoCoordinate(-0.1, 51.2));
262      addDocument("doc2", fields);
263      SearchResult res = client.ftSearch(index, "hello world",
264          FTSearchParams.searchParams()
265              .geoFilter(new FTSearchParams.GeoFilter("loc", -0.44, 51.45, 10, GeoUnit.KM)));
266      assertEquals(1, res.getTotalResults());
267      res = client.ftSearch(index, "hello world",
268          FTSearchParams.searchParams()
269              .geoFilter(new FTSearchParams.GeoFilter("loc", -0.44, 51.45, 100, GeoUnit.KM)));
270      assertEquals(2, res.getTotalResults());
271    }
272    @Test
273    public void testQueryFlags() {
274      assertOK(client.ftCreate(index, TextField.of("title")));
275      Map<String, Object> fields = new HashMap<>();
276      for (int i = 0; i < 100; i++) {
277        fields.put("title", i % 2 != 0 ? "hello worlds" : "hello world");
278        addDocument(String.format("doc%d", i), fields);
279      }
280      SearchResult res = client.ftSearch(index, "hello",
281          FTSearchParams.searchParams().withScores());
282      assertEquals(100, res.getTotalResults());
283      assertEquals(10, res.getDocuments().size());
284      for (Document d : res.getDocuments()) {
285        assertTrue(d.getId().startsWith("doc"));
286        assertTrue(((String) d.get("title")).startsWith("hello world"));
287      }
288      res = client.ftSearch(index, "hello",
289          FTSearchParams.searchParams().noContent());
290      for (Document d : res.getDocuments()) {
291        assertTrue(d.getId().startsWith("doc"));
292        assertEquals(1.0, d.getScore(), 0);
293        assertNull(d.get("title"));
294      }
295      res = client.ftSearch(index, "hello worlds");
296      assertEquals(100, res.getTotalResults());
297      res = client.ftSearch(index, "hello worlds", FTSearchParams.searchParams().verbatim());
298      assertEquals(50, res.getTotalResults());
299      res = client.ftSearch(index, "hello a world", FTSearchParams.searchParams().verbatim());
300      assertEquals(50, res.getTotalResults());
301      res = client.ftSearch(index, "hello a worlds", FTSearchParams.searchParams().verbatim());
302      assertEquals(50, res.getTotalResults());
303      res = client.ftSearch(index, "hello a world", FTSearchParams.searchParams().verbatim().noStopwords());
304      assertEquals(0, res.getTotalResults());
305    }
306    @Test
307    public void testQueryParams() {
308      assertOK(client.ftCreate(index, NumericField.of("numval")));
309      client.hset("1", "numval", "1");
310      client.hset("2", "numval", "2");
311      client.hset("3", "numval", "3");
312      assertEquals(2, client.ftSearch(index, "@numval:[$min $max]",
313          FTSearchParams.searchParams().addParam("min", 1).addParam("max", 2)
314              .dialect(2)).getTotalResults());
315      Map<String, Object> paramValues = new HashMap<>();
316      paramValues.put("min", 1);
317      paramValues.put("max", 2);
318      assertEquals(2, client.ftSearch(index, "@numval:[$min $max]",
319          FTSearchParams.searchParams().params(paramValues)
320              .dialect(2)).getTotalResults());
321    }
322    @Test
323    public void testSortQueryFlags() {
324      assertOK(client.ftCreate(index, TextField.of("title").sortable()));
325      Map<String, Object> fields = new HashMap<>();
326      fields.put("title", "b title");
327      addDocument("doc1", fields);
328      fields.put("title", "a title");
329      addDocument("doc2", fields);
330      fields.put("title", "c title");
331      addDocument("doc3", fields);
332      SearchResult res = client.ftSearch(index, "title",
333          FTSearchParams.searchParams().sortBy("title", SortingOrder.ASC));
334      assertEquals(3, res.getTotalResults());
335      Document doc1 = res.getDocuments().get(0);
336      assertEquals("a title", doc1.get("title"));
337      doc1 = res.getDocuments().get(1);
338      assertEquals("b title", doc1.get("title"));
339      doc1 = res.getDocuments().get(2);
340      assertEquals("c title", doc1.get("title"));
341    }
342    @Test
343    public void testJsonWithAlias() {
344      assertOK(client.ftCreate(index,
345          FTCreateParams.createParams()
346              .on(IndexDataType.JSON)
347              .prefix("king:"),
348          TextField.of("$.name").as("name"),
349          NumericField.of("$.num").as("num")));
350      Map<String, Object> king1 = new HashMap<>();
351      king1.put("name", "henry");
352      king1.put("num", 42);
353      client.jsonSet("king:1", Path.ROOT_PATH, king1);
354      Map<String, Object> king2 = new HashMap<>();
355      king2.put("name", "james");
356      king2.put("num", 3.14);
357      client.jsonSet("king:2", Path.ROOT_PATH, king2);
358      SearchResult res = client.ftSearch(index, "@name:henry");
359      assertEquals(1, res.getTotalResults());
360      assertEquals("king:1", res.getDocuments().get(0).getId());
361      res = client.ftSearch(index, "@num:[0 10]");
362      assertEquals(1, res.getTotalResults());
363      assertEquals("king:2", res.getDocuments().get(0).getId());
364    }
365    @Test
366    public void dropIndex() {
367      assertOK(client.ftCreate(index, TextField.of("title")));
368      Map<String, Object> fields = new HashMap<>();
369      fields.put("title", "hello world");
370      for (int i = 0; i < 100; i++) {
371        addDocument(String.format("doc%d", i), fields);
372      }
373      SearchResult res = client.ftSearch(index, "hello world");
374      assertEquals(100, res.getTotalResults());
375      assertEquals("OK", client.ftDropIndex(index));
376      try {
377        client.ftSearch(index, "hello world");
378        fail("Index should not exist.");
379      } catch (JedisDataException de) {
380        assertTrue(de.getMessage().contains("no such index"));
381      }
382      assertEquals(100, client.dbSize());
383    }
384    @Test
385    public void dropIndexDD() {
386      assertOK(client.ftCreate(index, TextField.of("title")));
387      Map<String, Object> fields = new HashMap<>();
388      fields.put("title", "hello world");
389      for (int i = 0; i < 100; i++) {
390        addDocument(String.format("doc%d", i), fields);
391      }
392      SearchResult res = client.ftSearch(index, "hello world");
393      assertEquals(100, res.getTotalResults());
394      assertEquals("OK", client.ftDropIndexDD(index));
395      Set<String> keys = client.keys("*");
396      assertTrue(keys.isEmpty());
397      assertEquals(0, client.dbSize());
398    }
399    @Test
400    public void noStem() {
401      assertOK(client.ftCreate(index, new TextField("stemmed").weight(1.0),
402          new TextField("notStemmed").weight(1.0).noStem()));
403      Map<String, Object> doc = new HashMap<>();
404      doc.put("stemmed", "located");
405      doc.put("notStemmed", "located");
406      addDocument("doc", doc);
407      SearchResult res = client.ftSearch(index, "@stemmed:location");
408      assertEquals(1, res.getTotalResults());
409      res = client.ftSearch(index, "@notStemmed:location");
410      assertEquals(0, res.getTotalResults());
411    }
412    @Test
413    public void phoneticMatch() {
414      assertOK(client.ftCreate(index, new TextField("noPhonetic").weight(1.0),
415          new TextField("withPhonetic").weight(1.0).phonetic("dm:en")));
416      Map<String, Object> doc = new HashMap<>();
417      doc.put("noPhonetic", "morfix");
418      doc.put("withPhonetic", "morfix");
419      addDocument("doc", doc);
420      SearchResult res = client.ftSearch(index, "@withPhonetic:morphix=>{$phonetic:true}");
421      assertEquals(1, res.getTotalResults());
422      try {
423        client.ftSearch(index, "@noPhonetic:morphix=>{$phonetic:true}");
424        fail();
425      } catch (JedisDataException e) {&bsol;*field does not support phonetics*/
426      }
427      SearchResult res3 = client.ftSearch(index, "@withPhonetic:morphix=>{$phonetic:false}");
428      assertEquals(0, res3.getTotalResults());
429    }
430    @Test
431    public void info() {
432      Collection<SchemaField> sc = new ArrayList<>();
433      sc.add(TextField.of("title").weight(5));
434      sc.add(TextField.of("plot").sortable());
435      sc.add(TagField.of("genre").separator(',').sortable());
436      sc.add(NumericField.of("release_year").sortable());
437      sc.add(NumericField.of("rating").sortable());
438      sc.add(NumericField.of("votes").sortable());
439      assertOK(client.ftCreate(index, sc));
440      Map<String, Object> info = client.ftInfo(index);
441      assertEquals(index, info.get("index_name"));
442      assertEquals(6, ((List) info.get("attributes")).size());
443      assertEquals("global_idle", ((List) info.get("cursor_stats")).get(0));
444      assertEquals(0L, ((List) info.get("cursor_stats")).get(1));
445    }
446    @Test
447    public void noIndexAndSortBy() {
448      assertOK(client.ftCreate(index, TextField.of("f1").sortable().noIndex(), TextField.of("f2")));
449      Map<String, Object> mm = new HashMap<>();
450      mm.put("f1", "MarkZZ");
451      mm.put("f2", "MarkZZ");
452      addDocument("doc1", mm);
453      mm.clear();
454      mm.put("f1", "MarkAA");
455      mm.put("f2", "MarkBB");
456      addDocument("doc2", mm);
457      SearchResult res = client.ftSearch(index, "@f1:Mark*");
458      assertEquals(0, res.getTotalResults());
459      res = client.ftSearch(index, "@f2:Mark*");
460      assertEquals(2, res.getTotalResults());
461      res = client.ftSearch(index, "@f2:Mark*",
462          FTSearchParams.searchParams().sortBy("f1", SortingOrder.DESC));
463      assertEquals(2, res.getTotalResults());
464      assertEquals("doc1", res.getDocuments().get(0).getId());
465      res = client.ftSearch(index, "@f2:Mark*",
466          FTSearchParams.searchParams().sortBy("f1", SortingOrder.ASC));
467      assertEquals("doc2", res.getDocuments().get(0).getId());
468    }
469    @Test
470    public void testHighlightSummarize() {
471      assertOK(client.ftCreate(index, TextField.of("text").weight(1)));
472      Map<String, Object> doc = new HashMap<>();
473      doc.put("text", "Redis is often referred as a data structures server. What this means is that "
474          + "Redis provides access to mutable data structures via a set of commands, which are sent "
475          + "using a server-client model with TCP sockets and a simple protocol. So different "
476          + "processes can query and modify the same data structures in a shared way");
477      addDocument("foo", doc);
478      SearchResult res = client.ftSearch(index, "data", FTSearchParams.searchParams().highlight().summarize());
479      assertEquals("is often referred as a <b>data</b> structures server. What this means is that "
480          + "Redis provides... What this means is that Redis provides access to mutable <b>data</b> "
481          + "structures via a set of commands, which are sent using a... So different processes can "
482          + "query and modify the same <b>data</b> structures in a shared... ",
483          res.getDocuments().get(0).get("text"));
484      res = client.ftSearch(index, "data", FTSearchParams.searchParams()
485          .highlight(FTSearchParams.highlightParams().tags("<u>", "</u>"))
486          .summarize());
487      assertEquals("is often referred as a <u>data</u> structures server. What this means is that "
488          + "Redis provides... What this means is that Redis provides access to mutable <u>data</u> "
489          + "structures via a set of commands, which are sent using a... So different processes can "
490          + "query and modify the same <u>data</u> structures in a shared... ",
491          res.getDocuments().get(0).get("text"));
492    }
493    @Test
494    public void getTagField() {
495      assertOK(client.ftCreate(index, TextField.of("title"), TagField.of("category")));
496      Map<String, Object> fields1 = new HashMap<>();
497      fields1.put("title", "hello world");
498      fields1.put("category", "red");
499      addDocument("foo", fields1);
500      Map<String, Object> fields2 = new HashMap<>();
501      fields2.put("title", "hello world");
502      fields2.put("category", "blue");
503      addDocument("bar", fields2);
504      Map<String, Object> fields3 = new HashMap<>();
505      fields3.put("title", "hello world");
506      fields3.put("category", "green,yellow");
507      addDocument("baz", fields3);
508      Map<String, Object> fields4 = new HashMap<>();
509      fields4.put("title", "hello world");
510      fields4.put("category", "orange;purple");
511      addDocument("qux", fields4);
512      assertEquals(1, client.ftSearch(index, "@category:{red}").getTotalResults());
513      assertEquals(1, client.ftSearch(index, "@category:{blue}").getTotalResults());
514      assertEquals(1, client.ftSearch(index, "hello @category:{red}").getTotalResults());
515      assertEquals(1, client.ftSearch(index, "hello @category:{blue}").getTotalResults());
516      assertEquals(1, client.ftSearch(index, "@category:{yellow}").getTotalResults());
517      assertEquals(0, client.ftSearch(index, "@category:{purple}").getTotalResults());
518      assertEquals(1, client.ftSearch(index, "@category:{orange\\;purple}").getTotalResults());
519      assertEquals(4, client.ftSearch(index, "hello").getTotalResults());
520      assertEquals(new HashSet<>(Arrays.asList("red", "blue", "green", "yellow", "orange;purple")),
521          client.ftTagVals(index, "category"));
522    }
523    @Test
524    public void testGetTagFieldWithNonDefaultSeparator() {
525      assertOK(client.ftCreate(index,
526          TextField.of("title"),
527          TagField.of("category").separator(';')));
528      Map<String, Object> fields1 = new HashMap<>();
529      fields1.put("title", "hello world");
530      fields1.put("category", "red");
531      addDocument("foo", fields1);
532      Map<String, Object> fields2 = new HashMap<>();
533      fields2.put("title", "hello world");
534      fields2.put("category", "blue");
535      addDocument("bar", fields2);
536      Map<String, Object> fields3 = new HashMap<>();
537      fields3.put("title", "hello world");
538      fields3.put("category", "green;yellow");
539      addDocument("baz", fields3);
540      Map<String, Object> fields4 = new HashMap<>();
541      fields4.put("title", "hello world");
542      fields4.put("category", "orange,purple");
543      addDocument("qux", fields4);
544      assertEquals(1, client.ftSearch(index, "@category:{red}").getTotalResults());
545      assertEquals(1, client.ftSearch(index, "@category:{blue}").getTotalResults());
546      assertEquals(1, client.ftSearch(index, "hello @category:{red}").getTotalResults());
547      assertEquals(1, client.ftSearch(index, "hello @category:{blue}").getTotalResults());
548      assertEquals(1, client.ftSearch(index, "hello @category:{yellow}").getTotalResults());
549      assertEquals(0, client.ftSearch(index, "@category:{purple}").getTotalResults());
550      assertEquals(1, client.ftSearch(index, "@category:{orange\\,purple}").getTotalResults());
551      assertEquals(4, client.ftSearch(index, "hello").getTotalResults());
552      assertEquals(new HashSet<>(Arrays.asList("red", "blue", "green", "yellow", "orange,purple")),
553          client.ftTagVals(index, "category"));
554    }
555    @Test
556    public void caseSensitiveTagField() {
557      assertOK(client.ftCreate(index,
558          TextField.of("title"),
559          TagField.of("category").caseSensitive()));
560      Map<String, Object> fields = new HashMap<>();
561      fields.put("title", "hello world");
562      fields.put("category", "RedX");
563      addDocument("foo", fields);
564      assertEquals(0, client.ftSearch(index, "@category:{redx}").getTotalResults());
565      assertEquals(0, client.ftSearch(index, "@category:{redX}").getTotalResults());
566      assertEquals(0, client.ftSearch(index, "@category:{Redx}").getTotalResults());
567      assertEquals(1, client.ftSearch(index, "@category:{RedX}").getTotalResults());
568      assertEquals(1, client.ftSearch(index, "hello").getTotalResults());
569    }
570    @Test
571    public void testReturnFields() {
572      assertOK(client.ftCreate(index, TextField.of("field1"), TextField.of("field2")));
573      Map<String, Object> doc = new HashMap<>();
574      doc.put("field1", "value1");
575      doc.put("field2", "value2");
576      addDocument("doc", doc);
577      SearchResult res = client.ftSearch(index, "*",
578          FTSearchParams.searchParams().returnFields("field1"));
579      assertEquals(1, res.getTotalResults());
580      Document ret = res.getDocuments().get(0);
581      assertEquals("value1", ret.get("field1"));
582      assertNull(ret.get("field2"));
583    }
584    @Test
585    public void returnWithFieldNames() {
586      assertOK(client.ftCreate(index, TextField.of("a"), TextField.of("b"), TextField.of("c")));
587      Map<String, Object> map = new HashMap<>();
588      map.put("a", "value1");
589      map.put("b", "value2");
590      map.put("c", "value3");
591      addDocument("doc", map);
592      SearchResult res = client.ftSearch(index, "*",
593          FTSearchParams.searchParams().returnFields(
594              FieldName.of("a"), FieldName.of("b").as("d")));
595      assertEquals(1, res.getTotalResults());
<span onclick='openModal()' class='match'>596      Document doc = res.getDocuments().get(0);
597      assertEquals("value1", doc.get("a"));
</span>598      assertNull(doc.get("b"));
599      assertEquals("value2", doc.get("d"));
600      assertNull(doc.get("c"));
601    }
602    @Test
603    public void inKeys() {
604      assertOK(client.ftCreate(index, TextField.of("field1"), TextField.of("field2")));
605      Map<String, Object> doc = new HashMap<>();
606      doc.put("field1", "value");
607      doc.put("field2", "not");
608      addDocument("doc1", doc);
609      addDocument("doc2", doc);
610      SearchResult res = client.ftSearch(index, "value",
611          FTSearchParams.searchParams().inKeys("doc1"));
612      assertEquals(1, res.getTotalResults());
613      assertEquals("doc1", res.getDocuments().get(0).getId());
614      assertEquals("value", res.getDocuments().get(0).get("field1"));
615      assertEquals(null, res.getDocuments().get(0).get("value"));
616    }
617    @Test
618    public void alias() {
619      assertOK(client.ftCreate(index, TextField.of("field1")));
620      Map<String, Object> doc = new HashMap<>();
621      doc.put("field1", "value");
622      addDocument("doc1", doc);
623      assertEquals("OK", client.ftAliasAdd("ALIAS1", index));
624      SearchResult res1 = client.ftSearch("ALIAS1", "*",
625          FTSearchParams.searchParams().returnFields("field1"));
626      assertEquals(1, res1.getTotalResults());
627      assertEquals("value", res1.getDocuments().get(0).get("field1"));
628      assertEquals("OK", client.ftAliasUpdate("ALIAS2", index));
629      SearchResult res2 = client.ftSearch("ALIAS2", "*",
630          FTSearchParams.searchParams().returnFields("field1"));
631      assertEquals(1, res2.getTotalResults());
632      assertEquals("value", res2.getDocuments().get(0).get("field1"));
633      try {
634        client.ftAliasDel("ALIAS3");
635        fail("Should throw JedisDataException");
636      } catch (JedisDataException e) {
637      }
638      assertEquals("OK", client.ftAliasDel("ALIAS2"));
639      try {
640        client.ftAliasDel("ALIAS2");
641        fail("Should throw JedisDataException");
642      } catch (JedisDataException e) {
643      }
644    }
645    @Test
646    public void synonym() {
647      assertOK(client.ftCreate(index, TextField.of("name").weight(1), TextField.of("addr").weight(1)));
648      long group1 = 345L;
649      long group2 = 789L;
650      String group1_str = Long.toString(group1);
651      String group2_str = Long.toString(group2);
652      assertEquals("OK", client.ftSynUpdate(index, group1_str, "girl", "baby"));
653      assertEquals("OK", client.ftSynUpdate(index, group1_str, "child"));
654      assertEquals("OK", client.ftSynUpdate(index, group2_str, "child"));
655      Map<String, List<String>> dump = client.ftSynDump(index);
656      Map<String, List<String>> expected = new HashMap<>();
657      expected.put("girl", Arrays.asList(group1_str));
658      expected.put("baby", Arrays.asList(group1_str));
659      expected.put("child", Arrays.asList(group1_str, group2_str));
660      assertEquals(expected, dump);
661    }
662    @Test
663    public void slop() {
664      assertOK(client.ftCreate(index, TextField.of("field1"), TextField.of("field2")));
665      Map<String, Object> doc = new HashMap<>();
666      doc.put("field1", "ok hi jedis");
667      addDocument("doc1", doc);
668      SearchResult res = client.ftSearch(index, "ok jedis", FTSearchParams.searchParams().slop(0));
669      assertEquals(0, res.getTotalResults());
670      res = client.ftSearch(index, "ok jedis", FTSearchParams.searchParams().slop(1));
671      assertEquals(1, res.getTotalResults());
672      assertEquals("doc1", res.getDocuments().get(0).getId());
673      assertEquals("ok hi jedis", res.getDocuments().get(0).get("field1"));
674    }
675    @Test
676    public void timeout() {
677      assertOK(client.ftCreate(index, TextField.of("field1"), TextField.of("field2")));
678      Map<String, String> map = new HashMap<>();
679      map.put("field1", "value");
680      map.put("field2", "not");
681      client.hset("doc1", map);
682      SearchResult res = client.ftSearch(index, "value", FTSearchParams.searchParams().timeout(1000));
683      assertEquals(1, res.getTotalResults());
684      assertEquals("doc1", res.getDocuments().get(0).getId());
685      assertEquals("value", res.getDocuments().get(0).get("field1"));
686      assertEquals("not", res.getDocuments().get(0).get("field2"));
687    }
688    @Test
689    public void inOrder() {
690      assertOK(client.ftCreate(index, TextField.of("field1"), TextField.of("field2")));
691      Map<String, String> map = new HashMap<>();
692      map.put("field1", "value");
693      map.put("field2", "not");
694      client.hset("doc2", map);
695      client.hset("doc1", map);
696      SearchResult res = client.ftSearch(index, "value", FTSearchParams.searchParams().inOrder());
697      assertEquals(2, res.getTotalResults());
698      assertEquals("doc2", res.getDocuments().get(0).getId());
699      assertEquals("value", res.getDocuments().get(0).get("field1"));
700      assertEquals("not", res.getDocuments().get(0).get("field2"));
701    }
702    @Test
703    public void testHNSWVVectorSimilarity() {
704      Map<String, Object> attr = new HashMap<>();
705      attr.put("TYPE", "FLOAT32");
706      attr.put("DIM", 2);
707      attr.put("DISTANCE_METRIC", "L2");
708      assertOK(client.ftCreate(index, VectorField.builder().fieldName("v")
709          .algorithm(VectorField.VectorAlgorithm.HNSW).attributes(attr).build()));
710      client.hset("a", "v", "aaaaaaaa");
711      client.hset("b", "v", "aaaabaaa");
712      client.hset("c", "v", "aaaaabaa");
713      FTSearchParams searchParams = FTSearchParams.searchParams()
714          .addParam("vec", "aaaaaaaa")
715          .sortBy("__v_score", SortingOrder.ASC)
716          .returnFields("__v_score")
717          .dialect(2);
718      Document doc1 = client.ftSearch(index, "*=>[KNN 2 @v $vec]", searchParams).getDocuments().get(0);
719      assertEquals("a", doc1.getId());
720      assertEquals("0", doc1.get("__v_score"));
721    }
722    @Test
723    public void testFlatVectorSimilarity() {
724      assertOK(client.ftCreate(index,
725          VectorField.builder().fieldName("v")
726              .algorithm(VectorField.VectorAlgorithm.FLAT)
727              .addAttribute("TYPE", "FLOAT32")
728              .addAttribute("DIM", 2)
729              .addAttribute("DISTANCE_METRIC", "L2")
730              .build()
731      ));
732      client.hset("a", "v", "aaaaaaaa");
733      client.hset("b", "v", "aaaabaaa");
734      client.hset("c", "v", "aaaaabaa");
735      FTSearchParams searchParams = FTSearchParams.searchParams()
736          .addParam("vec", "aaaaaaaa")
737          .sortBy("__v_score", SortingOrder.ASC)
738          .returnFields("__v_score")
739          .dialect(2);
740      Document doc1 = client.ftSearch(index, "*=>[KNN 2 @v $vec]", searchParams).getDocuments().get(0);
741      assertEquals("a", doc1.getId());
742      assertEquals("0", doc1.get("__v_score"));
743    }
744    @Test
745    public void searchProfile() {
746      assertOK(client.ftCreate(index, TextField.of("t1"), TextField.of("t2")));
747      Map<String, String> map = new HashMap<>();
748      map.put("t1", "foo");
749      map.put("t2", "bar");
750      client.hset("doc1", map);
751      Map.Entry<SearchResult, Map<String, Object>> profile = client.ftProfileSearch(index,
752          FTProfileParams.profileParams(), "foo", FTSearchParams.searchParams());
753      Map<String, Object> iteratorsProfile = (Map<String, Object>) profile.getValue().get("Iterators profile");
754      assertEquals("TEXT", iteratorsProfile.get("Type"));
755      assertEquals("foo", iteratorsProfile.get("Term"));
756      assertEquals(1L, iteratorsProfile.get("Counter"));
757      assertEquals(1L, iteratorsProfile.get("Size"));
758      assertSame(Double.class, iteratorsProfile.get("Time").getClass());
759    }
760    @Test
761    public void vectorSearchProfile() {
762      assertOK(client.ftCreate(index, VectorField.builder().fieldName("v")
763          .algorithm(VectorAlgorithm.FLAT).addAttribute("TYPE", "FLOAT32")
764          .addAttribute("DIM", 2).addAttribute("DISTANCE_METRIC", "L2").build(),
765          TextField.of("t")));
766      client.hset("1", toMap("v", "bababaca", "t", "hello"));
767      client.hset("2", toMap("v", "babababa", "t", "hello"));
768      client.hset("3", toMap("v", "aabbaabb", "t", "hello"));
769      client.hset("4", toMap("v", "bbaabbaa", "t", "hello world"));
770      client.hset("5", toMap("v", "aaaabbbb", "t", "hello world"));
771      FTSearchParams searchParams = FTSearchParams.searchParams().addParam("vec", "aaaaaaaa")
772          .sortBy("__v_score", SortingOrder.ASC).noContent().dialect(2);
773      Map.Entry<SearchResult, Map<String, Object>> profile = client.ftProfileSearch(index,
774          FTProfileParams.profileParams(), "*=>[KNN 3 @v $vec]", searchParams);
775      assertEquals(3, profile.getKey().getTotalResults());
776      assertEquals(Arrays.asList(4, 2, 1).toString(), profile.getKey().getDocuments()
777          .stream().map(Document::getId).collect(Collectors.toList()).toString());
778      Map<String, Object> iteratorsProfile = (Map<String, Object>) profile.getValue().get("Iterators profile");
779      assertEquals("VECTOR", iteratorsProfile.get("Type"));
780      assertEquals(3L, iteratorsProfile.get("Counter"));
781      List<Map<String, Object>> resultProcessorsProfile = (List<Map<String, Object>>) profile.getValue().get("Result processors profile");
782      assertEquals(3l, resultProcessorsProfile.get(1).get("Counter"));
783    }
784    @Test
785    public void maxPrefixExpansionSearchProfile() {
786      final String configParam = "MAXPREFIXEXPANSIONS";
787      String configValue = client.ftConfigGet(configParam).get(configParam);
788      client.ftConfigSet(configParam, "2");
789      assertOK(client.ftCreate(index, TextField.of("t")));
790      client.hset("1", Collections.singletonMap("t", "foo1"));
791      client.hset("2", Collections.singletonMap("t", "foo2"));
792      client.hset("3", Collections.singletonMap("t", "foo3"));
793      Map.Entry<SearchResult, Map<String, Object>> profile = client.ftProfileSearch(index,
794          FTProfileParams.profileParams(), "foo*", FTSearchParams.searchParams().limit(0, 0));
795      Map<String, Object> iteratorsProfile = (Map<String, Object>) profile.getValue().get("Iterators profile");
796      assertEquals("Max prefix expansion reached", iteratorsProfile.get("Warning"));
797      client.ftConfigSet(configParam, configValue);
798    }
799    @Test
800    public void notIteratorSearchProfile() {
801      assertOK(client.ftCreate(index, TextField.of("t")));
802      client.hset("1", Collections.singletonMap("t", "foo"));
803      client.hset("2", Collections.singletonMap("t", "bar"));
804      Map.Entry<SearchResult, Map<String, Object>> profile = client.ftProfileSearch(index,
805          FTProfileParams.profileParams(), "foo -@t:baz", FTSearchParams.searchParams().noContent());
806      Map<String, Object> depth0 = (Map<String, Object>) profile.getValue().get("Iterators profile");
807      assertEquals("INTERSECT", depth0.get("Type"));
808      List<Map<String, Object>> depth0_children = (List<Map<String, Object>>) depth0.get("Child iterators");
809      assertEquals("TEXT", depth0_children.get(0).get("Type"));
810      Map<String, Object> depth1 = depth0_children.get(1);
811      assertEquals("NOT", depth1.get("Type"));
812      List<Map<String, Object>> depth1_children = (List<Map<String, Object>>) depth1.get("Child iterators");
813      assertEquals(1, depth1_children.size());
814      assertEquals("EMPTY", depth1_children.get(0).get("Type"));
815    }
816    @Test
817    public void deepReplySearchProfile() {
818      assertOK(client.ftCreate(index, TextField.of("t")));
819      client.hset("1", Collections.singletonMap("t", "hello"));
820      client.hset("2", Collections.singletonMap("t", "world"));
821      Map.Entry<SearchResult, Map<String, Object>> profile
822          = client.ftProfileSearch(index, FTProfileParams.profileParams(),
823              "hello(hello(hello(hello(hello(hello)))))", FTSearchParams.searchParams().noContent());
824      Map<String, Object> depth0 = (Map<String, Object>) profile.getValue().get("Iterators profile");
825      assertEquals("INTERSECT", depth0.get("Type"));
826      List<Map<String, Object>> depth0_children = (List<Map<String, Object>>) depth0.get("Child iterators");
827      assertEquals("TEXT", depth0_children.get(0).get("Type"));
828      Map<String, Object> depth1 = depth0_children.get(1);
829      assertEquals("INTERSECT", depth1.get("Type"));
830      List<Map<String, Object>> depth1_children = (List<Map<String, Object>>) depth1.get("Child iterators");
831      assertEquals("TEXT", depth1_children.get(0).get("Type"));
832      Map<String, Object> depth2 = depth1_children.get(1);
833      assertEquals("INTERSECT", depth2.get("Type"));
834      List<Map<String, Object>> depth2_children = (List<Map<String, Object>>) depth2.get("Child iterators");
835      assertEquals("TEXT", depth2_children.get(0).get("Type"));
836      Map<String, Object> depth3 = depth2_children.get(1);
837      assertEquals("INTERSECT", depth3.get("Type"));
838      List<Map<String, Object>> depth3_children = (List<Map<String, Object>>) depth3.get("Child iterators");
839      assertEquals("TEXT", depth3_children.get(0).get("Type"));
840      Map<String, Object> depth4 = depth3_children.get(1);
841      assertEquals("INTERSECT", depth4.get("Type"));
842      List<Map<String, Object>> depth4_children = (List<Map<String, Object>>) depth4.get("Child iterators");
843      assertEquals("TEXT", depth4_children.get(0).get("Type"));
844      Map<String, Object> depth5 = depth4_children.get(1);
845      assertEquals("TEXT", depth5.get("Type"));
846      assertNull(depth5.get("Child iterators"));
847    }
848    @Test
849    public void limitedSearchProfile() {
850      assertOK(client.ftCreate(index, TextField.of("t")));
851      client.hset("1", Collections.singletonMap("t", "hello"));
852      client.hset("2", Collections.singletonMap("t", "hell"));
853      client.hset("3", Collections.singletonMap("t", "help"));
854      client.hset("4", Collections.singletonMap("t", "helowa"));
855      Map.Entry<SearchResult, Map<String, Object>> profile = client.ftProfileSearch(index,
856          FTProfileParams.profileParams().limited(), "%hell% hel*", FTSearchParams.searchParams().noContent());
857      Map<String, Object> depth0 = (Map<String, Object>) profile.getValue().get("Iterators profile");
858      assertEquals("INTERSECT", depth0.get("Type"));
859      assertEquals(3L, depth0.get("Counter"));
860      List<Map<String, Object>> depth0_children = (List<Map<String, Object>>) depth0.get("Child iterators");
861      assertFalse(depth0_children.isEmpty());
862      for (Map<String, Object> depth1 : depth0_children) {
863        assertEquals("UNION", depth1.get("Type"));
864        assertNotNull(depth1.get("Query type"));
865        List depth1_children = (List) depth1.get("Child iterators");
866        assertEquals(1, depth1_children.size());
867        assertSame(String.class, depth1_children.get(0).getClass());
868      }
869    }
870    @Test
871    public void list() {
872      assertEquals(Collections.emptyList(), client.ftList());
873      final int count = 20;
874      Set<String> names = new HashSet<>();
875      for (int i = 0; i < count; i++) {
876        final String name = "idx" + i;
877        assertOK(client.ftCreate(name, TextField.of("t" + i)));
878        names.add(name);
879      }
880      assertEquals(names, new HashSet<>(client.ftList()));
881    }
882    @Test
883    public void broadcast() {
884      String reply = client.ftCreate(index, TextField.of("t"));
885      assertOK(reply);
886    }
887    @Test
888    public void searchIteration() {
889      assertOK(client.ftCreate(index, FTCreateParams.createParams(),
890          TextField.of("first"), TextField.of("last"), NumericField.of("age")));
891      client.hset("profesor:5555", toMap("first", "Albert", "last", "Blue", "age", "55"));
892      client.hset("student:1111", toMap("first", "Joe", "last", "Dod", "age", "18"));
893      client.hset("pupil:2222", toMap("first", "Jen", "last", "Rod", "age", "14"));
894      client.hset("student:3333", toMap("first", "El", "last", "Mark", "age", "17"));
895      client.hset("pupil:4444", toMap("first", "Pat", "last", "Shu", "age", "21"));
896      client.hset("student:5555", toMap("first", "Joen", "last", "Ko", "age", "20"));
897      client.hset("teacher:6666", toMap("first", "Pat", "last", "Rod", "age", "20"));
898      FtSearchIteration search = client.ftSearchIteration(3, index, "*", FTSearchParams.searchParams());
899      int total = 0;
900      while (!search.isIterationCompleted()) {
901        SearchResult result = search.nextBatch();
902        int count = result.getDocuments().size();
903        assertThat(count, Matchers.lessThanOrEqualTo(3));
904        total += count;
905      }
906      assertEquals(7, total);
907    }
908    @Test
909    public void searchIterationCollect() {
910      assertOK(client.ftCreate(index, FTCreateParams.createParams(),
911          TextField.of("first"), TextField.of("last"), NumericField.of("age")));
912      client.hset("profesor:5555", toMap("first", "Albert", "last", "Blue", "age", "55"));
913      client.hset("student:1111", toMap("first", "Joe", "last", "Dod", "age", "18"));
914      client.hset("pupil:2222", toMap("first", "Jen", "last", "Rod", "age", "14"));
915      client.hset("student:3333", toMap("first", "El", "last", "Mark", "age", "17"));
916      client.hset("pupil:4444", toMap("first", "Pat", "last", "Shu", "age", "21"));
917      client.hset("student:5555", toMap("first", "Joen", "last", "Ko", "age", "20"));
918      client.hset("teacher:6666", toMap("first", "Pat", "last", "Rod", "age", "20"));
919      ArrayList<Document> collect = new ArrayList<>();
920      client.ftSearchIteration(3, index, "*", FTSearchParams.searchParams()).collect(collect);
921      assertEquals(7, collect.size());
922      assertEquals(Arrays.asList("profesor:5555", "student:1111", "pupil:2222", "student:3333",
923          "pupil:4444", "student:5555", "teacher:6666").stream().collect(Collectors.toSet()),
924          collect.stream().map(Document::getId).collect(Collectors.toSet()));
925    }
926  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-SearchWithParamsTest.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-SearchWithParamsTest.java</div>
                </div>
                <div class="column column_space"><pre><code>335      Document doc1 = res.getDocuments().get(0);
336      assertEquals("a title", doc1.get("title"));
</pre></code></div>
                <div class="column column_space"><pre><code>596      Document doc = res.getDocuments().get(0);
597      assertEquals("value1", doc.get("a"));
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    