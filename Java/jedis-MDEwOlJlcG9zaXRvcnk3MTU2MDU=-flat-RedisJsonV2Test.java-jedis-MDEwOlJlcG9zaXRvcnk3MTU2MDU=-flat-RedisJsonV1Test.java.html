
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 29, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-RedisJsonV2Test.java</h3>
            <pre><code>1  package redis.clients.jedis.modules.json;
2  import static java.util.Collections.singletonList;
3  import static org.junit.Assert.*;
4  import static redis.clients.jedis.json.Path2.ROOT_PATH;
5  import static redis.clients.jedis.modules.json.JsonObjects.*;
6  import com.google.gson.Gson;
7  import java.util.Arrays;
8  import java.util.Collections;
9  import java.util.List;
10  import org.hamcrest.MatcherAssert;
11  import org.hamcrest.Matchers;
12  import org.json.JSONArray;
13  import org.json.JSONObject;
14  import org.junit.Before;
15  import org.junit.BeforeClass;
16  import org.junit.Test;
17  import redis.clients.jedis.exceptions.JedisDataException;
18  import redis.clients.jedis.json.JsonSetParams;
19  import redis.clients.jedis.json.Path2;
20  import redis.clients.jedis.json.commands.RedisJsonV2Commands;
21  import redis.clients.jedis.modules.RedisModuleCommandsTestBase;
22  public class RedisJsonV2Test extends RedisModuleCommandsTestBase {
23    private static final Gson gson = new Gson();
24    private RedisJsonV2Commands jsonClient;
25    @BeforeClass
26    public static void prepare() {
27      RedisModuleCommandsTestBase.prepare();
28    }
29    @Before
30    @Override
31    public void setUp() {
32      super.setUp();
33      this.jsonClient = super.client;
34    }
35    @Test
36    public void basicSetGetShouldSucceed() {
37      jsonClient.jsonSetWithEscape("null", ROOT_PATH, (Object) null);
38      assertJsonArrayEquals(jsonArray((Object) null), jsonClient.jsonGet("null", ROOT_PATH));
39      jsonClient.jsonSetWithEscape("str", "strong");
40      assertEquals("strong", jsonClient.jsonGet("str"));
41      IRLObject obj = new IRLObject();
42      jsonClient.jsonSetWithEscape("obj", obj);
43      Object expected = gson.fromJson(gson.toJson(obj), Object.class);
44      assertTrue(expected.equals(jsonClient.jsonGet("obj")));
45      Path2 p = Path2.of(".str");
46      jsonClient.jsonSet("obj", p, gson.toJson("strung"));
47      assertJsonArrayEquals(jsonArray("strung"), jsonClient.jsonGet("obj", p));
48    }
49    @Test
50    public void setExistingPathOnlyIfExistsShouldSucceed() {
51      jsonClient.jsonSetWithEscape("obj", new IRLObject());
52      Path2 p = Path2.of(".str");
53      jsonClient.jsonSetWithEscape("obj", p, "strangle", JsonSetParams.jsonSetParams().xx());
54      assertJsonArrayEquals(jsonArray("strangle"), jsonClient.jsonGet("obj", p));
55    }
56    @Test
57    public void setNonExistingOnlyIfNotExistsShouldSucceed() {
58      jsonClient.jsonSet("obj", gson.toJson(new IRLObject()));
59      Path2 p = Path2.of(".none");
60      jsonClient.jsonSet("obj", p, gson.toJson("strangle"), JsonSetParams.jsonSetParams().nx());
61      assertJsonArrayEquals(jsonArray("strangle"), jsonClient.jsonGet("obj", p));
62    }
63    @Test
64    public void setWithoutAPathDefaultsToRootPath() {
65      String objStr = gson.toJson(new IRLObject());
66      jsonClient.jsonSet("obj1", new JSONObject(objStr));
67      jsonClient.jsonSetWithEscape("obj1", (Object) "strangle", JsonSetParams.jsonSetParams().xx());
68      assertJsonArrayEquals(jsonArray("strangle"), jsonClient.jsonGet("obj1", ROOT_PATH));
69    }
70    @Test
71    public void setExistingPathOnlyIfNotExistsShouldFail() {
72      jsonClient.jsonSetWithEscape("obj", new IRLObject());
73      Path2 p = Path2.of(".str");
74      assertNull(jsonClient.jsonSetWithEscape("obj", p, "strangle", JsonSetParams.jsonSetParams().nx()));
75    }
76    @Test
77    public void setNonExistingPathOnlyIfExistsShouldFail() {
78      jsonClient.jsonSetWithEscape("obj", new IRLObject());
79      Path2 p = Path2.of(".none");
80      assertNull(jsonClient.jsonSetWithEscape("obj", p, "strangle", JsonSetParams.jsonSetParams().xx()));
81    }
82    @Test(expected = JedisDataException.class)
83    public void setException() {
84      jsonClient.jsonSet("test", Path2.of(".foo"), "bar");
85    }
86    @Test
87    public void getMultiplePathsShouldSucceed() {
88      IRLObject obj = new IRLObject();
89      jsonClient.jsonSetWithEscape("obj", obj);
90      JSONObject result = (JSONObject) jsonClient.jsonGet("obj", Path2.of("bool"), Path2.of("str"));
91      assertJsonArrayEquals(jsonArray(true), result.get("$.bool"));
92      assertJsonArrayEquals(jsonArray("string"), result.get("$.str"));
93    }
94    @Test
95    public void getMultiLevels() {
96      JSONObject obj = new JSONObject();
97      obj.put("foo", "John");
98      JSONObject inner = new JSONObject();
99      inner.put("foo", "Jane");
100      obj.put("bar", inner);
101      jsonClient.jsonSet("multi", obj);
102      assertJsonArrayEquals(jsonArray("John", "Jane"), jsonClient.jsonGet("multi", new Path2("..foo")));
103    }
104    @Test
105    public void toggle() {
106      IRLObject obj = new IRLObject();
107      jsonClient.jsonSetWithEscape("obj", obj);
108      Path2 pbool = Path2.of(".bool");
109      assertJsonArrayEquals(jsonArray(true), jsonClient.jsonGet("obj", pbool));
110      jsonClient.jsonToggle("obj", pbool);
111      assertJsonArrayEquals(jsonArray(false), jsonClient.jsonGet("obj", pbool));
112      jsonClient.jsonToggle("obj", pbool);
113      assertJsonArrayEquals(jsonArray(true), jsonClient.jsonGet("obj", pbool));
114      Path2 pstr = Path2.of(".str");
115      assertEquals(singletonList(null), jsonClient.jsonToggle("obj", pstr));
116      assertJsonArrayEquals(jsonArray("string"), jsonClient.jsonGet("obj", pstr));
117    }
118    @Test
119    public void getAbsent() {
120      jsonClient.jsonSetWithEscape("test", ROOT_PATH, "foo");
121      assertJsonArrayEquals(jsonArray(), jsonClient.jsonGet("test", Path2.of(".bar")));
122    }
123    @Test
124    public void delValidShouldSucceed() {
125      jsonClient.jsonSetWithEscape("obj", ROOT_PATH, new IRLObject());
126      assertEquals(1L, jsonClient.jsonDel("obj", Path2.of(".str")));
127      assertTrue(client.exists("obj"));
128      assertEquals(1L, jsonClient.jsonDel("obj"));
129      assertFalse(client.exists("obj"));
130    }
131    @Test
132    public void delNonExistingPathsAreIgnored() {
133      jsonClient.jsonSetWithEscape("foobar", ROOT_PATH, new FooBarObject());
134      assertEquals(0L, jsonClient.jsonDel("foobar", Path2.of(".foo[1]")));
135    }
136    @Test
137    public void typeChecksShouldSucceed() {
138      jsonClient.jsonSet("foobar", ROOT_PATH, new JSONObject(gson.toJson(new FooBarObject())));
139      assertEquals(singletonList(Object.class), jsonClient.jsonType("foobar", ROOT_PATH));
140      assertEquals(singletonList(String.class), jsonClient.jsonType("foobar", Path2.of(".foo")));
141      assertEquals(singletonList(int.class), jsonClient.jsonType("foobar", Path2.of(".fooI")));
142      assertEquals(singletonList(float.class), jsonClient.jsonType("foobar", Path2.of(".fooF")));
143      assertEquals(singletonList(List.class), jsonClient.jsonType("foobar", Path2.of(".fooArr")));
144      assertEquals(singletonList(boolean.class), jsonClient.jsonType("foobar", Path2.of(".fooB")));
145      assertEquals(Collections.emptyList(), jsonClient.jsonType("foobar", Path2.of(".fooErr")));
146    }
147    @Test
148    public void testJsonMerge() {
149      JSONObject json = new JSONObject("{\"person\":{\"name\":\"John Doe\",\"age\":25,\"address\":{\"home\":\"123 Main Street\"},\"phone\":\"123-456-7890\"}}");
150      assertEquals("OK", jsonClient.jsonSet("test_merge", json));
151      json = new JSONObject("{\"person\":{\"name\":\"John Doe\",\"age\":30,\"address\":{\"home\":\"123 Main Street\"},\"phone\":\"123-456-7890\"}}");
152      assertEquals("OK", jsonClient.jsonMerge("test_merge", Path2.of("$"), "{\"person\":{\"age\":30}}"));
153      assertJsonArrayEquals(jsonArray(json), jsonClient.jsonGet("test_merge", Path2.of("$")));
154      assertEquals("OK", jsonClient.jsonMerge("test_merge", Path2.of("$.person.address"), "{\"work\":\"Redis office\"}"));
155      json = new JSONObject("{\"person\":{\"name\":\"John Doe\",\"age\":30,\"address\":{\"home\":\"123 Main Street\",\"work\":\"Redis office\"},\"phone\":\"123-456-7890\"}}");
156      assertJsonArrayEquals(jsonArray(json), jsonClient.jsonGet("test_merge", Path2.of("$")));
157      assertEquals("OK", jsonClient.jsonMerge("test_merge", Path2.of("$.person"), "{\"age\":null}"));
158      json = new JSONObject("{\"person\":{\"name\":\"John Doe\",\"address\":{\"home\":\"123 Main Street\",\"work\":\"Redis office\"},\"phone\":\"123-456-7890\"}}");
159      assertJsonArrayEquals(jsonArray(json), jsonClient.jsonGet("test_merge", Path2.of("$")));
160      assertEquals(1L, client.del("test_merge"));
161    }
162    @Test
163    public void testJsonMergeArray()
164    {
165      JSONObject json = new JSONObject("{\"a\":{\"b\":{\"c\":[\"d\",\"e\"]}}}");
166      assertEquals("OK", jsonClient.jsonSet("test_merge_array", Path2.of("$"), json));
167      assertEquals("OK", jsonClient.jsonMerge("test_merge_array", Path2.of("$.a.b.c"), "[\"f\"]"));
168      json = new JSONObject("{\"a\":{\"b\":{\"c\":[\"f\"]}}}");
169      assertJsonArrayEquals(jsonArray(json), jsonClient.jsonGet("test_merge_array", Path2.of("$")));
170      assertEquals("OK", jsonClient.jsonSet("test_merge_array", Path2.of("$"), "{\"a\":{\"b\":{\"c\":\"d\"}}}"));
171      assertEquals("OK", jsonClient.jsonMerge("test_merge_array", Path2.of("$.a.b.c"), "[\"f\"]"));
172      json = new JSONObject("{\"a\":{\"b\":{\"c\":[\"f\"]}}}");
173      assertJsonArrayEquals(jsonArray(json), jsonClient.jsonGet("test_merge_array", Path2.of("$")));
174      assertEquals("OK", jsonClient.jsonSet("test_merge_array", Path2.of("$"), "{\"a\":{\"b\":{\"c\":[\"d\",\"e\"]}}}"));
175      assertEquals("OK", jsonClient.jsonMerge("test_merge_array", Path2.of("$.a.b"), "{\"c\":null}"));
176      json = new JSONObject("{\"a\":{\"b\":{}}}");
177      assertJsonArrayEquals(jsonArray(json), jsonClient.jsonGet("test_merge_array", Path2.of("$")));
178    }
179    @Test
180    public void mgetWithPathWithAllKeysExist() {
181      Baz baz1 = new Baz("quuz1", "grault1", "waldo1");
182      Baz baz2 = new Baz("quuz2", "grault2", "waldo2");
183      Qux qux1 = new Qux("quux1", "corge1", "garply1", baz1);
184      Qux qux2 = new Qux("quux2", "corge2", "garply2", baz2);
185      jsonClient.jsonSet("qux1", new JSONObject(gson.toJson(qux1)));
186      jsonClient.jsonSet("qux2", new JSONObject(gson.toJson(qux2)));
187      List<JSONArray> list = jsonClient.jsonMGet(Path2.of("baz"), "qux1", "qux2");
188      assertEquals(2, list.size());
189      assertJsonArrayEquals(jsonArray(new JSONObject(gson.toJson(baz1))), list.get(0));
190      assertJsonArrayEquals(jsonArray(new JSONObject(gson.toJson(baz2))), list.get(1));
191    }
192    @Test
193    public void mgetAtRootPathWithMissingKeys() {
194      Baz baz1 = new Baz("quuz1", "grault1", "waldo1");
195      Baz baz2 = new Baz("quuz2", "grault2", "waldo2");
196      Qux qux1 = new Qux("quux1", "corge1", "garply1", baz1);
197      Qux qux2 = new Qux("quux2", "corge2", "garply2", baz2);
198      jsonClient.jsonSetWithEscape("qux1", qux1);
199      jsonClient.jsonSetWithEscape("qux2", qux2);
200      List<JSONArray> list = jsonClient.jsonMGet("qux1", "qux2", "qux3");
201      assertEquals(3, list.size());
202      assertNull(list.get(2));
203      list.removeAll(singletonList(null));
204      assertEquals(2, list.size());
205    }
206    @Test
207    public void arrLen() {
208      jsonClient.jsonSet("arr", ROOT_PATH, new JSONArray(new int[]{0, 1, 2, 3, 4}));
209      assertEquals(singletonList(5L), jsonClient.jsonArrLen("arr", ROOT_PATH));
210    }
211    @Test
212    public void clearArray() {
213      jsonClient.jsonSet("foobar", ROOT_PATH, gson.toJson(new FooBarObject()));
214      Path2 arrPath = Path2.of(".fooArr");
215      assertEquals(singletonList(3L), jsonClient.jsonArrLen("foobar", arrPath));
216      assertEquals(1L, jsonClient.jsonClear("foobar", arrPath));
217      assertEquals(singletonList(0L), jsonClient.jsonArrLen("foobar", arrPath));
218      Path2 strPath = Path2.of(".foo");
219      assertEquals(0L, jsonClient.jsonClear("foobar", strPath));
220      assertJsonArrayEquals(jsonArray("bar"), jsonClient.jsonGet("foobar", strPath));
221    }
222    @Test
223    public void clearObject() {
224      Baz baz = new Baz("quuz", "grault", "waldo");
225      Qux qux = new Qux("quux", "corge", "garply", baz);
226      jsonClient.jsonSet("qux", gson.toJson(qux));
227      Path2 objPath = Path2.of(".baz");
228      assertEquals(1L, jsonClient.jsonClear("qux", objPath));
229      assertJsonArrayEquals(jsonArray(new JSONObject()), jsonClient.jsonGet("qux", objPath));
230    }
231    @Test
232    public void arrAppendSameType() {
233      String json = "{ a: 'hello', b: [1, 2, 3], c: { d: ['ello'] }}";
234      jsonClient.jsonSet("test_arrappend", ROOT_PATH, new JSONObject(json));
235      assertEquals(singletonList(6L), jsonClient.jsonArrAppend("test_arrappend", Path2.of(".b"), 4, 5, 6));
236      assertJsonArrayEquals(jsonArray(jsonArray(1, 2, 3, 4, 5, 6)), jsonClient.jsonGet("test_arrappend", Path2.of(".b")));
237    }
238    @Test
239    public void arrAppendMultipleTypes() {
240      Object fooObject = gson.toJson("foo");
241      Object trueObject = gson.toJson(true);
242      Object nullObject = gson.toJson(null);
243      String json = "{ a: 'hello', b: [1, 2, 3], c: { d: ['ello'] }}";
244      jsonClient.jsonSet("test_arrappend", ROOT_PATH, new JSONObject(json));
245      assertEquals(singletonList(6L), jsonClient.jsonArrAppend("test_arrappend", Path2.of(".b"), fooObject, trueObject, nullObject));
246      assertJsonArrayEquals(jsonArray(jsonArray(1, 2, 3, "foo", true, null)), jsonClient.jsonGet("test_arrappend", Path2.of(".b")));
247    }
248    @Test
249    public void arrAppendMultipleTypesWithDeepPath() {
250      String json = "{ a: 'hello', b: [1, 2, 3], c: { d: ['ello'] }}";
251      jsonClient.jsonSet("test_arrappend", ROOT_PATH, new JSONObject(json));
252      assertEquals(singletonList(4L), jsonClient.jsonArrAppendWithEscape("test_arrappend", Path2.of(".c.d"), "foo", true, null));
253      assertJsonArrayEquals(jsonArray(jsonArray("ello", "foo", true, null)), jsonClient.jsonGet("test_arrappend", Path2.of(".c.d")));
254    }
255    @Test
256    public void arrAppendAgaintsEmptyArray() {
257      String json = "{ a: 'hello', b: [1, 2, 3], c: { d: [] }}";
258      jsonClient.jsonSet("test_arrappend", ROOT_PATH, new JSONObject(json));
259      assertEquals(singletonList(3L), jsonClient.jsonArrAppendWithEscape("test_arrappend", Path2.of(".c.d"), "a", "b", "c"));
260      assertJsonArrayEquals(jsonArray(jsonArray("a", "b", "c")), jsonClient.jsonGet("test_arrappend", Path2.of(".c.d")));
261    }
262    @Test
263    public void arrAppendPathIsNotArray() {
264      String json = "{ a: 'hello', b: [1, 2, 3], c: { d: ['ello'] }}";
265      jsonClient.jsonSet("test_arrappend", ROOT_PATH, new JSONObject(json));
266      assertEquals(singletonList(null), jsonClient.jsonArrAppend("test_arrappend", Path2.of(".a"), 1));
267      assertEquals(singletonList(null), jsonClient.jsonArrAppend("test_arrappend", Path2.of(".a"), gson.toJson(1)));
268      assertEquals(singletonList(null), jsonClient.jsonArrAppendWithEscape("test_arrappend", Path2.of(".a"), 1));
269    }
270    @Test(expected = JedisDataException.class)
271    public void arrIndexAbsentKey() {
272      jsonClient.jsonArrIndexWithEscape("quxquux", ROOT_PATH, new JSONObject());
273    }
274    @Test
275    public void arrIndexWithInts() {
<span onclick='openModal()' class='match'>276      jsonClient.jsonSetWithEscape("quxquux", ROOT_PATH, new int[]{8, 6, 7, 5, 3, 0, 9});
277      assertEquals(singletonList(2L), jsonClient.jsonArrIndexWithEscape("quxquux", ROOT_PATH, 7));
</span>278      assertEquals(singletonList(-1L), jsonClient.jsonArrIndexWithEscape("quxquux", ROOT_PATH, "7"));
279    }
280    @Test
281    public void arrIndexWithStrings() {
282      jsonClient.jsonSetWithEscape("quxquux", ROOT_PATH, new String[]{"8", "6", "7", "5", "3", "0", "9"});
283      assertEquals(singletonList(2L), jsonClient.jsonArrIndexWithEscape("quxquux", ROOT_PATH, "7"));
284    }
285    @Test
286    public void arrIndexWithStringsAndPath() {
287      jsonClient.jsonSetWithEscape("foobar", ROOT_PATH, new FooBarObject());
288      assertEquals(singletonList(1L), jsonClient.jsonArrIndexWithEscape("foobar", Path2.of(".fooArr"), "b"));
289    }
290    @Test
291    public void arrIndexNonExistentPath() {
292      jsonClient.jsonSet("foobar", ROOT_PATH, gson.toJson(new FooBarObject()));
293      assertEquals(Collections.emptyList(), jsonClient.jsonArrIndex("foobar", Path2.of(".barArr"), gson.toJson("x")));
294    }
295    @Test
296    public void arrInsert() {
297      String json = "['hello', 'world', true, 1, 3, null, false]";
298      jsonClient.jsonSet("test_arrinsert", ROOT_PATH, new JSONArray(json));
299      assertEquals(singletonList(8L), jsonClient.jsonArrInsertWithEscape("test_arrinsert", ROOT_PATH, 1, "foo"));
300      assertJsonArrayEquals(jsonArray(jsonArray("hello", "foo", "world", true, 1, 3, null, false)),
301          jsonClient.jsonGet("test_arrinsert", ROOT_PATH));
302    }
303    @Test
304    public void arrInsertWithNegativeIndex() {
305      String json = "['hello', 'world', true, 1, 3, null, false]";
306      jsonClient.jsonSet("test_arrinsert", ROOT_PATH, new JSONArray(json));
307      assertEquals(singletonList(8L), jsonClient.jsonArrInsertWithEscape("test_arrinsert", ROOT_PATH, -1, "foo"));
308      assertJsonArrayEquals(jsonArray(jsonArray("hello", "world", true, 1, 3, null, "foo", false)),
309          jsonClient.jsonGet("test_arrinsert", ROOT_PATH));
310    }
311    @Test
312    public void arrPop() {
313      jsonClient.jsonSet("arr", ROOT_PATH, new JSONArray(new int[]{0, 1, 2, 3, 4}));
314      assertEquals(singletonList(4d), jsonClient.jsonArrPop("arr", ROOT_PATH));
315      assertEquals(singletonList(3d), jsonClient.jsonArrPop("arr", ROOT_PATH, -1));
316      assertEquals(singletonList(0d), jsonClient.jsonArrPop("arr", ROOT_PATH, 0));
317    }
318    @Test
319    public void arrTrim() {
320      jsonClient.jsonSet("arr", ROOT_PATH, new JSONArray(new int[]{0, 1, 2, 3, 4}));
321      assertEquals(singletonList(3L), jsonClient.jsonArrTrim("arr", ROOT_PATH, 1, 3));
322      assertJsonArrayEquals(jsonArray(jsonArray(1, 2, 3)), jsonClient.jsonGet("arr", ROOT_PATH));
323    }
324    @Test
325    public void strAppend() {
326      jsonClient.jsonSet("str", ROOT_PATH, gson.toJson("foo"));
327      assertEquals(singletonList(6L), jsonClient.jsonStrAppend("str", ROOT_PATH, "bar"));
328      assertEquals("foobar", jsonClient.jsonGet("str"));
329    }
330    @Test
331    public void strLen() {
332      jsonClient.jsonSetWithEscape("str", "foobar");
333      assertEquals(singletonList(6L), jsonClient.jsonStrLen("str", ROOT_PATH));
334    }
335    @Test
336    public void numIncrBy() {
337      jsonClient.jsonSet("doc", "{\"a\":\"b\",\"b\":[{\"a\":2}, {\"a\":5}, {\"a\":\"c\"}]}");
338      assertJsonArrayEquals(jsonArray((Object) null), jsonClient.jsonNumIncrBy("doc", Path2.of(".a"), 1d));
339      assertJsonArrayEquals(jsonArray(null, 4, 7, null), jsonClient.jsonNumIncrBy("doc", Path2.of("..a"), 2d));
340      assertJsonArrayEquals(jsonArray((Object) null), jsonClient.jsonNumIncrBy("doc", Path2.of("..b"), 0d));
341      assertJsonArrayEquals(jsonArray(), jsonClient.jsonNumIncrBy("doc", Path2.of("..c"), 0d));
342    }
343    @Test
344    public void obj() {
345      String json = "{\"a\":[3], \"nested\": {\"a\": {\"b\":2, \"c\": 1}}}";
346      jsonClient.jsonSet("doc", ROOT_PATH, json);
347      assertEquals(Arrays.asList(2L), jsonClient.jsonObjLen("doc", ROOT_PATH));
348      assertEquals(Arrays.asList(Arrays.asList("a", "nested")), jsonClient.jsonObjKeys("doc", ROOT_PATH));
349      assertEquals(Arrays.asList(null, 2L), jsonClient.jsonObjLen("doc", Path2.of("..a")));
350      assertEquals(Arrays.asList(null, Arrays.asList("b", "c")), jsonClient.jsonObjKeys("doc", Path2.of("..a")));
351    }
352    @Test
353    public void debugMemory() {
354      assertEquals(Collections.emptyList(), jsonClient.jsonDebugMemory("json", ROOT_PATH));
355      jsonClient.jsonSet("json", new JSONObject("{ foo: 'bar', bar: { foo: 10 }}"));
356      assertEquals(1, jsonClient.jsonDebugMemory("json", ROOT_PATH).size());
357      assertEquals(2, jsonClient.jsonDebugMemory("json", Path2.of("$..foo")).size());
358      assertEquals(1, jsonClient.jsonDebugMemory("json", Path2.of("$..bar")).size());
359    }
360    @Test
361    public void resp() {
362      assertNull(jsonClient.jsonResp("resp", ROOT_PATH));
363      String json = "{\"foo\": {\"hello\":\"world\"}, \"bar\": [null, 3, 2.5, true]}";
364      jsonClient.jsonSet("resp", ROOT_PATH, json);
365      List<List<Object>> fullResp = jsonClient.jsonResp("resp", ROOT_PATH);
366      assertEquals(1, fullResp.size());
367      List<Object> resp = fullResp.get(0);
368      assertEquals("{", resp.get(0));
369      assertEquals("foo", resp.get(1));
370      assertEquals(Arrays.asList("{", "hello", "world"), resp.get(2));
371      assertEquals("bar", resp.get(3));
372      List<Object> arr = (List<Object>) resp.get(4);
373      assertEquals("[", arr.get(0));
374      assertNull(arr.get(1));
375      assertEquals(Long.valueOf(3), arr.get(2));
376      MatcherAssert.assertThat(arr.get(3), Matchers.isOneOf("2.5", 2.5));
377      assertEquals("true", arr.get(4));
378    }
379    private void assertJsonArrayEquals(JSONArray a, Object _b) {
380      if (!(_b instanceof JSONArray)) {
381        fail("Actual value is not JSONArray.");
382      }
383      JSONArray b = (JSONArray) _b;
384      assertEquals("JSONArray length mismatch", a.length(), b.length());
385      int length = a.length();
386      for (int index = 0; index < length; index++) {
387        if (a.isNull(index)) {
388          assertTrue(index + "'th element is not null", b.isNull(index));
389          continue;
390        }
391        Object ia = a.get(index);
392        Object ib = b.get(index);
393        if (ia instanceof JSONArray) {
394          assertJsonArrayEquals((JSONArray) ia, ib);
395        } else if (ia instanceof JSONObject) {
396          assertJsonObjectEquals((JSONObject) ia, ib);
397        } else if (ia instanceof Number && ib instanceof Number) {
398          assertEquals(index + "'th element mismatch", ((Number) ia).doubleValue(), ((Number) ib).doubleValue(), 0d);
399        } else {
400          assertEquals(index + "'th element mismatch", ia, ib);
401        }
402      }
403    }
404    private void assertJsonObjectEquals(JSONObject a, Object _b) {
405      if (!(_b instanceof JSONObject)) {
406        fail("Actual value is not JSONObject.");
407      }
408      JSONObject b = (JSONObject) _b;
409      assertEquals("JSONObject length mismatch", a.length(), b.length());
410      assertEquals(a.keySet(), b.keySet());
411      for (String key : a.keySet()) {
412        if (a.isNull(key)) {
413          assertTrue(key + "'s value is not null", b.isNull(key));
414          continue;
415        }
416        Object oa = a.get(key);
417        Object ob = b.get(key);
418        if (oa instanceof JSONArray) {
419          assertJsonArrayEquals((JSONArray) oa, ob);
420        } else if (oa instanceof JSONObject) {
421          assertJsonObjectEquals((JSONObject) oa, ob);
422        } else {
423          assertEquals(key + "'s value mismatch", oa, ob);
424        }
425      }
426    }
427    private static JSONArray jsonArray(Object... objects) {
428      JSONArray arr = new JSONArray();
429      for (Object o : objects) {
430        arr.put(o);
431      }
432      return arr;
433    }
434  }
</code></pre>
        </div>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-RedisJsonV1Test.java</h3>
            <pre><code>1  package redis.clients.jedis.modules.json;
2  import static org.junit.Assert.*;
3  import static redis.clients.jedis.json.Path.ROOT_PATH;
4  import static redis.clients.jedis.modules.json.JsonObjects.*;
5  import com.google.gson.Gson;
6  import com.google.gson.JsonArray;
7  import com.google.gson.JsonObject;
8  import java.time.Instant;
9  import java.util.ArrayList;
10  import java.util.Arrays;
11  import java.util.Collections;
12  import java.util.List;
13  import org.hamcrest.MatcherAssert;
14  import org.hamcrest.Matchers;
15  import org.junit.Before;
16  import org.junit.BeforeClass;
17  import org.junit.Test;
18  import redis.clients.jedis.exceptions.JedisDataException;
19  import redis.clients.jedis.json.JsonSetParams;
20  import redis.clients.jedis.json.Path;
21  import redis.clients.jedis.json.commands.RedisJsonV1Commands;
22  import redis.clients.jedis.modules.RedisModuleCommandsTestBase;
23  import redis.clients.jedis.util.JsonObjectMapperTestUtil;
24  public class RedisJsonV1Test extends RedisModuleCommandsTestBase {
25    private final Gson gson = new Gson();
26    private RedisJsonV1Commands jsonClient;
27    @BeforeClass
28    public static void prepare() {
29      RedisModuleCommandsTestBase.prepare();
30    }
31    @Before
32    @Override
33    public void setUp() {
34      super.setUp();
35      this.jsonClient = super.client;
36    }
37    @Test
38    public void basicSetGetShouldSucceed() {
39      jsonClient.jsonSet("null", ROOT_PATH, (Object) null);
40      assertNull(client.jsonGet("null", String.class, ROOT_PATH));
41      jsonClient.jsonSet("str", ROOT_PATH, "strong");
42      assertEquals("strong", jsonClient.jsonGet("str"));
43      IRLObject obj = new IRLObject();
44      jsonClient.jsonSet("obj", ROOT_PATH, obj);
45      Object expected = gson.fromJson(gson.toJson(obj), Object.class);
46      assertTrue(expected.equals(client.jsonGet("obj")));
47      Path p = Path.of(".str");
48      jsonClient.jsonSet("obj", p, "strung");
49      assertEquals("strung", jsonClient.jsonGet("obj", String.class, p));
50    }
51    @Test
52    public void setExistingPathOnlyIfExistsShouldSucceed() {
53      jsonClient.jsonSet("obj", ROOT_PATH, new IRLObject());
54      Path p = Path.of(".str");
55      jsonClient.jsonSet("obj", p, "strangle", JsonSetParams.jsonSetParams().xx());
56      assertEquals("strangle", jsonClient.jsonGet("obj", String.class, p));
57    }
58    @Test
59    public void setNonExistingOnlyIfNotExistsShouldSucceed() {
60      jsonClient.jsonSet("obj", ROOT_PATH, new IRLObject());
61      Path p = Path.of(".none");
62      jsonClient.jsonSet("obj", p, "strangle", JsonSetParams.jsonSetParams().nx());
63      assertEquals("strangle", jsonClient.jsonGet("obj", String.class, p));
64    }
65    @Test
66    public void setWithoutAPathDefaultsToRootPath() {
67      jsonClient.jsonSet("obj1", ROOT_PATH, new IRLObject());
68      jsonClient.jsonSetLegacy("obj1", (Object) "strangle", JsonSetParams.jsonSetParams().xx());
69      assertEquals("strangle", jsonClient.jsonGet("obj1", String.class, ROOT_PATH));
70    }
71    @Test
72    public void setExistingPathOnlyIfNotExistsShouldFail() {
73      jsonClient.jsonSet("obj", ROOT_PATH, new IRLObject());
74      Path p = Path.of(".str");
75      assertNull(client.jsonSet("obj", p, "strangle", JsonSetParams.jsonSetParams().nx()));
76    }
77    @Test
78    public void setNonExistingPathOnlyIfExistsShouldFail() {
79      jsonClient.jsonSet("obj", ROOT_PATH, new IRLObject());
80      Path p = Path.of(".none");
81      assertNull(client.jsonSet("obj", p, "strangle", JsonSetParams.jsonSetParams().xx()));
82    }
83    @Test(expected = JedisDataException.class)
84    public void setException() {
85      jsonClient.jsonSet("test", Path.of(".foo"), "bar");
86    }
87    @Test
88    public void getMultiplePathsShouldSucceed() {
89      IRLObject obj = new IRLObject();
90      jsonClient.jsonSetLegacy("obj", obj);
91      Object expected = gson.fromJson(gson.toJson(obj), Object.class);
92      assertTrue(expected.equals(client.jsonGet("obj", Object.class, Path.of("bool"), Path.of("str"))));
93    }
94    @Test
95    public void getMultiplePathsShouldSucceedWithLegacy() {
96      IRLObject obj = new IRLObject();
97      jsonClient.jsonSetLegacy("obj", obj);
98      Object expected = gson.fromJson(gson.toJson(obj), Object.class);
99      assertTrue(expected.equals(client.jsonGet("obj", Object.class, Path.of("bool"), Path.of("str"))));
100    }
101    @Test
102    public void toggle() {
103      IRLObject obj = new IRLObject();
104      jsonClient.jsonSetLegacy("obj", obj);
105      Path pbool = Path.of(".bool");
106      assertTrue(client.jsonGet("obj", Boolean.class, pbool));
107      jsonClient.jsonToggle("obj", pbool);
108      assertFalse(client.jsonGet("obj", Boolean.class, pbool));
109      jsonClient.jsonToggle("obj", pbool);
110      assertTrue(client.jsonGet("obj", Boolean.class, pbool));
111      Path pstr = Path.of(".str");
112      try {
113        jsonClient.jsonToggle("obj", pstr);
114        fail("String not a bool");
115      } catch (JedisDataException jde) {
116        assertTrue(jde.getMessage().contains("not a bool"));
117      }
118      assertEquals("string", jsonClient.jsonGet("obj", String.class, pstr));
119    }
120    @Test(expected = JedisDataException.class)
121    public void getAbsent() {
122      jsonClient.jsonSet("test", ROOT_PATH, "foo");
123      jsonClient.jsonGet("test", String.class, Path.of(".bar"));
124    }
125    @Test
126    public void delValidShouldSucceed() {
127      jsonClient.jsonSet("obj", ROOT_PATH, new IRLObject());
128      assertEquals(1L, jsonClient.jsonDel("obj", Path.of(".str")));
129      assertTrue(client.exists("obj"));
130      assertEquals(1L, jsonClient.jsonDel("obj"));
131      assertFalse(client.exists("obj"));
132    }
133    @Test
134    public void delNonExistingPathsAreIgnored() {
135      jsonClient.jsonSet("foobar", ROOT_PATH, new FooBarObject());
136      assertEquals(0L, jsonClient.jsonDel("foobar", Path.of(".foo[1]")));
137    }
138    @Test
139    public void typeChecksShouldSucceed() {
140      assertNull(client.jsonType("foobar"));
141      jsonClient.jsonSet("foobar", ROOT_PATH, new FooBarObject());
142      assertSame(Object.class, jsonClient.jsonType("foobar"));
143      assertSame(Object.class, jsonClient.jsonType("foobar", ROOT_PATH));
144      assertSame(String.class, jsonClient.jsonType("foobar", Path.of(".foo")));
145      assertSame(int.class, jsonClient.jsonType("foobar", Path.of(".fooI")));
146      assertSame(float.class, jsonClient.jsonType("foobar", Path.of(".fooF")));
147      assertSame(List.class, jsonClient.jsonType("foobar", Path.of(".fooArr")));
148      assertSame(boolean.class, jsonClient.jsonType("foobar", Path.of(".fooB")));
149      assertNull(client.jsonType("foobar", Path.of(".fooErr")));
150    }
151    @Test
152    public void testJsonMerge() {
153      List<String> childrens = new ArrayList<>();
154      childrens.add("Child 1");
155      Person person = new Person("John Doe", 25, "123 Main Street", "123-456-7890", childrens);
156      assertEquals("OK", jsonClient.jsonSet("test_merge", ROOT_PATH, person));
157      person.age = 30;
158      person.childrens.add("Child 2");
159      person.childrens.add("Child 3");
160      assertEquals("OK", jsonClient.jsonMerge("test_merge", Path.of((".childrens")), person.childrens));
161      assertEquals("OK", jsonClient.jsonMerge("test_merge", Path.of((".age")), person.age));
162      assertEquals(person, jsonClient.jsonGet("test_merge", Person.class));
163    }
164    @Test
165    public void mgetWithPathWithAllKeysExist() {
166      Baz baz1 = new Baz("quuz1", "grault1", "waldo1");
167      Baz baz2 = new Baz("quuz2", "grault2", "waldo2");
168      Qux qux1 = new Qux("quux1", "corge1", "garply1", baz1);
169      Qux qux2 = new Qux("quux2", "corge2", "garply2", baz2);
170      jsonClient.jsonSetLegacy("qux1", qux1);
171      jsonClient.jsonSetLegacy("qux2", qux2);
172      List<Baz> allBaz = jsonClient.jsonMGet(Path.of("baz"), Baz.class, "qux1", "qux2");
173      assertEquals(2, allBaz.size());
174      Baz testBaz1 = allBaz.stream() 
175          .filter(b -> b.quuz.equals("quuz1")) 
176          .findFirst() 
177          .orElseThrow(() -> new NullPointerException(""));
178      Baz testBaz2 = allBaz.stream() 
179          .filter(q -> q.quuz.equals("quuz2")) 
180          .findFirst() 
181          .orElseThrow(() -> new NullPointerException(""));
182      assertEquals(baz1, testBaz1);
183      assertEquals(baz2, testBaz2);
184    }
185    @Test
186    public void mgetAtRootPathWithMissingKeys() {
187      Baz baz1 = new Baz("quuz1", "grault1", "waldo1");
188      Baz baz2 = new Baz("quuz2", "grault2", "waldo2");
189      Qux qux1 = new Qux("quux1", "corge1", "garply1", baz1);
190      Qux qux2 = new Qux("quux2", "corge2", "garply2", baz2);
191      jsonClient.jsonSetLegacy("qux1", qux1);
192      jsonClient.jsonSetLegacy("qux2", qux2);
193      List<Qux> allQux = jsonClient.jsonMGet(Qux.class, "qux1", "qux2", "qux3");
194      assertEquals(3, allQux.size());
195      assertNull(allQux.get(2));
196      allQux.removeAll(Collections.singleton(null));
197      assertEquals(2, allQux.size());
198    }
199    @Test
200    public void arrLen() {
201      jsonClient.jsonSet("foobar", ROOT_PATH, new FooBarObject());
202      assertEquals(Long.valueOf(3), jsonClient.jsonArrLen("foobar", Path.of(".fooArr")));
203    }
204    @Test
205    public void arrLenDefaultPath() {
206      assertNull(client.jsonArrLen("array"));
207      jsonClient.jsonSetLegacy("array", new int[]{1, 2, 3});
208      assertEquals(Long.valueOf(3), jsonClient.jsonArrLen("array"));
209    }
210    @Test
211    public void clearArray() {
212      jsonClient.jsonSet("foobar", ROOT_PATH, new FooBarObject());
213      Path arrPath = Path.of(".fooArr");
214      assertEquals(Long.valueOf(3), jsonClient.jsonArrLen("foobar", arrPath));
215      assertEquals(1L, jsonClient.jsonClear("foobar", arrPath));
216      assertEquals(Long.valueOf(0), jsonClient.jsonArrLen("foobar", arrPath));
217      Path strPath = Path.of("foo");
218      assertEquals(0L, jsonClient.jsonClear("foobar", strPath));
219      assertEquals("bar", jsonClient.jsonGet("foobar", String.class, strPath));
220    }
221    @Test
222    public void clearObject() {
223      Baz baz = new Baz("quuz", "grault", "waldo");
224      Qux qux = new Qux("quux", "corge", "garply", baz);
225      jsonClient.jsonSetLegacy("qux", qux);
226      Path objPath = Path.of("baz");
227      assertEquals(baz, jsonClient.jsonGet("qux", Baz.class, objPath));
228      assertEquals(1L, jsonClient.jsonClear("qux", objPath));
229      assertEquals(new Baz(null, null, null), jsonClient.jsonGet("qux", Baz.class, objPath));
230    }
231    @Test
232    public void arrAppendSameType() {
233      String json = "{ a: 'hello', b: [1, 2, 3], c: { d: ['ello'] }}";
234      JsonObject jsonObject = gson.fromJson(json, JsonObject.class);
235      jsonClient.jsonSet("test_arrappend", ROOT_PATH, jsonObject);
236      assertEquals(Long.valueOf(6), jsonClient.jsonArrAppend("test_arrappend", Path.of(".b"), 4, 5, 6));
237      Integer[] array = jsonClient.jsonGet("test_arrappend", Integer[].class, Path.of(".b"));
238      assertArrayEquals(new Integer[]{1, 2, 3, 4, 5, 6}, array);
239    }
240    @Test
241    public void arrAppendMultipleTypes() {
242      String json = "{ a: 'hello', b: [1, 2, 3], c: { d: ['ello'] }}";
243      JsonObject jsonObject = gson.fromJson(json, JsonObject.class);
244      jsonClient.jsonSet("test_arrappend", ROOT_PATH, jsonObject);
245      assertEquals(Long.valueOf(6), jsonClient.jsonArrAppend("test_arrappend", Path.of(".b"), "foo", true, null));
246      Object[] array = jsonClient.jsonGet("test_arrappend", Object[].class, Path.of(".b"));
247      assertArrayEquals(new Object[]{1.0, 2.0, 3.0, "foo", true, null}, array);
248    }
249    @Test
250    public void arrAppendMultipleTypesWithDeepPath() {
251      String json = "{ a: 'hello', b: [1, 2, 3], c: { d: ['ello'] }}";
252      JsonObject jsonObject = gson.fromJson(json, JsonObject.class);
253      jsonClient.jsonSet("test_arrappend", ROOT_PATH, jsonObject);
254      assertEquals(Long.valueOf(4), jsonClient.jsonArrAppend("test_arrappend", Path.of(".c.d"), "foo", true, null));
255      Object[] array = jsonClient.jsonGet("test_arrappend", Object[].class, Path.of(".c.d"));
256      assertArrayEquals(new Object[]{"ello", "foo", true, null}, array);
257    }
258    @Test
259    public void arrAppendAgaintsEmptyArray() {
260      String json = "{ a: 'hello', b: [1, 2, 3], c: { d: [] }}";
261      JsonObject jsonObject = gson.fromJson(json, JsonObject.class);
262      jsonClient.jsonSet("test_arrappend", ROOT_PATH, jsonObject);
263      assertEquals(Long.valueOf(3), jsonClient.jsonArrAppend("test_arrappend", Path.of(".c.d"), "a", "b", "c"));
264      String[] array = jsonClient.jsonGet("test_arrappend", String[].class, Path.of(".c.d"));
265      assertArrayEquals(new String[]{"a", "b", "c"}, array);
266    }
267    @Test(expected = JedisDataException.class)
268    public void arrAppendPathIsNotArray() {
269      String json = "{ a: 'hello', b: [1, 2, 3], c: { d: ['ello'] }}";
270      JsonObject jsonObject = gson.fromJson(json, JsonObject.class);
271      jsonClient.jsonSet("test_arrappend", ROOT_PATH, jsonObject);
272      jsonClient.jsonArrAppend("test_arrappend", Path.of(".a"), 1);
273    }
274    @Test(expected = JedisDataException.class)
275    public void arrIndexAbsentKey() {
276      jsonClient.jsonArrIndex("quxquux", ROOT_PATH, gson.toJson(new Object()));
277    }
278    @Test
279    public void arrIndexWithInts() {
<span onclick='openModal()' class='match'>280      jsonClient.jsonSet("quxquux", ROOT_PATH, new int[]{8, 6, 7, 5, 3, 0, 9});
281      assertEquals(2L, jsonClient.jsonArrIndex("quxquux", ROOT_PATH, 7));
</span>282      assertEquals(-1L, jsonClient.jsonArrIndex("quxquux", ROOT_PATH, "7"));
283    }
284    @Test
285    public void arrIndexWithStrings() {
286      jsonClient.jsonSet("quxquux", ROOT_PATH, new String[]{"8", "6", "7", "5", "3", "0", "9"});
287      assertEquals(2L, jsonClient.jsonArrIndex("quxquux", ROOT_PATH, "7"));
288    }
289    @Test
290    public void arrIndexWithStringsAndPath() {
291      jsonClient.jsonSet("foobar", ROOT_PATH, new FooBarObject());
292      assertEquals(1L, jsonClient.jsonArrIndex("foobar", Path.of(".fooArr"), "b"));
293    }
294    @Test(expected = JedisDataException.class)
295    public void arrIndexNonExistentPath() {
296      jsonClient.jsonSet("foobar", ROOT_PATH, new FooBarObject());
297      assertEquals(1L, jsonClient.jsonArrIndex("foobar", Path.of(".barArr"), "x"));
298    }
299    @Test
300    public void arrInsert() {
301      String json = "['hello', 'world', true, 1, 3, null, false]";
302      JsonArray jsonArray = gson.fromJson(json, JsonArray.class);
303      jsonClient.jsonSet("test_arrinsert", ROOT_PATH, jsonArray);
304      assertEquals(8L, jsonClient.jsonArrInsert("test_arrinsert", ROOT_PATH, 1, "foo"));
305      Object[] array = jsonClient.jsonGet("test_arrinsert", Object[].class, ROOT_PATH);
306      assertArrayEquals(new Object[]{"hello", "foo", "world", true, 1.0, 3.0, null, false}, array);
307    }
308    @Test
309    public void arrInsertWithNegativeIndex() {
310      String json = "['hello', 'world', true, 1, 3, null, false]";
311      JsonArray jsonArray = gson.fromJson(json, JsonArray.class);
312      jsonClient.jsonSet("test_arrinsert", ROOT_PATH, jsonArray);
313      assertEquals(8L, jsonClient.jsonArrInsert("test_arrinsert", ROOT_PATH, -1, "foo"));
314      Object[] array = jsonClient.jsonGet("test_arrinsert", Object[].class, ROOT_PATH);
315      assertArrayEquals(new Object[]{"hello", "world", true, 1.0, 3.0, null, "foo", false}, array);
316    }
317    @Test
318    public void testArrayPop() {
319      jsonClient.jsonSet("arr", ROOT_PATH, new int[]{0, 1, 2, 3, 4});
320      assertEquals(Long.valueOf(4), jsonClient.jsonArrPop("arr", Long.class, ROOT_PATH));
321      assertEquals(Long.valueOf(3), jsonClient.jsonArrPop("arr", Long.class, ROOT_PATH, -1));
322      assertEquals(Long.valueOf(2), jsonClient.jsonArrPop("arr", Long.class));
323      assertEquals(Long.valueOf(0), jsonClient.jsonArrPop("arr", Long.class, ROOT_PATH, 0));
324      assertEquals(Double.valueOf(1), jsonClient.jsonArrPop("arr"));
325    }
326    @Test
327    public void arrTrim() {
328      jsonClient.jsonSet("arr", ROOT_PATH, new int[]{0, 1, 2, 3, 4});
329      assertEquals(Long.valueOf(3), jsonClient.jsonArrTrim("arr", ROOT_PATH, 1, 3));
330      assertArrayEquals(new Integer[]{1, 2, 3}, jsonClient.jsonGet("arr", Integer[].class, ROOT_PATH));
331    }
332    @Test
333    public void strAppend() {
334      jsonClient.jsonSet("str", ROOT_PATH, "foo");
335      assertEquals(6L, jsonClient.jsonStrAppend("str", ROOT_PATH, "bar"));
336      assertEquals("foobar", jsonClient.jsonGet("str", String.class, ROOT_PATH));
337      assertEquals(8L, jsonClient.jsonStrAppend("str", "ed"));
338      assertEquals("foobared", jsonClient.jsonGet("str"));
339    }
340    @Test
341    public void strLen() {
342      assertNull(client.jsonStrLen("str"));
343      jsonClient.jsonSet("str", ROOT_PATH, "foo");
344      assertEquals(Long.valueOf(3), jsonClient.jsonStrLen("str"));
345      assertEquals(Long.valueOf(3), jsonClient.jsonStrLen("str", ROOT_PATH));
346    }
347    @Test
348    public void numIncrBy() {
349      jsonClient.jsonSetLegacy("doc", gson.fromJson("{a:3}", JsonObject.class));
350      assertEquals(5d, jsonClient.jsonNumIncrBy("doc", Path.of(".a"), 2), 0d);
351    }
352    @Test
353    public void obj() {
354      assertNull(client.jsonObjLen("doc"));
355      assertNull(client.jsonObjKeys("doc"));
356      assertNull(client.jsonObjLen("doc", ROOT_PATH));
357      assertNull(client.jsonObjKeys("doc", ROOT_PATH));
358      String json = "{\"a\":[3], \"nested\": {\"a\": {\"b\":2, \"c\": 1}}}";
359      jsonClient.jsonSetWithPlainString("doc", ROOT_PATH, json);
360      assertEquals(Long.valueOf(2), jsonClient.jsonObjLen("doc"));
361      assertEquals(Arrays.asList("a", "nested"), jsonClient.jsonObjKeys("doc"));
362      assertEquals(Long.valueOf(2), jsonClient.jsonObjLen("doc", Path.of(".nested.a")));
363      assertEquals(Arrays.asList("b", "c"), jsonClient.jsonObjKeys("doc", Path.of(".nested.a")));
364    }
365    @Test
366    public void debugMemory() {
367      assertEquals(0L, jsonClient.jsonDebugMemory("json"));
368      assertEquals(0L, jsonClient.jsonDebugMemory("json", ROOT_PATH));
369      String json = "{ foo: 'bar', bar: { foo: 10 }}";
370      JsonObject jsonObject = gson.fromJson(json, JsonObject.class);
371      jsonClient.jsonSet("json", ROOT_PATH, jsonObject);
372      jsonClient.jsonDebugMemory("json");
373      jsonClient.jsonDebugMemory("json", ROOT_PATH);
374      jsonClient.jsonDebugMemory("json", Path.of(".bar"));
375    }
376    @Test
377    public void plainString() {
378      String json = "{\"foo\":\"bar\",\"bar\":{\"foo\":10}}";
379      assertEquals("OK", jsonClient.jsonSetWithPlainString("plain", ROOT_PATH, json));
380      assertEquals(json, jsonClient.jsonGetAsPlainString("plain", ROOT_PATH));
381    }
382    @Test
383    public void resp() {
384      assertNull(client.jsonResp("resp"));
385      assertNull(client.jsonResp("resp", ROOT_PATH));
386      String json = "{\"foo\": {\"hello\":\"world\"}, \"bar\": [null, 3, 2.5, true]}";
387      jsonClient.jsonSetWithPlainString("resp", ROOT_PATH, json);
388      List<Object> resp = jsonClient.jsonResp("resp");
389      assertEquals("{", resp.get(0));
390      assertEquals("foo", resp.get(1));
391      assertEquals(Arrays.asList("{", "hello", "world"), resp.get(2));
392      assertEquals("bar", resp.get(3));
393      List<Object> arr = (List<Object>) resp.get(4);
394      assertEquals("[", arr.get(0));
395      assertNull(arr.get(1));
396      assertEquals(Long.valueOf(3), arr.get(2));
397      MatcherAssert.assertThat(arr.get(3), Matchers.isOneOf("2.5", 2.5));
398      assertEquals("true", arr.get(4));
399      arr = jsonClient.jsonResp("resp", Path.of(".bar"));
400      assertEquals("[", arr.get(0));
401      assertNull(arr.get(1));
402      assertEquals(Long.valueOf(3), arr.get(2));
403      MatcherAssert.assertThat(arr.get(3), Matchers.isOneOf("2.5", 2.5));
404      assertEquals("true", arr.get(4));
405    }
406    @Test
407    public void testJsonGsonParser() {
408      Tick person = new Tick("foo", Instant.now());
409      client.setJsonObjectMapper(JsonObjectMapperTestUtil.getCustomGsonObjectMapper());
410      jsonClient.jsonSet(person.getId(), ROOT_PATH, person);
411      String valueExpected = jsonClient.jsonGet(person.getId(), String.class, Path.of(".created"));
412      assertEquals(valueExpected, person.getCreated().toString());
413    }
414    @Test
415    public void testDefaultJsonGsonParserStringsMustBeDifferent() {
416      Tick person = new Tick("foo", Instant.now());
417      jsonClient.jsonSet(person.getId(), ROOT_PATH, person);
418      Object valueExpected = jsonClient.jsonGet(person.getId(), Path.of(".created"));
419      assertNotEquals(valueExpected, person.getCreated().toString());
420    }
421    @Test
422    public void testJsonJacksonParser() {
423      Tick person = new Tick("foo", Instant.now());
424      client.setJsonObjectMapper(JsonObjectMapperTestUtil.getCustomJacksonObjectMapper());
425      jsonClient.jsonSet(person.getId(), ROOT_PATH, person);
426      String valueExpected = jsonClient.jsonGet(person.getId(), String.class, Path.of(".created"));
427      assertEquals(valueExpected, person.getCreated().toString());
428    }
429  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-RedisJsonV2Test.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-RedisJsonV1Test.java</div>
                </div>
                <div class="column column_space"><pre><code>276      jsonClient.jsonSetWithEscape("quxquux", ROOT_PATH, new int[]{8, 6, 7, 5, 3, 0, 9});
277      assertEquals(singletonList(2L), jsonClient.jsonArrIndexWithEscape("quxquux", ROOT_PATH, 7));
</pre></code></div>
                <div class="column column_space"><pre><code>280      jsonClient.jsonSet("quxquux", ROOT_PATH, new int[]{8, 6, 7, 5, 3, 0, 9});
281      assertEquals(2L, jsonClient.jsonArrIndex("quxquux", ROOT_PATH, 7));
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    