
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 16, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-TimeSeriesTest.java</h3>
            <pre><code>1  package redis.clients.jedis.modules.timeseries;
2  import static org.junit.Assert.assertEquals;
3  import static org.junit.Assert.assertNotEquals;
4  import static org.junit.Assert.assertNotNull;
5  import static org.junit.Assert.assertNull;
6  import static org.junit.Assert.assertTrue;
7  import static org.junit.Assert.fail;
8  import static redis.clients.jedis.util.AssertUtil.assertEqualsByProtocol;
9  import java.util.*;
10  import org.junit.BeforeClass;
11  import org.junit.Test;
12  import redis.clients.jedis.RedisProtocol;
13  import redis.clients.jedis.exceptions.JedisDataException;
14  import redis.clients.jedis.modules.RedisModuleCommandsTestBase;
15  import redis.clients.jedis.timeseries.*;
16  import redis.clients.jedis.util.KeyValue;
17  public class TimeSeriesTest extends RedisModuleCommandsTestBase {
18    @BeforeClass
19    public static void prepare() {
20      RedisModuleCommandsTestBase.prepare();
21    }
22    @Test
23    public void testCreate() {
24      Map<String, String> labels = new HashMap<>();
25      labels.put("l1", "v1");
26      labels.put("l2", "v2");
27      assertEquals("OK", client.tsCreate("series1", TSCreateParams.createParams().retention(10).labels(labels)));
28      assertEquals("TSDB-TYPE", client.type("series1"));
29      assertEquals("OK", client.tsCreate("series2", TSCreateParams.createParams().labels(labels)));
30      assertEquals("TSDB-TYPE", client.type("series2"));
31      assertEquals("OK", client.tsCreate("series3", TSCreateParams.createParams().retention(10)));
32      assertEquals("TSDB-TYPE", client.type("series3"));
33      assertEquals("OK", client.tsCreate("series4"));
34      assertEquals("TSDB-TYPE", client.type("series4"));
35      assertEquals("OK", client.tsCreate("series5", TSCreateParams.createParams().retention(0).uncompressed().labels(labels)));
36      assertEquals("TSDB-TYPE", client.type("series5"));
37      assertEquals("OK", client.tsCreate("series6", TSCreateParams.createParams().retention(7898)
38          .uncompressed().duplicatePolicy(DuplicatePolicy.MAX).labels(labels)));
39      assertEquals("TSDB-TYPE", client.type("series6"));
40      try {
41        assertEquals("OK", client.tsCreate("series1", TSCreateParams.createParams().retention(10).labels(labels)));
42        fail();
43      } catch (JedisDataException e) {
44      }
45      try {
46        assertEquals("OK", client.tsCreate("series1", TSCreateParams.createParams().labels(labels)));
47        fail();
48      } catch (JedisDataException e) {
49      }
50      try {
51        assertEquals("OK", client.tsCreate("series1", TSCreateParams.createParams().retention(10)));
52        fail();
53      } catch (JedisDataException e) {
54      }
55      try {
56        assertEquals("OK", client.tsCreate("series1"));
57        fail();
58      } catch (JedisDataException e) {
59      }
60      try {
61        assertEquals("OK", client.tsCreate("series1"));
62        fail();
63      } catch (JedisDataException e) {
64      }
65      try {
66        assertEquals("OK", client.tsCreate("series7", TSCreateParams.createParams().retention(7898)
67            .uncompressed().chunkSize(-10).duplicatePolicy(DuplicatePolicy.MAX).labels(labels)));
68        fail();
69      } catch (JedisDataException e) {
70      }
71    }
72    @Test
73    public void testAlter() {
74      Map<String, String> labels = new HashMap<>();
75      labels.put("l1", "v1");
76      labels.put("l2", "v2");
77      assertEquals("OK", client.tsCreate("seriesAlter", TSCreateParams.createParams().retention(60000).labels(labels)));
78      assertEquals(Collections.emptyList(), client.tsQueryIndex("l2=v22"));
79      labels.put("l1", "v11");
80      labels.remove("l2");
81      labels.put("l3", "v33");
82      assertEquals("OK", client.tsAlter("seriesAlter", TSAlterParams.alterParams().retention(15000).chunkSize(8192)
83          .duplicatePolicy(DuplicatePolicy.SUM).labels(labels)));
84      TSInfo info = client.tsInfo("seriesAlter");
85      assertEquals(Long.valueOf(15000), info.getProperty("retentionTime"));
86      assertEquals(Long.valueOf(8192), info.getProperty("chunkSize"));
87      assertEquals(DuplicatePolicy.SUM, info.getProperty("duplicatePolicy"));
88      assertEquals("v11", info.getLabel("l1"));
89      assertNull(info.getLabel("l2"));
90      assertEquals("v33", info.getLabel("l3"));
91    }
92    @Test
93    public void testRule() {
94      assertEquals("OK", client.tsCreate("source"));
95      assertEquals("OK", client.tsCreate("dest", TSCreateParams.createParams().retention(10)));
96      assertEquals("OK", client.tsCreateRule("source", "dest", AggregationType.AVG, 100));
97      try {
98        client.tsCreateRule("source", "dest", AggregationType.COUNT, 100);
99        fail();
100      } catch (JedisDataException e) {
101      }
102      assertEquals("OK", client.tsDeleteRule("source", "dest"));
103      assertEquals("OK", client.tsCreateRule("source", "dest", AggregationType.COUNT, 100));
104      try {
105        assertEquals("OK", client.tsDeleteRule("source", "dest1"));
106        fail();
107      } catch (JedisDataException e) {
108      }
109    }
110    @Test
111    public void testAdd() {
112      Map<String, String> labels = new HashMap<>();
113      labels.put("l1", "v1");
114      labels.put("l2", "v2");
115      assertEquals("OK", client.tsCreate("seriesAdd", TSCreateParams.createParams().retention(10000).labels(labels)));
116      assertEquals(0, client.tsRange("seriesAdd", TSRangeParams.rangeParams()).size());
117      assertEquals(1000L, client.tsAdd("seriesAdd", 1000L, 1.1, TSCreateParams.createParams().retention(10000).labels(null)));
118      assertEquals(2000L, client.tsAdd("seriesAdd", 2000L, 0.9, TSCreateParams.createParams().labels(null)));
119      assertEquals(3200L, client.tsAdd("seriesAdd", 3200L, 1.1, TSCreateParams.createParams().retention(10000)));
120      assertEquals(4500L, client.tsAdd("seriesAdd", 4500L, -1.1));
121      TSElement[] rawValues = new TSElement[]{
122        new TSElement(1000L, 1.1),
123        new TSElement(2000L, 0.9),
124        new TSElement(3200L, 1.1),
125        new TSElement(4500L, -1.1)
126      };
127      List<TSElement> values = client.tsRange("seriesAdd", 800L, 3000L);
128      assertEquals(2, values.size());
129      assertEquals(Arrays.asList(rawValues[0], rawValues[1]), values);
130      values = client.tsRange("seriesAdd", 800L, 5000L);
131      assertEquals(4, values.size());
132      assertEquals(Arrays.asList(rawValues), values);
133      assertEquals(Arrays.asList(rawValues), client.tsRange("seriesAdd", TSRangeParams.rangeParams()));
134      List<TSElement> expectedCountValues = Arrays.asList(
135          new TSElement(2000L, 1), new TSElement(3200L, 1), new TSElement(4500L, 1));
136      values = client.tsRange("seriesAdd", TSRangeParams.rangeParams(1200L, 4600L).aggregation(AggregationType.COUNT, 1));
137      assertEquals(3, values.size());
138      assertEquals(expectedCountValues, values);
139      List<TSElement> expectedAvgValues = Arrays.asList(
140          new TSElement(0L, 1.1), new TSElement(2000L, 1), new TSElement(4000L, -1.1));
141      values = client.tsRange("seriesAdd", TSRangeParams.rangeParams(500L, 4600L).aggregation(AggregationType.AVG, 2000L));
142      assertEquals(3, values.size());
143      assertEquals(expectedAvgValues, values);
144      List<TSElement> valuesZeroBased = client.tsRange("seriesAdd",
145          TSRangeParams.rangeParams(0L, 4600L).aggregation(AggregationType.AVG, 2000L));
146      assertEquals(3, valuesZeroBased.size());
147      assertEquals(values, valuesZeroBased);
148      List<TSElement> expectedOverallSumValues = Arrays.asList(new TSElement(0L, 2.0));
149      values = client.tsRange("seriesAdd", TSRangeParams.rangeParams(0L, 5000L).aggregation(AggregationType.SUM, 5000L));
150      assertEquals(1, values.size());
151      assertEquals(expectedOverallSumValues, values);
152      List<TSElement> expectedOverallMinValues = Arrays.asList(new TSElement(0L, -1.1));
153      values = client.tsRange("seriesAdd", TSRangeParams.rangeParams(0L, 5000L).aggregation(AggregationType.MIN, 5000L));
154      assertEquals(1, values.size());
155      assertEquals(expectedOverallMinValues, values);
156      List<TSElement> expectedOverallMaxValues = Arrays.asList(new TSElement(0L, 1.1));
157      values = client.tsRange("seriesAdd", TSRangeParams.rangeParams(0L, 5000L).aggregation(AggregationType.MAX, 5000L));
158      assertEquals(1, values.size());
159      assertEquals(expectedOverallMaxValues, values);
160      assertEquals(Collections.emptyMap(), client.tsMRange(TSMRangeParams.multiRangeParams().filter("l=v")));
161      try {
162        client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L).aggregation(AggregationType.COUNT, 1));
163        fail();
164      } catch (IllegalArgumentException e) {
165      }
166      try {
167        client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L).aggregation(AggregationType.COUNT, 1).filter((String) null));
168        fail();
169      } catch (IllegalArgumentException e) {
170      }
171      Map<String, TSMRangeElements> ranges = client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L)
172          .aggregation(AggregationType.COUNT, 1).filter("l1=v1"));
173      assertEquals(1, ranges.size());
174      TSMRangeElements range = ranges.values().stream().findAny().get();
175      assertEquals("seriesAdd", range.getKey());
176      assertEquals(Collections.emptyMap(), range.getLabels());
177      List<TSElement> rangeValues = range.getValue();
178      assertEquals(4, rangeValues.size());
179      assertEquals(new TSElement(1000, 1), rangeValues.get(0));
180      assertNotEquals(new TSElement(1000, 1.1), rangeValues.get(0));
181      assertEquals(2000L, rangeValues.get(1).getTimestamp());
182      assertEquals("(2000:1.0)", rangeValues.get(1).toString());
183      Map<String, String> labels2 = new HashMap<>();
184      labels2.put("l3", "v3");
185      labels2.put("l4", "v4");
186      assertEquals(1000L, client.tsAdd("seriesAdd2", 1000L, 1.1, TSCreateParams.createParams().retention(10000).labels(labels2)));
187      Map<String, TSMRangeElements> ranges2 = client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L)
188          .aggregation(AggregationType.COUNT, 1).withLabels().filter("l4=v4"));
189      assertEquals(1, ranges2.size());
190      TSMRangeElements elements2 = ranges2.values().stream().findAny().get();
191      assertEquals(labels2, elements2.getLabels());
192      assertEqualsByProtocol(protocol, null, Arrays.asList(AggregationType.COUNT), elements2.getAggregators());
193      Map<String, String> labels3 = new HashMap<>();
194      labels3.put("l3", "v33");
195      labels3.put("l4", "v4");
196      assertEquals(1000L, client.tsAdd("seriesAdd3", 1000L, 1.1, TSCreateParams.createParams().labels(labels3)));
197      assertEquals(2000L, client.tsAdd("seriesAdd3", 2000L, 1.1, TSCreateParams.createParams().labels(labels3)));
198      assertEquals(3000L, client.tsAdd("seriesAdd3", 3000L, 1.1, TSCreateParams.createParams().labels(labels3)));
199      Map<String, TSMRangeElements> ranges3 = client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L)
200          .aggregation(AggregationType.AVG, 1L).withLabels(true).count(2).filter("l4=v4"));
201      assertEquals(2, ranges3.size());
202      ArrayList<TSMRangeElements> ranges3List = new ArrayList<>(ranges3.values());
203      assertEquals(1, ranges3List.get(0).getValue().size());
204      assertEquals(labels2, ranges3List.get(0).getLabels());
205      assertEqualsByProtocol(protocol, null, Arrays.asList(AggregationType.AVG), ranges3List.get(0).getAggregators());
206      assertEquals(2, ranges3List.get(1).getValue().size());
207      assertEquals(labels3, ranges3List.get(1).getLabels());
208      assertEqualsByProtocol(protocol, null, Arrays.asList(AggregationType.AVG), ranges3List.get(1).getAggregators());
209      assertEquals(800L, client.tsAdd("seriesAdd", 800L, 1.1));
210      assertEquals(700L, client.tsAdd("seriesAdd", 700L, 1.1, TSCreateParams.createParams().retention(10000)));
211      assertEquals(600L, client.tsAdd("seriesAdd", 600L, 1.1, TSCreateParams.createParams().retention(10000).labels(null)));
212      assertEquals(400L, client.tsAdd("seriesAdd4", 400L, 0.4, TSCreateParams.createParams()
213          .retention(7898L).uncompressed().chunkSize(1000L).duplicatePolicy(DuplicatePolicy.SUM)
214          .labels(labels)));
215      assertEquals("TSDB-TYPE", client.type("seriesAdd4"));
216      assertEquals(400L, client.tsAdd("seriesAdd4", 400L, 0.3, TSCreateParams.createParams()
217          .retention(7898L).uncompressed().chunkSize(1000L).duplicatePolicy(DuplicatePolicy.SUM)
218          .labels(labels)));
219      assertEquals(Arrays.asList(new TSElement(400L, 0.7)), client.tsRange("seriesAdd4", 0L, Long.MAX_VALUE));
220      try {
221        client.tsRange("seriesAdd1", TSRangeParams.rangeParams(500L, 4000L).aggregation(AggregationType.COUNT, 1));
222        fail();
223      } catch (JedisDataException e) {
224      }
225    }
226    @Test
227    public void issue75() {
228      client.tsMRange(TSMRangeParams.multiRangeParams().filter("id=1"));
229    }
230    @Test
231    public void del() {
232      try {
233        client.tsDel("ts-del", 0, 1);
234        fail();
235      } catch (JedisDataException jde) {
236      }
237      assertEquals("OK", client.tsCreate("ts-del", TSCreateParams.createParams().retention(10000L)));
238      assertEquals(0, client.tsDel("ts-del", 0, 1));
239      assertEquals(1000L, client.tsAdd("ts-del", 1000L, 1.1, TSCreateParams.createParams().retention(10000)));
240      assertEquals(2000L, client.tsAdd("ts-del", 2000L, 0.9));
241      assertEquals(3200L, client.tsAdd("ts-del", 3200L, 1.1, TSCreateParams.createParams().retention(10000)));
242      assertEquals(4500L, client.tsAdd("ts-del", 4500L, -1.1));
243      assertEquals(4, client.tsRange("ts-del", 0, 5000).size());
244      assertEquals(2, client.tsDel("ts-del", 2000, 4000));
245      assertEquals(2, client.tsRange("ts-del", 0, 5000).size());
246      assertEquals(1, client.tsRange("ts-del", 0, 2500).size());
247      assertEquals(1, client.tsRange("ts-del", 2500, 5000).size());
248    }
249    @Test
250    public void testValue() {
251      TSElement v = new TSElement(1234, 234.89634);
252      assertEquals(1234, v.getTimestamp());
253      assertEquals(234.89634, v.getValue(), 0);
254      assertEquals(v, new TSElement(1234, 234.89634));
255      assertNotEquals(v, new TSElement(1334, 234.89634));
256      assertNotEquals(v, new TSElement(1234, 234.8934));
257      assertNotEquals(1234, v.getValue());
258      assertEquals("(1234:234.89634)", v.toString());
259      assertEquals(-1856719580, v.hashCode());
260    }
261    @Test
262    public void testAddStar() throws InterruptedException {
263      Map<String, String> labels = new HashMap<>();
264      labels.put("l11", "v11");
265      labels.put("l22", "v22");
266      assertEquals("OK", client.tsCreate("seriesAdd2", TSCreateParams.createParams().retention(10000L).labels(labels)));
267      long startTime = System.currentTimeMillis();
268      Thread.sleep(1);
269      long add1 = client.tsAdd("seriesAdd2", 1.1);
270      assertTrue(add1 > startTime);
271      Thread.sleep(1);
272      long add2 = client.tsAdd("seriesAdd2", 3.2);
273      assertTrue(add2 > add1);
274      Thread.sleep(1);
275      long add3 = client.tsAdd("seriesAdd2", 3.2);
276      assertTrue(add3 > add2);
277      Thread.sleep(1);
278      long add4 = client.tsAdd("seriesAdd2", -1.2);
279      assertTrue(add4 > add3);
280      Thread.sleep(1);
281      long endTime = System.currentTimeMillis();
282      assertTrue(endTime > add4);
283      List<TSElement> values = client.tsRange("seriesAdd2", startTime, add3);
284      assertEquals(3, values.size());
285    }
286    @Test
287    public void testMadd() {
288      Map<String, String> labels = new HashMap<>();
289      labels.put("l1", "v1");
290      labels.put("l2", "v2");
291      assertEquals("OK", client.tsCreate("seriesAdd1", TSCreateParams.createParams().retention(10000L).labels(labels)));
292      assertEquals("OK", client.tsCreate("seriesAdd2", TSCreateParams.createParams().retention(10000L).labels(labels)));
293      List<Long> result = client.tsMAdd(
294          new KeyValue<>("seriesAdd1", new TSElement(1000L, 1.1)),
295          new KeyValue<>("seriesAdd2", new TSElement(2000L, 3.2)),
296          new KeyValue<>("seriesAdd1", new TSElement(1500L, 2.67)),
297          new KeyValue<>("seriesAdd2", new TSElement(3200L, 54.2)),
298          new KeyValue<>("seriesAdd2", new TSElement(4300L, 21.2)));
299      assertEquals(1000L, result.get(0).longValue());
300      assertEquals(2000L, result.get(1).longValue());
301      assertEquals(1500L, result.get(2).longValue());
302      assertEquals(3200L, result.get(3).longValue());
303      assertEquals(4300L, result.get(4).longValue());
304      List<TSElement> values1 = client.tsRange("seriesAdd1", 0, Long.MAX_VALUE);
305      assertEquals(2, values1.size());
306      assertEquals(1.1, values1.get(0).getValue(), 0.001);
307      assertEquals(2.67, values1.get(1).getValue(), 0.001);
308      List<TSElement> values2 = client.tsRange("seriesAdd2", TSRangeParams.rangeParams(0, Long.MAX_VALUE).count(2));
309      assertEquals(2, values2.size());
310      assertEquals(3.2, values2.get(0).getValue(), 0.001);
311      assertEquals(54.2, values2.get(1).getValue(), 0.001);
312    }
313    @Test
314    public void testIncrByDecrBy() throws InterruptedException {
315      assertEquals("OK", client.tsCreate("seriesIncDec",
316          TSCreateParams.createParams().retention(100 * 1000 &bsol;*100 sec*/)));
317      assertEquals(1L, client.tsAdd("seriesIncDec", 1L, 1), 0);
318      assertEquals(2L, client.tsIncrBy("seriesIncDec", 3, 2L), 0);
319      assertEquals(3L, client.tsDecrBy("seriesIncDec", 2, 3L), 0);
320      List<TSElement> values = client.tsRange("seriesIncDec", 1L, 3L);
321      assertEquals(3, values.size());
322      assertEquals(2, values.get(2).getValue(), 0);
323      assertEquals(3L, client.tsDecrBy("seriesIncDec", 2, 3L), 0);
324      values = client.tsRange("seriesIncDec", 1L, Long.MAX_VALUE);
325      assertEquals(3, values.size());
326      client.tsIncrBy("seriesIncDec", 100);
327      client.tsDecrBy("seriesIncDec", 33);
328    }
329    @Test
330    public void align() {
331      client.tsAdd("align", 1, 10d);
332      client.tsAdd("align", 3, 5d);
333      client.tsAdd("align", 11, 10d);
334      client.tsAdd("align", 25, 11d);
335      List<TSElement> values = client.tsRange("align", TSRangeParams.rangeParams(1L, 30L).aggregation(AggregationType.COUNT, 10));
336      assertEquals(Arrays.asList(new TSElement(1, 2), new TSElement(11, 1), new TSElement(21, 1)), values);
337      values = client.tsRange("align", TSRangeParams.rangeParams(1L, 30L).alignStart().aggregation(AggregationType.COUNT, 10));
338      assertEquals(Arrays.asList(new TSElement(1, 2), new TSElement(11, 1), new TSElement(21, 1)), values);
339      values = client.tsRange("align", TSRangeParams.rangeParams(1L, 30L).alignEnd().aggregation(AggregationType.COUNT, 10));
340      assertEquals(Arrays.asList(new TSElement(1, 2), new TSElement(11, 1), new TSElement(21, 1)), values);
341      values =
342          client.tsRange("align", TSRangeParams.rangeParams(1L, 30L).align(5).aggregation(AggregationType.COUNT, 10));
343      assertEquals(Arrays.asList(new TSElement(1, 2), new TSElement(11, 1), new TSElement(21, 1)), values);
344    }
345    @Test
346    public void rangeFilterBy() {
347      TSElement[] rawValues =
348          new TSElement[] {
349            new TSElement(1000L, 1.0),
350            new TSElement(2000L, 0.9),
351            new TSElement(3200L, 1.1),
352            new TSElement(4500L, -1.1)
353          };
354      for (TSElement value : rawValues) {
355        client.tsAdd("filterBy", value.getTimestamp(), value.getValue());
356      }
357      List<TSElement> values = client.tsRange("filterBy", 0L, 5000L);
358      assertEquals(Arrays.asList(rawValues), values);
359      values = client.tsRange("filterBy", TSRangeParams.rangeParams(0L, 5000L).filterByTS(1000L, 2000L));
360      assertEquals(Arrays.asList(rawValues[0], rawValues[1]), values);
361      values = client.tsRange("filterBy", TSRangeParams.rangeParams(0L, 5000L).filterByValues(1.0, 1.2));
362      assertEquals(Arrays.asList(rawValues[0], rawValues[2]), values);
363      values = client.tsRange("filterBy", TSRangeParams.rangeParams(0L, 5000L).filterByTS(1000L, 2000L).filterByValues(1.0, 1.2));
364      assertEquals(Arrays.asList(rawValues[0]), values);
365      values = client.tsRevRange("filterBy", 0L, 5000L);
366      assertEquals(Arrays.asList(rawValues[3], rawValues[2], rawValues[1], rawValues[0]), values);
367      values =
368          client.tsRevRange("filterBy", TSRangeParams.rangeParams(0L, 5000L).filterByTS(1000L, 2000L));
369      assertEquals(Arrays.asList(rawValues[1], rawValues[0]), values);
370      values =
371          client.tsRevRange("filterBy", TSRangeParams.rangeParams(0L, 5000L).filterByValues(1.0, 1.2));
372      assertEquals(Arrays.asList(rawValues[2], rawValues[0]), values);
373      values =
374          client.tsRevRange("filterBy", TSRangeParams.rangeParams(0L, 5000L).filterByTS(1000L, 2000L).filterByValues(1.0, 1.2));
375      assertEquals(Arrays.asList(rawValues[0]), values);
376    }
377    @Test
378    public void mrangeFilterBy() {
379      Map<String, String> labels = Collections.singletonMap("label", "multi");
380      client.tsCreate("ts1", TSCreateParams.createParams().labels(labels));
381      client.tsCreate("ts2", TSCreateParams.createParams().labels(labels));
382      String filter = "label=multi";
383      TSElement[] rawValues = new TSElement[]{
384        new TSElement(1000L, 1.0),
385        new TSElement(2000L, 0.9),
386        new TSElement(3200L, 1.1),
387        new TSElement(4500L, -1.1)
388      };
389      client.tsAdd("ts1", rawValues[0].getTimestamp(), rawValues[0].getValue());
390      client.tsAdd("ts2", rawValues[1].getTimestamp(), rawValues[1].getValue());
391      client.tsAdd("ts2", rawValues[2].getTimestamp(), rawValues[2].getValue());
392      client.tsAdd("ts1", rawValues[3].getTimestamp(), rawValues[3].getValue());
393      Map<String, TSMRangeElements> range = client.tsMRange(0L, 5000L, filter);
394      ArrayList<TSMRangeElements> rangeList = new ArrayList<>(range.values());
395      assertEquals("ts1", rangeList.get(0).getKey());
396      assertEquals(Arrays.asList(rawValues[0], rawValues[3]), rangeList.get(0).getValue());
397      assertEquals("ts2", rangeList.get(1).getKey());
398      assertEquals(Arrays.asList(rawValues[1], rawValues[2]), rangeList.get(1).getValue());
399      range = client.tsMRange(TSMRangeParams.multiRangeParams(0L, 5000L).filterByTS(1000L, 2000L).filter(filter));
400      rangeList = new ArrayList<>(range.values());
401      assertEquals("ts1", rangeList.get(0).getKey());
402      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
403      assertEquals("ts2", rangeList.get(1).getKey());
404      assertEquals(Arrays.asList(rawValues[1]), rangeList.get(1).getValue());
405      range = client.tsMRange(TSMRangeParams.multiRangeParams(0L, 5000L).filterByValues(1.0, 1.2).filter(filter));
406      rangeList = new ArrayList<>(range.values());
407      assertEquals("ts1", rangeList.get(0).getKey());
408      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
409      assertEquals("ts2", rangeList.get(1).getKey());
410      assertEquals(Arrays.asList(rawValues[2]), rangeList.get(1).getValue());
411      range = client.tsMRange(TSMRangeParams.multiRangeParams(0L, 5000L)
412          .filterByTS(1000L, 2000L).filterByValues(1.0, 1.2).filter(filter));
413      rangeList = new ArrayList<>(range.values());
414      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
415      range = client.tsMRevRange(0L, 5000L,  filter);
416      rangeList = new ArrayList<>(range.values());
417      assertEquals("ts1", rangeList.get(0).getKey());
418      assertEquals(Arrays.asList(rawValues[3], rawValues[0]), rangeList.get(0).getValue());
419      assertEquals("ts2", rangeList.get(1).getKey());
420      assertEquals(Arrays.asList(rawValues[2], rawValues[1]), rangeList.get(1).getValue());
421      range = client.tsMRevRange(TSMRangeParams.multiRangeParams(0L, 5000L).filterByTS(1000L, 2000L).filter(filter));
422      rangeList = new ArrayList<>(range.values());
423      assertEquals("ts1", rangeList.get(0).getKey());
424      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
425      assertEquals("ts2", rangeList.get(1).getKey());
426      assertEquals(Arrays.asList(rawValues[1]), rangeList.get(1).getValue());
427      range = client.tsMRevRange(TSMRangeParams.multiRangeParams(0L, 5000L).filterByValues(1.0, 1.2).filter(filter));
428      rangeList = new ArrayList<>(range.values());
429      assertEquals("ts1", rangeList.get(0).getKey());
430      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
431      assertEquals("ts2", rangeList.get(1).getKey());
432      assertEquals(Arrays.asList(rawValues[2]), rangeList.get(1).getValue());
433      range = client.tsMRevRange(TSMRangeParams.multiRangeParams(0L, 5000L)
434          .filterByTS(1000L, 2000L).filterByValues(1.0, 1.2).filter(filter));
435      rangeList = new ArrayList<>(range.values());
436      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
437    }
438    @Test
439    public void groupByReduce() {
440      client.tsCreate("ts1", TSCreateParams.createParams().labels(convertMap("metric", "cpu", "metric_name", "system")));
441      client.tsCreate("ts2", TSCreateParams.createParams().labels(convertMap("metric", "cpu", "metric_name", "user")));
442      client.tsAdd("ts1", 1L, 90.0);
443      client.tsAdd("ts1", 2L, 45.0);
444      client.tsAdd("ts2", 2L, 99.0);
445      Map<String, TSMRangeElements> range = client.tsMRange(TSMRangeParams.multiRangeParams(0L, 100L).withLabels()
446          .filter("metric=cpu").groupBy("metric_name", "max"));
447      assertEquals(2, range.size());
448      ArrayList<TSMRangeElements> rangeList = new ArrayList<>(range.values());
449      assertEquals("metric_name=system", rangeList.get(0).getKey());
450      assertEquals("system", rangeList.get(0).getLabels().get("metric_name"));
451      if (protocol != RedisProtocol.RESP3) {
452        assertEquals("max", rangeList.get(0).getLabels().get("__reducer__"));
453        assertEquals("ts1", rangeList.get(0).getLabels().get("__source__"));
454      } else {
455        assertEquals(Arrays.asList("max"), rangeList.get(0).getReducers());
456        assertEquals(Arrays.asList("ts1"), rangeList.get(0).getSources());
457      }
458      assertEquals(Arrays.asList(new TSElement(1, 90), new TSElement(2, 45)), rangeList.get(0).getValue());
459      assertEquals("metric_name=user", rangeList.get(1).getKey());
460      assertEquals("user", rangeList.get(1).getLabels().get("metric_name"));
461      if (protocol != RedisProtocol.RESP3) {
462        assertEquals("max", rangeList.get(1).getLabels().get("__reducer__"));
463        assertEquals("ts2", rangeList.get(1).getLabels().get("__source__"));
464      } else {
465        assertEquals(Arrays.asList("max"), rangeList.get(1).getReducers());
466        assertEquals(Arrays.asList("ts2"), rangeList.get(1).getSources());
467      }
468      assertEquals(Arrays.asList(new TSElement(2, 99)), rangeList.get(1).getValue());
469    }
470    private Map<String, String> convertMap(String... array) {
471      Map<String, String> map = new HashMap<>(array.length / 2);
472      for (int i = 0; i < array.length; i += 2) {
473        map.put(array[i], array[i + 1]);
474      }
475      return map;
476    }
477    @Test
478    public void testGet() {
479      try {
480        client.tsGet("seriesGet");
481        fail();
482      } catch (JedisDataException e) {
483      }
484      assertEquals("OK", client.tsCreate("seriesGet", TSCreateParams.createParams()
485          .retention(100 * 1000 &bsol;*100sec retentionTime*/)));
486      assertNull(client.tsGet("seriesGet"));
487      client.tsAdd("seriesGet", 2558, 8.7);
488      assertEquals(new TSElement(2558, 8.7), client.tsGet("seriesGet"));
489      client.tsAdd("seriesGet", 3458, 1.117);
490      assertEquals(new TSElement(3458, 1.117), client.tsGet("seriesGet"));
491    }
492    @Test
493    public void testMGet() {
494      Map<String, String> labels = new HashMap<>();
495      labels.put("l1", "v1");
496      labels.put("l2", "v2");
497      assertEquals("OK", client.tsCreate("seriesMGet1", TSCreateParams.createParams()
498          .retention(100 * 1000 &bsol;*100sec retentionTime*/).labels(labels)));
499      assertEquals("OK", client.tsCreate("seriesMGet2", TSCreateParams.createParams()
500          .retention(100 * 1000 &bsol;*100sec retentionTime*/).labels(labels)));
501      Map<String, TSMGetElement> ranges1 = client.tsMGet(TSMGetParams.multiGetParams().withLabels(false), "l1=v2");
502      assertEquals(0, ranges1.size());
503      Map<String, TSMGetElement> ranges2 = client.tsMGet(TSMGetParams.multiGetParams().withLabels(true), "l1=v1");
504      assertEquals(2, ranges2.size());
505      ArrayList<TSMGetElement> ranges2List = new ArrayList<>(ranges2.values());
506      assertEquals(labels, ranges2List.get(0).getLabels());
507      assertEquals(labels, ranges2List.get(1).getLabels());
508      assertNull(ranges2List.get(0).getValue());
509      client.tsAdd("seriesMGet1", 1500, 1.3);
510      Map<String, TSMGetElement> ranges3 = client.tsMGet(TSMGetParams.multiGetParams().withLabels(false), "l1=v1");
511      assertEquals(2, ranges3.size());
512      ArrayList<TSMGetElement> ranges3List = new ArrayList<>(ranges3.values());
513      assertEquals(Collections.emptyMap(), ranges3List.get(0).getLabels());
514      assertEquals(Collections.emptyMap(), ranges3List.get(1).getLabels());
515      assertEquals(new TSElement(1500, 1.3), ranges3List.get(0).getValue());
516      assertNull(ranges3List.get(1).getValue());
517    }
518    @Test
519    public void testQueryIndex() {
520      Map<String, String> labels = new HashMap<>();
521      labels.put("l1", "v1");
522      labels.put("l2", "v2");
523      assertEquals("OK", client.tsCreate("seriesQueryIndex1", TSCreateParams.createParams()
524          .retention(100 * 1000 &bsol;*100sec retentionTime*/).labels(labels)));
525      labels.put("l2", "v22");
526      labels.put("l3", "v33");
527      assertEquals("OK", client.tsCreate("seriesQueryIndex2", TSCreateParams.createParams()
528          .retention(100 * 1000 &bsol;*100sec retentionTime*/).labels(labels)));
529      assertEquals(Arrays.<String>asList(), client.tsQueryIndex("l1=v2"));
530      assertEquals(Arrays.asList("seriesQueryIndex1", "seriesQueryIndex2"), client.tsQueryIndex("l1=v1"));
531      assertEquals(Arrays.asList("seriesQueryIndex2"), client.tsQueryIndex("l2=v22"));
532    }
533    @Test
534    public void testInfo() {
535      Map<String, String> labels = new HashMap<>();
536      labels.put("l1", "v1");
537      labels.put("l2", "v2");
538      assertEquals("OK", client.tsCreate("source", TSCreateParams.createParams().retention(10000L).labels(labels)));
539      assertEquals("OK", client.tsCreate("dest", TSCreateParams.createParams().retention(20000L)));
540      assertEquals("OK", client.tsCreateRule("source", "dest", AggregationType.AVG, 100));
541      TSInfo info = client.tsInfo("source");
542      assertEquals((Long) 10000L, info.getProperty("retentionTime"));
543      assertEquals((Long) 4096L, info.getProperty("chunkSize"));
544      assertEquals("v1", info.getLabel("l1"));
545      assertEquals("v2", info.getLabel("l2"));
546      assertNull(info.getLabel("l3"));
547      assertEquals(1, info.getRules().size());
548      TSInfo.Rule rule = info.getRule("dest");
549      assertEquals("dest", rule.getCompactionKey());
550      assertEquals(100L, rule.getBucketDuration());
551      assertEquals(AggregationType.AVG, rule.getAggregator());
552      try {
553        client.tsInfo("none");
554        fail();
555      } catch (JedisDataException e) {
556      }
557    }
558    @Test
559    public void testInfoDebug() {
560      assertEquals("OK", client.tsCreate("source", TSCreateParams.createParams()));
561      TSInfo info = client.tsInfoDebug("source");
562      assertEquals((Long) 0L, info.getProperty("retentionTime"));
563      assertEquals(0, info.getLabels().size());
564      assertEquals(0, info.getRules().size());
565      List<Map<String, Object>> chunks = info.getChunks();
566      assertEquals(1, chunks.size());
567      Map<String, Object> chunk = chunks.get(0);
568      assertEquals(0L, chunk.get("samples"));
569      assertTrue(chunk.get("size") instanceof Long);
570      assertTrue(chunk.get("startTimestamp") instanceof Long);
571      assertTrue(chunk.get("endTimestamp") instanceof Long);
572      assertTrue(chunk.get("bytesPerSample") instanceof Double);
573      try {
574        client.tsInfoDebug("none");
575        fail();
576      } catch (JedisDataException e) {
577      }
578    }
579    @Test
580    public void testRevRange() {
581      Map<String, String> labels = new HashMap<>();
582      labels.put("l1", "v1");
583      labels.put("l2", "v2");
584      assertEquals("OK", client.tsCreate("seriesAdd", TSCreateParams.createParams().retention(10000L).labels(labels)));
585      assertEquals(Collections.emptyList(), client.tsRevRange("seriesAdd", TSRangeParams.rangeParams()));
586      assertEquals(1000L, client.tsAdd("seriesRevRange", 1000L, 1.1, TSCreateParams.createParams().retention(10000)));
587      assertEquals(2000L, client.tsAdd("seriesRevRange", 2000L, 0.9, TSCreateParams.createParams().labels(null)));
588      assertEquals(3200L, client.tsAdd("seriesRevRange", 3200L, 1.1, TSCreateParams.createParams().retention(10000)));
589      assertEquals(4500L, client.tsAdd("seriesRevRange", 4500L, -1.1));
590      TSElement[] rawValues = new TSElement[]{
591        new TSElement(4500L, -1.1),
<span onclick='openModal()' class='match'>592        new TSElement(3200L, 1.1),
593        new TSElement(2000L, 0.9),
594        new TSElement(1000L, 1.1)
</span>595      };
596      List<TSElement> values = client.tsRevRange("seriesRevRange", 800L, 3000L);
597      assertEquals(2, values.size());
598      assertEquals(Arrays.asList(Arrays.copyOfRange(rawValues, 2, 4)), values);
599      values = client.tsRevRange("seriesRevRange", 800L, 5000L);
600      assertEquals(4, values.size());
601      assertEquals(Arrays.asList(rawValues), values);
602      assertEquals(Arrays.asList(rawValues), client.tsRevRange("seriesRevRange", TSRangeParams.rangeParams()));
603      List<TSElement> expectedCountValues = Arrays.asList(
604          new TSElement(4500L, 1), new TSElement(3200L, 1), new TSElement(2000L, 1));
605      values = client.tsRevRange("seriesRevRange", TSRangeParams.rangeParams(1200L, 4600L)
606          .aggregation(AggregationType.COUNT, 1));
607      assertEquals(3, values.size());
608      assertEquals(expectedCountValues, values);
609      List<TSElement> expectedAvgValues = Arrays.asList(
610          new TSElement(4000L, -1.1), new TSElement(2000L, 1), new TSElement(0L, 1.1));
611      values = client.tsRevRange("seriesRevRange", TSRangeParams.rangeParams(500L, 4600L)
612          .aggregation(AggregationType.AVG, 2000L));
613      assertEquals(3, values.size());
614      assertEquals(expectedAvgValues, values);
615    }
616    @Test
617    public void testMRevRange() {
618      assertEquals(Collections.emptyMap(), client.tsMRevRange(TSMRangeParams.multiRangeParams().filter("l=v")));
619      Map<String, String> labels1 = new HashMap<>();
620      labels1.put("l3", "v3");
621      labels1.put("l4", "v4");
622      assertEquals(1000L, client.tsAdd("seriesMRevRange1", 1000L, 1.1,
623          TSCreateParams.createParams().retention(10000).labels(labels1)));
624      assertEquals(2222L, client.tsAdd("seriesMRevRange1", 2222L, 3.1,
625          TSCreateParams.createParams().retention(10000).labels(labels1)));
626      Map<String, TSMRangeElements> ranges1 = client.tsMRevRange(TSMRangeParams.multiRangeParams(500L, 4600L)
627          .aggregation(AggregationType.COUNT, 1).withLabels().filter("l4=v4"));
628      assertEquals(1, ranges1.size());
629      ArrayList<TSMRangeElements> ranges1List = new ArrayList<>(ranges1.values());
630      assertEquals(labels1, ranges1List.get(0).getLabels());
631      assertEquals(Arrays.asList(new TSElement(2222L, 1.0), new TSElement(1000L, 1.0)), ranges1List.get(0).getValue());
632      Map<String, String> labels2 = new HashMap<>();
633      labels2.put("l3", "v3");
634      labels2.put("l4", "v44");
635      assertEquals(1000L, client.tsAdd("seriesMRevRange2", 1000L, 8.88,
636          TSCreateParams.createParams().retention(10000).labels(labels2)));
637      assertEquals(1111L, client.tsAdd("seriesMRevRange2", 1111L, 99.99,
638          TSCreateParams.createParams().retention(10000).labels(labels2)));
639      Map<String, TSMRangeElements> ranges2 = client.tsMRevRange(500L, 4600L, "l3=v3");
640      assertEquals(2, ranges2.size());
641      ArrayList<TSMRangeElements> ranges2List = new ArrayList<>(ranges2.values());
642      assertEquals(Collections.emptyMap(), ranges2List.get(0).getLabels());
643      assertEquals(Arrays.asList(new TSElement(2222L, 3.1), new TSElement(1000L, 1.1)), ranges2List.get(0).getValue());
644      assertEquals(Collections.emptyMap(), ranges2List.get(0).getLabels());
645      assertEquals(Arrays.asList(new TSElement(1111L, 99.99), new TSElement(1000L, 8.88)), ranges2List.get(1).getValue());
646      Map<String, String> labels3 = new HashMap<>();
647      labels3.put("l3", "v33");
648      labels3.put("l4", "v4");
649      assertEquals(2200L, client.tsAdd("seriesMRevRange3", 2200L, -1.1, TSCreateParams.createParams().labels(labels3)));
650      assertEquals(2400L, client.tsAdd("seriesMRevRange3", 2400L, 1.1, TSCreateParams.createParams().labels(labels3)));
651      assertEquals(3300L, client.tsAdd("seriesMRevRange3", 3300L, -33, TSCreateParams.createParams().labels(labels3)));
652      Map<String, TSMRangeElements> ranges3 = client.tsMRevRange(TSMRangeParams.multiRangeParams(500L, 4600L)
653          .aggregation(AggregationType.AVG, 500).withLabels().count(5).filter("l4=v4"));
654      assertEquals(2, ranges3.size());
655      ArrayList<TSMRangeElements> ranges3List = new ArrayList<>(ranges3.values());
656      assertEquals(labels1, ranges3List.get(0).getLabels());
657      assertEquals(Arrays.asList(new TSElement(2000L, 3.1), new TSElement(1000L, 1.1)), ranges3List.get(0).getValue());
658      assertEquals(labels3, ranges3List.get(1).getLabels());
659      assertEquals(Arrays.asList(new TSElement(3000L, -33.0), new TSElement(2000L, 0.0)), ranges3List.get(1).getValue());
660    }
661    @Test
662    public void latest() {
663      client.tsCreate("ts1");
664      client.tsCreate("ts2");
665      client.tsCreateRule("ts1", "ts2", AggregationType.SUM, 10);
666      client.tsAdd("ts1", 1, 1);
667      client.tsAdd("ts1", 2, 3);
668      client.tsAdd("ts1", 11, 7);
669      client.tsAdd("ts1", 13, 1);
670      List<TSElement> range = client.tsRange("ts1", 0, 20);
671      assertEquals(4, range.size());
672      final TSElement compact = new TSElement(0, 4);
673      final TSElement latest = new TSElement(10, 8);
674      assertEquals(compact, client.tsGet("ts2", TSGetParams.getParams()));
675      assertEquals(latest, client.tsGet("ts2", TSGetParams.getParams().latest()));
676      assertEquals(Arrays.asList(compact), client.tsRange("ts2", TSRangeParams.rangeParams(0, 10)));
677      assertEquals(Arrays.asList(compact, latest), client.tsRange("ts2", TSRangeParams.rangeParams(0, 10).latest()));
678      assertEquals(Arrays.asList(compact), client.tsRevRange("ts2", TSRangeParams.rangeParams(0, 10)));
679      assertEquals(Arrays.asList(latest, compact), client.tsRevRange("ts2", TSRangeParams.rangeParams(0, 10).latest()));
680    }
681    @Test
682    public void latestMulti() {
683      client.tsCreate("ts1");
684      client.tsCreate("ts2", TSCreateParams.createParams().label("compact", "true"));
685      client.tsCreateRule("ts1", "ts2", AggregationType.SUM, 10);
686      client.tsAdd("ts1", 1, 1);
687      client.tsAdd("ts1", 2, 3);
688      client.tsAdd("ts1", 11, 7);
689      client.tsAdd("ts1", 13, 1);
690      List<TSElement> range = client.tsRange("ts1", 0, 20);
691      assertEquals(4, range.size());
692      final TSElement compact = new TSElement(0, 4);
693      final TSElement latest = new TSElement(10, 8);
694      assertEquals(makeSingletonMap(new TSMGetElement("ts2", null, compact)),
695          client.tsMGet(TSMGetParams.multiGetParams(), "compact=true"));
696      assertEquals(makeSingletonMap(new TSMGetElement("ts2", null, latest)),
697          client.tsMGet(TSMGetParams.multiGetParams().latest(), "compact=true"));
698      assertEquals(makeSingletonMap(new TSMRangeElements("ts2", null, Arrays.asList(compact))),
699          client.tsMRange(TSMRangeParams.multiRangeParams().filter("compact=true")));
700      assertEquals(makeSingletonMap(new TSMRangeElements("ts2", null, Arrays.asList(compact, latest))),
701          client.tsMRange(TSMRangeParams.multiRangeParams().latest().filter("compact=true")));
702      assertEquals(makeSingletonMap(new TSMRangeElements("ts2", null, Arrays.asList(compact))),
703          client.tsMRevRange(TSMRangeParams.multiRangeParams().filter("compact=true")));
704      assertEquals(makeSingletonMap(new TSMRangeElements("ts2", null, Arrays.asList(latest, compact))),
705          client.tsMRevRange(TSMRangeParams.multiRangeParams().latest().filter("compact=true")));
706    }
707    private Map<String, TSMGetElement> makeSingletonMap(TSMGetElement value) {
708      return Collections.singletonMap(value.getKey(), value);
709    }
710    private Map<String, TSMRangeElements> makeSingletonMap(TSMRangeElements value) {
711      return Collections.singletonMap(value.getKey(), value);
712    }
713    @Test
714    public void empty() {
715      client.tsCreate("ts", TSCreateParams.createParams().label("l", "v"));
716      client.tsAdd("ts", 1, 1);
717      client.tsAdd("ts", 2, 3);
718      client.tsAdd("ts", 11, 7);
719      client.tsAdd("ts", 13, 1);
720      List<TSElement> range = client.tsRange("ts", TSRangeParams.rangeParams().aggregation(AggregationType.MAX, 5));
721      assertEquals(2, range.size());
722      range = client.tsRange("ts", TSRangeParams.rangeParams().aggregation(AggregationType.MAX, 5).empty());
723      assertEquals(3, range.size());
724      assertNotNull(range.get(1).getValue()); 
725      range = client.tsRevRange("ts", TSRangeParams.rangeParams().aggregation(AggregationType.MIN, 5));
726      assertEquals(2, range.size());
727      range = client.tsRevRange("ts", TSRangeParams.rangeParams().aggregation(AggregationType.MIN, 5).empty());
728      assertEquals(3, range.size());
729      assertNotNull(range.get(1).getValue()); 
730      Map<String, TSMRangeElements> mrange = client.tsMRange(TSMRangeParams.multiRangeParams()
731          .aggregation(AggregationType.MIN, 5).filter("l=v"));
732      assertEquals(1, mrange.size());
733      ArrayList<TSMRangeElements> mrangeList = new ArrayList<>(mrange.values());
734      assertEquals(2, mrangeList.get(0).getValue().size());
735      mrange = client.tsMRange(TSMRangeParams.multiRangeParams()
736          .aggregation(AggregationType.MIN, 5).empty().filter("l=v"));
737      assertEquals(1, mrange.size());
738      mrangeList = new ArrayList<>(mrange.values());
739      assertEquals(3, mrangeList.get(0).getValue().size());
740      assertNotNull(mrangeList.get(0).getValue().get(1).getValue()); 
741      mrange = client.tsMRevRange(TSMRangeParams.multiRangeParams()
742          .aggregation(AggregationType.MAX, 5).filter("l=v"));
743      assertEquals(1, mrange.size());
744      mrangeList = new ArrayList<>(mrange.values());
745      assertEquals(2, mrangeList.get(0).getValue().size());
746      mrange = client.tsMRevRange(TSMRangeParams.multiRangeParams()
747          .aggregation(AggregationType.MAX, 5).empty().filter("l=v"));
748      assertEquals(1, mrange.size());
749      mrangeList = new ArrayList<>(mrange.values());
750      assertEquals(3, mrangeList.get(0).getValue().size());
751      assertNotNull(mrangeList.get(0).getValue().get(1).getValue()); 
752    }
753    @Test
754    public void bucketTimestamp() {
755      client.tsCreate("ts", TSCreateParams.createParams().label("l", "v"));
756      client.tsAdd("ts", 1, 1);
757      client.tsAdd("ts", 2, 3);
758      assertEquals(0, client.tsRange("ts", TSRangeParams.rangeParams()
759          .aggregation(AggregationType.FIRST, 10).bucketTimestampLow()).get(0).getTimestamp());
760      assertEquals(10, client.tsRange("ts", TSRangeParams.rangeParams()
761          .aggregation(AggregationType.LAST, 10).bucketTimestampHigh()).get(0).getTimestamp());
762      assertEquals(5, client.tsRange("ts", TSRangeParams.rangeParams()
763          .aggregation(AggregationType.RANGE, 10).bucketTimestampMid()).get(0).getTimestamp());
764      assertEquals(5, client.tsRevRange("ts", TSRangeParams.rangeParams()
765          .aggregation(AggregationType.TWA, 10).bucketTimestampMid()).get(0).getTimestamp());
766      assertEquals(5, client.tsRevRange("ts", TSRangeParams.rangeParams()
767          .aggregation(AggregationType.TWA, 10).bucketTimestamp("mid")).get(0).getTimestamp());
768      assertEquals(0, client.tsMRange(TSMRangeParams.multiRangeParams()
769          .aggregation(AggregationType.STD_P, 10).bucketTimestampLow().filter("l=v"))
770          .values().stream().findAny().get().getValue().get(0).getTimestamp());
771      assertEquals(10, client.tsMRange(TSMRangeParams.multiRangeParams()
772          .aggregation(AggregationType.STD_S, 10).bucketTimestampHigh().filter("l=v"))
773          .values().stream().findAny().get().getValue().get(0).getTimestamp());
774      assertEquals(5, client.tsMRange(TSMRangeParams.multiRangeParams()
775          .aggregation(AggregationType.TWA, 10).bucketTimestampMid().filter("l=v"))
776          .values().stream().findAny().get().getValue().get(0).getTimestamp());
777      assertEquals(5, client.tsMRange(TSMRangeParams.multiRangeParams()
778          .aggregation(AggregationType.VAR_P, 10).bucketTimestampMid().filter("l=v"))
779          .values().stream().findAny().get().getValue().get(0).getTimestamp());
780      assertEquals(5, client.tsMRange(TSMRangeParams.multiRangeParams()
781          .aggregation(AggregationType.VAR_S, 10).bucketTimestamp("~").filter("l=v"))
782          .values().stream().findAny().get().getValue().get(0).getTimestamp());
783    }
784    @Test
785    public void alignTimestamp() {
786      client.tsCreate("ts1");
787      client.tsCreate("ts2");
788      client.tsCreate("ts3");
789      client.tsCreateRule("ts1", "ts2", AggregationType.COUNT, 10, 0);
790      client.tsCreateRule("ts1", "ts3", AggregationType.COUNT, 10, 1);
791      client.tsAdd("ts1", 1, 1);
792      client.tsAdd("ts1", 10, 3);
793      client.tsAdd("ts1", 21, 7);
794      assertEquals(2, client.tsRange("ts2", TSRangeParams.rangeParams().aggregation(AggregationType.COUNT, 10)).size());
795      assertEquals(1, client.tsRange("ts3", TSRangeParams.rangeParams().aggregation(AggregationType.COUNT, 10)).size());
796    }
797  }
</code></pre>
        </div>
        <div class="column">
            <h3>jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-TimeSeriesTest.java</h3>
            <pre><code>1  package redis.clients.jedis.modules.timeseries;
2  import static org.junit.Assert.assertEquals;
3  import static org.junit.Assert.assertNotEquals;
4  import static org.junit.Assert.assertNotNull;
5  import static org.junit.Assert.assertNull;
6  import static org.junit.Assert.assertTrue;
7  import static org.junit.Assert.fail;
8  import static redis.clients.jedis.util.AssertUtil.assertEqualsByProtocol;
9  import java.util.*;
10  import org.junit.BeforeClass;
11  import org.junit.Test;
12  import redis.clients.jedis.RedisProtocol;
13  import redis.clients.jedis.exceptions.JedisDataException;
14  import redis.clients.jedis.modules.RedisModuleCommandsTestBase;
15  import redis.clients.jedis.timeseries.*;
16  import redis.clients.jedis.util.KeyValue;
17  public class TimeSeriesTest extends RedisModuleCommandsTestBase {
18    @BeforeClass
19    public static void prepare() {
20      RedisModuleCommandsTestBase.prepare();
21    }
22    @Test
23    public void testCreate() {
24      Map<String, String> labels = new HashMap<>();
25      labels.put("l1", "v1");
26      labels.put("l2", "v2");
27      assertEquals("OK", client.tsCreate("series1", TSCreateParams.createParams().retention(10).labels(labels)));
28      assertEquals("TSDB-TYPE", client.type("series1"));
29      assertEquals("OK", client.tsCreate("series2", TSCreateParams.createParams().labels(labels)));
30      assertEquals("TSDB-TYPE", client.type("series2"));
31      assertEquals("OK", client.tsCreate("series3", TSCreateParams.createParams().retention(10)));
32      assertEquals("TSDB-TYPE", client.type("series3"));
33      assertEquals("OK", client.tsCreate("series4"));
34      assertEquals("TSDB-TYPE", client.type("series4"));
35      assertEquals("OK", client.tsCreate("series5", TSCreateParams.createParams().retention(0).uncompressed().labels(labels)));
36      assertEquals("TSDB-TYPE", client.type("series5"));
37      assertEquals("OK", client.tsCreate("series6", TSCreateParams.createParams().retention(7898)
38          .uncompressed().duplicatePolicy(DuplicatePolicy.MAX).labels(labels)));
39      assertEquals("TSDB-TYPE", client.type("series6"));
40      try {
41        assertEquals("OK", client.tsCreate("series1", TSCreateParams.createParams().retention(10).labels(labels)));
42        fail();
43      } catch (JedisDataException e) {
44      }
45      try {
46        assertEquals("OK", client.tsCreate("series1", TSCreateParams.createParams().labels(labels)));
47        fail();
48      } catch (JedisDataException e) {
49      }
50      try {
51        assertEquals("OK", client.tsCreate("series1", TSCreateParams.createParams().retention(10)));
52        fail();
53      } catch (JedisDataException e) {
54      }
55      try {
56        assertEquals("OK", client.tsCreate("series1"));
57        fail();
58      } catch (JedisDataException e) {
59      }
60      try {
61        assertEquals("OK", client.tsCreate("series1"));
62        fail();
63      } catch (JedisDataException e) {
64      }
65      try {
66        assertEquals("OK", client.tsCreate("series7", TSCreateParams.createParams().retention(7898)
67            .uncompressed().chunkSize(-10).duplicatePolicy(DuplicatePolicy.MAX).labels(labels)));
68        fail();
69      } catch (JedisDataException e) {
70      }
71    }
72    @Test
73    public void testAlter() {
74      Map<String, String> labels = new HashMap<>();
75      labels.put("l1", "v1");
76      labels.put("l2", "v2");
77      assertEquals("OK", client.tsCreate("seriesAlter", TSCreateParams.createParams().retention(60000).labels(labels)));
78      assertEquals(Collections.emptyList(), client.tsQueryIndex("l2=v22"));
79      labels.put("l1", "v11");
80      labels.remove("l2");
81      labels.put("l3", "v33");
82      assertEquals("OK", client.tsAlter("seriesAlter", TSAlterParams.alterParams().retention(15000).chunkSize(8192)
83          .duplicatePolicy(DuplicatePolicy.SUM).labels(labels)));
84      TSInfo info = client.tsInfo("seriesAlter");
85      assertEquals(Long.valueOf(15000), info.getProperty("retentionTime"));
86      assertEquals(Long.valueOf(8192), info.getProperty("chunkSize"));
87      assertEquals(DuplicatePolicy.SUM, info.getProperty("duplicatePolicy"));
88      assertEquals("v11", info.getLabel("l1"));
89      assertNull(info.getLabel("l2"));
90      assertEquals("v33", info.getLabel("l3"));
91    }
92    @Test
93    public void testRule() {
94      assertEquals("OK", client.tsCreate("source"));
95      assertEquals("OK", client.tsCreate("dest", TSCreateParams.createParams().retention(10)));
96      assertEquals("OK", client.tsCreateRule("source", "dest", AggregationType.AVG, 100));
97      try {
98        client.tsCreateRule("source", "dest", AggregationType.COUNT, 100);
99        fail();
100      } catch (JedisDataException e) {
101      }
102      assertEquals("OK", client.tsDeleteRule("source", "dest"));
103      assertEquals("OK", client.tsCreateRule("source", "dest", AggregationType.COUNT, 100));
104      try {
105        assertEquals("OK", client.tsDeleteRule("source", "dest1"));
106        fail();
107      } catch (JedisDataException e) {
108      }
109    }
110    @Test
111    public void testAdd() {
112      Map<String, String> labels = new HashMap<>();
113      labels.put("l1", "v1");
114      labels.put("l2", "v2");
115      assertEquals("OK", client.tsCreate("seriesAdd", TSCreateParams.createParams().retention(10000).labels(labels)));
116      assertEquals(0, client.tsRange("seriesAdd", TSRangeParams.rangeParams()).size());
117      assertEquals(1000L, client.tsAdd("seriesAdd", 1000L, 1.1, TSCreateParams.createParams().retention(10000).labels(null)));
118      assertEquals(2000L, client.tsAdd("seriesAdd", 2000L, 0.9, TSCreateParams.createParams().labels(null)));
119      assertEquals(3200L, client.tsAdd("seriesAdd", 3200L, 1.1, TSCreateParams.createParams().retention(10000)));
120      assertEquals(4500L, client.tsAdd("seriesAdd", 4500L, -1.1));
121      TSElement[] rawValues = new TSElement[]{
122        new TSElement(1000L, 1.1),
123        new TSElement(2000L, 0.9),
124        new TSElement(3200L, 1.1),
125        new TSElement(4500L, -1.1)
126      };
127      List<TSElement> values = client.tsRange("seriesAdd", 800L, 3000L);
128      assertEquals(2, values.size());
129      assertEquals(Arrays.asList(rawValues[0], rawValues[1]), values);
130      values = client.tsRange("seriesAdd", 800L, 5000L);
131      assertEquals(4, values.size());
132      assertEquals(Arrays.asList(rawValues), values);
133      assertEquals(Arrays.asList(rawValues), client.tsRange("seriesAdd", TSRangeParams.rangeParams()));
134      List<TSElement> expectedCountValues = Arrays.asList(
135          new TSElement(2000L, 1), new TSElement(3200L, 1), new TSElement(4500L, 1));
136      values = client.tsRange("seriesAdd", TSRangeParams.rangeParams(1200L, 4600L).aggregation(AggregationType.COUNT, 1));
137      assertEquals(3, values.size());
138      assertEquals(expectedCountValues, values);
139      List<TSElement> expectedAvgValues = Arrays.asList(
140          new TSElement(0L, 1.1), new TSElement(2000L, 1), new TSElement(4000L, -1.1));
141      values = client.tsRange("seriesAdd", TSRangeParams.rangeParams(500L, 4600L).aggregation(AggregationType.AVG, 2000L));
142      assertEquals(3, values.size());
143      assertEquals(expectedAvgValues, values);
144      List<TSElement> valuesZeroBased = client.tsRange("seriesAdd",
145          TSRangeParams.rangeParams(0L, 4600L).aggregation(AggregationType.AVG, 2000L));
146      assertEquals(3, valuesZeroBased.size());
147      assertEquals(values, valuesZeroBased);
148      List<TSElement> expectedOverallSumValues = Arrays.asList(new TSElement(0L, 2.0));
149      values = client.tsRange("seriesAdd", TSRangeParams.rangeParams(0L, 5000L).aggregation(AggregationType.SUM, 5000L));
150      assertEquals(1, values.size());
151      assertEquals(expectedOverallSumValues, values);
152      List<TSElement> expectedOverallMinValues = Arrays.asList(new TSElement(0L, -1.1));
153      values = client.tsRange("seriesAdd", TSRangeParams.rangeParams(0L, 5000L).aggregation(AggregationType.MIN, 5000L));
154      assertEquals(1, values.size());
155      assertEquals(expectedOverallMinValues, values);
156      List<TSElement> expectedOverallMaxValues = Arrays.asList(new TSElement(0L, 1.1));
157      values = client.tsRange("seriesAdd", TSRangeParams.rangeParams(0L, 5000L).aggregation(AggregationType.MAX, 5000L));
158      assertEquals(1, values.size());
159      assertEquals(expectedOverallMaxValues, values);
160      assertEquals(Collections.emptyMap(), client.tsMRange(TSMRangeParams.multiRangeParams().filter("l=v")));
161      try {
162        client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L).aggregation(AggregationType.COUNT, 1));
163        fail();
164      } catch (IllegalArgumentException e) {
165      }
166      try {
167        client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L).aggregation(AggregationType.COUNT, 1).filter((String) null));
168        fail();
169      } catch (IllegalArgumentException e) {
170      }
171      Map<String, TSMRangeElements> ranges = client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L)
172          .aggregation(AggregationType.COUNT, 1).filter("l1=v1"));
173      assertEquals(1, ranges.size());
174      TSMRangeElements range = ranges.values().stream().findAny().get();
175      assertEquals("seriesAdd", range.getKey());
176      assertEquals(Collections.emptyMap(), range.getLabels());
177      List<TSElement> rangeValues = range.getValue();
178      assertEquals(4, rangeValues.size());
179      assertEquals(new TSElement(1000, 1), rangeValues.get(0));
180      assertNotEquals(new TSElement(1000, 1.1), rangeValues.get(0));
181      assertEquals(2000L, rangeValues.get(1).getTimestamp());
182      assertEquals("(2000:1.0)", rangeValues.get(1).toString());
183      Map<String, String> labels2 = new HashMap<>();
184      labels2.put("l3", "v3");
185      labels2.put("l4", "v4");
186      assertEquals(1000L, client.tsAdd("seriesAdd2", 1000L, 1.1, TSCreateParams.createParams().retention(10000).labels(labels2)));
187      Map<String, TSMRangeElements> ranges2 = client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L)
188          .aggregation(AggregationType.COUNT, 1).withLabels().filter("l4=v4"));
189      assertEquals(1, ranges2.size());
190      TSMRangeElements elements2 = ranges2.values().stream().findAny().get();
191      assertEquals(labels2, elements2.getLabels());
192      assertEqualsByProtocol(protocol, null, Arrays.asList(AggregationType.COUNT), elements2.getAggregators());
193      Map<String, String> labels3 = new HashMap<>();
194      labels3.put("l3", "v33");
195      labels3.put("l4", "v4");
196      assertEquals(1000L, client.tsAdd("seriesAdd3", 1000L, 1.1, TSCreateParams.createParams().labels(labels3)));
197      assertEquals(2000L, client.tsAdd("seriesAdd3", 2000L, 1.1, TSCreateParams.createParams().labels(labels3)));
198      assertEquals(3000L, client.tsAdd("seriesAdd3", 3000L, 1.1, TSCreateParams.createParams().labels(labels3)));
199      Map<String, TSMRangeElements> ranges3 = client.tsMRange(TSMRangeParams.multiRangeParams(500L, 4600L)
200          .aggregation(AggregationType.AVG, 1L).withLabels(true).count(2).filter("l4=v4"));
201      assertEquals(2, ranges3.size());
202      ArrayList<TSMRangeElements> ranges3List = new ArrayList<>(ranges3.values());
203      assertEquals(1, ranges3List.get(0).getValue().size());
204      assertEquals(labels2, ranges3List.get(0).getLabels());
205      assertEqualsByProtocol(protocol, null, Arrays.asList(AggregationType.AVG), ranges3List.get(0).getAggregators());
206      assertEquals(2, ranges3List.get(1).getValue().size());
207      assertEquals(labels3, ranges3List.get(1).getLabels());
208      assertEqualsByProtocol(protocol, null, Arrays.asList(AggregationType.AVG), ranges3List.get(1).getAggregators());
209      assertEquals(800L, client.tsAdd("seriesAdd", 800L, 1.1));
210      assertEquals(700L, client.tsAdd("seriesAdd", 700L, 1.1, TSCreateParams.createParams().retention(10000)));
211      assertEquals(600L, client.tsAdd("seriesAdd", 600L, 1.1, TSCreateParams.createParams().retention(10000).labels(null)));
212      assertEquals(400L, client.tsAdd("seriesAdd4", 400L, 0.4, TSCreateParams.createParams()
213          .retention(7898L).uncompressed().chunkSize(1000L).duplicatePolicy(DuplicatePolicy.SUM)
214          .labels(labels)));
215      assertEquals("TSDB-TYPE", client.type("seriesAdd4"));
216      assertEquals(400L, client.tsAdd("seriesAdd4", 400L, 0.3, TSCreateParams.createParams()
217          .retention(7898L).uncompressed().chunkSize(1000L).duplicatePolicy(DuplicatePolicy.SUM)
218          .labels(labels)));
219      assertEquals(Arrays.asList(new TSElement(400L, 0.7)), client.tsRange("seriesAdd4", 0L, Long.MAX_VALUE));
220      try {
221        client.tsRange("seriesAdd1", TSRangeParams.rangeParams(500L, 4000L).aggregation(AggregationType.COUNT, 1));
222        fail();
223      } catch (JedisDataException e) {
224      }
225    }
226    @Test
227    public void issue75() {
228      client.tsMRange(TSMRangeParams.multiRangeParams().filter("id=1"));
229    }
230    @Test
231    public void del() {
232      try {
233        client.tsDel("ts-del", 0, 1);
234        fail();
235      } catch (JedisDataException jde) {
236      }
237      assertEquals("OK", client.tsCreate("ts-del", TSCreateParams.createParams().retention(10000L)));
238      assertEquals(0, client.tsDel("ts-del", 0, 1));
239      assertEquals(1000L, client.tsAdd("ts-del", 1000L, 1.1, TSCreateParams.createParams().retention(10000)));
240      assertEquals(2000L, client.tsAdd("ts-del", 2000L, 0.9));
241      assertEquals(3200L, client.tsAdd("ts-del", 3200L, 1.1, TSCreateParams.createParams().retention(10000)));
242      assertEquals(4500L, client.tsAdd("ts-del", 4500L, -1.1));
243      assertEquals(4, client.tsRange("ts-del", 0, 5000).size());
244      assertEquals(2, client.tsDel("ts-del", 2000, 4000));
245      assertEquals(2, client.tsRange("ts-del", 0, 5000).size());
246      assertEquals(1, client.tsRange("ts-del", 0, 2500).size());
247      assertEquals(1, client.tsRange("ts-del", 2500, 5000).size());
248    }
249    @Test
250    public void testValue() {
251      TSElement v = new TSElement(1234, 234.89634);
252      assertEquals(1234, v.getTimestamp());
253      assertEquals(234.89634, v.getValue(), 0);
254      assertEquals(v, new TSElement(1234, 234.89634));
255      assertNotEquals(v, new TSElement(1334, 234.89634));
256      assertNotEquals(v, new TSElement(1234, 234.8934));
257      assertNotEquals(1234, v.getValue());
258      assertEquals("(1234:234.89634)", v.toString());
259      assertEquals(-1856719580, v.hashCode());
260    }
261    @Test
262    public void testAddStar() throws InterruptedException {
263      Map<String, String> labels = new HashMap<>();
264      labels.put("l11", "v11");
265      labels.put("l22", "v22");
266      assertEquals("OK", client.tsCreate("seriesAdd2", TSCreateParams.createParams().retention(10000L).labels(labels)));
267      long startTime = System.currentTimeMillis();
268      Thread.sleep(1);
269      long add1 = client.tsAdd("seriesAdd2", 1.1);
270      assertTrue(add1 > startTime);
271      Thread.sleep(1);
272      long add2 = client.tsAdd("seriesAdd2", 3.2);
273      assertTrue(add2 > add1);
274      Thread.sleep(1);
275      long add3 = client.tsAdd("seriesAdd2", 3.2);
276      assertTrue(add3 > add2);
277      Thread.sleep(1);
278      long add4 = client.tsAdd("seriesAdd2", -1.2);
279      assertTrue(add4 > add3);
280      Thread.sleep(1);
281      long endTime = System.currentTimeMillis();
282      assertTrue(endTime > add4);
283      List<TSElement> values = client.tsRange("seriesAdd2", startTime, add3);
284      assertEquals(3, values.size());
285    }
286    @Test
287    public void testMadd() {
288      Map<String, String> labels = new HashMap<>();
289      labels.put("l1", "v1");
290      labels.put("l2", "v2");
291      assertEquals("OK", client.tsCreate("seriesAdd1", TSCreateParams.createParams().retention(10000L).labels(labels)));
292      assertEquals("OK", client.tsCreate("seriesAdd2", TSCreateParams.createParams().retention(10000L).labels(labels)));
293      List<Long> result = client.tsMAdd(
294          new KeyValue<>("seriesAdd1", new TSElement(1000L, 1.1)),
295          new KeyValue<>("seriesAdd2", new TSElement(2000L, 3.2)),
296          new KeyValue<>("seriesAdd1", new TSElement(1500L, 2.67)),
297          new KeyValue<>("seriesAdd2", new TSElement(3200L, 54.2)),
298          new KeyValue<>("seriesAdd2", new TSElement(4300L, 21.2)));
299      assertEquals(1000L, result.get(0).longValue());
300      assertEquals(2000L, result.get(1).longValue());
301      assertEquals(1500L, result.get(2).longValue());
302      assertEquals(3200L, result.get(3).longValue());
303      assertEquals(4300L, result.get(4).longValue());
304      List<TSElement> values1 = client.tsRange("seriesAdd1", 0, Long.MAX_VALUE);
305      assertEquals(2, values1.size());
306      assertEquals(1.1, values1.get(0).getValue(), 0.001);
307      assertEquals(2.67, values1.get(1).getValue(), 0.001);
308      List<TSElement> values2 = client.tsRange("seriesAdd2", TSRangeParams.rangeParams(0, Long.MAX_VALUE).count(2));
309      assertEquals(2, values2.size());
310      assertEquals(3.2, values2.get(0).getValue(), 0.001);
311      assertEquals(54.2, values2.get(1).getValue(), 0.001);
312    }
313    @Test
314    public void testIncrByDecrBy() throws InterruptedException {
315      assertEquals("OK", client.tsCreate("seriesIncDec",
316          TSCreateParams.createParams().retention(100 * 1000 &bsol;*100 sec*/)));
317      assertEquals(1L, client.tsAdd("seriesIncDec", 1L, 1), 0);
318      assertEquals(2L, client.tsIncrBy("seriesIncDec", 3, 2L), 0);
319      assertEquals(3L, client.tsDecrBy("seriesIncDec", 2, 3L), 0);
320      List<TSElement> values = client.tsRange("seriesIncDec", 1L, 3L);
321      assertEquals(3, values.size());
322      assertEquals(2, values.get(2).getValue(), 0);
323      assertEquals(3L, client.tsDecrBy("seriesIncDec", 2, 3L), 0);
324      values = client.tsRange("seriesIncDec", 1L, Long.MAX_VALUE);
325      assertEquals(3, values.size());
326      client.tsIncrBy("seriesIncDec", 100);
327      client.tsDecrBy("seriesIncDec", 33);
328    }
329    @Test
330    public void align() {
331      client.tsAdd("align", 1, 10d);
332      client.tsAdd("align", 3, 5d);
333      client.tsAdd("align", 11, 10d);
334      client.tsAdd("align", 25, 11d);
335      List<TSElement> values = client.tsRange("align", TSRangeParams.rangeParams(1L, 30L).aggregation(AggregationType.COUNT, 10));
336      assertEquals(Arrays.asList(new TSElement(1, 2), new TSElement(11, 1), new TSElement(21, 1)), values);
337      values = client.tsRange("align", TSRangeParams.rangeParams(1L, 30L).alignStart().aggregation(AggregationType.COUNT, 10));
338      assertEquals(Arrays.asList(new TSElement(1, 2), new TSElement(11, 1), new TSElement(21, 1)), values);
339      values = client.tsRange("align", TSRangeParams.rangeParams(1L, 30L).alignEnd().aggregation(AggregationType.COUNT, 10));
340      assertEquals(Arrays.asList(new TSElement(1, 2), new TSElement(11, 1), new TSElement(21, 1)), values);
341      values =
342          client.tsRange("align", TSRangeParams.rangeParams(1L, 30L).align(5).aggregation(AggregationType.COUNT, 10));
343      assertEquals(Arrays.asList(new TSElement(1, 2), new TSElement(11, 1), new TSElement(21, 1)), values);
344    }
345    @Test
346    public void rangeFilterBy() {
347      TSElement[] rawValues =
348          new TSElement[] {
<span onclick='openModal()' class='match'>349            new TSElement(1000L, 1.0),
350            new TSElement(2000L, 0.9),
351            new TSElement(3200L, 1.1),
</span>352            new TSElement(4500L, -1.1)
353          };
354      for (TSElement value : rawValues) {
355        client.tsAdd("filterBy", value.getTimestamp(), value.getValue());
356      }
357      List<TSElement> values = client.tsRange("filterBy", 0L, 5000L);
358      assertEquals(Arrays.asList(rawValues), values);
359      values = client.tsRange("filterBy", TSRangeParams.rangeParams(0L, 5000L).filterByTS(1000L, 2000L));
360      assertEquals(Arrays.asList(rawValues[0], rawValues[1]), values);
361      values = client.tsRange("filterBy", TSRangeParams.rangeParams(0L, 5000L).filterByValues(1.0, 1.2));
362      assertEquals(Arrays.asList(rawValues[0], rawValues[2]), values);
363      values = client.tsRange("filterBy", TSRangeParams.rangeParams(0L, 5000L).filterByTS(1000L, 2000L).filterByValues(1.0, 1.2));
364      assertEquals(Arrays.asList(rawValues[0]), values);
365      values = client.tsRevRange("filterBy", 0L, 5000L);
366      assertEquals(Arrays.asList(rawValues[3], rawValues[2], rawValues[1], rawValues[0]), values);
367      values =
368          client.tsRevRange("filterBy", TSRangeParams.rangeParams(0L, 5000L).filterByTS(1000L, 2000L));
369      assertEquals(Arrays.asList(rawValues[1], rawValues[0]), values);
370      values =
371          client.tsRevRange("filterBy", TSRangeParams.rangeParams(0L, 5000L).filterByValues(1.0, 1.2));
372      assertEquals(Arrays.asList(rawValues[2], rawValues[0]), values);
373      values =
374          client.tsRevRange("filterBy", TSRangeParams.rangeParams(0L, 5000L).filterByTS(1000L, 2000L).filterByValues(1.0, 1.2));
375      assertEquals(Arrays.asList(rawValues[0]), values);
376    }
377    @Test
378    public void mrangeFilterBy() {
379      Map<String, String> labels = Collections.singletonMap("label", "multi");
380      client.tsCreate("ts1", TSCreateParams.createParams().labels(labels));
381      client.tsCreate("ts2", TSCreateParams.createParams().labels(labels));
382      String filter = "label=multi";
383      TSElement[] rawValues = new TSElement[]{
384        new TSElement(1000L, 1.0),
385        new TSElement(2000L, 0.9),
386        new TSElement(3200L, 1.1),
387        new TSElement(4500L, -1.1)
388      };
389      client.tsAdd("ts1", rawValues[0].getTimestamp(), rawValues[0].getValue());
390      client.tsAdd("ts2", rawValues[1].getTimestamp(), rawValues[1].getValue());
391      client.tsAdd("ts2", rawValues[2].getTimestamp(), rawValues[2].getValue());
392      client.tsAdd("ts1", rawValues[3].getTimestamp(), rawValues[3].getValue());
393      Map<String, TSMRangeElements> range = client.tsMRange(0L, 5000L, filter);
394      ArrayList<TSMRangeElements> rangeList = new ArrayList<>(range.values());
395      assertEquals("ts1", rangeList.get(0).getKey());
396      assertEquals(Arrays.asList(rawValues[0], rawValues[3]), rangeList.get(0).getValue());
397      assertEquals("ts2", rangeList.get(1).getKey());
398      assertEquals(Arrays.asList(rawValues[1], rawValues[2]), rangeList.get(1).getValue());
399      range = client.tsMRange(TSMRangeParams.multiRangeParams(0L, 5000L).filterByTS(1000L, 2000L).filter(filter));
400      rangeList = new ArrayList<>(range.values());
401      assertEquals("ts1", rangeList.get(0).getKey());
402      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
403      assertEquals("ts2", rangeList.get(1).getKey());
404      assertEquals(Arrays.asList(rawValues[1]), rangeList.get(1).getValue());
405      range = client.tsMRange(TSMRangeParams.multiRangeParams(0L, 5000L).filterByValues(1.0, 1.2).filter(filter));
406      rangeList = new ArrayList<>(range.values());
407      assertEquals("ts1", rangeList.get(0).getKey());
408      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
409      assertEquals("ts2", rangeList.get(1).getKey());
410      assertEquals(Arrays.asList(rawValues[2]), rangeList.get(1).getValue());
411      range = client.tsMRange(TSMRangeParams.multiRangeParams(0L, 5000L)
412          .filterByTS(1000L, 2000L).filterByValues(1.0, 1.2).filter(filter));
413      rangeList = new ArrayList<>(range.values());
414      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
415      range = client.tsMRevRange(0L, 5000L,  filter);
416      rangeList = new ArrayList<>(range.values());
417      assertEquals("ts1", rangeList.get(0).getKey());
418      assertEquals(Arrays.asList(rawValues[3], rawValues[0]), rangeList.get(0).getValue());
419      assertEquals("ts2", rangeList.get(1).getKey());
420      assertEquals(Arrays.asList(rawValues[2], rawValues[1]), rangeList.get(1).getValue());
421      range = client.tsMRevRange(TSMRangeParams.multiRangeParams(0L, 5000L).filterByTS(1000L, 2000L).filter(filter));
422      rangeList = new ArrayList<>(range.values());
423      assertEquals("ts1", rangeList.get(0).getKey());
424      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
425      assertEquals("ts2", rangeList.get(1).getKey());
426      assertEquals(Arrays.asList(rawValues[1]), rangeList.get(1).getValue());
427      range = client.tsMRevRange(TSMRangeParams.multiRangeParams(0L, 5000L).filterByValues(1.0, 1.2).filter(filter));
428      rangeList = new ArrayList<>(range.values());
429      assertEquals("ts1", rangeList.get(0).getKey());
430      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
431      assertEquals("ts2", rangeList.get(1).getKey());
432      assertEquals(Arrays.asList(rawValues[2]), rangeList.get(1).getValue());
433      range = client.tsMRevRange(TSMRangeParams.multiRangeParams(0L, 5000L)
434          .filterByTS(1000L, 2000L).filterByValues(1.0, 1.2).filter(filter));
435      rangeList = new ArrayList<>(range.values());
436      assertEquals(Arrays.asList(rawValues[0]), rangeList.get(0).getValue());
437    }
438    @Test
439    public void groupByReduce() {
440      client.tsCreate("ts1", TSCreateParams.createParams().labels(convertMap("metric", "cpu", "metric_name", "system")));
441      client.tsCreate("ts2", TSCreateParams.createParams().labels(convertMap("metric", "cpu", "metric_name", "user")));
442      client.tsAdd("ts1", 1L, 90.0);
443      client.tsAdd("ts1", 2L, 45.0);
444      client.tsAdd("ts2", 2L, 99.0);
445      Map<String, TSMRangeElements> range = client.tsMRange(TSMRangeParams.multiRangeParams(0L, 100L).withLabels()
446          .filter("metric=cpu").groupBy("metric_name", "max"));
447      assertEquals(2, range.size());
448      ArrayList<TSMRangeElements> rangeList = new ArrayList<>(range.values());
449      assertEquals("metric_name=system", rangeList.get(0).getKey());
450      assertEquals("system", rangeList.get(0).getLabels().get("metric_name"));
451      if (protocol != RedisProtocol.RESP3) {
452        assertEquals("max", rangeList.get(0).getLabels().get("__reducer__"));
453        assertEquals("ts1", rangeList.get(0).getLabels().get("__source__"));
454      } else {
455        assertEquals(Arrays.asList("max"), rangeList.get(0).getReducers());
456        assertEquals(Arrays.asList("ts1"), rangeList.get(0).getSources());
457      }
458      assertEquals(Arrays.asList(new TSElement(1, 90), new TSElement(2, 45)), rangeList.get(0).getValue());
459      assertEquals("metric_name=user", rangeList.get(1).getKey());
460      assertEquals("user", rangeList.get(1).getLabels().get("metric_name"));
461      if (protocol != RedisProtocol.RESP3) {
462        assertEquals("max", rangeList.get(1).getLabels().get("__reducer__"));
463        assertEquals("ts2", rangeList.get(1).getLabels().get("__source__"));
464      } else {
465        assertEquals(Arrays.asList("max"), rangeList.get(1).getReducers());
466        assertEquals(Arrays.asList("ts2"), rangeList.get(1).getSources());
467      }
468      assertEquals(Arrays.asList(new TSElement(2, 99)), rangeList.get(1).getValue());
469    }
470    private Map<String, String> convertMap(String... array) {
471      Map<String, String> map = new HashMap<>(array.length / 2);
472      for (int i = 0; i < array.length; i += 2) {
473        map.put(array[i], array[i + 1]);
474      }
475      return map;
476    }
477    @Test
478    public void testGet() {
479      try {
480        client.tsGet("seriesGet");
481        fail();
482      } catch (JedisDataException e) {
483      }
484      assertEquals("OK", client.tsCreate("seriesGet", TSCreateParams.createParams()
485          .retention(100 * 1000 &bsol;*100sec retentionTime*/)));
486      assertNull(client.tsGet("seriesGet"));
487      client.tsAdd("seriesGet", 2558, 8.7);
488      assertEquals(new TSElement(2558, 8.7), client.tsGet("seriesGet"));
489      client.tsAdd("seriesGet", 3458, 1.117);
490      assertEquals(new TSElement(3458, 1.117), client.tsGet("seriesGet"));
491    }
492    @Test
493    public void testMGet() {
494      Map<String, String> labels = new HashMap<>();
495      labels.put("l1", "v1");
496      labels.put("l2", "v2");
497      assertEquals("OK", client.tsCreate("seriesMGet1", TSCreateParams.createParams()
498          .retention(100 * 1000 &bsol;*100sec retentionTime*/).labels(labels)));
499      assertEquals("OK", client.tsCreate("seriesMGet2", TSCreateParams.createParams()
500          .retention(100 * 1000 &bsol;*100sec retentionTime*/).labels(labels)));
501      Map<String, TSMGetElement> ranges1 = client.tsMGet(TSMGetParams.multiGetParams().withLabels(false), "l1=v2");
502      assertEquals(0, ranges1.size());
503      Map<String, TSMGetElement> ranges2 = client.tsMGet(TSMGetParams.multiGetParams().withLabels(true), "l1=v1");
504      assertEquals(2, ranges2.size());
505      ArrayList<TSMGetElement> ranges2List = new ArrayList<>(ranges2.values());
506      assertEquals(labels, ranges2List.get(0).getLabels());
507      assertEquals(labels, ranges2List.get(1).getLabels());
508      assertNull(ranges2List.get(0).getValue());
509      client.tsAdd("seriesMGet1", 1500, 1.3);
510      Map<String, TSMGetElement> ranges3 = client.tsMGet(TSMGetParams.multiGetParams().withLabels(false), "l1=v1");
511      assertEquals(2, ranges3.size());
512      ArrayList<TSMGetElement> ranges3List = new ArrayList<>(ranges3.values());
513      assertEquals(Collections.emptyMap(), ranges3List.get(0).getLabels());
514      assertEquals(Collections.emptyMap(), ranges3List.get(1).getLabels());
515      assertEquals(new TSElement(1500, 1.3), ranges3List.get(0).getValue());
516      assertNull(ranges3List.get(1).getValue());
517    }
518    @Test
519    public void testQueryIndex() {
520      Map<String, String> labels = new HashMap<>();
521      labels.put("l1", "v1");
522      labels.put("l2", "v2");
523      assertEquals("OK", client.tsCreate("seriesQueryIndex1", TSCreateParams.createParams()
524          .retention(100 * 1000 &bsol;*100sec retentionTime*/).labels(labels)));
525      labels.put("l2", "v22");
526      labels.put("l3", "v33");
527      assertEquals("OK", client.tsCreate("seriesQueryIndex2", TSCreateParams.createParams()
528          .retention(100 * 1000 &bsol;*100sec retentionTime*/).labels(labels)));
529      assertEquals(Arrays.<String>asList(), client.tsQueryIndex("l1=v2"));
530      assertEquals(Arrays.asList("seriesQueryIndex1", "seriesQueryIndex2"), client.tsQueryIndex("l1=v1"));
531      assertEquals(Arrays.asList("seriesQueryIndex2"), client.tsQueryIndex("l2=v22"));
532    }
533    @Test
534    public void testInfo() {
535      Map<String, String> labels = new HashMap<>();
536      labels.put("l1", "v1");
537      labels.put("l2", "v2");
538      assertEquals("OK", client.tsCreate("source", TSCreateParams.createParams().retention(10000L).labels(labels)));
539      assertEquals("OK", client.tsCreate("dest", TSCreateParams.createParams().retention(20000L)));
540      assertEquals("OK", client.tsCreateRule("source", "dest", AggregationType.AVG, 100));
541      TSInfo info = client.tsInfo("source");
542      assertEquals((Long) 10000L, info.getProperty("retentionTime"));
543      assertEquals((Long) 4096L, info.getProperty("chunkSize"));
544      assertEquals("v1", info.getLabel("l1"));
545      assertEquals("v2", info.getLabel("l2"));
546      assertNull(info.getLabel("l3"));
547      assertEquals(1, info.getRules().size());
548      TSInfo.Rule rule = info.getRule("dest");
549      assertEquals("dest", rule.getCompactionKey());
550      assertEquals(100L, rule.getBucketDuration());
551      assertEquals(AggregationType.AVG, rule.getAggregator());
552      try {
553        client.tsInfo("none");
554        fail();
555      } catch (JedisDataException e) {
556      }
557    }
558    @Test
559    public void testInfoDebug() {
560      assertEquals("OK", client.tsCreate("source", TSCreateParams.createParams()));
561      TSInfo info = client.tsInfoDebug("source");
562      assertEquals((Long) 0L, info.getProperty("retentionTime"));
563      assertEquals(0, info.getLabels().size());
564      assertEquals(0, info.getRules().size());
565      List<Map<String, Object>> chunks = info.getChunks();
566      assertEquals(1, chunks.size());
567      Map<String, Object> chunk = chunks.get(0);
568      assertEquals(0L, chunk.get("samples"));
569      assertTrue(chunk.get("size") instanceof Long);
570      assertTrue(chunk.get("startTimestamp") instanceof Long);
571      assertTrue(chunk.get("endTimestamp") instanceof Long);
572      assertTrue(chunk.get("bytesPerSample") instanceof Double);
573      try {
574        client.tsInfoDebug("none");
575        fail();
576      } catch (JedisDataException e) {
577      }
578    }
579    @Test
580    public void testRevRange() {
581      Map<String, String> labels = new HashMap<>();
582      labels.put("l1", "v1");
583      labels.put("l2", "v2");
584      assertEquals("OK", client.tsCreate("seriesAdd", TSCreateParams.createParams().retention(10000L).labels(labels)));
585      assertEquals(Collections.emptyList(), client.tsRevRange("seriesAdd", TSRangeParams.rangeParams()));
586      assertEquals(1000L, client.tsAdd("seriesRevRange", 1000L, 1.1, TSCreateParams.createParams().retention(10000)));
587      assertEquals(2000L, client.tsAdd("seriesRevRange", 2000L, 0.9, TSCreateParams.createParams().labels(null)));
588      assertEquals(3200L, client.tsAdd("seriesRevRange", 3200L, 1.1, TSCreateParams.createParams().retention(10000)));
589      assertEquals(4500L, client.tsAdd("seriesRevRange", 4500L, -1.1));
590      TSElement[] rawValues = new TSElement[]{
591        new TSElement(4500L, -1.1),
592        new TSElement(3200L, 1.1),
593        new TSElement(2000L, 0.9),
594        new TSElement(1000L, 1.1)
595      };
596      List<TSElement> values = client.tsRevRange("seriesRevRange", 800L, 3000L);
597      assertEquals(2, values.size());
598      assertEquals(Arrays.asList(Arrays.copyOfRange(rawValues, 2, 4)), values);
599      values = client.tsRevRange("seriesRevRange", 800L, 5000L);
600      assertEquals(4, values.size());
601      assertEquals(Arrays.asList(rawValues), values);
602      assertEquals(Arrays.asList(rawValues), client.tsRevRange("seriesRevRange", TSRangeParams.rangeParams()));
603      List<TSElement> expectedCountValues = Arrays.asList(
604          new TSElement(4500L, 1), new TSElement(3200L, 1), new TSElement(2000L, 1));
605      values = client.tsRevRange("seriesRevRange", TSRangeParams.rangeParams(1200L, 4600L)
606          .aggregation(AggregationType.COUNT, 1));
607      assertEquals(3, values.size());
608      assertEquals(expectedCountValues, values);
609      List<TSElement> expectedAvgValues = Arrays.asList(
610          new TSElement(4000L, -1.1), new TSElement(2000L, 1), new TSElement(0L, 1.1));
611      values = client.tsRevRange("seriesRevRange", TSRangeParams.rangeParams(500L, 4600L)
612          .aggregation(AggregationType.AVG, 2000L));
613      assertEquals(3, values.size());
614      assertEquals(expectedAvgValues, values);
615    }
616    @Test
617    public void testMRevRange() {
618      assertEquals(Collections.emptyMap(), client.tsMRevRange(TSMRangeParams.multiRangeParams().filter("l=v")));
619      Map<String, String> labels1 = new HashMap<>();
620      labels1.put("l3", "v3");
621      labels1.put("l4", "v4");
622      assertEquals(1000L, client.tsAdd("seriesMRevRange1", 1000L, 1.1,
623          TSCreateParams.createParams().retention(10000).labels(labels1)));
624      assertEquals(2222L, client.tsAdd("seriesMRevRange1", 2222L, 3.1,
625          TSCreateParams.createParams().retention(10000).labels(labels1)));
626      Map<String, TSMRangeElements> ranges1 = client.tsMRevRange(TSMRangeParams.multiRangeParams(500L, 4600L)
627          .aggregation(AggregationType.COUNT, 1).withLabels().filter("l4=v4"));
628      assertEquals(1, ranges1.size());
629      ArrayList<TSMRangeElements> ranges1List = new ArrayList<>(ranges1.values());
630      assertEquals(labels1, ranges1List.get(0).getLabels());
631      assertEquals(Arrays.asList(new TSElement(2222L, 1.0), new TSElement(1000L, 1.0)), ranges1List.get(0).getValue());
632      Map<String, String> labels2 = new HashMap<>();
633      labels2.put("l3", "v3");
634      labels2.put("l4", "v44");
635      assertEquals(1000L, client.tsAdd("seriesMRevRange2", 1000L, 8.88,
636          TSCreateParams.createParams().retention(10000).labels(labels2)));
637      assertEquals(1111L, client.tsAdd("seriesMRevRange2", 1111L, 99.99,
638          TSCreateParams.createParams().retention(10000).labels(labels2)));
639      Map<String, TSMRangeElements> ranges2 = client.tsMRevRange(500L, 4600L, "l3=v3");
640      assertEquals(2, ranges2.size());
641      ArrayList<TSMRangeElements> ranges2List = new ArrayList<>(ranges2.values());
642      assertEquals(Collections.emptyMap(), ranges2List.get(0).getLabels());
643      assertEquals(Arrays.asList(new TSElement(2222L, 3.1), new TSElement(1000L, 1.1)), ranges2List.get(0).getValue());
644      assertEquals(Collections.emptyMap(), ranges2List.get(0).getLabels());
645      assertEquals(Arrays.asList(new TSElement(1111L, 99.99), new TSElement(1000L, 8.88)), ranges2List.get(1).getValue());
646      Map<String, String> labels3 = new HashMap<>();
647      labels3.put("l3", "v33");
648      labels3.put("l4", "v4");
649      assertEquals(2200L, client.tsAdd("seriesMRevRange3", 2200L, -1.1, TSCreateParams.createParams().labels(labels3)));
650      assertEquals(2400L, client.tsAdd("seriesMRevRange3", 2400L, 1.1, TSCreateParams.createParams().labels(labels3)));
651      assertEquals(3300L, client.tsAdd("seriesMRevRange3", 3300L, -33, TSCreateParams.createParams().labels(labels3)));
652      Map<String, TSMRangeElements> ranges3 = client.tsMRevRange(TSMRangeParams.multiRangeParams(500L, 4600L)
653          .aggregation(AggregationType.AVG, 500).withLabels().count(5).filter("l4=v4"));
654      assertEquals(2, ranges3.size());
655      ArrayList<TSMRangeElements> ranges3List = new ArrayList<>(ranges3.values());
656      assertEquals(labels1, ranges3List.get(0).getLabels());
657      assertEquals(Arrays.asList(new TSElement(2000L, 3.1), new TSElement(1000L, 1.1)), ranges3List.get(0).getValue());
658      assertEquals(labels3, ranges3List.get(1).getLabels());
659      assertEquals(Arrays.asList(new TSElement(3000L, -33.0), new TSElement(2000L, 0.0)), ranges3List.get(1).getValue());
660    }
661    @Test
662    public void latest() {
663      client.tsCreate("ts1");
664      client.tsCreate("ts2");
665      client.tsCreateRule("ts1", "ts2", AggregationType.SUM, 10);
666      client.tsAdd("ts1", 1, 1);
667      client.tsAdd("ts1", 2, 3);
668      client.tsAdd("ts1", 11, 7);
669      client.tsAdd("ts1", 13, 1);
670      List<TSElement> range = client.tsRange("ts1", 0, 20);
671      assertEquals(4, range.size());
672      final TSElement compact = new TSElement(0, 4);
673      final TSElement latest = new TSElement(10, 8);
674      assertEquals(compact, client.tsGet("ts2", TSGetParams.getParams()));
675      assertEquals(latest, client.tsGet("ts2", TSGetParams.getParams().latest()));
676      assertEquals(Arrays.asList(compact), client.tsRange("ts2", TSRangeParams.rangeParams(0, 10)));
677      assertEquals(Arrays.asList(compact, latest), client.tsRange("ts2", TSRangeParams.rangeParams(0, 10).latest()));
678      assertEquals(Arrays.asList(compact), client.tsRevRange("ts2", TSRangeParams.rangeParams(0, 10)));
679      assertEquals(Arrays.asList(latest, compact), client.tsRevRange("ts2", TSRangeParams.rangeParams(0, 10).latest()));
680    }
681    @Test
682    public void latestMulti() {
683      client.tsCreate("ts1");
684      client.tsCreate("ts2", TSCreateParams.createParams().label("compact", "true"));
685      client.tsCreateRule("ts1", "ts2", AggregationType.SUM, 10);
686      client.tsAdd("ts1", 1, 1);
687      client.tsAdd("ts1", 2, 3);
688      client.tsAdd("ts1", 11, 7);
689      client.tsAdd("ts1", 13, 1);
690      List<TSElement> range = client.tsRange("ts1", 0, 20);
691      assertEquals(4, range.size());
692      final TSElement compact = new TSElement(0, 4);
693      final TSElement latest = new TSElement(10, 8);
694      assertEquals(makeSingletonMap(new TSMGetElement("ts2", null, compact)),
695          client.tsMGet(TSMGetParams.multiGetParams(), "compact=true"));
696      assertEquals(makeSingletonMap(new TSMGetElement("ts2", null, latest)),
697          client.tsMGet(TSMGetParams.multiGetParams().latest(), "compact=true"));
698      assertEquals(makeSingletonMap(new TSMRangeElements("ts2", null, Arrays.asList(compact))),
699          client.tsMRange(TSMRangeParams.multiRangeParams().filter("compact=true")));
700      assertEquals(makeSingletonMap(new TSMRangeElements("ts2", null, Arrays.asList(compact, latest))),
701          client.tsMRange(TSMRangeParams.multiRangeParams().latest().filter("compact=true")));
702      assertEquals(makeSingletonMap(new TSMRangeElements("ts2", null, Arrays.asList(compact))),
703          client.tsMRevRange(TSMRangeParams.multiRangeParams().filter("compact=true")));
704      assertEquals(makeSingletonMap(new TSMRangeElements("ts2", null, Arrays.asList(latest, compact))),
705          client.tsMRevRange(TSMRangeParams.multiRangeParams().latest().filter("compact=true")));
706    }
707    private Map<String, TSMGetElement> makeSingletonMap(TSMGetElement value) {
708      return Collections.singletonMap(value.getKey(), value);
709    }
710    private Map<String, TSMRangeElements> makeSingletonMap(TSMRangeElements value) {
711      return Collections.singletonMap(value.getKey(), value);
712    }
713    @Test
714    public void empty() {
715      client.tsCreate("ts", TSCreateParams.createParams().label("l", "v"));
716      client.tsAdd("ts", 1, 1);
717      client.tsAdd("ts", 2, 3);
718      client.tsAdd("ts", 11, 7);
719      client.tsAdd("ts", 13, 1);
720      List<TSElement> range = client.tsRange("ts", TSRangeParams.rangeParams().aggregation(AggregationType.MAX, 5));
721      assertEquals(2, range.size());
722      range = client.tsRange("ts", TSRangeParams.rangeParams().aggregation(AggregationType.MAX, 5).empty());
723      assertEquals(3, range.size());
724      assertNotNull(range.get(1).getValue()); 
725      range = client.tsRevRange("ts", TSRangeParams.rangeParams().aggregation(AggregationType.MIN, 5));
726      assertEquals(2, range.size());
727      range = client.tsRevRange("ts", TSRangeParams.rangeParams().aggregation(AggregationType.MIN, 5).empty());
728      assertEquals(3, range.size());
729      assertNotNull(range.get(1).getValue()); 
730      Map<String, TSMRangeElements> mrange = client.tsMRange(TSMRangeParams.multiRangeParams()
731          .aggregation(AggregationType.MIN, 5).filter("l=v"));
732      assertEquals(1, mrange.size());
733      ArrayList<TSMRangeElements> mrangeList = new ArrayList<>(mrange.values());
734      assertEquals(2, mrangeList.get(0).getValue().size());
735      mrange = client.tsMRange(TSMRangeParams.multiRangeParams()
736          .aggregation(AggregationType.MIN, 5).empty().filter("l=v"));
737      assertEquals(1, mrange.size());
738      mrangeList = new ArrayList<>(mrange.values());
739      assertEquals(3, mrangeList.get(0).getValue().size());
740      assertNotNull(mrangeList.get(0).getValue().get(1).getValue()); 
741      mrange = client.tsMRevRange(TSMRangeParams.multiRangeParams()
742          .aggregation(AggregationType.MAX, 5).filter("l=v"));
743      assertEquals(1, mrange.size());
744      mrangeList = new ArrayList<>(mrange.values());
745      assertEquals(2, mrangeList.get(0).getValue().size());
746      mrange = client.tsMRevRange(TSMRangeParams.multiRangeParams()
747          .aggregation(AggregationType.MAX, 5).empty().filter("l=v"));
748      assertEquals(1, mrange.size());
749      mrangeList = new ArrayList<>(mrange.values());
750      assertEquals(3, mrangeList.get(0).getValue().size());
751      assertNotNull(mrangeList.get(0).getValue().get(1).getValue()); 
752    }
753    @Test
754    public void bucketTimestamp() {
755      client.tsCreate("ts", TSCreateParams.createParams().label("l", "v"));
756      client.tsAdd("ts", 1, 1);
757      client.tsAdd("ts", 2, 3);
758      assertEquals(0, client.tsRange("ts", TSRangeParams.rangeParams()
759          .aggregation(AggregationType.FIRST, 10).bucketTimestampLow()).get(0).getTimestamp());
760      assertEquals(10, client.tsRange("ts", TSRangeParams.rangeParams()
761          .aggregation(AggregationType.LAST, 10).bucketTimestampHigh()).get(0).getTimestamp());
762      assertEquals(5, client.tsRange("ts", TSRangeParams.rangeParams()
763          .aggregation(AggregationType.RANGE, 10).bucketTimestampMid()).get(0).getTimestamp());
764      assertEquals(5, client.tsRevRange("ts", TSRangeParams.rangeParams()
765          .aggregation(AggregationType.TWA, 10).bucketTimestampMid()).get(0).getTimestamp());
766      assertEquals(5, client.tsRevRange("ts", TSRangeParams.rangeParams()
767          .aggregation(AggregationType.TWA, 10).bucketTimestamp("mid")).get(0).getTimestamp());
768      assertEquals(0, client.tsMRange(TSMRangeParams.multiRangeParams()
769          .aggregation(AggregationType.STD_P, 10).bucketTimestampLow().filter("l=v"))
770          .values().stream().findAny().get().getValue().get(0).getTimestamp());
771      assertEquals(10, client.tsMRange(TSMRangeParams.multiRangeParams()
772          .aggregation(AggregationType.STD_S, 10).bucketTimestampHigh().filter("l=v"))
773          .values().stream().findAny().get().getValue().get(0).getTimestamp());
774      assertEquals(5, client.tsMRange(TSMRangeParams.multiRangeParams()
775          .aggregation(AggregationType.TWA, 10).bucketTimestampMid().filter("l=v"))
776          .values().stream().findAny().get().getValue().get(0).getTimestamp());
777      assertEquals(5, client.tsMRange(TSMRangeParams.multiRangeParams()
778          .aggregation(AggregationType.VAR_P, 10).bucketTimestampMid().filter("l=v"))
779          .values().stream().findAny().get().getValue().get(0).getTimestamp());
780      assertEquals(5, client.tsMRange(TSMRangeParams.multiRangeParams()
781          .aggregation(AggregationType.VAR_S, 10).bucketTimestamp("~").filter("l=v"))
782          .values().stream().findAny().get().getValue().get(0).getTimestamp());
783    }
784    @Test
785    public void alignTimestamp() {
786      client.tsCreate("ts1");
787      client.tsCreate("ts2");
788      client.tsCreate("ts3");
789      client.tsCreateRule("ts1", "ts2", AggregationType.COUNT, 10, 0);
790      client.tsCreateRule("ts1", "ts3", AggregationType.COUNT, 10, 1);
791      client.tsAdd("ts1", 1, 1);
792      client.tsAdd("ts1", 10, 3);
793      client.tsAdd("ts1", 21, 7);
794      assertEquals(2, client.tsRange("ts2", TSRangeParams.rangeParams().aggregation(AggregationType.COUNT, 10)).size());
795      assertEquals(1, client.tsRange("ts3", TSRangeParams.rangeParams().aggregation(AggregationType.COUNT, 10)).size());
796    }
797  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-TimeSeriesTest.java</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from jedis-MDEwOlJlcG9zaXRvcnk3MTU2MDU=-flat-TimeSeriesTest.java</div>
                </div>
                <div class="column column_space"><pre><code>592        new TSElement(3200L, 1.1),
593        new TSElement(2000L, 0.9),
594        new TSElement(1000L, 1.1)
</pre></code></div>
                <div class="column column_space"><pre><code>349            new TSElement(1000L, 1.0),
350            new TSElement(2000L, 0.9),
351            new TSElement(3200L, 1.1),
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    