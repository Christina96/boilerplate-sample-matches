<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE>Matches for SslContextProviderTest.java & GroupByAggregateTest.java</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<body>
  <div style="align-items: center; display: flex; justify-content: space-around;">
    <div>
      <h3 align="center">
Matches for SslContextProviderTest.java & GroupByAggregateTest.java
      </h3>
      <h1 align="center">
        15.7%
      </h1>
      <center>
        <a href="index.html" target="_top">
          INDEX
        </a>
        <span>-</span>
        <a href="help-en.html" target="_top">
          HELP
        </a>
      </center>
    </div>
    <div>
<TABLE BORDER="1" CELLSPACING="0" BGCOLOR="#d0d0d0">
<TR><TH><TH>SslContextProviderTest.java (63.178295%)<TH>GroupByAggregateTest.java (8.970831%)<TH>Tokens
<TR><TD BGCOLOR="#0000ff"><FONT COLOR="#0000ff">-</FONT><TD><A HREF="javascript:ZweiFrames('match1076278-0.html#0',2,'match1076278-1.html#0',3)" NAME="0">(164-174)<TD><A HREF="javascript:ZweiFrames('match1076278-0.html#0',2,'match1076278-1.html#0',3)" NAME="0">(169-184)</A><TD ALIGN=center><FONT COLOR="#ff0000">24</FONT>
<TR><TD BGCOLOR="#f63526"><FONT COLOR="#f63526">-</FONT><TD><A HREF="javascript:ZweiFrames('match1076278-0.html#1',2,'match1076278-1.html#1',3)" NAME="1">(114-123)<TD><A HREF="javascript:ZweiFrames('match1076278-0.html#1',2,'match1076278-1.html#1',3)" NAME="1">(112-134)</A><TD ALIGN=center><FONT COLOR="#d40000">20</FONT>
<TR><TD BGCOLOR="#980517"><FONT COLOR="#980517">-</FONT><TD><A HREF="javascript:ZweiFrames('match1076278-0.html#2',2,'match1076278-1.html#2',3)" NAME="2">(128-141)<TD><A HREF="javascript:ZweiFrames('match1076278-0.html#2',2,'match1076278-1.html#2',3)" NAME="2">(626-639)</A><TD ALIGN=center><FONT COLOR="#c90000">19</FONT>
<TR><TD BGCOLOR="#53858b"><FONT COLOR="#53858b">-</FONT><TD><A HREF="javascript:ZweiFrames('match1076278-0.html#3',2,'match1076278-1.html#3',3)" NAME="3">(22-43)<TD><A HREF="javascript:ZweiFrames('match1076278-0.html#3',2,'match1076278-1.html#3',3)" NAME="3">(22-43)</A><TD ALIGN=center><FONT COLOR="#c90000">19</FONT>
<TR><TD BGCOLOR="#6cc417"><FONT COLOR="#6cc417">-</FONT><TD><A HREF="javascript:ZweiFrames('match1076278-0.html#4',2,'match1076278-1.html#4',3)" NAME="4">(87-94)<TD><A HREF="javascript:ZweiFrames('match1076278-0.html#4',2,'match1076278-1.html#4',3)" NAME="4">(193-207)</A><TD ALIGN=center><FONT COLOR="#bf0000">18</FONT>
<TR><TD BGCOLOR="#151b8d"><FONT COLOR="#151b8d">-</FONT><TD><A HREF="javascript:ZweiFrames('match1076278-0.html#5',2,'match1076278-1.html#5',3)" NAME="5">(153-161)<TD><A HREF="javascript:ZweiFrames('match1076278-0.html#5',2,'match1076278-1.html#5',3)" NAME="5">(60-70)</A><TD ALIGN=center><FONT COLOR="#aa0000">16</FONT>
<TR><TD BGCOLOR="#8c8774"><FONT COLOR="#8c8774">-</FONT><TD><A HREF="javascript:ZweiFrames('match1076278-0.html#6',2,'match1076278-1.html#6',3)" NAME="6">(97-104)<TD><A HREF="javascript:ZweiFrames('match1076278-0.html#6',2,'match1076278-1.html#6',3)" NAME="6">(208-217)</A><TD ALIGN=center><FONT COLOR="#9f0000">15</FONT>
<TR><TD BGCOLOR="#38a4a5"><FONT COLOR="#38a4a5">-</FONT><TD><A HREF="javascript:ZweiFrames('match1076278-0.html#7',2,'match1076278-1.html#7',3)" NAME="7">(142-150)<TD><A HREF="javascript:ZweiFrames('match1076278-0.html#7',2,'match1076278-1.html#7',3)" NAME="7">(82-92)</A><TD ALIGN=center><FONT COLOR="#7f0000">12</FONT>
<TR><TD BGCOLOR="#c58917"><FONT COLOR="#c58917">-</FONT><TD><A HREF="javascript:ZweiFrames('match1076278-0.html#8',2,'match1076278-1.html#8',3)" NAME="8">(106-113)<TD><A HREF="javascript:ZweiFrames('match1076278-0.html#8',2,'match1076278-1.html#8',3)" NAME="8">(1324-1332)</A><TD ALIGN=center><FONT COLOR="#740000">11</FONT>
<TR><TD BGCOLOR="#83a33a"><FONT COLOR="#83a33a">-</FONT><TD><A HREF="javascript:ZweiFrames('match1076278-0.html#9',2,'match1076278-1.html#9',3)" NAME="9">(124-126)<TD><A HREF="javascript:ZweiFrames('match1076278-0.html#9',2,'match1076278-1.html#9',3)" NAME="9">(218-225)</A><TD ALIGN=center><FONT COLOR="#5f0000">9</FONT>
</TABLE>
    </div>
  </div>
  <hr>
  <div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>SslContextProviderTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
<A NAME="3"></A> * software solely pursuant to the terms of the relevant commercial agreement.
 */

<FONT color="#53858b"><A HREF="javascript:ZweiFrames('match1076278-1.html#3',3,'match1076278-top.html#3',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>package io.crate.protocols.ssl;

import static org.hamcrest.CoreMatchers.containsString;
import static org.hamcrest.CoreMatchers.hasItem;
import static org.hamcrest.CoreMatchers.not;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.Matchers.empty;
import static org.hamcrest.Matchers.instanceOf;
import static org.hamcrest.Matchers.is;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.net.URL;
import java.net.URLDecoder;
import java.nio.charset.StandardCharsets;
import java.security.KeyStore;
import java.security.PrivateKey;
import java.security.UnrecoverableKeyException;
import java.security.cert.X509Certificate;

import</B></FONT> javax.net.ssl.KeyManager;
import javax.net.ssl.SSLContext;

import io.crate.auth.Protocol;
import org.elasticsearch.common.settings.Settings;
import org.elasticsearch.test.ESTestCase;
import org.hamcrest.Matchers;
import org.junit.BeforeClass;
import org.junit.Test;

import io.netty.handler.ssl.SslContext;

public class SslContextProviderTest extends ESTestCase {

    private static final String KEYSTORE_PASSWORD = &quot;keystorePassword&quot;;
    private static final String KEYSTORE_KEY_PASSWORD = &quot;keystorePassword&quot;;
    private static final String TRUSTSTORE_PASSWORD = &quot;keystorePassword&quot;;
    private static final String ROOT_CA_ALIAS = &quot;tmp/localhost&quot;;

    private static File trustStoreFile;
    private static File keyStoreFile;

    @BeforeClass
    public static void beforeTests() throws IOException {
        trustStoreFile = getAbsoluteFilePathFromClassPath(&quot;truststore.pcks12&quot;);
        keyStoreFile = getAbsoluteFilePathFromClassPath(&quot;keystore.pcks12&quot;);
    }


    @Test
    public void testClassLoadingWithInvalidConfiguration() {
        // empty ssl configuration which is invalid
        Settings settings = Settings.builder()
            .put(SslSettings.SSL_HTTP_ENABLED.getKey(), true)
            .put(SslSettings.SSL_PSQL_ENABLED.getKey(), true)
            .build();
        expectedException.expect(SslConfigurationException.class);
        expectedException.expectMessage(&quot;Failed to build SSL configuration&quot;);
        var sslContextProvider = new SslContextProvider(settings);
        sslContextProvider.getServerContext(Protocol.TRANSPORT);
    }
<A NAME="4"></A>
    @Test
    public void testClassLoadingWithValidConfiguration() {
        Settings settings = <FONT color="#6cc417"><A HREF="javascript:ZweiFrames('match1076278-1.html#4',3,'match1076278-top.html#4',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>Settings.builder()
            .put(SslSettings.SSL_HTTP_ENABLED.getKey(), true)
            .put(SslSettings.SSL_PSQL_ENABLED.getKey(), true)
            .put(SslSettings.SSL_TRUSTSTORE_FILEPATH.getKey(), trustStoreFile.getAbsolutePath())
            .put(SslSettings.SSL_TRUSTSTORE_PASSWORD.getKey(), &quot;keystorePassword&quot;)
            .put(SslSettings.SSL_KEYSTORE_FILEPATH.getKey(), keyStoreFile.getAbsolutePath())
            .put(SslSettings.SSL_KEYSTORE_PASSWORD.getKey(), &quot;keystorePassword&quot;)
<A NAME="6"></A>            .put(SslSettings.SSL_KEYSTORE_KEY_PASSWORD.getKey</B></FONT>(), &quot;keystorePassword&quot;)
            .build();
        var sslContextProvider = new SslContextProvider(settings);
        SslContext sslContext = <FONT color="#8c8774"><A HREF="javascript:ZweiFrames('match1076278-1.html#6',3,'match1076278-top.html#6',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>sslContextProvider.getServerContext(Protocol.TRANSPORT);
        assertThat(sslContext, instanceOf(SslContext.class));
        assertThat(sslContext.isServer(), is(true));
        assertThat(sslContext.cipherSuites(), not(empty()));
    }

<A NAME="8"></A>    @Test
    public void test_netty_ssl_context_can_be_built_and_doesnt_override_default_context() throws Exception {</B></FONT>
        var defaultSSLContext = SSLContext.getDefault();
        Settings settings = <FONT color="#c58917"><A HREF="javascript:ZweiFrames('match1076278-1.html#8',3,'match1076278-top.html#8',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>Settings.builder()
            .put(SslSettings.SSL_TRUSTSTORE_FILEPATH_SETTING_NAME, trustStoreFile.getAbsolutePath())
            .put(SslSettings.SSL_TRUSTSTORE_PASSWORD_SETTING_NAME, TRUSTSTORE_PASSWORD)
            .put(SslSettings.SSL_KEYSTORE_FILEPATH_SETTING_NAME, keyStoreFile.getAbsolutePath())
            .put(SslSettings.SSL_KEYSTORE_PASSWORD_SETTING_NAME, KEYSTORE_PASSWORD)
<A NAME="1"></A>            .put(SslSettings.SSL_KEYSTORE_KEY_PASSWORD_SETTING_NAME, KEYSTORE_KEY_PASSWORD)
        .build();
        SslContext sslContext = new SslContextProvider(settings).getServerContext</B></FONT>(Protocol.TRANSPORT);
        <FONT color="#f63526"><A HREF="javascript:ZweiFrames('match1076278-1.html#1',3,'match1076278-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>assertThat(sslContext.isServer(), is(true));
        assertThat(sslContext.cipherSuites(), not(empty()));
        // check that we don't offer NULL ciphers which do not encrypt
        assertThat(sslContext.cipherSuites(), not(hasItem(containsString(&quot;NULL&quot;))));

        assertThat(defaultSSLContext, Matchers.sameInstance(SSLContext.getDefault()));
    }
<A NAME="9"></A>
    @Test
    public void testKeyStoreLoading() throws Exception {</B></FONT>
        KeyStore keyStore = <FONT color="#83a33a"><A HREF="javascript:ZweiFrames('match1076278-1.html#9',3,'match1076278-top.html#9',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>SslContextProvider.loadKeyStore(keyStoreFile.getAbsolutePath(), KEYSTORE_PASSWORD.toCharArray());
<A NAME="2"></A>        assertThat(keyStore.getType(), is(&quot;pkcs12&quot;));
        assertThat(keyStore.getCertificate(ROOT_CA_ALIAS), notNullValue</B></FONT>());

        KeyManager[] keyManagers = <FONT color="#980517"><A HREF="javascript:ZweiFrames('match1076278-1.html#2',3,'match1076278-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>SslContextProvider.createKeyManagers(keyStore, KEYSTORE_KEY_PASSWORD.toCharArray());
        assertThat(keyManagers.length, is(1));
    }

    @Test
    public void testKeyStoreLoadingFailWrongPassword() throws Exception {
        expectedException.expect(IOException.class);
        expectedException.expectMessage(&quot;keystore password was incorrect&quot;);

        SslContextProvider.loadKeyStore(keyStoreFile.getAbsolutePath(), &quot;wrongpassword&quot;.toCharArray());
    }
<A NAME="7"></A>
    @Test
    public void testKeyStoreLoadingFailWrongKeyPassword() throws Exception {</B></FONT>
        KeyStore keyStore = <FONT color="#38a4a5"><A HREF="javascript:ZweiFrames('match1076278-1.html#7',3,'match1076278-top.html#7',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>SslContextProvider.loadKeyStore(keyStoreFile.getAbsolutePath(), KEYSTORE_PASSWORD.toCharArray());

        expectedException.expect(UnrecoverableKeyException.class);
        expectedException.expectMessage(&quot;Get Key failed&quot;);
        SslContextProvider.createKeyManagers(keyStore, &quot;wrongpassword&quot;.toCharArray());
    }

    @Test
<A NAME="5"></A>    public void testExportRootCertificates() throws Exception {</B></FONT>
        KeyStore keyStore = SslContextProvider.loadKeyStore(keyStoreFile.getAbsolutePath(), KEYSTORE_PASSWORD.toCharArray());

        X509Certificate[] certificates = <FONT color="#151b8d"><A HREF="javascript:ZweiFrames('match1076278-1.html#5',3,'match1076278-top.html#5',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>SslContextProvider.getRootCertificates(keyStore);
        assertThat(certificates.length, is(1));

        assertThat(certificates[0].getIssuerDN().getName(), containsString(&quot;CN=myCA&quot;));
        assertThat(certificates[0].getNotAfter().getTime(), is(1651658343000L));
    }

    @Test
<A NAME="0"></A>    public void testExportServerCertChain() throws Exception {</B></FONT>
        KeyStore keyStore = SslContextProvider.loadKeyStore(keyStoreFile.getAbsolutePath(), KEYSTORE_PASSWORD.toCharArray());

        X509Certificate[] certificates = <FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match1076278-1.html#0',3,'match1076278-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>SslContextProvider.getCertificateChain(keyStore);

        assertThat(certificates.length, is(2));
        assertThat(certificates[0].getIssuerDN().getName(), containsString(&quot;CN=myCA, O=Dummy Company, L=Dummy Country, ST=Dummy State, C=AT&quot;));
        assertThat(certificates[0].getSubjectDN().getName(), containsString(&quot;CN=localhost&quot;));
        assertThat(certificates[1].getIssuerDN().getName(), containsString(&quot;CN=myCA, O=Dummy Company, L=Dummy Country, ST=Dummy State, C=AT&quot;));
        assertThat(certificates[1].getSubjectDN().getName(), containsString(&quot;CN=myCA&quot;));
    }

    @Test
    public void testExportDecryptedKey() throws Exception {</B></FONT>
        KeyStore keyStore = SslContextProvider.loadKeyStore(keyStoreFile.getAbsolutePath(), KEYSTORE_PASSWORD.toCharArray());
        PrivateKey privateKey = SslContextProvider.getPrivateKey(keyStore, KEYSTORE_KEY_PASSWORD.toCharArray());
        assertThat(privateKey, Matchers.notNullValue());
    }

    public static File getAbsoluteFilePathFromClassPath(final String fileNameFromClasspath) throws IOException {
        final URL fileUrl = SslContextProviderTest.class.getClassLoader().getResource(fileNameFromClasspath);
        if (fileUrl == null) {
            throw new FileNotFoundException(&quot;Resource was not found: &quot; + fileNameFromClasspath);
        }
        return new File(URLDecoder.decode(fileUrl.getFile(), StandardCharsets.UTF_8));
    }
}
</PRE>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>GroupByAggregateTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<HR>
<PRE>
/*
 * Licensed to Crate.io GmbH (&quot;Crate&quot;) under one or more contributor
 * license agreements.  See the NOTICE file distributed with this work for
 * additional information regarding copyright ownership.  Crate licenses
 * this file to you under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.  You may
 * obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * However, if you have executed another commercial license agreement
 * with Crate these terms will supersede the license and you may use the
<A NAME="3"></A> * software solely pursuant to the terms of the relevant commercial agreement.
 */

<FONT color="#53858b"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match1076278-0.html#3',2,'match1076278-top.html#3',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>package io.crate.integrationtests;

import io.crate.data.ArrayBucket;
import io.crate.data.Paging;
import io.crate.testing.SQLResponse;
import io.crate.testing.TestingHelpers;
import io.crate.testing.UseJdbc;
import org.elasticsearch.test.ESIntegTestCase;
import org.hamcrest.Matchers;
import org.hamcrest.core.Is;
import org.junit.Before;
import org.junit.Test;
import org.junit.jupiter.api.Assertions;

import java.util.Arrays;

import static com.carrotsearch.randomizedtesting.RandomizedTest.randomAsciiLettersOfLength;
import static io.crate.testing.TestingHelpers.printedTable;
import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.Matchers.closeTo;
import static org.hamcrest.Matchers.isIn;
import</B></FONT> static org.hamcrest.Matchers.not;

@ESIntegTestCase.ClusterScope(numDataNodes = 2, numClientNodes = 0, supportsDedicatedMasters = false)
public class GroupByAggregateTest extends SQLIntegrationTestCase {

    private Setup setup = new Setup(sqlExecutor);

    @Before
    public void initTestData() {
        setup.setUpEmployees();
    }

    @Test
    public void selectGroupByAggregateMinInteger() throws Exception {
<A NAME="5"></A>        this.setup.groupBySetup(&quot;integer&quot;);

        execute(&quot;select min(age) as minage, gender from characters group by gender order by gender&quot;);
        assertArrayEquals(new String[]{&quot;minage&quot;, &quot;gender&quot;}, <FONT color="#151b8d"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match1076278-0.html#5',2,'match1076278-top.html#5',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>response.cols());
        assertEquals(2L, response.rowCount());
        assertEquals(&quot;female&quot;, response.rows()[0][1]);
        assertEquals(32, response.rows()[0][0]);

        assertEquals(&quot;male&quot;, response.rows()[1][1]);
        assertEquals(34, response.rows()[1][0]);
    }

    @Test
    public void testSelectDistinctWithPaging() throws Exception {</B></FONT>
        Paging.PAGE_SIZE = 2;
        execute(&quot;create table t (name string) with (number_of_replicas = 0)&quot;);
        ensureYellow();
        execute(&quot;insert into t (name) values ('Marvin'), ('Trillian'), ('Ford'), ('Arthur')&quot;);
        execute(&quot;refresh table t&quot;);
        execute(&quot;select distinct name from t&quot;);
    }

<A NAME="7"></A>    @Test
    public void testNonDistributedGroupByWithManyKeysNoOrderByAndLimit() throws Exception {
        execute(&quot;create table t (name string, x int) clustered by (name) with (number_of_replicas = 0)&quot;);
        <FONT color="#38a4a5"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match1076278-0.html#7',2,'match1076278-top.html#7',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>ensureYellow();

        execute(&quot;insert into t (name, x) values ('Marvin', 1), ('Trillian', 1), ('Ford', 1), ('Arthur', 1)&quot;);
        execute(&quot;refresh table t&quot;);

        execute(&quot;select count(*), name from t group by name, x limit 2&quot;);
        assertThat(response.rowCount(), is(2L));
    }

    @Test
    public void testGroupByOnClusteredByColumnPartOfPrimaryKey() {</B></FONT>
        execute(&quot;CREATE TABLE tickets ( &quot; +
                &quot; pk1 long, &quot; +
                &quot; pk2 integer, &quot; +
                &quot; pk3 timestamp with time zone,&quot; +
                &quot; value string,&quot; +
                &quot; primary key(pk1, pk2, pk3)) &quot; +
                &quot;CLUSTERED BY (pk2) INTO 3 SHARDS &quot; +
                &quot;PARTITIONED BY (pk3) &quot; +
                &quot;WITH (column_policy = 'strict', number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into tickets (pk1, pk2, pk3, value) values (?, ?, ?, ?)&quot;,
            new Object[][]{
                {1L, 42, 1425168000000L, &quot;foo&quot;},
                {2L, 43, 0L, &quot;bar&quot;},
                {3L, 44, 1425168000000L, &quot;baz&quot;},
                {4L, 45, 499651200000L, null},
<A NAME="1"></A>                {5L, 42, 0L, &quot;foo&quot;}
            });
        ensureYellow();
        <FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match1076278-0.html#1',2,'match1076278-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>refresh();
        execute(&quot;select pk2, count(pk2) from tickets group by pk2 order by pk2 limit 100&quot;);
        assertThat(printedTable(response.rows()), is(
            &quot;42| 2\n&quot; + // assert that different partitions have been merged
            &quot;43| 1\n&quot; +
            &quot;44| 1\n&quot; +
            &quot;45| 1\n&quot;));

        execute(&quot;create table tickets_export (c2 int, c long) with (number_of_replicas = 0)&quot;);
        ensureYellow();
        execute(&quot;insert into tickets_export (c2, c) (select pk2, count(pk2) from tickets group by pk2)&quot;);
        execute(&quot;refresh table tickets_export&quot;);

        execute(&quot;select c2, c from tickets_export order by 1&quot;);
        assertThat(printedTable(response.rows()), is(
            &quot;42| 2\n&quot; + // assert that different partitions have been merged
            &quot;43| 1\n&quot; +
            &quot;44| 1\n&quot; +
            &quot;45| 1\n&quot;));
    }

    @Test
    public void selectGroupByAggregateMinFloat() throws Exception {</B></FONT>
        this.setup.groupBySetup(&quot;float&quot;);

        execute(&quot;select min(age), gender from characters group by gender order by gender&quot;);

        String expected = &quot;32.0| female\n34.0| male\n&quot;;

        assertEquals(&quot;min(age)&quot;, response.cols()[0]);
        assertEquals(expected, printedTable(response.rows()));
    }

    @Test
    public void selectGroupByAggregateMinDouble() throws Exception {
        this.setup.groupBySetup(&quot;double&quot;);

        execute(&quot;select min(age) as minAge, gender from characters group by gender order by gender&quot;);
        assertEquals(2L, response.rowCount());
        assertEquals(32.0d, response.rows()[0][0]);
        assertEquals(34.0d, response.rows()[1][0]);
    }

    @Test
    public void testCountDistinctGlobal() throws Exception {
        execute(&quot;select count(distinct department), count(*) from employees&quot;);

        assertEquals(1L, response.rowCount());
        assertEquals(4L, response.rows()[0][0]);
        assertEquals(6L, response.rows()[0][1]);
    }

    @Test
    public void testCountDistinctGroupBy() throws Exception {
<A NAME="0"></A>        this.setup.groupBySetup(&quot;integer&quot;);
        execute(&quot;select count(distinct gender), count(*), race from characters group by race order by count(*) desc&quot;);

        assertEquals(3L, <FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match1076278-0.html#0',2,'match1076278-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>response.rowCount());
        assertEquals(2L, response.rows()[0][0]);
        assertEquals(4L, response.rows()[0][1]);
        assertEquals(&quot;Human&quot;, response.rows()[0][2]);

        assertEquals(1L, response.rows()[1][0]);
        assertEquals(2L, response.rows()[1][1]);
        assertEquals(&quot;Vogon&quot;, response.rows()[1][2]);

        assertEquals(1L, response.rows()[2][0]);
        assertEquals(1L, response.rows()[2][1]);
        assertEquals(&quot;Android&quot;, response.rows()[2][2]);
    }

    @Test
    public void testCountDistinctGroupByOrderByCountDistinct() throws Exception {</B></FONT>
        this.setup.groupBySetup(&quot;integer&quot;);
        execute(&quot;select count(distinct gender), count(*), race from characters group by race order by count(distinct gender) desc&quot;);
        assertEquals(3L, response.rowCount());
        assertEquals(2L, response.rows()[0][0]);
    }
<A NAME="4"></A>
    @Test
    public void testCountDistinctManySame() throws Exception {
        <FONT color="#6cc417"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match1076278-0.html#4',2,'match1076278-top.html#4',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>this.setup.groupBySetup(&quot;integer&quot;);
        execute(&quot;select race, count(distinct gender), count(*), count(distinct gender) &quot; +
                &quot;from characters group by race order by count(distinct gender) desc, &quot; +
                &quot;count(*) desc&quot;);

        assertEquals(3L, response.rowCount());

        assertEquals(&quot;Human&quot;, response.rows()[0][0]);
        assertEquals(2L, response.rows()[0][1]);
        assertEquals(4L, response.rows()[0][2]);
        assertEquals(2L, response.rows()[0][3]);

<A NAME="6"></A>        assertEquals(&quot;Vogon&quot;, response.rows()[1][0]);
        assertEquals(1L, response.rows()[1][1]);
        assertEquals(2L, response.rows</B></FONT>()[1][2]);
        <FONT color="#8c8774"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match1076278-0.html#6',2,'match1076278-top.html#6',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>assertEquals(1L, response.rows()[1][3]);

        assertEquals(&quot;Android&quot;, response.rows()[2][0]);
        assertEquals(1L, response.rows()[2][1]);
        assertEquals(1L, response.rows()[2][2]);
        assertEquals(1L, response.rows()[2][3]);
    }
<A NAME="9"></A>
    @Test
    public void testCountDistinctManyDifferent() throws Exception {</B></FONT>
        <FONT color="#83a33a"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match1076278-0.html#9',2,'match1076278-top.html#9',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>this.setup.groupBySetup(&quot;integer&quot;);
        execute(&quot;select race, count(distinct gender), count(distinct age) &quot; +
                &quot;from characters group by race order by count(distinct gender) desc, race desc&quot;);
        assertEquals(3L, response.rowCount());

        assertEquals(&quot;Human&quot;, response.rows()[0][0]);
        assertEquals(2L, response.rows()[0][1]);
        assertEquals</B></FONT>(4L, response.rows()[0][2]);


        assertEquals(&quot;Vogon&quot;, response.rows()[1][0]);
        assertEquals(1L, response.rows()[1][1]);
        assertEquals(0L, response.rows()[1][2]);

        assertEquals(&quot;Android&quot;, response.rows()[2][0]);
        assertEquals(1L, response.rows()[2][1]);
        assertEquals(0L, response.rows()[2][2]);
    }

    @Test
    public void selectGroupByAggregateMinOrderByMin() throws Exception {
        this.setup.groupBySetup(&quot;double&quot;);

        execute(&quot;select min(age) as minAge, gender from characters group by gender order by minAge desc&quot;);
        assertEquals(2L, response.rowCount());

        assertEquals(&quot;male&quot;, response.rows()[0][1]);
        assertEquals(34.0d, response.rows()[0][0]);

        assertEquals(&quot;female&quot;, response.rows()[1][1]);
        assertEquals(32.0d, response.rows()[1][0]);

        execute(&quot;select min(age), gender from characters group by gender order by min(age) asc&quot;);
        assertEquals(2L, response.rowCount());

        assertEquals(&quot;female&quot;, response.rows()[0][1]);
        assertEquals(32.0d, response.rows()[0][0]);

        assertEquals(&quot;male&quot;, response.rows()[1][1]);
        assertEquals(34.0d, response.rows()[1][0]);
    }

    @Test
    public void selectGroupByAggregateMinLong() throws Exception {
        this.setup.groupBySetup(&quot;long&quot;);

        execute(&quot;select min(age) as minAge, gender from characters group by gender order by gender&quot;);
        assertEquals(2L, response.rowCount());
        assertEquals(32L, response.rows()[0][0]);
        assertEquals(34L, response.rows()[1][0]);
    }

    @Test
    public void selectGroupByAggregateMinString() throws Exception {
        this.setup.groupBySetup();

        execute(&quot;select min(name) as minName, gender from characters group by gender order by gender&quot;);
        assertEquals(2L, response.rowCount());
        assertEquals(&quot;Anjie&quot;, response.rows()[0][0]);
        assertEquals(&quot;Arthur Dent&quot;, response.rows()[1][0]);
    }

    @Test
    public void selectGroupByAggregateMinDate() throws Exception {
        this.setup.groupBySetup();

        execute(&quot;select min(birthdate) as minBirthdate, gender from characters group by gender &quot; +
                &quot;order by gender&quot;);
        assertEquals(2L, response.rowCount());
        assertEquals(&quot;female&quot;, response.rows()[0][1]);
        assertEquals(0L, response.rows()[0][0]);

        assertEquals(&quot;male&quot;, response.rows()[1][1]);
        assertEquals(181353600000L, response.rows()[1][0]);
    }

    // MAX

    @Test
    public void selectGroupByAggregateMaxString() throws Exception {
        this.setup.groupBySetup();

        execute(&quot;select max(name), gender from characters group by gender order by gender&quot;);
        assertEquals(2L, response.rowCount());
        assertEquals(&quot;Trillian&quot;, response.rows()[0][0]);
        assertEquals(&quot;Marving&quot;, response.rows()[1][0]);
    }

    @Test
    public void selectGroupByMixedCaseAggregateMaxString() throws Exception {
        this.setup.groupBySetup();

        execute(&quot;select max(NAME), GENDER from characters group by gender order by gender&quot;);
        assertEquals(2L, response.rowCount());
        assertEquals(&quot;Trillian&quot;, response.rows()[0][0]);
        assertEquals(&quot;Marving&quot;, response.rows()[1][0]);
    }

    @Test
    public void selectGroupByAggregateMaxLong() throws Exception {
        this.setup.groupBySetup(&quot;long&quot;);

        execute(&quot;select max(age), gender from characters group by gender order by gender&quot;);
        assertEquals(2L, response.rowCount());
        assertEquals(43L, response.rows()[0][0]);
        assertEquals(112L, response.rows()[1][0]);
    }

    @Test
    public void selectGroupByAggregateMaxDate() throws Exception {

        execute(&quot;select max(hired), department from employees group by department &quot; +
                &quot;order by department asc&quot;);
        assertEquals(4L, response.rowCount());

        assertEquals(&quot;HR&quot;, response.rows()[0][1]);
        assertEquals(631152000000L, response.rows()[0][0]);

        assertEquals(&quot;engineering&quot;, response.rows()[1][1]);
        assertEquals(946684800000L, response.rows()[1][0]);

        assertEquals(&quot;internship&quot;, response.rows()[2][1]);
        assertEquals(null, response.rows()[2][0]);

        assertEquals(&quot;management&quot;, response.rows()[3][1]);
        assertEquals(1286668800000L, response.rows()[3][0]);
    }

    @Test
    public void selectGroupByAggregateMaxInteger() throws Exception {
        this.setup.groupBySetup(&quot;integer&quot;);

        execute(&quot;select max(age), gender from characters group by gender order by gender&quot;);
        assertArrayEquals(new String[]{&quot;max(age)&quot;, &quot;gender&quot;}, response.cols());
        assertEquals(2L, response.rowCount());
        assertEquals(&quot;female&quot;, response.rows()[0][1]);
        assertEquals(43, response.rows()[0][0]);

        assertEquals(&quot;male&quot;, response.rows()[1][1]);
        assertEquals(112, response.rows()[1][0]);
    }

    @Test
    public void selectGroupByAggregateMaxFloat() throws Exception {
        this.setup.groupBySetup(&quot;float&quot;);

        execute(&quot;select max(age), gender from characters group by gender order by gender&quot;);
        assertEquals(2L, response.rowCount());
        assertEquals(&quot;max(age)&quot;, response.cols()[0]);
        assertEquals(43.0f, response.rows()[0][0]);
        assertEquals(112.0f, response.rows()[1][0]);
    }

    @Test
    public void selectGroupByAggregateMaxDouble() throws Exception {

        execute(&quot;select max(income), department from employees group by department order by department&quot;);
        assertEquals(4L, response.rowCount());
        assertEquals(999999999.99d, response.rows()[0][0]);
        assertEquals(&quot;HR&quot;, response.rows()[0][1]);

        assertEquals(6000.0d, response.rows()[1][0]);
        assertEquals(&quot;engineering&quot;, response.rows()[1][1]);

        assertEquals(null, response.rows()[2][0]);
        assertEquals(&quot;internship&quot;, response.rows()[2][1]);

        assertEquals(Double.MAX_VALUE, response.rows()[3][0]);
        assertEquals(&quot;management&quot;, response.rows()[3][1]);
    }

    @Test
    public void selectGroupByAggregateMaxOrderByMax() throws Exception {
        this.setup.groupBySetup(&quot;double&quot;);

        execute(&quot;select max(age) as maxage, gender from characters group by gender order by maxage desc&quot;);
        assertEquals(2L, response.rowCount());

        assertEquals(&quot;male&quot;, response.rows()[0][1]);
        assertEquals(112.0d, response.rows()[0][0]);

        assertEquals(&quot;female&quot;, response.rows()[1][1]);
        assertEquals(43.0d, response.rows()[1][0]);

        execute(&quot;select max(age), gender from characters group by gender order by max(age) asc&quot;);
        assertEquals(2L, response.rowCount());

        assertEquals(&quot;female&quot;, response.rows()[0][1]);
        assertEquals(43.0d, response.rows()[0][0]);

        assertEquals(&quot;male&quot;, response.rows()[1][1]);
        assertEquals(112.0d, response.rows()[1][0]);
    }

    @Test
    public void testGroupByAggSumDouble() throws Exception {

        execute(&quot;select sum(income), department from employees group by department order by sum(income) asc&quot;);
        assertEquals(4, response.rowCount());

        assertEquals(&quot;engineering&quot;, response.rows()[0][1]);
        assertEquals(10000.0, response.rows()[0][0]);

        assertEquals(&quot;HR&quot;, response.rows()[1][1]);
        assertEquals(1000000000.49, response.rows()[1][0]);

        assertEquals(&quot;management&quot;, response.rows()[2][1]);
        assertEquals(Double.MAX_VALUE, response.rows()[2][0]);

        assertEquals(&quot;internship&quot;, response.rows()[3][1]);
        assertNull(response.rows()[3][0]);
    }

    @Test
    public void testGroupByAggSumShort() throws Exception {

        execute(&quot;select sum(age), department from employees group by department order by department asc&quot;);
        assertEquals(4, response.rowCount());

        assertEquals(&quot;HR&quot;, response.rows()[0][1]);
        assertEquals(12L, response.rows()[0][0]);

        assertEquals(&quot;engineering&quot;, response.rows()[1][1]);
        assertEquals(101L, response.rows()[1][0]);

        assertEquals(&quot;internship&quot;, response.rows()[2][1]);
        assertEquals(28L, response.rows()[2][0]);

        assertEquals(&quot;management&quot;, response.rows()[3][1]);
        assertEquals(45L, response.rows()[3][0]);

    }

    @Test
    public void testGroupByAvgDouble() throws Exception {
        execute(&quot;select avg(income), mean(income), department from employees group by department order by department asc&quot;);
        assertEquals(4, response.rowCount());

        assertEquals(500000000.245d, response.rows()[0][0]);
        assertEquals(500000000.245d, response.rows()[0][1]);
        assertEquals(&quot;HR&quot;, response.rows()[0][2]);

        assertEquals(5000.0d, response.rows()[1][0]);
        assertEquals(5000.0d, response.rows()[1][1]);
        assertEquals(&quot;engineering&quot;, response.rows()[1][2]);


        assertEquals(null, response.rows()[2][0]);
        assertEquals(null, response.rows()[2][1]);
        assertEquals(&quot;internship&quot;, response.rows()[2][2]);

        assertEquals(Double.MAX_VALUE, response.rows()[3][0]);
        assertEquals(Double.MAX_VALUE, response.rows()[3][1]);
        assertEquals(&quot;management&quot;, response.rows()[3][2]);
    }

    @Test
    public void testGroupByAvgMany() throws Exception {
        execute(&quot;select avg(income), avg(age), department from employees group by department order by department asc&quot;);
        assertEquals(4, response.rowCount());

        assertEquals(&quot;HR&quot;, response.rows()[0][2]);
        assertEquals(500000000.245d, response.rows()[0][0]);
        assertEquals(12.0d, response.rows()[0][1]);

        assertEquals(&quot;engineering&quot;, response.rows()[1][2]);
        assertEquals(5000.0d, response.rows()[1][0]);
        assertEquals(50.5d, response.rows()[1][1]);

        assertEquals(&quot;internship&quot;, response.rows()[2][2]);
        assertEquals(null, response.rows()[2][0]);
        assertEquals(28.0d, response.rows()[2][1]);

        assertEquals(&quot;management&quot;, response.rows()[3][2]);
        assertEquals(Double.MAX_VALUE, response.rows()[3][0]);
        assertEquals(45.0d, response.rows()[3][1]);
    }

    @Test
    public void testGroupByArbitrary() throws Exception {
        this.setup.groupBySetup();

        execute(&quot;select arbitrary(name), race from characters group by race order by race asc&quot;);
        SQLResponse arbitrary_response = response;
        assertEquals(3, arbitrary_response.rowCount());

        assertEquals(&quot;Android&quot;, arbitrary_response.rows()[0][1]);
        assertEquals(1,
            execute(&quot;select name from characters where race=? AND name=? &quot;,
                new Object[]{&quot;Android&quot;, arbitrary_response.rows()[0][0]})
                .rowCount()
        );
        assertEquals(&quot;Human&quot;, arbitrary_response.rows()[1][1]);
        assertEquals(1,
            execute(&quot;select name from characters where race=? AND name=? &quot;,
                new Object[]{&quot;Human&quot;, arbitrary_response.rows()[1][0]})
                .rowCount()
        );
        assertEquals(&quot;Vogon&quot;, arbitrary_response.rows()[2][1]);
        assertEquals(1,
            execute(&quot;select name from characters where race=? AND name=? &quot;,
                new Object[]{&quot;Vogon&quot;, arbitrary_response.rows()[2][0]})
                .rowCount()
        );

    }

    @Test
    public void testGlobalAggregateArbitrary() throws Exception {
        this.setup.groupBySetup();

        execute(&quot;select arbitrary(age) from characters where age is not null&quot;);
        assertEquals(1, response.rowCount());
        assertEquals(1,
            execute(&quot;select count(*) from characters where age=?&quot;,
                new Object[]{response.rows()[0][0]})
                .rowCount()
        );
    }

    @Test
    public void testAggregateArbitraryOnBoolean() throws Exception {
        execute(&quot;select arbitrary(good) from employees&quot;);
        assertEquals(1, response.rowCount());
        assertThat(response.rows()[0][0], isIn(new Object[]{true, false, null}));

        execute(&quot;select arbitrary(good) from employees where name='dilbert'&quot;);
        assertEquals(1, response.rowCount());
        assertEquals(true, response.rows()[0][0]);

        execute(&quot;select arbitrary(good), department from employees group by department order by department asc&quot;);
        assertEquals(4, response.rowCount());
        assertEquals(&quot;HR&quot;, response.rows()[0][1]);
        assertThat(response.rows()[0][0], isIn(new Object[]{false, null}));

        assertEquals(&quot;engineering&quot;, response.rows()[1][1]);
        assertEquals(true, response.rows()[1][0]);  // by accident only single values exist in group

        assertEquals(&quot;internship&quot;, response.rows()[2][1]);
        assertNull(response.rows()[2][0]);

        assertEquals(&quot;management&quot;, response.rows()[3][1]);
        assertEquals(false, response.rows()[3][0]);
    }

    public void testGroupByCountOnColumn() throws Exception {
        execute(&quot;select department, count(income), count(*) &quot; +
                &quot;from employees group by department order by department asc&quot;);
        assertEquals(4, response.rowCount());

        assertEquals(&quot;HR&quot;, response.rows()[0][0]);
        assertEquals(2L, response.rows()[0][1]);
        assertEquals(2L, response.rows()[0][2]);

        assertEquals(&quot;engineering&quot;, response.rows()[1][0]);
        assertEquals(2L, response.rows()[1][1]);
        assertEquals(2L, response.rows()[1][2]);

        assertEquals(&quot;internship&quot;, response.rows()[2][0]);
        assertEquals(0L, response.rows()[2][1]);
        assertEquals(1L, response.rows()[2][2]);

        assertEquals(&quot;management&quot;, response.rows()[3][0]);
        assertEquals(1L, response.rows()[3][1]);
        assertEquals(1L, response.rows()[3][2]);
    }

    @Test
    public void testCompareCountOnObjectHavingNotNullSubcolumnAndCountDirectlyOnNotNullSubcolumn() {
        execute(&quot;&quot;&quot;
                   create table tbl (
                        device int not null,
                        payload object as (
                            col int,
                            nested_payload object as (
                                col int not null)
                        ),
                        nullable_payload object as (
                            col int
                        )
                   )
                   &quot;&quot;&quot;);
        execute(&quot;insert into tbl values(1, {col=11, nested_payload={col=111}}, {col=null})&quot;);
        execute(&quot;insert into tbl values(1, {col=null, nested_payload={col=111}}, {col=11})&quot;);
        execute(&quot;insert into tbl values(1, {col=11, nested_payload={col=111}}, null)&quot;);
        execute(&quot;refresh table tbl&quot;);

        /* count(payload) is implicitly optimized to use DocValueAggregator of payload['nested_payload']['col'],
           so below 3 executions are expected to have the same results. */
        execute(&quot;select device, count(payload) from tbl group by 1&quot;);
        assertThat(printedTable(response.rows()), is(&quot;1| 3\n&quot;));
        execute(&quot;select device, count(payload['nested_payload']) from tbl group by 1&quot;);
        assertThat(printedTable(response.rows()), is(&quot;1| 3\n&quot;));
        execute(&quot;select device, count(payload['nested_payload']['col']) from tbl group by 1&quot;);
        assertThat(printedTable(response.rows()), is(&quot;1| 3\n&quot;));
        // below are just there to show that no other available columns are used instead of payload['nested_payload']['col']
        execute(&quot;select device, count(nullable_payload) from tbl group by 1&quot;);
        assertThat(printedTable(response.rows()), is(&quot;1| 2\n&quot;));
        execute(&quot;select device, count(payload['col']) from tbl group by 1&quot;);
        assertThat(printedTable(response.rows()), is(&quot;1| 2\n&quot;));
    }

    @Test
    public void testGlobalCountOnColumn() throws Exception {

<A NAME="2"></A>        execute(&quot;select count(*), count(good), count(distinct good) from employees&quot;);
        assertEquals(1, response.rowCount());
        assertEquals(6L, response.rows()[0][0]);
        <FONT color="#980517"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match1076278-0.html#2',2,'match1076278-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>assertEquals(4L, response.rows()[0][1]);
        assertEquals(2L, response.rows()[0][2]);
    }

    @Test
    public void testGlobalCountDistinct() throws Exception {

        execute(&quot;select count(distinct good) from employees&quot;);
        assertEquals(1, response.rowCount());
        assertEquals(2L, response.rows()[0][0]);
    }

    @Test
    public void testGlobalCountDistinctColumnReuse() throws Exception {</B></FONT>

        execute(&quot;select count(distinct good), count(distinct department), count(distinct good) from employees&quot;);
        assertEquals(1, response.rowCount());
        assertEquals(2L, response.rows()[0][0]);
        assertEquals(4L, response.rows()[0][1]);
        assertEquals(2L, response.rows()[0][2]);
    }

    @Test
    public void testGlobalAggregateOnNestedColumn() throws Exception {
        this.setup.groupBySetup();
        waitNoPendingTasksOnAll();
        execute(&quot;select count(details['job']), min(details['job']), max(details['job']), count(distinct details['job']) from characters&quot;);
        assertEquals(1, response.rowCount());
        assertEquals(2L, response.rows()[0][0]);
        assertEquals(&quot;Mathematician&quot;, response.rows()[0][1]);
        assertEquals(&quot;Sandwitch Maker&quot;, response.rows()[0][2]);
        assertEquals(2L, response.rows()[0][3]);
    }

    @Test
    public void testGroupByAggregateOnNestedColumn() throws Exception {
        this.setup.groupBySetup();
        waitNoPendingTasksOnAll();
        execute(&quot;select race, count(details['job']) from characters group by race order by race&quot;);
        assertEquals(3, response.rowCount());
        assertEquals(&quot;Android&quot;, response.rows()[0][0]);
        assertEquals(0L, response.rows()[0][1]);

        assertEquals(&quot;Human&quot;, response.rows()[1][0]);
        assertEquals(2L, response.rows()[1][1]);

        assertEquals(&quot;Vogon&quot;, response.rows()[2][0]);
        assertEquals(0L, response.rows()[2][1]);
    }

    @Test
    public void testGroupByAggregateOnNestedColumnOrderBy() throws Exception {
        this.setup.groupBySetup();
        waitNoPendingTasksOnAll();
        execute(&quot;select race, count(details['job']) from characters group by race order by count(details['job']) desc limit 1&quot;);
        assertEquals(1, response.rowCount());
        assertArrayEquals(new String[]{&quot;race&quot;, &quot;count(details['job'])&quot;}, response.cols());
        assertEquals(&quot;Human&quot;, response.rows()[0][0]);
        assertEquals(2L, response.rows()[0][1]);
    }

    @Test
    public void testGroupByAggregateOnNestedColumnOrderByAlias() throws Exception {
        this.setup.groupBySetup();
        waitNoPendingTasksOnAll();
        execute(&quot;select race, count(details['job']) as job_count from characters group by race order by job_count desc limit 1&quot;);
        assertEquals(1, response.rowCount());
        assertArrayEquals(new String[]{&quot;race&quot;, &quot;job_count&quot;}, response.cols());

        assertEquals(&quot;Human&quot;, response.rows()[0][0]);
        assertEquals(2L, response.rows()[0][1]);
    }

    @Test
    public void testGroupByUnknownResultColumn() throws Exception {
        this.setup.groupBySetup();
        Assertions.assertThrows(Exception.class, () -&gt; execute(&quot;select details_ignored['lol'] from characters group by race&quot;),
                                &quot;'details_ignored['lol']' must appear in the GROUP BY clause&quot;);
    }

    @Test
    public void test_group_by_undefined_column_casted() throws Exception {
        this.setup.groupBySetup();
        execute(&quot;select max(age) from characters group by details_ignored['lol']::String&quot;);
        assertEquals(1, response.rowCount());
        assertEquals(112, response.rows()[0][0]);
    }

    @Test
    public void testGroupByUnknownWhere() throws Exception {
        this.setup.groupBySetup();
        execute(&quot;select max(birthdate), race from characters where details_ignored['lol']='funky' group by race&quot;);
        assertEquals(0, response.rowCount());
    }

    @Test
    public void testNonDistributedGroupByNoMatch() throws Exception {
        execute(&quot;create table characters (&quot; +
                &quot; details_ignored object(ignored),&quot; +
                &quot; race string&quot; +
                &quot;) clustered into 1 shards&quot;);
        ensureYellow();
        execute(&quot;select race from characters where details_ignored['lol']='funky' group by race&quot;);
        assertEquals(0, response.rowCount());
    }

    @Test
    public void testGlobalAggregateUnknownWhere() throws Exception {
        this.setup.groupBySetup();
        execute(&quot;select max(birthdate) from characters where details_ignored['lol']='funky'&quot;);
        assertEquals(1, response.rowCount());
        assertNull(response.rows()[0][0]);
    }

    @Test
    public void testAggregateNonExistingColumn() throws Exception {
        this.setup.groupBySetup();
        execute(&quot;select max(details_ignored['lol']), race from characters group by race order by race&quot;);
        assertThat(printedTable(response.rows()), is(&quot;NULL| Android\n&quot; +
                                                     &quot;NULL| Human\n&quot; +
                                                     &quot;NULL| Vogon\n&quot;));
    }

    @Test
    public void testHavingGlobalAggregation() throws Exception {
        this.setup.groupBySetup(&quot;integer&quot;);
        execute(&quot;select min(birthdate), min(age) from characters having min(age) &lt; 33 and max(age) &gt; 100&quot;);
        assertEquals(1L, response.rowCount());
        assertEquals(2, response.rows()[0].length);
        assertEquals(0L, response.rows()[0][0]);
        assertEquals(32, response.rows()[0][1]);
    }

    @Test
    public void testHavingGroupBy() throws Exception {
        this.setup.groupBySetup(&quot;integer&quot;);
        execute(&quot;select age from characters group by age having age &gt; 40 order by age&quot;);
        assertEquals(2L, response.rowCount());
        assertEquals(43, response.rows()[0][0]);
    }

    @Test
    public void testHavingGroupByOnScalar() throws Exception {
        this.setup.groupBySetup(&quot;integer&quot;);
        execute(&quot;select date_trunc('week', birthdate) from characters group by 1&quot; +
                &quot; having date_trunc('week', birthdate) &gt; 0&quot; +
                &quot; order by date_trunc('week', birthdate)&quot;);
        assertEquals(2L, response.rowCount());
    }

    @Test
    public void testHavingOnSameAggregate() throws Exception {
        this.setup.groupBySetup(&quot;integer&quot;);
        execute(&quot;select avg(birthdate) from characters group by gender\n&quot; +
                &quot;having avg(birthdate) = 181353600000.0&quot;);
        assertThat(response.rowCount(), is(1L));
        assertThat(printedTable(response.rows()), is(&quot;1.813536E11\n&quot;));
    }

    @Test
    public void testHavingOnOtherAggregate() throws Exception {
        this.setup.groupBySetup(&quot;integer&quot;);
        execute(&quot;select avg(birthdate) from characters group by gender\n&quot; +
                &quot;having min(birthdate) &gt; '1970-01-01'&quot;);
        assertThat(response.rowCount(), is(1L));
        assertThat(printedTable(response.rows()), is(&quot;1.813536E11\n&quot;));
    }


    @Test
    public void testHavingGroupByWithAggSelected() throws Exception {
        this.setup.groupBySetup(&quot;integer&quot;);
        execute(&quot;select age, count(*) from characters group by age having age &gt; 40 order by age&quot;);
        assertEquals(2L, response.rowCount());
        assertEquals(43, response.rows()[0][0]);
    }

    @Test
    public void testHavingGroupByNonDistributed() throws Exception {
        execute(&quot;create table foo (id int, name string, country string) clustered by (country) with (number_of_replicas = 0)&quot;);
        ensureYellow();

        execute(&quot;insert into foo (id, name, country) values (?, ?, ?)&quot;, new Object[][]{
            new Object[]{1, &quot;Arthur&quot;, &quot;Austria&quot;},
            new Object[]{2, &quot;Trillian&quot;, &quot;Austria&quot;},
            new Object[]{3, &quot;Marvin&quot;, &quot;Austria&quot;},
            new Object[]{4, &quot;Jeltz&quot;, &quot;German&quot;},
            new Object[]{5, &quot;Ford&quot;, &quot;German&quot;},
            new Object[]{6, &quot;Slartibardfast&quot;, &quot;Italy&quot;},
        });
        refresh();


        execute(&quot;select country from foo group by country having country = 'Austria'&quot;);
        assertThat(response.rowCount(), is(1L));
        assertThat((String) response.rows()[0][0], is(&quot;Austria&quot;));

        execute(&quot;select count(*), country from foo group by country having country = 'Austria'&quot;);
        assertThat(response.rowCount(), is(1L));
        assertThat((Long) response.rows()[0][0], is(3L));
        assertThat((String) response.rows()[0][1], is(&quot;Austria&quot;));

        execute(&quot;select country, min(id) from foo group by country having min(id) &lt; 5 &quot;);
        assertThat(response.rowCount(), is(2L));
    }

    @Test
    public void testGroupByHavingInsertInto() throws Exception {
        execute(&quot;create table foo (id int, name string, country string) with (number_of_replicas = 0)&quot;);
        execute(&quot;create table bar (country string) clustered by (country) with (number_of_replicas = 0)&quot;);
        ensureYellow();

        execute(&quot;insert into foo (id, name, country) values (?, ?, ?)&quot;, new Object[][]{
            new Object[]{1, &quot;Arthur&quot;, &quot;Austria&quot;},
            new Object[]{2, &quot;Trillian&quot;, &quot;Austria&quot;},
            new Object[]{3, &quot;Marvin&quot;, &quot;Austria&quot;},
            new Object[]{4, &quot;Jeltz&quot;, &quot;German&quot;},
            new Object[]{5, &quot;Ford&quot;, &quot;German&quot;},
            new Object[]{6, &quot;Slartibardfast&quot;, &quot;Italy&quot;},
        });
        refresh();

        execute(&quot;insert into bar(country)(select country from foo group by country having country = 'Austria')&quot;);
        refresh();
        execute(&quot;select country from bar&quot;);
        assertThat(response.rowCount(), is(1L));
    }

    @Test
    public void testGroupByHavingWithAggregate() throws Exception {
        this.setup.groupBySetup(&quot;integer&quot;);
        execute(&quot;select gender from characters group by gender having min(age) &lt; 33&quot;);
        assertEquals(1L, response.rowCount());
    }

    @Test
    public void testGroupByOnClusteredByColumn() throws Exception {
        execute(&quot;create table foo (id int, name string, country string) clustered by (country) with (number_of_replicas = 0)&quot;);
        ensureYellow();

        execute(&quot;insert into foo (id, name, country) values (?, ?, ?)&quot;, new Object[][]{
            new Object[]{1, &quot;Arthur&quot;, &quot;Austria&quot;},
            new Object[]{2, &quot;Trillian&quot;, &quot;Austria&quot;},
            new Object[]{3, &quot;Marvin&quot;, &quot;Austria&quot;},
            new Object[]{4, &quot;Jeltz&quot;, &quot;Germany&quot;},
            new Object[]{5, &quot;Ford&quot;, &quot;Germany&quot;},
            new Object[]{6, &quot;Slartibardfast&quot;, &quot;Italy&quot;},
        });
        refresh();

        execute(&quot;select count(*), country from foo group by country order by count(*) desc&quot;);
        assertThat(response.rowCount(), Is.is(3L));
        assertThat((String) response.rows()[0][1], Is.is(&quot;Austria&quot;));
        assertThat((String) response.rows()[1][1], Is.is(&quot;Germany&quot;));
        assertThat((String) response.rows()[2][1], Is.is(&quot;Italy&quot;));
    }

    @Test
    public void testGroupByOnAllPrimaryKeys() throws Exception {
        execute(&quot;create table foo (id int primary key, name string primary key) with (number_of_replicas = 0)&quot;);
        ensureYellow();

        execute(&quot;insert into foo (id, name) values (?, ?)&quot;, new Object[][]{
            new Object[]{1, &quot;Arthur&quot;},
            new Object[]{2, &quot;Trillian&quot;},
            new Object[]{3, &quot;Slartibardfast&quot;},
            new Object[]{4, &quot;Marvin&quot;},
        });
        refresh();

        execute(&quot;select count(*), name from foo group by id, name order by name desc&quot;);
        assertThat(printedTable(response.rows()), is(
            &quot;1| Trillian\n&quot; +
            &quot;1| Slartibardfast\n&quot; +
            &quot;1| Marvin\n&quot; +
            &quot;1| Arthur\n&quot;));
    }

    @Test
    public void testGroupByEmpty() throws Exception {
        execute(&quot;create table test (col1 string)&quot;);
        ensureYellow();

        execute(&quot;select count(*), col1 from test group by col1&quot;);
        assertEquals(0, response.rowCount());
    }

    @Test
    public void testGroupByOnSysNodes() throws Exception {
        execute(&quot;select count(*), name from sys.nodes group by name&quot;);
        assertThat(response.rowCount(), Is.is(2L));

        execute(&quot;select count(*), hostname from sys.nodes group by hostname&quot;);
        assertThat(response.rowCount(), Is.is(1L));
    }

    @Test
    public void testGroupByCountStringGroupByPrimaryKey() throws Exception {
        execute(&quot;create table rankings (&quot; +
                &quot; \&quot;pageURL\&quot; string primary key,&quot; +
                &quot; \&quot;pageRank\&quot; int,&quot; +
                &quot; \&quot;avgDuration\&quot; int&quot; +
                &quot;) with (number_of_replicas=0)&quot;);
        ensureYellow();
        for (int i = 0; i &lt; 100; i++) {
            execute(&quot;insert into rankings (\&quot;pageURL\&quot;, \&quot;pageRank\&quot;, \&quot;avgDuration\&quot;) values (?, ?, ?)&quot;,
                new Object[]{String.valueOf(i), randomIntBetween(i, i * i), randomInt(i)});
            assertThat(response.rowCount(), is(1L));
        }
        execute(&quot;refresh table rankings&quot;);

        execute(&quot;select count(*), \&quot;pageURL\&quot; from rankings group by \&quot;pageURL\&quot; order by 1 desc limit 100&quot;);
        assertThat(response.rowCount(), is(100L));
        assertThat(new ArrayBucket(response.rows()), TestingHelpers.hasSortedRows(0, true, null));
    }

    @Test
    public void testGroupByCountString() throws Exception {
        execute(&quot;create table rankings (&quot; +
                &quot; \&quot;pageURL\&quot; string,&quot; +
                &quot; \&quot;pageRank\&quot; int,&quot; +
                &quot; \&quot;avgDuration\&quot; int&quot; +
                &quot;) with (number_of_replicas=0)&quot;);
        ensureYellow();
        for (int i = 0; i &lt; 100; i++) {
            execute(&quot;insert into rankings (\&quot;pageURL\&quot;, \&quot;pageRank\&quot;, \&quot;avgDuration\&quot;) values (?, ?, ?)&quot;,
                new Object[]{randomAsciiLettersOfLength(10 + (i % 3)), randomIntBetween(i, i * i), randomInt(i)});
        }
        execute(&quot;refresh table rankings&quot;);
        execute(&quot;select count(*), \&quot;pageURL\&quot; from rankings group by \&quot;pageURL\&quot; order by 1 desc limit 100&quot;);
        assertThat(response.rowCount(), is(100L));
    }

    @Test
    public void testAggregateTwiceOnRoutingColumn() throws Exception {
        execute(&quot;create table twice (&quot; +
                &quot;name string, &quot; +
                &quot;url string, &quot; +
                &quot;score double&quot; +
                &quot;) clustered by (url) with (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into twice (\&quot;name\&quot;, \&quot;url\&quot;, \&quot;score\&quot;) values (?, ?, ?)&quot;,
            new Object[]{
                &quot;A&quot;,
                &quot;https://.com&quot;,
                99.6d});
        refresh();
        execute(&quot;select avg(score), url, avg(score) from twice group by url limit 10&quot;);
        assertThat(printedTable(response.rows()), is(&quot;99.6| https://.com| 99.6\n&quot;));
    }

    @Test
    public void testGroupByWithHavingAndLimit() throws Exception {
        execute(&quot;create table likes (&quot; +
                &quot;   event_id string,&quot; +
                &quot;   item_id string&quot; +
                &quot;) clustered into 2 shards with (number_of_replicas = 0)&quot;);
        ensureYellow();
        execute(&quot;insert into likes (event_id, item_id) values (?, ?)&quot;, new Object[][]{
            new Object[]{&quot;event1&quot;, &quot;item1&quot;},
            new Object[]{&quot;event1&quot;, &quot;item1&quot;},
            new Object[]{&quot;event1&quot;, &quot;item2&quot;},
            new Object[]{&quot;event2&quot;, &quot;item1&quot;},
            new Object[]{&quot;event2&quot;, &quot;item2&quot;},
        });
        execute(&quot;refresh table likes&quot;);

        try {
            execute(&quot;select count(*), item_id from likes where event_id = 'event1' group by 2 having count(*) &gt; 1&quot;);
            assertThat(response.rowCount(), is(1L));
        } catch (Exception e) {
            fail(e.getMessage());
        }

        try {
            execute(&quot;select count(*), item_id from likes where event_id = 'event1' group by 2 having count(*) &gt; 1 limit 100&quot;);
            assertThat(response.rowCount(), is(1L));
        } catch (Exception e) {
            fail(e.getMessage());
        }

        try {
            execute(&quot;select item_id, count(*) from likes where event_id = 'event1' group by 1 having count(*) &gt; 1&quot;);
            assertThat(response.rowCount(), is(1L));
        } catch (Exception e) {
            fail(e.getMessage());
        }

        try {
            execute(&quot;select item_id, count(*) from likes where event_id = 'event1' group by 1 having count(*) &gt; 1 limit 100&quot;);
            assertThat(response.rowCount(), is(1L));
        } catch (Exception e) {
            fail(e.getMessage());
        }
    }

    @Test
    public void testNonDistributedGroupByWithHavingAndLimit() throws Exception {
        execute(&quot;create table likes (&quot; +
                &quot;   event_id string,&quot; +
                &quot;   item_id string&quot; +
                &quot;) clustered into 1 shards with (number_of_replicas = 0)&quot;);
        // only 1 shard to force non-distribution
        ensureYellow();
        execute(&quot;insert into likes (event_id, item_id) values (?, ?)&quot;, new Object[][]{
            new Object[]{&quot;event1&quot;, &quot;item1&quot;},
            new Object[]{&quot;event1&quot;, &quot;item1&quot;},
            new Object[]{&quot;event1&quot;, &quot;item2&quot;},
            new Object[]{&quot;event2&quot;, &quot;item1&quot;},
            new Object[]{&quot;event2&quot;, &quot;item2&quot;},
        });
        execute(&quot;refresh table likes&quot;);

        try {
            execute(&quot;select count(*), item_id from likes where event_id = 'event1' group by 2 having count(*) &gt; 1&quot;);
            assertThat(response.rowCount(), is(1L));
        } catch (Exception e) {
            fail(e.getMessage());
        }

        try {
            execute(&quot;select count(*), item_id from likes where event_id = 'event1' group by 2 having count(*) &gt; 1 limit 100&quot;);
            assertThat(response.rowCount(), is(1L));
        } catch (Exception e) {
            fail(e.getMessage());
        }

        try {
            execute(&quot;select item_id, count(*) from likes where event_id = 'event1' group by 1 having count(*) &gt; 1&quot;);
            assertThat(response.rowCount(), is(1L));
        } catch (Exception e) {
            fail(e.getMessage());
        }

        try {
            execute(&quot;select item_id, count(*) from likes where event_id = 'event1' group by 1 having count(*) &gt; 1 limit 100&quot;);
            assertThat(response.rowCount(), is(1L));
        } catch (Exception e) {
            fail(e.getMessage());
        }

        try {
            execute(&quot;select count(*), item_id from likes group by item_id having min(event_id) = 'event1'&quot;);
            assertThat(response.rowCount(), is(2L));
        } catch (Exception e) {
            fail(e.getMessage());
        }
    }

    @Test
    public void groupByAggregateStdDevByte() throws Exception {
        this.setup.groupBySetup(&quot;byte&quot;);

        execute(&quot;select stddev(age), gender from characters group by gender order by gender&quot;);
        assertEquals(2L, response.rowCount());
        assertEquals(5.5d, response.rows()[0][0]);
        assertEquals(39.0d, response.rows()[1][0]);
    }

    @Test
    public void groupByAggregateVarianceByte() throws Exception {
        this.setup.groupBySetup(&quot;byte&quot;);

        execute(&quot;select variance(age), gender from characters group by gender order by gender&quot;);
        assertEquals(2L, response.rowCount());
        assertEquals(30.25d, response.rows()[0][0]);
        assertEquals(1521.0d, response.rows()[1][0]);
    }

    @Test
    public void groupByAggregateStdDevDouble() throws Exception {
        this.setup.groupBySetup(&quot;double&quot;);

        execute(&quot;select stddev(age), gender from characters group by gender order by gender&quot;);
        assertEquals(2L, response.rowCount());
        assertEquals(5.5d, response.rows()[0][0]);
        assertEquals(39.0d, response.rows()[1][0]);
    }

    @Test
    public void groupByStatsAggregatesGlobal() throws Exception {
        this.setup.groupBySetup(&quot;short&quot;);
        execute(&quot;select min(age), mean(age), geometric_mean(age), max(age), variance(age), stddev(age) from characters&quot;);
        assertThat((Short) response.rows()[0][0], is((short) 32));
        assertThat((Double) response.rows()[0][1], is(55.25d));

        assertThat((Double) response.rows()[0][2], closeTo(47.84415001097868d, 0.0000001));
        assertThat((Short) response.rows()[0][3], is((short) 112));
        assertThat((Double) response.rows()[0][4], is(1090.6875d));
        assertThat((Double) response.rows()[0][5], is(33.025558284456d));
    }

    @Test
    public void testGroupByOnClusteredByColumnPartitioned() throws Exception {
        execute(&quot;CREATE TABLE tickets ( &quot; +
                &quot;  ticket_id long, &quot; +
                &quot;  tenant_id integer, &quot; +
                &quot;  created_month string )&quot; +
                &quot;PARTITIONED BY (created_month) &quot; +
                &quot;CLUSTERED BY (tenant_id) &quot; +
                &quot;WITH (number_of_replicas=0)&quot;);
        ensureYellow();
        execute(&quot;insert into tickets (ticket_id, tenant_id, created_month) values (?, ?, ?)&quot;,
            new Object[][]{
                {1L, 42, 1425168000000L},
                {2L, 43, 0},
                {3L, 44, 1425168000000L},
                {4L, 45, 499651200000L},
                {5L, 42, 0L},
            });
        ensureYellow();
        refresh();

        execute(&quot;select count(*), tenant_id from tickets group by 2 order by tenant_id limit 100&quot;);
        assertThat(printedTable(response.rows()), is(
            &quot;2| 42\n&quot; + // assert that different partitions have been merged
            &quot;1| 43\n&quot; +
            &quot;1| 44\n&quot; +
            &quot;1| 45\n&quot;));
    }

    @Test
    public void testFilterByScore() throws Exception {
        execute(&quot;create table locations (&quot; +
                &quot; altitude int,&quot; +
                &quot; name string,&quot; +
                &quot; description string index using fulltext&quot; +
                &quot;) clustered into 1 shards with (number_of_replicas = 0)&quot;); // 1 shard because scoring is relative within a shard
        ensureYellow();

        execute(&quot;insert into locations (altitude, name, description) values (420, 'Crate Dornbirn', 'A nice place in a nice country')&quot;);
        execute(&quot;insert into locations (altitude, name, description) values (230, 'Crate Berlin', 'Also very nice place mostly nice in summer')&quot;);
        execute(&quot;insert into locations (altitude, name, description) values (70, 'Crate SF', 'A nice place with lot of sunshine')&quot;);
        execute(&quot;refresh table locations&quot;);

        execute(&quot;select min(altitude) as altitude, name, _score from locations where match(description, 'nice') &quot; +
                &quot;and _score &gt;= 1.08 group by name, _score order by name&quot;);
        assertEquals(2L, response.rowCount());
    }

    @Test
    public void testDistinctWithGroupBy() throws Exception {
        execute(&quot;select DISTINCT max(col1), min(col1) from unnest([1,1,1,2,2,2,2,3,3],[1,2,3,1,2,3,4,1,2]) &quot; +
                &quot;group by col2 order by 2, 1&quot;);
        assertThat(printedTable(response.rows()), is(&quot;2| 1\n&quot; +
                                                     &quot;3| 1\n&quot; +
                                                     &quot;2| 2\n&quot;));
    }

    @Test
    public void testDistinctWithGroupByLimitAndOffset() throws Exception {
        execute(&quot;select DISTINCT max(col2), min(col2) from &quot; +
                &quot;unnest([1,1,2,2,3,3,4,4,5,5,6,6],[1,2,2,1,2,1,3,4,4,3,5,6]) &quot; +
                &quot;group by col1 order by 1 desc, 2 limit 2 offset 1&quot;);
        assertThat(printedTable(response.rows()), is(&quot;4| 3\n&quot; +
                                                     &quot;2| 1\n&quot;));
    }

    @Test
    public void testDistinctOnJoinWithGroupBy() throws Exception {
        execute(&quot;select DISTINCT max(t1.col1), min(t2.col2) from &quot; +
                &quot;unnest([1,1,1,2,2,2,2,3,3],[1,2,3,1,2,3,4,1,2]) as t1, &quot; +
                &quot;unnest([1,1,1,2,2,2,2,3,3],[1,2,3,1,2,3,4,1,2]) as t2 &quot; +
                &quot;where t1.col1=t2.col2 &quot; +
                &quot;group by t1.col2 order by 2, 1&quot;);
        assertThat(printedTable(response.rows()), is(&quot;2| 1\n&quot; +
                                                     &quot;3| 1\n&quot; +
                                                     &quot;2| 2\n&quot;));
    }

    @Test
    public void testDistinctOnSubselectWithGroupBy() throws Exception {
        execute(&quot;select * from (&quot; +
                &quot; select distinct max(col1), min(col1) from unnest([1,1,1,2,2,2,2,3,3],[1,2,3,1,2,3,4,1,2]) &quot; +
                &quot; group by col2 order by 2, 1 limit 2&quot; +
                &quot;) t order by 1 desc limit 1&quot;);
        assertThat(printedTable(response.rows()), is(&quot;3| 1\n&quot;));
    }

    @Test
    public void testGroupByOnScalarOnArray() throws Exception {
        execute(&quot;select string_to_array(col1, ' ')[2], count(*) &quot; +
                &quot;from unnest([' select foo', 'insert into ', 'select 1']) &quot; +
                &quot;group by 1 order by 2 desc&quot;);
        assertThat(printedTable(response.rows()), is(&quot;into| 1\n&quot; +
                                                     &quot;1| 1\n&quot; +
                                                     &quot;select| 1\n&quot;));
    }

    @Test
    public void testGroupByOnComplexLiterals() throws Exception {
        execute(&quot;select '{coordinates=[[0.0, 0.0], [1.0, 1.0]], type=LineString}', count(*) &quot; +
                &quot;from employees group by 1&quot;);
        assertThat(printedTable(response.rows()), is(&quot;{coordinates=[[0.0, 0.0], [1.0, 1.0]], type=LineString}| 6\n&quot;));
        execute(&quot;select {id1=1, id2=36}, count(*) &quot; +
                &quot;from employees group by 1&quot;);
        assertThat(printedTable(response.rows()), is(&quot;{id1=1, id2=36}| 6\n&quot;));
    }

    @Test
    public void testGroupByOnIndexOff() throws Exception {
        execute(&quot;create table t1 (i int index off, s string index off)&quot;);
        execute(&quot;insert into t1 (i, s) values (?,?)&quot;,
            new Object[][]{
                {1, &quot;foo&quot;},
                {2, &quot;bar&quot;},
                {1, &quot;foo&quot;}
        });
        refresh();
        execute(&quot;select count(*), i, s from t1 group by i, s order by 1&quot;);
        assertThat(printedTable(response.rows()), is(&quot;1| 2| bar\n&quot; +
                                                     &quot;2| 1| foo\n&quot;));
    }

    @Test
    public void testAggregateOnIndexOff() throws Exception {
        execute(&quot;create table t1 (i int index off, s string index off)&quot;);
        execute(&quot;insert into t1 (i, s) values (?,?)&quot;,
            new Object[][]{
                {1, &quot;foo&quot;},
                {2, &quot;foobar&quot;},
                {1, &quot;foo&quot;}
        });
        refresh();
        execute(&quot;select sum(i), max(s) from t1&quot;);
        assertThat(printedTable(response.rows()), is(&quot;4| foobar\n&quot;));
    }

    @Test
    public void testGroupBySingleNumberWithNullValues() {
        execute(&quot;create table t (along long, aint int, ashort short) clustered into 2 shards with (number_of_replicas = 0)&quot;);
        execute(&quot;insert into t (along,aint,ashort) values (1,1,1), (1,1,1), (1,1,1), (2,2,2), (2,2,2), (null,null,null), &quot; +
                &quot;(null,null,null), (null,null,null), (null,null,null)&quot;);
        execute(&quot;refresh table t&quot;);

        assertThat(
            printedTable(execute(&quot;select along, count(*) from t group by along order by 2 desc&quot;).rows()),
            is(&quot;NULL| 4\n&quot; +
               &quot;1| 3\n&quot; +
               &quot;2| 2\n&quot;)
        );

        assertThat(
            printedTable(execute(&quot;select aint, count(*) from t group by aint order by 2 desc&quot;).rows()),
            is(&quot;NULL| 4\n&quot; +
               &quot;1| 3\n&quot; +
               &quot;2| 2\n&quot;)
        );

        assertThat(
            printedTable(execute(&quot;select ashort, count(*) from t group by ashort order by 2 desc&quot;).rows()),
            is(&quot;NULL| 4\n&quot; +
               &quot;1| 3\n&quot; +
               &quot;2| 2\n&quot;)
        );
    }

    @Test
    public void testSelectAndGroupBySingleStringKeyForLowCardinalityField() {
        execute(&quot;create table t (name string) clustered into 1 shards&quot;);
        // has low cardinality ration: CARDINALITY_RATIO_THRESHOLD (0.5) &gt; 2 terms / 4 docs
        execute(&quot;insert into t (name) values ('a'), ('b'), ('a'), ('b')&quot;);
        execute(&quot;refresh table t&quot;);
        execute(&quot;select name, count(name) from t group by 1 order by 1&quot;);
        assertThat(printedTable(response.rows()), is(
            &quot;a| 2\n&quot; +
            &quot;b| 2\n&quot;));
    }

    @Test
    public void testSelectCollectSetAndGroupBy() {
        execute(&quot;SELECT\n&quot; +
                &quot;col1,\n&quot; +
                &quot;collect_set(col1)\n&quot; +
                &quot;FROM unnest(ARRAY[1, 2, 2, 3, 4, 5, null]) col1 &quot; +
                &quot;GROUP BY col1 &quot; +
                &quot;ORDER BY col1 NULLS LAST&quot;);
        assertThat(
            printedTable(response.rows()),
            Matchers.is(&quot;1| [1]\n&quot; +
                        &quot;2| [2]\n&quot; +
                        &quot;3| [3]\n&quot; +
                        &quot;4| [4]\n&quot; +
                        &quot;5| [5]\n&quot; +
                        &quot;NULL| []\n&quot;)
        );
    }

    @Test
    public void test_optimized_topn_distinct_returns_2_unique_items() throws Throwable {
        execute(&quot;create table m.tbl (id int primary key)&quot;);
        Object[][] ids = new Object[100][];
        for (int i = 0; i &lt; ids.length; i++) {
            ids[i] = new Object[] { i };
        }
<A NAME="8"></A>        execute(&quot;insert into m.tbl (id) values (?)&quot;, ids);
        execute(&quot;refresh table m.tbl&quot;);
        execute(&quot;analyze&quot;);
        <FONT color="#c58917"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match1076278-0.html#8',2,'match1076278-top.html#8',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>execute(&quot;explain select distinct id from m.tbl limit 2&quot;);
        assertThat(
            printedTable(response.rows()),
            is(&quot;TopNDistinct[2::bigint;0 | [id]]\n&quot; +
               &quot;   Collect[m.tbl | [id] | true]\n&quot;)
        );
        execute(&quot;select distinct id from m.tbl limit 2&quot;);
        assertThat(response.rowCount(), is(2L));
        Object firstId = response.rows</B></FONT>()[0][0];
        Object secondId = response.rows()[1][0];
        assertThat(firstId, not(is(secondId)));
    }

    @Test
    public void test_select_distinct_with_limit_and_offset_applies_limit_and_offset_on_distinct_resultset() throws Exception {
        execute(&quot;create table tbl (x int)&quot;);
        execute(&quot;insert into tbl (x) values (1), (1), (2), (3)&quot;);
        execute(&quot;refresh table tbl&quot;);

        execute(&quot;select distinct x from tbl limit 1 offset 3&quot;);
        assertThat(response.rowCount(), is(0L));
    }

    @Test
    public void test_group_by_on_subscript_on_object_of_sub_relation() {
        execute(&quot;create table tbl (obj object as (x int))&quot;);
        execute(&quot;insert into tbl (obj) values ({x=10})&quot;);
        execute(&quot;refresh table tbl&quot;);
        execute(&quot;select obj['x'] from (select obj from tbl) as t group by obj['x']&quot;);
        assertThat(printedTable(response.rows()), Is.is(&quot;10\n&quot;));
    }

    @Test
    public void test_select_same_aggregate_multiple_times() throws Exception {
        execute(&quot;create table doc.tbl (name text, x int)&quot;);
        execute(&quot;insert into doc.tbl (name, x) values ('Apple', 1), ('Apple', 2), ('Apple', 3)&quot;);
        execute(&quot;refresh table doc.tbl&quot;);


        execute(&quot;explain select name, count(x), count(x) from doc.tbl group by name&quot;);
        assertThat(
            printedTable(response.rows()),
            Is.is(
                &quot;Eval[name, count(x), count(x)]\n&quot; +
                &quot;   GroupHashAggregate[name | count(x)]\n&quot;+
                &quot;     Collect[doc.tbl | [x, name] | true]\n&quot;
            )
        );
        execute(&quot;select name, count(x), count(x) from doc.tbl group by name&quot;);
        assertThat(printedTable(response.rows()), Is.is(&quot;Apple| 3| 3\n&quot;));
    }

    @Test
    @UseJdbc(1)
    public void test_group_by_on_duplicate_keys() throws Exception {
        execute(&quot;create table tbl (city text, name text, id text, location geo_point)&quot;);
        execute(
            &quot;insert into tbl (id, name, location, city) values &quot; +
            &quot; ('122021430M', 'Rue Penavayre', [2.573609,44.35007], 'Rodez'), &quot; +
            &quot; ('013440476U', 'Avenue de Trvoux ', [5.201722,46.20096], 'Saint-Denis-ls-Bourg'), &quot; +
            &quot; ('021140050C', 'Rue Paul Doumer ', [3.426928,49.04915], 'Brasles') &quot;);
        execute(&quot;refresh table tbl&quot;);
        execute(&quot;SELECT DISTINCT id, name, id, location, city FROM tbl&quot;);

        // Ensure deterministic order for assertion  sort by id
        Arrays.sort(response.rows(), (a, b) -&gt; ((String) a[0]).compareTo((String) b[0]));
        assertThat(printedTable(response.rows()), is(
            &quot;013440476U| Avenue de Trvoux | 013440476U| Pt(x=5.20172193646431,y=46.200959966517985)| Saint-Denis-ls-Bourg\n&quot; +
            &quot;021140050C| Rue Paul Doumer | 021140050C| Pt(x=3.426927952095866,y=49.04914998449385)| Brasles\n&quot; +
            &quot;122021430M| Rue Penavayre| 122021430M| Pt(x=2.573608970269561,y=44.35006999410689)| Rodez\n&quot;
        ));
    }
}
</PRE>
</div>
  </div>
</body>
</html>
