<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>Matches for SslContextProviderTest.java &amp; GroupByAggregateTest.java</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<style>.modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.4);}  .modal-content {height: 250%;background-color: #fefefe;margin: 5% auto;padding: 20px;border: 1px solid #888;width: 80%;}  .close {color: #aaa;float: right;font-size: 20px;font-weight: bold;}  .close:hover, .close:focus {color: black;text-decoration: none;cursor: pointer;}  .column {float: left;width: 50%;}  .row:after {content: ;display: table;clear: both;}  #column1, #column2 {white-space: pre-wrap;}</style></head>
<body>
<div style="align-items: center; display: flex; justify-content: space-around;">
<div>
<h3 align="center">
Matches for SslContextProviderTest.java &amp; GroupByAggregateTest.java
      </h3>
<h1 align="center">
        15.7%
      </h1>
<center>
<a href="#" target="_top">
          INDEX
        </a>
<span>-</span>
<a href="#" target="_top">
          HELP
        </a>
</center>
</div>
<div>
<table bgcolor="#d0d0d0" border="1" cellspacing="0">
<tr><th><th>SslContextProviderTest.java (63.178295%)<th>GroupByAggregateTest.java (8.970831%)<th>Tokens
<tr onclick='openModal("#0000ff")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#0000ff"><font color="#0000ff">-</font><td><a href="#" name="0">(164-174)<td><a href="#" name="0">(169-184)</a><td align="center"><font color="#ff0000">24</font>
<tr onclick='openModal("#f63526")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#f63526"><font color="#f63526">-</font><td><a href="#" name="1">(114-123)<td><a href="#" name="1">(112-134)</a><td align="center"><font color="#d40000">20</font>
<tr onclick='openModal("#980517")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#980517"><font color="#980517">-</font><td><a href="#" name="2">(128-141)<td><a href="#" name="2">(626-639)</a><td align="center"><font color="#c90000">19</font>
<tr onclick='openModal("#53858b")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#53858b"><font color="#53858b">-</font><td><a href="#" name="3">(22-43)<td><a href="#" name="3">(22-43)</a><td align="center"><font color="#c90000">19</font>
<tr onclick='openModal("#6cc417")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#6cc417"><font color="#6cc417">-</font><td><a href="#" name="4">(87-94)<td><a href="#" name="4">(193-207)</a><td align="center"><font color="#bf0000">18</font>
<tr onclick='openModal("#151b8d")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#151b8d"><font color="#151b8d">-</font><td><a href="#" name="5">(153-161)<td><a href="#" name="5">(60-70)</a><td align="center"><font color="#aa0000">16</font>
<tr onclick='openModal("#8c8774")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#8c8774"><font color="#8c8774">-</font><td><a href="#" name="6">(97-104)<td><a href="#" name="6">(208-217)</a><td align="center"><font color="#9f0000">15</font>
<tr onclick='openModal("#38a4a5")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#38a4a5"><font color="#38a4a5">-</font><td><a href="#" name="7">(142-150)<td><a href="#" name="7">(82-92)</a><td align="center"><font color="#7f0000">12</font>
<tr onclick='openModal("#c58917")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#c58917"><font color="#c58917">-</font><td><a href="#" name="8">(106-113)<td><a href="#" name="8">(1324-1332)</a><td align="center"><font color="#740000">11</font>
<tr onclick='openModal("#83a33a")' onmouseleave='this.style.backgroundColor = "#D0D0D0"' onmouseover='this.style.backgroundColor = "yellow"' style="cursor:pointer"><td bgcolor="#83a33a"><font color="#83a33a">-</font><td><a href="#" name="9">(124-126)<td><a href="#" name="9">(218-225)</a><td align="center"><font color="#5f0000">9</font>
</td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></td></td></a></td></td></tr></th></th></th></th></tr></table>
</div>
</div>
<hr/>
<div style="display: flex;">
<div style="flex-grow: 1;">
<h3>
<center>
<span>SslContextProviderTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#53858b"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>package io.crate.protocols.ssl;
2 import static org.hamcrest.CoreMatchers.containsString;
3 import static org.hamcrest.CoreMatchers.hasItem;
4 import static org.hamcrest.CoreMatchers.not;
5 import static org.hamcrest.CoreMatchers.notNullValue;
6 import static org.hamcrest.Matchers.empty;
7 import static org.hamcrest.Matchers.instanceOf;
8 import static org.hamcrest.Matchers.is;
9 import java.io.File;
10 import java.io.FileNotFoundException;
11 import java.io.IOException;
12 import java.net.URL;
13 import java.net.URLDecoder;
14 import java.nio.charset.StandardCharsets;
15 import java.security.KeyStore;
16 import java.security.PrivateKey;
17 import java.security.UnrecoverableKeyException;
18 import java.security.cert.X509Certificate;
19 import</b></font> javax.net.ssl.KeyManager;
20 import javax.net.ssl.SSLContext;
21 import io.crate.auth.Protocol;
22 import org.elasticsearch.common.settings.Settings;
23 import org.elasticsearch.test.ESTestCase;
24 import org.hamcrest.Matchers;
25 import org.junit.BeforeClass;
26 import org.junit.Test;
27 import io.netty.handler.ssl.SslContext;
28 public class SslContextProviderTest extends ESTestCase {
29     private static final String KEYSTORE_PASSWORD = "keystorePassword";
30     private static final String KEYSTORE_KEY_PASSWORD = "keystorePassword";
31     private static final String TRUSTSTORE_PASSWORD = "keystorePassword";
32     private static final String ROOT_CA_ALIAS = "tmp/localhost";
33     private static File trustStoreFile;
34     private static File keyStoreFile;
35     @BeforeClass
36     public static void beforeTests() throws IOException {
37         trustStoreFile = getAbsoluteFilePathFromClassPath("truststore.pcks12");
38         keyStoreFile = getAbsoluteFilePathFromClassPath("keystore.pcks12");
39     }
40     @Test
41     public void testClassLoadingWithInvalidConfiguration() {
42         Settings settings = Settings.builder()
43             .put(SslSettings.SSL_HTTP_ENABLED.getKey(), true)
44             .put(SslSettings.SSL_PSQL_ENABLED.getKey(), true)
45             .build();
46         expectedException.expect(SslConfigurationException.class);
47         expectedException.expectMessage("Failed to build SSL configuration");
48         var sslContextProvider = new SslContextProvider(settings);
49         sslContextProvider.getServerContext(Protocol.TRANSPORT);
50     }
51 <a name="4"></a>
52     @Test
53     public void testClassLoadingWithValidConfiguration() {
54         Settings settings = <font color="#6cc417"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Settings.builder()
55             .put(SslSettings.SSL_HTTP_ENABLED.getKey(), true)
56             .put(SslSettings.SSL_PSQL_ENABLED.getKey(), true)
57             .put(SslSettings.SSL_TRUSTSTORE_FILEPATH.getKey(), trustStoreFile.getAbsolutePath())
58             .put(SslSettings.SSL_TRUSTSTORE_PASSWORD.getKey(), "keystorePassword")
59             .put(SslSettings.SSL_KEYSTORE_FILEPATH.getKey(), keyStoreFile.getAbsolutePath())
60             .put(SslSettings.SSL_KEYSTORE_PASSWORD.getKey(), "keystorePassword")
61 <a name="6"></a>            .put(SslSettings.SSL_KEYSTORE_KEY_PASSWORD.getKey</b></font>(), "keystorePassword")
62             .build();
63         var sslContextProvider = new SslContextProvider(settings);
64         SslContext sslContext = <font color="#8c8774"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>sslContextProvider.getServerContext(Protocol.TRANSPORT);
65         assertThat(sslContext, instanceOf(SslContext.class));
66         assertThat(sslContext.isServer(), is(true));
67         assertThat(sslContext.cipherSuites(), not(empty()));
68     }
69 <a name="8"></a>    @Test
70     public void test_netty_ssl_context_can_be_built_and_doesnt_override_default_context() throws Exception {</b></font>
71         var defaultSSLContext = SSLContext.getDefault();
72         Settings settings = <font color="#c58917"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>Settings.builder()
73             .put(SslSettings.SSL_TRUSTSTORE_FILEPATH_SETTING_NAME, trustStoreFile.getAbsolutePath())
74             .put(SslSettings.SSL_TRUSTSTORE_PASSWORD_SETTING_NAME, TRUSTSTORE_PASSWORD)
75             .put(SslSettings.SSL_KEYSTORE_FILEPATH_SETTING_NAME, keyStoreFile.getAbsolutePath())
76             .put(SslSettings.SSL_KEYSTORE_PASSWORD_SETTING_NAME, KEYSTORE_PASSWORD)
77 <a name="1"></a>            .put(SslSettings.SSL_KEYSTORE_KEY_PASSWORD_SETTING_NAME, KEYSTORE_KEY_PASSWORD)
78         .build();
79         SslContext sslContext = new SslContextProvider(settings).getServerContext</b></font>(Protocol.TRANSPORT);
80         <font color="#f63526"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>assertThat(sslContext.isServer(), is(true));
81         assertThat(sslContext.cipherSuites(), not(empty()));
82         assertThat(sslContext.cipherSuites(), not(hasItem(containsString("NULL"))));
83         assertThat(defaultSSLContext, Matchers.sameInstance(SSLContext.getDefault()));
84     }
85 <a name="9"></a>
86     @Test
87     public void testKeyStoreLoading() throws Exception {</b></font>
88         KeyStore keyStore = <font color="#83a33a"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>SslContextProvider.loadKeyStore(keyStoreFile.getAbsolutePath(), KEYSTORE_PASSWORD.toCharArray());
89 <a name="2"></a>        assertThat(keyStore.getType(), is("pkcs12"));
90         assertThat(keyStore.getCertificate(ROOT_CA_ALIAS), notNullValue</b></font>());
91         KeyManager[] keyManagers = <font color="#980517"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>SslContextProvider.createKeyManagers(keyStore, KEYSTORE_KEY_PASSWORD.toCharArray());
92         assertThat(keyManagers.length, is(1));
93     }
94     @Test
95     public void testKeyStoreLoadingFailWrongPassword() throws Exception {
96         expectedException.expect(IOException.class);
97         expectedException.expectMessage("keystore password was incorrect");
98         SslContextProvider.loadKeyStore(keyStoreFile.getAbsolutePath(), "wrongpassword".toCharArray());
99     }
100 <a name="7"></a>
101     @Test
102     public void testKeyStoreLoadingFailWrongKeyPassword() throws Exception {</b></font>
103         KeyStore keyStore = <font color="#38a4a5"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>SslContextProvider.loadKeyStore(keyStoreFile.getAbsolutePath(), KEYSTORE_PASSWORD.toCharArray());
104         expectedException.expect(UnrecoverableKeyException.class);
105         expectedException.expectMessage("Get Key failed");
106         SslContextProvider.createKeyManagers(keyStore, "wrongpassword".toCharArray());
107     }
108     @Test
109 <a name="5"></a>    public void testExportRootCertificates() throws Exception {</b></font>
110         KeyStore keyStore = SslContextProvider.loadKeyStore(keyStoreFile.getAbsolutePath(), KEYSTORE_PASSWORD.toCharArray());
111         X509Certificate[] certificates = <font color="#151b8d"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>SslContextProvider.getRootCertificates(keyStore);
112         assertThat(certificates.length, is(1));
113         assertThat(certificates[0].getIssuerDN().getName(), containsString("CN=myCA"));
114         assertThat(certificates[0].getNotAfter().getTime(), is(1651658343000L));
115     }
116     @Test
117 <a name="0"></a>    public void testExportServerCertChain() throws Exception {</b></font>
118         KeyStore keyStore = SslContextProvider.loadKeyStore(keyStoreFile.getAbsolutePath(), KEYSTORE_PASSWORD.toCharArray());
119         X509Certificate[] certificates = <font color="#0000ff"><a href="#"><img align="right" alt="other" border="0" src="forward.gif"/></a><b>SslContextProvider.getCertificateChain(keyStore);
120         assertThat(certificates.length, is(2));
121         assertThat(certificates[0].getIssuerDN().getName(), containsString("CN=myCA, O=Dummy Company, L=Dummy Country, ST=Dummy State, C=AT"));
122         assertThat(certificates[0].getSubjectDN().getName(), containsString("CN=localhost"));
123         assertThat(certificates[1].getIssuerDN().getName(), containsString("CN=myCA, O=Dummy Company, L=Dummy Country, ST=Dummy State, C=AT"));
124         assertThat(certificates[1].getSubjectDN().getName(), containsString("CN=myCA"));
125     }
126     @Test
127     public void testExportDecryptedKey() throws Exception {</b></font>
128         KeyStore keyStore = SslContextProvider.loadKeyStore(keyStoreFile.getAbsolutePath(), KEYSTORE_PASSWORD.toCharArray());
129         PrivateKey privateKey = SslContextProvider.getPrivateKey(keyStore, KEYSTORE_KEY_PASSWORD.toCharArray());
130         assertThat(privateKey, Matchers.notNullValue());
131     }
132     public static File getAbsoluteFilePathFromClassPath(final String fileNameFromClasspath) throws IOException {
133         final URL fileUrl = SslContextProviderTest.class.getClassLoader().getResource(fileNameFromClasspath);
134         if (fileUrl == null) {
135             throw new FileNotFoundException("Resource was not found: " + fileNameFromClasspath);
136         }
137         return new File(URLDecoder.decode(fileUrl.getFile(), StandardCharsets.UTF_8));
138     }
139 }
</pre>
</div>
<div style="flex-grow: 1;">
<h3>
<center>
<span>GroupByAggregateTest.java</span>
<span> - </span>
<span></span>
</center>
</h3>
<hr/>
<pre>
1 <font color="#53858b"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>package io.crate.integrationtests;
2 import io.crate.data.ArrayBucket;
3 import io.crate.data.Paging;
4 import io.crate.testing.SQLResponse;
5 import io.crate.testing.TestingHelpers;
6 import io.crate.testing.UseJdbc;
7 import org.elasticsearch.test.ESIntegTestCase;
8 import org.hamcrest.Matchers;
9 import org.hamcrest.core.Is;
10 import org.junit.Before;
11 import org.junit.Test;
12 import org.junit.jupiter.api.Assertions;
13 import java.util.Arrays;
14 import static com.carrotsearch.randomizedtesting.RandomizedTest.randomAsciiLettersOfLength;
15 import static io.crate.testing.TestingHelpers.printedTable;
16 import static org.hamcrest.CoreMatchers.is;
17 import static org.hamcrest.Matchers.closeTo;
18 import static org.hamcrest.Matchers.isIn;
19 import</b></font> static org.hamcrest.Matchers.not;
20 @ESIntegTestCase.ClusterScope(numDataNodes = 2, numClientNodes = 0, supportsDedicatedMasters = false)
21 public class GroupByAggregateTest extends SQLIntegrationTestCase {
22     private Setup setup = new Setup(sqlExecutor);
23     @Before
24     public void initTestData() {
25         setup.setUpEmployees();
26     }
27     @Test
28     public void selectGroupByAggregateMinInteger() throws Exception {
29 <a name="5"></a>        this.setup.groupBySetup("integer");
30         execute("select min(age) as minage, gender from characters group by gender order by gender");
31         assertArrayEquals(new String[]{"minage", "gender"}, <font color="#151b8d"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>response.cols());
32         assertEquals(2L, response.rowCount());
33         assertEquals("female", response.rows()[0][1]);
34         assertEquals(32, response.rows()[0][0]);
35         assertEquals("male", response.rows()[1][1]);
36         assertEquals(34, response.rows()[1][0]);
37     }
38     @Test
39     public void testSelectDistinctWithPaging() throws Exception {</b></font>
40         Paging.PAGE_SIZE = 2;
41         execute("create table t (name string) with (number_of_replicas = 0)");
42         ensureYellow();
43         execute("insert into t (name) values ('Marvin'), ('Trillian'), ('Ford'), ('Arthur')");
44         execute("refresh table t");
45         execute("select distinct name from t");
46     }
47 <a name="7"></a>    @Test
48     public void testNonDistributedGroupByWithManyKeysNoOrderByAndLimit() throws Exception {
49         execute("create table t (name string, x int) clustered by (name) with (number_of_replicas = 0)");
50         <font color="#38a4a5"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>ensureYellow();
51         execute("insert into t (name, x) values ('Marvin', 1), ('Trillian', 1), ('Ford', 1), ('Arthur', 1)");
52         execute("refresh table t");
53         execute("select count(*), name from t group by name, x limit 2");
54         assertThat(response.rowCount(), is(2L));
55     }
56     @Test
57     public void testGroupByOnClusteredByColumnPartOfPrimaryKey() {</b></font>
58         execute("CREATE TABLE tickets ( " +
59                 " pk1 long, " +
60                 " pk2 integer, " +
61                 " pk3 timestamp with time zone," +
62                 " value string," +
63                 " primary key(pk1, pk2, pk3)) " +
64                 "CLUSTERED BY (pk2) INTO 3 SHARDS " +
65                 "PARTITIONED BY (pk3) " +
66                 "WITH (column_policy = 'strict', number_of_replicas=0)");
67         ensureYellow();
68         execute("insert into tickets (pk1, pk2, pk3, value) values (?, ?, ?, ?)",
69             new Object[][]{
70                 {1L, 42, 1425168000000L, "foo"},
71                 {2L, 43, 0L, "bar"},
72                 {3L, 44, 1425168000000L, "baz"},
73                 {4L, 45, 499651200000L, null},
74 <a name="1"></a>                {5L, 42, 0L, "foo"}
75             });
76         ensureYellow();
77         <font color="#f63526"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>refresh();
78         execute("select pk2, count(pk2) from tickets group by pk2 order by pk2 limit 100");
79         assertThat(printedTable(response.rows()), is(
80             "42| 2\n" +             "43| 1\n" +
81             "44| 1\n" +
82             "45| 1\n"));
83         execute("create table tickets_export (c2 int, c long) with (number_of_replicas = 0)");
84         ensureYellow();
85         execute("insert into tickets_export (c2, c) (select pk2, count(pk2) from tickets group by pk2)");
86         execute("refresh table tickets_export");
87         execute("select c2, c from tickets_export order by 1");
88         assertThat(printedTable(response.rows()), is(
89             "42| 2\n" +             "43| 1\n" +
90             "44| 1\n" +
91             "45| 1\n"));
92     }
93     @Test
94     public void selectGroupByAggregateMinFloat() throws Exception {</b></font>
95         this.setup.groupBySetup("float");
96         execute("select min(age), gender from characters group by gender order by gender");
97         String expected = "32.0| female\n34.0| male\n";
98         assertEquals("min(age)", response.cols()[0]);
99         assertEquals(expected, printedTable(response.rows()));
100     }
101     @Test
102     public void selectGroupByAggregateMinDouble() throws Exception {
103         this.setup.groupBySetup("double");
104         execute("select min(age) as minAge, gender from characters group by gender order by gender");
105         assertEquals(2L, response.rowCount());
106         assertEquals(32.0d, response.rows()[0][0]);
107         assertEquals(34.0d, response.rows()[1][0]);
108     }
109     @Test
110     public void testCountDistinctGlobal() throws Exception {
111         execute("select count(distinct department), count(*) from employees");
112         assertEquals(1L, response.rowCount());
113         assertEquals(4L, response.rows()[0][0]);
114         assertEquals(6L, response.rows()[0][1]);
115     }
116     @Test
117     public void testCountDistinctGroupBy() throws Exception {
118 <a name="0"></a>        this.setup.groupBySetup("integer");
119         execute("select count(distinct gender), count(*), race from characters group by race order by count(*) desc");
120         assertEquals(3L, <font color="#0000ff"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>response.rowCount());
121         assertEquals(2L, response.rows()[0][0]);
122         assertEquals(4L, response.rows()[0][1]);
123         assertEquals("Human", response.rows()[0][2]);
124         assertEquals(1L, response.rows()[1][0]);
125         assertEquals(2L, response.rows()[1][1]);
126         assertEquals("Vogon", response.rows()[1][2]);
127         assertEquals(1L, response.rows()[2][0]);
128         assertEquals(1L, response.rows()[2][1]);
129         assertEquals("Android", response.rows()[2][2]);
130     }
131     @Test
132     public void testCountDistinctGroupByOrderByCountDistinct() throws Exception {</b></font>
133         this.setup.groupBySetup("integer");
134         execute("select count(distinct gender), count(*), race from characters group by race order by count(distinct gender) desc");
135         assertEquals(3L, response.rowCount());
136         assertEquals(2L, response.rows()[0][0]);
137     }
138 <a name="4"></a>
139     @Test
140     public void testCountDistinctManySame() throws Exception {
141         <font color="#6cc417"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>this.setup.groupBySetup("integer");
142         execute("select race, count(distinct gender), count(*), count(distinct gender) " +
143                 "from characters group by race order by count(distinct gender) desc, " +
144                 "count(*) desc");
145         assertEquals(3L, response.rowCount());
146         assertEquals("Human", response.rows()[0][0]);
147         assertEquals(2L, response.rows()[0][1]);
148         assertEquals(4L, response.rows()[0][2]);
149         assertEquals(2L, response.rows()[0][3]);
150 <a name="6"></a>        assertEquals("Vogon", response.rows()[1][0]);
151         assertEquals(1L, response.rows()[1][1]);
152         assertEquals(2L, response.rows</b></font>()[1][2]);
153         <font color="#8c8774"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(1L, response.rows()[1][3]);
154         assertEquals("Android", response.rows()[2][0]);
155         assertEquals(1L, response.rows()[2][1]);
156         assertEquals(1L, response.rows()[2][2]);
157         assertEquals(1L, response.rows()[2][3]);
158     }
159 <a name="9"></a>
160     @Test
161     public void testCountDistinctManyDifferent() throws Exception {</b></font>
162         <font color="#83a33a"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>this.setup.groupBySetup("integer");
163         execute("select race, count(distinct gender), count(distinct age) " +
164                 "from characters group by race order by count(distinct gender) desc, race desc");
165         assertEquals(3L, response.rowCount());
166         assertEquals("Human", response.rows()[0][0]);
167         assertEquals(2L, response.rows()[0][1]);
168         assertEquals</b></font>(4L, response.rows()[0][2]);
169         assertEquals("Vogon", response.rows()[1][0]);
170         assertEquals(1L, response.rows()[1][1]);
171         assertEquals(0L, response.rows()[1][2]);
172         assertEquals("Android", response.rows()[2][0]);
173         assertEquals(1L, response.rows()[2][1]);
174         assertEquals(0L, response.rows()[2][2]);
175     }
176     @Test
177     public void selectGroupByAggregateMinOrderByMin() throws Exception {
178         this.setup.groupBySetup("double");
179         execute("select min(age) as minAge, gender from characters group by gender order by minAge desc");
180         assertEquals(2L, response.rowCount());
181         assertEquals("male", response.rows()[0][1]);
182         assertEquals(34.0d, response.rows()[0][0]);
183         assertEquals("female", response.rows()[1][1]);
184         assertEquals(32.0d, response.rows()[1][0]);
185         execute("select min(age), gender from characters group by gender order by min(age) asc");
186         assertEquals(2L, response.rowCount());
187         assertEquals("female", response.rows()[0][1]);
188         assertEquals(32.0d, response.rows()[0][0]);
189         assertEquals("male", response.rows()[1][1]);
190         assertEquals(34.0d, response.rows()[1][0]);
191     }
192     @Test
193     public void selectGroupByAggregateMinLong() throws Exception {
194         this.setup.groupBySetup("long");
195         execute("select min(age) as minAge, gender from characters group by gender order by gender");
196         assertEquals(2L, response.rowCount());
197         assertEquals(32L, response.rows()[0][0]);
198         assertEquals(34L, response.rows()[1][0]);
199     }
200     @Test
201     public void selectGroupByAggregateMinString() throws Exception {
202         this.setup.groupBySetup();
203         execute("select min(name) as minName, gender from characters group by gender order by gender");
204         assertEquals(2L, response.rowCount());
205         assertEquals("Anjie", response.rows()[0][0]);
206         assertEquals("Arthur Dent", response.rows()[1][0]);
207     }
208     @Test
209     public void selectGroupByAggregateMinDate() throws Exception {
210         this.setup.groupBySetup();
211         execute("select min(birthdate) as minBirthdate, gender from characters group by gender " +
212                 "order by gender");
213         assertEquals(2L, response.rowCount());
214         assertEquals("female", response.rows()[0][1]);
215         assertEquals(0L, response.rows()[0][0]);
216         assertEquals("male", response.rows()[1][1]);
217         assertEquals(181353600000L, response.rows()[1][0]);
218     }
219     @Test
220     public void selectGroupByAggregateMaxString() throws Exception {
221         this.setup.groupBySetup();
222         execute("select max(name), gender from characters group by gender order by gender");
223         assertEquals(2L, response.rowCount());
224         assertEquals("Trillian", response.rows()[0][0]);
225         assertEquals("Marving", response.rows()[1][0]);
226     }
227     @Test
228     public void selectGroupByMixedCaseAggregateMaxString() throws Exception {
229         this.setup.groupBySetup();
230         execute("select max(NAME), GENDER from characters group by gender order by gender");
231         assertEquals(2L, response.rowCount());
232         assertEquals("Trillian", response.rows()[0][0]);
233         assertEquals("Marving", response.rows()[1][0]);
234     }
235     @Test
236     public void selectGroupByAggregateMaxLong() throws Exception {
237         this.setup.groupBySetup("long");
238         execute("select max(age), gender from characters group by gender order by gender");
239         assertEquals(2L, response.rowCount());
240         assertEquals(43L, response.rows()[0][0]);
241         assertEquals(112L, response.rows()[1][0]);
242     }
243     @Test
244     public void selectGroupByAggregateMaxDate() throws Exception {
245         execute("select max(hired), department from employees group by department " +
246                 "order by department asc");
247         assertEquals(4L, response.rowCount());
248         assertEquals("HR", response.rows()[0][1]);
249         assertEquals(631152000000L, response.rows()[0][0]);
250         assertEquals("engineering", response.rows()[1][1]);
251         assertEquals(946684800000L, response.rows()[1][0]);
252         assertEquals("internship", response.rows()[2][1]);
253         assertEquals(null, response.rows()[2][0]);
254         assertEquals("management", response.rows()[3][1]);
255         assertEquals(1286668800000L, response.rows()[3][0]);
256     }
257     @Test
258     public void selectGroupByAggregateMaxInteger() throws Exception {
259         this.setup.groupBySetup("integer");
260         execute("select max(age), gender from characters group by gender order by gender");
261         assertArrayEquals(new String[]{"max(age)", "gender"}, response.cols());
262         assertEquals(2L, response.rowCount());
263         assertEquals("female", response.rows()[0][1]);
264         assertEquals(43, response.rows()[0][0]);
265         assertEquals("male", response.rows()[1][1]);
266         assertEquals(112, response.rows()[1][0]);
267     }
268     @Test
269     public void selectGroupByAggregateMaxFloat() throws Exception {
270         this.setup.groupBySetup("float");
271         execute("select max(age), gender from characters group by gender order by gender");
272         assertEquals(2L, response.rowCount());
273         assertEquals("max(age)", response.cols()[0]);
274         assertEquals(43.0f, response.rows()[0][0]);
275         assertEquals(112.0f, response.rows()[1][0]);
276     }
277     @Test
278     public void selectGroupByAggregateMaxDouble() throws Exception {
279         execute("select max(income), department from employees group by department order by department");
280         assertEquals(4L, response.rowCount());
281         assertEquals(999999999.99d, response.rows()[0][0]);
282         assertEquals("HR", response.rows()[0][1]);
283         assertEquals(6000.0d, response.rows()[1][0]);
284         assertEquals("engineering", response.rows()[1][1]);
285         assertEquals(null, response.rows()[2][0]);
286         assertEquals("internship", response.rows()[2][1]);
287         assertEquals(Double.MAX_VALUE, response.rows()[3][0]);
288         assertEquals("management", response.rows()[3][1]);
289     }
290     @Test
291     public void selectGroupByAggregateMaxOrderByMax() throws Exception {
292         this.setup.groupBySetup("double");
293         execute("select max(age) as maxage, gender from characters group by gender order by maxage desc");
294         assertEquals(2L, response.rowCount());
295         assertEquals("male", response.rows()[0][1]);
296         assertEquals(112.0d, response.rows()[0][0]);
297         assertEquals("female", response.rows()[1][1]);
298         assertEquals(43.0d, response.rows()[1][0]);
299         execute("select max(age), gender from characters group by gender order by max(age) asc");
300         assertEquals(2L, response.rowCount());
301         assertEquals("female", response.rows()[0][1]);
302         assertEquals(43.0d, response.rows()[0][0]);
303         assertEquals("male", response.rows()[1][1]);
304         assertEquals(112.0d, response.rows()[1][0]);
305     }
306     @Test
307     public void testGroupByAggSumDouble() throws Exception {
308         execute("select sum(income), department from employees group by department order by sum(income) asc");
309         assertEquals(4, response.rowCount());
310         assertEquals("engineering", response.rows()[0][1]);
311         assertEquals(10000.0, response.rows()[0][0]);
312         assertEquals("HR", response.rows()[1][1]);
313         assertEquals(1000000000.49, response.rows()[1][0]);
314         assertEquals("management", response.rows()[2][1]);
315         assertEquals(Double.MAX_VALUE, response.rows()[2][0]);
316         assertEquals("internship", response.rows()[3][1]);
317         assertNull(response.rows()[3][0]);
318     }
319     @Test
320     public void testGroupByAggSumShort() throws Exception {
321         execute("select sum(age), department from employees group by department order by department asc");
322         assertEquals(4, response.rowCount());
323         assertEquals("HR", response.rows()[0][1]);
324         assertEquals(12L, response.rows()[0][0]);
325         assertEquals("engineering", response.rows()[1][1]);
326         assertEquals(101L, response.rows()[1][0]);
327         assertEquals("internship", response.rows()[2][1]);
328         assertEquals(28L, response.rows()[2][0]);
329         assertEquals("management", response.rows()[3][1]);
330         assertEquals(45L, response.rows()[3][0]);
331     }
332     @Test
333     public void testGroupByAvgDouble() throws Exception {
334         execute("select avg(income), mean(income), department from employees group by department order by department asc");
335         assertEquals(4, response.rowCount());
336         assertEquals(500000000.245d, response.rows()[0][0]);
337         assertEquals(500000000.245d, response.rows()[0][1]);
338         assertEquals("HR", response.rows()[0][2]);
339         assertEquals(5000.0d, response.rows()[1][0]);
340         assertEquals(5000.0d, response.rows()[1][1]);
341         assertEquals("engineering", response.rows()[1][2]);
342         assertEquals(null, response.rows()[2][0]);
343         assertEquals(null, response.rows()[2][1]);
344         assertEquals("internship", response.rows()[2][2]);
345         assertEquals(Double.MAX_VALUE, response.rows()[3][0]);
346         assertEquals(Double.MAX_VALUE, response.rows()[3][1]);
347         assertEquals("management", response.rows()[3][2]);
348     }
349     @Test
350     public void testGroupByAvgMany() throws Exception {
351         execute("select avg(income), avg(age), department from employees group by department order by department asc");
352         assertEquals(4, response.rowCount());
353         assertEquals("HR", response.rows()[0][2]);
354         assertEquals(500000000.245d, response.rows()[0][0]);
355         assertEquals(12.0d, response.rows()[0][1]);
356         assertEquals("engineering", response.rows()[1][2]);
357         assertEquals(5000.0d, response.rows()[1][0]);
358         assertEquals(50.5d, response.rows()[1][1]);
359         assertEquals("internship", response.rows()[2][2]);
360         assertEquals(null, response.rows()[2][0]);
361         assertEquals(28.0d, response.rows()[2][1]);
362         assertEquals("management", response.rows()[3][2]);
363         assertEquals(Double.MAX_VALUE, response.rows()[3][0]);
364         assertEquals(45.0d, response.rows()[3][1]);
365     }
366     @Test
367     public void testGroupByArbitrary() throws Exception {
368         this.setup.groupBySetup();
369         execute("select arbitrary(name), race from characters group by race order by race asc");
370         SQLResponse arbitrary_response = response;
371         assertEquals(3, arbitrary_response.rowCount());
372         assertEquals("Android", arbitrary_response.rows()[0][1]);
373         assertEquals(1,
374             execute("select name from characters where race=? AND name=? ",
375                 new Object[]{"Android", arbitrary_response.rows()[0][0]})
376                 .rowCount()
377         );
378         assertEquals("Human", arbitrary_response.rows()[1][1]);
379         assertEquals(1,
380             execute("select name from characters where race=? AND name=? ",
381                 new Object[]{"Human", arbitrary_response.rows()[1][0]})
382                 .rowCount()
383         );
384         assertEquals("Vogon", arbitrary_response.rows()[2][1]);
385         assertEquals(1,
386             execute("select name from characters where race=? AND name=? ",
387                 new Object[]{"Vogon", arbitrary_response.rows()[2][0]})
388                 .rowCount()
389         );
390     }
391     @Test
392     public void testGlobalAggregateArbitrary() throws Exception {
393         this.setup.groupBySetup();
394         execute("select arbitrary(age) from characters where age is not null");
395         assertEquals(1, response.rowCount());
396         assertEquals(1,
397             execute("select count(*) from characters where age=?",
398                 new Object[]{response.rows()[0][0]})
399                 .rowCount()
400         );
401     }
402     @Test
403     public void testAggregateArbitraryOnBoolean() throws Exception {
404         execute("select arbitrary(good) from employees");
405         assertEquals(1, response.rowCount());
406         assertThat(response.rows()[0][0], isIn(new Object[]{true, false, null}));
407         execute("select arbitrary(good) from employees where name='dilbert'");
408         assertEquals(1, response.rowCount());
409         assertEquals(true, response.rows()[0][0]);
410         execute("select arbitrary(good), department from employees group by department order by department asc");
411         assertEquals(4, response.rowCount());
412         assertEquals("HR", response.rows()[0][1]);
413         assertThat(response.rows()[0][0], isIn(new Object[]{false, null}));
414         assertEquals("engineering", response.rows()[1][1]);
415         assertEquals(true, response.rows()[1][0]);  
416         assertEquals("internship", response.rows()[2][1]);
417         assertNull(response.rows()[2][0]);
418         assertEquals("management", response.rows()[3][1]);
419         assertEquals(false, response.rows()[3][0]);
420     }
421     public void testGroupByCountOnColumn() throws Exception {
422         execute("select department, count(income), count(*) " +
423                 "from employees group by department order by department asc");
424         assertEquals(4, response.rowCount());
425         assertEquals("HR", response.rows()[0][0]);
426         assertEquals(2L, response.rows()[0][1]);
427         assertEquals(2L, response.rows()[0][2]);
428         assertEquals("engineering", response.rows()[1][0]);
429         assertEquals(2L, response.rows()[1][1]);
430         assertEquals(2L, response.rows()[1][2]);
431         assertEquals("internship", response.rows()[2][0]);
432         assertEquals(0L, response.rows()[2][1]);
433         assertEquals(1L, response.rows()[2][2]);
434         assertEquals("management", response.rows()[3][0]);
435         assertEquals(1L, response.rows()[3][1]);
436         assertEquals(1L, response.rows()[3][2]);
437     }
438     @Test
439     public void testCompareCountOnObjectHavingNotNullSubcolumnAndCountDirectlyOnNotNullSubcolumn() {
440         execute("""
441                    create table tbl (
442                         device int not null,
443                         payload object as (
444                             col int,
445                             nested_payload object as (
446                                 col int not null)
447                         ),
448                         nullable_payload object as (
449                             col int
450                         )
451                    )
452                    """);
453         execute("insert into tbl values(1, {col=11, nested_payload={col=111}}, {col=null})");
454         execute("insert into tbl values(1, {col=null, nested_payload={col=111}}, {col=11})");
455         execute("insert into tbl values(1, {col=11, nested_payload={col=111}}, null)");
456         execute("refresh table tbl");
457         execute("select device, count(payload) from tbl group by 1");
458         assertThat(printedTable(response.rows()), is("1| 3\n"));
459         execute("select device, count(payload['nested_payload']) from tbl group by 1");
460         assertThat(printedTable(response.rows()), is("1| 3\n"));
461         execute("select device, count(payload['nested_payload']['col']) from tbl group by 1");
462         assertThat(printedTable(response.rows()), is("1| 3\n"));
463         execute("select device, count(nullable_payload) from tbl group by 1");
464         assertThat(printedTable(response.rows()), is("1| 2\n"));
465         execute("select device, count(payload['col']) from tbl group by 1");
466         assertThat(printedTable(response.rows()), is("1| 2\n"));
467     }
468     @Test
469     public void testGlobalCountOnColumn() throws Exception {
470 <a name="2"></a>        execute("select count(*), count(good), count(distinct good) from employees");
471         assertEquals(1, response.rowCount());
472         assertEquals(6L, response.rows()[0][0]);
473         <font color="#980517"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>assertEquals(4L, response.rows()[0][1]);
474         assertEquals(2L, response.rows()[0][2]);
475     }
476     @Test
477     public void testGlobalCountDistinct() throws Exception {
478         execute("select count(distinct good) from employees");
479         assertEquals(1, response.rowCount());
480         assertEquals(2L, response.rows()[0][0]);
481     }
482     @Test
483     public void testGlobalCountDistinctColumnReuse() throws Exception {</b></font>
484         execute("select count(distinct good), count(distinct department), count(distinct good) from employees");
485         assertEquals(1, response.rowCount());
486         assertEquals(2L, response.rows()[0][0]);
487         assertEquals(4L, response.rows()[0][1]);
488         assertEquals(2L, response.rows()[0][2]);
489     }
490     @Test
491     public void testGlobalAggregateOnNestedColumn() throws Exception {
492         this.setup.groupBySetup();
493         waitNoPendingTasksOnAll();
494         execute("select count(details['job']), min(details['job']), max(details['job']), count(distinct details['job']) from characters");
495         assertEquals(1, response.rowCount());
496         assertEquals(2L, response.rows()[0][0]);
497         assertEquals("Mathematician", response.rows()[0][1]);
498         assertEquals("Sandwitch Maker", response.rows()[0][2]);
499         assertEquals(2L, response.rows()[0][3]);
500     }
501     @Test
502     public void testGroupByAggregateOnNestedColumn() throws Exception {
503         this.setup.groupBySetup();
504         waitNoPendingTasksOnAll();
505         execute("select race, count(details['job']) from characters group by race order by race");
506         assertEquals(3, response.rowCount());
507         assertEquals("Android", response.rows()[0][0]);
508         assertEquals(0L, response.rows()[0][1]);
509         assertEquals("Human", response.rows()[1][0]);
510         assertEquals(2L, response.rows()[1][1]);
511         assertEquals("Vogon", response.rows()[2][0]);
512         assertEquals(0L, response.rows()[2][1]);
513     }
514     @Test
515     public void testGroupByAggregateOnNestedColumnOrderBy() throws Exception {
516         this.setup.groupBySetup();
517         waitNoPendingTasksOnAll();
518         execute("select race, count(details['job']) from characters group by race order by count(details['job']) desc limit 1");
519         assertEquals(1, response.rowCount());
520         assertArrayEquals(new String[]{"race", "count(details['job'])"}, response.cols());
521         assertEquals("Human", response.rows()[0][0]);
522         assertEquals(2L, response.rows()[0][1]);
523     }
524     @Test
525     public void testGroupByAggregateOnNestedColumnOrderByAlias() throws Exception {
526         this.setup.groupBySetup();
527         waitNoPendingTasksOnAll();
528         execute("select race, count(details['job']) as job_count from characters group by race order by job_count desc limit 1");
529         assertEquals(1, response.rowCount());
530         assertArrayEquals(new String[]{"race", "job_count"}, response.cols());
531         assertEquals("Human", response.rows()[0][0]);
532         assertEquals(2L, response.rows()[0][1]);
533     }
534     @Test
535     public void testGroupByUnknownResultColumn() throws Exception {
536         this.setup.groupBySetup();
537         Assertions.assertThrows(Exception.class, () -&gt; execute("select details_ignored['lol'] from characters group by race"),
538                                 "'details_ignored['lol']' must appear in the GROUP BY clause");
539     }
540     @Test
541     public void test_group_by_undefined_column_casted() throws Exception {
542         this.setup.groupBySetup();
543         execute("select max(age) from characters group by details_ignored['lol']::String");
544         assertEquals(1, response.rowCount());
545         assertEquals(112, response.rows()[0][0]);
546     }
547     @Test
548     public void testGroupByUnknownWhere() throws Exception {
549         this.setup.groupBySetup();
550         execute("select max(birthdate), race from characters where details_ignored['lol']='funky' group by race");
551         assertEquals(0, response.rowCount());
552     }
553     @Test
554     public void testNonDistributedGroupByNoMatch() throws Exception {
555         execute("create table characters (" +
556                 " details_ignored object(ignored)," +
557                 " race string" +
558                 ") clustered into 1 shards");
559         ensureYellow();
560         execute("select race from characters where details_ignored['lol']='funky' group by race");
561         assertEquals(0, response.rowCount());
562     }
563     @Test
564     public void testGlobalAggregateUnknownWhere() throws Exception {
565         this.setup.groupBySetup();
566         execute("select max(birthdate) from characters where details_ignored['lol']='funky'");
567         assertEquals(1, response.rowCount());
568         assertNull(response.rows()[0][0]);
569     }
570     @Test
571     public void testAggregateNonExistingColumn() throws Exception {
572         this.setup.groupBySetup();
573         execute("select max(details_ignored['lol']), race from characters group by race order by race");
574         assertThat(printedTable(response.rows()), is("NULL| Android\n" +
575                                                      "NULL| Human\n" +
576                                                      "NULL| Vogon\n"));
577     }
578     @Test
579     public void testHavingGlobalAggregation() throws Exception {
580         this.setup.groupBySetup("integer");
581         execute("select min(birthdate), min(age) from characters having min(age) &lt; 33 and max(age) &gt; 100");
582         assertEquals(1L, response.rowCount());
583         assertEquals(2, response.rows()[0].length);
584         assertEquals(0L, response.rows()[0][0]);
585         assertEquals(32, response.rows()[0][1]);
586     }
587     @Test
588     public void testHavingGroupBy() throws Exception {
589         this.setup.groupBySetup("integer");
590         execute("select age from characters group by age having age &gt; 40 order by age");
591         assertEquals(2L, response.rowCount());
592         assertEquals(43, response.rows()[0][0]);
593     }
594     @Test
595     public void testHavingGroupByOnScalar() throws Exception {
596         this.setup.groupBySetup("integer");
597         execute("select date_trunc('week', birthdate) from characters group by 1" +
598                 " having date_trunc('week', birthdate) &gt; 0" +
599                 " order by date_trunc('week', birthdate)");
600         assertEquals(2L, response.rowCount());
601     }
602     @Test
603     public void testHavingOnSameAggregate() throws Exception {
604         this.setup.groupBySetup("integer");
605         execute("select avg(birthdate) from characters group by gender\n" +
606                 "having avg(birthdate) = 181353600000.0");
607         assertThat(response.rowCount(), is(1L));
608         assertThat(printedTable(response.rows()), is("1.813536E11\n"));
609     }
610     @Test
611     public void testHavingOnOtherAggregate() throws Exception {
612         this.setup.groupBySetup("integer");
613         execute("select avg(birthdate) from characters group by gender\n" +
614                 "having min(birthdate) &gt; '1970-01-01'");
615         assertThat(response.rowCount(), is(1L));
616         assertThat(printedTable(response.rows()), is("1.813536E11\n"));
617     }
618     @Test
619     public void testHavingGroupByWithAggSelected() throws Exception {
620         this.setup.groupBySetup("integer");
621         execute("select age, count(*) from characters group by age having age &gt; 40 order by age");
622         assertEquals(2L, response.rowCount());
623         assertEquals(43, response.rows()[0][0]);
624     }
625     @Test
626     public void testHavingGroupByNonDistributed() throws Exception {
627         execute("create table foo (id int, name string, country string) clustered by (country) with (number_of_replicas = 0)");
628         ensureYellow();
629         execute("insert into foo (id, name, country) values (?, ?, ?)", new Object[][]{
630             new Object[]{1, "Arthur", "Austria"},
631             new Object[]{2, "Trillian", "Austria"},
632             new Object[]{3, "Marvin", "Austria"},
633             new Object[]{4, "Jeltz", "German"},
634             new Object[]{5, "Ford", "German"},
635             new Object[]{6, "Slartibardfast", "Italy"},
636         });
637         refresh();
638         execute("select country from foo group by country having country = 'Austria'");
639         assertThat(response.rowCount(), is(1L));
640         assertThat((String) response.rows()[0][0], is("Austria"));
641         execute("select count(*), country from foo group by country having country = 'Austria'");
642         assertThat(response.rowCount(), is(1L));
643         assertThat((Long) response.rows()[0][0], is(3L));
644         assertThat((String) response.rows()[0][1], is("Austria"));
645         execute("select country, min(id) from foo group by country having min(id) &lt; 5 ");
646         assertThat(response.rowCount(), is(2L));
647     }
648     @Test
649     public void testGroupByHavingInsertInto() throws Exception {
650         execute("create table foo (id int, name string, country string) with (number_of_replicas = 0)");
651         execute("create table bar (country string) clustered by (country) with (number_of_replicas = 0)");
652         ensureYellow();
653         execute("insert into foo (id, name, country) values (?, ?, ?)", new Object[][]{
654             new Object[]{1, "Arthur", "Austria"},
655             new Object[]{2, "Trillian", "Austria"},
656             new Object[]{3, "Marvin", "Austria"},
657             new Object[]{4, "Jeltz", "German"},
658             new Object[]{5, "Ford", "German"},
659             new Object[]{6, "Slartibardfast", "Italy"},
660         });
661         refresh();
662         execute("insert into bar(country)(select country from foo group by country having country = 'Austria')");
663         refresh();
664         execute("select country from bar");
665         assertThat(response.rowCount(), is(1L));
666     }
667     @Test
668     public void testGroupByHavingWithAggregate() throws Exception {
669         this.setup.groupBySetup("integer");
670         execute("select gender from characters group by gender having min(age) &lt; 33");
671         assertEquals(1L, response.rowCount());
672     }
673     @Test
674     public void testGroupByOnClusteredByColumn() throws Exception {
675         execute("create table foo (id int, name string, country string) clustered by (country) with (number_of_replicas = 0)");
676         ensureYellow();
677         execute("insert into foo (id, name, country) values (?, ?, ?)", new Object[][]{
678             new Object[]{1, "Arthur", "Austria"},
679             new Object[]{2, "Trillian", "Austria"},
680             new Object[]{3, "Marvin", "Austria"},
681             new Object[]{4, "Jeltz", "Germany"},
682             new Object[]{5, "Ford", "Germany"},
683             new Object[]{6, "Slartibardfast", "Italy"},
684         });
685         refresh();
686         execute("select count(*), country from foo group by country order by count(*) desc");
687         assertThat(response.rowCount(), Is.is(3L));
688         assertThat((String) response.rows()[0][1], Is.is("Austria"));
689         assertThat((String) response.rows()[1][1], Is.is("Germany"));
690         assertThat((String) response.rows()[2][1], Is.is("Italy"));
691     }
692     @Test
693     public void testGroupByOnAllPrimaryKeys() throws Exception {
694         execute("create table foo (id int primary key, name string primary key) with (number_of_replicas = 0)");
695         ensureYellow();
696         execute("insert into foo (id, name) values (?, ?)", new Object[][]{
697             new Object[]{1, "Arthur"},
698             new Object[]{2, "Trillian"},
699             new Object[]{3, "Slartibardfast"},
700             new Object[]{4, "Marvin"},
701         });
702         refresh();
703         execute("select count(*), name from foo group by id, name order by name desc");
704         assertThat(printedTable(response.rows()), is(
705             "1| Trillian\n" +
706             "1| Slartibardfast\n" +
707             "1| Marvin\n" +
708             "1| Arthur\n"));
709     }
710     @Test
711     public void testGroupByEmpty() throws Exception {
712         execute("create table test (col1 string)");
713         ensureYellow();
714         execute("select count(*), col1 from test group by col1");
715         assertEquals(0, response.rowCount());
716     }
717     @Test
718     public void testGroupByOnSysNodes() throws Exception {
719         execute("select count(*), name from sys.nodes group by name");
720         assertThat(response.rowCount(), Is.is(2L));
721         execute("select count(*), hostname from sys.nodes group by hostname");
722         assertThat(response.rowCount(), Is.is(1L));
723     }
724     @Test
725     public void testGroupByCountStringGroupByPrimaryKey() throws Exception {
726         execute("create table rankings (" +
727                 " \"pageURL\" string primary key," +
728                 " \"pageRank\" int," +
729                 " \"avgDuration\" int" +
730                 ") with (number_of_replicas=0)");
731         ensureYellow();
732         for (int i = 0; i &lt; 100; i++) {
733             execute("insert into rankings (\"pageURL\", \"pageRank\", \"avgDuration\") values (?, ?, ?)",
734                 new Object[]{String.valueOf(i), randomIntBetween(i, i * i), randomInt(i)});
735             assertThat(response.rowCount(), is(1L));
736         }
737         execute("refresh table rankings");
738         execute("select count(*), \"pageURL\" from rankings group by \"pageURL\" order by 1 desc limit 100");
739         assertThat(response.rowCount(), is(100L));
740         assertThat(new ArrayBucket(response.rows()), TestingHelpers.hasSortedRows(0, true, null));
741     }
742     @Test
743     public void testGroupByCountString() throws Exception {
744         execute("create table rankings (" +
745                 " \"pageURL\" string," +
746                 " \"pageRank\" int," +
747                 " \"avgDuration\" int" +
748                 ") with (number_of_replicas=0)");
749         ensureYellow();
750         for (int i = 0; i &lt; 100; i++) {
751             execute("insert into rankings (\"pageURL\", \"pageRank\", \"avgDuration\") values (?, ?, ?)",
752                 new Object[]{randomAsciiLettersOfLength(10 + (i % 3)), randomIntBetween(i, i * i), randomInt(i)});
753         }
754         execute("refresh table rankings");
755         execute("select count(*), \"pageURL\" from rankings group by \"pageURL\" order by 1 desc limit 100");
756         assertThat(response.rowCount(), is(100L));
757     }
758     @Test
759     public void testAggregateTwiceOnRoutingColumn() throws Exception {
760         execute("create table twice (" +
761                 "name string, " +
762                 "url string, " +
763                 "score double" +
764                 ") clustered by (url) with (number_of_replicas=0)");
765         ensureYellow();
766         execute("insert into twice (\"name\", \"url\", \"score\") values (?, ?, ?)",
767             new Object[]{
768                 "A",
769                 "https://Ä.com",
770                 99.6d});
771         refresh();
772         execute("select avg(score), url, avg(score) from twice group by url limit 10");
773         assertThat(printedTable(response.rows()), is("99.6| https://Ä.com| 99.6\n"));
774     }
775     @Test
776     public void testGroupByWithHavingAndLimit() throws Exception {
777         execute("create table likes (" +
778                 "   event_id string," +
779                 "   item_id string" +
780                 ") clustered into 2 shards with (number_of_replicas = 0)");
781         ensureYellow();
782         execute("insert into likes (event_id, item_id) values (?, ?)", new Object[][]{
783             new Object[]{"event1", "item1"},
784             new Object[]{"event1", "item1"},
785             new Object[]{"event1", "item2"},
786             new Object[]{"event2", "item1"},
787             new Object[]{"event2", "item2"},
788         });
789         execute("refresh table likes");
790         try {
791             execute("select count(*), item_id from likes where event_id = 'event1' group by 2 having count(*) &gt; 1");
792             assertThat(response.rowCount(), is(1L));
793         } catch (Exception e) {
794             fail(e.getMessage());
795         }
796         try {
797             execute("select count(*), item_id from likes where event_id = 'event1' group by 2 having count(*) &gt; 1 limit 100");
798             assertThat(response.rowCount(), is(1L));
799         } catch (Exception e) {
800             fail(e.getMessage());
801         }
802         try {
803             execute("select item_id, count(*) from likes where event_id = 'event1' group by 1 having count(*) &gt; 1");
804             assertThat(response.rowCount(), is(1L));
805         } catch (Exception e) {
806             fail(e.getMessage());
807         }
808         try {
809             execute("select item_id, count(*) from likes where event_id = 'event1' group by 1 having count(*) &gt; 1 limit 100");
810             assertThat(response.rowCount(), is(1L));
811         } catch (Exception e) {
812             fail(e.getMessage());
813         }
814     }
815     @Test
816     public void testNonDistributedGroupByWithHavingAndLimit() throws Exception {
817         execute("create table likes (" +
818                 "   event_id string," +
819                 "   item_id string" +
820                 ") clustered into 1 shards with (number_of_replicas = 0)");
821         ensureYellow();
822         execute("insert into likes (event_id, item_id) values (?, ?)", new Object[][]{
823             new Object[]{"event1", "item1"},
824             new Object[]{"event1", "item1"},
825             new Object[]{"event1", "item2"},
826             new Object[]{"event2", "item1"},
827             new Object[]{"event2", "item2"},
828         });
829         execute("refresh table likes");
830         try {
831             execute("select count(*), item_id from likes where event_id = 'event1' group by 2 having count(*) &gt; 1");
832             assertThat(response.rowCount(), is(1L));
833         } catch (Exception e) {
834             fail(e.getMessage());
835         }
836         try {
837             execute("select count(*), item_id from likes where event_id = 'event1' group by 2 having count(*) &gt; 1 limit 100");
838             assertThat(response.rowCount(), is(1L));
839         } catch (Exception e) {
840             fail(e.getMessage());
841         }
842         try {
843             execute("select item_id, count(*) from likes where event_id = 'event1' group by 1 having count(*) &gt; 1");
844             assertThat(response.rowCount(), is(1L));
845         } catch (Exception e) {
846             fail(e.getMessage());
847         }
848         try {
849             execute("select item_id, count(*) from likes where event_id = 'event1' group by 1 having count(*) &gt; 1 limit 100");
850             assertThat(response.rowCount(), is(1L));
851         } catch (Exception e) {
852             fail(e.getMessage());
853         }
854         try {
855             execute("select count(*), item_id from likes group by item_id having min(event_id) = 'event1'");
856             assertThat(response.rowCount(), is(2L));
857         } catch (Exception e) {
858             fail(e.getMessage());
859         }
860     }
861     @Test
862     public void groupByAggregateStdDevByte() throws Exception {
863         this.setup.groupBySetup("byte");
864         execute("select stddev(age), gender from characters group by gender order by gender");
865         assertEquals(2L, response.rowCount());
866         assertEquals(5.5d, response.rows()[0][0]);
867         assertEquals(39.0d, response.rows()[1][0]);
868     }
869     @Test
870     public void groupByAggregateVarianceByte() throws Exception {
871         this.setup.groupBySetup("byte");
872         execute("select variance(age), gender from characters group by gender order by gender");
873         assertEquals(2L, response.rowCount());
874         assertEquals(30.25d, response.rows()[0][0]);
875         assertEquals(1521.0d, response.rows()[1][0]);
876     }
877     @Test
878     public void groupByAggregateStdDevDouble() throws Exception {
879         this.setup.groupBySetup("double");
880         execute("select stddev(age), gender from characters group by gender order by gender");
881         assertEquals(2L, response.rowCount());
882         assertEquals(5.5d, response.rows()[0][0]);
883         assertEquals(39.0d, response.rows()[1][0]);
884     }
885     @Test
886     public void groupByStatsAggregatesGlobal() throws Exception {
887         this.setup.groupBySetup("short");
888         execute("select min(age), mean(age), geometric_mean(age), max(age), variance(age), stddev(age) from characters");
889         assertThat((Short) response.rows()[0][0], is((short) 32));
890         assertThat((Double) response.rows()[0][1], is(55.25d));
891         assertThat((Double) response.rows()[0][2], closeTo(47.84415001097868d, 0.0000001));
892         assertThat((Short) response.rows()[0][3], is((short) 112));
893         assertThat((Double) response.rows()[0][4], is(1090.6875d));
894         assertThat((Double) response.rows()[0][5], is(33.025558284456d));
895     }
896     @Test
897     public void testGroupByOnClusteredByColumnPartitioned() throws Exception {
898         execute("CREATE TABLE tickets ( " +
899                 "  ticket_id long, " +
900                 "  tenant_id integer, " +
901                 "  created_month string )" +
902                 "PARTITIONED BY (created_month) " +
903                 "CLUSTERED BY (tenant_id) " +
904                 "WITH (number_of_replicas=0)");
905         ensureYellow();
906         execute("insert into tickets (ticket_id, tenant_id, created_month) values (?, ?, ?)",
907             new Object[][]{
908                 {1L, 42, 1425168000000L},
909                 {2L, 43, 0},
910                 {3L, 44, 1425168000000L},
911                 {4L, 45, 499651200000L},
912                 {5L, 42, 0L},
913             });
914         ensureYellow();
915         refresh();
916         execute("select count(*), tenant_id from tickets group by 2 order by tenant_id limit 100");
917         assertThat(printedTable(response.rows()), is(
918             "2| 42\n" +             "1| 43\n" +
919             "1| 44\n" +
920             "1| 45\n"));
921     }
922     @Test
923     public void testFilterByScore() throws Exception {
924         execute("create table locations (" +
925                 " altitude int," +
926                 " name string," +
927                 " description string index using fulltext" +
928                 ") clustered into 1 shards with (number_of_replicas = 0)");         ensureYellow();
929         execute("insert into locations (altitude, name, description) values (420, 'Crate Dornbirn', 'A nice place in a nice country')");
930         execute("insert into locations (altitude, name, description) values (230, 'Crate Berlin', 'Also very nice place mostly nice in summer')");
931         execute("insert into locations (altitude, name, description) values (70, 'Crate SF', 'A nice place with lot of sunshine')");
932         execute("refresh table locations");
933         execute("select min(altitude) as altitude, name, _score from locations where match(description, 'nice') " +
934                 "and _score &gt;= 1.08 group by name, _score order by name");
935         assertEquals(2L, response.rowCount());
936     }
937     @Test
938     public void testDistinctWithGroupBy() throws Exception {
939         execute("select DISTINCT max(col1), min(col1) from unnest([1,1,1,2,2,2,2,3,3],[1,2,3,1,2,3,4,1,2]) " +
940                 "group by col2 order by 2, 1");
941         assertThat(printedTable(response.rows()), is("2| 1\n" +
942                                                      "3| 1\n" +
943                                                      "2| 2\n"));
944     }
945     @Test
946     public void testDistinctWithGroupByLimitAndOffset() throws Exception {
947         execute("select DISTINCT max(col2), min(col2) from " +
948                 "unnest([1,1,2,2,3,3,4,4,5,5,6,6],[1,2,2,1,2,1,3,4,4,3,5,6]) " +
949                 "group by col1 order by 1 desc, 2 limit 2 offset 1");
950         assertThat(printedTable(response.rows()), is("4| 3\n" +
951                                                      "2| 1\n"));
952     }
953     @Test
954     public void testDistinctOnJoinWithGroupBy() throws Exception {
955         execute("select DISTINCT max(t1.col1), min(t2.col2) from " +
956                 "unnest([1,1,1,2,2,2,2,3,3],[1,2,3,1,2,3,4,1,2]) as t1, " +
957                 "unnest([1,1,1,2,2,2,2,3,3],[1,2,3,1,2,3,4,1,2]) as t2 " +
958                 "where t1.col1=t2.col2 " +
959                 "group by t1.col2 order by 2, 1");
960         assertThat(printedTable(response.rows()), is("2| 1\n" +
961                                                      "3| 1\n" +
962                                                      "2| 2\n"));
963     }
964     @Test
965     public void testDistinctOnSubselectWithGroupBy() throws Exception {
966         execute("select * from (" +
967                 " select distinct max(col1), min(col1) from unnest([1,1,1,2,2,2,2,3,3],[1,2,3,1,2,3,4,1,2]) " +
968                 " group by col2 order by 2, 1 limit 2" +
969                 ") t order by 1 desc limit 1");
970         assertThat(printedTable(response.rows()), is("3| 1\n"));
971     }
972     @Test
973     public void testGroupByOnScalarOnArray() throws Exception {
974         execute("select string_to_array(col1, ' ')[2], count(*) " +
975                 "from unnest([' select foo', 'insert into ', 'select 1']) " +
976                 "group by 1 order by 2 desc");
977         assertThat(printedTable(response.rows()), is("into| 1\n" +
978                                                      "1| 1\n" +
979                                                      "select| 1\n"));
980     }
981     @Test
982     public void testGroupByOnComplexLiterals() throws Exception {
983         execute("select '{coordinates=[[0.0, 0.0], [1.0, 1.0]], type=LineString}', count(*) " +
984                 "from employees group by 1");
985         assertThat(printedTable(response.rows()), is("{coordinates=[[0.0, 0.0], [1.0, 1.0]], type=LineString}| 6\n"));
986         execute("select {id1=1, id2=36}, count(*) " +
987                 "from employees group by 1");
988         assertThat(printedTable(response.rows()), is("{id1=1, id2=36}| 6\n"));
989     }
990     @Test
991     public void testGroupByOnIndexOff() throws Exception {
992         execute("create table t1 (i int index off, s string index off)");
993         execute("insert into t1 (i, s) values (?,?)",
994             new Object[][]{
995                 {1, "foo"},
996                 {2, "bar"},
997                 {1, "foo"}
998         });
999         refresh();
1000         execute("select count(*), i, s from t1 group by i, s order by 1");
1001         assertThat(printedTable(response.rows()), is("1| 2| bar\n" +
1002                                                      "2| 1| foo\n"));
1003     }
1004     @Test
1005     public void testAggregateOnIndexOff() throws Exception {
1006         execute("create table t1 (i int index off, s string index off)");
1007         execute("insert into t1 (i, s) values (?,?)",
1008             new Object[][]{
1009                 {1, "foo"},
1010                 {2, "foobar"},
1011                 {1, "foo"}
1012         });
1013         refresh();
1014         execute("select sum(i), max(s) from t1");
1015         assertThat(printedTable(response.rows()), is("4| foobar\n"));
1016     }
1017     @Test
1018     public void testGroupBySingleNumberWithNullValues() {
1019         execute("create table t (along long, aint int, ashort short) clustered into 2 shards with (number_of_replicas = 0)");
1020         execute("insert into t (along,aint,ashort) values (1,1,1), (1,1,1), (1,1,1), (2,2,2), (2,2,2), (null,null,null), " +
1021                 "(null,null,null), (null,null,null), (null,null,null)");
1022         execute("refresh table t");
1023         assertThat(
1024             printedTable(execute("select along, count(*) from t group by along order by 2 desc").rows()),
1025             is("NULL| 4\n" +
1026                "1| 3\n" +
1027                "2| 2\n")
1028         );
1029         assertThat(
1030             printedTable(execute("select aint, count(*) from t group by aint order by 2 desc").rows()),
1031             is("NULL| 4\n" +
1032                "1| 3\n" +
1033                "2| 2\n")
1034         );
1035         assertThat(
1036             printedTable(execute("select ashort, count(*) from t group by ashort order by 2 desc").rows()),
1037             is("NULL| 4\n" +
1038                "1| 3\n" +
1039                "2| 2\n")
1040         );
1041     }
1042     @Test
1043     public void testSelectAndGroupBySingleStringKeyForLowCardinalityField() {
1044         execute("create table t (name string) clustered into 1 shards");
1045         execute("insert into t (name) values ('a'), ('b'), ('a'), ('b')");
1046         execute("refresh table t");
1047         execute("select name, count(name) from t group by 1 order by 1");
1048         assertThat(printedTable(response.rows()), is(
1049             "a| 2\n" +
1050             "b| 2\n"));
1051     }
1052     @Test
1053     public void testSelectCollectSetAndGroupBy() {
1054         execute("SELECT\n" +
1055                 "col1,\n" +
1056                 "collect_set(col1)\n" +
1057                 "FROM unnest(ARRAY[1, 2, 2, 3, 4, 5, null]) col1 " +
1058                 "GROUP BY col1 " +
1059                 "ORDER BY col1 NULLS LAST");
1060         assertThat(
1061             printedTable(response.rows()),
1062             Matchers.is("1| [1]\n" +
1063                         "2| [2]\n" +
1064                         "3| [3]\n" +
1065                         "4| [4]\n" +
1066                         "5| [5]\n" +
1067                         "NULL| []\n")
1068         );
1069     }
1070     @Test
1071     public void test_optimized_topn_distinct_returns_2_unique_items() throws Throwable {
1072         execute("create table m.tbl (id int primary key)");
1073         Object[][] ids = new Object[100][];
1074         for (int i = 0; i &lt; ids.length; i++) {
1075             ids[i] = new Object[] { i };
1076         }
1077 <a name="8"></a>        execute("insert into m.tbl (id) values (?)", ids);
1078         execute("refresh table m.tbl");
1079         execute("analyze");
1080         <font color="#c58917"><div style="position:absolute;left:0"><a href="#"><img align="left" alt="other" border="0" src="back.gif"/></a></div><b>execute("explain select distinct id from m.tbl limit 2");
1081         assertThat(
1082             printedTable(response.rows()),
1083             is("TopNDistinct[2::bigint;0 | [id]]\n" +
1084                "  └ Collect[m.tbl | [id] | true]\n")
1085         );
1086         execute("select distinct id from m.tbl limit 2");
1087         assertThat(response.rowCount(), is(2L));
1088         Object firstId = response.rows</b></font>()[0][0];
1089         Object secondId = response.rows()[1][0];
1090         assertThat(firstId, not(is(secondId)));
1091     }
1092     @Test
1093     public void test_select_distinct_with_limit_and_offset_applies_limit_and_offset_on_distinct_resultset() throws Exception {
1094         execute("create table tbl (x int)");
1095         execute("insert into tbl (x) values (1), (1), (2), (3)");
1096         execute("refresh table tbl");
1097         execute("select distinct x from tbl limit 1 offset 3");
1098         assertThat(response.rowCount(), is(0L));
1099     }
1100     @Test
1101     public void test_group_by_on_subscript_on_object_of_sub_relation() {
1102         execute("create table tbl (obj object as (x int))");
1103         execute("insert into tbl (obj) values ({x=10})");
1104         execute("refresh table tbl");
1105         execute("select obj['x'] from (select obj from tbl) as t group by obj['x']");
1106         assertThat(printedTable(response.rows()), Is.is("10\n"));
1107     }
1108     @Test
1109     public void test_select_same_aggregate_multiple_times() throws Exception {
1110         execute("create table doc.tbl (name text, x int)");
1111         execute("insert into doc.tbl (name, x) values ('Apple', 1), ('Apple', 2), ('Apple', 3)");
1112         execute("refresh table doc.tbl");
1113         execute("explain select name, count(x), count(x) from doc.tbl group by name");
1114         assertThat(
1115             printedTable(response.rows()),
1116             Is.is(
1117                 "Eval[name, count(x), count(x)]\n" +
1118                 "  └ GroupHashAggregate[name | count(x)]\n"+
1119                 "    └ Collect[doc.tbl | [x, name] | true]\n"
1120             )
1121         );
1122         execute("select name, count(x), count(x) from doc.tbl group by name");
1123         assertThat(printedTable(response.rows()), Is.is("Apple| 3| 3\n"));
1124     }
1125     @Test
1126     @UseJdbc(1)
1127     public void test_group_by_on_duplicate_keys() throws Exception {
1128         execute("create table tbl (city text, name text, id text, location geo_point)");
1129         execute(
1130             "insert into tbl (id, name, location, city) values " +
1131             " ('122021430M', 'Rue Penavayre', [2.573609,44.35007], 'Rodez'), " +
1132             " ('013440476U', 'Avenue de Trévoux ', [5.201722,46.20096], 'Saint-Denis-lès-Bourg'), " +
1133             " ('021140050C', 'Rue Paul Doumer ', [3.426928,49.04915], 'Brasles') ");
1134         execute("refresh table tbl");
1135         execute("SELECT DISTINCT id, name, id, location, city FROM tbl");
1136         Arrays.sort(response.rows(), (a, b) -&gt; ((String) a[0]).compareTo((String) b[0]));
1137         assertThat(printedTable(response.rows()), is(
1138             "013440476U| Avenue de Trévoux | 013440476U| Pt(x=5.20172193646431,y=46.200959966517985)| Saint-Denis-lès-Bourg\n" +
1139             "021140050C| Rue Paul Doumer | 021140050C| Pt(x=3.426927952095866,y=49.04914998449385)| Brasles\n" +
1140             "122021430M| Rue Penavayre| 122021430M| Pt(x=2.573608970269561,y=44.35006999410689)| Rodez\n"
1141         ));
1142     }
1143 }
</pre>
</div>
</div>
<div class="modal" id="myModal" style="display:none;"><div class="modal-content"><span class="close">x</span><p></p><div class="row"><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 1</div><div class="column" style="font-weight: bold;text-decoration: underline">Fragment from File 2</div></div><div class="row"><div class="column" id="column1">Column 1</div><div class="column" id="column2">Column 2</div></div></div></div><script>var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];span.onclick=function(){modal.style.display="none"};window.onclick=function(a){a.target==modal&&(modal.style.display="none")};function openModal(a){console.log("the color is "+a);let b=getCodes(a);console.log(b);var c=document.getElementById("column1");c.innerText=b[0];var d=document.getElementById("column2");d.innerText=b[1];c.style.color=a;c.style.fontWeight="bold";d.style.fontWeight="bold";d.style.color=a;var e=document.getElementById("myModal");e.style.display="block"}function getCodes(a){for(var b=document.getElementsByTagName("font"),c=[],d=0;d<b.length;d++)b[d].attributes.color.nodeValue===a&&"-"!==b[d].innerText&&c.push(b[d].innerText);return c}</script><script>const params=window.location.search;const urlParams=new URLSearchParams(params);const searchText=urlParams.get('lines');let lines=searchText.split(',');for(let line of lines){const elements=document.getElementsByTagName('td');for(let i=0;i<elements.length;i++){if(elements[i].innerText.includes(line)){elements[i].style.background='green';break;}}}</script></body>
</html>
