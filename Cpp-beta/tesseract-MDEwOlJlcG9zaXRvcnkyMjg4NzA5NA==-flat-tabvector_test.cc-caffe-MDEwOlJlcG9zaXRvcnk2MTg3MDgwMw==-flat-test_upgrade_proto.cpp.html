
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 11.11111111111111%, Tokens: 18, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>tesseract-MDEwOlJlcG9zaXRvcnkyMjg4NzA5NA==-flat-tabvector_test.cc</h3>
            <pre><code>1  #include <memory>
2  #include "tabvector.h"
3  #include "include_gunit.h"
4  namespace tesseract {
5  class TabVectorTest : public testing::Test {
6  protected:
7    void SetUp() override {
8      std::locale::global(std::locale(""));
9      vector_.reset();
10    }
11    void TearDown() override {}
12    void MakeSimpleTabVector(int x1, int y1, int x2, int y2) {
13      vector_ = std::make_unique<TabVector>();
14      vector_->set_startpt(ICOORD(x1, y1));
15      vector_->set_endpt(ICOORD(x2, y2));
16    }
17    std::unique_ptr<TabVector> vector_;
18  };
19  TEST_F(TabVectorTest, SetStartEndPointsMatch) {
20    vector_ = std::make_unique<TabVector>();
21    ICOORD start(51, 65);
22    ICOORD end(7568, 234);
23    vector_->set_startpt(start);
24    EXPECT_EQ(start.x(), vector_->startpt().x());
25    EXPECT_EQ(start.y(), vector_->startpt().y());
26    vector_->set_endpt(end);
27    EXPECT_EQ(end.x(), vector_->endpt().x());
28    EXPECT_EQ(end.y(), vector_->endpt().y());
29  }
30  TEST_F(TabVectorTest, XAtY45DegreeSlopeInRangeExact) {
31    MakeSimpleTabVector(0, 0, 100, 100);
32    for (int y = 0; y <= 100; ++y) {
33      int x = vector_->XAtY(y);
34      EXPECT_EQ(y, x);
35    }
36  }
37  TEST_F(TabVectorTest, XAtYVerticalInRangeExact) {
38    const int x = 120; 
39    MakeSimpleTabVector(x, 0, x, 100);
40    for (int y = 0; y <= 100; ++y) {
41      int result_x = vector_->XAtY(y);
42      EXPECT_EQ(x, result_x);
43    }
44  }
45  TEST_F(TabVectorTest, XAtYHorizontal) {
46    const int y = 76; 
47    MakeSimpleTabVector(0, y, 100, y);
48    EXPECT_EQ(0, vector_->XAtY(y));
49    EXPECT_EQ(0, vector_->XAtY(10));
50  }
51  TEST_F(TabVectorTest, XAtYRoundingSimple) {
52    MakeSimpleTabVector(0, 0, 2, 10000);
53    int x = vector_->XAtY(1);
54    EXPECT_EQ(0, x);
55    x = vector_->XAtY(4999);
56    EXPECT_EQ(0, x);
57    x = vector_->XAtY(5001);
58    EXPECT_EQ(1, x);
59    x = vector_->XAtY(9999);
60    EXPECT_EQ(1, x);
61  }
62  TEST_F(TabVectorTest, XAtYLargeNumbers) {
63    MakeSimpleTabVector(7804, 504, 7968, 11768); 
<span onclick='openModal()' class='match'>64    int x = vector_->XAtY(6136);                 
65    EXPECT_EQ(7886, x);
66  }
67  TEST_F(TabVectorTest, XAtYHorizontalInRangeExact) {
68    const int y = 120; 
69    MakeSimpleTabVector(50, y, 150, y);
70    int x = vector_->XAtY(y);
71    EXPECT_EQ(50, x);
72  }
73  TEST_F(TabVectorTest, VOverlapInRangeSimple) {
74    MakeSimpleTabVector(0, 0, 100, 100);
75    int overlap = vector_->VOverlap(90, 10);
</span>76    EXPECT_EQ(80, overlap);
77    overlap = vector_->VOverlap(100, 0);
78    EXPECT_EQ(100, overlap);
79  }
80  TEST_F(TabVectorTest, VOverlapOutOfRange) {
81    MakeSimpleTabVector(0, 10, 100, 90);
82    int overlap = vector_->VOverlap(100, 0);
83    EXPECT_EQ(80, overlap);
84  }
85  TEST_F(TabVectorTest, XYFlip) {
86    MakeSimpleTabVector(1, 2, 3, 4);
87    vector_->XYFlip();
88    EXPECT_EQ(2, vector_->startpt().x());
89    EXPECT_EQ(1, vector_->startpt().y());
90    EXPECT_EQ(4, vector_->endpt().x());
91    EXPECT_EQ(3, vector_->endpt().y());
92  }
93  } 
</code></pre>
        </div>
        <div class="column">
            <h3>caffe-MDEwOlJlcG9zaXRvcnk2MTg3MDgwMw==-flat-test_upgrade_proto.cpp</h3>
            <pre><code>1  #include <string>
2  #include <vector>
3  #include "boost/scoped_ptr.hpp"
4  #include "google/protobuf/text_format.h"
5  #include "gtest/gtest.h"
6  #include "caffe/blob.hpp"
7  #include "caffe/common.hpp"
8  #include "caffe/layer.hpp"
9  #include "caffe/util/db.hpp"
10  #include "caffe/util/io.hpp"
11  #include "caffe/util/upgrade_proto.hpp"
12  #include "caffe/test/test_caffe_main.hpp"
13  namespace caffe {
14  class PaddingLayerUpgradeTest : public ::testing::Test {
15   protected:
16    void RunPaddingUpgradeTest(
17        const string& input_param_string, const string& output_param_string) {
18      NetParameter input_param;
19      CHECK(google::protobuf::TextFormat::ParseFromString(
20          input_param_string, &input_param));
21      NetParameter expected_output_param;
22      CHECK(google::protobuf::TextFormat::ParseFromString(
23          output_param_string, &expected_output_param));
24      NetParameter actual_output_param;
25      UpgradeV0PaddingLayers(input_param, &actual_output_param);
26      EXPECT_EQ(expected_output_param.DebugString(),
27          actual_output_param.DebugString());
28      NetParameter double_pad_upgrade_param;
29      UpgradeV0PaddingLayers(actual_output_param, &double_pad_upgrade_param);
30      EXPECT_EQ(actual_output_param.DebugString(),
31         double_pad_upgrade_param.DebugString());
32    }
33  };
34  TEST_F(PaddingLayerUpgradeTest, TestSimple) {
35    const string& input_proto =
36        "name: 'CaffeNet' "
37        "layers { "
38        "  layer { "
39        "    name: 'data' "
40        "    type: 'data' "
41        "    source: '/home/jiayq/Data/ILSVRC12/train-leveldb' "
42        "    meanfile: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
43        "    batchsize: 256 "
44        "    cropsize: 227 "
45        "    mirror: true "
46        "  } "
47        "  top: 'data' "
48        "  top: 'label' "
49        "} "
50        "layers { "
51        "  layer { "
52        "    name: 'pad1' "
53        "    type: 'padding' "
54        "    pad: 2 "
55        "  } "
56        "  bottom: 'data' "
57        "  top: 'pad1' "
58        "} "
59        "layers { "
60        "  layer { "
61        "    name: 'conv1' "
62        "    type: 'conv' "
63        "    num_output: 96 "
64        "    kernelsize: 11 "
65        "    stride: 4 "
66        "    weight_filler { "
67        "      type: 'gaussian' "
68        "      std: 0.01 "
69        "    } "
70        "    bias_filler { "
71        "      type: 'constant' "
72        "      value: 0. "
73        "    } "
74        "    blobs_lr: 1. "
75        "    blobs_lr: 2. "
76        "    weight_decay: 1. "
77        "    weight_decay: 0. "
78        "  } "
79        "  bottom: 'pad1' "
80        "  top: 'conv1' "
81        "} "
82        "layers { "
83        "  layer { "
84        "    name: 'fc8' "
85        "    type: 'innerproduct' "
86        "    num_output: 1000 "
87        "    weight_filler { "
88        "      type: 'gaussian' "
89        "      std: 0.01 "
90        "    } "
91        "    bias_filler { "
92        "      type: 'constant' "
93        "      value: 0 "
94        "    } "
95        "    blobs_lr: 1. "
96        "    blobs_lr: 2. "
97        "    weight_decay: 1. "
98        "    weight_decay: 0. "
99        "  } "
100        "  bottom: 'conv1' "
101        "  top: 'fc8' "
102        "} "
103        "layers { "
104        "  layer { "
105        "    name: 'loss' "
106        "    type: 'softmax_loss' "
107        "  } "
108        "  bottom: 'fc8' "
109        "  bottom: 'label' "
110        "} ";
<span onclick='openModal()' class='match'>111    const string& expected_output_proto =
112        "name: 'CaffeNet' "
113        "layers { "
114        "  layer { "
115        "    name: 'data' "
116        "    type: 'data' "
117        "    source: '/home/jiayq/Data/ILSVRC12/train-leveldb' "
118        "    meanfile: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
119        "    batchsize: 256 "
120        "    cropsize: 227 "
121        "    mirror: true "
122        "  } "
123        "  top: 'data' "
124        "  top: 'label' "
125        "} "
126        "layers { "
127        "  layer { "
128        "    name: 'conv1' "
129        "    type: 'conv' "
130        "    num_output: 96 "
131        "    kernelsize: 11 "
132        "    stride: 4 "
133        "    pad: 2 "
134        "    weight_filler { "
135        "      type: 'gaussian' "
136        "      std: 0.01 "
137        "    } "
138        "    bias_filler { "
139        "      type: 'constant' "
140        "      value: 0. "
141        "    } "
142        "    blobs_lr: 1. "
143        "    blobs_lr: 2. "
144        "    weight_decay: 1. "
145        "    weight_decay: 0. "
146        "  } "
147        "  bottom: 'data' "
148        "  top: 'conv1' "
149        "} "
150        "layers { "
151        "  layer { "
152        "    name: 'fc8' "
153        "    type: 'innerproduct' "
154        "    num_output: 1000 "
155        "    weight_filler { "
156        "      type: 'gaussian' "
157        "      std: 0.01 "
158        "    } "
159        "    bias_filler { "
160        "      type: 'constant' "
161        "      value: 0 "
162        "    } "
163        "    blobs_lr: 1. "
164        "    blobs_lr: 2. "
165        "    weight_decay: 1. "
166        "    weight_decay: 0. "
167        "  } "
168        "  bottom: 'conv1' "
169        "  top: 'fc8' "
170        "} "
171        "layers { "
172        "  layer { "
173        "    name: 'loss' "
174        "    type: 'softmax_loss' "
175        "  } "
176        "  bottom: 'fc8' "
177        "  bottom: 'label' "
178        "} ";
179    this->RunPaddingUpgradeTest(input_proto, expected_output_proto);
180  }
181  TEST_F(PaddingLayerUpgradeTest, TestTwoTops) {
182    const string& input_proto =
183        "name: 'CaffeNet' "
184        "layers { "
185        "  layer { "
186        "    name: 'data' "
187        "    type: 'data' "
188        "    source: '/home/jiayq/Data/ILSVRC12/train-leveldb' "
189        "    meanfile: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
190        "    batchsize: 256 "
191        "    cropsize: 227 "
192        "    mirror: true "
193        "  } "
194        "  top: 'data' "
195        "  top: 'label' "
196        "} "
197        "layers { "
198        "  layer { "
199        "    name: 'pad1' "
200        "    type: 'padding' "
201        "    pad: 2 "
202        "  } "
203        "  bottom: 'data' "
204        "  top: 'pad1' "
205        "} "
206        "layers { "
207        "  layer { "
208        "    name: 'conv1' "
209        "    type: 'conv' "
210        "    num_output: 96 "
211        "    kernelsize: 11 "
212        "    stride: 4 "
213        "    weight_filler { "
214        "      type: 'gaussian' "
215        "      std: 0.01 "
216        "    } "
217        "    bias_filler { "
218        "      type: 'constant' "
219        "      value: 0. "
220        "    } "
221        "    blobs_lr: 1. "
222        "    blobs_lr: 2. "
223        "    weight_decay: 1. "
224        "    weight_decay: 0. "
225        "  } "
226        "  bottom: 'pad1' "
227        "  top: 'conv1' "
228        "} "
229        "layers { "
230        "  layer { "
231        "    name: 'fc8' "
232        "    type: 'innerproduct' "
233        "    num_output: 1000 "
234        "    weight_filler { "
235        "      type: 'gaussian' "
236        "      std: 0.01 "
237        "    } "
238        "    bias_filler { "
239        "      type: 'constant' "
240        "      value: 0 "
241        "    } "
242        "    blobs_lr: 1. "
243        "    blobs_lr: 2. "
244        "    weight_decay: 1. "
245        "    weight_decay: 0. "
246        "  } "
247        "  bottom: 'conv1' "
248        "  top: 'fc8' "
249        "} "
250        "layers { "
251        "  layer { "
252        "    name: 'conv2' "
253        "    type: 'conv' "
254        "    num_output: 96 "
255        "    kernelsize: 11 "
256        "    stride: 4 "
257        "    weight_filler { "
258        "      type: 'gaussian' "
259        "      std: 0.01 "
260        "    } "
261        "    bias_filler { "
262        "      type: 'constant' "
263        "      value: 0. "
264        "    } "
265        "    blobs_lr: 1. "
266        "    blobs_lr: 2. "
267        "    weight_decay: 1. "
268        "    weight_decay: 0. "
269        "  } "
270        "  bottom: 'pad1' "
271        "  top: 'conv2' "
272        "} "
273        "layers { "
274        "  layer { "
275        "    name: 'loss' "
276        "    type: 'softmax_loss' "
277        "  } "
278        "  bottom: 'fc8' "
279        "  bottom: 'label' "
280        "} ";
281    const string& expected_output_proto =
282        "name: 'CaffeNet' "
283        "layers { "
284        "  layer { "
285        "    name: 'data' "
286        "    type: 'data' "
287        "    source: '/home/jiayq/Data/ILSVRC12/train-leveldb' "
288        "    meanfile: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
289        "    batchsize: 256 "
290        "    cropsize: 227 "
291        "    mirror: true "
292        "  } "
293        "  top: 'data' "
294        "  top: 'label' "
295        "} "
296        "layers { "
297        "  layer { "
298        "    name: 'conv1' "
299        "    type: 'conv' "
300        "    num_output: 96 "
301        "    kernelsize: 11 "
302        "    stride: 4 "
303        "    pad: 2 "
304        "    weight_filler { "
305        "      type: 'gaussian' "
306        "      std: 0.01 "
307        "    } "
308        "    bias_filler { "
309        "      type: 'constant' "
310        "      value: 0. "
311        "    } "
312        "    blobs_lr: 1. "
313        "    blobs_lr: 2. "
314        "    weight_decay: 1. "
315        "    weight_decay: 0. "
316        "  } "
317        "  bottom: 'data' "
318        "  top: 'conv1' "
319        "} "
320        "layers { "
321        "  layer { "
322        "    name: 'fc8' "
323        "    type: 'innerproduct' "
324        "    num_output: 1000 "
325        "    weight_filler { "
326        "      type: 'gaussian' "
327        "      std: 0.01 "
328        "    } "
329        "    bias_filler { "
330        "      type: 'constant' "
331        "      value: 0 "
332        "    } "
333        "    blobs_lr: 1. "
334        "    blobs_lr: 2. "
335        "    weight_decay: 1. "
336        "    weight_decay: 0. "
337        "  } "
338        "  bottom: 'conv1' "
339        "  top: 'fc8' "
340        "} "
341        "layers { "
342        "  layer { "
343        "    name: 'conv2' "
344        "    type: 'conv' "
345        "    num_output: 96 "
346        "    kernelsize: 11 "
347        "    stride: 4 "
348        "    pad: 2 "
349        "    weight_filler { "
350        "      type: 'gaussian' "
351        "      std: 0.01 "
352        "    } "
353        "    bias_filler { "
354        "      type: 'constant' "
355        "      value: 0. "
356        "    } "
357        "    blobs_lr: 1. "
358        "    blobs_lr: 2. "
359        "    weight_decay: 1. "
360        "    weight_decay: 0. "
361        "  } "
362        "  bottom: 'data' "
363        "  top: 'conv2' "
364        "} "
365        "layers { "
366        "  layer { "
367        "    name: 'loss' "
368        "    type: 'softmax_loss' "
369        "  } "
370        "  bottom: 'fc8' "
371        "  bottom: 'label' "
372        "} ";
373    this->RunPaddingUpgradeTest(input_proto, expected_output_proto);
374  }
375  TEST_F(PaddingLayerUpgradeTest, TestImageNet) {
376    const string& input_proto =
</span>377        "name: 'CaffeNet' "
378        "layers { "
379        "  layer { "
380        "    name: 'data' "
381        "    type: 'data' "
382        "    source: '/home/jiayq/Data/ILSVRC12/train-leveldb' "
383        "    meanfile: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
384        "    batchsize: 256 "
385        "    cropsize: 227 "
386        "    mirror: true "
387        "  } "
388        "  top: 'data' "
389        "  top: 'label' "
390        "} "
391        "layers { "
392        "  layer { "
393        "    name: 'conv1' "
394        "    type: 'conv' "
395        "    num_output: 96 "
396        "    kernelsize: 11 "
397        "    stride: 4 "
398        "    weight_filler { "
399        "      type: 'gaussian' "
400        "      std: 0.01 "
401        "    } "
402        "    bias_filler { "
403        "      type: 'constant' "
404        "      value: 0. "
405        "    } "
406        "    blobs_lr: 1. "
407        "    blobs_lr: 2. "
408        "    weight_decay: 1. "
409        "    weight_decay: 0. "
410        "  } "
411        "  bottom: 'data' "
412        "  top: 'conv1' "
413        "} "
414        "layers { "
415        "  layer { "
416        "    name: 'relu1' "
417        "    type: 'relu' "
418        "  } "
419        "  bottom: 'conv1' "
420        "  top: 'conv1' "
421        "} "
422        "layers { "
423        "  layer { "
424        "    name: 'pool1' "
425        "    type: 'pool' "
426        "    pool: MAX "
427        "    kernelsize: 3 "
428        "    stride: 2 "
429        "  } "
430        "  bottom: 'conv1' "
431        "  top: 'pool1' "
432        "} "
433        "layers { "
434        "  layer { "
435        "    name: 'norm1' "
436        "    type: 'lrn' "
437        "    local_size: 5 "
438        "    alpha: 0.0001 "
439        "    beta: 0.75 "
440        "  } "
441        "  bottom: 'pool1' "
442        "  top: 'norm1' "
443        "} "
444        "layers { "
445        "  layer { "
446        "    name: 'pad2' "
447        "    type: 'padding' "
448        "    pad: 2 "
449        "  } "
450        "  bottom: 'norm1' "
451        "  top: 'pad2' "
452        "} "
453        "layers { "
454        "  layer { "
455        "    name: 'conv2' "
456        "    type: 'conv' "
457        "    num_output: 256 "
458        "    group: 2 "
459        "    kernelsize: 5 "
460        "    weight_filler { "
461        "      type: 'gaussian' "
462        "      std: 0.01 "
463        "    } "
464        "    bias_filler { "
465        "      type: 'constant' "
466        "      value: 1. "
467        "    } "
468        "    blobs_lr: 1. "
469        "    blobs_lr: 2. "
470        "    weight_decay: 1. "
471        "    weight_decay: 0. "
472        "  } "
473        "  bottom: 'pad2' "
474        "  top: 'conv2' "
475        "} "
476        "layers { "
477        "  layer { "
478        "    name: 'relu2' "
479        "    type: 'relu' "
480        "  } "
481        "  bottom: 'conv2' "
482        "  top: 'conv2' "
483        "} "
484        "layers { "
485        "  layer { "
486        "    name: 'pool2' "
487        "    type: 'pool' "
488        "    pool: MAX "
489        "    kernelsize: 3 "
490        "    stride: 2 "
491        "  } "
492        "  bottom: 'conv2' "
493        "  top: 'pool2' "
494        "} "
495        "layers { "
496        "  layer { "
497        "    name: 'norm2' "
498        "    type: 'lrn' "
499        "    local_size: 5 "
500        "    alpha: 0.0001 "
501        "    beta: 0.75 "
502        "  } "
503        "  bottom: 'pool2' "
504        "  top: 'norm2' "
505        "} "
506        "layers { "
507        "  layer { "
508        "    name: 'pad3' "
509        "    type: 'padding' "
510        "    pad: 1 "
511        "  } "
512        "  bottom: 'norm2' "
513        "  top: 'pad3' "
514        "} "
515        "layers { "
516        "  layer { "
517        "    name: 'conv3' "
518        "    type: 'conv' "
519        "    num_output: 384 "
520        "    kernelsize: 3 "
521        "    weight_filler { "
522        "      type: 'gaussian' "
523        "      std: 0.01 "
524        "    } "
525        "    bias_filler { "
526        "      type: 'constant' "
527        "      value: 0. "
528        "    } "
529        "    blobs_lr: 1. "
530        "    blobs_lr: 2. "
531        "    weight_decay: 1. "
532        "    weight_decay: 0. "
533        "  } "
534        "  bottom: 'pad3' "
535        "  top: 'conv3' "
536        "} "
537        "layers { "
538        "  layer { "
539        "    name: 'relu3' "
540        "    type: 'relu' "
541        "  } "
542        "  bottom: 'conv3' "
543        "  top: 'conv3' "
544        "} "
545        "layers { "
546        "  layer { "
547        "    name: 'pad4' "
548        "    type: 'padding' "
549        "    pad: 1 "
550        "  } "
551        "  bottom: 'conv3' "
552        "  top: 'pad4' "
553        "} "
554        "layers { "
555        "  layer { "
556        "    name: 'conv4' "
557        "    type: 'conv' "
558        "    num_output: 384 "
559        "    group: 2 "
560        "    kernelsize: 3 "
561        "    weight_filler { "
562        "      type: 'gaussian' "
563        "      std: 0.01 "
564        "    } "
565        "    bias_filler { "
566        "      type: 'constant' "
567        "      value: 1. "
568        "    } "
569        "    blobs_lr: 1. "
570        "    blobs_lr: 2. "
571        "    weight_decay: 1. "
572        "    weight_decay: 0. "
573        "  } "
574        "  bottom: 'pad4' "
575        "  top: 'conv4' "
576        "} "
577        "layers { "
578        "  layer { "
579        "    name: 'relu4' "
580        "    type: 'relu' "
581        "  } "
582        "  bottom: 'conv4' "
583        "  top: 'conv4' "
584        "} "
585        "layers { "
586        "  layer { "
587        "    name: 'pad5' "
588        "    type: 'padding' "
589        "    pad: 1 "
590        "  } "
591        "  bottom: 'conv4' "
592        "  top: 'pad5' "
593        "} "
594        "layers { "
595        "  layer { "
596        "    name: 'conv5' "
597        "    type: 'conv' "
598        "    num_output: 256 "
599        "    group: 2 "
600        "    kernelsize: 3 "
601        "    weight_filler { "
602        "      type: 'gaussian' "
603        "      std: 0.01 "
604        "    } "
605        "    bias_filler { "
606        "      type: 'constant' "
607        "      value: 1. "
608        "    } "
609        "    blobs_lr: 1. "
610        "    blobs_lr: 2. "
611        "    weight_decay: 1. "
612        "    weight_decay: 0. "
613        "  } "
614        "  bottom: 'pad5' "
615        "  top: 'conv5' "
616        "} "
617        "layers { "
618        "  layer { "
619        "    name: 'relu5' "
620        "    type: 'relu' "
621        "  } "
622        "  bottom: 'conv5' "
623        "  top: 'conv5' "
624        "} "
625        "layers { "
626        "  layer { "
627        "    name: 'pool5' "
628        "    type: 'pool' "
629        "    kernelsize: 3 "
630        "    pool: MAX "
631        "    stride: 2 "
632        "  } "
633        "  bottom: 'conv5' "
634        "  top: 'pool5' "
635        "} "
636        "layers { "
637        "  layer { "
638        "    name: 'fc6' "
639        "    type: 'innerproduct' "
640        "    num_output: 4096 "
641        "    weight_filler { "
642        "      type: 'gaussian' "
643        "      std: 0.005 "
644        "    } "
645        "    bias_filler { "
646        "      type: 'constant' "
647        "      value: 1. "
648        "    } "
649        "    blobs_lr: 1. "
650        "    blobs_lr: 2. "
651        "    weight_decay: 1. "
652        "    weight_decay: 0. "
653        "  } "
654        "  bottom: 'pool5' "
655        "  top: 'fc6' "
656        "} "
657        "layers { "
658        "  layer { "
659        "    name: 'relu6' "
660        "    type: 'relu' "
661        "  } "
662        "  bottom: 'fc6' "
663        "  top: 'fc6' "
664        "} "
665        "layers { "
666        "  layer { "
667        "    name: 'drop6' "
668        "    type: 'dropout' "
669        "    dropout_ratio: 0.5 "
670        "  } "
671        "  bottom: 'fc6' "
672        "  top: 'fc6' "
673        "} "
674        "layers { "
675        "  layer { "
676        "    name: 'fc7' "
677        "    type: 'innerproduct' "
678        "    num_output: 4096 "
679        "    weight_filler { "
680        "      type: 'gaussian' "
681        "      std: 0.005 "
682        "    } "
683        "    bias_filler { "
684        "      type: 'constant' "
685        "      value: 1. "
686        "    } "
687        "    blobs_lr: 1. "
688        "    blobs_lr: 2. "
689        "    weight_decay: 1. "
690        "    weight_decay: 0. "
691        "  } "
692        "  bottom: 'fc6' "
693        "  top: 'fc7' "
694        "} "
695        "layers { "
696        "  layer { "
697        "    name: 'relu7' "
698        "    type: 'relu' "
699        "  } "
700        "  bottom: 'fc7' "
701        "  top: 'fc7' "
702        "} "
703        "layers { "
704        "  layer { "
705        "    name: 'drop7' "
706        "    type: 'dropout' "
707        "    dropout_ratio: 0.5 "
708        "  } "
709        "  bottom: 'fc7' "
710        "  top: 'fc7' "
711        "} "
712        "layers { "
713        "  layer { "
714        "    name: 'fc8' "
715        "    type: 'innerproduct' "
716        "    num_output: 1000 "
717        "    weight_filler { "
718        "      type: 'gaussian' "
719        "      std: 0.01 "
720        "    } "
721        "    bias_filler { "
722        "      type: 'constant' "
723        "      value: 0 "
724        "    } "
725        "    blobs_lr: 1. "
726        "    blobs_lr: 2. "
727        "    weight_decay: 1. "
728        "    weight_decay: 0. "
729        "  } "
730        "  bottom: 'fc7' "
731        "  top: 'fc8' "
732        "} "
733        "layers { "
734        "  layer { "
735        "    name: 'loss' "
736        "    type: 'softmax_loss' "
737        "  } "
738        "  bottom: 'fc8' "
739        "  bottom: 'label' "
740        "} ";
741    const string& expected_output_proto =
742        "name: 'CaffeNet' "
743        "layers { "
744        "  layer { "
745        "    name: 'data' "
746        "    type: 'data' "
747        "    source: '/home/jiayq/Data/ILSVRC12/train-leveldb' "
748        "    meanfile: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
749        "    batchsize: 256 "
750        "    cropsize: 227 "
751        "    mirror: true "
752        "  } "
753        "  top: 'data' "
754        "  top: 'label' "
755        "} "
756        "layers { "
757        "  layer { "
758        "    name: 'conv1' "
759        "    type: 'conv' "
760        "    num_output: 96 "
761        "    kernelsize: 11 "
762        "    stride: 4 "
763        "    weight_filler { "
764        "      type: 'gaussian' "
765        "      std: 0.01 "
766        "    } "
767        "    bias_filler { "
768        "      type: 'constant' "
769        "      value: 0. "
770        "    } "
771        "    blobs_lr: 1. "
772        "    blobs_lr: 2. "
773        "    weight_decay: 1. "
774        "    weight_decay: 0. "
775        "  } "
776        "  bottom: 'data' "
777        "  top: 'conv1' "
778        "} "
779        "layers { "
780        "  layer { "
781        "    name: 'relu1' "
782        "    type: 'relu' "
783        "  } "
784        "  bottom: 'conv1' "
785        "  top: 'conv1' "
786        "} "
787        "layers { "
788        "  layer { "
789        "    name: 'pool1' "
790        "    type: 'pool' "
791        "    pool: MAX "
792        "    kernelsize: 3 "
793        "    stride: 2 "
794        "  } "
795        "  bottom: 'conv1' "
796        "  top: 'pool1' "
797        "} "
798        "layers { "
799        "  layer { "
800        "    name: 'norm1' "
801        "    type: 'lrn' "
802        "    local_size: 5 "
803        "    alpha: 0.0001 "
804        "    beta: 0.75 "
805        "  } "
806        "  bottom: 'pool1' "
807        "  top: 'norm1' "
808        "} "
809        "layers { "
810        "  layer { "
811        "    name: 'conv2' "
812        "    type: 'conv' "
813        "    num_output: 256 "
814        "    group: 2 "
815        "    kernelsize: 5 "
816        "    pad: 2 "
817        "    weight_filler { "
818        "      type: 'gaussian' "
819        "      std: 0.01 "
820        "    } "
821        "    bias_filler { "
822        "      type: 'constant' "
823        "      value: 1. "
824        "    } "
825        "    blobs_lr: 1. "
826        "    blobs_lr: 2. "
827        "    weight_decay: 1. "
828        "    weight_decay: 0. "
829        "  } "
830        "  bottom: 'norm1' "
831        "  top: 'conv2' "
832        "} "
833        "layers { "
834        "  layer { "
835        "    name: 'relu2' "
836        "    type: 'relu' "
837        "  } "
838        "  bottom: 'conv2' "
839        "  top: 'conv2' "
840        "} "
841        "layers { "
842        "  layer { "
843        "    name: 'pool2' "
844        "    type: 'pool' "
845        "    pool: MAX "
846        "    kernelsize: 3 "
847        "    stride: 2 "
848        "  } "
849        "  bottom: 'conv2' "
850        "  top: 'pool2' "
851        "} "
852        "layers { "
853        "  layer { "
854        "    name: 'norm2' "
855        "    type: 'lrn' "
856        "    local_size: 5 "
857        "    alpha: 0.0001 "
858        "    beta: 0.75 "
859        "  } "
860        "  bottom: 'pool2' "
861        "  top: 'norm2' "
862        "} "
863        "layers { "
864        "  layer { "
865        "    name: 'conv3' "
866        "    type: 'conv' "
867        "    num_output: 384 "
868        "    kernelsize: 3 "
869        "    pad: 1 "
870        "    weight_filler { "
871        "      type: 'gaussian' "
872        "      std: 0.01 "
873        "    } "
874        "    bias_filler { "
875        "      type: 'constant' "
876        "      value: 0. "
877        "    } "
878        "    blobs_lr: 1. "
879        "    blobs_lr: 2. "
880        "    weight_decay: 1. "
881        "    weight_decay: 0. "
882        "  } "
883        "  bottom: 'norm2' "
884        "  top: 'conv3' "
885        "} "
886        "layers { "
887        "  layer { "
888        "    name: 'relu3' "
889        "    type: 'relu' "
890        "  } "
891        "  bottom: 'conv3' "
892        "  top: 'conv3' "
893        "} "
894        "layers { "
895        "  layer { "
896        "    name: 'conv4' "
897        "    type: 'conv' "
898        "    num_output: 384 "
899        "    group: 2 "
900        "    kernelsize: 3 "
901        "    pad: 1 "
902        "    weight_filler { "
903        "      type: 'gaussian' "
904        "      std: 0.01 "
905        "    } "
906        "    bias_filler { "
907        "      type: 'constant' "
908        "      value: 1. "
909        "    } "
910        "    blobs_lr: 1. "
911        "    blobs_lr: 2. "
912        "    weight_decay: 1. "
913        "    weight_decay: 0. "
914        "  } "
915        "  bottom: 'conv3' "
916        "  top: 'conv4' "
917        "} "
918        "layers { "
919        "  layer { "
920        "    name: 'relu4' "
921        "    type: 'relu' "
922        "  } "
923        "  bottom: 'conv4' "
924        "  top: 'conv4' "
925        "} "
926        "layers { "
927        "  layer { "
928        "    name: 'conv5' "
929        "    type: 'conv' "
930        "    num_output: 256 "
931        "    group: 2 "
932        "    kernelsize: 3 "
933        "    pad: 1 "
934        "    weight_filler { "
935        "      type: 'gaussian' "
936        "      std: 0.01 "
937        "    } "
938        "    bias_filler { "
939        "      type: 'constant' "
940        "      value: 1. "
941        "    } "
942        "    blobs_lr: 1. "
943        "    blobs_lr: 2. "
944        "    weight_decay: 1. "
945        "    weight_decay: 0. "
946        "  } "
947        "  bottom: 'conv4' "
948        "  top: 'conv5' "
949        "} "
950        "layers { "
951        "  layer { "
952        "    name: 'relu5' "
953        "    type: 'relu' "
954        "  } "
955        "  bottom: 'conv5' "
956        "  top: 'conv5' "
957        "} "
958        "layers { "
959        "  layer { "
960        "    name: 'pool5' "
961        "    type: 'pool' "
962        "    kernelsize: 3 "
963        "    pool: MAX "
964        "    stride: 2 "
965        "  } "
966        "  bottom: 'conv5' "
967        "  top: 'pool5' "
968        "} "
969        "layers { "
970        "  layer { "
971        "    name: 'fc6' "
972        "    type: 'innerproduct' "
973        "    num_output: 4096 "
974        "    weight_filler { "
975        "      type: 'gaussian' "
976        "      std: 0.005 "
977        "    } "
978        "    bias_filler { "
979        "      type: 'constant' "
980        "      value: 1. "
981        "    } "
982        "    blobs_lr: 1. "
983        "    blobs_lr: 2. "
984        "    weight_decay: 1. "
985        "    weight_decay: 0. "
986        "  } "
987        "  bottom: 'pool5' "
988        "  top: 'fc6' "
989        "} "
990        "layers { "
991        "  layer { "
992        "    name: 'relu6' "
993        "    type: 'relu' "
994        "  } "
995        "  bottom: 'fc6' "
996        "  top: 'fc6' "
997        "} "
998        "layers { "
999        "  layer { "
1000        "    name: 'drop6' "
1001        "    type: 'dropout' "
1002        "    dropout_ratio: 0.5 "
1003        "  } "
1004        "  bottom: 'fc6' "
1005        "  top: 'fc6' "
1006        "} "
1007        "layers { "
1008        "  layer { "
1009        "    name: 'fc7' "
1010        "    type: 'innerproduct' "
1011        "    num_output: 4096 "
1012        "    weight_filler { "
1013        "      type: 'gaussian' "
1014        "      std: 0.005 "
1015        "    } "
1016        "    bias_filler { "
1017        "      type: 'constant' "
1018        "      value: 1. "
1019        "    } "
1020        "    blobs_lr: 1. "
1021        "    blobs_lr: 2. "
1022        "    weight_decay: 1. "
1023        "    weight_decay: 0. "
1024        "  } "
1025        "  bottom: 'fc6' "
1026        "  top: 'fc7' "
1027        "} "
1028        "layers { "
1029        "  layer { "
1030        "    name: 'relu7' "
1031        "    type: 'relu' "
1032        "  } "
1033        "  bottom: 'fc7' "
1034        "  top: 'fc7' "
1035        "} "
1036        "layers { "
1037        "  layer { "
1038        "    name: 'drop7' "
1039        "    type: 'dropout' "
1040        "    dropout_ratio: 0.5 "
1041        "  } "
1042        "  bottom: 'fc7' "
1043        "  top: 'fc7' "
1044        "} "
1045        "layers { "
1046        "  layer { "
1047        "    name: 'fc8' "
1048        "    type: 'innerproduct' "
1049        "    num_output: 1000 "
1050        "    weight_filler { "
1051        "      type: 'gaussian' "
1052        "      std: 0.01 "
1053        "    } "
1054        "    bias_filler { "
1055        "      type: 'constant' "
1056        "      value: 0 "
1057        "    } "
1058        "    blobs_lr: 1. "
1059        "    blobs_lr: 2. "
1060        "    weight_decay: 1. "
1061        "    weight_decay: 0. "
1062        "  } "
1063        "  bottom: 'fc7' "
1064        "  top: 'fc8' "
1065        "} "
1066        "layers { "
1067        "  layer { "
1068        "    name: 'loss' "
1069        "    type: 'softmax_loss' "
1070        "  } "
1071        "  bottom: 'fc8' "
1072        "  bottom: 'label' "
1073        "} ";
1074    this->RunPaddingUpgradeTest(input_proto, expected_output_proto);
1075  }
1076  class NetUpgradeTest : public ::testing::Test {
1077   protected:
1078    void RunV0UpgradeTest(
1079        const string& input_param_string, const string& output_param_string) {
1080      NetParameter input_param;
1081      CHECK(google::protobuf::TextFormat::ParseFromString(
1082          input_param_string, &input_param));
1083      NetParameter expected_output_param;
1084      CHECK(google::protobuf::TextFormat::ParseFromString(
1085          output_param_string, &expected_output_param));
1086      NetParameter actual_output_param;
1087      UpgradeV0Net(input_param, &actual_output_param);
1088      EXPECT_EQ(expected_output_param.DebugString(),
1089          actual_output_param.DebugString());
1090    }
1091    void RunV1UpgradeTest(
1092        const string& input_param_string, const string& output_param_string) {
1093      NetParameter input_param;
1094      CHECK(google::protobuf::TextFormat::ParseFromString(
1095          input_param_string, &input_param));
1096      NetParameter expected_output_param;
1097      CHECK(google::protobuf::TextFormat::ParseFromString(
1098          output_param_string, &expected_output_param));
1099      NetParameter actual_output_param;
1100      UpgradeV1Net(input_param, &actual_output_param);
1101      EXPECT_EQ(expected_output_param.DebugString(),
1102          actual_output_param.DebugString());
1103    }
1104  };
1105  TEST_F(NetUpgradeTest, TestSimple) {
1106    const string& v0_proto =
1107        "name: 'CaffeNet' "
1108        "layers { "
1109        "  layer { "
1110        "    name: 'data' "
1111        "    type: 'data' "
1112        "    source: '/home/jiayq/Data/ILSVRC12/train-leveldb' "
1113        "    meanfile: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
1114        "    batchsize: 256 "
1115        "    cropsize: 227 "
1116        "    mirror: true "
1117        "  } "
1118        "  top: 'data' "
1119        "  top: 'label' "
1120        "} "
1121        "layers { "
1122        "  layer { "
1123        "    name: 'pad1' "
1124        "    type: 'padding' "
1125        "    pad: 2 "
1126        "  } "
1127        "  bottom: 'data' "
1128        "  top: 'pad1' "
1129        "} "
1130        "layers { "
1131        "  layer { "
1132        "    name: 'conv1' "
1133        "    type: 'conv' "
1134        "    num_output: 96 "
1135        "    kernelsize: 11 "
1136        "    stride: 4 "
1137        "    weight_filler { "
1138        "      type: 'gaussian' "
1139        "      std: 0.01 "
1140        "    } "
1141        "    bias_filler { "
1142        "      type: 'constant' "
1143        "      value: 0. "
1144        "    } "
1145        "    blobs_lr: 1. "
1146        "    blobs_lr: 2. "
1147        "    weight_decay: 1. "
1148        "    weight_decay: 0. "
1149        "  } "
1150        "  bottom: 'pad1' "
1151        "  top: 'conv1' "
1152        "} "
1153        "layers { "
1154        "  layer { "
1155        "    name: 'fc8' "
1156        "    type: 'innerproduct' "
1157        "    num_output: 1000 "
1158        "    weight_filler { "
1159        "      type: 'gaussian' "
1160        "      std: 0.01 "
1161        "    } "
1162        "    bias_filler { "
1163        "      type: 'constant' "
1164        "      value: 0 "
1165        "    } "
1166        "    blobs_lr: 1. "
1167        "    blobs_lr: 2. "
1168        "    weight_decay: 1. "
1169        "    weight_decay: 0. "
1170        "  } "
1171        "  bottom: 'conv1' "
1172        "  top: 'fc8' "
1173        "} "
1174        "layers { "
1175        "  layer { "
1176        "    name: 'loss' "
1177        "    type: 'softmax_loss' "
1178        "  } "
1179        "  bottom: 'fc8' "
1180        "  bottom: 'label' "
1181        "} ";
1182    const string& expected_v1_proto =
1183        "name: 'CaffeNet' "
1184        "layers { "
1185        "  name: 'data' "
1186        "  type: DATA "
1187        "  data_param { "
1188        "    source: '/home/jiayq/Data/ILSVRC12/train-leveldb' "
1189        "    batch_size: 256 "
1190        "  } "
1191        "  transform_param { "
1192        "    crop_size: 227 "
1193        "    mirror: true "
1194        "    mean_file: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
1195        "  } "
1196        "  top: 'data' "
1197        "  top: 'label' "
1198        "} "
1199        "layers { "
1200        "  name: 'conv1' "
1201        "  type: CONVOLUTION "
1202        "  convolution_param { "
1203        "    num_output: 96 "
1204        "    kernel_size: 11 "
1205        "    stride: 4 "
1206        "    pad: 2 "
1207        "    weight_filler { "
1208        "      type: 'gaussian' "
1209        "      std: 0.01 "
1210        "    } "
1211        "    bias_filler { "
1212        "      type: 'constant' "
1213        "      value: 0. "
1214        "    } "
1215        "  } "
1216        "  blobs_lr: 1. "
1217        "  blobs_lr: 2. "
1218        "  weight_decay: 1. "
1219        "  weight_decay: 0. "
1220        "  bottom: 'data' "
1221        "  top: 'conv1' "
1222        "} "
1223        "layers { "
1224        "  name: 'fc8' "
1225        "  type: INNER_PRODUCT "
1226        "  inner_product_param { "
1227        "    num_output: 1000 "
1228        "    weight_filler { "
1229        "      type: 'gaussian' "
1230        "      std: 0.01 "
1231        "    } "
1232        "    bias_filler { "
1233        "      type: 'constant' "
1234        "      value: 0 "
1235        "    } "
1236        "  } "
1237        "  blobs_lr: 1. "
1238        "  blobs_lr: 2. "
1239        "  weight_decay: 1. "
1240        "  weight_decay: 0. "
1241        "  bottom: 'conv1' "
1242        "  top: 'fc8' "
1243        "} "
1244        "layers { "
1245        "  name: 'loss' "
1246        "  type: SOFTMAX_LOSS "
1247        "  bottom: 'fc8' "
1248        "  bottom: 'label' "
1249        "} ";
1250    this->RunV0UpgradeTest(v0_proto, expected_v1_proto);
1251    const string& expected_v2_proto =
1252        "name: 'CaffeNet' "
1253        "layer { "
1254        "  name: 'data' "
1255        "  type: 'Data' "
1256        "  data_param { "
1257        "    source: '/home/jiayq/Data/ILSVRC12/train-leveldb' "
1258        "    batch_size: 256 "
1259        "  } "
1260        "  transform_param { "
1261        "    crop_size: 227 "
1262        "    mirror: true "
1263        "    mean_file: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
1264        "  } "
1265        "  top: 'data' "
1266        "  top: 'label' "
1267        "} "
1268        "layer { "
1269        "  name: 'conv1' "
1270        "  type: 'Convolution' "
1271        "  convolution_param { "
1272        "    num_output: 96 "
1273        "    kernel_size: 11 "
1274        "    stride: 4 "
1275        "    pad: 2 "
1276        "    weight_filler { "
1277        "      type: 'gaussian' "
1278        "      std: 0.01 "
1279        "    } "
1280        "    bias_filler { "
1281        "      type: 'constant' "
1282        "      value: 0. "
1283        "    } "
1284        "  } "
1285        "  param { "
1286        "    lr_mult: 1 "
1287        "    decay_mult: 1 "
1288        "  } "
1289        "  param { "
1290        "    lr_mult: 2 "
1291        "    decay_mult: 0 "
1292        "  } "
1293        "  bottom: 'data' "
1294        "  top: 'conv1' "
1295        "} "
1296        "layer { "
1297        "  name: 'fc8' "
1298        "  type: 'InnerProduct' "
1299        "  inner_product_param { "
1300        "    num_output: 1000 "
1301        "    weight_filler { "
1302        "      type: 'gaussian' "
1303        "      std: 0.01 "
1304        "    } "
1305        "    bias_filler { "
1306        "      type: 'constant' "
1307        "      value: 0 "
1308        "    } "
1309        "  } "
1310        "  param { "
1311        "    lr_mult: 1 "
1312        "    decay_mult: 1 "
1313        "  } "
1314        "  param { "
1315        "    lr_mult: 2 "
1316        "    decay_mult: 0 "
1317        "  } "
1318        "  bottom: 'conv1' "
1319        "  top: 'fc8' "
1320        "} "
1321        "layer { "
1322        "  name: 'loss' "
1323        "  type: 'SoftmaxWithLoss' "
1324        "  bottom: 'fc8' "
1325        "  bottom: 'label' "
1326        "} ";
1327    this->RunV1UpgradeTest(expected_v1_proto, expected_v2_proto);
1328  }
1329  TEST_F(NetUpgradeTest, TestAllParams) {
1330    const string& input_proto =
1331        "name: 'CaffeNet' "
1332        "input: 'input_data' "
1333        "input_dim: 64 "
1334        "input_dim: 3 "
1335        "input_dim: 32 "
1336        "input_dim: 32 "
1337        "layers { "
1338        "  layer { "
1339        "    name: 'data' "
1340        "    type: 'data' "
1341        "    source: '/home/jiayq/Data/ILSVRC12/train-leveldb' "
1342        "    meanfile: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
1343        "    batchsize: 256 "
1344        "    cropsize: 227 "
1345        "    mirror: true "
1346        "    scale: 0.25 "
1347        "    rand_skip: 73 "
1348        "  } "
1349        "  top: 'data' "
1350        "  top: 'label' "
1351        "} "
1352        "layers { "
1353        "  layer { "
1354        "    name: 'images' "
1355        "    type: 'images' "
1356        "    source: '/home/jiayq/Data/ILSVRC12/train-images' "
1357        "    meanfile: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
1358        "    batchsize: 256 "
1359        "    cropsize: 227 "
1360        "    mirror: true "
1361        "    scale: 0.25 "
1362        "    rand_skip: 73 "
1363        "    shuffle_images: true "
1364        "    new_height: 40 "
1365        "    new_width: 30 "
1366        "  } "
1367        "  top: 'images_data' "
1368        "  top: 'images_label' "
1369        "} "
1370        "layers { "
1371        "  layer { "
1372        "    name: 'window_data' "
1373        "    type: 'window_data' "
1374        "    source: '/home/jiayq/Data/ILSVRC12/train-leveldb' "
1375        "    meanfile: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
1376        "    batchsize: 256 "
1377        "    cropsize: 227 "
1378        "    mirror: true "
1379        "    det_fg_threshold: 0.25 "
1380        "    det_bg_threshold: 0.75 "
1381        "    det_fg_fraction: 0.5 "
1382        "    det_context_pad: 16 "
1383        "    det_crop_mode: 'square' "
1384        "  } "
1385        "  top: 'window_data' "
1386        "  top: 'window_label' "
1387        "} "
1388        "layers { "
1389        "  layer { "
1390        "    name: 'hdf5data' "
1391        "    type: 'hdf5_data' "
1392        "    source: '/my/hdf5/data' "
1393        "    batchsize: 256 "
1394        "  } "
1395        "  top: 'hdf5data' "
1396        "} "
1397        "layers { "
1398        "  layer { "
1399        "    name: 'conv1' "
1400        "    type: 'conv' "
1401        "    num_output: 96 "
1402        "    biasterm: false "
1403        "    pad: 4 "
1404        "    kernelsize: 11 "
1405        "    stride: 4 "
1406        "    weight_filler { "
1407        "      type: 'gaussian' "
1408        "      std: 0.01 "
1409        "    } "
1410        "    bias_filler { "
1411        "      type: 'constant' "
1412        "      value: 3. "
1413        "    } "
1414        "    blobs_lr: 1. "
1415        "    blobs_lr: 2. "
1416        "    weight_decay: 1. "
1417        "    weight_decay: 0. "
1418        "  } "
1419        "  bottom: 'data' "
1420        "  top: 'conv1' "
1421        "} "
1422        "layers { "
1423        "  layer { "
1424        "    name: 'pool1ave' "
1425        "    type: 'pool' "
1426        "    pool: AVE "
1427        "    kernelsize: 3 "
1428        "    stride: 2 "
1429        "  } "
1430        "  bottom: 'conv1' "
1431        "  top: 'pool1ave' "
1432        "} "
1433        "layers { "
1434        "  layer { "
1435        "    name: 'pool1stoch' "
1436        "    type: 'pool' "
1437        "    pool: STOCHASTIC "
1438        "    kernelsize: 4 "
1439        "    stride: 5 "
1440        "  } "
1441        "  bottom: 'conv1' "
1442        "  top: 'pool1stoch' "
1443        "} "
1444        "layers { "
1445        "  layer { "
1446        "    name: 'concat' "
1447        "    type: 'concat' "
1448        "    concat_dim: 2 "
1449        "  } "
1450        "  bottom: 'pool1ave' "
1451        "  bottom: 'pool1stoch' "
1452        "  top: 'pool1concat' "
1453        "} "
1454        "layers { "
1455        "  layer { "
1456        "    name: 'norm1' "
1457        "    type: 'lrn' "
1458        "    local_size: 5 "
1459        "    alpha: 0.0001 "
1460        "    beta: 0.75 "
1461        "  } "
1462        "  bottom: 'pool1concat' "
1463        "  top: 'norm1' "
1464        "} "
1465        "layers { "
1466        "  layer { "
1467        "    name: 'fc6' "
1468        "    type: 'innerproduct' "
1469        "    num_output: 4096 "
1470        "    biasterm: false "
1471        "    weight_filler { "
1472        "      type: 'gaussian' "
1473        "      std: 0.005 "
1474        "    } "
1475        "    bias_filler { "
1476        "      type: 'constant' "
1477        "      value: 1. "
1478        "    } "
1479        "    blobs_lr: 1. "
1480        "    blobs_lr: 2. "
1481        "    weight_decay: 1. "
1482        "    weight_decay: 0. "
1483        "  } "
1484        "  bottom: 'norm1' "
1485        "  top: 'fc6' "
1486        "} "
1487        "layers { "
1488        "  layer { "
1489        "    name: 'relu6' "
1490        "    type: 'relu' "
1491        "  } "
1492        "  bottom: 'fc6' "
1493        "  top: 'fc6' "
1494        "} "
1495        "layers { "
1496        "  layer { "
1497        "    name: 'drop6' "
1498        "    type: 'dropout' "
1499        "    dropout_ratio: 0.2 "
1500        "  } "
1501        "  bottom: 'fc6' "
1502        "  top: 'fc6' "
1503        "} "
1504        "layers { "
1505        "  layer { "
1506        "    name: 'loss' "
1507        "    type: 'infogain_loss' "
1508        "    source: '/my/infogain/matrix' "
1509        "  } "
1510        "  bottom: 'fc6' "
1511        "  bottom: 'label' "
1512        "} "
1513        "layers { "
1514        "  layer { "
1515        "    name: 'accuracy' "
1516        "    type: 'accuracy' "
1517        "  } "
1518        "} "
1519        "layers { "
1520        "  layer { "
1521        "    name: 'bnll' "
1522        "    type: 'bnll' "
1523        "  } "
1524        "} "
1525        "layers { "
1526        "  layer { "
1527        "    name: 'euclidean_loss' "
1528        "    type: 'euclidean_loss' "
1529        "  } "
1530        "} "
1531        "layers { "
1532        "  layer { "
1533        "    name: 'flatten' "
1534        "    type: 'flatten' "
1535        "  } "
1536        "} "
1537        "layers { "
1538        "  layer { "
1539        "    name: 'hdf5_output' "
1540        "    type: 'hdf5_output' "
1541        "    hdf5_output_param { "
1542        "      file_name: '/my/hdf5/output/file' "
1543        "    } "
1544        "  } "
1545        "} "
1546        "layers { "
1547        "  layer { "
1548        "    name: 'im2col' "
1549        "    type: 'im2col' "
1550        "  } "
1551        "} "
1552        "layers { "
1553        "  layer { "
1554        "    name: 'images' "
1555        "    type: 'images' "
1556        "  } "
1557        "} "
1558        "layers { "
1559        "  layer { "
1560        "    name: 'multinomial_logistic_loss' "
1561        "    type: 'multinomial_logistic_loss' "
1562        "  } "
1563        "} "
1564        "layers { "
1565        "  layer { "
1566        "    name: 'sigmoid' "
1567        "    type: 'sigmoid' "
1568        "  } "
1569        "} "
1570        "layers { "
1571        "  layer { "
1572        "    name: 'softmax' "
1573        "    type: 'softmax' "
1574        "  } "
1575        "} "
1576        "layers { "
1577        "  layer { "
1578        "    name: 'split' "
1579        "    type: 'split' "
1580        "  } "
1581        "} "
1582        "layers { "
1583        "  layer { "
1584        "    name: 'tanh' "
1585        "    type: 'tanh' "
1586        "  } "
1587        "} ";
1588    const string& expected_output_proto =
1589        "name: 'CaffeNet' "
1590        "input: 'input_data' "
1591        "input_dim: 64 "
1592        "input_dim: 3 "
1593        "input_dim: 32 "
1594        "input_dim: 32 "
1595        "layers { "
1596        "  name: 'data' "
1597        "  type: DATA "
1598        "  data_param { "
1599        "    source: '/home/jiayq/Data/ILSVRC12/train-leveldb' "
1600        "    batch_size: 256 "
1601        "    rand_skip: 73 "
1602        "  } "
1603        "  transform_param { "
1604        "    crop_size: 227 "
1605        "    mirror: true "
1606        "    scale: 0.25 "
1607        "    mean_file: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
1608        "  } "
1609        "  top: 'data' "
1610        "  top: 'label' "
1611        "} "
1612        "layers { "
1613        "  name: 'images' "
1614        "  type: IMAGE_DATA "
1615        "  image_data_param { "
1616        "    source: '/home/jiayq/Data/ILSVRC12/train-images' "
1617        "    batch_size: 256 "
1618        "    rand_skip: 73 "
1619        "    shuffle: true "
1620        "    new_height: 40 "
1621        "    new_width: 30 "
1622        "  } "
1623        "  transform_param {"
1624        "    mean_file: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
1625        "    crop_size: 227 "
1626        "    mirror: true "
1627        "    scale: 0.25 "
1628        "  } "
1629        "  top: 'images_data' "
1630        "  top: 'images_label' "
1631        "} "
1632        "layers { "
1633        "  name: 'window_data' "
1634        "  type: WINDOW_DATA "
1635        "  window_data_param { "
1636        "    source: '/home/jiayq/Data/ILSVRC12/train-leveldb' "
1637        "    batch_size: 256 "
1638        "    fg_threshold: 0.25 "
1639        "    bg_threshold: 0.75 "
1640        "    fg_fraction: 0.5 "
1641        "    context_pad: 16 "
1642        "    crop_mode: 'square' "
1643        "  } "
1644        "  transform_param { "
1645        "    mirror: true "
1646        "    crop_size: 227 "
1647        "    mean_file: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
1648        "  }"
1649        "  top: 'window_data' "
1650        "  top: 'window_label' "
1651        "} "
1652        "layers { "
1653        "  name: 'hdf5data' "
1654        "  type: HDF5_DATA "
1655        "  hdf5_data_param { "
1656        "    source: '/my/hdf5/data' "
1657        "    batch_size: 256 "
1658        "  } "
1659        "  top: 'hdf5data' "
1660        "} "
1661        "layers { "
1662        "  name: 'conv1' "
1663        "  type: CONVOLUTION "
1664        "  convolution_param { "
1665        "    num_output: 96 "
1666        "    bias_term: false "
1667        "    pad: 4 "
1668        "    kernel_size: 11 "
1669        "    stride: 4 "
1670        "    weight_filler { "
1671        "      type: 'gaussian' "
1672        "      std: 0.01 "
1673        "    } "
1674        "    bias_filler { "
1675        "      type: 'constant' "
1676        "      value: 3. "
1677        "    } "
1678        "  } "
1679        "  blobs_lr: 1. "
1680        "  blobs_lr: 2. "
1681        "  weight_decay: 1. "
1682        "  weight_decay: 0. "
1683        "  bottom: 'data' "
1684        "  top: 'conv1' "
1685        "} "
1686        "layers { "
1687        "  name: 'pool1ave' "
1688        "  type: POOLING "
1689        "  pooling_param { "
1690        "    pool: AVE "
1691        "    kernel_size: 3 "
1692        "    stride: 2 "
1693        "  } "
1694        "  bottom: 'conv1' "
1695        "  top: 'pool1ave' "
1696        "} "
1697        "layers { "
1698        "  name: 'pool1stoch' "
1699        "  type: POOLING "
1700        "  pooling_param { "
1701        "    pool: STOCHASTIC "
1702        "    kernel_size: 4 "
1703        "    stride: 5 "
1704        "  } "
1705        "  bottom: 'conv1' "
1706        "  top: 'pool1stoch' "
1707        "} "
1708        "layers { "
1709        "  name: 'concat' "
1710        "  type: CONCAT "
1711        "  concat_param { "
1712        "    concat_dim: 2 "
1713        "  } "
1714        "  bottom: 'pool1ave' "
1715        "  bottom: 'pool1stoch' "
1716        "  top: 'pool1concat' "
1717        "} "
1718        "layers { "
1719        "  name: 'norm1' "
1720        "  type: LRN "
1721        "  lrn_param { "
1722        "    local_size: 5 "
1723        "    alpha: 0.0001 "
1724        "    beta: 0.75 "
1725        "  } "
1726        "  bottom: 'pool1concat' "
1727        "  top: 'norm1' "
1728        "} "
1729        "layers { "
1730        "  name: 'fc6' "
1731        "  type: INNER_PRODUCT "
1732        "  inner_product_param { "
1733        "    num_output: 4096 "
1734        "    bias_term: false "
1735        "    weight_filler { "
1736        "      type: 'gaussian' "
1737        "      std: 0.005 "
1738        "    } "
1739        "    bias_filler { "
1740        "      type: 'constant' "
1741        "      value: 1. "
1742        "    } "
1743        "  } "
1744        "  blobs_lr: 1. "
1745        "  blobs_lr: 2. "
1746        "  weight_decay: 1. "
1747        "  weight_decay: 0. "
1748        "  bottom: 'norm1' "
1749        "  top: 'fc6' "
1750        "} "
1751        "layers { "
1752        "  name: 'relu6' "
1753        "  type: RELU "
1754        "  bottom: 'fc6' "
1755        "  top: 'fc6' "
1756        "} "
1757        "layers { "
1758        "  name: 'drop6' "
1759        "  type: DROPOUT "
1760        "  dropout_param { "
1761        "    dropout_ratio: 0.2 "
1762        "  } "
1763        "  bottom: 'fc6' "
1764        "  top: 'fc6' "
1765        "} "
1766        "layers { "
1767        "  name: 'loss' "
1768        "  type: INFOGAIN_LOSS "
1769        "  infogain_loss_param { "
1770        "    source: '/my/infogain/matrix' "
1771        "  } "
1772        "  bottom: 'fc6' "
1773        "  bottom: 'label' "
1774        "} "
1775        "layers { "
1776        "  name: 'accuracy' "
1777        "  type: ACCURACY "
1778        "} "
1779        "layers { "
1780        "  name: 'bnll' "
1781        "  type: BNLL "
1782        "} "
1783        "layers { "
1784        "  name: 'euclidean_loss' "
1785        "  type: EUCLIDEAN_LOSS "
1786        "} "
1787        "layers { "
1788        "  name: 'flatten' "
1789        "  type: FLATTEN "
1790        "} "
1791        "layers { "
1792        "  name: 'hdf5_output' "
1793        "  type: HDF5_OUTPUT "
1794        "  hdf5_output_param { "
1795        "    file_name: '/my/hdf5/output/file' "
1796        "  } "
1797        "} "
1798        "layers { "
1799        "  name: 'im2col' "
1800        "  type: IM2COL "
1801        "} "
1802        "layers { "
1803        "  name: 'images' "
1804        "  type: IMAGE_DATA "
1805        "} "
1806        "layers { "
1807        "  name: 'multinomial_logistic_loss' "
1808        "  type: MULTINOMIAL_LOGISTIC_LOSS "
1809        "} "
1810        "layers { "
1811        "  name: 'sigmoid' "
1812        "  type: SIGMOID "
1813        "} "
1814        "layers { "
1815        "  name: 'softmax' "
1816        "  type: SOFTMAX "
1817        "} "
1818        "layers { "
1819        "  name: 'split' "
1820        "  type: SPLIT "
1821        "} "
1822        "layers { "
1823        "  name: 'tanh' "
1824        "  type: TANH "
1825        "} ";
1826    this->RunV0UpgradeTest(input_proto, expected_output_proto);
1827  }
1828  TEST_F(NetUpgradeTest, TestImageNet) {
1829    const string& v0_proto =
1830        "name: 'CaffeNet' "
1831        "layers { "
1832        "  layer { "
1833        "    name: 'data' "
1834        "    type: 'data' "
1835        "    source: '/home/jiayq/Data/ILSVRC12/train-leveldb' "
1836        "    meanfile: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
1837        "    batchsize: 256 "
1838        "    cropsize: 227 "
1839        "    mirror: true "
1840        "  } "
1841        "  top: 'data' "
1842        "  top: 'label' "
1843        "} "
1844        "layers { "
1845        "  layer { "
1846        "    name: 'conv1' "
1847        "    type: 'conv' "
1848        "    num_output: 96 "
1849        "    kernelsize: 11 "
1850        "    stride: 4 "
1851        "    weight_filler { "
1852        "      type: 'gaussian' "
1853        "      std: 0.01 "
1854        "    } "
1855        "    bias_filler { "
1856        "      type: 'constant' "
1857        "      value: 0. "
1858        "    } "
1859        "    blobs_lr: 1. "
1860        "    blobs_lr: 2. "
1861        "    weight_decay: 1. "
1862        "    weight_decay: 0. "
1863        "  } "
1864        "  bottom: 'data' "
1865        "  top: 'conv1' "
1866        "} "
1867        "layers { "
1868        "  layer { "
1869        "    name: 'relu1' "
1870        "    type: 'relu' "
1871        "  } "
1872        "  bottom: 'conv1' "
1873        "  top: 'conv1' "
1874        "} "
1875        "layers { "
1876        "  layer { "
1877        "    name: 'pool1' "
1878        "    type: 'pool' "
1879        "    pool: MAX "
1880        "    kernelsize: 3 "
1881        "    stride: 2 "
1882        "  } "
1883        "  bottom: 'conv1' "
1884        "  top: 'pool1' "
1885        "} "
1886        "layers { "
1887        "  layer { "
1888        "    name: 'norm1' "
1889        "    type: 'lrn' "
1890        "    local_size: 5 "
1891        "    alpha: 0.0001 "
1892        "    beta: 0.75 "
1893        "  } "
1894        "  bottom: 'pool1' "
1895        "  top: 'norm1' "
1896        "} "
1897        "layers { "
1898        "  layer { "
1899        "    name: 'pad2' "
1900        "    type: 'padding' "
1901        "    pad: 2 "
1902        "  } "
1903        "  bottom: 'norm1' "
1904        "  top: 'pad2' "
1905        "} "
1906        "layers { "
1907        "  layer { "
1908        "    name: 'conv2' "
1909        "    type: 'conv' "
1910        "    num_output: 256 "
1911        "    group: 2 "
1912        "    kernelsize: 5 "
1913        "    weight_filler { "
1914        "      type: 'gaussian' "
1915        "      std: 0.01 "
1916        "    } "
1917        "    bias_filler { "
1918        "      type: 'constant' "
1919        "      value: 1. "
1920        "    } "
1921        "    blobs_lr: 1. "
1922        "    blobs_lr: 2. "
1923        "    weight_decay: 1. "
1924        "    weight_decay: 0. "
1925        "  } "
1926        "  bottom: 'pad2' "
1927        "  top: 'conv2' "
1928        "} "
1929        "layers { "
1930        "  layer { "
1931        "    name: 'relu2' "
1932        "    type: 'relu' "
1933        "  } "
1934        "  bottom: 'conv2' "
1935        "  top: 'conv2' "
1936        "} "
1937        "layers { "
1938        "  layer { "
1939        "    name: 'pool2' "
1940        "    type: 'pool' "
1941        "    pool: MAX "
1942        "    kernelsize: 3 "
1943        "    stride: 2 "
1944        "  } "
1945        "  bottom: 'conv2' "
1946        "  top: 'pool2' "
1947        "} "
1948        "layers { "
1949        "  layer { "
1950        "    name: 'norm2' "
1951        "    type: 'lrn' "
1952        "    local_size: 5 "
1953        "    alpha: 0.0001 "
1954        "    beta: 0.75 "
1955        "  } "
1956        "  bottom: 'pool2' "
1957        "  top: 'norm2' "
1958        "} "
1959        "layers { "
1960        "  layer { "
1961        "    name: 'pad3' "
1962        "    type: 'padding' "
1963        "    pad: 1 "
1964        "  } "
1965        "  bottom: 'norm2' "
1966        "  top: 'pad3' "
1967        "} "
1968        "layers { "
1969        "  layer { "
1970        "    name: 'conv3' "
1971        "    type: 'conv' "
1972        "    num_output: 384 "
1973        "    kernelsize: 3 "
1974        "    weight_filler { "
1975        "      type: 'gaussian' "
1976        "      std: 0.01 "
1977        "    } "
1978        "    bias_filler { "
1979        "      type: 'constant' "
1980        "      value: 0. "
1981        "    } "
1982        "    blobs_lr: 1. "
1983        "    blobs_lr: 2. "
1984        "    weight_decay: 1. "
1985        "    weight_decay: 0. "
1986        "  } "
1987        "  bottom: 'pad3' "
1988        "  top: 'conv3' "
1989        "} "
1990        "layers { "
1991        "  layer { "
1992        "    name: 'relu3' "
1993        "    type: 'relu' "
1994        "  } "
1995        "  bottom: 'conv3' "
1996        "  top: 'conv3' "
1997        "} "
1998        "layers { "
1999        "  layer { "
2000        "    name: 'pad4' "
2001        "    type: 'padding' "
2002        "    pad: 1 "
2003        "  } "
2004        "  bottom: 'conv3' "
2005        "  top: 'pad4' "
2006        "} "
2007        "layers { "
2008        "  layer { "
2009        "    name: 'conv4' "
2010        "    type: 'conv' "
2011        "    num_output: 384 "
2012        "    group: 2 "
2013        "    kernelsize: 3 "
2014        "    weight_filler { "
2015        "      type: 'gaussian' "
2016        "      std: 0.01 "
2017        "    } "
2018        "    bias_filler { "
2019        "      type: 'constant' "
2020        "      value: 1. "
2021        "    } "
2022        "    blobs_lr: 1. "
2023        "    blobs_lr: 2. "
2024        "    weight_decay: 1. "
2025        "    weight_decay: 0. "
2026        "  } "
2027        "  bottom: 'pad4' "
2028        "  top: 'conv4' "
2029        "} "
2030        "layers { "
2031        "  layer { "
2032        "    name: 'relu4' "
2033        "    type: 'relu' "
2034        "  } "
2035        "  bottom: 'conv4' "
2036        "  top: 'conv4' "
2037        "} "
2038        "layers { "
2039        "  layer { "
2040        "    name: 'pad5' "
2041        "    type: 'padding' "
2042        "    pad: 1 "
2043        "  } "
2044        "  bottom: 'conv4' "
2045        "  top: 'pad5' "
2046        "} "
2047        "layers { "
2048        "  layer { "
2049        "    name: 'conv5' "
2050        "    type: 'conv' "
2051        "    num_output: 256 "
2052        "    group: 2 "
2053        "    kernelsize: 3 "
2054        "    weight_filler { "
2055        "      type: 'gaussian' "
2056        "      std: 0.01 "
2057        "    } "
2058        "    bias_filler { "
2059        "      type: 'constant' "
2060        "      value: 1. "
2061        "    } "
2062        "    blobs_lr: 1. "
2063        "    blobs_lr: 2. "
2064        "    weight_decay: 1. "
2065        "    weight_decay: 0. "
2066        "  } "
2067        "  bottom: 'pad5' "
2068        "  top: 'conv5' "
2069        "} "
2070        "layers { "
2071        "  layer { "
2072        "    name: 'relu5' "
2073        "    type: 'relu' "
2074        "  } "
2075        "  bottom: 'conv5' "
2076        "  top: 'conv5' "
2077        "} "
2078        "layers { "
2079        "  layer { "
2080        "    name: 'pool5' "
2081        "    type: 'pool' "
2082        "    kernelsize: 3 "
2083        "    pool: MAX "
2084        "    stride: 2 "
2085        "  } "
2086        "  bottom: 'conv5' "
2087        "  top: 'pool5' "
2088        "} "
2089        "layers { "
2090        "  layer { "
2091        "    name: 'fc6' "
2092        "    type: 'innerproduct' "
2093        "    num_output: 4096 "
2094        "    weight_filler { "
2095        "      type: 'gaussian' "
2096        "      std: 0.005 "
2097        "    } "
2098        "    bias_filler { "
2099        "      type: 'constant' "
2100        "      value: 1. "
2101        "    } "
2102        "    blobs_lr: 1. "
2103        "    blobs_lr: 2. "
2104        "    weight_decay: 1. "
2105        "    weight_decay: 0. "
2106        "  } "
2107        "  bottom: 'pool5' "
2108        "  top: 'fc6' "
2109        "} "
2110        "layers { "
2111        "  layer { "
2112        "    name: 'relu6' "
2113        "    type: 'relu' "
2114        "  } "
2115        "  bottom: 'fc6' "
2116        "  top: 'fc6' "
2117        "} "
2118        "layers { "
2119        "  layer { "
2120        "    name: 'drop6' "
2121        "    type: 'dropout' "
2122        "    dropout_ratio: 0.5 "
2123        "  } "
2124        "  bottom: 'fc6' "
2125        "  top: 'fc6' "
2126        "} "
2127        "layers { "
2128        "  layer { "
2129        "    name: 'fc7' "
2130        "    type: 'innerproduct' "
2131        "    num_output: 4096 "
2132        "    weight_filler { "
2133        "      type: 'gaussian' "
2134        "      std: 0.005 "
2135        "    } "
2136        "    bias_filler { "
2137        "      type: 'constant' "
2138        "      value: 1. "
2139        "    } "
2140        "    blobs_lr: 1. "
2141        "    blobs_lr: 2. "
2142        "    weight_decay: 1. "
2143        "    weight_decay: 0. "
2144        "  } "
2145        "  bottom: 'fc6' "
2146        "  top: 'fc7' "
2147        "} "
2148        "layers { "
2149        "  layer { "
2150        "    name: 'relu7' "
2151        "    type: 'relu' "
2152        "  } "
2153        "  bottom: 'fc7' "
2154        "  top: 'fc7' "
2155        "} "
2156        "layers { "
2157        "  layer { "
2158        "    name: 'drop7' "
2159        "    type: 'dropout' "
2160        "    dropout_ratio: 0.5 "
2161        "  } "
2162        "  bottom: 'fc7' "
2163        "  top: 'fc7' "
2164        "} "
2165        "layers { "
2166        "  layer { "
2167        "    name: 'fc8' "
2168        "    type: 'innerproduct' "
2169        "    num_output: 1000 "
2170        "    weight_filler { "
2171        "      type: 'gaussian' "
2172        "      std: 0.01 "
2173        "    } "
2174        "    bias_filler { "
2175        "      type: 'constant' "
2176        "      value: 0 "
2177        "    } "
2178        "    blobs_lr: 1. "
2179        "    blobs_lr: 2. "
2180        "    weight_decay: 1. "
2181        "    weight_decay: 0. "
2182        "  } "
2183        "  bottom: 'fc7' "
2184        "  top: 'fc8' "
2185        "} "
2186        "layers { "
2187        "  layer { "
2188        "    name: 'loss' "
2189        "    type: 'softmax_loss' "
2190        "  } "
2191        "  bottom: 'fc8' "
2192        "  bottom: 'label' "
2193        "} ";
2194    const string& expected_v1_proto =
2195        "name: 'CaffeNet' "
2196        "layers { "
2197        "  name: 'data' "
2198        "  type: DATA "
2199        "  data_param { "
2200        "    source: '/home/jiayq/Data/ILSVRC12/train-leveldb' "
2201        "    batch_size: 256 "
2202        "  } "
2203        "  transform_param { "
2204        "    crop_size: 227 "
2205        "    mirror: true "
2206        "    mean_file: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
2207        "  } "
2208        "  top: 'data' "
2209        "  top: 'label' "
2210        "} "
2211        "layers { "
2212        "  name: 'conv1' "
2213        "  type: CONVOLUTION "
2214        "  convolution_param { "
2215        "    num_output: 96 "
2216        "    kernel_size: 11 "
2217        "    stride: 4 "
2218        "    weight_filler { "
2219        "      type: 'gaussian' "
2220        "      std: 0.01 "
2221        "    } "
2222        "    bias_filler { "
2223        "      type: 'constant' "
2224        "      value: 0. "
2225        "    } "
2226        "  } "
2227        "  blobs_lr: 1. "
2228        "  blobs_lr: 2. "
2229        "  weight_decay: 1. "
2230        "  weight_decay: 0. "
2231        "  bottom: 'data' "
2232        "  top: 'conv1' "
2233        "} "
2234        "layers { "
2235        "  name: 'relu1' "
2236        "  type: RELU "
2237        "  bottom: 'conv1' "
2238        "  top: 'conv1' "
2239        "} "
2240        "layers { "
2241        "  name: 'pool1' "
2242        "  type: POOLING "
2243        "  pooling_param { "
2244        "    pool: MAX "
2245        "    kernel_size: 3 "
2246        "    stride: 2 "
2247        "  } "
2248        "  bottom: 'conv1' "
2249        "  top: 'pool1' "
2250        "} "
2251        "layers { "
2252        "  name: 'norm1' "
2253        "  type: LRN "
2254        "  lrn_param { "
2255        "    local_size: 5 "
2256        "    alpha: 0.0001 "
2257        "    beta: 0.75 "
2258        "  } "
2259        "  bottom: 'pool1' "
2260        "  top: 'norm1' "
2261        "} "
2262        "layers { "
2263        "  name: 'conv2' "
2264        "  type: CONVOLUTION "
2265        "  convolution_param { "
2266        "    num_output: 256 "
2267        "    group: 2 "
2268        "    kernel_size: 5 "
2269        "    pad: 2 "
2270        "    weight_filler { "
2271        "      type: 'gaussian' "
2272        "      std: 0.01 "
2273        "    } "
2274        "    bias_filler { "
2275        "      type: 'constant' "
2276        "      value: 1. "
2277        "    } "
2278        "  } "
2279        "  blobs_lr: 1. "
2280        "  blobs_lr: 2. "
2281        "  weight_decay: 1. "
2282        "  weight_decay: 0. "
2283        "  bottom: 'norm1' "
2284        "  top: 'conv2' "
2285        "} "
2286        "layers { "
2287        "  name: 'relu2' "
2288        "  type: RELU "
2289        "  bottom: 'conv2' "
2290        "  top: 'conv2' "
2291        "} "
2292        "layers { "
2293        "  name: 'pool2' "
2294        "  type: POOLING "
2295        "  pooling_param { "
2296        "    pool: MAX "
2297        "    kernel_size: 3 "
2298        "    stride: 2 "
2299        "  } "
2300        "  bottom: 'conv2' "
2301        "  top: 'pool2' "
2302        "} "
2303        "layers { "
2304        "  name: 'norm2' "
2305        "  type: LRN "
2306        "  lrn_param { "
2307        "    local_size: 5 "
2308        "    alpha: 0.0001 "
2309        "    beta: 0.75 "
2310        "  } "
2311        "  bottom: 'pool2' "
2312        "  top: 'norm2' "
2313        "} "
2314        "layers { "
2315        "  name: 'conv3' "
2316        "  type: CONVOLUTION "
2317        "  convolution_param { "
2318        "    num_output: 384 "
2319        "    kernel_size: 3 "
2320        "    pad: 1 "
2321        "    weight_filler { "
2322        "      type: 'gaussian' "
2323        "      std: 0.01 "
2324        "    } "
2325        "    bias_filler { "
2326        "      type: 'constant' "
2327        "      value: 0. "
2328        "    } "
2329        "  } "
2330        "  blobs_lr: 1. "
2331        "  blobs_lr: 2. "
2332        "  weight_decay: 1. "
2333        "  weight_decay: 0. "
2334        "  bottom: 'norm2' "
2335        "  top: 'conv3' "
2336        "} "
2337        "layers { "
2338        "  name: 'relu3' "
2339        "  type: RELU "
2340        "  bottom: 'conv3' "
2341        "  top: 'conv3' "
2342        "} "
2343        "layers { "
2344        "  name: 'conv4' "
2345        "  type: CONVOLUTION "
2346        "  convolution_param { "
2347        "    num_output: 384 "
2348        "    group: 2 "
2349        "    kernel_size: 3 "
2350        "    pad: 1 "
2351        "    weight_filler { "
2352        "      type: 'gaussian' "
2353        "      std: 0.01 "
2354        "    } "
2355        "    bias_filler { "
2356        "      type: 'constant' "
2357        "      value: 1. "
2358        "    } "
2359        "  } "
2360        "  blobs_lr: 1. "
2361        "  blobs_lr: 2. "
2362        "  weight_decay: 1. "
2363        "  weight_decay: 0. "
2364        "  bottom: 'conv3' "
2365        "  top: 'conv4' "
2366        "} "
2367        "layers { "
2368        "  name: 'relu4' "
2369        "  type: RELU "
2370        "  bottom: 'conv4' "
2371        "  top: 'conv4' "
2372        "} "
2373        "layers { "
2374        "  name: 'conv5' "
2375        "  type: CONVOLUTION "
2376        "  convolution_param { "
2377        "    num_output: 256 "
2378        "    group: 2 "
2379        "    kernel_size: 3 "
2380        "    pad: 1 "
2381        "    weight_filler { "
2382        "      type: 'gaussian' "
2383        "      std: 0.01 "
2384        "    } "
2385        "    bias_filler { "
2386        "      type: 'constant' "
2387        "      value: 1. "
2388        "    } "
2389        "  } "
2390        "  blobs_lr: 1. "
2391        "  blobs_lr: 2. "
2392        "  weight_decay: 1. "
2393        "  weight_decay: 0. "
2394        "  bottom: 'conv4' "
2395        "  top: 'conv5' "
2396        "} "
2397        "layers { "
2398        "  name: 'relu5' "
2399        "  type: RELU "
2400        "  bottom: 'conv5' "
2401        "  top: 'conv5' "
2402        "} "
2403        "layers { "
2404        "  name: 'pool5' "
2405        "  type: POOLING "
2406        "  pooling_param { "
2407        "    kernel_size: 3 "
2408        "    pool: MAX "
2409        "    stride: 2 "
2410        "  } "
2411        "  bottom: 'conv5' "
2412        "  top: 'pool5' "
2413        "} "
2414        "layers { "
2415        "  name: 'fc6' "
2416        "  type: INNER_PRODUCT "
2417        "  inner_product_param { "
2418        "    num_output: 4096 "
2419        "    weight_filler { "
2420        "      type: 'gaussian' "
2421        "      std: 0.005 "
2422        "    } "
2423        "    bias_filler { "
2424        "      type: 'constant' "
2425        "      value: 1. "
2426        "    } "
2427        "  } "
2428        "  blobs_lr: 1. "
2429        "  blobs_lr: 2. "
2430        "  weight_decay: 1. "
2431        "  weight_decay: 0. "
2432        "  bottom: 'pool5' "
2433        "  top: 'fc6' "
2434        "} "
2435        "layers { "
2436        "  name: 'relu6' "
2437        "  type: RELU "
2438        "  bottom: 'fc6' "
2439        "  top: 'fc6' "
2440        "} "
2441        "layers { "
2442        "  name: 'drop6' "
2443        "  type: DROPOUT "
2444        "  dropout_param { "
2445        "    dropout_ratio: 0.5 "
2446        "  } "
2447        "  bottom: 'fc6' "
2448        "  top: 'fc6' "
2449        "} "
2450        "layers { "
2451        "  name: 'fc7' "
2452        "  type: INNER_PRODUCT "
2453        "  inner_product_param { "
2454        "    num_output: 4096 "
2455        "    weight_filler { "
2456        "      type: 'gaussian' "
2457        "      std: 0.005 "
2458        "    } "
2459        "    bias_filler { "
2460        "      type: 'constant' "
2461        "      value: 1. "
2462        "    } "
2463        "  } "
2464        "  blobs_lr: 1. "
2465        "  blobs_lr: 2. "
2466        "  weight_decay: 1. "
2467        "  weight_decay: 0. "
2468        "  bottom: 'fc6' "
2469        "  top: 'fc7' "
2470        "} "
2471        "layers { "
2472        "  name: 'relu7' "
2473        "  type: RELU "
2474        "  bottom: 'fc7' "
2475        "  top: 'fc7' "
2476        "} "
2477        "layers { "
2478        "  name: 'drop7' "
2479        "  type: DROPOUT "
2480        "  dropout_param { "
2481        "    dropout_ratio: 0.5 "
2482        "  } "
2483        "  bottom: 'fc7' "
2484        "  top: 'fc7' "
2485        "} "
2486        "layers { "
2487        "  name: 'fc8' "
2488        "  type: INNER_PRODUCT "
2489        "  inner_product_param { "
2490        "    num_output: 1000 "
2491        "    weight_filler { "
2492        "      type: 'gaussian' "
2493        "      std: 0.01 "
2494        "    } "
2495        "    bias_filler { "
2496        "      type: 'constant' "
2497        "      value: 0 "
2498        "    } "
2499        "  } "
2500        "  blobs_lr: 1. "
2501        "  blobs_lr: 2. "
2502        "  weight_decay: 1. "
2503        "  weight_decay: 0. "
2504        "  bottom: 'fc7' "
2505        "  top: 'fc8' "
2506        "} "
2507        "layers { "
2508        "  name: 'loss' "
2509        "  type: SOFTMAX_LOSS "
2510        "  bottom: 'fc8' "
2511        "  bottom: 'label' "
2512        "} ";
2513    this->RunV0UpgradeTest(v0_proto, expected_v1_proto);
2514    const string& expected_v2_proto =
2515        "name: 'CaffeNet' "
2516        "layer { "
2517        "  name: 'data' "
2518        "  type: 'Data' "
2519        "  data_param { "
2520        "    source: '/home/jiayq/Data/ILSVRC12/train-leveldb' "
2521        "    batch_size: 256 "
2522        "  } "
2523        "  transform_param { "
2524        "    crop_size: 227 "
2525        "    mirror: true "
2526        "    mean_file: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
2527        "  } "
2528        "  top: 'data' "
2529        "  top: 'label' "
2530        "} "
2531        "layer { "
2532        "  name: 'conv1' "
2533        "  type: 'Convolution' "
2534        "  convolution_param { "
2535        "    num_output: 96 "
2536        "    kernel_size: 11 "
2537        "    stride: 4 "
2538        "    weight_filler { "
2539        "      type: 'gaussian' "
2540        "      std: 0.01 "
2541        "    } "
2542        "    bias_filler { "
2543        "      type: 'constant' "
2544        "      value: 0. "
2545        "    } "
2546        "  } "
2547        "  param { "
2548        "    lr_mult: 1 "
2549        "    decay_mult: 1 "
2550        "  } "
2551        "  param { "
2552        "    lr_mult: 2 "
2553        "    decay_mult: 0 "
2554        "  } "
2555        "  bottom: 'data' "
2556        "  top: 'conv1' "
2557        "} "
2558        "layer { "
2559        "  name: 'relu1' "
2560        "  type: 'ReLU' "
2561        "  bottom: 'conv1' "
2562        "  top: 'conv1' "
2563        "} "
2564        "layer { "
2565        "  name: 'pool1' "
2566        "  type: 'Pooling' "
2567        "  pooling_param { "
2568        "    pool: MAX "
2569        "    kernel_size: 3 "
2570        "    stride: 2 "
2571        "  } "
2572        "  bottom: 'conv1' "
2573        "  top: 'pool1' "
2574        "} "
2575        "layer { "
2576        "  name: 'norm1' "
2577        "  type: 'LRN' "
2578        "  lrn_param { "
2579        "    local_size: 5 "
2580        "    alpha: 0.0001 "
2581        "    beta: 0.75 "
2582        "  } "
2583        "  bottom: 'pool1' "
2584        "  top: 'norm1' "
2585        "} "
2586        "layer { "
2587        "  name: 'conv2' "
2588        "  type: 'Convolution' "
2589        "  convolution_param { "
2590        "    num_output: 256 "
2591        "    group: 2 "
2592        "    kernel_size: 5 "
2593        "    pad: 2 "
2594        "    weight_filler { "
2595        "      type: 'gaussian' "
2596        "      std: 0.01 "
2597        "    } "
2598        "    bias_filler { "
2599        "      type: 'constant' "
2600        "      value: 1. "
2601        "    } "
2602        "  } "
2603        "  param { "
2604        "    lr_mult: 1 "
2605        "    decay_mult: 1 "
2606        "  } "
2607        "  param { "
2608        "    lr_mult: 2 "
2609        "    decay_mult: 0 "
2610        "  } "
2611        "  bottom: 'norm1' "
2612        "  top: 'conv2' "
2613        "} "
2614        "layer { "
2615        "  name: 'relu2' "
2616        "  type: 'ReLU' "
2617        "  bottom: 'conv2' "
2618        "  top: 'conv2' "
2619        "} "
2620        "layer { "
2621        "  name: 'pool2' "
2622        "  type: 'Pooling' "
2623        "  pooling_param { "
2624        "    pool: MAX "
2625        "    kernel_size: 3 "
2626        "    stride: 2 "
2627        "  } "
2628        "  bottom: 'conv2' "
2629        "  top: 'pool2' "
2630        "} "
2631        "layer { "
2632        "  name: 'norm2' "
2633        "  type: 'LRN' "
2634        "  lrn_param { "
2635        "    local_size: 5 "
2636        "    alpha: 0.0001 "
2637        "    beta: 0.75 "
2638        "  } "
2639        "  bottom: 'pool2' "
2640        "  top: 'norm2' "
2641        "} "
2642        "layer { "
2643        "  name: 'conv3' "
2644        "  type: 'Convolution' "
2645        "  convolution_param { "
2646        "    num_output: 384 "
2647        "    kernel_size: 3 "
2648        "    pad: 1 "
2649        "    weight_filler { "
2650        "      type: 'gaussian' "
2651        "      std: 0.01 "
2652        "    } "
2653        "    bias_filler { "
2654        "      type: 'constant' "
2655        "      value: 0. "
2656        "    } "
2657        "  } "
2658        "  param { "
2659        "    lr_mult: 1 "
2660        "    decay_mult: 1 "
2661        "  } "
2662        "  param { "
2663        "    lr_mult: 2 "
2664        "    decay_mult: 0 "
2665        "  } "
2666        "  bottom: 'norm2' "
2667        "  top: 'conv3' "
2668        "} "
2669        "layer { "
2670        "  name: 'relu3' "
2671        "  type: 'ReLU' "
2672        "  bottom: 'conv3' "
2673        "  top: 'conv3' "
2674        "} "
2675        "layer { "
2676        "  name: 'conv4' "
2677        "  type: 'Convolution' "
2678        "  convolution_param { "
2679        "    num_output: 384 "
2680        "    group: 2 "
2681        "    kernel_size: 3 "
2682        "    pad: 1 "
2683        "    weight_filler { "
2684        "      type: 'gaussian' "
2685        "      std: 0.01 "
2686        "    } "
2687        "    bias_filler { "
2688        "      type: 'constant' "
2689        "      value: 1. "
2690        "    } "
2691        "  } "
2692        "  param { "
2693        "    lr_mult: 1 "
2694        "    decay_mult: 1 "
2695        "  } "
2696        "  param { "
2697        "    lr_mult: 2 "
2698        "    decay_mult: 0 "
2699        "  } "
2700        "  bottom: 'conv3' "
2701        "  top: 'conv4' "
2702        "} "
2703        "layer { "
2704        "  name: 'relu4' "
2705        "  type: 'ReLU' "
2706        "  bottom: 'conv4' "
2707        "  top: 'conv4' "
2708        "} "
2709        "layer { "
2710        "  name: 'conv5' "
2711        "  type: 'Convolution' "
2712        "  convolution_param { "
2713        "    num_output: 256 "
2714        "    group: 2 "
2715        "    kernel_size: 3 "
2716        "    pad: 1 "
2717        "    weight_filler { "
2718        "      type: 'gaussian' "
2719        "      std: 0.01 "
2720        "    } "
2721        "    bias_filler { "
2722        "      type: 'constant' "
2723        "      value: 1. "
2724        "    } "
2725        "  } "
2726        "  param { "
2727        "    lr_mult: 1 "
2728        "    decay_mult: 1 "
2729        "  } "
2730        "  param { "
2731        "    lr_mult: 2 "
2732        "    decay_mult: 0 "
2733        "  } "
2734        "  bottom: 'conv4' "
2735        "  top: 'conv5' "
2736        "} "
2737        "layer { "
2738        "  name: 'relu5' "
2739        "  type: 'ReLU' "
2740        "  bottom: 'conv5' "
2741        "  top: 'conv5' "
2742        "} "
2743        "layer { "
2744        "  name: 'pool5' "
2745        "  type: 'Pooling' "
2746        "  pooling_param { "
2747        "    kernel_size: 3 "
2748        "    pool: MAX "
2749        "    stride: 2 "
2750        "  } "
2751        "  bottom: 'conv5' "
2752        "  top: 'pool5' "
2753        "} "
2754        "layer { "
2755        "  name: 'fc6' "
2756        "  type: 'InnerProduct' "
2757        "  inner_product_param { "
2758        "    num_output: 4096 "
2759        "    weight_filler { "
2760        "      type: 'gaussian' "
2761        "      std: 0.005 "
2762        "    } "
2763        "    bias_filler { "
2764        "      type: 'constant' "
2765        "      value: 1. "
2766        "    } "
2767        "  } "
2768        "  param { "
2769        "    lr_mult: 1 "
2770        "    decay_mult: 1 "
2771        "  } "
2772        "  param { "
2773        "    lr_mult: 2 "
2774        "    decay_mult: 0 "
2775        "  } "
2776        "  bottom: 'pool5' "
2777        "  top: 'fc6' "
2778        "} "
2779        "layer { "
2780        "  name: 'relu6' "
2781        "  type: 'ReLU' "
2782        "  bottom: 'fc6' "
2783        "  top: 'fc6' "
2784        "} "
2785        "layer { "
2786        "  name: 'drop6' "
2787        "  type: 'Dropout' "
2788        "  dropout_param { "
2789        "    dropout_ratio: 0.5 "
2790        "  } "
2791        "  bottom: 'fc6' "
2792        "  top: 'fc6' "
2793        "} "
2794        "layer { "
2795        "  name: 'fc7' "
2796        "  type: 'InnerProduct' "
2797        "  inner_product_param { "
2798        "    num_output: 4096 "
2799        "    weight_filler { "
2800        "      type: 'gaussian' "
2801        "      std: 0.005 "
2802        "    } "
2803        "    bias_filler { "
2804        "      type: 'constant' "
2805        "      value: 1. "
2806        "    } "
2807        "  } "
2808        "  param { "
2809        "    lr_mult: 1 "
2810        "    decay_mult: 1 "
2811        "  } "
2812        "  param { "
2813        "    lr_mult: 2 "
2814        "    decay_mult: 0 "
2815        "  } "
2816        "  bottom: 'fc6' "
2817        "  top: 'fc7' "
2818        "} "
2819        "layer { "
2820        "  name: 'relu7' "
2821        "  type: 'ReLU' "
2822        "  bottom: 'fc7' "
2823        "  top: 'fc7' "
2824        "} "
2825        "layer { "
2826        "  name: 'drop7' "
2827        "  type: 'Dropout' "
2828        "  dropout_param { "
2829        "    dropout_ratio: 0.5 "
2830        "  } "
2831        "  bottom: 'fc7' "
2832        "  top: 'fc7' "
2833        "} "
2834        "layer { "
2835        "  name: 'fc8' "
2836        "  type: 'InnerProduct' "
2837        "  inner_product_param { "
2838        "    num_output: 1000 "
2839        "    weight_filler { "
2840        "      type: 'gaussian' "
2841        "      std: 0.01 "
2842        "    } "
2843        "    bias_filler { "
2844        "      type: 'constant' "
2845        "      value: 0 "
2846        "    } "
2847        "  } "
2848        "  param { "
2849        "    lr_mult: 1 "
2850        "    decay_mult: 1 "
2851        "  } "
2852        "  param { "
2853        "    lr_mult: 2 "
2854        "    decay_mult: 0 "
2855        "  } "
2856        "  bottom: 'fc7' "
2857        "  top: 'fc8' "
2858        "} "
2859        "layer { "
2860        "  name: 'loss' "
2861        "  type: 'SoftmaxWithLoss' "
2862        "  bottom: 'fc8' "
2863        "  bottom: 'label' "
2864        "} ";
2865    this->RunV1UpgradeTest(expected_v1_proto, expected_v2_proto);
2866  }  
2867  TEST_F(NetUpgradeTest, TestUpgradeV1LayerType) {
2868    LayerParameter layer_param;
2869    shared_ptr<Layer<float> > layer;
2870    for (int i = 0; i < V1LayerParameter_LayerType_LayerType_ARRAYSIZE; ++i) {
2871      ASSERT_TRUE(V1LayerParameter_LayerType_IsValid(i));
2872      V1LayerParameter_LayerType v1_type = V1LayerParameter_LayerType(i);
2873      string v2_layer_type(UpgradeV1LayerType(v1_type));
2874      if (v2_layer_type == "") {
2875        EXPECT_EQ(V1LayerParameter_LayerType_NONE, v1_type);
2876        continue;  
2877      }
2878      layer_param.set_type(v2_layer_type);
2879      if (v2_layer_type == "Data") {
2880        #ifdef USE_LEVELDB
2881        string tmp;
2882        MakeTempDir(&tmp);
2883        boost::scoped_ptr<db::DB> db(db::GetDB(DataParameter_DB_LEVELDB));
2884        db->Open(tmp, db::NEW);
2885        db->Close();
2886        layer_param.mutable_data_param()->set_source(tmp);
2887        #else
2888        continue;
2889        #endif  
2890      }
2891      #ifndef USE_OPENCV
2892      if (v2_layer_type == "ImageData" || v2_layer_type == "WindowData") {
2893       continue;
2894      }
2895      #endif  
2896      layer = LayerRegistry<float>::CreateLayer(layer_param);
2897      EXPECT_EQ(v2_layer_type, layer->type());
2898    }
2899  }
2900  class SolverTypeUpgradeTest : public ::testing::Test {
2901   protected:
2902    void RunSolverTypeUpgradeTest(
2903        const string& input_param_string, const string& output_param_string) {
2904      SolverParameter input_param;
2905      CHECK(google::protobuf::TextFormat::ParseFromString(
2906          input_param_string, &input_param));
2907      SolverParameter expected_output_param;
2908      CHECK(google::protobuf::TextFormat::ParseFromString(
2909          output_param_string, &expected_output_param));
2910      SolverParameter actual_output_param = input_param;
2911      UpgradeSolverType(&actual_output_param);
2912      EXPECT_EQ(expected_output_param.DebugString(),
2913          actual_output_param.DebugString());
2914    }
2915  };
2916  TEST_F(SolverTypeUpgradeTest, TestSimple) {
2917    const char* old_type_vec[6] = { "SGD", "ADAGRAD", "NESTEROV", "RMSPROP",
2918        "ADADELTA", "ADAM" };
2919    const char* new_type_vec[6] = { "SGD", "AdaGrad", "Nesterov", "RMSProp",
2920        "AdaDelta", "Adam" };
2921    for (int i = 0; i < 6; ++i) {
2922      const string& input_proto =
2923          "net: 'examples/mnist/lenet_train_test.prototxt' "
2924          "test_iter: 100 "
2925          "test_interval: 500 "
2926          "base_lr: 0.01 "
2927          "momentum: 0.0 "
2928          "weight_decay: 0.0005 "
2929          "lr_policy: 'inv' "
2930          "gamma: 0.0001 "
2931          "power: 0.75 "
2932          "display: 100 "
2933          "max_iter: 10000 "
2934          "snapshot: 5000 "
2935          "snapshot_prefix: 'examples/mnist/lenet_rmsprop' "
2936          "solver_mode: GPU "
2937          "solver_type: " + std::string(old_type_vec[i]) + " ";
2938      const string& expected_output_proto =
2939          "net: 'examples/mnist/lenet_train_test.prototxt' "
2940          "test_iter: 100 "
2941          "test_interval: 500 "
2942          "base_lr: 0.01 "
2943          "momentum: 0.0 "
2944          "weight_decay: 0.0005 "
2945          "lr_policy: 'inv' "
2946          "gamma: 0.0001 "
2947          "power: 0.75 "
2948          "display: 100 "
2949          "max_iter: 10000 "
2950          "snapshot: 5000 "
2951          "snapshot_prefix: 'examples/mnist/lenet_rmsprop' "
2952          "solver_mode: GPU "
2953          "type: '" + std::string(new_type_vec[i]) + "' ";
2954      this->RunSolverTypeUpgradeTest(input_proto, expected_output_proto);
2955    }
2956  }
2957  }  
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from tesseract-MDEwOlJlcG9zaXRvcnkyMjg4NzA5NA==-flat-tabvector_test.cc</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from caffe-MDEwOlJlcG9zaXRvcnk2MTg3MDgwMw==-flat-test_upgrade_proto.cpp</div>
                </div>
                <div class="column column_space"><pre><code>64    int x = vector_->XAtY(6136);                 
65    EXPECT_EQ(7886, x);
66  }
67  TEST_F(TabVectorTest, XAtYHorizontalInRangeExact) {
68    const int y = 120; 
69    MakeSimpleTabVector(50, y, 150, y);
70    int x = vector_->XAtY(y);
71    EXPECT_EQ(50, x);
72  }
73  TEST_F(TabVectorTest, VOverlapInRangeSimple) {
74    MakeSimpleTabVector(0, 0, 100, 100);
75    int overlap = vector_->VOverlap(90, 10);
</pre></code></div>
                <div class="column column_space"><pre><code>111    const string& expected_output_proto =
112        "name: 'CaffeNet' "
113        "layers { "
114        "  layer { "
115        "    name: 'data' "
116        "    type: 'data' "
117        "    source: '/home/jiayq/Data/ILSVRC12/train-leveldb' "
118        "    meanfile: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
119        "    batchsize: 256 "
120        "    cropsize: 227 "
121        "    mirror: true "
122        "  } "
123        "  top: 'data' "
124        "  top: 'label' "
125        "} "
126        "layers { "
127        "  layer { "
128        "    name: 'conv1' "
129        "    type: 'conv' "
130        "    num_output: 96 "
131        "    kernelsize: 11 "
132        "    stride: 4 "
133        "    pad: 2 "
134        "    weight_filler { "
135        "      type: 'gaussian' "
136        "      std: 0.01 "
137        "    } "
138        "    bias_filler { "
139        "      type: 'constant' "
140        "      value: 0. "
141        "    } "
142        "    blobs_lr: 1. "
143        "    blobs_lr: 2. "
144        "    weight_decay: 1. "
145        "    weight_decay: 0. "
146        "  } "
147        "  bottom: 'data' "
148        "  top: 'conv1' "
149        "} "
150        "layers { "
151        "  layer { "
152        "    name: 'fc8' "
153        "    type: 'innerproduct' "
154        "    num_output: 1000 "
155        "    weight_filler { "
156        "      type: 'gaussian' "
157        "      std: 0.01 "
158        "    } "
159        "    bias_filler { "
160        "      type: 'constant' "
161        "      value: 0 "
162        "    } "
163        "    blobs_lr: 1. "
164        "    blobs_lr: 2. "
165        "    weight_decay: 1. "
166        "    weight_decay: 0. "
167        "  } "
168        "  bottom: 'conv1' "
169        "  top: 'fc8' "
170        "} "
171        "layers { "
172        "  layer { "
173        "    name: 'loss' "
174        "    type: 'softmax_loss' "
175        "  } "
176        "  bottom: 'fc8' "
177        "  bottom: 'label' "
178        "} ";
179    this->RunPaddingUpgradeTest(input_proto, expected_output_proto);
180  }
181  TEST_F(PaddingLayerUpgradeTest, TestTwoTops) {
182    const string& input_proto =
183        "name: 'CaffeNet' "
184        "layers { "
185        "  layer { "
186        "    name: 'data' "
187        "    type: 'data' "
188        "    source: '/home/jiayq/Data/ILSVRC12/train-leveldb' "
189        "    meanfile: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
190        "    batchsize: 256 "
191        "    cropsize: 227 "
192        "    mirror: true "
193        "  } "
194        "  top: 'data' "
195        "  top: 'label' "
196        "} "
197        "layers { "
198        "  layer { "
199        "    name: 'pad1' "
200        "    type: 'padding' "
201        "    pad: 2 "
202        "  } "
203        "  bottom: 'data' "
204        "  top: 'pad1' "
205        "} "
206        "layers { "
207        "  layer { "
208        "    name: 'conv1' "
209        "    type: 'conv' "
210        "    num_output: 96 "
211        "    kernelsize: 11 "
212        "    stride: 4 "
213        "    weight_filler { "
214        "      type: 'gaussian' "
215        "      std: 0.01 "
216        "    } "
217        "    bias_filler { "
218        "      type: 'constant' "
219        "      value: 0. "
220        "    } "
221        "    blobs_lr: 1. "
222        "    blobs_lr: 2. "
223        "    weight_decay: 1. "
224        "    weight_decay: 0. "
225        "  } "
226        "  bottom: 'pad1' "
227        "  top: 'conv1' "
228        "} "
229        "layers { "
230        "  layer { "
231        "    name: 'fc8' "
232        "    type: 'innerproduct' "
233        "    num_output: 1000 "
234        "    weight_filler { "
235        "      type: 'gaussian' "
236        "      std: 0.01 "
237        "    } "
238        "    bias_filler { "
239        "      type: 'constant' "
240        "      value: 0 "
241        "    } "
242        "    blobs_lr: 1. "
243        "    blobs_lr: 2. "
244        "    weight_decay: 1. "
245        "    weight_decay: 0. "
246        "  } "
247        "  bottom: 'conv1' "
248        "  top: 'fc8' "
249        "} "
250        "layers { "
251        "  layer { "
252        "    name: 'conv2' "
253        "    type: 'conv' "
254        "    num_output: 96 "
255        "    kernelsize: 11 "
256        "    stride: 4 "
257        "    weight_filler { "
258        "      type: 'gaussian' "
259        "      std: 0.01 "
260        "    } "
261        "    bias_filler { "
262        "      type: 'constant' "
263        "      value: 0. "
264        "    } "
265        "    blobs_lr: 1. "
266        "    blobs_lr: 2. "
267        "    weight_decay: 1. "
268        "    weight_decay: 0. "
269        "  } "
270        "  bottom: 'pad1' "
271        "  top: 'conv2' "
272        "} "
273        "layers { "
274        "  layer { "
275        "    name: 'loss' "
276        "    type: 'softmax_loss' "
277        "  } "
278        "  bottom: 'fc8' "
279        "  bottom: 'label' "
280        "} ";
281    const string& expected_output_proto =
282        "name: 'CaffeNet' "
283        "layers { "
284        "  layer { "
285        "    name: 'data' "
286        "    type: 'data' "
287        "    source: '/home/jiayq/Data/ILSVRC12/train-leveldb' "
288        "    meanfile: '/home/jiayq/Data/ILSVRC12/image_mean.binaryproto' "
289        "    batchsize: 256 "
290        "    cropsize: 227 "
291        "    mirror: true "
292        "  } "
293        "  top: 'data' "
294        "  top: 'label' "
295        "} "
296        "layers { "
297        "  layer { "
298        "    name: 'conv1' "
299        "    type: 'conv' "
300        "    num_output: 96 "
301        "    kernelsize: 11 "
302        "    stride: 4 "
303        "    pad: 2 "
304        "    weight_filler { "
305        "      type: 'gaussian' "
306        "      std: 0.01 "
307        "    } "
308        "    bias_filler { "
309        "      type: 'constant' "
310        "      value: 0. "
311        "    } "
312        "    blobs_lr: 1. "
313        "    blobs_lr: 2. "
314        "    weight_decay: 1. "
315        "    weight_decay: 0. "
316        "  } "
317        "  bottom: 'data' "
318        "  top: 'conv1' "
319        "} "
320        "layers { "
321        "  layer { "
322        "    name: 'fc8' "
323        "    type: 'innerproduct' "
324        "    num_output: 1000 "
325        "    weight_filler { "
326        "      type: 'gaussian' "
327        "      std: 0.01 "
328        "    } "
329        "    bias_filler { "
330        "      type: 'constant' "
331        "      value: 0 "
332        "    } "
333        "    blobs_lr: 1. "
334        "    blobs_lr: 2. "
335        "    weight_decay: 1. "
336        "    weight_decay: 0. "
337        "  } "
338        "  bottom: 'conv1' "
339        "  top: 'fc8' "
340        "} "
341        "layers { "
342        "  layer { "
343        "    name: 'conv2' "
344        "    type: 'conv' "
345        "    num_output: 96 "
346        "    kernelsize: 11 "
347        "    stride: 4 "
348        "    pad: 2 "
349        "    weight_filler { "
350        "      type: 'gaussian' "
351        "      std: 0.01 "
352        "    } "
353        "    bias_filler { "
354        "      type: 'constant' "
355        "      value: 0. "
356        "    } "
357        "    blobs_lr: 1. "
358        "    blobs_lr: 2. "
359        "    weight_decay: 1. "
360        "    weight_decay: 0. "
361        "  } "
362        "  bottom: 'data' "
363        "  top: 'conv2' "
364        "} "
365        "layers { "
366        "  layer { "
367        "    name: 'loss' "
368        "    type: 'softmax_loss' "
369        "  } "
370        "  bottom: 'fc8' "
371        "  bottom: 'label' "
372        "} ";
373    this->RunPaddingUpgradeTest(input_proto, expected_output_proto);
374  }
375  TEST_F(PaddingLayerUpgradeTest, TestImageNet) {
376    const string& input_proto =
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    