
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 33, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ExecutionContextL0.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Linq;
4  using System.Runtime.CompilerServices;
5  using System.Threading;
6  using GitHub.DistributedTask.Pipelines.ContextData;
7  using GitHub.DistributedTask.WebApi;
8  using GitHub.Runner.Worker;
9  using GitHub.Runner.Worker.Container;
10  using GitHub.Runner.Worker.Handlers;
11  using Moq;
12  using Xunit;
13  using GitHub.DistributedTask.ObjectTemplating.Tokens;
14  using Pipelines = GitHub.DistributedTask.Pipelines;
15  namespace GitHub.Runner.Common.Tests.Worker
16  {
17      public sealed class ExecutionContextL0
18      {
19          [Fact]
20          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
21          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
22          public void AddIssue_CountWarningsErrors()
23          {
24              using (TestHostContext hc = CreateTestContext())
25              {
26                  TaskOrchestrationPlanReference plan = new();
27                  TimelineReference timeline = new();
28                  Guid jobId = Guid.NewGuid();
29                  string jobName = &quot;some job name&quot;;
30                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
31                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
32                  {
33                      Alias = Pipelines.PipelineConstants.SelfAlias,
34                      Id = &quot;github&quot;,
35                      Version = &quot;sha1&quot;
36                  });
37                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
38                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
39                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
40                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
41                  hc.EnqueueInstance(pagingLogger.Object);
42                  hc.SetSingleton(jobServerQueue.Object);
43                  var ec = new Runner.Worker.ExecutionContext();
44                  ec.Initialize(hc);
45                  ec.InitializeJob(jobRequest, CancellationToken.None);
46                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
47                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
48                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
49                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
50                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
51                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
52                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
53                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
54                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
55                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
56                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
57                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
58                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
59                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
60                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
61                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
62                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
63                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
64                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
65                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
66                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
67                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
68                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
69                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
70                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
71                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
72                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
73                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
74                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
75                  ec.Complete();
76                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.ErrorCount &gt; 0)), Times.AtLeast(10));
77                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.WarningCount &gt; 0)), Times.AtLeast(10));
78                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.Issues.Where(i =&gt; i.Type == IssueType.Error).Count() == 10)), Times.AtLeastOnce);
79                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.Issues.Where(i =&gt; i.Type == IssueType.Warning).Count() == 10)), Times.AtLeastOnce);
80              }
81          }
82          [Fact]
83          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
84          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
85          public void ApplyContinueOnError_CheckResultAndOutcome()
86          {
87              using (TestHostContext hc = CreateTestContext())
88              {
89                  TaskOrchestrationPlanReference plan = new();
90                  TimelineReference timeline = new();
91                  Guid jobId = Guid.NewGuid();
92                  string jobName = &quot;some job name&quot;;
93                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
94                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
95                  {
96                      Alias = Pipelines.PipelineConstants.SelfAlias,
97                      Id = &quot;github&quot;,
98                      Version = &quot;sha1&quot;
99                  });
100                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
101                  jobRequest.Variables[&quot;ACTIONS_STEP_DEBUG&quot;] = &quot;true&quot;;
102                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
103                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
104                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
105                  jobServerQueue.Setup(x =&gt; x.QueueWebConsoleLine(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;long&gt;())).Callback((Guid id, string msg, long? lineNumber) =&gt; { hc.GetTrace().Info(msg); });
106                  hc.EnqueueInstance(pagingLogger.Object);
107                  hc.SetSingleton(jobServerQueue.Object);
108                  var ec = new Runner.Worker.ExecutionContext();
109                  ec.Initialize(hc);
110                  ec.InitializeJob(jobRequest, CancellationToken.None);
111                  foreach (var tc in new List&lt;(TemplateToken token, TaskResult result, TaskResult? expectedResult, TaskResult? expectedOutcome)&gt; {
112                  (token: new BooleanToken(null, null, null, true), result: TaskResult.Failed, expectedResult: TaskResult.Succeeded, expectedOutcome: TaskResult.Failed),
113                  (token: new BooleanToken(null, null, null, true), result: TaskResult.Succeeded, expectedResult: TaskResult.Succeeded, expectedOutcome: null),
114                  (token: new BooleanToken(null, null, null, true), result: TaskResult.Canceled, expectedResult: TaskResult.Canceled, expectedOutcome: null),
115                  (token: new BooleanToken(null, null, null, false), result: TaskResult.Failed, expectedResult: TaskResult.Failed, expectedOutcome: null),
116                  (token: new BooleanToken(null, null, null, false), result: TaskResult.Succeeded, expectedResult: TaskResult.Succeeded, expectedOutcome: null),
117                  (token: new BooleanToken(null, null, null, false), result: TaskResult.Canceled, expectedResult: TaskResult.Canceled, expectedOutcome: null),
118              })
119                  {
120                      ec.Result = tc.result;
121                      ec.Outcome = null;
122                      ec.ApplyContinueOnError(tc.token);
123                      Assert.Equal(ec.Result, tc.expectedResult);
124                      Assert.Equal(ec.Outcome, tc.expectedOutcome);
125                  }
126              }
127          }
128          [Fact]
129          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
130          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
131          public void AddIssue_TrimMessageSize()
132          {
133              using (TestHostContext hc = CreateTestContext())
134              {
135                  TaskOrchestrationPlanReference plan = new();
136                  TimelineReference timeline = new();
137                  Guid jobId = Guid.NewGuid();
138                  string jobName = &quot;some job name&quot;;
139                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
140                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
141                  {
142                      Alias = Pipelines.PipelineConstants.SelfAlias,
143                      Id = &quot;github&quot;,
144                      Version = &quot;sha1&quot;
145                  });
146                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
147                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
148                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
149                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
150                  hc.EnqueueInstance(pagingLogger.Object);
151                  hc.SetSingleton(jobServerQueue.Object);
152                  var ec = new Runner.Worker.ExecutionContext();
153                  ec.Initialize(hc);
154                  ec.InitializeJob(jobRequest, CancellationToken.None);
155                  var bigMessage = &quot;&quot;;
156                  for (var i = 0; i &lt; 5000; i++)
157                  {
158                      bigMessage += &quot;a&quot;;
159                  }
160                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = bigMessage }, ExecutionContextLogOptions.Default);
161                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = bigMessage }, ExecutionContextLogOptions.Default);
162                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = bigMessage }, ExecutionContextLogOptions.Default);
163                  ec.Complete();
164                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.Issues.Where(i =&gt; i.Type == IssueType.Error).Single().Message.Length &lt;= 4096)), Times.AtLeastOnce);
165                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.Issues.Where(i =&gt; i.Type == IssueType.Warning).Single().Message.Length &lt;= 4096)), Times.AtLeastOnce);
166                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.Issues.Where(i =&gt; i.Type == IssueType.Notice).Single().Message.Length &lt;= 4096)), Times.AtLeastOnce);
167              }
168          }
169          [Fact]
170          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
171          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
172          public void AddIssue_OverrideLogMessage()
173          {
174              using (TestHostContext hc = CreateTestContext())
175              {
176                  TaskOrchestrationPlanReference plan = new();
177                  TimelineReference timeline = new();
178                  Guid jobId = Guid.NewGuid();
179                  string jobName = &quot;some job name&quot;;
180                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
181                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
182                  {
183                      Alias = Pipelines.PipelineConstants.SelfAlias,
184                      Id = &quot;github&quot;,
185                      Version = &quot;sha1&quot;
186                  });
187                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
188                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
189                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
190                  hc.EnqueueInstance(pagingLogger.Object);
191                  hc.SetSingleton(jobServerQueue.Object);
192                  var ec = new Runner.Worker.ExecutionContext();
193                  ec.Initialize(hc);
194                  ec.InitializeJob(jobRequest, CancellationToken.None);
195                  var issueMessage = &quot;Message embedded in issue.&quot;;
196                  var overrideMessage = &quot;Message override.&quot;;
197                  var options = new ExecutionContextLogOptions(true, overrideMessage);
198                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = issueMessage }, options);
199                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = issueMessage }, options);
200                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = issueMessage }, options);
201                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = issueMessage }, ExecutionContextLogOptions.Default);
202                  ec.Complete();
203                  jobServerQueue.Verify(x =&gt; x.QueueWebConsoleLine(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;long?&gt;()), Times.Exactly(4));
204                  jobServerQueue.Verify(x =&gt; x.QueueWebConsoleLine(It.IsAny&lt;Guid&gt;(), It.Is&lt;string&gt;(text =&gt; text.EndsWith(overrideMessage)), It.IsAny&lt;long?&gt;()), Times.Exactly(3));
205                  jobServerQueue.Verify(x =&gt; x.QueueWebConsoleLine(It.IsAny&lt;Guid&gt;(), It.Is&lt;string&gt;(text =&gt; text.EndsWith(issueMessage)), It.IsAny&lt;long?&gt;()), Times.Exactly(1));
206              }
207          }
208          [Fact]
209          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
210          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
211          public void AddIssue_AddStepAndLineNumberInformation()
212          {
213              using (TestHostContext hc = CreateTestContext())
214              {
215                  TaskOrchestrationPlanReference plan = new();
216                  TimelineReference timeline = new();
217                  Guid jobId = Guid.NewGuid();
218                  string jobName = &quot;some job name&quot;;
219                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
220                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
221                  {
222                      Alias = Pipelines.PipelineConstants.SelfAlias,
223                      Id = &quot;github&quot;,
224                      Version = &quot;sha1&quot;
225                  });
226                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
227                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
228                  var pagingLogger2 = new Mock&lt;IPagingLogger&gt;();
229                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
230                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
231                  hc.EnqueueInstance(pagingLogger.Object);
232                  hc.EnqueueInstance(pagingLogger2.Object);
233                  hc.SetSingleton(jobServerQueue.Object);
234                  var ec = new Runner.Worker.ExecutionContext();
235                  ec.Initialize(hc);
236                  ec.InitializeJob(jobRequest, CancellationToken.None);
237                  ec.Start();
238                  var embeddedStep = ec.CreateChild(Guid.NewGuid(), &quot;action_1_pre&quot;, &quot;action_1_pre&quot;, null, null, ActionRunStage.Main, isEmbedded: true);
239                  embeddedStep.Start();
240                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error annotation that should have step and line number information&quot; }, ExecutionContextLogOptions.Default);
241                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning annotation that should have step and line number information&quot; }, ExecutionContextLogOptions.Default);
242                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Notice, Message = &quot;notice annotation that should have step and line number information&quot; }, ExecutionContextLogOptions.Default);
243                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()), Times.AtLeastOnce);
244                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.Issues.Where(i =&gt; i.Data.ContainsKey(&quot;stepNumber&quot;) &amp;&amp; i.Data.ContainsKey(&quot;logFileLineNumber&quot;) &amp;&amp; i.Type == IssueType.Error).Count() == 1)), Times.Never);
245                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.Issues.Where(i =&gt; i.Data.ContainsKey(&quot;stepNumber&quot;) &amp;&amp; i.Data.ContainsKey(&quot;logFileLineNumber&quot;) &amp;&amp; i.Type == IssueType.Warning).Count() == 1)), Times.Never);
246                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.Issues.Where(i =&gt; i.Data.ContainsKey(&quot;stepNumber&quot;) &amp;&amp; i.Data.ContainsKey(&quot;logFileLineNumber&quot;) &amp;&amp; i.Type == IssueType.Notice).Count() == 1)), Times.Never);
247              }
248          }
249          [Fact]
250          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
251          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
252          public void Debug_Multilines()
253          {
254              using (TestHostContext hc = CreateTestContext())
255              {
256                  TaskOrchestrationPlanReference plan = new();
257                  TimelineReference timeline = new();
258                  Guid jobId = Guid.NewGuid();
259                  string jobName = &quot;some job name&quot;;
260                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
261                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
262                  {
263                      Alias = Pipelines.PipelineConstants.SelfAlias,
264                      Id = &quot;github&quot;,
265                      Version = &quot;sha1&quot;
266                  });
267                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
268                  jobRequest.Variables[&quot;ACTIONS_STEP_DEBUG&quot;] = &quot;true&quot;;
269                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
270                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
271                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
272                  jobServerQueue.Setup(x =&gt; x.QueueWebConsoleLine(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;long&gt;())).Callback((Guid id, string msg, long? lineNumber) =&gt; { hc.GetTrace().Info(msg); });
273                  hc.EnqueueInstance(pagingLogger.Object);
274                  hc.SetSingleton(jobServerQueue.Object);
275                  var ec = new Runner.Worker.ExecutionContext();
276                  ec.Initialize(hc);
277                  ec.InitializeJob(jobRequest, CancellationToken.None);
278                  ec.Debug(null);
279                  ec.Debug(&quot;&quot;);
280                  ec.Debug(&quot;\n&quot;);
281                  ec.Debug(&quot;\r\n&quot;);
282                  ec.Debug(&quot;test&quot;);
283                  ec.Debug(&quot;te\nst&quot;);
284                  ec.Debug(&quot;te\r\nst&quot;);
285                  ec.Complete();
286                  jobServerQueue.Verify(x =&gt; x.QueueWebConsoleLine(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;long?&gt;()), Times.Exactly(10));
287              }
288          }
289          [Fact]
290          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
291          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
292          public void RegisterPostJobAction_ShareState()
293          {
294              using (TestHostContext hc = CreateTestContext())
295              {
296                  TaskOrchestrationPlanReference plan = new();
297                  TimelineReference timeline = new();
298                  Guid jobId = Guid.NewGuid();
299                  string jobName = &quot;some job name&quot;;
300                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
301                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
302                  {
303                      Alias = Pipelines.PipelineConstants.SelfAlias,
304                      Id = &quot;github&quot;,
305                      Version = &quot;sha1&quot;
306                  });
307                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
308                  jobRequest.Variables[&quot;ACTIONS_STEP_DEBUG&quot;] = &quot;true&quot;;
309                  var pagingLogger1 = new Mock&lt;IPagingLogger&gt;();
310                  var pagingLogger2 = new Mock&lt;IPagingLogger&gt;();
311                  var pagingLogger3 = new Mock&lt;IPagingLogger&gt;();
312                  var pagingLogger4 = new Mock&lt;IPagingLogger&gt;();
313                  var pagingLogger5 = new Mock&lt;IPagingLogger&gt;();
314                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
315                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
316                  jobServerQueue.Setup(x =&gt; x.QueueWebConsoleLine(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;long?&gt;())).Callback((Guid id, string msg, long? lineNumber) =&gt; { hc.GetTrace().Info(msg); });
317                  var actionRunner1 = new ActionRunner();
318                  actionRunner1.Initialize(hc);
319                  var actionRunner2 = new ActionRunner();
320                  actionRunner2.Initialize(hc);
321                  hc.EnqueueInstance(pagingLogger1.Object);
322                  hc.EnqueueInstance(pagingLogger2.Object);
323                  hc.EnqueueInstance(pagingLogger3.Object);
324                  hc.EnqueueInstance(pagingLogger4.Object);
325                  hc.EnqueueInstance(pagingLogger5.Object);
326                  hc.EnqueueInstance(actionRunner1 as IActionRunner);
327                  hc.EnqueueInstance(actionRunner2 as IActionRunner);
328                  hc.SetSingleton(jobServerQueue.Object);
329                  var jobContext = new Runner.Worker.ExecutionContext();
330                  jobContext.Initialize(hc);
331                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
332                  var action1 = jobContext.CreateChild(Guid.NewGuid(), &quot;action_1&quot;, &quot;action_1&quot;, null, null, 0);
333                  action1.IntraActionState[&quot;state&quot;] = &quot;1&quot;;
334                  var action2 = jobContext.CreateChild(Guid.NewGuid(), &quot;action_2&quot;, &quot;action_2&quot;, null, null, 0);
335                  action2.IntraActionState[&quot;state&quot;] = &quot;2&quot;;
336                  var postRunner1 = hc.CreateService&lt;IActionRunner&gt;();
337                  postRunner1.Action = new Pipelines.ActionStep() { Id = Guid.NewGuid(), Name = &quot;post1&quot;, DisplayName = &quot;Test 1&quot;, Reference = new Pipelines.RepositoryPathReference() { Name = &quot;actions/action&quot; } };
338                  postRunner1.Stage = ActionRunStage.Post;
339                  postRunner1.Condition = &quot;always()&quot;;
340                  postRunner1.DisplayName = &quot;post1&quot;;
341                  var postRunner2 = hc.CreateService&lt;IActionRunner&gt;();
342                  postRunner2.Action = new Pipelines.ActionStep() { Id = Guid.NewGuid(), Name = &quot;post2&quot;, DisplayName = &quot;Test 2&quot;, Reference = new Pipelines.RepositoryPathReference() { Name = &quot;actions/action&quot; } };
343                  postRunner2.Stage = ActionRunStage.Post;
344                  postRunner2.Condition = &quot;always()&quot;;
345                  postRunner2.DisplayName = &quot;post2&quot;;
346                  action1.RegisterPostJobStep(postRunner1);
347                  action2.RegisterPostJobStep(postRunner2);
348                  Assert.NotNull(jobContext.JobSteps);
349                  Assert.NotNull(jobContext.PostJobSteps);
350                  Assert.Null(action1.JobSteps);
351                  Assert.Null(action2.JobSteps);
352                  Assert.Null(action1.PostJobSteps);
353                  Assert.Null(action2.PostJobSteps);
354                  var post1 = jobContext.PostJobSteps.Pop();
355                  var post2 = jobContext.PostJobSteps.Pop();
356                  Assert.Equal(&quot;post2&quot;, (post1 as IActionRunner).Action.Name);
357                  Assert.Equal(&quot;post1&quot;, (post2 as IActionRunner).Action.Name);
358                  Assert.Equal(ActionRunStage.Post, (post1 as IActionRunner).Stage);
359                  Assert.Equal(ActionRunStage.Post, (post2 as IActionRunner).Stage);
360                  Assert.Equal(&quot;always()&quot;, (post1 as IActionRunner).Condition);
361                  Assert.Equal(&quot;always()&quot;, (post2 as IActionRunner).Condition);
362                  Assert.Equal(&quot;2&quot;, (post1 as IActionRunner).ExecutionContext.IntraActionState[&quot;state&quot;]);
363                  Assert.Equal(&quot;1&quot;, (post2 as IActionRunner).ExecutionContext.IntraActionState[&quot;state&quot;]);
364              }
365          }
366          [Fact]
367          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
368          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
369          public void RegisterPostJobAction_NotRegisterPostTwice()
370          {
371              using (TestHostContext hc = CreateTestContext())
372              {
373                  TaskOrchestrationPlanReference plan = new();
374                  TimelineReference timeline = new();
375                  Guid jobId = Guid.NewGuid();
376                  string jobName = &quot;some job name&quot;;
377                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
378                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
379                  {
380                      Alias = Pipelines.PipelineConstants.SelfAlias,
381                      Id = &quot;github&quot;,
382                      Version = &quot;sha1&quot;
383                  });
384                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
385                  jobRequest.Variables[&quot;ACTIONS_STEP_DEBUG&quot;] = &quot;true&quot;;
386                  var pagingLogger1 = new Mock&lt;IPagingLogger&gt;();
387                  var pagingLogger2 = new Mock&lt;IPagingLogger&gt;();
388                  var pagingLogger3 = new Mock&lt;IPagingLogger&gt;();
389                  var pagingLogger4 = new Mock&lt;IPagingLogger&gt;();
390                  var pagingLogger5 = new Mock&lt;IPagingLogger&gt;();
391                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
392                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
393                  jobServerQueue.Setup(x =&gt; x.QueueWebConsoleLine(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;long?&gt;())).Callback((Guid id, string msg, long? lineNumber) =&gt; { hc.GetTrace().Info(msg); });
394                  var actionRunner1 = new ActionRunner();
395                  actionRunner1.Initialize(hc);
396                  var actionRunner2 = new ActionRunner();
397                  actionRunner2.Initialize(hc);
398                  hc.EnqueueInstance(pagingLogger1.Object);
399                  hc.EnqueueInstance(pagingLogger2.Object);
400                  hc.EnqueueInstance(pagingLogger3.Object);
401                  hc.EnqueueInstance(pagingLogger4.Object);
402                  hc.EnqueueInstance(pagingLogger5.Object);
403                  hc.EnqueueInstance(actionRunner1 as IActionRunner);
404                  hc.EnqueueInstance(actionRunner2 as IActionRunner);
405                  hc.SetSingleton(jobServerQueue.Object);
406                  var jobContext = new Runner.Worker.ExecutionContext();
407                  jobContext.Initialize(hc);
408                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
409                  var action1 = jobContext.CreateChild(Guid.NewGuid(), &quot;action_1_pre&quot;, &quot;action_1_pre&quot;, null, null, 0);
410                  var action2 = jobContext.CreateChild(Guid.NewGuid(), &quot;action_1_main&quot;, &quot;action_1_main&quot;, null, null, 0);
411                  var actionId = Guid.NewGuid();
412                  var postRunner1 = hc.CreateService&lt;IActionRunner&gt;();
413                  postRunner1.Action = new Pipelines.ActionStep() { Id = actionId, Name = &quot;post1&quot;, DisplayName = &quot;Test 1&quot;, Reference = new Pipelines.RepositoryPathReference() { Name = &quot;actions/action&quot; } };
414                  postRunner1.Stage = ActionRunStage.Post;
415                  postRunner1.Condition = &quot;always()&quot;;
416                  postRunner1.DisplayName = &quot;post1&quot;;
417                  var postRunner2 = hc.CreateService&lt;IActionRunner&gt;();
418                  postRunner2.Action = new Pipelines.ActionStep() { Id = actionId, Name = &quot;post2&quot;, DisplayName = &quot;Test 2&quot;, Reference = new Pipelines.RepositoryPathReference() { Name = &quot;actions/action&quot; } };
419                  postRunner2.Stage = ActionRunStage.Post;
420                  postRunner2.Condition = &quot;always()&quot;;
421                  postRunner2.DisplayName = &quot;post2&quot;;
422                  action1.RegisterPostJobStep(postRunner1);
423                  action2.RegisterPostJobStep(postRunner2);
424                  Assert.NotNull(jobContext.JobSteps);
425                  Assert.NotNull(jobContext.PostJobSteps);
426                  Assert.Equal(1, jobContext.PostJobSteps.Count);
427                  var post1 = jobContext.PostJobSteps.Pop();
428                  Assert.Equal(&quot;post1&quot;, (post1 as IActionRunner).Action.Name);
429                  Assert.Equal(ActionRunStage.Post, (post1 as IActionRunner).Stage);
430                  Assert.Equal(&quot;always()&quot;, (post1 as IActionRunner).Condition);
431              }
432          }
433          [Fact]
434          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
435          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
436          public void ActionResult_Lowercase()
437          {
438              using (TestHostContext hc = CreateTestContext())
439              {
440                  TaskOrchestrationPlanReference plan = new();
441                  TimelineReference timeline = new();
442                  Guid jobId = Guid.NewGuid();
443                  string jobName = &quot;some job name&quot;;
444                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
445                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
446                  {
447                      Alias = Pipelines.PipelineConstants.SelfAlias,
448                      Id = &quot;github&quot;,
449                      Version = &quot;sha1&quot;
450                  });
451                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
452                  jobRequest.Variables[&quot;ACTIONS_STEP_DEBUG&quot;] = &quot;true&quot;;
453                  var pagingLogger1 = new Mock&lt;IPagingLogger&gt;();
454                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
455                  hc.EnqueueInstance(pagingLogger1.Object);
456                  hc.SetSingleton(jobServerQueue.Object);
457                  var jobContext = new Runner.Worker.ExecutionContext();
458                  jobContext.Initialize(hc);
459                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
460                  jobContext.Global.StepsContext.SetConclusion(null, &quot;step1&quot;, ActionResult.Success);
461                  var conclusion1 = (jobContext.Global.StepsContext.GetScope(null)[&quot;step1&quot;] as DictionaryContextData)[&quot;conclusion&quot;].ToString();
462                  Assert.Equal(conclusion1, conclusion1.ToLowerInvariant());
463                  jobContext.Global.StepsContext.SetOutcome(null, &quot;step2&quot;, ActionResult.Cancelled);
464                  var outcome1 = (jobContext.Global.StepsContext.GetScope(null)[&quot;step2&quot;] as DictionaryContextData)[&quot;outcome&quot;].ToString();
465                  Assert.Equal(outcome1, outcome1.ToLowerInvariant());
466                  jobContext.Global.StepsContext.SetConclusion(null, &quot;step3&quot;, ActionResult.Failure);
467                  var conclusion2 = (jobContext.Global.StepsContext.GetScope(null)[&quot;step3&quot;] as DictionaryContextData)[&quot;conclusion&quot;].ToString();
468                  Assert.Equal(conclusion2, conclusion2.ToLowerInvariant());
469                  jobContext.Global.StepsContext.SetOutcome(null, &quot;step4&quot;, ActionResult.Skipped);
470                  var outcome2 = (jobContext.Global.StepsContext.GetScope(null)[&quot;step4&quot;] as DictionaryContextData)[&quot;outcome&quot;].ToString();
471                  Assert.Equal(outcome2, outcome2.ToLowerInvariant());
472                  jobContext.JobContext.Status = ActionResult.Success;
473                  Assert.Equal(jobContext.JobContext[&quot;status&quot;].ToString(), jobContext.JobContext[&quot;status&quot;].ToString().ToLowerInvariant());
474              }
475          }
476          [Fact]
477          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
478          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
479          public void PublishStepTelemetry_RegularStep_NoOpt()
480          {
481              using (TestHostContext hc = CreateTestContext())
482              {
483                  TaskOrchestrationPlanReference plan = new();
484                  TimelineReference timeline = new();
485                  Guid jobId = Guid.NewGuid();
486                  string jobName = &quot;some job name&quot;;
487                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
488                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
489                  {
490                      Alias = Pipelines.PipelineConstants.SelfAlias,
491                      Id = &quot;github&quot;,
492                      Version = &quot;sha1&quot;
493                  });
494                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
495                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
496                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
497                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
498                  hc.EnqueueInstance(pagingLogger.Object);
499                  hc.SetSingleton(jobServerQueue.Object);
500                  var ec = new Runner.Worker.ExecutionContext();
501                  ec.Initialize(hc);
502                  ec.InitializeJob(jobRequest, CancellationToken.None);
503                  ec.Start();
504                  ec.Complete();
505                  Assert.Equal(0, ec.Global.StepsTelemetry.Count);
506              }
507          }
508          [Fact]
509          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
510          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
511          public void PublishStepTelemetry_RegularStep()
512          {
513              using (TestHostContext hc = CreateTestContext())
514              {
515                  TaskOrchestrationPlanReference plan = new();
516                  TimelineReference timeline = new();
517                  Guid jobId = Guid.NewGuid();
518                  string jobName = &quot;some job name&quot;;
519                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
520                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
521                  {
522                      Alias = Pipelines.PipelineConstants.SelfAlias,
523                      Id = &quot;github&quot;,
524                      Version = &quot;sha1&quot;
525                  });
526                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
527                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
528                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
529                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
530                  hc.EnqueueInstance(pagingLogger.Object);
531                  hc.SetSingleton(jobServerQueue.Object);
532                  var ec = new Runner.Worker.ExecutionContext();
533                  ec.Initialize(hc);
534                  ec.InitializeJob(jobRequest, CancellationToken.None);
535                  ec.Start();
536                  ec.StepTelemetry.Type = &quot;node16&quot;;
537                  ec.StepTelemetry.Action = &quot;actions/checkout&quot;;
538                  ec.StepTelemetry.Ref = &quot;v2&quot;;
539                  ec.StepTelemetry.IsEmbedded = false;
540                  ec.StepTelemetry.StepId = Guid.NewGuid();
541                  ec.StepTelemetry.Stage = &quot;main&quot;;
542                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
543                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
544                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = &quot;notice&quot; }, ExecutionContextLogOptions.Default);
545                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
546                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
547                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = &quot;notice&quot; }, ExecutionContextLogOptions.Default);
548                  ec.Complete();
549                  Assert.Equal(1, ec.Global.StepsTelemetry.Count);
550                  Assert.Equal(&quot;node16&quot;, ec.Global.StepsTelemetry.Single().Type);
551                  Assert.Equal(&quot;actions/checkout&quot;, ec.Global.StepsTelemetry.Single().Action);
552                  Assert.Equal(&quot;v2&quot;, ec.Global.StepsTelemetry.Single().Ref);
553                  Assert.Equal(TaskResult.Succeeded, ec.Global.StepsTelemetry.Single().Result);
554                  Assert.NotNull(ec.Global.StepsTelemetry.Single().ExecutionTimeInSeconds);
555                  Assert.Equal(3, ec.Global.StepsTelemetry.Single().ErrorMessages.Count);
556                  Assert.DoesNotContain(ec.Global.StepsTelemetry.Single().ErrorMessages, x =&gt; x.Contains(&quot;notice&quot;));
557              }
558          }
559          [Fact]
560          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
561          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
562          public void PublishStepTelemetry_EmbeddedStep()
563          {
564              using (TestHostContext hc = CreateTestContext())
565              {
566                  TaskOrchestrationPlanReference plan = new();
567                  TimelineReference timeline = new();
568                  Guid jobId = Guid.NewGuid();
569                  string jobName = &quot;some job name&quot;;
570                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
571                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
572                  {
573                      Alias = Pipelines.PipelineConstants.SelfAlias,
574                      Id = &quot;github&quot;,
575                      Version = &quot;sha1&quot;
576                  });
577                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
578                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
579                  var pagingLogger2 = new Mock&lt;IPagingLogger&gt;();
580                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
581                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
582                  hc.EnqueueInstance(pagingLogger.Object);
583                  hc.EnqueueInstance(pagingLogger2.Object);
584                  hc.SetSingleton(jobServerQueue.Object);
585                  var ec = new Runner.Worker.ExecutionContext();
586                  ec.Initialize(hc);
587                  ec.InitializeJob(jobRequest, CancellationToken.None);
588                  ec.Start();
589                  var embeddedStep = ec.CreateChild(Guid.NewGuid(), &quot;action_1_pre&quot;, &quot;action_1_pre&quot;, null, null, ActionRunStage.Main, isEmbedded: true);
590                  embeddedStep.Start();
591                  embeddedStep.StepTelemetry.Type = &quot;node16&quot;;
592                  embeddedStep.StepTelemetry.Action = &quot;actions/checkout&quot;;
593                  embeddedStep.StepTelemetry.Ref = &quot;v2&quot;;
594                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
595                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
596                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Notice, Message = &quot;notice&quot; }, ExecutionContextLogOptions.Default);
597                  embeddedStep.PublishStepTelemetry();
598                  Assert.Equal(1, ec.Global.StepsTelemetry.Count);
599                  Assert.Equal(&quot;node16&quot;, ec.Global.StepsTelemetry.Single().Type);
600                  Assert.Equal(&quot;actions/checkout&quot;, ec.Global.StepsTelemetry.Single().Action);
601                  Assert.Equal(&quot;v2&quot;, ec.Global.StepsTelemetry.Single().Ref);
602                  Assert.Equal(ActionRunStage.Main.ToString(), ec.Global.StepsTelemetry.Single().Stage);
603                  Assert.True(ec.Global.StepsTelemetry.Single().IsEmbedded);
604                  Assert.Null(ec.Global.StepsTelemetry.Single().Result);
605                  Assert.Null(ec.Global.StepsTelemetry.Single().ExecutionTimeInSeconds);
606                  Assert.Equal(0, ec.Global.StepsTelemetry.Single().ErrorMessages.Count);
607              }
608          }
609          [Fact]
610          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
611          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
612          public void PublishStepResult_EmbeddedStep()
613          {
614              using (TestHostContext hc = CreateTestContext())
615              {
616                  TaskOrchestrationPlanReference plan = new();
617                  TimelineReference timeline = new();
618                  Guid jobId = Guid.NewGuid();
619                  string jobName = &quot;some job name&quot;;
620                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
621                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
622                  {
623                      Alias = Pipelines.PipelineConstants.SelfAlias,
624                      Id = &quot;github&quot;,
625                      Version = &quot;sha1&quot;
626                  });
627                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
628                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
629                  var pagingLogger2 = new Mock&lt;IPagingLogger&gt;();
630                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
631                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
632                  hc.EnqueueInstance(pagingLogger.Object);
633                  hc.EnqueueInstance(pagingLogger2.Object);
634                  hc.SetSingleton(jobServerQueue.Object);
635                  var ec = new Runner.Worker.ExecutionContext();
636                  ec.Initialize(hc);
637                  ec.InitializeJob(jobRequest, CancellationToken.None);
638                  ec.Start();
639                  var embeddedStep = ec.CreateChild(Guid.NewGuid(), &quot;action_1_pre&quot;, &quot;action_1_pre&quot;, null, null, ActionRunStage.Main, isEmbedded: true);
640                  embeddedStep.Start();
641                  embeddedStep.StepTelemetry.Type = &quot;node16&quot;;
642                  embeddedStep.StepTelemetry.Action = &quot;actions/checkout&quot;;
643                  embeddedStep.StepTelemetry.Ref = &quot;v2&quot;;
644                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
645                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
646                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Notice, Message = &quot;notice&quot; }, ExecutionContextLogOptions.Default);
647                  ec.Complete();
648                  Assert.Equal(1, ec.Global.StepsResult.Count);
649                  Assert.Equal(TaskResult.Succeeded, ec.Global.StepsResult.Single().Conclusion);
650              }
651          }
652          private TestHostContext CreateTestContext([CallerMemberName] String testName = &quot;&quot;)
653          {
654              var hc = new TestHostContext(this, testName);
655              var configurationStore = new Mock&lt;IConfigurationStore&gt;();
656              configurationStore.Setup(x =&gt; x.GetSettings()).Returns(new RunnerSettings());
657              hc.SetSingleton(configurationStore.Object);
658              hc.SetSingleton(new Mock&lt;IJobServerQueue&gt;().Object);
659              return hc;
660          }
661          [Fact]
662          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
663          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
664          public void GetExpressionValues_ContainerStepHost()
665          {
666              using (TestHostContext hc = CreateTestContext())
667              {
668                  const string source = &quot;/home/username/Projects/work/runner/_layout&quot;;
669                  var containerInfo = new ContainerInfo();
670                  containerInfo.ContainerId = &quot;test&quot;;
671                  containerInfo.AddPathTranslateMapping($&quot;{source}/_work&quot;, &quot;/__w&quot;);
672                  containerInfo.AddPathTranslateMapping($&quot;{source}/_temp&quot;, &quot;/__t&quot;);
673                  containerInfo.AddPathTranslateMapping($&quot;{source}/externals&quot;, &quot;/__e&quot;);
674                  containerInfo.AddPathTranslateMapping($&quot;{source}/_work/_temp/_github_home&quot;, &quot;/github/home&quot;);
675                  containerInfo.AddPathTranslateMapping($&quot;{source}/_work/_temp/_github_workflow&quot;, &quot;/github/workflow&quot;);
676                  foreach (var v in new List&lt;string&gt;() {
677                      $&quot;{source}/_work&quot;,
678                      $&quot;{source}/externals&quot;,
679                      $&quot;{source}/_work/_temp&quot;,
680                      $&quot;{source}/_work/_actions&quot;,
681                      $&quot;{source}/_work/_tool&quot;,
682                  })
683                  {
684                      containerInfo.MountVolumes.Add(new MountVolume(v, containerInfo.TranslateToContainerPath(v)));
685                  };
686                  var stepHost = new ContainerStepHost();
687                  stepHost.Container = containerInfo;
688                  var ec = new Runner.Worker.ExecutionContext();
689                  ec.Initialize(hc);
690                  var inputGithubContext = new GitHubContext();
691                  var inputeRunnerContext = new RunnerContext();
692                  inputGithubContext[&quot;action_path&quot;] = new StringContextData(&quot;/home/username/Projects/work/runner/_layout/_work/_actions/owner/composite/main&quot;);
693                  inputGithubContext[&quot;action&quot;] = new StringContextData(&quot;__owner_composite&quot;);
694                  inputGithubContext[&quot;api_url&quot;] = new StringContextData(&quot;https:&amp;bsol;&amp;bsol;api.github.com/custom/path&quot;);
695                  inputGithubContext[&quot;env&quot;] = new StringContextData(&quot;/home/username/Projects/work/runner/_layout/_work/_temp/_runner_file_commands/set_env_265698aa-7f38-40f5-9316-5c01a3153672&quot;);
696                  inputGithubContext[&quot;path&quot;] = new StringContextData(&quot;/home/username/Projects/work/runner/_layout/_work/_temp/_runner_file_commands/add_path_265698aa-7f38-40f5-9316-5c01a3153672&quot;);
697                  inputGithubContext[&quot;event_path&quot;] = new StringContextData(&quot;/home/username/Projects/work/runner/_layout/_work/_temp/_github_workflow/event.json&quot;);
698                  inputGithubContext[&quot;repository&quot;] = new StringContextData(&quot;owner/repo-name&quot;);
699                  inputGithubContext[&quot;run_id&quot;] = new StringContextData(&quot;2033211332&quot;);
700                  inputGithubContext[&quot;workflow&quot;] = new StringContextData(&quot;Name of Workflow&quot;);
701                  inputGithubContext[&quot;workspace&quot;] = new StringContextData(&quot;/home/username/Projects/work/runner/_layout/_work/step-order/step-order&quot;);
702                  inputeRunnerContext[&quot;temp&quot;] = new StringContextData(&quot;/home/username/Projects/work/runner/_layout/_work/_temp&quot;);
703                  inputeRunnerContext[&quot;tool_cache&quot;] = new StringContextData(&quot;/home/username/Projects/work/runner/_layout/_work/_tool&quot;);
704                  var githubEvent = new DictionaryContextData();
705                  githubEvent[&quot;inputs&quot;] = null;
706                  githubEvent[&quot;ref&quot;] = new StringContextData(&quot;refs/heads/main&quot;);
707                  githubEvent[&quot;repository&quot;] = new DictionaryContextData();
708                  githubEvent[&quot;sender&quot;] = new DictionaryContextData();
709                  githubEvent[&quot;workflow&quot;] = new StringContextData(&quot;.github/workflows/composite_step_host_translate.yaml&quot;);
710                  inputGithubContext[&quot;event&quot;] = githubEvent;
711                  ec.ExpressionValues[&quot;github&quot;] = inputGithubContext;
712                  ec.ExpressionValues[&quot;runner&quot;] = inputeRunnerContext;
713                  var ecExpect = new Runner.Worker.ExecutionContext();
714                  ecExpect.Initialize(hc);
715                  var expectedGithubEvent = new DictionaryContextData();
716                  expectedGithubEvent[&quot;inputs&quot;] = null;
717                  expectedGithubEvent[&quot;ref&quot;] = new StringContextData(&quot;refs/heads/main&quot;);
718                  expectedGithubEvent[&quot;repository&quot;] = new DictionaryContextData();
719                  expectedGithubEvent[&quot;sender&quot;] = new DictionaryContextData();
720                  expectedGithubEvent[&quot;workflow&quot;] = new StringContextData(&quot;.github/workflows/composite_step_host_translate.yaml&quot;);
721                  var expectedGithubContext = new GitHubContext();
722                  var expectedRunnerContext = new RunnerContext();
723                  expectedGithubContext[&quot;action_path&quot;] = new StringContextData(&quot;/__w/_actions/owner/composite/main&quot;);
724                  expectedGithubContext[&quot;action&quot;] = new StringContextData(&quot;__owner_composite&quot;);
725                  expectedGithubContext[&quot;api_url&quot;] = new StringContextData(&quot;https:&amp;bsol;&amp;bsol;api.github.com/custom/path&quot;);
726                  expectedGithubContext[&quot;env&quot;] = new StringContextData(&quot;/__w/_temp/_runner_file_commands/set_env_265698aa-7f38-40f5-9316-5c01a3153672&quot;);
727                  expectedGithubContext[&quot;path&quot;] = new StringContextData(&quot;/__w/_temp/_runner_file_commands/add_path_265698aa-7f38-40f5-9316-5c01a3153672&quot;);
728                  expectedGithubContext[&quot;event_path&quot;] = new StringContextData(&quot;/github/workflow/event.json&quot;);
729                  expectedGithubContext[&quot;repository&quot;] = new StringContextData(&quot;owner/repo-name&quot;);
730                  expectedGithubContext[&quot;run_id&quot;] = new StringContextData(&quot;2033211332&quot;);
731                  expectedGithubContext[&quot;workflow&quot;] = new StringContextData(&quot;Name of Workflow&quot;);
732                  expectedGithubContext[&quot;workspace&quot;] = new StringContextData(&quot;/__w/step-order/step-order&quot;);
733                  expectedGithubContext[&quot;event&quot;] = expectedGithubEvent;
734                  expectedRunnerContext[&quot;temp&quot;] = new StringContextData(&quot;/__w/_temp&quot;);
735                  expectedRunnerContext[&quot;tool_cache&quot;] = new StringContextData(&quot;/__w/_tool&quot;);
736                  ecExpect.ExpressionValues[&quot;github&quot;] = expectedGithubContext;
737                  ecExpect.ExpressionValues[&quot;runner&quot;] = expectedRunnerContext;
738                  var translatedExpressionValues = ec.GetExpressionValues(stepHost);
739                  foreach (var contextName in new string[] { &quot;github&quot;, &quot;runner&quot; })
740                  {
741                      var dict = translatedExpressionValues[contextName].AssertDictionary($&quot;expected context github to be a dictionary&quot;);
742                      var expectedExpressionValues = ecExpect.ExpressionValues[contextName].AssertDictionary(&quot;expect dict&quot;);
743                      foreach (var key in dict.Keys.ToList())
744                      {
745                          if (dict[key] is StringContextData)
746                          {
747                              var expect = dict[key].AssertString(&quot;expect string&quot;);
748                              var outcome = expectedExpressionValues[key].AssertString(&quot;expect string&quot;);
749                              Assert.Equal(expect.Value, outcome.Value);
750                          }
751                          else if (dict[key] is DictionaryContextData || dict[key] is CaseSensitiveDictionaryContextData)
752                          {
753                              var expectDict = dict[key].AssertDictionary(&quot;expect dict&quot;);
754                              var actualDict = expectedExpressionValues[key].AssertDictionary(&quot;expect dict&quot;);
755                              Assert.True(ExpressionValuesAssertEqual(expectDict, actualDict));
756                          }
757                      }
758                  }
759              }
760          }
761          [Fact]
762          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
763          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
764          public void ActionVariables_AddedToVarsContext()
765          {
766              using (TestHostContext hc = CreateTestContext())
767              {
768                  TaskOrchestrationPlanReference plan = new();
769                  TimelineReference timeline = new();
770                  Guid jobId = Guid.NewGuid();
771                  string jobName = &quot;some job name&quot;;
772                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
773                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
774                  {
775                      Alias = Pipelines.PipelineConstants.SelfAlias,
776                      Id = &quot;github&quot;,
777                      Version = &quot;sha1&quot;
778                  });
779                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
780                  var inputVarsContext = new DictionaryContextData();
781                  inputVarsContext[&quot;VARIABLE_1&quot;] = new StringContextData(&quot;value1&quot;);
782                  inputVarsContext[&quot;VARIABLE_2&quot;] = new StringContextData(&quot;value2&quot;);
783                  jobRequest.ContextData[&quot;vars&quot;] = inputVarsContext;
784                  var pagingLogger1 = new Mock&lt;IPagingLogger&gt;();
785                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
786                  hc.EnqueueInstance(pagingLogger1.Object);
787                  hc.SetSingleton(jobServerQueue.Object);
788                  var jobContext = new Runner.Worker.ExecutionContext();
789                  jobContext.Initialize(hc);
790                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
791                  var expected = new DictionaryContextData();
792                  expected[&quot;VARIABLE_1&quot;] = new StringContextData(&quot;value1&quot;);
793                  expected[&quot;VARIABLE_2&quot;] = new StringContextData(&quot;value1&quot;);
794                  Assert.True(ExpressionValuesAssertEqual(expected, jobContext.ExpressionValues[&quot;vars&quot;] as DictionaryContextData));
795              }
796          }
797          [Fact]
798          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
799          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
800          public void ActionVariables_DebugUsingVars()
801          {
802              using (TestHostContext hc = CreateTestContext())
803              {
804                  TaskOrchestrationPlanReference plan = new TaskOrchestrationPlanReference();
805                  TimelineReference timeline = new TimelineReference();
806                  Guid jobId = Guid.NewGuid();
807                  string jobName = &quot;some job name&quot;;
808                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
809                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
810                  {
811                      Alias = Pipelines.PipelineConstants.SelfAlias,
812                      Id = &quot;github&quot;,
813                      Version = &quot;sha1&quot;
814                  });
815                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
816                  var inputVarsContext = new DictionaryContextData();
817                  inputVarsContext[Constants.Variables.Actions.StepDebug] = new StringContextData(&quot;true&quot;);
818                  inputVarsContext[Constants.Variables.Actions.RunnerDebug] = new StringContextData(&quot;true&quot;);
819                  jobRequest.ContextData[&quot;vars&quot;] = inputVarsContext;
820                  var pagingLogger1 = new Mock&lt;IPagingLogger&gt;();
821                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
822                  hc.EnqueueInstance(pagingLogger1.Object);
823                  hc.SetSingleton(jobServerQueue.Object);
824                  var jobContext = new Runner.Worker.ExecutionContext();
825                  jobContext.Initialize(hc);
826                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
827                  Assert.Equal(&quot;true&quot;, jobContext.Global.Variables.Get(Constants.Variables.Actions.StepDebug));
828                  Assert.Equal(&quot;true&quot;, jobContext.Global.Variables.Get(Constants.Variables.Actions.RunnerDebug));
829              }
830          }
831          [Fact]
832          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
833          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
834          public void ActionVariables_SecretsPrecedenceForDebugUsingVars()
835          {
836              using (TestHostContext hc = CreateTestContext())
837              {
838                  TaskOrchestrationPlanReference plan = new TaskOrchestrationPlanReference();
839                  TimelineReference timeline = new TimelineReference();
840                  Guid jobId = Guid.NewGuid();
841                  string jobName = &quot;some job name&quot;;
842                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
<span onclick='openModal()' class='match'>843                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
844                  {
845                      Alias = Pipelines.PipelineConstants.SelfAlias,
846                      Id = &quot;github&quot;,
847                      Version = &quot;sha1&quot;
848                  });
849                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
</span>850                  var inputVarsContext = new DictionaryContextData();
851                  inputVarsContext[Constants.Variables.Actions.StepDebug] = new StringContextData(&quot;true&quot;);
852                  inputVarsContext[Constants.Variables.Actions.RunnerDebug] = new StringContextData(&quot;true&quot;);
853                  jobRequest.ContextData[&quot;vars&quot;] = inputVarsContext;
854                  jobRequest.Variables[Constants.Variables.Actions.StepDebug] = &quot;false&quot;;
855                  jobRequest.Variables[Constants.Variables.Actions.RunnerDebug] = &quot;false&quot;;
856                  var pagingLogger1 = new Mock&lt;IPagingLogger&gt;();
857                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
858                  hc.EnqueueInstance(pagingLogger1.Object);
859                  hc.SetSingleton(jobServerQueue.Object);
860                  var jobContext = new Runner.Worker.ExecutionContext();
861                  jobContext.Initialize(hc);
862                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
863                  Assert.Equal(&quot;false&quot;, jobContext.Global.Variables.Get(Constants.Variables.Actions.StepDebug));
864                  Assert.Equal(&quot;false&quot;, jobContext.Global.Variables.Get(Constants.Variables.Actions.RunnerDebug));
865              }
866          }
867          private bool ExpressionValuesAssertEqual(DictionaryContextData expect, DictionaryContextData actual)
868          {
869              foreach (var key in expect.Keys.ToList())
870              {
871                  if (expect[key] is StringContextData)
872                  {
873                      var expectValue = expect[key].AssertString(&quot;expect string&quot;);
874                      var actualValue = actual[key].AssertString(&quot;expect string&quot;);
875                      if (expectValue.Equals(actualValue))
876                      {
877                          return false;
878                      }
879                  }
880                  else if (expect[key] is DictionaryContextData || expect[key] is CaseSensitiveDictionaryContextData)
881                  {
882                      var expectDict = expect[key].AssertDictionary(&quot;expect dict&quot;);
883                      var actualDict = actual[key].AssertDictionary(&quot;expect dict&quot;);
884                      if (!ExpressionValuesAssertEqual(expectDict, actualDict))
885                      {
886                          return false;
887                      }
888                  }
889              }
890              return true;
891          }
892      }
893  }
</code></pre>
        </div>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ExecutionContextL0.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Linq;
4  using System.Runtime.CompilerServices;
5  using System.Threading;
6  using GitHub.DistributedTask.Pipelines.ContextData;
7  using GitHub.DistributedTask.WebApi;
8  using GitHub.Runner.Worker;
9  using GitHub.Runner.Worker.Container;
10  using GitHub.Runner.Worker.Handlers;
11  using Moq;
12  using Xunit;
13  using GitHub.DistributedTask.ObjectTemplating.Tokens;
14  using Pipelines = GitHub.DistributedTask.Pipelines;
15  namespace GitHub.Runner.Common.Tests.Worker
16  {
17      public sealed class ExecutionContextL0
18      {
19          [Fact]
20          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
21          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
22          public void AddIssue_CountWarningsErrors()
23          {
24              using (TestHostContext hc = CreateTestContext())
25              {
26                  TaskOrchestrationPlanReference plan = new();
27                  TimelineReference timeline = new();
28                  Guid jobId = Guid.NewGuid();
29                  string jobName = &quot;some job name&quot;;
30                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
31                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
32                  {
33                      Alias = Pipelines.PipelineConstants.SelfAlias,
34                      Id = &quot;github&quot;,
35                      Version = &quot;sha1&quot;
36                  });
37                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
38                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
39                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
40                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
41                  hc.EnqueueInstance(pagingLogger.Object);
42                  hc.SetSingleton(jobServerQueue.Object);
43                  var ec = new Runner.Worker.ExecutionContext();
44                  ec.Initialize(hc);
45                  ec.InitializeJob(jobRequest, CancellationToken.None);
46                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
47                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
48                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
49                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
50                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
51                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
52                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
53                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
54                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
55                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
56                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
57                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
58                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
59                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
60                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
61                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
62                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
63                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
64                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
65                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
66                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
67                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
68                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
69                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
70                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
71                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
72                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
73                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
74                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
75                  ec.Complete();
76                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.ErrorCount &gt; 0)), Times.AtLeast(10));
77                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.WarningCount &gt; 0)), Times.AtLeast(10));
78                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.Issues.Where(i =&gt; i.Type == IssueType.Error).Count() == 10)), Times.AtLeastOnce);
79                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.Issues.Where(i =&gt; i.Type == IssueType.Warning).Count() == 10)), Times.AtLeastOnce);
80              }
81          }
82          [Fact]
83          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
84          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
85          public void ApplyContinueOnError_CheckResultAndOutcome()
86          {
87              using (TestHostContext hc = CreateTestContext())
88              {
89                  TaskOrchestrationPlanReference plan = new();
90                  TimelineReference timeline = new();
91                  Guid jobId = Guid.NewGuid();
92                  string jobName = &quot;some job name&quot;;
93                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
94                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
95                  {
96                      Alias = Pipelines.PipelineConstants.SelfAlias,
97                      Id = &quot;github&quot;,
98                      Version = &quot;sha1&quot;
99                  });
100                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
101                  jobRequest.Variables[&quot;ACTIONS_STEP_DEBUG&quot;] = &quot;true&quot;;
102                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
103                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
104                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
105                  jobServerQueue.Setup(x =&gt; x.QueueWebConsoleLine(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;long&gt;())).Callback((Guid id, string msg, long? lineNumber) =&gt; { hc.GetTrace().Info(msg); });
106                  hc.EnqueueInstance(pagingLogger.Object);
107                  hc.SetSingleton(jobServerQueue.Object);
108                  var ec = new Runner.Worker.ExecutionContext();
109                  ec.Initialize(hc);
110                  ec.InitializeJob(jobRequest, CancellationToken.None);
111                  foreach (var tc in new List&lt;(TemplateToken token, TaskResult result, TaskResult? expectedResult, TaskResult? expectedOutcome)&gt; {
112                  (token: new BooleanToken(null, null, null, true), result: TaskResult.Failed, expectedResult: TaskResult.Succeeded, expectedOutcome: TaskResult.Failed),
113                  (token: new BooleanToken(null, null, null, true), result: TaskResult.Succeeded, expectedResult: TaskResult.Succeeded, expectedOutcome: null),
114                  (token: new BooleanToken(null, null, null, true), result: TaskResult.Canceled, expectedResult: TaskResult.Canceled, expectedOutcome: null),
115                  (token: new BooleanToken(null, null, null, false), result: TaskResult.Failed, expectedResult: TaskResult.Failed, expectedOutcome: null),
116                  (token: new BooleanToken(null, null, null, false), result: TaskResult.Succeeded, expectedResult: TaskResult.Succeeded, expectedOutcome: null),
117                  (token: new BooleanToken(null, null, null, false), result: TaskResult.Canceled, expectedResult: TaskResult.Canceled, expectedOutcome: null),
118              })
119                  {
120                      ec.Result = tc.result;
121                      ec.Outcome = null;
122                      ec.ApplyContinueOnError(tc.token);
123                      Assert.Equal(ec.Result, tc.expectedResult);
124                      Assert.Equal(ec.Outcome, tc.expectedOutcome);
125                  }
126              }
127          }
128          [Fact]
129          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
130          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
131          public void AddIssue_TrimMessageSize()
132          {
133              using (TestHostContext hc = CreateTestContext())
134              {
135                  TaskOrchestrationPlanReference plan = new();
136                  TimelineReference timeline = new();
137                  Guid jobId = Guid.NewGuid();
138                  string jobName = &quot;some job name&quot;;
139                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
140                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
141                  {
142                      Alias = Pipelines.PipelineConstants.SelfAlias,
143                      Id = &quot;github&quot;,
144                      Version = &quot;sha1&quot;
145                  });
146                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
147                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
148                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
149                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
150                  hc.EnqueueInstance(pagingLogger.Object);
151                  hc.SetSingleton(jobServerQueue.Object);
152                  var ec = new Runner.Worker.ExecutionContext();
153                  ec.Initialize(hc);
154                  ec.InitializeJob(jobRequest, CancellationToken.None);
155                  var bigMessage = &quot;&quot;;
156                  for (var i = 0; i &lt; 5000; i++)
157                  {
158                      bigMessage += &quot;a&quot;;
159                  }
160                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = bigMessage }, ExecutionContextLogOptions.Default);
161                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = bigMessage }, ExecutionContextLogOptions.Default);
162                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = bigMessage }, ExecutionContextLogOptions.Default);
163                  ec.Complete();
164                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.Issues.Where(i =&gt; i.Type == IssueType.Error).Single().Message.Length &lt;= 4096)), Times.AtLeastOnce);
165                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.Issues.Where(i =&gt; i.Type == IssueType.Warning).Single().Message.Length &lt;= 4096)), Times.AtLeastOnce);
166                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.Issues.Where(i =&gt; i.Type == IssueType.Notice).Single().Message.Length &lt;= 4096)), Times.AtLeastOnce);
167              }
168          }
169          [Fact]
170          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
171          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
172          public void AddIssue_OverrideLogMessage()
173          {
174              using (TestHostContext hc = CreateTestContext())
175              {
176                  TaskOrchestrationPlanReference plan = new();
177                  TimelineReference timeline = new();
178                  Guid jobId = Guid.NewGuid();
179                  string jobName = &quot;some job name&quot;;
180                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
181                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
182                  {
183                      Alias = Pipelines.PipelineConstants.SelfAlias,
184                      Id = &quot;github&quot;,
185                      Version = &quot;sha1&quot;
186                  });
187                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
188                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
189                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
190                  hc.EnqueueInstance(pagingLogger.Object);
191                  hc.SetSingleton(jobServerQueue.Object);
192                  var ec = new Runner.Worker.ExecutionContext();
193                  ec.Initialize(hc);
194                  ec.InitializeJob(jobRequest, CancellationToken.None);
195                  var issueMessage = &quot;Message embedded in issue.&quot;;
196                  var overrideMessage = &quot;Message override.&quot;;
197                  var options = new ExecutionContextLogOptions(true, overrideMessage);
198                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = issueMessage }, options);
199                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = issueMessage }, options);
200                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = issueMessage }, options);
201                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = issueMessage }, ExecutionContextLogOptions.Default);
202                  ec.Complete();
203                  jobServerQueue.Verify(x =&gt; x.QueueWebConsoleLine(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;long?&gt;()), Times.Exactly(4));
204                  jobServerQueue.Verify(x =&gt; x.QueueWebConsoleLine(It.IsAny&lt;Guid&gt;(), It.Is&lt;string&gt;(text =&gt; text.EndsWith(overrideMessage)), It.IsAny&lt;long?&gt;()), Times.Exactly(3));
205                  jobServerQueue.Verify(x =&gt; x.QueueWebConsoleLine(It.IsAny&lt;Guid&gt;(), It.Is&lt;string&gt;(text =&gt; text.EndsWith(issueMessage)), It.IsAny&lt;long?&gt;()), Times.Exactly(1));
206              }
207          }
208          [Fact]
209          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
210          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
211          public void AddIssue_AddStepAndLineNumberInformation()
212          {
213              using (TestHostContext hc = CreateTestContext())
214              {
215                  TaskOrchestrationPlanReference plan = new();
216                  TimelineReference timeline = new();
217                  Guid jobId = Guid.NewGuid();
218                  string jobName = &quot;some job name&quot;;
219                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
220                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
221                  {
222                      Alias = Pipelines.PipelineConstants.SelfAlias,
223                      Id = &quot;github&quot;,
224                      Version = &quot;sha1&quot;
225                  });
226                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
227                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
228                  var pagingLogger2 = new Mock&lt;IPagingLogger&gt;();
229                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
230                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
231                  hc.EnqueueInstance(pagingLogger.Object);
232                  hc.EnqueueInstance(pagingLogger2.Object);
233                  hc.SetSingleton(jobServerQueue.Object);
234                  var ec = new Runner.Worker.ExecutionContext();
235                  ec.Initialize(hc);
236                  ec.InitializeJob(jobRequest, CancellationToken.None);
237                  ec.Start();
238                  var embeddedStep = ec.CreateChild(Guid.NewGuid(), &quot;action_1_pre&quot;, &quot;action_1_pre&quot;, null, null, ActionRunStage.Main, isEmbedded: true);
239                  embeddedStep.Start();
240                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error annotation that should have step and line number information&quot; }, ExecutionContextLogOptions.Default);
241                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning annotation that should have step and line number information&quot; }, ExecutionContextLogOptions.Default);
242                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Notice, Message = &quot;notice annotation that should have step and line number information&quot; }, ExecutionContextLogOptions.Default);
243                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()), Times.AtLeastOnce);
244                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.Issues.Where(i =&gt; i.Data.ContainsKey(&quot;stepNumber&quot;) &amp;&amp; i.Data.ContainsKey(&quot;logFileLineNumber&quot;) &amp;&amp; i.Type == IssueType.Error).Count() == 1)), Times.Never);
245                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.Issues.Where(i =&gt; i.Data.ContainsKey(&quot;stepNumber&quot;) &amp;&amp; i.Data.ContainsKey(&quot;logFileLineNumber&quot;) &amp;&amp; i.Type == IssueType.Warning).Count() == 1)), Times.Never);
246                  jobServerQueue.Verify(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.Is&lt;TimelineRecord&gt;(t =&gt; t.Issues.Where(i =&gt; i.Data.ContainsKey(&quot;stepNumber&quot;) &amp;&amp; i.Data.ContainsKey(&quot;logFileLineNumber&quot;) &amp;&amp; i.Type == IssueType.Notice).Count() == 1)), Times.Never);
247              }
248          }
249          [Fact]
250          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
251          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
252          public void Debug_Multilines()
253          {
254              using (TestHostContext hc = CreateTestContext())
255              {
256                  TaskOrchestrationPlanReference plan = new();
257                  TimelineReference timeline = new();
258                  Guid jobId = Guid.NewGuid();
259                  string jobName = &quot;some job name&quot;;
260                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
<span onclick='openModal()' class='match'>261                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
262                  {
263                      Alias = Pipelines.PipelineConstants.SelfAlias,
264                      Id = &quot;github&quot;,
265                      Version = &quot;sha1&quot;
266                  });
267                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
</span>268                  jobRequest.Variables[&quot;ACTIONS_STEP_DEBUG&quot;] = &quot;true&quot;;
269                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
270                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
271                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
272                  jobServerQueue.Setup(x =&gt; x.QueueWebConsoleLine(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;long&gt;())).Callback((Guid id, string msg, long? lineNumber) =&gt; { hc.GetTrace().Info(msg); });
273                  hc.EnqueueInstance(pagingLogger.Object);
274                  hc.SetSingleton(jobServerQueue.Object);
275                  var ec = new Runner.Worker.ExecutionContext();
276                  ec.Initialize(hc);
277                  ec.InitializeJob(jobRequest, CancellationToken.None);
278                  ec.Debug(null);
279                  ec.Debug(&quot;&quot;);
280                  ec.Debug(&quot;\n&quot;);
281                  ec.Debug(&quot;\r\n&quot;);
282                  ec.Debug(&quot;test&quot;);
283                  ec.Debug(&quot;te\nst&quot;);
284                  ec.Debug(&quot;te\r\nst&quot;);
285                  ec.Complete();
286                  jobServerQueue.Verify(x =&gt; x.QueueWebConsoleLine(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;long?&gt;()), Times.Exactly(10));
287              }
288          }
289          [Fact]
290          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
291          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
292          public void RegisterPostJobAction_ShareState()
293          {
294              using (TestHostContext hc = CreateTestContext())
295              {
296                  TaskOrchestrationPlanReference plan = new();
297                  TimelineReference timeline = new();
298                  Guid jobId = Guid.NewGuid();
299                  string jobName = &quot;some job name&quot;;
300                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
301                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
302                  {
303                      Alias = Pipelines.PipelineConstants.SelfAlias,
304                      Id = &quot;github&quot;,
305                      Version = &quot;sha1&quot;
306                  });
307                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
308                  jobRequest.Variables[&quot;ACTIONS_STEP_DEBUG&quot;] = &quot;true&quot;;
309                  var pagingLogger1 = new Mock&lt;IPagingLogger&gt;();
310                  var pagingLogger2 = new Mock&lt;IPagingLogger&gt;();
311                  var pagingLogger3 = new Mock&lt;IPagingLogger&gt;();
312                  var pagingLogger4 = new Mock&lt;IPagingLogger&gt;();
313                  var pagingLogger5 = new Mock&lt;IPagingLogger&gt;();
314                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
315                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
316                  jobServerQueue.Setup(x =&gt; x.QueueWebConsoleLine(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;long?&gt;())).Callback((Guid id, string msg, long? lineNumber) =&gt; { hc.GetTrace().Info(msg); });
317                  var actionRunner1 = new ActionRunner();
318                  actionRunner1.Initialize(hc);
319                  var actionRunner2 = new ActionRunner();
320                  actionRunner2.Initialize(hc);
321                  hc.EnqueueInstance(pagingLogger1.Object);
322                  hc.EnqueueInstance(pagingLogger2.Object);
323                  hc.EnqueueInstance(pagingLogger3.Object);
324                  hc.EnqueueInstance(pagingLogger4.Object);
325                  hc.EnqueueInstance(pagingLogger5.Object);
326                  hc.EnqueueInstance(actionRunner1 as IActionRunner);
327                  hc.EnqueueInstance(actionRunner2 as IActionRunner);
328                  hc.SetSingleton(jobServerQueue.Object);
329                  var jobContext = new Runner.Worker.ExecutionContext();
330                  jobContext.Initialize(hc);
331                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
332                  var action1 = jobContext.CreateChild(Guid.NewGuid(), &quot;action_1&quot;, &quot;action_1&quot;, null, null, 0);
333                  action1.IntraActionState[&quot;state&quot;] = &quot;1&quot;;
334                  var action2 = jobContext.CreateChild(Guid.NewGuid(), &quot;action_2&quot;, &quot;action_2&quot;, null, null, 0);
335                  action2.IntraActionState[&quot;state&quot;] = &quot;2&quot;;
336                  var postRunner1 = hc.CreateService&lt;IActionRunner&gt;();
337                  postRunner1.Action = new Pipelines.ActionStep() { Id = Guid.NewGuid(), Name = &quot;post1&quot;, DisplayName = &quot;Test 1&quot;, Reference = new Pipelines.RepositoryPathReference() { Name = &quot;actions/action&quot; } };
338                  postRunner1.Stage = ActionRunStage.Post;
339                  postRunner1.Condition = &quot;always()&quot;;
340                  postRunner1.DisplayName = &quot;post1&quot;;
341                  var postRunner2 = hc.CreateService&lt;IActionRunner&gt;();
342                  postRunner2.Action = new Pipelines.ActionStep() { Id = Guid.NewGuid(), Name = &quot;post2&quot;, DisplayName = &quot;Test 2&quot;, Reference = new Pipelines.RepositoryPathReference() { Name = &quot;actions/action&quot; } };
343                  postRunner2.Stage = ActionRunStage.Post;
344                  postRunner2.Condition = &quot;always()&quot;;
345                  postRunner2.DisplayName = &quot;post2&quot;;
346                  action1.RegisterPostJobStep(postRunner1);
347                  action2.RegisterPostJobStep(postRunner2);
348                  Assert.NotNull(jobContext.JobSteps);
349                  Assert.NotNull(jobContext.PostJobSteps);
350                  Assert.Null(action1.JobSteps);
351                  Assert.Null(action2.JobSteps);
352                  Assert.Null(action1.PostJobSteps);
353                  Assert.Null(action2.PostJobSteps);
354                  var post1 = jobContext.PostJobSteps.Pop();
355                  var post2 = jobContext.PostJobSteps.Pop();
356                  Assert.Equal(&quot;post2&quot;, (post1 as IActionRunner).Action.Name);
357                  Assert.Equal(&quot;post1&quot;, (post2 as IActionRunner).Action.Name);
358                  Assert.Equal(ActionRunStage.Post, (post1 as IActionRunner).Stage);
359                  Assert.Equal(ActionRunStage.Post, (post2 as IActionRunner).Stage);
360                  Assert.Equal(&quot;always()&quot;, (post1 as IActionRunner).Condition);
361                  Assert.Equal(&quot;always()&quot;, (post2 as IActionRunner).Condition);
362                  Assert.Equal(&quot;2&quot;, (post1 as IActionRunner).ExecutionContext.IntraActionState[&quot;state&quot;]);
363                  Assert.Equal(&quot;1&quot;, (post2 as IActionRunner).ExecutionContext.IntraActionState[&quot;state&quot;]);
364              }
365          }
366          [Fact]
367          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
368          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
369          public void RegisterPostJobAction_NotRegisterPostTwice()
370          {
371              using (TestHostContext hc = CreateTestContext())
372              {
373                  TaskOrchestrationPlanReference plan = new();
374                  TimelineReference timeline = new();
375                  Guid jobId = Guid.NewGuid();
376                  string jobName = &quot;some job name&quot;;
377                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
378                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
379                  {
380                      Alias = Pipelines.PipelineConstants.SelfAlias,
381                      Id = &quot;github&quot;,
382                      Version = &quot;sha1&quot;
383                  });
384                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
385                  jobRequest.Variables[&quot;ACTIONS_STEP_DEBUG&quot;] = &quot;true&quot;;
386                  var pagingLogger1 = new Mock&lt;IPagingLogger&gt;();
387                  var pagingLogger2 = new Mock&lt;IPagingLogger&gt;();
388                  var pagingLogger3 = new Mock&lt;IPagingLogger&gt;();
389                  var pagingLogger4 = new Mock&lt;IPagingLogger&gt;();
390                  var pagingLogger5 = new Mock&lt;IPagingLogger&gt;();
391                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
392                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
393                  jobServerQueue.Setup(x =&gt; x.QueueWebConsoleLine(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;long?&gt;())).Callback((Guid id, string msg, long? lineNumber) =&gt; { hc.GetTrace().Info(msg); });
394                  var actionRunner1 = new ActionRunner();
395                  actionRunner1.Initialize(hc);
396                  var actionRunner2 = new ActionRunner();
397                  actionRunner2.Initialize(hc);
398                  hc.EnqueueInstance(pagingLogger1.Object);
399                  hc.EnqueueInstance(pagingLogger2.Object);
400                  hc.EnqueueInstance(pagingLogger3.Object);
401                  hc.EnqueueInstance(pagingLogger4.Object);
402                  hc.EnqueueInstance(pagingLogger5.Object);
403                  hc.EnqueueInstance(actionRunner1 as IActionRunner);
404                  hc.EnqueueInstance(actionRunner2 as IActionRunner);
405                  hc.SetSingleton(jobServerQueue.Object);
406                  var jobContext = new Runner.Worker.ExecutionContext();
407                  jobContext.Initialize(hc);
408                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
409                  var action1 = jobContext.CreateChild(Guid.NewGuid(), &quot;action_1_pre&quot;, &quot;action_1_pre&quot;, null, null, 0);
410                  var action2 = jobContext.CreateChild(Guid.NewGuid(), &quot;action_1_main&quot;, &quot;action_1_main&quot;, null, null, 0);
411                  var actionId = Guid.NewGuid();
412                  var postRunner1 = hc.CreateService&lt;IActionRunner&gt;();
413                  postRunner1.Action = new Pipelines.ActionStep() { Id = actionId, Name = &quot;post1&quot;, DisplayName = &quot;Test 1&quot;, Reference = new Pipelines.RepositoryPathReference() { Name = &quot;actions/action&quot; } };
414                  postRunner1.Stage = ActionRunStage.Post;
415                  postRunner1.Condition = &quot;always()&quot;;
416                  postRunner1.DisplayName = &quot;post1&quot;;
417                  var postRunner2 = hc.CreateService&lt;IActionRunner&gt;();
418                  postRunner2.Action = new Pipelines.ActionStep() { Id = actionId, Name = &quot;post2&quot;, DisplayName = &quot;Test 2&quot;, Reference = new Pipelines.RepositoryPathReference() { Name = &quot;actions/action&quot; } };
419                  postRunner2.Stage = ActionRunStage.Post;
420                  postRunner2.Condition = &quot;always()&quot;;
421                  postRunner2.DisplayName = &quot;post2&quot;;
422                  action1.RegisterPostJobStep(postRunner1);
423                  action2.RegisterPostJobStep(postRunner2);
424                  Assert.NotNull(jobContext.JobSteps);
425                  Assert.NotNull(jobContext.PostJobSteps);
426                  Assert.Equal(1, jobContext.PostJobSteps.Count);
427                  var post1 = jobContext.PostJobSteps.Pop();
428                  Assert.Equal(&quot;post1&quot;, (post1 as IActionRunner).Action.Name);
429                  Assert.Equal(ActionRunStage.Post, (post1 as IActionRunner).Stage);
430                  Assert.Equal(&quot;always()&quot;, (post1 as IActionRunner).Condition);
431              }
432          }
433          [Fact]
434          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
435          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
436          public void ActionResult_Lowercase()
437          {
438              using (TestHostContext hc = CreateTestContext())
439              {
440                  TaskOrchestrationPlanReference plan = new();
441                  TimelineReference timeline = new();
442                  Guid jobId = Guid.NewGuid();
443                  string jobName = &quot;some job name&quot;;
444                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
445                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
446                  {
447                      Alias = Pipelines.PipelineConstants.SelfAlias,
448                      Id = &quot;github&quot;,
449                      Version = &quot;sha1&quot;
450                  });
451                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
452                  jobRequest.Variables[&quot;ACTIONS_STEP_DEBUG&quot;] = &quot;true&quot;;
453                  var pagingLogger1 = new Mock&lt;IPagingLogger&gt;();
454                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
455                  hc.EnqueueInstance(pagingLogger1.Object);
456                  hc.SetSingleton(jobServerQueue.Object);
457                  var jobContext = new Runner.Worker.ExecutionContext();
458                  jobContext.Initialize(hc);
459                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
460                  jobContext.Global.StepsContext.SetConclusion(null, &quot;step1&quot;, ActionResult.Success);
461                  var conclusion1 = (jobContext.Global.StepsContext.GetScope(null)[&quot;step1&quot;] as DictionaryContextData)[&quot;conclusion&quot;].ToString();
462                  Assert.Equal(conclusion1, conclusion1.ToLowerInvariant());
463                  jobContext.Global.StepsContext.SetOutcome(null, &quot;step2&quot;, ActionResult.Cancelled);
464                  var outcome1 = (jobContext.Global.StepsContext.GetScope(null)[&quot;step2&quot;] as DictionaryContextData)[&quot;outcome&quot;].ToString();
465                  Assert.Equal(outcome1, outcome1.ToLowerInvariant());
466                  jobContext.Global.StepsContext.SetConclusion(null, &quot;step3&quot;, ActionResult.Failure);
467                  var conclusion2 = (jobContext.Global.StepsContext.GetScope(null)[&quot;step3&quot;] as DictionaryContextData)[&quot;conclusion&quot;].ToString();
468                  Assert.Equal(conclusion2, conclusion2.ToLowerInvariant());
469                  jobContext.Global.StepsContext.SetOutcome(null, &quot;step4&quot;, ActionResult.Skipped);
470                  var outcome2 = (jobContext.Global.StepsContext.GetScope(null)[&quot;step4&quot;] as DictionaryContextData)[&quot;outcome&quot;].ToString();
471                  Assert.Equal(outcome2, outcome2.ToLowerInvariant());
472                  jobContext.JobContext.Status = ActionResult.Success;
473                  Assert.Equal(jobContext.JobContext[&quot;status&quot;].ToString(), jobContext.JobContext[&quot;status&quot;].ToString().ToLowerInvariant());
474              }
475          }
476          [Fact]
477          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
478          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
479          public void PublishStepTelemetry_RegularStep_NoOpt()
480          {
481              using (TestHostContext hc = CreateTestContext())
482              {
483                  TaskOrchestrationPlanReference plan = new();
484                  TimelineReference timeline = new();
485                  Guid jobId = Guid.NewGuid();
486                  string jobName = &quot;some job name&quot;;
487                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
488                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
489                  {
490                      Alias = Pipelines.PipelineConstants.SelfAlias,
491                      Id = &quot;github&quot;,
492                      Version = &quot;sha1&quot;
493                  });
494                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
495                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
496                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
497                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
498                  hc.EnqueueInstance(pagingLogger.Object);
499                  hc.SetSingleton(jobServerQueue.Object);
500                  var ec = new Runner.Worker.ExecutionContext();
501                  ec.Initialize(hc);
502                  ec.InitializeJob(jobRequest, CancellationToken.None);
503                  ec.Start();
504                  ec.Complete();
505                  Assert.Equal(0, ec.Global.StepsTelemetry.Count);
506              }
507          }
508          [Fact]
509          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
510          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
511          public void PublishStepTelemetry_RegularStep()
512          {
513              using (TestHostContext hc = CreateTestContext())
514              {
515                  TaskOrchestrationPlanReference plan = new();
516                  TimelineReference timeline = new();
517                  Guid jobId = Guid.NewGuid();
518                  string jobName = &quot;some job name&quot;;
519                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
520                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
521                  {
522                      Alias = Pipelines.PipelineConstants.SelfAlias,
523                      Id = &quot;github&quot;,
524                      Version = &quot;sha1&quot;
525                  });
526                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
527                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
528                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
529                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
530                  hc.EnqueueInstance(pagingLogger.Object);
531                  hc.SetSingleton(jobServerQueue.Object);
532                  var ec = new Runner.Worker.ExecutionContext();
533                  ec.Initialize(hc);
534                  ec.InitializeJob(jobRequest, CancellationToken.None);
535                  ec.Start();
536                  ec.StepTelemetry.Type = &quot;node16&quot;;
537                  ec.StepTelemetry.Action = &quot;actions/checkout&quot;;
538                  ec.StepTelemetry.Ref = &quot;v2&quot;;
539                  ec.StepTelemetry.IsEmbedded = false;
540                  ec.StepTelemetry.StepId = Guid.NewGuid();
541                  ec.StepTelemetry.Stage = &quot;main&quot;;
542                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
543                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
544                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = &quot;notice&quot; }, ExecutionContextLogOptions.Default);
545                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
546                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
547                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = &quot;notice&quot; }, ExecutionContextLogOptions.Default);
548                  ec.Complete();
549                  Assert.Equal(1, ec.Global.StepsTelemetry.Count);
550                  Assert.Equal(&quot;node16&quot;, ec.Global.StepsTelemetry.Single().Type);
551                  Assert.Equal(&quot;actions/checkout&quot;, ec.Global.StepsTelemetry.Single().Action);
552                  Assert.Equal(&quot;v2&quot;, ec.Global.StepsTelemetry.Single().Ref);
553                  Assert.Equal(TaskResult.Succeeded, ec.Global.StepsTelemetry.Single().Result);
554                  Assert.NotNull(ec.Global.StepsTelemetry.Single().ExecutionTimeInSeconds);
555                  Assert.Equal(3, ec.Global.StepsTelemetry.Single().ErrorMessages.Count);
556                  Assert.DoesNotContain(ec.Global.StepsTelemetry.Single().ErrorMessages, x =&gt; x.Contains(&quot;notice&quot;));
557              }
558          }
559          [Fact]
560          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
561          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
562          public void PublishStepTelemetry_EmbeddedStep()
563          {
564              using (TestHostContext hc = CreateTestContext())
565              {
566                  TaskOrchestrationPlanReference plan = new();
567                  TimelineReference timeline = new();
568                  Guid jobId = Guid.NewGuid();
569                  string jobName = &quot;some job name&quot;;
570                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
571                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
572                  {
573                      Alias = Pipelines.PipelineConstants.SelfAlias,
574                      Id = &quot;github&quot;,
575                      Version = &quot;sha1&quot;
576                  });
577                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
578                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
579                  var pagingLogger2 = new Mock&lt;IPagingLogger&gt;();
580                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
581                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
582                  hc.EnqueueInstance(pagingLogger.Object);
583                  hc.EnqueueInstance(pagingLogger2.Object);
584                  hc.SetSingleton(jobServerQueue.Object);
585                  var ec = new Runner.Worker.ExecutionContext();
586                  ec.Initialize(hc);
587                  ec.InitializeJob(jobRequest, CancellationToken.None);
588                  ec.Start();
589                  var embeddedStep = ec.CreateChild(Guid.NewGuid(), &quot;action_1_pre&quot;, &quot;action_1_pre&quot;, null, null, ActionRunStage.Main, isEmbedded: true);
590                  embeddedStep.Start();
591                  embeddedStep.StepTelemetry.Type = &quot;node16&quot;;
592                  embeddedStep.StepTelemetry.Action = &quot;actions/checkout&quot;;
593                  embeddedStep.StepTelemetry.Ref = &quot;v2&quot;;
594                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
595                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
596                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Notice, Message = &quot;notice&quot; }, ExecutionContextLogOptions.Default);
597                  embeddedStep.PublishStepTelemetry();
598                  Assert.Equal(1, ec.Global.StepsTelemetry.Count);
599                  Assert.Equal(&quot;node16&quot;, ec.Global.StepsTelemetry.Single().Type);
600                  Assert.Equal(&quot;actions/checkout&quot;, ec.Global.StepsTelemetry.Single().Action);
601                  Assert.Equal(&quot;v2&quot;, ec.Global.StepsTelemetry.Single().Ref);
602                  Assert.Equal(ActionRunStage.Main.ToString(), ec.Global.StepsTelemetry.Single().Stage);
603                  Assert.True(ec.Global.StepsTelemetry.Single().IsEmbedded);
604                  Assert.Null(ec.Global.StepsTelemetry.Single().Result);
605                  Assert.Null(ec.Global.StepsTelemetry.Single().ExecutionTimeInSeconds);
606                  Assert.Equal(0, ec.Global.StepsTelemetry.Single().ErrorMessages.Count);
607              }
608          }
609          [Fact]
610          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
611          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
612          public void PublishStepResult_EmbeddedStep()
613          {
614              using (TestHostContext hc = CreateTestContext())
615              {
616                  TaskOrchestrationPlanReference plan = new();
617                  TimelineReference timeline = new();
618                  Guid jobId = Guid.NewGuid();
619                  string jobName = &quot;some job name&quot;;
620                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
621                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
622                  {
623                      Alias = Pipelines.PipelineConstants.SelfAlias,
624                      Id = &quot;github&quot;,
625                      Version = &quot;sha1&quot;
626                  });
627                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
628                  var pagingLogger = new Mock&lt;IPagingLogger&gt;();
629                  var pagingLogger2 = new Mock&lt;IPagingLogger&gt;();
630                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
631                  jobServerQueue.Setup(x =&gt; x.QueueTimelineRecordUpdate(It.IsAny&lt;Guid&gt;(), It.IsAny&lt;TimelineRecord&gt;()));
632                  hc.EnqueueInstance(pagingLogger.Object);
633                  hc.EnqueueInstance(pagingLogger2.Object);
634                  hc.SetSingleton(jobServerQueue.Object);
635                  var ec = new Runner.Worker.ExecutionContext();
636                  ec.Initialize(hc);
637                  ec.InitializeJob(jobRequest, CancellationToken.None);
638                  ec.Start();
639                  var embeddedStep = ec.CreateChild(Guid.NewGuid(), &quot;action_1_pre&quot;, &quot;action_1_pre&quot;, null, null, ActionRunStage.Main, isEmbedded: true);
640                  embeddedStep.Start();
641                  embeddedStep.StepTelemetry.Type = &quot;node16&quot;;
642                  embeddedStep.StepTelemetry.Action = &quot;actions/checkout&quot;;
643                  embeddedStep.StepTelemetry.Ref = &quot;v2&quot;;
644                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Error, Message = &quot;error&quot; }, ExecutionContextLogOptions.Default);
645                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Warning, Message = &quot;warning&quot; }, ExecutionContextLogOptions.Default);
646                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Notice, Message = &quot;notice&quot; }, ExecutionContextLogOptions.Default);
647                  ec.Complete();
648                  Assert.Equal(1, ec.Global.StepsResult.Count);
649                  Assert.Equal(TaskResult.Succeeded, ec.Global.StepsResult.Single().Conclusion);
650              }
651          }
652          private TestHostContext CreateTestContext([CallerMemberName] String testName = &quot;&quot;)
653          {
654              var hc = new TestHostContext(this, testName);
655              var configurationStore = new Mock&lt;IConfigurationStore&gt;();
656              configurationStore.Setup(x =&gt; x.GetSettings()).Returns(new RunnerSettings());
657              hc.SetSingleton(configurationStore.Object);
658              hc.SetSingleton(new Mock&lt;IJobServerQueue&gt;().Object);
659              return hc;
660          }
661          [Fact]
662          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
663          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
664          public void GetExpressionValues_ContainerStepHost()
665          {
666              using (TestHostContext hc = CreateTestContext())
667              {
668                  const string source = &quot;/home/username/Projects/work/runner/_layout&quot;;
669                  var containerInfo = new ContainerInfo();
670                  containerInfo.ContainerId = &quot;test&quot;;
671                  containerInfo.AddPathTranslateMapping($&quot;{source}/_work&quot;, &quot;/__w&quot;);
672                  containerInfo.AddPathTranslateMapping($&quot;{source}/_temp&quot;, &quot;/__t&quot;);
673                  containerInfo.AddPathTranslateMapping($&quot;{source}/externals&quot;, &quot;/__e&quot;);
674                  containerInfo.AddPathTranslateMapping($&quot;{source}/_work/_temp/_github_home&quot;, &quot;/github/home&quot;);
675                  containerInfo.AddPathTranslateMapping($&quot;{source}/_work/_temp/_github_workflow&quot;, &quot;/github/workflow&quot;);
676                  foreach (var v in new List&lt;string&gt;() {
677                      $&quot;{source}/_work&quot;,
678                      $&quot;{source}/externals&quot;,
679                      $&quot;{source}/_work/_temp&quot;,
680                      $&quot;{source}/_work/_actions&quot;,
681                      $&quot;{source}/_work/_tool&quot;,
682                  })
683                  {
684                      containerInfo.MountVolumes.Add(new MountVolume(v, containerInfo.TranslateToContainerPath(v)));
685                  };
686                  var stepHost = new ContainerStepHost();
687                  stepHost.Container = containerInfo;
688                  var ec = new Runner.Worker.ExecutionContext();
689                  ec.Initialize(hc);
690                  var inputGithubContext = new GitHubContext();
691                  var inputeRunnerContext = new RunnerContext();
692                  inputGithubContext[&quot;action_path&quot;] = new StringContextData(&quot;/home/username/Projects/work/runner/_layout/_work/_actions/owner/composite/main&quot;);
693                  inputGithubContext[&quot;action&quot;] = new StringContextData(&quot;__owner_composite&quot;);
694                  inputGithubContext[&quot;api_url&quot;] = new StringContextData(&quot;https:&amp;bsol;&amp;bsol;api.github.com/custom/path&quot;);
695                  inputGithubContext[&quot;env&quot;] = new StringContextData(&quot;/home/username/Projects/work/runner/_layout/_work/_temp/_runner_file_commands/set_env_265698aa-7f38-40f5-9316-5c01a3153672&quot;);
696                  inputGithubContext[&quot;path&quot;] = new StringContextData(&quot;/home/username/Projects/work/runner/_layout/_work/_temp/_runner_file_commands/add_path_265698aa-7f38-40f5-9316-5c01a3153672&quot;);
697                  inputGithubContext[&quot;event_path&quot;] = new StringContextData(&quot;/home/username/Projects/work/runner/_layout/_work/_temp/_github_workflow/event.json&quot;);
698                  inputGithubContext[&quot;repository&quot;] = new StringContextData(&quot;owner/repo-name&quot;);
699                  inputGithubContext[&quot;run_id&quot;] = new StringContextData(&quot;2033211332&quot;);
700                  inputGithubContext[&quot;workflow&quot;] = new StringContextData(&quot;Name of Workflow&quot;);
701                  inputGithubContext[&quot;workspace&quot;] = new StringContextData(&quot;/home/username/Projects/work/runner/_layout/_work/step-order/step-order&quot;);
702                  inputeRunnerContext[&quot;temp&quot;] = new StringContextData(&quot;/home/username/Projects/work/runner/_layout/_work/_temp&quot;);
703                  inputeRunnerContext[&quot;tool_cache&quot;] = new StringContextData(&quot;/home/username/Projects/work/runner/_layout/_work/_tool&quot;);
704                  var githubEvent = new DictionaryContextData();
705                  githubEvent[&quot;inputs&quot;] = null;
706                  githubEvent[&quot;ref&quot;] = new StringContextData(&quot;refs/heads/main&quot;);
707                  githubEvent[&quot;repository&quot;] = new DictionaryContextData();
708                  githubEvent[&quot;sender&quot;] = new DictionaryContextData();
709                  githubEvent[&quot;workflow&quot;] = new StringContextData(&quot;.github/workflows/composite_step_host_translate.yaml&quot;);
710                  inputGithubContext[&quot;event&quot;] = githubEvent;
711                  ec.ExpressionValues[&quot;github&quot;] = inputGithubContext;
712                  ec.ExpressionValues[&quot;runner&quot;] = inputeRunnerContext;
713                  var ecExpect = new Runner.Worker.ExecutionContext();
714                  ecExpect.Initialize(hc);
715                  var expectedGithubEvent = new DictionaryContextData();
716                  expectedGithubEvent[&quot;inputs&quot;] = null;
717                  expectedGithubEvent[&quot;ref&quot;] = new StringContextData(&quot;refs/heads/main&quot;);
718                  expectedGithubEvent[&quot;repository&quot;] = new DictionaryContextData();
719                  expectedGithubEvent[&quot;sender&quot;] = new DictionaryContextData();
720                  expectedGithubEvent[&quot;workflow&quot;] = new StringContextData(&quot;.github/workflows/composite_step_host_translate.yaml&quot;);
721                  var expectedGithubContext = new GitHubContext();
722                  var expectedRunnerContext = new RunnerContext();
723                  expectedGithubContext[&quot;action_path&quot;] = new StringContextData(&quot;/__w/_actions/owner/composite/main&quot;);
724                  expectedGithubContext[&quot;action&quot;] = new StringContextData(&quot;__owner_composite&quot;);
725                  expectedGithubContext[&quot;api_url&quot;] = new StringContextData(&quot;https:&amp;bsol;&amp;bsol;api.github.com/custom/path&quot;);
726                  expectedGithubContext[&quot;env&quot;] = new StringContextData(&quot;/__w/_temp/_runner_file_commands/set_env_265698aa-7f38-40f5-9316-5c01a3153672&quot;);
727                  expectedGithubContext[&quot;path&quot;] = new StringContextData(&quot;/__w/_temp/_runner_file_commands/add_path_265698aa-7f38-40f5-9316-5c01a3153672&quot;);
728                  expectedGithubContext[&quot;event_path&quot;] = new StringContextData(&quot;/github/workflow/event.json&quot;);
729                  expectedGithubContext[&quot;repository&quot;] = new StringContextData(&quot;owner/repo-name&quot;);
730                  expectedGithubContext[&quot;run_id&quot;] = new StringContextData(&quot;2033211332&quot;);
731                  expectedGithubContext[&quot;workflow&quot;] = new StringContextData(&quot;Name of Workflow&quot;);
732                  expectedGithubContext[&quot;workspace&quot;] = new StringContextData(&quot;/__w/step-order/step-order&quot;);
733                  expectedGithubContext[&quot;event&quot;] = expectedGithubEvent;
734                  expectedRunnerContext[&quot;temp&quot;] = new StringContextData(&quot;/__w/_temp&quot;);
735                  expectedRunnerContext[&quot;tool_cache&quot;] = new StringContextData(&quot;/__w/_tool&quot;);
736                  ecExpect.ExpressionValues[&quot;github&quot;] = expectedGithubContext;
737                  ecExpect.ExpressionValues[&quot;runner&quot;] = expectedRunnerContext;
738                  var translatedExpressionValues = ec.GetExpressionValues(stepHost);
739                  foreach (var contextName in new string[] { &quot;github&quot;, &quot;runner&quot; })
740                  {
741                      var dict = translatedExpressionValues[contextName].AssertDictionary($&quot;expected context github to be a dictionary&quot;);
742                      var expectedExpressionValues = ecExpect.ExpressionValues[contextName].AssertDictionary(&quot;expect dict&quot;);
743                      foreach (var key in dict.Keys.ToList())
744                      {
745                          if (dict[key] is StringContextData)
746                          {
747                              var expect = dict[key].AssertString(&quot;expect string&quot;);
748                              var outcome = expectedExpressionValues[key].AssertString(&quot;expect string&quot;);
749                              Assert.Equal(expect.Value, outcome.Value);
750                          }
751                          else if (dict[key] is DictionaryContextData || dict[key] is CaseSensitiveDictionaryContextData)
752                          {
753                              var expectDict = dict[key].AssertDictionary(&quot;expect dict&quot;);
754                              var actualDict = expectedExpressionValues[key].AssertDictionary(&quot;expect dict&quot;);
755                              Assert.True(ExpressionValuesAssertEqual(expectDict, actualDict));
756                          }
757                      }
758                  }
759              }
760          }
761          [Fact]
762          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
763          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
764          public void ActionVariables_AddedToVarsContext()
765          {
766              using (TestHostContext hc = CreateTestContext())
767              {
768                  TaskOrchestrationPlanReference plan = new();
769                  TimelineReference timeline = new();
770                  Guid jobId = Guid.NewGuid();
771                  string jobName = &quot;some job name&quot;;
772                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
773                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
774                  {
775                      Alias = Pipelines.PipelineConstants.SelfAlias,
776                      Id = &quot;github&quot;,
777                      Version = &quot;sha1&quot;
778                  });
779                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
780                  var inputVarsContext = new DictionaryContextData();
781                  inputVarsContext[&quot;VARIABLE_1&quot;] = new StringContextData(&quot;value1&quot;);
782                  inputVarsContext[&quot;VARIABLE_2&quot;] = new StringContextData(&quot;value2&quot;);
783                  jobRequest.ContextData[&quot;vars&quot;] = inputVarsContext;
784                  var pagingLogger1 = new Mock&lt;IPagingLogger&gt;();
785                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
786                  hc.EnqueueInstance(pagingLogger1.Object);
787                  hc.SetSingleton(jobServerQueue.Object);
788                  var jobContext = new Runner.Worker.ExecutionContext();
789                  jobContext.Initialize(hc);
790                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
791                  var expected = new DictionaryContextData();
792                  expected[&quot;VARIABLE_1&quot;] = new StringContextData(&quot;value1&quot;);
793                  expected[&quot;VARIABLE_2&quot;] = new StringContextData(&quot;value1&quot;);
794                  Assert.True(ExpressionValuesAssertEqual(expected, jobContext.ExpressionValues[&quot;vars&quot;] as DictionaryContextData));
795              }
796          }
797          [Fact]
798          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
799          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
800          public void ActionVariables_DebugUsingVars()
801          {
802              using (TestHostContext hc = CreateTestContext())
803              {
804                  TaskOrchestrationPlanReference plan = new TaskOrchestrationPlanReference();
805                  TimelineReference timeline = new TimelineReference();
806                  Guid jobId = Guid.NewGuid();
807                  string jobName = &quot;some job name&quot;;
808                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
809                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
810                  {
811                      Alias = Pipelines.PipelineConstants.SelfAlias,
812                      Id = &quot;github&quot;,
813                      Version = &quot;sha1&quot;
814                  });
815                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
816                  var inputVarsContext = new DictionaryContextData();
817                  inputVarsContext[Constants.Variables.Actions.StepDebug] = new StringContextData(&quot;true&quot;);
818                  inputVarsContext[Constants.Variables.Actions.RunnerDebug] = new StringContextData(&quot;true&quot;);
819                  jobRequest.ContextData[&quot;vars&quot;] = inputVarsContext;
820                  var pagingLogger1 = new Mock&lt;IPagingLogger&gt;();
821                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
822                  hc.EnqueueInstance(pagingLogger1.Object);
823                  hc.SetSingleton(jobServerQueue.Object);
824                  var jobContext = new Runner.Worker.ExecutionContext();
825                  jobContext.Initialize(hc);
826                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
827                  Assert.Equal(&quot;true&quot;, jobContext.Global.Variables.Get(Constants.Variables.Actions.StepDebug));
828                  Assert.Equal(&quot;true&quot;, jobContext.Global.Variables.Get(Constants.Variables.Actions.RunnerDebug));
829              }
830          }
831          [Fact]
832          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
833          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
834          public void ActionVariables_SecretsPrecedenceForDebugUsingVars()
835          {
836              using (TestHostContext hc = CreateTestContext())
837              {
838                  TaskOrchestrationPlanReference plan = new TaskOrchestrationPlanReference();
839                  TimelineReference timeline = new TimelineReference();
840                  Guid jobId = Guid.NewGuid();
841                  string jobName = &quot;some job name&quot;;
842                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary&lt;string, VariableValue&gt;(), new List&lt;MaskHint&gt;(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List&lt;Pipelines.ActionStep&gt;(), null, null, null, null);
843                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
844                  {
845                      Alias = Pipelines.PipelineConstants.SelfAlias,
846                      Id = &quot;github&quot;,
847                      Version = &quot;sha1&quot;
848                  });
849                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
850                  var inputVarsContext = new DictionaryContextData();
851                  inputVarsContext[Constants.Variables.Actions.StepDebug] = new StringContextData(&quot;true&quot;);
852                  inputVarsContext[Constants.Variables.Actions.RunnerDebug] = new StringContextData(&quot;true&quot;);
853                  jobRequest.ContextData[&quot;vars&quot;] = inputVarsContext;
854                  jobRequest.Variables[Constants.Variables.Actions.StepDebug] = &quot;false&quot;;
855                  jobRequest.Variables[Constants.Variables.Actions.RunnerDebug] = &quot;false&quot;;
856                  var pagingLogger1 = new Mock&lt;IPagingLogger&gt;();
857                  var jobServerQueue = new Mock&lt;IJobServerQueue&gt;();
858                  hc.EnqueueInstance(pagingLogger1.Object);
859                  hc.SetSingleton(jobServerQueue.Object);
860                  var jobContext = new Runner.Worker.ExecutionContext();
861                  jobContext.Initialize(hc);
862                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
863                  Assert.Equal(&quot;false&quot;, jobContext.Global.Variables.Get(Constants.Variables.Actions.StepDebug));
864                  Assert.Equal(&quot;false&quot;, jobContext.Global.Variables.Get(Constants.Variables.Actions.RunnerDebug));
865              }
866          }
867          private bool ExpressionValuesAssertEqual(DictionaryContextData expect, DictionaryContextData actual)
868          {
869              foreach (var key in expect.Keys.ToList())
870              {
871                  if (expect[key] is StringContextData)
872                  {
873                      var expectValue = expect[key].AssertString(&quot;expect string&quot;);
874                      var actualValue = actual[key].AssertString(&quot;expect string&quot;);
875                      if (expectValue.Equals(actualValue))
876                      {
877                          return false;
878                      }
879                  }
880                  else if (expect[key] is DictionaryContextData || expect[key] is CaseSensitiveDictionaryContextData)
881                  {
882                      var expectDict = expect[key].AssertDictionary(&quot;expect dict&quot;);
883                      var actualDict = actual[key].AssertDictionary(&quot;expect dict&quot;);
884                      if (!ExpressionValuesAssertEqual(expectDict, actualDict))
885                      {
886                          return false;
887                      }
888                  }
889              }
890              return true;
891          }
892      }
893  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ExecutionContextL0.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ExecutionContextL0.cs</div>
                </div>
                <div class="column column_space"><pre><code>843                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
844                  {
845                      Alias = Pipelines.PipelineConstants.SelfAlias,
846                      Id = &quot;github&quot;,
847                      Version = &quot;sha1&quot;
848                  });
849                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
</pre></code></div>
                <div class="column column_space"><pre><code>261                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
262                  {
263                      Alias = Pipelines.PipelineConstants.SelfAlias,
264                      Id = &quot;github&quot;,
265                      Version = &quot;sha1&quot;
266                  });
267                  jobRequest.ContextData[&quot;github&quot;] = new Pipelines.ContextData.DictionaryContextData();
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    