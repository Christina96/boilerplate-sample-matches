
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 6.116207951070336%, Tokens: 10, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>Simple.Data-MDEwOlJlcG9zaXRvcnk4MTg3Njg=-flat-ProcedureTest_35.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Linq;
4  using System.Text;
5  using NUnit.Framework;
6  using Simple.Data.Ado;
7  using Simple.Data.Mocking.Ado;
8  namespace Simple.Data.IntegrationTest
9  {
10      [TestFixture]
11      public class ProcedureTest
12      {
13          static dynamic CreateDatabase(MockDatabase mockDatabase)
14          {
15              var mockSchemaProvider = new MockSchemaProvider();
16              mockSchemaProvider.SetProcedures(new[] { "dbo", "ProcedureWithParameters" },
17                  new[] { "dbo", "ProcedureWithoutParameters"},new[] { "foo", "ProcedureInAnotherSchema"});
18              mockSchemaProvider.SetParameters(new[] { "dbo", "ProcedureWithParameters", "@One" },
19                                            new[] { "dbo", "ProcedureWithParameters", "@Two" });
20              return new Database(new AdoAdapter(new MockConnectionProvider(new MockDbConnection(mockDatabase), mockSchemaProvider)));
21          }
22          [Test]
23          public void CheckMockWorking()
24          {
25              var mockDatabase = new MockDatabase();
26              var db = CreateDatabase(mockDatabase);
27              Assert.NotNull(db);
28          }
29          [Test]
30          public void CallingMethodOnDatabase_Should_CallProcedure()
31          {
32              var mockDatabase = new MockDatabase();
33              var db = CreateDatabase(mockDatabase);
34              db.ProcedureWithoutParameters();
35              Assert.IsNotNull(mockDatabase.Sql);
36              Assert.AreEqual("[dbo].[ProcedureWithoutParameters]".ToLowerInvariant(), mockDatabase.Sql.ToLowerInvariant());
37              Assert.AreEqual(0, mockDatabase.Parameters.Count());
38          }
39          [Test]
40          public void CallingMethodOnDatabase_WithNamedParameters_Should_CallProcedure()
41          {
42              var mockDatabase = new MockDatabase();
<span onclick='openModal()' class='match'>43              var db = CreateDatabase(mockDatabase);
44              db.ProcedureWithParameters(One: 1, Two: 2);
45              Assert.AreEqual(1, mockDatabase.CommandTexts.Count);
46              Assert.AreEqual("[dbo].[ProcedureWithParameters]".ToLowerInvariant(), mockDatabase.CommandTexts[0].ToLowerInvariant());
47              Assert.AreEqual(2, mockDatabase.CommandParameters[0].Count);
48              Assert.IsTrue(mockDatabase.CommandParameters[0].ContainsKey("@One"));
</span>49              Assert.AreEqual(1, mockDatabase.CommandParameters[0]["@One"]);
50              Assert.IsTrue(mockDatabase.CommandParameters[0].ContainsKey("@Two"));
51              Assert.AreEqual(2, mockDatabase.CommandParameters[0]["@Two"]);
52          }
53          [Test]
54          public void CallingMethodOnDatabase_WithPositionalParameters_Should_CallProcedure()
55          {
56              var mockDatabase = new MockDatabase();
57              var db = CreateDatabase(mockDatabase);
58              db.ProcedureWithParameters(1, 2);
59              Assert.AreEqual(1, mockDatabase.CommandTexts.Count);
60              Assert.AreEqual("[dbo].[ProcedureWithParameters]".ToLowerInvariant(), mockDatabase.CommandTexts[0].ToLowerInvariant());
61              Assert.AreEqual(2, mockDatabase.CommandParameters[0].Count);
62              Assert.IsTrue(mockDatabase.CommandParameters[0].ContainsKey("@One"));
63              Assert.AreEqual(1, mockDatabase.CommandParameters[0]["@One"]);
64              Assert.IsTrue(mockDatabase.CommandParameters[0].ContainsKey("@Two"));
65              Assert.AreEqual(2, mockDatabase.CommandParameters[0]["@Two"]);
66          }
67          [Test]
68          public void CallingMethodOnObjectInDatabase_Should_CallProcedure()
69          {
70              var mockDatabase = new MockDatabase();
71              var db = CreateDatabase(mockDatabase);
72              db.foo.ProcedureInAnotherSchema();
73              Assert.IsNotNull(mockDatabase.Sql);
74              Assert.AreEqual("[foo].[ProcedureInAnotherSchema]".ToLowerInvariant(), mockDatabase.Sql.ToLowerInvariant());
75              Assert.AreEqual(0, mockDatabase.Parameters.Count());
76          }
77      }
78  }
</code></pre>
        </div>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-RowDescriptionMessage.cs</h3>
            <pre><code>1  using System;
2  using System.Collections;
3  using System.Collections.Generic;
4  using System.Diagnostics;
5  using System.Globalization;
6  using Npgsql.Internal;
7  using Npgsql.Internal.TypeHandlers;
8  using Npgsql.Internal.TypeHandling;
9  using Npgsql.Internal.TypeMapping;
10  using Npgsql.PostgresTypes;
11  using Npgsql.Replication.PgOutput.Messages;
12  using Npgsql.TypeMapping;
13  using Npgsql.Util;
14  namespace Npgsql.BackendMessages;
15  sealed class RowDescriptionMessage : IBackendMessage, IReadOnlyList<FieldDescription>
16  {
17      FieldDescription?[] _fields;
18      readonly Dictionary<string, int> _nameIndex;
19      Dictionary<string, int>? _insensitiveIndex;
20      internal RowDescriptionMessage(int numFields = 10)
21      {
22          _fields = new FieldDescription[numFields];
23          _nameIndex = new Dictionary<string, int>();
24      }
25      RowDescriptionMessage(RowDescriptionMessage source)
26      {
27          Count = source.Count;
28          _fields = new FieldDescription?[Count];
29          for (var i = 0; i < Count; i++)
30              _fields[i] = source._fields[i]!.Clone();
31          _nameIndex = new Dictionary<string, int>(source._nameIndex);
32          if (source._insensitiveIndex?.Count > 0)
33              _insensitiveIndex = new Dictionary<string, int>(source._insensitiveIndex);
34      }
35      internal RowDescriptionMessage Load(NpgsqlReadBuffer buf, TypeMapper typeMapper)
36      {
37          _nameIndex.Clear();
38          _insensitiveIndex?.Clear();
39          var numFields = Count = buf.ReadInt16();
40          if (_fields.Length < numFields)
41          {
42              var oldFields = _fields;
43              _fields = new FieldDescription[numFields];
44              Array.Copy(oldFields, _fields, oldFields.Length);
45          }
46          for (var i = 0; i < numFields; ++i)
47          {
<span onclick='openModal()' class='match'>48              var field = _fields[i] ??= new();
49              field.Populate(
50                  typeMapper,
51                  name:                  buf.ReadNullTerminatedString(),
52                  tableOID:              buf.ReadUInt32(),
53                  columnAttributeNumber: buf.ReadInt16(),
54                  oid:                   buf.ReadUInt32(),
55                  typeSize:              buf.ReadInt16(),
56                  typeModifier:          buf.ReadInt32(),
57                  formatCode:            (FormatCode)buf.ReadInt16()
58              );
59              _nameIndex.TryAdd(field.Name, i);
</span>60          }
61          return this;
62      }
63      internal static RowDescriptionMessage CreateForReplication(
64          TypeMapper typeMapper, uint tableOID, FormatCode formatCode, IReadOnlyList<RelationMessage.Column> columns)
65      {
66          var msg = new RowDescriptionMessage(columns.Count);
67          var numFields = msg.Count = columns.Count;
68          for (var i = 0; i < numFields; ++i)
69          {
70              var field = msg._fields[i] = new();
71              var column = columns[i];
72              field.Populate(
73                  typeMapper,
74                  name:                  column.ColumnName,
75                  tableOID:              tableOID,
76                  columnAttributeNumber: checked((short)i),
77                  oid:                   column.DataTypeId,
78                  typeSize:              0, 
79                  typeModifier:          column.TypeModifier,
80                  formatCode:            formatCode
81              );
82              if (!msg._nameIndex.ContainsKey(field.Name))
83                  msg._nameIndex.Add(field.Name, i);
84          }
85          return msg;
86      }
87      public FieldDescription this[int index]
88      {
89          get
90          {
91              Debug.Assert(index < Count);
92              Debug.Assert(_fields[index] != null);
93              return _fields[index]!;
94          }
95      }
96      public int Count { get; private set; }
97      public IEnumerator<FieldDescription> GetEnumerator() => new Enumerator(this);
98      IEnumerator IEnumerable.GetEnumerator() => GetEnumerator();
99      internal int GetFieldIndex(string name)
100      {
101          if (!TryGetFieldIndex(name, out var ret))
102              ThrowHelper.ThrowIndexOutOfRangeException($"Field not found in row: {name}");
103          return ret;
104      }
105      internal bool TryGetFieldIndex(string name, out int fieldIndex)
106      {
107          if (_nameIndex.TryGetValue(name, out fieldIndex))
108              return true;
109          if (_insensitiveIndex is null || _insensitiveIndex.Count == 0)
110          {
111              if (_insensitiveIndex == null)
112                  _insensitiveIndex = new Dictionary<string, int>(InsensitiveComparer.Instance);
113              foreach (var kv in _nameIndex)
114                  _insensitiveIndex.TryAdd(kv.Key, kv.Value);
115          }
116          return _insensitiveIndex.TryGetValue(name, out fieldIndex);
117      }
118      public BackendMessageCode Code => BackendMessageCode.RowDescription;
119      internal RowDescriptionMessage Clone() => new(this);
120      sealed class InsensitiveComparer : IEqualityComparer<string>
121      {
122          public static readonly InsensitiveComparer Instance = new();
123          static readonly CompareInfo CompareInfo = CultureInfo.InvariantCulture.CompareInfo;
124          InsensitiveComparer() {}
125          public bool Equals(string? x, string? y)
126              => CompareInfo.Compare(x, y, CompareOptions.IgnoreWidth | CompareOptions.IgnoreCase | CompareOptions.IgnoreKanaType) == 0;
127          public int GetHashCode(string o)
128              => CompareInfo.GetSortKey(o, CompareOptions.IgnoreWidth | CompareOptions.IgnoreCase | CompareOptions.IgnoreKanaType).GetHashCode();
129      }
130      sealed class Enumerator : IEnumerator<FieldDescription>
131      {
132          readonly RowDescriptionMessage _rowDescription;
133          int _pos = -1;
134          public Enumerator(RowDescriptionMessage rowDescription)
135              => _rowDescription = rowDescription;
136          public FieldDescription Current
137          {
138              get
139              {
140                  if (_pos < 0)
141                      ThrowHelper.ThrowInvalidOperationException();
142                  return _rowDescription[_pos];
143              }
144          }
145          object IEnumerator.Current => Current;
146          public bool MoveNext()
147          {
148              if (_pos == _rowDescription.Count - 1)
149                  return false;
150              _pos++;
151              return true;
152          }
153          public void Reset() => _pos = -1;
154          public void Dispose() {}
155      }
156  }
157  public sealed class FieldDescription
158  {
159  #pragma warning disable CS8618  
160      internal FieldDescription() {}
161      internal FieldDescription(uint oid)
162          : this("?", 0, 0, oid, 0, 0, FormatCode.Binary) {}
163      internal FieldDescription(
164          string name, uint tableOID, short columnAttributeNumber,
165          uint oid, short typeSize, int typeModifier, FormatCode formatCode)
166      {
167          Name = name;
168          TableOID = tableOID;
169          ColumnAttributeNumber = columnAttributeNumber;
170          TypeOID = oid;
171          TypeSize = typeSize;
172          TypeModifier = typeModifier;
173          FormatCode = formatCode;
174      }
175  #pragma warning restore CS8618
176      internal FieldDescription(FieldDescription source)
177      {
178          _typeMapper = source._typeMapper;
179          Name = source.Name;
180          TableOID = source.TableOID;
181          ColumnAttributeNumber = source.ColumnAttributeNumber;
182          TypeOID = source.TypeOID;
183          TypeSize = source.TypeSize;
184          TypeModifier = source.TypeModifier;
185          FormatCode = source.FormatCode;
186          Handler = source.Handler;
187      }
188      internal void Populate(
189          TypeMapper typeMapper, string name, uint tableOID, short columnAttributeNumber,
190          uint oid, short typeSize, int typeModifier, FormatCode formatCode
191      )
192      {
193          _typeMapper = typeMapper;
194          Name = name;
195          TableOID = tableOID;
196          ColumnAttributeNumber = columnAttributeNumber;
197          TypeOID = oid;
198          TypeSize = typeSize;
199          TypeModifier = typeModifier;
200          FormatCode = formatCode;
201          ResolveHandler();
202      }
203      internal string Name { get; set; }
204      internal uint TypeOID { get; set; }
205      public short TypeSize { get; set; }
206      public int TypeModifier { get; set; }
207      internal uint TableOID { get; set; }
208      internal short ColumnAttributeNumber { get; set; }
209      internal FormatCode FormatCode { get; set; }
210      internal string TypeDisplayName => PostgresType.GetDisplayNameWithFacets(TypeModifier);
211      internal NpgsqlTypeHandler Handler { get; private set; }
212      internal PostgresType PostgresType
213          => _typeMapper.DatabaseInfo.ByOID.TryGetValue(TypeOID, out var postgresType)
214              ? postgresType
215              : UnknownBackendType.Instance;
216      internal Type FieldType => Handler.GetFieldType(this);
217      internal void ResolveHandler()
218          => Handler = IsBinaryFormat ? _typeMapper.ResolveByOID(TypeOID) : _typeMapper.UnrecognizedTypeHandler;
219      TypeMapper _typeMapper;
220      internal bool IsBinaryFormat => FormatCode == FormatCode.Binary;
221      internal bool IsTextFormat => FormatCode == FormatCode.Text;
222      internal FieldDescription Clone()
223      {
224          var field =  new FieldDescription(this);
225          field.ResolveHandler();
226          return field;
227      }
228      public override string ToString() => Name + (Handler == null ? "" : $"({Handler.PgDisplayName})");
229  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Simple.Data-MDEwOlJlcG9zaXRvcnk4MTg3Njg=-flat-ProcedureTest_35.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-RowDescriptionMessage.cs</div>
                </div>
                <div class="column column_space"><pre><code>43              var db = CreateDatabase(mockDatabase);
44              db.ProcedureWithParameters(One: 1, Two: 2);
45              Assert.AreEqual(1, mockDatabase.CommandTexts.Count);
46              Assert.AreEqual("[dbo].[ProcedureWithParameters]".ToLowerInvariant(), mockDatabase.CommandTexts[0].ToLowerInvariant());
47              Assert.AreEqual(2, mockDatabase.CommandParameters[0].Count);
48              Assert.IsTrue(mockDatabase.CommandParameters[0].ContainsKey("@One"));
</pre></code></div>
                <div class="column column_space"><pre><code>48              var field = _fields[i] ??= new();
49              field.Populate(
50                  typeMapper,
51                  name:                  buf.ReadNullTerminatedString(),
52                  tableOID:              buf.ReadUInt32(),
53                  columnAttributeNumber: buf.ReadInt16(),
54                  oid:                   buf.ReadUInt32(),
55                  typeSize:              buf.ReadInt16(),
56                  typeModifier:          buf.ReadInt32(),
57                  formatCode:            (FormatCode)buf.ReadInt16()
58              );
59              _nameIndex.TryAdd(field.Name, i);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    