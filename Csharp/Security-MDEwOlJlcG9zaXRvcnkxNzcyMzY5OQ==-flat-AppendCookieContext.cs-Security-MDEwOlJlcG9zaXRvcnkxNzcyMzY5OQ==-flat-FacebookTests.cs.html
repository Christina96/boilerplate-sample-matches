
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 5.633802816901409%, Tokens: 10, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-AppendCookieContext.cs</h3>
            <pre><code>1  using Microsoft.AspNetCore.Http;
2  namespace Microsoft.AspNetCore.CookiePolicy
3  {
4      public class AppendCookieContext
5      {
6          public AppendCookieContext(HttpContext context, CookieOptions options, string name, string value)
7          {
8              Context = context;
9              CookieOptions = options;
10              CookieName = name;
11              CookieValue = value;
12          }
<span onclick='openModal()' class='match'>13          public HttpContext Context { get; }
14          public CookieOptions CookieOptions { get; }
</span>15          public string CookieName { get; set; }
16          public string CookieValue { get; set; }
17          public bool IsConsentNeeded { get; internal set; }
18          public bool HasConsent { get; internal set; }
19          public bool IssueCookie { get; set; }
20      }
21  }
</code></pre>
        </div>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-FacebookTests.cs</h3>
            <pre><code>1  using Microsoft.AspNetCore.Authentication.Cookies;
2  using Microsoft.AspNetCore.Authentication.OAuth;
3  using Microsoft.AspNetCore.Builder;
4  using Microsoft.AspNetCore.DataProtection;
5  using Microsoft.AspNetCore.Hosting;
6  using Microsoft.AspNetCore.Http;
7  using Microsoft.AspNetCore.TestHost;
8  using Microsoft.Extensions.DependencyInjection;
9  using Microsoft.Extensions.Logging.Abstractions;
10  using Newtonsoft.Json;
11  using System;
12  using System.Linq;
13  using System.Net;
14  using System.Net.Http;
15  using System.Text;
16  using System.Text.Encodings.Web;
17  using System.Threading.Tasks;
18  using Xunit;
19  namespace Microsoft.AspNetCore.Authentication.Facebook
20  {
21      public class FacebookTests : RemoteAuthenticationTests<FacebookOptions>
22      {
23          protected override string DefaultScheme => FacebookDefaults.AuthenticationScheme;
24          protected override Type HandlerType => typeof(FacebookHandler);
<span onclick='openModal()' class='match'>25          protected override bool SupportsSignIn { get => false; }
26          protected override bool SupportsSignOut { get => false; }
</span>27          protected override void RegisterAuth(AuthenticationBuilder services, Action<FacebookOptions> configure)
28          {
29              services.AddFacebook(o =>
30              {
31                  ConfigureDefaults(o);
32                  configure.Invoke(o);
33              });
34          }
35          protected override void ConfigureDefaults(FacebookOptions o)
36          {
37              o.AppId = "whatever";
38              o.AppSecret = "whatever";
39              o.SignInScheme = "auth1";
40          }
41          [Fact]
42          public async Task ThrowsIfAppIdMissing()
43          {
44              var server = CreateServer(
45                  app => { },
46                  services => services.AddAuthentication().AddFacebook(o => o.SignInScheme = "Whatever"),
47                  async context =>
48                  {
49                      await Assert.ThrowsAsync<ArgumentException>("AppId", () => context.ChallengeAsync("Facebook"));
50                      return true;
51                  });
52              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/challenge");
53              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
54          }
55          [Fact]
56          public async Task ThrowsIfAppSecretMissing()
57          {
58              var server = CreateServer(
59                  app => { },
60                  services => services.AddAuthentication().AddFacebook(o => o.AppId = "Whatever"),
61                  async context =>
62                  {
63                      await Assert.ThrowsAsync<ArgumentException>("AppSecret", () => context.ChallengeAsync("Facebook"));
64                      return true;
65                  });
66              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/challenge");
67              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
68          }
69          [Fact]
70          public async Task ChallengeWillTriggerApplyRedirectEvent()
71          {
72              var server = CreateServer(
73                  app =>
74                  {
75                      app.UseAuthentication();
76                  },
77                  services =>
78                  {
79                      services.AddAuthentication("External")
80                          .AddCookie("External", o => { })
81                          .AddFacebook(o =>
82                      {
83                          o.AppId = "Test App Id";
84                          o.AppSecret = "Test App Secret";
85                          o.Events = new OAuthEvents
86                          {
87                              OnRedirectToAuthorizationEndpoint = context =>
88                              {
89                                  context.Response.Redirect(context.RedirectUri + "&custom=test");
90                                  return Task.FromResult(0);
91                              }
92                          };
93                      });
94                  },
95                  async context =>
96                  {
97                      await context.ChallengeAsync("Facebook");
98                      return true;
99                  });
100              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/challenge");
101              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
102              var query = transaction.Response.Headers.Location.Query;
103              Assert.Contains("custom=test", query);
104          }
105          [Fact]
106          public async Task ChallengeWillIncludeScopeAsConfigured()
107          {
108              var server = CreateServer(
109                  app => app.UseAuthentication(),
110                  services =>
111                  {
112                      services.AddAuthentication().AddFacebook(o =>
113                      {
114                          o.AppId = "Test App Id";
115                          o.AppSecret = "Test App Secret";
116                          o.Scope.Clear();
117                          o.Scope.Add("foo");
118                          o.Scope.Add("bar");
119                      });
120                  },
121                  async context =>
122                  {
123                      await context.ChallengeAsync(FacebookDefaults.AuthenticationScheme);
124                      return true;
125                  });
126              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/challenge");
127              var res = transaction.Response;
128              Assert.Equal(HttpStatusCode.Redirect, res.StatusCode);
129              Assert.Contains("scope=foo,bar", res.Headers.Location.Query);
130          }
131          [Fact]
132          public async Task ChallengeWillIncludeScopeAsOverwritten()
133          {
134              var server = CreateServer(
135                  app => app.UseAuthentication(),
136                  services =>
137                  {
138                      services.AddAuthentication().AddFacebook(o =>
139                      {
140                          o.AppId = "Test App Id";
141                          o.AppSecret = "Test App Secret";
142                          o.Scope.Clear();
143                          o.Scope.Add("foo");
144                          o.Scope.Add("bar");
145                      });
146                  },
147                  async context =>
148                  {
149                      var properties = new OAuthChallengeProperties();
150                      properties.SetScope("baz", "qux");
151                      await context.ChallengeAsync(FacebookDefaults.AuthenticationScheme, properties);
152                      return true;
153                  });
154              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/challenge");
155              var res = transaction.Response;
156              Assert.Equal(HttpStatusCode.Redirect, res.StatusCode);
157              Assert.Contains("scope=baz,qux", res.Headers.Location.Query);
158          }
159          [Fact]
160          public async Task ChallengeWillIncludeScopeAsOverwrittenWithBaseAuthenticationProperties()
161          {
162              var server = CreateServer(
163                  app => app.UseAuthentication(),
164                  services =>
165                  {
166                      services.AddAuthentication().AddFacebook(o =>
167                      {
168                          o.AppId = "Test App Id";
169                          o.AppSecret = "Test App Secret";
170                          o.Scope.Clear();
171                          o.Scope.Add("foo");
172                          o.Scope.Add("bar");
173                      });
174                  },
175                  async context =>
176                  {
177                      var properties = new AuthenticationProperties();
178                      properties.SetParameter(OAuthChallengeProperties.ScopeKey, new string[] { "baz", "qux" });
179                      await context.ChallengeAsync(FacebookDefaults.AuthenticationScheme, properties);
180                      return true;
181                  });
182              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/challenge");
183              var res = transaction.Response;
184              Assert.Equal(HttpStatusCode.Redirect, res.StatusCode);
185              Assert.Contains("scope=baz,qux", res.Headers.Location.Query);
186          }
187          [Fact]
188          public async Task NestedMapWillNotAffectRedirect()
189          {
190              var server = CreateServer(app => app.Map("/base", map =>
191              {
192                  map.UseAuthentication();
193                  map.Map("/login", signoutApp => signoutApp.Run(context => context.ChallengeAsync("Facebook", new AuthenticationProperties() { RedirectUri = "/" })));
194              }),
195              services =>
196              {
197                  services.AddAuthentication()
198                      .AddCookie("External", o => { })
199                      .AddFacebook(o =>
200                  {
201                      o.AppId = "Test App Id";
202                      o.AppSecret = "Test App Secret";
203                  });
204              },
205              handler: null);
206              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/base/login");
207              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
208              var location = transaction.Response.Headers.Location.AbsoluteUri;
209              Assert.Contains("https:&bsol;&bsol;www.facebook.com/v3.1/dialog/oauth", location);
210              Assert.Contains("response_type=code", location);
211              Assert.Contains("client_id=", location);
212              Assert.Contains("redirect_uri=" + UrlEncoder.Default.Encode("http:&bsol;&bsol;example.com/base/signin-facebook"), location);
213              Assert.Contains("scope=", location);
214              Assert.Contains("state=", location);
215          }
216          [Fact]
217          public async Task MapWillNotAffectRedirect()
218          {
219              var server = CreateServer(
220                  app =>
221                  {
222                      app.UseAuthentication();
223                      app.Map("/login", signoutApp => signoutApp.Run(context => context.ChallengeAsync("Facebook", new AuthenticationProperties() { RedirectUri = "/" })));
224                  },
225                  services =>
226                  {
227                      services.AddAuthentication()
228                          .AddCookie("External", o => { })
229                          .AddFacebook(o =>
230                      {
231                          o.AppId = "Test App Id";
232                          o.AppSecret = "Test App Secret";
233                          o.SignInScheme = "External";
234                      });
235                  },
236                  handler: null);
237              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/login");
238              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
239              var location = transaction.Response.Headers.Location.AbsoluteUri;
240              Assert.Contains("https:&bsol;&bsol;www.facebook.com/v3.1/dialog/oauth", location);
241              Assert.Contains("response_type=code", location);
242              Assert.Contains("client_id=", location);
243              Assert.Contains("redirect_uri=" + UrlEncoder.Default.Encode("http:&bsol;&bsol;example.com/signin-facebook"), location);
244              Assert.Contains("scope=", location);
245              Assert.Contains("state=", location);
246          }
247          [Fact]
248          public async Task ChallengeWillTriggerRedirection()
249          {
250              var server = CreateServer(
251                  app => app.UseAuthentication(),
252                  services =>
253                  {
254                      services.AddAuthentication(options =>
255                      {
256                          options.DefaultSignInScheme = "External";
257                      })
258                          .AddCookie()
259                          .AddFacebook(o =>
260                      {
261                          o.AppId = "Test App Id";
262                          o.AppSecret = "Test App Secret";
263                      });
264                  },
265                  async context =>
266                  {
267                      await context.ChallengeAsync("Facebook");
268                      return true;
269                  });
270              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/challenge");
271              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
272              var location = transaction.Response.Headers.Location.AbsoluteUri;
273              Assert.Contains("https:&bsol;&bsol;www.facebook.com/v3.1/dialog/oauth", location);
274              Assert.Contains("response_type=code", location);
275              Assert.Contains("client_id=", location);
276              Assert.Contains("redirect_uri=", location);
277              Assert.Contains("scope=", location);
278              Assert.Contains("state=", location);
279          }
280          [Fact]
281          public async Task CustomUserInfoEndpointHasValidGraphQuery()
282          {
283              var customUserInfoEndpoint = "https:&bsol;&bsol;graph.facebook.com/me?fields=email,timezone,picture";
284              var finalUserInfoEndpoint = string.Empty;
285              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("FacebookTest"));
286              var server = CreateServer(
287                  app => app.UseAuthentication(),
288                  services =>
289                  {
290                      services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
291                          .AddCookie()
292                          .AddFacebook(o =>
293                      {
294                          o.AppId = "Test App Id";
295                          o.AppSecret = "Test App Secret";
296                          o.StateDataFormat = stateFormat;
297                          o.UserInformationEndpoint = customUserInfoEndpoint;
298                          o.BackchannelHttpHandler = new TestHttpMessageHandler
299                          {
300                              Sender = req =>
301                              {
302                                  if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == FacebookDefaults.TokenEndpoint)
303                                  {
304                                      var res = new HttpResponseMessage(HttpStatusCode.OK);
305                                      var graphResponse = JsonConvert.SerializeObject(new
306                                      {
307                                          access_token = "TestAuthToken"
308                                      });
309                                      res.Content = new StringContent(graphResponse, Encoding.UTF8);
310                                      return res;
311                                  }
312                                  if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) ==
313                                      new Uri(customUserInfoEndpoint).GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped))
314                                  {
315                                      finalUserInfoEndpoint = req.RequestUri.ToString();
316                                      var res = new HttpResponseMessage(HttpStatusCode.OK);
317                                      var graphResponse = JsonConvert.SerializeObject(new
318                                      {
319                                          id = "TestProfileId",
320                                          name = "TestName"
321                                      });
322                                      res.Content = new StringContent(graphResponse, Encoding.UTF8);
323                                      return res;
324                                  }
325                                  return null;
326                              }
327                          };
328                      });
329                  },
330                  handler: null);
331              var properties = new AuthenticationProperties();
332              var correlationKey = ".xsrf";
333              var correlationValue = "TestCorrelationId";
334              properties.Items.Add(correlationKey, correlationValue);
335              properties.RedirectUri = "/me";
336              var state = stateFormat.Protect(properties);
337              var transaction = await server.SendAsync(
338                  "https:&bsol;&bsol;example.com/signin-facebook?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
339                  $".AspNetCore.Correlation.Facebook.{correlationValue}=N");
340              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
341              Assert.Equal("/me", transaction.Response.Headers.GetValues("Location").First());
342              Assert.Equal(1, finalUserInfoEndpoint.Count(c => c == '?'));
343              Assert.Contains("fields=email,timezone,picture", finalUserInfoEndpoint);
344              Assert.Contains("&access_token=", finalUserInfoEndpoint);
345          }
346          private static TestServer CreateServer(Action<IApplicationBuilder> configure, Action<IServiceCollection> configureServices, Func<HttpContext, Task<bool>> handler)
347          {
348              var builder = new WebHostBuilder()
349                  .Configure(app =>
350                  {
351                      configure?.Invoke(app);
352                      app.Use(async (context, next) =>
353                      {
354                          if (handler == null || !await handler(context))
355                          {
356                              await next();
357                          }
358                      });
359                  })
360                  .ConfigureServices(configureServices);
361              return new TestServer(builder);
362          }
363      }
364  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-AppendCookieContext.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-FacebookTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>13          public HttpContext Context { get; }
14          public CookieOptions CookieOptions { get; }
</pre></code></div>
                <div class="column column_space"><pre><code>25          protected override bool SupportsSignIn { get => false; }
26          protected override bool SupportsSignOut { get => false; }
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    