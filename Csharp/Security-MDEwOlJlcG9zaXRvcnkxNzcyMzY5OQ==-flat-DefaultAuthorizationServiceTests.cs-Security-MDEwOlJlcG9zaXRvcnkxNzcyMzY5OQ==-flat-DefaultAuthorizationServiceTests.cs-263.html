
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 22, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-DefaultAuthorizationServiceTests.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Linq;
4  using System.Security.Claims;
5  using System.Threading.Tasks;
6  using Microsoft.AspNetCore.Authorization.Infrastructure;
7  using Microsoft.Extensions.DependencyInjection;
8  using Microsoft.Extensions.Options;
9  using Xunit;
10  namespace Microsoft.AspNetCore.Authorization.Test
11  {
12      public class DefaultAuthorizationServiceTests
13      {
14          private IAuthorizationService BuildAuthorizationService(Action&lt;IServiceCollection&gt; setupServices = null)
15          {
16              var services = new ServiceCollection();
17              services.AddAuthorization();
18              services.AddLogging();
19              services.AddOptions();
20              setupServices?.Invoke(services);
21              return services.BuildServiceProvider().GetRequiredService&lt;IAuthorizationService&gt;();
22          }
23          [Fact]
24          public async Task AuthorizeCombineThrowsOnUnknownPolicy()
25          {
26              var provider = new DefaultAuthorizationPolicyProvider(Options.Create(new AuthorizationOptions()));
27              await Assert.ThrowsAsync&lt;InvalidOperationException&gt;(() =&gt; AuthorizationPolicy.CombineAsync(provider, new AuthorizeAttribute[] {
28                  new AuthorizeAttribute { Policy = &quot;Wut&quot; }
29              }));
30          }
31          [Fact]
32          public async Task Authorize_ShouldAllowIfClaimIsPresent()
33          {
34              var authorizationService = BuildAuthorizationService(services =&gt;
35              {
36                  services.AddAuthorization(options =&gt;
37                  {
38                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;));
39                  });
40              });
41              var user = new ClaimsPrincipal(new ClaimsIdentity(new Claim[] { new Claim(&quot;Permission&quot;, &quot;CanViewPage&quot;) }));
42              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
43              Assert.True(allowed.Succeeded);
44          }
45          [Fact]
46          public async Task Authorize_ShouldAllowIfClaimIsPresentWithSpecifiedAuthType()
47          {
48              var authorizationService = BuildAuthorizationService(services =&gt;
49              {
50                  services.AddAuthorization(options =&gt;
51                  {
52                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; {
53                          policy.AddAuthenticationSchemes(&quot;Basic&quot;);
54                          policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;);
55                      });
56                  });
57              });
58              var user = new ClaimsPrincipal(new ClaimsIdentity(new Claim[] { new Claim(&quot;Permission&quot;, &quot;CanViewPage&quot;) }, &quot;Basic&quot;));
59              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
60              Assert.True(allowed.Succeeded);
61          }
62          [Fact]
63          public async Task Authorize_ShouldAllowIfClaimIsAmongValues()
64          {
65              var authorizationService = BuildAuthorizationService(services =&gt;
66              {
67                  services.AddAuthorization(options =&gt;
68                  {
69                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;, &quot;CanViewAnything&quot;));
70                  });
71              });
72              var user = new ClaimsPrincipal(
73                  new ClaimsIdentity(
74                      new Claim[] {
75                          new Claim(&quot;Permission&quot;, &quot;CanViewPage&quot;),
76                          new Claim(&quot;Permission&quot;, &quot;CanViewAnything&quot;)
77                      },
78                      &quot;Basic&quot;)
79                  );
80              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
81              Assert.True(allowed.Succeeded);
82          }
83          [Fact]
84          public async Task Authorize_ShouldInvokeAllHandlersByDefault()
85          {
86              var handler1 = new FailHandler();
87              var handler2 = new FailHandler();
88              var authorizationService = BuildAuthorizationService(services =&gt;
89              {
90                  services.AddSingleton&lt;IAuthorizationHandler&gt;(handler1);
91                  services.AddSingleton&lt;IAuthorizationHandler&gt;(handler2);
92                  services.AddAuthorization(options =&gt;
93                  {
94                      options.AddPolicy(&quot;Custom&quot;, policy =&gt; policy.Requirements.Add(new CustomRequirement()));
95                  });
96              });
97              var allowed = await authorizationService.AuthorizeAsync(new ClaimsPrincipal(), &quot;Custom&quot;);
98              Assert.False(allowed.Succeeded);
99              Assert.True(allowed.Failure.FailCalled);
100              Assert.True(handler1.Invoked);
101              Assert.True(handler2.Invoked);
102          }
103          [Theory]
104          [InlineData(true)]
105          [InlineData(false)]
106          public async Task Authorize_ShouldInvokeAllHandlersDependingOnSetting(bool invokeAllHandlers)
107          {
108              var handler1 = new FailHandler();
109              var handler2 = new FailHandler();
110              var authorizationService = BuildAuthorizationService(services =&gt;
111              {
112                  services.AddSingleton&lt;IAuthorizationHandler&gt;(handler1);
113                  services.AddSingleton&lt;IAuthorizationHandler&gt;(handler2);
114                  services.AddAuthorization(options =&gt;
115                  {
116                      options.InvokeHandlersAfterFailure = invokeAllHandlers;
117                      options.AddPolicy(&quot;Custom&quot;, policy =&gt; policy.Requirements.Add(new CustomRequirement()));
118                  });
119              });
120              var allowed = await authorizationService.AuthorizeAsync(new ClaimsPrincipal(), &quot;Custom&quot;);
121              Assert.False(allowed.Succeeded);
122              Assert.True(handler1.Invoked);
123              Assert.Equal(invokeAllHandlers, handler2.Invoked);
124          }
125          private class FailHandler : IAuthorizationHandler
126          {
127              public bool Invoked { get; set; }
128              public Task HandleAsync(AuthorizationHandlerContext context)
129              {
130                  Invoked = true;
131                  context.Fail();
132                  return Task.FromResult(0);
133              }
134          }
135          [Fact]
136          public async Task Authorize_ShouldFailWhenAllRequirementsNotHandled()
137          {
138              var authorizationService = BuildAuthorizationService(services =&gt;
139              {
140                  services.AddAuthorization(options =&gt;
141                  {
142                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;, &quot;CanViewAnything&quot;));
143                  });
144              });
145              var user = new ClaimsPrincipal(
146                  new ClaimsIdentity(
147                      new Claim[] {
148                          new Claim(&quot;SomethingElse&quot;, &quot;CanViewPage&quot;),
149                      },
150                      &quot;Basic&quot;)
151                  );
152              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
153              Assert.False(allowed.Succeeded);
154              Assert.IsType&lt;ClaimsAuthorizationRequirement&gt;(allowed.Failure.FailedRequirements.First());
155          }
156          [Fact]
157          public async Task Authorize_ShouldNotAllowIfClaimTypeIsNotPresent()
158          {
159              var authorizationService = BuildAuthorizationService(services =&gt;
160              {
161                  services.AddAuthorization(options =&gt;
162                  {
163                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;, &quot;CanViewAnything&quot;));
164                  });
165              });
166              var user = new ClaimsPrincipal(
167                  new ClaimsIdentity(
168                      new Claim[] {
169                          new Claim(&quot;SomethingElse&quot;, &quot;CanViewPage&quot;),
170                      },
171                      &quot;Basic&quot;)
172                  );
173              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
174              Assert.False(allowed.Succeeded);
175          }
176          [Fact]
177          public async Task Authorize_ShouldNotAllowIfClaimValueIsNotPresent()
178          {
179              var authorizationService = BuildAuthorizationService(services =&gt;
180              {
181                  services.AddAuthorization(options =&gt;
182                  {
183                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;));
184                  });
185              });
186              var user = new ClaimsPrincipal(
187                  new ClaimsIdentity(
188                      new Claim[] {
189                          new Claim(&quot;Permission&quot;, &quot;CanViewComment&quot;),
190                      },
191                      &quot;Basic&quot;)
192                  );
193              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
194              Assert.False(allowed.Succeeded);
195          }
196          [Fact]
197          public async Task Authorize_ShouldNotAllowIfNoClaims()
198          {
199              var authorizationService = BuildAuthorizationService(services =&gt;
200              {
201                  services.AddAuthorization(options =&gt;
202                  {
203                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;));
204                  });
205              });
206              var user = new ClaimsPrincipal(
207                  new ClaimsIdentity(
208                      new Claim[0],
209                      &quot;Basic&quot;)
210                  );
211              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
212              Assert.False(allowed.Succeeded);
213          }
214          [Fact]
215          public async Task Authorize_ShouldNotAllowIfUserIsNull()
216          {
217              var authorizationService = BuildAuthorizationService(services =&gt;
218              {
219                  services.AddAuthorization(options =&gt;
220                  {
221                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;));
222                  });
223              });
224              var allowed = await authorizationService.AuthorizeAsync(null, null, &quot;Basic&quot;);
225              Assert.False(allowed.Succeeded);
226          }
227          [Fact]
228          public async Task Authorize_ShouldNotAllowIfNotCorrectAuthType()
229          {
230              var authorizationService = BuildAuthorizationService(services =&gt;
231              {
232                  services.AddAuthorization(options =&gt;
233                  {
234                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;));
235                  });
236              });
237              var user = new ClaimsPrincipal(new ClaimsIdentity());
238              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
239              Assert.False(allowed.Succeeded);
240          }
241          [Fact]
242          public async Task Authorize_ShouldAllowWithNoAuthType()
243          {
244              var authorizationService = BuildAuthorizationService(services =&gt;
245              {
246                  services.AddAuthorization(options =&gt;
247                  {
248                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;));
249                  });
250              });
251              var user = new ClaimsPrincipal(
252                  new ClaimsIdentity(
253                      new Claim[] {
254                          new Claim(&quot;Permission&quot;, &quot;CanViewPage&quot;),
255                      },
256                      &quot;Basic&quot;)
257                  );
258              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
259              Assert.True(allowed.Succeeded);
260          }
261          [Fact]
262          public async Task Authorize_ThrowsWithUnknownPolicy()
263          {
264              var authorizationService = BuildAuthorizationService();
265              var exception = await Assert.ThrowsAsync&lt;InvalidOperationException&gt;(() =&gt; authorizationService.AuthorizeAsync(new ClaimsPrincipal(), &quot;whatever&quot;, &quot;BogusPolicy&quot;));
266              Assert.Equal(&quot;No policy found: BogusPolicy.&quot;, exception.Message);
267          }
268          [Fact]
269          public async Task Authorize_CustomRolePolicy()
270          {
271              var policy = new AuthorizationPolicyBuilder().RequireRole(&quot;Administrator&quot;)
272                  .RequireClaim(ClaimTypes.Role, &quot;User&quot;);
273              var authorizationService = BuildAuthorizationService();
274              var user = new ClaimsPrincipal(
275                  new ClaimsIdentity(
276                      new Claim[] {
277                          new Claim(ClaimTypes.Role, &quot;User&quot;),
278                          new Claim(ClaimTypes.Role, &quot;Administrator&quot;)
279                      },
280                      &quot;Basic&quot;)
281                  );
282              var allowed = await authorizationService.AuthorizeAsync(user, policy.Build());
283              Assert.True(allowed.Succeeded);
284          }
285          [Fact]
286          public async Task Authorize_HasAnyClaimOfTypePolicy()
287          {
288              var policy = new AuthorizationPolicyBuilder().RequireClaim(ClaimTypes.Role);
289              var authorizationService = BuildAuthorizationService();
290              var user = new ClaimsPrincipal(
291                  new ClaimsIdentity(
292                      new Claim[] {
293                          new Claim(ClaimTypes.Role, &quot;none&quot;),
294                      },
295                      &quot;Basic&quot;)
296                  );
297              var allowed = await authorizationService.AuthorizeAsync(user, policy.Build());
298              Assert.True(allowed.Succeeded);
299          }
300          [Fact]
301          public async Task Authorize_PolicyCanAuthenticationSchemeWithNameClaim()
302          {
303              var policy = new AuthorizationPolicyBuilder(&quot;AuthType&quot;).RequireClaim(ClaimTypes.Name);
304              var authorizationService = BuildAuthorizationService();
305              var user = new ClaimsPrincipal(
306                  new ClaimsIdentity(new Claim[] { new Claim(ClaimTypes.Name, &quot;Name&quot;) }, &quot;AuthType&quot;)
307                  );
308              var allowed = await authorizationService.AuthorizeAsync(user, policy.Build());
309              Assert.True(allowed.Succeeded);
310          }
311          [Fact]
312          public async Task RolePolicyCanRequireSingleRole()
313          {
314              var policy = new AuthorizationPolicyBuilder(&quot;AuthType&quot;).RequireRole(&quot;Admin&quot;);
315              var authorizationService = BuildAuthorizationService();
316              var user = new ClaimsPrincipal(
317                  new ClaimsIdentity(new Claim[] { new Claim(ClaimTypes.Role, &quot;Admin&quot;) }, &quot;AuthType&quot;)
318              );
319              var allowed = await authorizationService.AuthorizeAsync(user, null, policy.Build());
320              Assert.True(allowed.Succeeded);
321          }
322          [Fact]
323          public async Task RolePolicyCanRequireOneOfManyRoles()
324          {
325              var policy = new AuthorizationPolicyBuilder(&quot;AuthType&quot;).RequireRole(&quot;Admin&quot;, &quot;Users&quot;);
326              var authorizationService = BuildAuthorizationService();
327              var user = new ClaimsPrincipal(
328                  new ClaimsIdentity(new Claim[] { new Claim(ClaimTypes.Role, &quot;Users&quot;) }, &quot;AuthType&quot;));
329              var allowed = await authorizationService.AuthorizeAsync(user, policy.Build());
330              Assert.True(allowed.Succeeded);
331          }
332          [Fact]
333          public async Task RolePolicyCanBlockWrongRole()
334          {
335              var policy = new AuthorizationPolicyBuilder().RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;);
336              var authorizationService = BuildAuthorizationService();
337              var user = new ClaimsPrincipal(
338                  new ClaimsIdentity(
339                      new Claim[] {
340                          new Claim(ClaimTypes.Role, &quot;Nope&quot;),
341                      },
342                      &quot;AuthType&quot;)
343                  );
344              var allowed = await authorizationService.AuthorizeAsync(user, policy.Build());
345              Assert.False(allowed.Succeeded);
346          }
347          [Fact]
348          public async Task RolePolicyCanBlockNoRole()
349          {
350              var authorizationService = BuildAuthorizationService(services =&gt;
351              {
352                  services.AddAuthorization(options =&gt;
353                  {
354                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireRole(&quot;Admin&quot;, &quot;Users&quot;));
355                  });
356              });
357              var user = new ClaimsPrincipal(
358                  new ClaimsIdentity(
359                      new Claim[] {
360                      },
361                      &quot;AuthType&quot;)
362                  );
363              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
364              Assert.False(allowed.Succeeded);
365          }
366          [Fact]
367          public void PolicyThrowsWithNoRequirements()
368          {
369              Assert.Throws&lt;InvalidOperationException&gt;(() =&gt; BuildAuthorizationService(services =&gt;
370              {
371                  services.AddAuthorization(options =&gt;
372                  {
373                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; { });
374                  });
375              }));
376          }
377          [Fact]
378          public async Task RequireUserNameFailsForWrongUserName()
379          {
380              var authorizationService = BuildAuthorizationService(services =&gt;
381              {
382                  services.AddAuthorization(options =&gt;
383                  {
384                      options.AddPolicy(&quot;Hao&quot;, policy =&gt; policy.RequireUserName(&quot;Hao&quot;));
385                  });
386              });
387              var user = new ClaimsPrincipal(
388                  new ClaimsIdentity(
389                      new Claim[] {
390                          new Claim(ClaimTypes.Name, &quot;Tek&quot;),
391                      },
392                      &quot;AuthType&quot;)
393                  );
394              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Hao&quot;);
395              Assert.False(allowed.Succeeded);
396          }
397          [Fact]
398          public async Task CanRequireUserName()
399          {
400              var authorizationService = BuildAuthorizationService(services =&gt;
401              {
402                  services.AddAuthorization(options =&gt;
403                  {
404                      options.AddPolicy(&quot;Hao&quot;, policy =&gt; policy.RequireUserName(&quot;Hao&quot;));
405                  });
406              });
407              var user = new ClaimsPrincipal(
408                  new ClaimsIdentity(
409                      new Claim[] {
410                          new Claim(ClaimTypes.Name, &quot;Hao&quot;),
411                      },
412                      &quot;AuthType&quot;)
413                  );
414              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Hao&quot;);
415              Assert.True(allowed.Succeeded);
416          }
417          [Fact]
418          public async Task CanRequireUserNameWithDiffClaimType()
419          {
420              var authorizationService = BuildAuthorizationService(services =&gt;
421              {
422                  services.AddAuthorization(options =&gt;
423                  {
424                      options.AddPolicy(&quot;Hao&quot;, policy =&gt; policy.RequireUserName(&quot;Hao&quot;));
425                  });
426              });
427              var identity = new ClaimsIdentity(&quot;AuthType&quot;, &quot;Name&quot;, &quot;Role&quot;);
428              identity.AddClaim(new Claim(&quot;Name&quot;, &quot;Hao&quot;));
429              var user = new ClaimsPrincipal(identity);
430              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Hao&quot;);
431              Assert.True(allowed.Succeeded);
432          }
433          [Fact]
434          public async Task CanRequireRoleWithDiffClaimType()
435          {
436              var authorizationService = BuildAuthorizationService(services =&gt;
437              {
438                  services.AddAuthorization(options =&gt;
439                  {
440                      options.AddPolicy(&quot;Hao&quot;, policy =&gt; policy.RequireRole(&quot;Hao&quot;));
441                  });
442              });
443              var identity = new ClaimsIdentity(&quot;AuthType&quot;, &quot;Name&quot;, &quot;Role&quot;);
444              identity.AddClaim(new Claim(&quot;Role&quot;, &quot;Hao&quot;));
445              var user = new ClaimsPrincipal(identity);
446              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Hao&quot;);
447              Assert.True(allowed.Succeeded);
448          }
449          [Fact]
450          public async Task CanApproveAnyAuthenticatedUser()
451          {
452              var authorizationService = BuildAuthorizationService(services =&gt;
453              {
454                  services.AddAuthorization(options =&gt;
455                  {
456                      options.AddPolicy(&quot;Any&quot;, policy =&gt; policy.RequireAuthenticatedUser());
457                  });
458              });
459              var user = new ClaimsPrincipal(new ClaimsIdentity());
460              user.AddIdentity(new ClaimsIdentity(
461                  new Claim[] {
462                      new Claim(ClaimTypes.Name, &quot;Name&quot;),
463                  },
464                  &quot;AuthType&quot;));
465              var allowed = await authorizationService.AuthorizeAsync(user, null, &quot;Any&quot;);
466              Assert.True(allowed.Succeeded);
467          }
468          [Fact]
469          public async Task CanBlockNonAuthenticatedUser()
470          {
471              var authorizationService = BuildAuthorizationService(services =&gt;
472              {
473                  services.AddAuthorization(options =&gt;
474                  {
475                      options.AddPolicy(&quot;Any&quot;, policy =&gt; policy.RequireAuthenticatedUser());
476                  });
477              });
478              var user = new ClaimsPrincipal(new ClaimsIdentity());
479              var allowed = await authorizationService.AuthorizeAsync(user, null, &quot;Any&quot;);
480              Assert.False(allowed.Succeeded);
481          }
482          public class CustomRequirement : IAuthorizationRequirement { }
483          public class CustomHandler : AuthorizationHandler&lt;CustomRequirement&gt;
484          {
485              public bool Invoked { get; set; }
486              protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, CustomRequirement requirement)
487              {
488                  Invoked = true;
489                  context.Succeed(requirement);
490                  return Task.FromResult(0);
491              }
492          }
493          [Fact]
494          public async Task CustomReqWithNoHandlerFails()
495          {
496              var authorizationService = BuildAuthorizationService(services =&gt;
497              {
498                  services.AddAuthorization(options =&gt;
499                  {
500                      options.AddPolicy(&quot;Custom&quot;, policy =&gt; policy.Requirements.Add(new CustomRequirement()));
501                  });
502              });
503              var user = new ClaimsPrincipal();
504              var allowed = await authorizationService.AuthorizeAsync(user, null, &quot;Custom&quot;);
505              Assert.False(allowed.Succeeded);
506          }
507          [Fact]
508          public async Task CustomReqWithHandlerSucceeds()
509          {
510              var authorizationService = BuildAuthorizationService(services =&gt;
511              {
512                  services.AddTransient&lt;IAuthorizationHandler, CustomHandler&gt;();
513                  services.AddAuthorization(options =&gt;
514                  {
515                      options.AddPolicy(&quot;Custom&quot;, policy =&gt; policy.Requirements.Add(new CustomRequirement()));
516                  });
517              });
518              var user = new ClaimsPrincipal();
519              var allowed = await authorizationService.AuthorizeAsync(user, null, &quot;Custom&quot;);
520              Assert.True(allowed.Succeeded);
521          }
522          public class PassThroughRequirement : AuthorizationHandler&lt;PassThroughRequirement&gt;, IAuthorizationRequirement
523          {
524              public PassThroughRequirement(bool succeed)
525              {
526                  Succeed = succeed;
527              }
528              public bool Succeed { get; set; }
529              protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, PassThroughRequirement requirement)
530              {
531                  if (Succeed) {
532                      context.Succeed(requirement);
533                  }
534                  return Task.FromResult(0);
535              }
536          }
537          [Theory]
538          [InlineData(true)]
539          [InlineData(false)]
540          public async Task PassThroughRequirementWillSucceedWithoutCustomHandler(bool shouldSucceed)
541          {
542              var authorizationService = BuildAuthorizationService(services =&gt;
543              {
544                  services.AddAuthorization(options =&gt;
545                  {
546                      options.AddPolicy(&quot;Passthrough&quot;, policy =&gt; policy.Requirements.Add(new PassThroughRequirement(shouldSucceed)));
547                  });
548              });
549              var user = new ClaimsPrincipal();
550              var allowed = await authorizationService.AuthorizeAsync(user, null, &quot;Passthrough&quot;);
551              Assert.Equal(shouldSucceed, allowed.Succeeded);
552          }
553          [Fact]
554          public async Task CanCombinePolicies()
555          {
556              var authorizationService = BuildAuthorizationService(services =&gt;
557              {
558                  services.AddAuthorization(options =&gt;
559                  {
560                      var basePolicy = new AuthorizationPolicyBuilder().RequireClaim(&quot;Base&quot;, &quot;Value&quot;).Build();
561                      options.AddPolicy(&quot;Combined&quot;, policy =&gt; policy.Combine(basePolicy).RequireClaim(&quot;Claim&quot;, &quot;Exists&quot;));
562                  });
563              });
564              var user = new ClaimsPrincipal(
565                  new ClaimsIdentity(
566                      new Claim[] {
567                          new Claim(&quot;Base&quot;, &quot;Value&quot;),
568                          new Claim(&quot;Claim&quot;, &quot;Exists&quot;)
569                      },
570                      &quot;AuthType&quot;)
571                  );
572              var allowed = await authorizationService.AuthorizeAsync(user, null, &quot;Combined&quot;);
573              Assert.True(allowed.Succeeded);
574          }
575          [Fact]
576          public async Task CombinePoliciesWillFailIfBasePolicyFails()
577          {
578              var authorizationService = BuildAuthorizationService(services =&gt;
579              {
580                  services.AddAuthorization(options =&gt;
581                  {
582                      var basePolicy = new AuthorizationPolicyBuilder().RequireClaim(&quot;Base&quot;, &quot;Value&quot;).Build();
583                      options.AddPolicy(&quot;Combined&quot;, policy =&gt; policy.Combine(basePolicy).RequireClaim(&quot;Claim&quot;, &quot;Exists&quot;));
584                  });
585              });
586              var user = new ClaimsPrincipal(
587                  new ClaimsIdentity(
588                      new Claim[] {
589                          new Claim(&quot;Claim&quot;, &quot;Exists&quot;)
590                      },
591                      &quot;AuthType&quot;)
592                  );
593              var allowed = await authorizationService.AuthorizeAsync(user, null, &quot;Combined&quot;);
594              Assert.False(allowed.Succeeded);
595          }
596          [Fact]
597          public async Task CombinedPoliciesWillFailIfExtraRequirementFails()
598          {
599              var authorizationService = BuildAuthorizationService(services =&gt;
600              {
601                  services.AddAuthorization(options =&gt;
602                  {
603                      var basePolicy = new AuthorizationPolicyBuilder().RequireClaim(&quot;Base&quot;, &quot;Value&quot;).Build();
604                      options.AddPolicy(&quot;Combined&quot;, policy =&gt; policy.Combine(basePolicy).RequireClaim(&quot;Claim&quot;, &quot;Exists&quot;));
605                  });
606              });
607              var user = new ClaimsPrincipal(
608                  new ClaimsIdentity(
609                      new Claim[] {
610                          new Claim(&quot;Base&quot;, &quot;Value&quot;),
611                      },
612                      &quot;AuthType&quot;)
613                  );
614              var allowed = await authorizationService.AuthorizeAsync(user, null, &quot;Combined&quot;);
615              Assert.False(allowed.Succeeded);
616          }
617          public class ExpenseReport { }
618          public static class Operations
619          {
620              public static OperationAuthorizationRequirement Edit = new OperationAuthorizationRequirement { Name = &quot;Edit&quot; };
621              public static OperationAuthorizationRequirement Create = new OperationAuthorizationRequirement { Name = &quot;Create&quot; };
622              public static OperationAuthorizationRequirement Delete = new OperationAuthorizationRequirement { Name = &quot;Delete&quot; };
623          }
624          public class ExpenseReportAuthorizationHandler : AuthorizationHandler&lt;OperationAuthorizationRequirement, ExpenseReport&gt;
625          {
626              public ExpenseReportAuthorizationHandler(IEnumerable&lt;OperationAuthorizationRequirement&gt; authorized)
627              {
628                  _allowed = authorized;
629              }
630              private IEnumerable&lt;OperationAuthorizationRequirement&gt; _allowed;
631              protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, OperationAuthorizationRequirement requirement, ExpenseReport resource)
632              {
633                  if (_allowed.Contains(requirement))
634                  {
635                      context.Succeed(requirement);
636                  }
637                  return Task.FromResult(0);
638              }
639          }
640          public class SuperUserHandler : AuthorizationHandler&lt;OperationAuthorizationRequirement&gt;
641          {
642              protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, OperationAuthorizationRequirement requirement)
643              {
644                  if (context.User.HasClaim(&quot;SuperUser&quot;, &quot;yes&quot;))
645                  {
646                      context.Succeed(requirement);
647                  }
648                  return Task.FromResult(0);
649              }
650          }
651          [Fact]
652          public async Task CanAuthorizeAllSuperuserOperations()
653          {
654              var authorizationService = BuildAuthorizationService(services =&gt;
655              {
656                  services.AddSingleton&lt;IAuthorizationHandler&gt;(new ExpenseReportAuthorizationHandler(new OperationAuthorizationRequirement[] { Operations.Edit }));
657                  services.AddTransient&lt;IAuthorizationHandler, SuperUserHandler&gt;();
658              });
659              var user = new ClaimsPrincipal(
660                  new ClaimsIdentity(
661                      new Claim[] {
662                          new Claim(&quot;SuperUser&quot;, &quot;yes&quot;),
663                      },
664                      &quot;AuthType&quot;)
665                  );
666              Assert.True((await authorizationService.AuthorizeAsync(user, null, Operations.Edit)).Succeeded);
667              Assert.True((await authorizationService.AuthorizeAsync(user, null, Operations.Delete)).Succeeded);
668              Assert.True((await authorizationService.AuthorizeAsync(user, null, Operations.Create)).Succeeded);
669          }
670          public class NotCalledHandler : AuthorizationHandler&lt;OperationAuthorizationRequirement, string&gt;
671          {
672              protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, OperationAuthorizationRequirement requirement, string resource)
673              {
674                  throw new NotImplementedException();
675              }
676          }
677          public class EvenHandler : AuthorizationHandler&lt;OperationAuthorizationRequirement, int&gt;
678          {
679              protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, OperationAuthorizationRequirement requirement, int id)
680              {
681                  if (id % 2 == 0)
682                  {
683                      context.Succeed(requirement);
684                  }
685                  return Task.FromResult(0);
686              }
687          }
688          [Fact]
689          public async Task CanUseValueTypeResource()
690          {
691              var authorizationService = BuildAuthorizationService(services =&gt;
692              {
693                  services.AddTransient&lt;IAuthorizationHandler, EvenHandler&gt;();
694              });
695              var user = new ClaimsPrincipal(
696                  new ClaimsIdentity(
697                      new Claim[] {
698                      },
699                      &quot;AuthType&quot;)
700                  );
701              Assert.False((await authorizationService.AuthorizeAsync(user, 1, Operations.Edit)).Succeeded);
702              Assert.True((await authorizationService.AuthorizeAsync(user, 2, Operations.Edit)).Succeeded);
703          }
704          [Fact]
705          public async Task DoesNotCallHandlerWithWrongResourceType()
706          {
707              var authorizationService = BuildAuthorizationService(services =&gt;
708              {
709                  services.AddTransient&lt;IAuthorizationHandler, NotCalledHandler&gt;();
710              });
711              var user = new ClaimsPrincipal(
712                  new ClaimsIdentity(
713                      new Claim[] {
714                          new Claim(&quot;SuperUser&quot;, &quot;yes&quot;)
715                      },
716                      &quot;AuthType&quot;)
717                  );
718              Assert.False((await authorizationService.AuthorizeAsync(user, 1, Operations.Edit)).Succeeded);
719          }
720          [Fact]
721          public async Task CanAuthorizeOnlyAllowedOperations()
722          {
723              var authorizationService = BuildAuthorizationService(services =&gt;
724              {
<span onclick='openModal()' class='match'>725                  services.AddSingleton&lt;IAuthorizationHandler&gt;(new ExpenseReportAuthorizationHandler(new OperationAuthorizationRequirement[] { Operations.Edit }));
726              });
</span>727              var user = new ClaimsPrincipal();
728              Assert.True((await authorizationService.AuthorizeAsync(user, new ExpenseReport(), Operations.Edit)).Succeeded);
729              Assert.False((await authorizationService.AuthorizeAsync(user, new ExpenseReport(), Operations.Delete)).Succeeded);
730              Assert.False((await authorizationService.AuthorizeAsync(user, new ExpenseReport(), Operations.Create)).Succeeded);
731          }
732          [Fact]
733          public async Task AuthorizeHandlerNotCalledWithNullResource()
734          {
735              var authorizationService = BuildAuthorizationService(services =&gt;
736              {
737                  services.AddSingleton&lt;IAuthorizationHandler&gt;(new ExpenseReportAuthorizationHandler(new OperationAuthorizationRequirement[] { Operations.Edit }));
738              });
739              var user = new ClaimsPrincipal();
740              Assert.False((await authorizationService.AuthorizeAsync(user, null, Operations.Edit)).Succeeded);
741          }
742          [Fact]
743          public async Task CanAuthorizeWithAssertionRequirement()
744          {
745              var authorizationService = BuildAuthorizationService(services =&gt;
746              {
747                  services.AddAuthorization(options =&gt;
748                  {
749                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireAssertion(context =&gt; true));
750                  });
751              });
752              var user = new ClaimsPrincipal();
753              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
754              Assert.True(allowed.Succeeded);
755          }
756          [Fact]
757          public async Task CanAuthorizeWithAsyncAssertionRequirement()
758          {
759              var authorizationService = BuildAuthorizationService(services =&gt;
760              {
761                  services.AddAuthorization(options =&gt;
762                  {
763                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireAssertion(context =&gt; Task.FromResult(true)));
764                  });
765              });
766              var user = new ClaimsPrincipal();
767              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
768              Assert.True(allowed.Succeeded);
769          }
770          public class StaticPolicyProvider : IAuthorizationPolicyProvider
771          {
772              public Task&lt;AuthorizationPolicy&gt; GetDefaultPolicyAsync()
773              {
774                  return Task.FromResult(new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build());
775              }
776              public Task&lt;AuthorizationPolicy&gt; GetRequiredPolicyAsync()
777              {
778                  return Task.FromResult&lt;AuthorizationPolicy&gt;(null);
779              }
780              public Task&lt;AuthorizationPolicy&gt; GetPolicyAsync(string policyName)
781              {
782                  return Task.FromResult(new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build());
783              }
784          }
785          [Fact]
786          public async Task CanReplaceDefaultPolicyProvider()
787          {
788              var authorizationService = BuildAuthorizationService(services =&gt;
789              {
790                  services.AddSingleton&lt;IAuthorizationPolicyProvider, StaticPolicyProvider&gt;();
791                  services.AddAuthorization(options =&gt;
792                  {
793                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireAssertion(context =&gt; true));
794                  });
795              });
796              var user = new ClaimsPrincipal();
797              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
798              Assert.False(allowed.Succeeded);
799          }
800          public class DynamicPolicyProvider : IAuthorizationPolicyProvider
801          {
802              public Task&lt;AuthorizationPolicy&gt; GetDefaultPolicyAsync()
803              {
804                  return Task.FromResult(new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build());
805              }
806              public Task&lt;AuthorizationPolicy&gt; GetRequiredPolicyAsync()
807              {
808                  return Task.FromResult&lt;AuthorizationPolicy&gt;(null);
809              }
810              public Task&lt;AuthorizationPolicy&gt; GetPolicyAsync(string policyName)
811              {
812                  return Task.FromResult(new AuthorizationPolicyBuilder().RequireClaim(policyName).Build());
813              }
814          }
815          [Fact]
816          public async Task CanUseDynamicPolicyProvider()
817          {
818              var authorizationService = BuildAuthorizationService(services =&gt;
819              {
820                  services.AddSingleton&lt;IAuthorizationPolicyProvider, DynamicPolicyProvider&gt;();
821                  services.AddAuthorization(options =&gt; { });
822              });
823              var id = new ClaimsIdentity();
824              id.AddClaim(new Claim(&quot;1&quot;, &quot;1&quot;));
825              id.AddClaim(new Claim(&quot;2&quot;, &quot;2&quot;));
826              var user = new ClaimsPrincipal(id);
827              Assert.False((await authorizationService.AuthorizeAsync(user, &quot;0&quot;)).Succeeded);
828              Assert.True((await authorizationService.AuthorizeAsync(user, &quot;1&quot;)).Succeeded);
829              Assert.True((await authorizationService.AuthorizeAsync(user, &quot;2&quot;)).Succeeded);
830              Assert.False((await authorizationService.AuthorizeAsync(user, &quot;3&quot;)).Succeeded);
831          }
832          public class SuccessEvaluator : IAuthorizationEvaluator
833          {
834              public AuthorizationResult Evaluate(AuthorizationHandlerContext context) =&gt; AuthorizationResult.Success();
835          }
836          [Fact]
837          public async Task CanUseCustomEvaluatorThatOverridesRequirement()
838          {
839              var authorizationService = BuildAuthorizationService(services =&gt;
840              {
841                  services.AddSingleton&lt;IAuthorizationEvaluator, SuccessEvaluator&gt;();
842                  services.AddAuthorization(options =&gt; options.AddPolicy(&quot;Fail&quot;, p =&gt; p.RequireAssertion(c =&gt; false)));
843              });
844              var result = await authorizationService.AuthorizeAsync(null, &quot;Fail&quot;);
845              Assert.True(result.Succeeded);
846          }
847          public class BadContextMaker : IAuthorizationHandlerContextFactory
848          {
849              public AuthorizationHandlerContext CreateContext(IEnumerable&lt;IAuthorizationRequirement&gt; requirements, ClaimsPrincipal user, object resource)
850              {
851                  return new BadContext();
852              }
853          }
854          public class BadContext : AuthorizationHandlerContext
855          {
856              public BadContext() : base(new List&lt;IAuthorizationRequirement&gt;(), null, null) { }
857              public override bool HasFailed
858              {
859                  get
860                  {
861                      return true;
862                  }
863              }
864              public override bool HasSucceeded
865              {
866                  get
867                  {
868                      return false;
869                  }
870              }
871          }
872          [Fact]
873          public async Task CanUseCustomContextThatAlwaysFails()
874          {
875              var authorizationService = BuildAuthorizationService(services =&gt;
876              {
877                  services.AddSingleton&lt;IAuthorizationHandlerContextFactory, BadContextMaker&gt;();
878                  services.AddAuthorization(options =&gt; options.AddPolicy(&quot;Success&quot;, p =&gt; p.RequireAssertion(c =&gt; true)));
879              });
880              Assert.False((await authorizationService.AuthorizeAsync(null, &quot;Success&quot;)).Succeeded);
881          }
882          public class SadHandlerProvider : IAuthorizationHandlerProvider
883          {
884              public Task&lt;IEnumerable&lt;IAuthorizationHandler&gt;&gt; GetHandlersAsync(AuthorizationHandlerContext context)
885              {
886                  return Task.FromResult&lt;IEnumerable&lt;IAuthorizationHandler&gt;&gt;(new IAuthorizationHandler[1] { new FailHandler() });
887              }
888          }
889          [Fact]
890          public async Task CanUseCustomHandlerProvider()
891          {
892              var authorizationService = BuildAuthorizationService(services =&gt;
893              {
894                  services.AddSingleton&lt;IAuthorizationHandlerProvider, SadHandlerProvider&gt;();
895                  services.AddAuthorization(options =&gt; options.AddPolicy(&quot;Success&quot;, p =&gt; p.RequireAssertion(c =&gt; true)));
896              });
897              Assert.False((await authorizationService.AuthorizeAsync(null, &quot;Success&quot;)).Succeeded);
898          }
899      }
900  }
</code></pre>
        </div>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-DefaultAuthorizationServiceTests.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Linq;
4  using System.Security.Claims;
5  using System.Threading.Tasks;
6  using Microsoft.AspNetCore.Authorization.Infrastructure;
7  using Microsoft.Extensions.DependencyInjection;
8  using Microsoft.Extensions.Options;
9  using Xunit;
10  namespace Microsoft.AspNetCore.Authorization.Test
11  {
12      public class DefaultAuthorizationServiceTests
13      {
14          private IAuthorizationService BuildAuthorizationService(Action&lt;IServiceCollection&gt; setupServices = null)
15          {
16              var services = new ServiceCollection();
17              services.AddAuthorization();
18              services.AddLogging();
19              services.AddOptions();
20              setupServices?.Invoke(services);
21              return services.BuildServiceProvider().GetRequiredService&lt;IAuthorizationService&gt;();
22          }
23          [Fact]
24          public async Task AuthorizeCombineThrowsOnUnknownPolicy()
25          {
26              var provider = new DefaultAuthorizationPolicyProvider(Options.Create(new AuthorizationOptions()));
27              await Assert.ThrowsAsync&lt;InvalidOperationException&gt;(() =&gt; AuthorizationPolicy.CombineAsync(provider, new AuthorizeAttribute[] {
28                  new AuthorizeAttribute { Policy = &quot;Wut&quot; }
29              }));
30          }
31          [Fact]
32          public async Task Authorize_ShouldAllowIfClaimIsPresent()
33          {
34              var authorizationService = BuildAuthorizationService(services =&gt;
35              {
36                  services.AddAuthorization(options =&gt;
37                  {
38                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;));
39                  });
40              });
41              var user = new ClaimsPrincipal(new ClaimsIdentity(new Claim[] { new Claim(&quot;Permission&quot;, &quot;CanViewPage&quot;) }));
42              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
43              Assert.True(allowed.Succeeded);
44          }
45          [Fact]
46          public async Task Authorize_ShouldAllowIfClaimIsPresentWithSpecifiedAuthType()
47          {
48              var authorizationService = BuildAuthorizationService(services =&gt;
49              {
50                  services.AddAuthorization(options =&gt;
51                  {
52                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; {
53                          policy.AddAuthenticationSchemes(&quot;Basic&quot;);
54                          policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;);
55                      });
56                  });
57              });
58              var user = new ClaimsPrincipal(new ClaimsIdentity(new Claim[] { new Claim(&quot;Permission&quot;, &quot;CanViewPage&quot;) }, &quot;Basic&quot;));
59              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
60              Assert.True(allowed.Succeeded);
61          }
62          [Fact]
63          public async Task Authorize_ShouldAllowIfClaimIsAmongValues()
64          {
65              var authorizationService = BuildAuthorizationService(services =&gt;
66              {
67                  services.AddAuthorization(options =&gt;
68                  {
69                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;, &quot;CanViewAnything&quot;));
70                  });
71              });
72              var user = new ClaimsPrincipal(
73                  new ClaimsIdentity(
74                      new Claim[] {
75                          new Claim(&quot;Permission&quot;, &quot;CanViewPage&quot;),
76                          new Claim(&quot;Permission&quot;, &quot;CanViewAnything&quot;)
77                      },
78                      &quot;Basic&quot;)
79                  );
80              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
81              Assert.True(allowed.Succeeded);
82          }
83          [Fact]
84          public async Task Authorize_ShouldInvokeAllHandlersByDefault()
85          {
86              var handler1 = new FailHandler();
87              var handler2 = new FailHandler();
88              var authorizationService = BuildAuthorizationService(services =&gt;
89              {
90                  services.AddSingleton&lt;IAuthorizationHandler&gt;(handler1);
91                  services.AddSingleton&lt;IAuthorizationHandler&gt;(handler2);
92                  services.AddAuthorization(options =&gt;
93                  {
94                      options.AddPolicy(&quot;Custom&quot;, policy =&gt; policy.Requirements.Add(new CustomRequirement()));
95                  });
96              });
97              var allowed = await authorizationService.AuthorizeAsync(new ClaimsPrincipal(), &quot;Custom&quot;);
98              Assert.False(allowed.Succeeded);
99              Assert.True(allowed.Failure.FailCalled);
100              Assert.True(handler1.Invoked);
101              Assert.True(handler2.Invoked);
102          }
103          [Theory]
104          [InlineData(true)]
105          [InlineData(false)]
106          public async Task Authorize_ShouldInvokeAllHandlersDependingOnSetting(bool invokeAllHandlers)
107          {
108              var handler1 = new FailHandler();
109              var handler2 = new FailHandler();
110              var authorizationService = BuildAuthorizationService(services =&gt;
111              {
112                  services.AddSingleton&lt;IAuthorizationHandler&gt;(handler1);
113                  services.AddSingleton&lt;IAuthorizationHandler&gt;(handler2);
114                  services.AddAuthorization(options =&gt;
115                  {
116                      options.InvokeHandlersAfterFailure = invokeAllHandlers;
117                      options.AddPolicy(&quot;Custom&quot;, policy =&gt; policy.Requirements.Add(new CustomRequirement()));
118                  });
119              });
120              var allowed = await authorizationService.AuthorizeAsync(new ClaimsPrincipal(), &quot;Custom&quot;);
121              Assert.False(allowed.Succeeded);
122              Assert.True(handler1.Invoked);
123              Assert.Equal(invokeAllHandlers, handler2.Invoked);
124          }
125          private class FailHandler : IAuthorizationHandler
126          {
127              public bool Invoked { get; set; }
128              public Task HandleAsync(AuthorizationHandlerContext context)
129              {
130                  Invoked = true;
131                  context.Fail();
132                  return Task.FromResult(0);
133              }
134          }
135          [Fact]
136          public async Task Authorize_ShouldFailWhenAllRequirementsNotHandled()
137          {
138              var authorizationService = BuildAuthorizationService(services =&gt;
139              {
140                  services.AddAuthorization(options =&gt;
141                  {
142                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;, &quot;CanViewAnything&quot;));
143                  });
144              });
145              var user = new ClaimsPrincipal(
146                  new ClaimsIdentity(
147                      new Claim[] {
148                          new Claim(&quot;SomethingElse&quot;, &quot;CanViewPage&quot;),
149                      },
150                      &quot;Basic&quot;)
151                  );
152              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
153              Assert.False(allowed.Succeeded);
154              Assert.IsType&lt;ClaimsAuthorizationRequirement&gt;(allowed.Failure.FailedRequirements.First());
155          }
156          [Fact]
157          public async Task Authorize_ShouldNotAllowIfClaimTypeIsNotPresent()
158          {
159              var authorizationService = BuildAuthorizationService(services =&gt;
160              {
161                  services.AddAuthorization(options =&gt;
162                  {
163                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;, &quot;CanViewAnything&quot;));
164                  });
165              });
166              var user = new ClaimsPrincipal(
167                  new ClaimsIdentity(
168                      new Claim[] {
169                          new Claim(&quot;SomethingElse&quot;, &quot;CanViewPage&quot;),
170                      },
171                      &quot;Basic&quot;)
172                  );
173              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
174              Assert.False(allowed.Succeeded);
175          }
176          [Fact]
177          public async Task Authorize_ShouldNotAllowIfClaimValueIsNotPresent()
178          {
179              var authorizationService = BuildAuthorizationService(services =&gt;
180              {
181                  services.AddAuthorization(options =&gt;
182                  {
183                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;));
184                  });
185              });
186              var user = new ClaimsPrincipal(
187                  new ClaimsIdentity(
188                      new Claim[] {
189                          new Claim(&quot;Permission&quot;, &quot;CanViewComment&quot;),
190                      },
191                      &quot;Basic&quot;)
192                  );
193              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
194              Assert.False(allowed.Succeeded);
195          }
196          [Fact]
197          public async Task Authorize_ShouldNotAllowIfNoClaims()
198          {
199              var authorizationService = BuildAuthorizationService(services =&gt;
200              {
201                  services.AddAuthorization(options =&gt;
202                  {
203                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;));
204                  });
205              });
206              var user = new ClaimsPrincipal(
207                  new ClaimsIdentity(
208                      new Claim[0],
209                      &quot;Basic&quot;)
210                  );
211              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
212              Assert.False(allowed.Succeeded);
213          }
214          [Fact]
215          public async Task Authorize_ShouldNotAllowIfUserIsNull()
216          {
217              var authorizationService = BuildAuthorizationService(services =&gt;
218              {
219                  services.AddAuthorization(options =&gt;
220                  {
221                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;));
222                  });
223              });
224              var allowed = await authorizationService.AuthorizeAsync(null, null, &quot;Basic&quot;);
225              Assert.False(allowed.Succeeded);
226          }
227          [Fact]
228          public async Task Authorize_ShouldNotAllowIfNotCorrectAuthType()
229          {
230              var authorizationService = BuildAuthorizationService(services =&gt;
231              {
232                  services.AddAuthorization(options =&gt;
233                  {
234                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;));
235                  });
236              });
237              var user = new ClaimsPrincipal(new ClaimsIdentity());
238              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
239              Assert.False(allowed.Succeeded);
240          }
241          [Fact]
242          public async Task Authorize_ShouldAllowWithNoAuthType()
243          {
244              var authorizationService = BuildAuthorizationService(services =&gt;
245              {
246                  services.AddAuthorization(options =&gt;
247                  {
248                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;));
249                  });
250              });
251              var user = new ClaimsPrincipal(
252                  new ClaimsIdentity(
253                      new Claim[] {
254                          new Claim(&quot;Permission&quot;, &quot;CanViewPage&quot;),
255                      },
256                      &quot;Basic&quot;)
257                  );
258              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
259              Assert.True(allowed.Succeeded);
260          }
261          [Fact]
262          public async Task Authorize_ThrowsWithUnknownPolicy()
263          {
264              var authorizationService = BuildAuthorizationService();
265              var exception = await Assert.ThrowsAsync&lt;InvalidOperationException&gt;(() =&gt; authorizationService.AuthorizeAsync(new ClaimsPrincipal(), &quot;whatever&quot;, &quot;BogusPolicy&quot;));
266              Assert.Equal(&quot;No policy found: BogusPolicy.&quot;, exception.Message);
267          }
268          [Fact]
269          public async Task Authorize_CustomRolePolicy()
270          {
271              var policy = new AuthorizationPolicyBuilder().RequireRole(&quot;Administrator&quot;)
272                  .RequireClaim(ClaimTypes.Role, &quot;User&quot;);
273              var authorizationService = BuildAuthorizationService();
274              var user = new ClaimsPrincipal(
275                  new ClaimsIdentity(
276                      new Claim[] {
277                          new Claim(ClaimTypes.Role, &quot;User&quot;),
278                          new Claim(ClaimTypes.Role, &quot;Administrator&quot;)
279                      },
280                      &quot;Basic&quot;)
281                  );
282              var allowed = await authorizationService.AuthorizeAsync(user, policy.Build());
283              Assert.True(allowed.Succeeded);
284          }
285          [Fact]
286          public async Task Authorize_HasAnyClaimOfTypePolicy()
287          {
288              var policy = new AuthorizationPolicyBuilder().RequireClaim(ClaimTypes.Role);
289              var authorizationService = BuildAuthorizationService();
290              var user = new ClaimsPrincipal(
291                  new ClaimsIdentity(
292                      new Claim[] {
293                          new Claim(ClaimTypes.Role, &quot;none&quot;),
294                      },
295                      &quot;Basic&quot;)
296                  );
297              var allowed = await authorizationService.AuthorizeAsync(user, policy.Build());
298              Assert.True(allowed.Succeeded);
299          }
300          [Fact]
301          public async Task Authorize_PolicyCanAuthenticationSchemeWithNameClaim()
302          {
303              var policy = new AuthorizationPolicyBuilder(&quot;AuthType&quot;).RequireClaim(ClaimTypes.Name);
304              var authorizationService = BuildAuthorizationService();
305              var user = new ClaimsPrincipal(
306                  new ClaimsIdentity(new Claim[] { new Claim(ClaimTypes.Name, &quot;Name&quot;) }, &quot;AuthType&quot;)
307                  );
308              var allowed = await authorizationService.AuthorizeAsync(user, policy.Build());
309              Assert.True(allowed.Succeeded);
310          }
311          [Fact]
312          public async Task RolePolicyCanRequireSingleRole()
313          {
314              var policy = new AuthorizationPolicyBuilder(&quot;AuthType&quot;).RequireRole(&quot;Admin&quot;);
315              var authorizationService = BuildAuthorizationService();
316              var user = new ClaimsPrincipal(
317                  new ClaimsIdentity(new Claim[] { new Claim(ClaimTypes.Role, &quot;Admin&quot;) }, &quot;AuthType&quot;)
318              );
319              var allowed = await authorizationService.AuthorizeAsync(user, null, policy.Build());
320              Assert.True(allowed.Succeeded);
321          }
322          [Fact]
323          public async Task RolePolicyCanRequireOneOfManyRoles()
324          {
325              var policy = new AuthorizationPolicyBuilder(&quot;AuthType&quot;).RequireRole(&quot;Admin&quot;, &quot;Users&quot;);
326              var authorizationService = BuildAuthorizationService();
327              var user = new ClaimsPrincipal(
328                  new ClaimsIdentity(new Claim[] { new Claim(ClaimTypes.Role, &quot;Users&quot;) }, &quot;AuthType&quot;));
329              var allowed = await authorizationService.AuthorizeAsync(user, policy.Build());
330              Assert.True(allowed.Succeeded);
331          }
332          [Fact]
333          public async Task RolePolicyCanBlockWrongRole()
334          {
335              var policy = new AuthorizationPolicyBuilder().RequireClaim(&quot;Permission&quot;, &quot;CanViewPage&quot;);
336              var authorizationService = BuildAuthorizationService();
337              var user = new ClaimsPrincipal(
338                  new ClaimsIdentity(
339                      new Claim[] {
340                          new Claim(ClaimTypes.Role, &quot;Nope&quot;),
341                      },
342                      &quot;AuthType&quot;)
343                  );
344              var allowed = await authorizationService.AuthorizeAsync(user, policy.Build());
345              Assert.False(allowed.Succeeded);
346          }
347          [Fact]
348          public async Task RolePolicyCanBlockNoRole()
349          {
350              var authorizationService = BuildAuthorizationService(services =&gt;
351              {
352                  services.AddAuthorization(options =&gt;
353                  {
354                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireRole(&quot;Admin&quot;, &quot;Users&quot;));
355                  });
356              });
357              var user = new ClaimsPrincipal(
358                  new ClaimsIdentity(
359                      new Claim[] {
360                      },
361                      &quot;AuthType&quot;)
362                  );
363              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
364              Assert.False(allowed.Succeeded);
365          }
366          [Fact]
367          public void PolicyThrowsWithNoRequirements()
368          {
369              Assert.Throws&lt;InvalidOperationException&gt;(() =&gt; BuildAuthorizationService(services =&gt;
370              {
371                  services.AddAuthorization(options =&gt;
372                  {
373                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; { });
374                  });
375              }));
376          }
377          [Fact]
378          public async Task RequireUserNameFailsForWrongUserName()
379          {
380              var authorizationService = BuildAuthorizationService(services =&gt;
381              {
382                  services.AddAuthorization(options =&gt;
383                  {
384                      options.AddPolicy(&quot;Hao&quot;, policy =&gt; policy.RequireUserName(&quot;Hao&quot;));
385                  });
386              });
387              var user = new ClaimsPrincipal(
388                  new ClaimsIdentity(
389                      new Claim[] {
390                          new Claim(ClaimTypes.Name, &quot;Tek&quot;),
391                      },
392                      &quot;AuthType&quot;)
393                  );
394              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Hao&quot;);
395              Assert.False(allowed.Succeeded);
396          }
397          [Fact]
398          public async Task CanRequireUserName()
399          {
400              var authorizationService = BuildAuthorizationService(services =&gt;
401              {
402                  services.AddAuthorization(options =&gt;
403                  {
404                      options.AddPolicy(&quot;Hao&quot;, policy =&gt; policy.RequireUserName(&quot;Hao&quot;));
405                  });
406              });
407              var user = new ClaimsPrincipal(
408                  new ClaimsIdentity(
409                      new Claim[] {
410                          new Claim(ClaimTypes.Name, &quot;Hao&quot;),
411                      },
412                      &quot;AuthType&quot;)
413                  );
414              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Hao&quot;);
415              Assert.True(allowed.Succeeded);
416          }
417          [Fact]
418          public async Task CanRequireUserNameWithDiffClaimType()
419          {
420              var authorizationService = BuildAuthorizationService(services =&gt;
421              {
422                  services.AddAuthorization(options =&gt;
423                  {
424                      options.AddPolicy(&quot;Hao&quot;, policy =&gt; policy.RequireUserName(&quot;Hao&quot;));
425                  });
426              });
427              var identity = new ClaimsIdentity(&quot;AuthType&quot;, &quot;Name&quot;, &quot;Role&quot;);
428              identity.AddClaim(new Claim(&quot;Name&quot;, &quot;Hao&quot;));
429              var user = new ClaimsPrincipal(identity);
430              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Hao&quot;);
431              Assert.True(allowed.Succeeded);
432          }
433          [Fact]
434          public async Task CanRequireRoleWithDiffClaimType()
435          {
436              var authorizationService = BuildAuthorizationService(services =&gt;
437              {
438                  services.AddAuthorization(options =&gt;
439                  {
440                      options.AddPolicy(&quot;Hao&quot;, policy =&gt; policy.RequireRole(&quot;Hao&quot;));
441                  });
442              });
443              var identity = new ClaimsIdentity(&quot;AuthType&quot;, &quot;Name&quot;, &quot;Role&quot;);
444              identity.AddClaim(new Claim(&quot;Role&quot;, &quot;Hao&quot;));
445              var user = new ClaimsPrincipal(identity);
446              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Hao&quot;);
447              Assert.True(allowed.Succeeded);
448          }
449          [Fact]
450          public async Task CanApproveAnyAuthenticatedUser()
451          {
452              var authorizationService = BuildAuthorizationService(services =&gt;
453              {
454                  services.AddAuthorization(options =&gt;
455                  {
456                      options.AddPolicy(&quot;Any&quot;, policy =&gt; policy.RequireAuthenticatedUser());
457                  });
458              });
459              var user = new ClaimsPrincipal(new ClaimsIdentity());
460              user.AddIdentity(new ClaimsIdentity(
461                  new Claim[] {
462                      new Claim(ClaimTypes.Name, &quot;Name&quot;),
463                  },
464                  &quot;AuthType&quot;));
465              var allowed = await authorizationService.AuthorizeAsync(user, null, &quot;Any&quot;);
466              Assert.True(allowed.Succeeded);
467          }
468          [Fact]
469          public async Task CanBlockNonAuthenticatedUser()
470          {
471              var authorizationService = BuildAuthorizationService(services =&gt;
472              {
473                  services.AddAuthorization(options =&gt;
474                  {
475                      options.AddPolicy(&quot;Any&quot;, policy =&gt; policy.RequireAuthenticatedUser());
476                  });
477              });
478              var user = new ClaimsPrincipal(new ClaimsIdentity());
479              var allowed = await authorizationService.AuthorizeAsync(user, null, &quot;Any&quot;);
480              Assert.False(allowed.Succeeded);
481          }
482          public class CustomRequirement : IAuthorizationRequirement { }
483          public class CustomHandler : AuthorizationHandler&lt;CustomRequirement&gt;
484          {
485              public bool Invoked { get; set; }
486              protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, CustomRequirement requirement)
487              {
488                  Invoked = true;
489                  context.Succeed(requirement);
490                  return Task.FromResult(0);
491              }
492          }
493          [Fact]
494          public async Task CustomReqWithNoHandlerFails()
495          {
496              var authorizationService = BuildAuthorizationService(services =&gt;
497              {
498                  services.AddAuthorization(options =&gt;
499                  {
500                      options.AddPolicy(&quot;Custom&quot;, policy =&gt; policy.Requirements.Add(new CustomRequirement()));
501                  });
502              });
503              var user = new ClaimsPrincipal();
504              var allowed = await authorizationService.AuthorizeAsync(user, null, &quot;Custom&quot;);
505              Assert.False(allowed.Succeeded);
506          }
507          [Fact]
508          public async Task CustomReqWithHandlerSucceeds()
509          {
510              var authorizationService = BuildAuthorizationService(services =&gt;
511              {
512                  services.AddTransient&lt;IAuthorizationHandler, CustomHandler&gt;();
513                  services.AddAuthorization(options =&gt;
514                  {
515                      options.AddPolicy(&quot;Custom&quot;, policy =&gt; policy.Requirements.Add(new CustomRequirement()));
516                  });
517              });
518              var user = new ClaimsPrincipal();
519              var allowed = await authorizationService.AuthorizeAsync(user, null, &quot;Custom&quot;);
520              Assert.True(allowed.Succeeded);
521          }
522          public class PassThroughRequirement : AuthorizationHandler&lt;PassThroughRequirement&gt;, IAuthorizationRequirement
523          {
524              public PassThroughRequirement(bool succeed)
525              {
526                  Succeed = succeed;
527              }
528              public bool Succeed { get; set; }
529              protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, PassThroughRequirement requirement)
530              {
531                  if (Succeed) {
532                      context.Succeed(requirement);
533                  }
534                  return Task.FromResult(0);
535              }
536          }
537          [Theory]
538          [InlineData(true)]
539          [InlineData(false)]
540          public async Task PassThroughRequirementWillSucceedWithoutCustomHandler(bool shouldSucceed)
541          {
542              var authorizationService = BuildAuthorizationService(services =&gt;
543              {
544                  services.AddAuthorization(options =&gt;
545                  {
546                      options.AddPolicy(&quot;Passthrough&quot;, policy =&gt; policy.Requirements.Add(new PassThroughRequirement(shouldSucceed)));
547                  });
548              });
549              var user = new ClaimsPrincipal();
550              var allowed = await authorizationService.AuthorizeAsync(user, null, &quot;Passthrough&quot;);
551              Assert.Equal(shouldSucceed, allowed.Succeeded);
552          }
553          [Fact]
554          public async Task CanCombinePolicies()
555          {
556              var authorizationService = BuildAuthorizationService(services =&gt;
557              {
558                  services.AddAuthorization(options =&gt;
559                  {
560                      var basePolicy = new AuthorizationPolicyBuilder().RequireClaim(&quot;Base&quot;, &quot;Value&quot;).Build();
561                      options.AddPolicy(&quot;Combined&quot;, policy =&gt; policy.Combine(basePolicy).RequireClaim(&quot;Claim&quot;, &quot;Exists&quot;));
562                  });
563              });
564              var user = new ClaimsPrincipal(
565                  new ClaimsIdentity(
566                      new Claim[] {
567                          new Claim(&quot;Base&quot;, &quot;Value&quot;),
568                          new Claim(&quot;Claim&quot;, &quot;Exists&quot;)
569                      },
570                      &quot;AuthType&quot;)
571                  );
572              var allowed = await authorizationService.AuthorizeAsync(user, null, &quot;Combined&quot;);
573              Assert.True(allowed.Succeeded);
574          }
575          [Fact]
576          public async Task CombinePoliciesWillFailIfBasePolicyFails()
577          {
578              var authorizationService = BuildAuthorizationService(services =&gt;
579              {
580                  services.AddAuthorization(options =&gt;
581                  {
582                      var basePolicy = new AuthorizationPolicyBuilder().RequireClaim(&quot;Base&quot;, &quot;Value&quot;).Build();
583                      options.AddPolicy(&quot;Combined&quot;, policy =&gt; policy.Combine(basePolicy).RequireClaim(&quot;Claim&quot;, &quot;Exists&quot;));
584                  });
585              });
586              var user = new ClaimsPrincipal(
587                  new ClaimsIdentity(
588                      new Claim[] {
589                          new Claim(&quot;Claim&quot;, &quot;Exists&quot;)
590                      },
591                      &quot;AuthType&quot;)
592                  );
593              var allowed = await authorizationService.AuthorizeAsync(user, null, &quot;Combined&quot;);
594              Assert.False(allowed.Succeeded);
595          }
596          [Fact]
597          public async Task CombinedPoliciesWillFailIfExtraRequirementFails()
598          {
599              var authorizationService = BuildAuthorizationService(services =&gt;
600              {
601                  services.AddAuthorization(options =&gt;
602                  {
603                      var basePolicy = new AuthorizationPolicyBuilder().RequireClaim(&quot;Base&quot;, &quot;Value&quot;).Build();
604                      options.AddPolicy(&quot;Combined&quot;, policy =&gt; policy.Combine(basePolicy).RequireClaim(&quot;Claim&quot;, &quot;Exists&quot;));
605                  });
606              });
607              var user = new ClaimsPrincipal(
608                  new ClaimsIdentity(
609                      new Claim[] {
610                          new Claim(&quot;Base&quot;, &quot;Value&quot;),
611                      },
612                      &quot;AuthType&quot;)
613                  );
614              var allowed = await authorizationService.AuthorizeAsync(user, null, &quot;Combined&quot;);
615              Assert.False(allowed.Succeeded);
616          }
617          public class ExpenseReport { }
618          public static class Operations
619          {
620              public static OperationAuthorizationRequirement Edit = new OperationAuthorizationRequirement { Name = &quot;Edit&quot; };
621              public static OperationAuthorizationRequirement Create = new OperationAuthorizationRequirement { Name = &quot;Create&quot; };
622              public static OperationAuthorizationRequirement Delete = new OperationAuthorizationRequirement { Name = &quot;Delete&quot; };
623          }
624          public class ExpenseReportAuthorizationHandler : AuthorizationHandler&lt;OperationAuthorizationRequirement, ExpenseReport&gt;
625          {
626              public ExpenseReportAuthorizationHandler(IEnumerable&lt;OperationAuthorizationRequirement&gt; authorized)
627              {
628                  _allowed = authorized;
629              }
630              private IEnumerable&lt;OperationAuthorizationRequirement&gt; _allowed;
631              protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, OperationAuthorizationRequirement requirement, ExpenseReport resource)
632              {
633                  if (_allowed.Contains(requirement))
634                  {
635                      context.Succeed(requirement);
636                  }
637                  return Task.FromResult(0);
638              }
639          }
640          public class SuperUserHandler : AuthorizationHandler&lt;OperationAuthorizationRequirement&gt;
641          {
642              protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, OperationAuthorizationRequirement requirement)
643              {
644                  if (context.User.HasClaim(&quot;SuperUser&quot;, &quot;yes&quot;))
645                  {
646                      context.Succeed(requirement);
647                  }
648                  return Task.FromResult(0);
649              }
650          }
651          [Fact]
652          public async Task CanAuthorizeAllSuperuserOperations()
653          {
654              var authorizationService = BuildAuthorizationService(services =&gt;
655              {
656                  services.AddSingleton&lt;IAuthorizationHandler&gt;(new ExpenseReportAuthorizationHandler(new OperationAuthorizationRequirement[] { Operations.Edit }));
657                  services.AddTransient&lt;IAuthorizationHandler, SuperUserHandler&gt;();
658              });
659              var user = new ClaimsPrincipal(
660                  new ClaimsIdentity(
661                      new Claim[] {
662                          new Claim(&quot;SuperUser&quot;, &quot;yes&quot;),
663                      },
664                      &quot;AuthType&quot;)
665                  );
666              Assert.True((await authorizationService.AuthorizeAsync(user, null, Operations.Edit)).Succeeded);
667              Assert.True((await authorizationService.AuthorizeAsync(user, null, Operations.Delete)).Succeeded);
668              Assert.True((await authorizationService.AuthorizeAsync(user, null, Operations.Create)).Succeeded);
669          }
670          public class NotCalledHandler : AuthorizationHandler&lt;OperationAuthorizationRequirement, string&gt;
671          {
672              protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, OperationAuthorizationRequirement requirement, string resource)
673              {
674                  throw new NotImplementedException();
675              }
676          }
677          public class EvenHandler : AuthorizationHandler&lt;OperationAuthorizationRequirement, int&gt;
678          {
679              protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, OperationAuthorizationRequirement requirement, int id)
680              {
681                  if (id % 2 == 0)
682                  {
683                      context.Succeed(requirement);
684                  }
685                  return Task.FromResult(0);
686              }
687          }
688          [Fact]
689          public async Task CanUseValueTypeResource()
690          {
691              var authorizationService = BuildAuthorizationService(services =&gt;
692              {
693                  services.AddTransient&lt;IAuthorizationHandler, EvenHandler&gt;();
694              });
695              var user = new ClaimsPrincipal(
696                  new ClaimsIdentity(
697                      new Claim[] {
698                      },
699                      &quot;AuthType&quot;)
700                  );
701              Assert.False((await authorizationService.AuthorizeAsync(user, 1, Operations.Edit)).Succeeded);
702              Assert.True((await authorizationService.AuthorizeAsync(user, 2, Operations.Edit)).Succeeded);
703          }
704          [Fact]
705          public async Task DoesNotCallHandlerWithWrongResourceType()
706          {
707              var authorizationService = BuildAuthorizationService(services =&gt;
708              {
709                  services.AddTransient&lt;IAuthorizationHandler, NotCalledHandler&gt;();
710              });
711              var user = new ClaimsPrincipal(
712                  new ClaimsIdentity(
713                      new Claim[] {
714                          new Claim(&quot;SuperUser&quot;, &quot;yes&quot;)
715                      },
716                      &quot;AuthType&quot;)
717                  );
718              Assert.False((await authorizationService.AuthorizeAsync(user, 1, Operations.Edit)).Succeeded);
719          }
720          [Fact]
721          public async Task CanAuthorizeOnlyAllowedOperations()
722          {
723              var authorizationService = BuildAuthorizationService(services =&gt;
724              {
725                  services.AddSingleton&lt;IAuthorizationHandler&gt;(new ExpenseReportAuthorizationHandler(new OperationAuthorizationRequirement[] { Operations.Edit }));
726              });
727              var user = new ClaimsPrincipal();
728              Assert.True((await authorizationService.AuthorizeAsync(user, new ExpenseReport(), Operations.Edit)).Succeeded);
729              Assert.False((await authorizationService.AuthorizeAsync(user, new ExpenseReport(), Operations.Delete)).Succeeded);
730              Assert.False((await authorizationService.AuthorizeAsync(user, new ExpenseReport(), Operations.Create)).Succeeded);
731          }
732          [Fact]
733          public async Task AuthorizeHandlerNotCalledWithNullResource()
734          {
735              var authorizationService = BuildAuthorizationService(services =&gt;
736              {
<span onclick='openModal()' class='match'>737                  services.AddSingleton&lt;IAuthorizationHandler&gt;(new ExpenseReportAuthorizationHandler(new OperationAuthorizationRequirement[] { Operations.Edit }));
738              });
</span>739              var user = new ClaimsPrincipal();
740              Assert.False((await authorizationService.AuthorizeAsync(user, null, Operations.Edit)).Succeeded);
741          }
742          [Fact]
743          public async Task CanAuthorizeWithAssertionRequirement()
744          {
745              var authorizationService = BuildAuthorizationService(services =&gt;
746              {
747                  services.AddAuthorization(options =&gt;
748                  {
749                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireAssertion(context =&gt; true));
750                  });
751              });
752              var user = new ClaimsPrincipal();
753              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
754              Assert.True(allowed.Succeeded);
755          }
756          [Fact]
757          public async Task CanAuthorizeWithAsyncAssertionRequirement()
758          {
759              var authorizationService = BuildAuthorizationService(services =&gt;
760              {
761                  services.AddAuthorization(options =&gt;
762                  {
763                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireAssertion(context =&gt; Task.FromResult(true)));
764                  });
765              });
766              var user = new ClaimsPrincipal();
767              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
768              Assert.True(allowed.Succeeded);
769          }
770          public class StaticPolicyProvider : IAuthorizationPolicyProvider
771          {
772              public Task&lt;AuthorizationPolicy&gt; GetDefaultPolicyAsync()
773              {
774                  return Task.FromResult(new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build());
775              }
776              public Task&lt;AuthorizationPolicy&gt; GetRequiredPolicyAsync()
777              {
778                  return Task.FromResult&lt;AuthorizationPolicy&gt;(null);
779              }
780              public Task&lt;AuthorizationPolicy&gt; GetPolicyAsync(string policyName)
781              {
782                  return Task.FromResult(new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build());
783              }
784          }
785          [Fact]
786          public async Task CanReplaceDefaultPolicyProvider()
787          {
788              var authorizationService = BuildAuthorizationService(services =&gt;
789              {
790                  services.AddSingleton&lt;IAuthorizationPolicyProvider, StaticPolicyProvider&gt;();
791                  services.AddAuthorization(options =&gt;
792                  {
793                      options.AddPolicy(&quot;Basic&quot;, policy =&gt; policy.RequireAssertion(context =&gt; true));
794                  });
795              });
796              var user = new ClaimsPrincipal();
797              var allowed = await authorizationService.AuthorizeAsync(user, &quot;Basic&quot;);
798              Assert.False(allowed.Succeeded);
799          }
800          public class DynamicPolicyProvider : IAuthorizationPolicyProvider
801          {
802              public Task&lt;AuthorizationPolicy&gt; GetDefaultPolicyAsync()
803              {
804                  return Task.FromResult(new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build());
805              }
806              public Task&lt;AuthorizationPolicy&gt; GetRequiredPolicyAsync()
807              {
808                  return Task.FromResult&lt;AuthorizationPolicy&gt;(null);
809              }
810              public Task&lt;AuthorizationPolicy&gt; GetPolicyAsync(string policyName)
811              {
812                  return Task.FromResult(new AuthorizationPolicyBuilder().RequireClaim(policyName).Build());
813              }
814          }
815          [Fact]
816          public async Task CanUseDynamicPolicyProvider()
817          {
818              var authorizationService = BuildAuthorizationService(services =&gt;
819              {
820                  services.AddSingleton&lt;IAuthorizationPolicyProvider, DynamicPolicyProvider&gt;();
821                  services.AddAuthorization(options =&gt; { });
822              });
823              var id = new ClaimsIdentity();
824              id.AddClaim(new Claim(&quot;1&quot;, &quot;1&quot;));
825              id.AddClaim(new Claim(&quot;2&quot;, &quot;2&quot;));
826              var user = new ClaimsPrincipal(id);
827              Assert.False((await authorizationService.AuthorizeAsync(user, &quot;0&quot;)).Succeeded);
828              Assert.True((await authorizationService.AuthorizeAsync(user, &quot;1&quot;)).Succeeded);
829              Assert.True((await authorizationService.AuthorizeAsync(user, &quot;2&quot;)).Succeeded);
830              Assert.False((await authorizationService.AuthorizeAsync(user, &quot;3&quot;)).Succeeded);
831          }
832          public class SuccessEvaluator : IAuthorizationEvaluator
833          {
834              public AuthorizationResult Evaluate(AuthorizationHandlerContext context) =&gt; AuthorizationResult.Success();
835          }
836          [Fact]
837          public async Task CanUseCustomEvaluatorThatOverridesRequirement()
838          {
839              var authorizationService = BuildAuthorizationService(services =&gt;
840              {
841                  services.AddSingleton&lt;IAuthorizationEvaluator, SuccessEvaluator&gt;();
842                  services.AddAuthorization(options =&gt; options.AddPolicy(&quot;Fail&quot;, p =&gt; p.RequireAssertion(c =&gt; false)));
843              });
844              var result = await authorizationService.AuthorizeAsync(null, &quot;Fail&quot;);
845              Assert.True(result.Succeeded);
846          }
847          public class BadContextMaker : IAuthorizationHandlerContextFactory
848          {
849              public AuthorizationHandlerContext CreateContext(IEnumerable&lt;IAuthorizationRequirement&gt; requirements, ClaimsPrincipal user, object resource)
850              {
851                  return new BadContext();
852              }
853          }
854          public class BadContext : AuthorizationHandlerContext
855          {
856              public BadContext() : base(new List&lt;IAuthorizationRequirement&gt;(), null, null) { }
857              public override bool HasFailed
858              {
859                  get
860                  {
861                      return true;
862                  }
863              }
864              public override bool HasSucceeded
865              {
866                  get
867                  {
868                      return false;
869                  }
870              }
871          }
872          [Fact]
873          public async Task CanUseCustomContextThatAlwaysFails()
874          {
875              var authorizationService = BuildAuthorizationService(services =&gt;
876              {
877                  services.AddSingleton&lt;IAuthorizationHandlerContextFactory, BadContextMaker&gt;();
878                  services.AddAuthorization(options =&gt; options.AddPolicy(&quot;Success&quot;, p =&gt; p.RequireAssertion(c =&gt; true)));
879              });
880              Assert.False((await authorizationService.AuthorizeAsync(null, &quot;Success&quot;)).Succeeded);
881          }
882          public class SadHandlerProvider : IAuthorizationHandlerProvider
883          {
884              public Task&lt;IEnumerable&lt;IAuthorizationHandler&gt;&gt; GetHandlersAsync(AuthorizationHandlerContext context)
885              {
886                  return Task.FromResult&lt;IEnumerable&lt;IAuthorizationHandler&gt;&gt;(new IAuthorizationHandler[1] { new FailHandler() });
887              }
888          }
889          [Fact]
890          public async Task CanUseCustomHandlerProvider()
891          {
892              var authorizationService = BuildAuthorizationService(services =&gt;
893              {
894                  services.AddSingleton&lt;IAuthorizationHandlerProvider, SadHandlerProvider&gt;();
895                  services.AddAuthorization(options =&gt; options.AddPolicy(&quot;Success&quot;, p =&gt; p.RequireAssertion(c =&gt; true)));
896              });
897              Assert.False((await authorizationService.AuthorizeAsync(null, &quot;Success&quot;)).Succeeded);
898          }
899      }
900  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-DefaultAuthorizationServiceTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-DefaultAuthorizationServiceTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>725                  services.AddSingleton&lt;IAuthorizationHandler&gt;(new ExpenseReportAuthorizationHandler(new OperationAuthorizationRequirement[] { Operations.Edit }));
726              });
</pre></code></div>
                <div class="column column_space"><pre><code>737                  services.AddSingleton&lt;IAuthorizationHandler&gt;(new ExpenseReportAuthorizationHandler(new OperationAuthorizationRequirement[] { Operations.Edit }));
738              });
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    