
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 13, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-BugTests.cs</h3>
            <pre><code>1  using Npgsql.BackendMessages;
2  using Npgsql.Tests.Support;
3  using Npgsql.TypeMapping;
4  using NpgsqlTypes;
5  using NUnit.Framework;
6  using System;
7  using System.Data;
8  using System.Text;
9  using System.Threading;
10  using System.Threading.Tasks;
11  using System.Transactions;
12  using static Npgsql.Tests.TestUtil;
13  namespace Npgsql.Tests;
14  public class BugTests : TestBase
15  {
16      #region Sequential reader bugs
17      [Test, Description("In sequential access, performing a null check on a non-first field would check the first field")]
18      public void SequentialNullCheckOnNonFirstField()
19      {
20          using var conn = OpenConnection();
21          using var cmd = new NpgsqlCommand("SELECT 'X', NULL", conn);
22          using var dr = cmd.ExecuteReader(CommandBehavior.SequentialAccess);
23          dr.Read();
24          Assert.That(dr.IsDBNull(1), Is.True);
25      }
26      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1034")]
27      public void SequentialSkipOverFirstRow()
28      {
29          using var conn = OpenConnection();
30          using var cmd = new NpgsqlCommand("SELECT 1; SELECT 2", conn);
31          using var reader = cmd.ExecuteReader(CommandBehavior.SequentialAccess);
32          Assert.That(reader.NextResult(), Is.True);
33          Assert.That(reader.Read(), Is.True);
34          Assert.That(reader.GetInt32(0), Is.EqualTo(2));
35      }
36      [Test]
37      public void SequentialConsumeWithNull()
38      {
39          using var conn = OpenConnection();
40          using var command = new NpgsqlCommand("SELECT 1, NULL", conn);
41          using var reader = command.ExecuteReader(CommandBehavior.SequentialAccess);
42          reader.Read();
43      }
44      #endregion
45      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1210")]
46      public void Many_parameters_with_mixed_FormatCode()
47      {
48          using var conn = OpenConnection();
49          using var cmd = new NpgsqlCommand();
50          cmd.Connection = conn;
51          var sb = new StringBuilder("SELECT @text_param");
52          cmd.Parameters.AddWithValue("@text_param", "some_text");
53          for (var i = 0; i < conn.Settings.WriteBufferSize; i++)
54          {
55              var paramName = $"@binary_param{i}";
56              sb.Append(',');
57              sb.Append(paramName);
58              cmd.Parameters.AddWithValue(paramName, 8);
59          }
60          cmd.CommandText = sb.ToString();
61          var ex = Assert.Throws<PostgresException>(() => cmd.ExecuteNonQuery())!;
62          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.ProgramLimitExceeded)
63              .Or.EqualTo(PostgresErrorCodes.TooManyColumns)); 
64      }
65      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1238")]
66      public void Record_with_non_int_field()
67      {
68          using var conn = OpenConnection();
69          using var cmd = new NpgsqlCommand("SELECT ('one'::TEXT, 2)", conn);
70          using var reader = cmd.ExecuteReader();
71          reader.Read();
72          var record = reader.GetFieldValue<object[]>(0);
73          Assert.That(record[0], Is.EqualTo("one"));
74          Assert.That(record[1], Is.EqualTo(2));
75      }
76      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1450")]
77      public void Bug1450()
78      {
79          using var conn = OpenConnection();
80          using var cmd = new NpgsqlCommand();
81          cmd.Connection = conn;
82          cmd.CommandText = "CREATE TEMP TABLE a (a1 int); CREATE TEMP TABLE b (b1 int);";
83          cmd.ExecuteNonQuery();
84          cmd.CommandText = "CREATE TEMP TABLE c (c1 int);";
85          cmd.ExecuteNonQuery();
86      }
87      [Test]
88      public async Task Bug1645()
89      {
90          await using var conn = await OpenConnectionAsync();
91          var tableName = await CreateTempTable(conn, "field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER");
92          Assert.That(() =>
93              {
94                  using var writer = conn.BeginBinaryImport($"COPY {tableName} (field_text, field_int4) FROM STDIN BINARY");
95                  writer.StartRow();
96                  writer.Write("foo");
97                  writer.Write(8);
98                  writer.StartRow();
99                  throw new InvalidOperationException("Catch me outside the using statement if you can!");
100              }, Throws.Exception
101                  .TypeOf<InvalidOperationException>()
102                  .With.Property(nameof(InvalidOperationException.Message)).EqualTo("Catch me outside the using statement if you can!")
103          );
104          Assert.That(await conn.ExecuteScalarAsync($"SELECT COUNT(*) FROM {tableName}"), Is.Zero);
105      }
106      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3600")]
107      public async Task Bug3600()
108      {
109          var csb = new NpgsqlConnectionStringBuilder(ConnectionString)
110          {
111              CommandTimeout = 1,
112          };
113          await using var postmasterMock = PgPostmasterMock.Start(csb.ConnectionString);
114          await using var dataSource = CreateDataSource(postmasterMock.ConnectionString);
115          await using var conn = await dataSource.OpenConnectionAsync();
116          var serverMock = await postmasterMock.WaitForServerConnection();
117          await serverMock
118              .WriteCopyInResponse()
119              .FlushAsync();
120          var ex = Assert.ThrowsAsync<NpgsqlException>(async () =>
121          {
122              await using var importer = await conn.BeginTextImportAsync($"COPY SomeTable (field_text, field_int4) FROM STDIN");
123          });
124          Assert.That(ex!.InnerException, Is.TypeOf<TimeoutException>());
125      }
126      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1497")]
127      public async Task Bug1497()
128      {
129          await using var conn = await OpenConnectionAsync();
130          var tableName = await CreateTempTable(conn, "id INT4");
131          conn.ExecuteNonQuery($"INSERT INTO {tableName} (id) VALUES (NULL)");
132          await using var cmd = new NpgsqlCommand($"SELECT * FROM {tableName}", conn);
133          await using var reader = await cmd.ExecuteReaderAsync();
134          var dt = new DataTable();
135          dt.Load(reader);
136      }
137      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1558")]
138      public void Bug1558()
139      {
140          using var dataSource = CreateDataSource(csb =>
141          {
142              csb.Pooling = false;
143              csb.Enlist = true;
144          });
145          using var tx = new TransactionScope();
146          using var conn = dataSource.OpenConnection();
147      }
148      [Test]
149      public void Bug1695()
150      {
151          using var dataSource = CreateDataSource(csb =>
152          {
153              csb.Pooling = false;
154              csb.MaxAutoPrepare = 10;
155              csb.AutoPrepareMinUsages = 1;
156          });
157          using var conn = dataSource.OpenConnection();
158          using (var cmd = new NpgsqlCommand("SELECT 1; SELECT 2", conn))
159          using (var reader = cmd.ExecuteReader())
160          {
161              reader.Read();
162          }
163          Assert.That(conn.ExecuteScalar("SELECT 2"), Is.EqualTo(2));
164      }
165      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1700")]
166      public void Bug1700()
167      {
168          Assert.That(() =>
169          {
170              using var conn = OpenConnection();
171              using var tx = conn.BeginTransaction();
172              using var cmd = conn.CreateCommand();
173              cmd.CommandText = "SELECT 1";
174              var reader = cmd.ExecuteReader();
175              while (reader.Read())
176              {
177                  throw new InvalidOperationException("Some problem parsing the returned data");
178              }
179              tx.Commit();
180          }, Throws.InvalidOperationException.With.Message.EqualTo("Some problem parsing the returned data"));
181      }
182      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1964")]
183      public void Bug1964()
184      {
185          using var conn = OpenConnection();
186          using var cmd = new NpgsqlCommand("INVALID SQL", conn);
187          cmd.Parameters.Add(new NpgsqlParameter { ParameterName = "p", Direction = ParameterDirection.Output });
188          Assert.That(() => cmd.ExecuteNonQuery(), Throws.Exception.TypeOf<PostgresException>()
189              .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.SyntaxError));
190      }
191      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1986")]
192      public void Bug1986()
193      {
194          using var conn = OpenConnection();
195          using var cmd = new NpgsqlCommand("SELECT 'hello', 'goodbye'", conn);
196          using var reader = cmd.ExecuteReader();
197          reader.Read();
198          using (var textReader1 = reader.GetTextReader(0))
199          {
200          }
201          using (var textReader2 = reader.GetTextReader(1))
202          {
203          }
204      }
205      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1987")]
206      public async Task Bug1987()
207      {
208          await using var adminConnection = await OpenConnectionAsync();
209          var type = await GetTempTypeName(adminConnection);
210          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} AS ENUM ('sad', 'ok', 'happy')");
211          var dataSourceBuilder = CreateDataSourceBuilder();
212          dataSourceBuilder.MapEnum<Mood>(type);
213          await using var dataSource = dataSourceBuilder.Build();
214          await using var connection = await dataSource.OpenConnectionAsync();
215          for (var i = 0; i < 2; i++)
216          {
217              await using var cmd = new NpgsqlCommand("SELECT @p", connection);
218              cmd.Parameters.AddWithValue("p", Mood.Happy);
219              Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(Mood.Happy));
220          }
221      }
222      enum Mood { Sad, Ok, Happy };
223      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2003")]
224      public void Bug2003()
225      {
226          using var conn = OpenConnection();
227          var longFieldName = new string('x', conn.Settings.ReadBufferSize);
228          using var cmd = new NpgsqlCommand($"SELECT 8 AS {longFieldName}", conn);
229          using var reader = cmd.ExecuteReader(CommandBehavior.SequentialAccess);
230          reader.Read();
231          Assert.That(reader.GetInt32(0), Is.EqualTo(8));
232      }
233      [Test]
234      public async Task Bug2046()
235      {
236          var expected = 64.27245f;
237          using var conn = OpenConnection();
238          using var cmd = new NpgsqlCommand("SELECT @p = 64.27245::real, 64.27245::real, @p", conn);
239          cmd.Parameters.AddWithValue("p", expected);
240          using var rdr = await cmd.ExecuteReaderAsync();
241          rdr.Read();
242          Assert.That(rdr.GetFieldValue<bool>(0));
243          Assert.That(rdr.GetFieldValue<float>(1), Is.EqualTo(expected));
244          Assert.That(rdr.GetFieldValue<float>(2), Is.EqualTo(expected));
245      }
246      [Test]
247      public void Bug1761()
248      {
249          using var dataSource = CreateDataSource(csb =>
250          {
251              csb.Enlist = true;
252              csb.Pooling = true;
253              csb.MinPoolSize = 1;
254              csb.MaxPoolSize = 1;
255          });
256          for (var i = 0; i < 2; i++)
257          {
258              try
259              {
260                  using var scope = new TransactionScope(TransactionScopeOption.Required, TimeSpan.FromMilliseconds(100));
261                  Thread.Sleep(1000);
262                  using (var connection = dataSource.OpenConnection())
263                  using (var cmd = new NpgsqlCommand("SELECT 1", connection))
264                  {
265                      cmd.CommandText = "select 1;";
266                      cmd.ExecuteNonQuery();
267                  }
268                  scope.Complete();
269              }
270              catch (TransactionException)
271              {
272              }
273          }
274      }
275      [Test]
276      public void Bug2274()
277      {
278          using var conn = OpenConnection();
279          using var cmd = new NpgsqlCommand("SELECT 1", conn);
280          cmd.Parameters.Add(new NpgsqlParameter
281          {
282              ParameterName = "p",
283              Direction = ParameterDirection.Output
284          });
285          using var reader = cmd.ExecuteReader(CommandBehavior.SingleRow);
286          Assert.That(() => reader.GetInt32(0), Throws.Exception.TypeOf<InvalidOperationException>());
287          Assert.That(reader.Read(), Is.True);
288          Assert.That(reader.GetInt32(0), Is.EqualTo(1));
289          Assert.That(reader.Read(), Is.False);
290      }
291      [Test]
292      public async Task Bug2278()
293      {
294          await using var adminConnection = await OpenConnectionAsync();
295          var enumType = await GetTempTypeName(adminConnection);
296          var domainType = await GetTempTypeName(adminConnection);
297          var compositeType = await GetTempTypeName(adminConnection);
298          await adminConnection.ExecuteNonQueryAsync($@"
299  CREATE TYPE {enumType} AS ENUM ('left', 'right');
300  CREATE DOMAIN {domainType} AS {enumType} NOT NULL;
301  CREATE TYPE {compositeType} AS (value {domainType})");
302          var table = await CreateTempTable(adminConnection, $"value {compositeType}");
303          var dataSourceBuilder = CreateDataSourceBuilder();
304          dataSourceBuilder.MapComposite<Bug2278CompositeType>(compositeType);
305          dataSourceBuilder.MapEnum<Bug2278EnumType>(enumType);
306          await using var dataSource = dataSourceBuilder.Build();
307          await using var connection = await dataSource.OpenConnectionAsync();
308          await connection.ExecuteScalarAsync($"SELECT * FROM {table} AS d");
309      }
310      class Bug2278CompositeType
311      {
312          public Bug2278EnumType Value { get; set; }
313      }
314      enum Bug2278EnumType
315      {
316          Left,
317          Right
318      }
319      [Test]
320      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2178")]
321      public async Task Bug2178()
322      {
323          await using var dataSource = CreateDataSource(csb =>
324          {
325              csb.AutoPrepareMinUsages = 2;
326              csb.MaxAutoPrepare = 2;
327          });
328          await using var conn = await dataSource.OpenConnectionAsync();
329          await using var cmd = new NpgsqlCommand();
330          cmd.Connection = conn;
<span onclick='openModal()' class='match'>331          cmd.CommandText = "SELECT 1";
332          await cmd.ExecuteScalarAsync();
333          await cmd.ExecuteScalarAsync();
</span>334          Assert.That(cmd.IsPrepared);
335          cmd.CommandText = "SELECT * FROM public.dummy_table_name";
336          for (var i = 0; i < 3; ++i)
337          {
338              Assert.ThrowsAsync<PostgresException>(async () => await cmd.ExecuteScalarAsync());
339          }
340          cmd.CommandText = "SELECT 1";
341          await cmd.ExecuteScalarAsync();
342          Assert.That(cmd.IsPrepared);
343      }
344      [Test]
345      public async Task Bug2296()
346      {
347          await using var conn = await OpenConnectionAsync();
348          await conn.ExecuteNonQueryAsync("DROP TYPE IF EXISTS \"boolean\" CASCADE");
349          await conn.ExecuteNonQueryAsync("CREATE DOMAIN pg_temp.\"boolean\" AS bool");
350          conn.ReloadTypes();
351          var tableName = await CreateTempTable(conn, $"mybool \"boolean\"");
352          await conn.ExecuteNonQueryAsync($"INSERT INTO {tableName} (mybool) VALUES (TRUE)");
353          await conn.ExecuteScalarAsync($"SELECT mybool FROM {tableName}");
354      }
355      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2660")]
356      public void Standard_conforming_strings()
357      {
358          using var conn = OpenConnection();
359          var sql = @"
360  SELECT table_name
361  FROM information_schema.views
362  WHERE table_name LIKE @p0 escape '\' AND (is_updatable = 'NO') = @p1";
363          using var cmd = new NpgsqlCommand(sql, conn);
364          cmd.Parameters.AddWithValue("@p0", "%trig%");
365          cmd.Parameters.AddWithValue("@p1", true);
366          using var reader = cmd.ExecuteReader();
367          reader.Read();
368      }
369      #region Bug1285
370      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1285")]
371      public void Bug1285()
372      {
373          using var conn = OpenConnection();
374          using var cmd = new NpgsqlCommand { Connection = conn };
375          cmd.CommandText = Bug1285CreateStatement;
376          cmd.ExecuteNonQuery();
377          cmd.CommandText = Bug1285SelectStatement;
378          cmd.Parameters.Add(new NpgsqlParameter("@1", Guid.NewGuid()));
379          cmd.ExecuteNonQuery();
380      }
381      const string Bug1285SelectStatement =
382          "select " +
383          " \"Afbeelding\"" +
384          ", \"Afbeelding#Id\"" +
385          ", \"Omschrijving\"" +
386          ", \"Website\"" +
387          ", \"EMailadres\"" +
388          ", \"SocialMediaVastleggen\"" +
389          ", \"Facebook\"" +
390          ", \"Linkedin\"" +
391          ", \"Twitter\"" +
392          ", \"Youtube\"" +
393          ", \"Branche\"" +
394          ", \"Branche#Id\"" +
395          ", \"Branche#ComponentId\"" +
396          ", \"Telefoonnummer\"" +
397          ", \"Overheidsidentificatienummer\"" +
398          ", \"Adres\"" +
399          ", \"Adres#Id\"" +
400          ", \"Adres#ComponentId\"" +
401          ", \"2gIKz62kaTdGxw82_OrzTc4ANSM_\"" +
402          ", \"OnderdeelVanOrganisatie\"" +
403          ", \"OnderdeelVanOrganisatie#Id\"" +
404          ", \"OnderdeelVanOrganisatie#ComponentId\"" +
405          ", \"Profit\"" +
406          ", \"Profit#Id\"" +
407          ", \"Profit#ComponentId\"" +
408          ", \"Taal\"" +
409          ", \"Taal#Id\"" +
410          ", \"Taal#ComponentId\"" +
411          ", \"KlantSinds\"" +
412          ", \"BarcodeKlant\"" +
413          ", \"BarcodeKlant#BarcodeType\"" +
414          ", \"BarcodeKlant#Value\"" +
415          ", \"Postadres\"" +
416          ", \"Postadres#Id\"" +
417          ", \"Postadres#ComponentId\"" +
418          ", \"LeverancierSinds\"" +
419          ", \"BarcodeLeverancier\"" +
420          ", \"BarcodeLeverancier#BarcodeType\"" +
421          ", \"BarcodeLeverancier#Value\"" +
422          ", \"Zoeknaam\"" +
423          ", \"TitelEnAanhef\"" +
424          ", \"TitelEnAanhef#Id\"" +
425          ", \"TitelEnAanhef#ComponentId\"" +
426          ", \"Rechtsvorm\"" +
427          ", \"Rechtsvorm#Id\"" +
428          ", \"Rechtsvorm#ComponentId\"" +
429          ", \"LandVanVestiging\"" +
430          ", \"LandVanVestiging#Id\"" +
431          ", \"LandVanVestiging#ComponentId\"" +
432          ", \"AantalMedewerkers\"" +
433          ", \"NaamStatutair\"" +
434          ", \"VestigingStatutair\"" +
435          ", \"Correspondentie\"" +
436          ", \"Medium\"" +
437          ", \"FiscaalNummer\"" +
438          ", \"AangebrachtDoor\"" +
439          ", \"AangebrachtDoor#Id\"" +
440          ", \"AangebrachtDoor#ComponentId\"" +
441          ", \"Status\"" +
442          ", \"NummerKamerVanKoophandel\"" +
443          ", \"zII9SOHbwUPS_jKSlcRrQzuEr6A_\"" +
444          ", \"Code\"" +
445          ", \"OrganisatorischeEenheid\"" +
446          ", \"OrganisatorischeEenheid#Id\"" +
447          ", \"OrganisatorischeEenheid#ComponentId\"" +
448          ", \"PJlr3asVdeHVoqmAyHIF2fF1gVM_\"" +
449          ", \"IsUwv\"" +
450          ", \"Uwv\"" +
451          ", \"Uwv#Id\"" +
452          ", \"Uwv#ComponentId\"" +
453          ", \"IsVerzekeraarVoorWerkgever\"" +
454          ", \"VerzekeraarVoorWerkgever\"" +
455          ", \"VerzekeraarVoorWerkgever#Id\"" +
456          ", \"VerzekeraarVoorWerkgever#ComponentId\"" +
457          ", \"IsAbonnementsadministratie\"" +
458          ", \"Abonnementsadministratie\"" +
459          ", \"Abonnementsadministratie#Id\"" +
460          ", \"Abonnementsadministratie#ComponentId\"" +
461          ", \"IsPensioenfonds\"" +
462          ", \"Pensioenfonds\"" +
463          ", \"Pensioenfonds#Id\"" +
464          ", \"Pensioenfonds#ComponentId\"" +
465          ", \"IsProfit\"" +
466          ", \"Profit1\"" +
467          ", \"Profit1#Id\"" +
468          ", \"Profit1#ComponentId\"" +
469          ", \"Verantwoordelijke\"" +
470          ", \"Verantwoordelijke#Id\"" +
471          ", \"Verantwoordelijke#ComponentId\"" +
472          ", \"IsKlant\"" +
473          ", \"Klant\"" +
474          ", \"Klant#Id\"" +
475          ", \"Klant#ComponentId\"" +
476          ", \"IsFactureringsadministratie\"" +
477          ", \"Factureringsadministratie\"" +
478          ", \"Factureringsadministratie#Id\"" +
479          ", \"Factureringsadministratie#ComponentId\"" +
480          ", \"IsLeninggever\"" +
481          ", \"Leninggever\"" +
482          ", \"Leninggever#Id\"" +
483          ", \"Leninggever#ComponentId\"" +
484          ", \"IsProjectadministratie\"" +
485          ", \"Projectadministratie\"" +
486          ", \"Projectadministratie#Id\"" +
487          ", \"Projectadministratie#ComponentId\"" +
488          ", \"IsVervangingsfonds\"" +
489          ", \"Vervangingsfonds\"" +
490          ", \"Vervangingsfonds#Id\"" +
491          ", \"Vervangingsfonds#ComponentId\"" +
492          ", \"IsPensioen\"" +
493          ", \"Pensioen\"" +
494          ", \"Pensioen#Id\"" +
495          ", \"Pensioen#ComponentId\"" +
496          ", \"IsVasteActivaAdministratie\"" +
497          ", \"VasteActivaAdministratie\"" +
498          ", \"VasteActivaAdministratie#Id\"" +
499          ", \"VasteActivaAdministratie#ComponentId\"" +
500          ", \"IsBelastingdienst\"" +
501          ", \"Belastingdienst\"" +
502          ", \"Belastingdienst#Id\"" +
503          ", \"Belastingdienst#ComponentId\"" +
504          ", \"IsCursusadministratie\"" +
505          ", \"Cursusadministratie\"" +
506          ", \"Cursusadministratie#Id\"" +
507          ", \"Cursusadministratie#ComponentId\"" +
508          ", \"IsUitvoerderVervangingsfonds\"" +
509          ", \"UitvoerderVervangingsfonds\"" +
510          ", \"UitvoerderVervangingsfonds#Id\"" +
511          ", \"UitvoerderVervangingsfonds#ComponentId\"" +
512          ", \"IsAssemblageadministratie\"" +
513          ", \"Assemblageadministratie\"" +
514          ", \"Assemblageadministratie#Id\"" +
515          ", \"Assemblageadministratie#ComponentId\"" +
516          ", \"IsLeasemaatschappij\"" +
517          ", \"Leasemaatschappij\"" +
518          ", \"Leasemaatschappij#Id\"" +
519          ", \"Leasemaatschappij#ComponentId\"" +
520          ", \"IsBeslaglegger\"" +
521          ", \"Beslaglegger\"" +
522          ", \"Beslaglegger#Id\"" +
523          ", \"Beslaglegger#ComponentId\"" +
524          ", \"IsVerzekeraarVoorMedewerker\"" +
525          ", \"VerzekeraarVoorMedewerker\"" +
526          ", \"VerzekeraarVoorMedewerker#Id\"" +
527          ", \"VerzekeraarVoorMedewerker#ComponentId\"" +
528          ", \"IsWoningverhuur\"" +
529          ", \"Woningverhuur\"" +
530          ", \"Woningverhuur#Id\"" +
531          ", \"Woningverhuur#ComponentId\"" +
532          ", \"9cSTu7fkjOZm08FFQUHvclQHSWY_\"" +
533          ", \"Goederenstroomadministratie\"" +
534          ", \"Goederenstroomadministratie#Id\"" +
535          ", \"Goederenstroomadministratie#ComponentId\"" +
536          ", \"IsConcurrent\"" +
537          ", \"Concurrent\"" +
538          ", \"Concurrent#Id\"" +
539          ", \"Concurrent#ComponentId\"" +
540          ", \"IsArbodienst\"" +
541          ", \"Arbodienst\"" +
542          ", \"Arbodienst#Id\"" +
543          ", \"Arbodienst#ComponentId\"" +
544          ", \"IsUitvoerderSociaalFonds\"" +
545          ", \"UitvoerderSociaalFonds\"" +
546          ", \"UitvoerderSociaalFonds#Id\"" +
547          ", \"UitvoerderSociaalFonds#ComponentId\"" +
548          ", \"IsPensioenuitvoerder\"" +
549          ", \"Pensioenuitvoerder\"" +
550          ", \"Pensioenuitvoerder#Id\"" +
551          ", \"Pensioenuitvoerder#ComponentId\"" +
552          ", \"IsProspect\"" +
553          ", \"Prospect\"" +
554          ", \"Prospect#Id\"" +
555          ", \"Prospect#ComponentId\"" +
556          ", \"IsProspectadministratie\"" +
557          ", \"Prospectadministratie\"" +
558          ", \"Prospectadministratie#Id\"" +
559          ", \"Prospectadministratie#ComponentId\"" +
560          ", \"IsArtikelbeheeradministratie\"" +
561          ", \"Artikelbeheeradministratie\"" +
562          ", \"Artikelbeheeradministratie#Id\"" +
563          ", \"Artikelbeheeradministratie#ComponentId\"" +
564          ", \"v1J4Rq2eNZy9GBvGhuCBKqga0Rg_\"" +
565          ", \"g4i3gYZGL0yu0T6UwmiZTaUDI8Y_\"" +
566          ", \"g4i3gYZGL0yu0T6UwmiZTaUDI8Y_#Id\"" +
567          ", \"g4i3gYZGL0yu0T6UwmiZTaUDI8Y_#ComponentId\"" +
568          ", \"IsSociaalFonds\"" +
569          ", \"SociaalFonds\"" +
570          ", \"SociaalFonds#Id\"" +
571          ", \"SociaalFonds#ComponentId\"" +
572          ", \"IsWagenparkadministratie\"" +
573          ", \"Wagenparkadministratie\"" +
574          ", \"Wagenparkadministratie#Id\"" +
575          ", \"Wagenparkadministratie#ComponentId\"" +
576          ", \"IsLeverancier\"" +
577          ", \"Leverancier\"" +
578          ", \"Leverancier#Id\"" +
579          ", \"Leverancier#ComponentId\"" +
580          ", \"IsWagenparkAfnemer\"" +
581          ", \"WagenparkAfnemer\"" +
582          ", \"WagenparkAfnemer#Id\"" +
583          ", \"WagenparkAfnemer#ComponentId\"" +
584          ", \"IsEvenementadministratie\"" +
585          ", \"Evenementadministratie\"" +
586          ", \"Evenementadministratie#Id\"" +
587          ", \"Evenementadministratie#ComponentId\"" +
588          ", \"IsCrediteur\"" +
589          ", \"Crediteur\"" +
590          ", \"Crediteur#Id\"" +
591          ", \"Crediteur#ComponentId\"" +
592          ", \"IsFinancieleAdministratie\"" +
593          ", \"FinancieleAdministratie\"" +
594          ", \"FinancieleAdministratie#Id\"" +
595          ", \"FinancieleAdministratie#ComponentId\"" +
596          ", \"IsSociaalSecretariaat\"" +
597          ", \"SociaalSecretariaat\"" +
598          ", \"SociaalSecretariaat#Id\"" +
599          ", \"SociaalSecretariaat#ComponentId\"" +
600          ", \"IsBank\"" +
601          ", \"Bank\"" +
602          ", \"Bank#Id\"" +
603          ", \"Bank#ComponentId\"" +
604          ", \"IsWerkgever\"" +
605          ", \"Werkgever\"" +
606          ", \"Werkgever#Id\"" +
607          ", \"Werkgever#ComponentId\"" +
608          ", \"IsVerkoopadministratie\"" +
609          ", \"Verkoopadministratie\"" +
610          ", \"Verkoopadministratie#Id\"" +
611          ", \"Verkoopadministratie#ComponentId\"" +
612          ", \"IsInkoopadministratie\"" +
613          ", \"Inkoopadministratie\"" +
614          ", \"Inkoopadministratie#Id\"" +
615          ", \"Inkoopadministratie#ComponentId\"" +
616          ", \"IsSubsidient\"" +
617          ", \"Subsidient\"" +
618          ", \"Subsidient#Id\"" +
619          ", \"Subsidient#ComponentId\"" +
620          ", \"IsEnqueteadministratie\"" +
621          ", \"Enqueteadministratie\"" +
622          ", \"Enqueteadministratie#Id\"" +
623          ", \"Enqueteadministratie#ComponentId\"" +
624          ", \"XWiQaVjEbD041r7QN0kj2aKeCys_\"" +
625          ", \"X_TVE5FRBaQ97JJQbT7LmX4HBVY_\"" +
626          ", \"BrancheDescription\"" +
627          ", \"AdresDescription\"" +
628          ", \"PicMWY7oCqeiZMTdDqwFqi1U508_\"" +
629          ", \"ProfitDescription\"" +
630          ", \"TaalDescription\"" +
631          ", \"PostadresDescription\"" +
632          ", \"TitelEnAanhefDescription\"" +
633          ", \"RechtsvormDescription\"" +
634          ", \"LandVanVestigingDescription\"" +
635          ", \"AangebrachtDoorDescription\"" +
636          ", \"KFEDo6ZYK_ffNCeHuujBCshlPVs_\"" +
637          ", \"VerantwoordelijkeDescription\"" +
638          ", \"FunctionalState\"" +
639          ", \"KlantFinancieleAdministratie\"" +
640          ", \"KlantFinancieleAdministratie#Id\"" +
641          ", \"KlantFinancieleAdministratie#ComponentId\"" +
642          ", \"KlantVerkoopadministratie\"" +
643          ", \"KlantVerkoopadministratie#Id\"" +
644          ", \"KlantVerkoopadministratie#ComponentId\"" +
645          ", \"NQwaM_lfzxIm_JPrPhwruL0YOXY_\"" +
646          ", \"NQwaM_lfzxIm_JPrPhwruL0YOXY_#Id\"" +
647          ", \"NQwaM_lfzxIm_JPrPhwruL0YOXY_#ComponentId\"" +
648          ", \"uSf1yseW4YQ1K6EoHNlzCxPofm0_\"" +
649          ", \"uSf1yseW4YQ1K6EoHNlzCxPofm0_#Id\"" +
650          ", \"uSf1yseW4YQ1K6EoHNlzCxPofm0_#ComponentId\"" +
651          ", \"KlantEvenementadministratie\"" +
652          ", \"KlantEvenementadministratie#Id\"" +
653          ", \"KlantEvenementadministratie#ComponentId\"" +
654          ", \"KlantCursusadministratie\"" +
655          ", \"KlantCursusadministratie#Id\"" +
656          ", \"KlantCursusadministratie#ComponentId\"" +
657          ", \"KlantProspectadministratie\"" +
658          ", \"KlantProspectadministratie#Id\"" +
659          ", \"KlantProspectadministratie#ComponentId\"" +
660          ", \"KlantInkoopadministratie\"" +
661          ", \"KlantInkoopadministratie#Id\"" +
662          ", \"KlantInkoopadministratie#ComponentId\"" +
663          ", \"KlantProjectadministratie\"" +
664          ", \"KlantProjectadministratie#Id\"" +
665          ", \"KlantProjectadministratie#ComponentId\"" +
666          ", \"P0gBTGcrSbl2kK8BM4_24fIeMvk_\"" +
667          ", \"P0gBTGcrSbl2kK8BM4_24fIeMvk_#Id\"" +
668          ", \"P0gBTGcrSbl2kK8BM4_24fIeMvk_#ComponentId\"" +
669          ", \"KlantMain\"" +
670          ", \"KlantMain#Id\"" +
671          ", \"KlantMain#ComponentId\"" +
672          ", \"8awXARDcCdVtrvN6IRlwAk5UcrI_\"" +
673          ", \"8awXARDcCdVtrvN6IRlwAk5UcrI_#Id\"" +
674          ", \"8awXARDcCdVtrvN6IRlwAk5UcrI_#ComponentId\"" +
675          ", \"MjgFAhRfH64O3M9Ts_5b0ENQDBE_\"" +
676          ", \"MjgFAhRfH64O3M9Ts_5b0ENQDBE_#Id\"" +
677          ", \"MjgFAhRfH64O3M9Ts_5b0ENQDBE_#ComponentId\"" +
678          ", \"LeverancierMain\"" +
679          ", \"LeverancierMain#Id\"" +
680          ", \"LeverancierMain#ComponentId\"" +
681          ", \"2CaNQvGgtPNHP2XCsoKBQEpwmYA_\"" +
682          ", \"2CaNQvGgtPNHP2XCsoKBQEpwmYA_#Id\"" +
683          ", \"2CaNQvGgtPNHP2XCsoKBQEpwmYA_#ComponentId\"" +
684          ", \"kleo39GG1utTUtP0F15mWkXZBFQ_\"" +
685          ", \"kleo39GG1utTUtP0F15mWkXZBFQ_#Id\"" +
686          ", \"kleo39GG1utTUtP0F15mWkXZBFQ_#ComponentId\"" +
687          ", \"d9jEYARbghWBrZU6jKbtZPyZUAk_\"" +
688          ", \"d9jEYARbghWBrZU6jKbtZPyZUAk_#Id\"" +
689          ", \"d9jEYARbghWBrZU6jKbtZPyZUAk_#ComponentId\"" +
690          ", \"CrediteurMain\"" +
691          ", \"CrediteurMain#Id\"" +
692          ", \"CrediteurMain#ComponentId\"" +
693          ", \"TTStart\"" +
694          ", \"TTEnd\"" +
695          ", \"InstanceId\"" +
696          ", \"StartDate\"" +
697          ", \"EndDate\"" +
698          ", \"UserId\"" +
699          ", \"Id\"" +
700          " from \"OrganisatieQmo_Organisatie_QueryModelObjects_Imp\" WHERE (\"InstanceId\" = @1) AND ((\"StartDate\" IS NULL) AND (\"TTEnd\" IS NULL)) ORDER BY \"Id\" ASC NULLS FIRST OFFSET 0 ROWS FETCH NEXT 2 ROWS ONLY;";
701      const string Bug1285CreateStatement = @"
702  CREATE TEMP TABLE ""OrganisatieQmo_Organisatie_QueryModelObjects_Imp""
703  (
704    ""Id"" uuid NOT NULL,
705    ""InstanceId"" uuid,
706    ""UserId"" text,
707    ""StartDate"" timestamp(3) without time zone,
708    ""EndDate"" timestamp(3) without time zone,
709    ""TTStart"" timestamp(3) without time zone,
710    ""TTEnd"" timestamp(3) without time zone,
711    ""Afbeelding#Id"" uuid,
712    ""Afbeelding"" boolean,
713    ""Omschrijving"" character varying(250),
714    ""Website"" text,
715    ""EMailadres"" character varying(255),
716    ""SocialMediaVastleggen"" boolean,
717    ""Facebook"" text,
718    ""Linkedin"" text,
719    ""Twitter"" text,
720    ""Youtube"" text,
721    ""Branche#Id"" uuid,
722    ""Branche#ComponentId"" uuid,
723    ""Branche"" boolean,
724    ""Telefoonnummer"" character varying(18),
725    ""Overheidsidentificatienummer"" character varying(40),
726    ""Adres#Id"" uuid,
727    ""Adres#ComponentId"" uuid,
728    ""Adres"" boolean,
729    ""2gIKz62kaTdGxw82_OrzTc4ANSM_"" boolean,
730    ""OnderdeelVanOrganisatie#Id"" uuid,
731    ""OnderdeelVanOrganisatie#ComponentId"" uuid,
732    ""OnderdeelVanOrganisatie"" boolean,
733    ""Profit#Id"" uuid,
734    ""Profit#ComponentId"" uuid,
735    ""Profit"" boolean,
736    ""Taal#Id"" uuid,
737    ""Taal#ComponentId"" uuid,
738    ""Taal"" boolean,
739    ""KlantSinds"" timestamp(3) without time zone,
740    ""BarcodeKlant#BarcodeType"" uuid,
741    ""BarcodeKlant#Value"" text,
742    ""BarcodeKlant"" boolean,
743    ""Postadres#Id"" uuid,
744    ""Postadres#ComponentId"" uuid,
745    ""Postadres"" boolean,
746    ""LeverancierSinds"" timestamp(3) without time zone,
747    ""BarcodeLeverancier#BarcodeType"" uuid,
748    ""BarcodeLeverancier#Value"" text,
749    ""BarcodeLeverancier"" boolean,
750    ""Zoeknaam"" character varying(255),
751    ""TitelEnAanhef#Id"" uuid,
752    ""TitelEnAanhef#ComponentId"" uuid,
753    ""TitelEnAanhef"" boolean,
754    ""Rechtsvorm#Id"" uuid,
755    ""Rechtsvorm#ComponentId"" uuid,
756    ""Rechtsvorm"" boolean,
757    ""LandVanVestiging#Id"" uuid,
758    ""LandVanVestiging#ComponentId"" uuid,
759    ""LandVanVestiging"" boolean,
760    ""AantalMedewerkers"" character varying(50),
761    ""NaamStatutair"" character varying(255),
762    ""VestigingStatutair"" character varying(255),
763    ""Correspondentie"" boolean,
764    ""Medium"" character varying(255),
765    ""FiscaalNummer"" character varying(9),
766    ""AangebrachtDoor#Id"" uuid,
767    ""AangebrachtDoor#ComponentId"" uuid,
768    ""AangebrachtDoor"" boolean,
769    ""Status"" character varying(255),
770    ""NummerKamerVanKoophandel"" character varying(30),
771    ""zII9SOHbwUPS_jKSlcRrQzuEr6A_"" timestamp(3) without time zone,
772    ""Code"" character varying(255),
773    ""OrganisatorischeEenheid#Id"" uuid,
774    ""OrganisatorischeEenheid#ComponentId"" uuid,
775    ""OrganisatorischeEenheid"" boolean,
776    ""PJlr3asVdeHVoqmAyHIF2fF1gVM_"" uuid,
777    ""IsUwv"" boolean,
778    ""Uwv#Id"" uuid,
779    ""Uwv#ComponentId"" uuid,
780    ""Uwv"" boolean,
781    ""IsVerzekeraarVoorWerkgever"" boolean,
782    ""VerzekeraarVoorWerkgever#Id"" uuid,
783    ""VerzekeraarVoorWerkgever#ComponentId"" uuid,
784    ""VerzekeraarVoorWerkgever"" boolean,
785    ""IsAbonnementsadministratie"" boolean,
786    ""Abonnementsadministratie#Id"" uuid,
787    ""Abonnementsadministratie#ComponentId"" uuid,
788    ""Abonnementsadministratie"" boolean,
789    ""IsPensioenfonds"" boolean,
790    ""Pensioenfonds#Id"" uuid,
791    ""Pensioenfonds#ComponentId"" uuid,
792    ""Pensioenfonds"" boolean,
793    ""IsProfit"" boolean,
794    ""Profit1#Id"" uuid,
795    ""Profit1#ComponentId"" uuid,
796    ""Profit1"" boolean,
797    ""Verantwoordelijke#Id"" uuid,
798    ""Verantwoordelijke#ComponentId"" uuid,
799    ""Verantwoordelijke"" boolean,
800    ""IsKlant"" boolean,
801    ""Klant#Id"" uuid,
802    ""Klant#ComponentId"" uuid,
803    ""Klant"" boolean,
804    ""IsFactureringsadministratie"" boolean,
805    ""Factureringsadministratie#Id"" uuid,
806    ""Factureringsadministratie#ComponentId"" uuid,
807    ""Factureringsadministratie"" boolean,
808    ""IsLeninggever"" boolean,
809    ""Leninggever#Id"" uuid,
810    ""Leninggever#ComponentId"" uuid,
811    ""Leninggever"" boolean,
812    ""IsProjectadministratie"" boolean,
813    ""Projectadministratie#Id"" uuid,
814    ""Projectadministratie#ComponentId"" uuid,
815    ""Projectadministratie"" boolean,
816    ""IsVervangingsfonds"" boolean,
817    ""Vervangingsfonds#Id"" uuid,
818    ""Vervangingsfonds#ComponentId"" uuid,
819    ""Vervangingsfonds"" boolean,
820    ""IsPensioen"" boolean,
821    ""Pensioen#Id"" uuid,
822    ""Pensioen#ComponentId"" uuid,
823    ""Pensioen"" boolean,
824    ""IsVasteActivaAdministratie"" boolean,
825    ""VasteActivaAdministratie#Id"" uuid,
826    ""VasteActivaAdministratie#ComponentId"" uuid,
827    ""VasteActivaAdministratie"" boolean,
828    ""IsBelastingdienst"" boolean,
829    ""Belastingdienst#Id"" uuid,
830    ""Belastingdienst#ComponentId"" uuid,
831    ""Belastingdienst"" boolean,
832    ""IsCursusadministratie"" boolean,
833    ""Cursusadministratie#Id"" uuid,
834    ""Cursusadministratie#ComponentId"" uuid,
835    ""Cursusadministratie"" boolean,
836    ""IsUitvoerderVervangingsfonds"" boolean,
837    ""UitvoerderVervangingsfonds#Id"" uuid,
838    ""UitvoerderVervangingsfonds#ComponentId"" uuid,
839    ""UitvoerderVervangingsfonds"" boolean,
840    ""IsAssemblageadministratie"" boolean,
841    ""Assemblageadministratie#Id"" uuid,
842    ""Assemblageadministratie#ComponentId"" uuid,
843    ""Assemblageadministratie"" boolean,
844    ""IsLeasemaatschappij"" boolean,
845    ""Leasemaatschappij#Id"" uuid,
846    ""Leasemaatschappij#ComponentId"" uuid,
847    ""Leasemaatschappij"" boolean,
848    ""IsBeslaglegger"" boolean,
849    ""Beslaglegger#Id"" uuid,
850    ""Beslaglegger#ComponentId"" uuid,
851    ""Beslaglegger"" boolean,
852    ""IsVerzekeraarVoorMedewerker"" boolean,
853    ""VerzekeraarVoorMedewerker#Id"" uuid,
854    ""VerzekeraarVoorMedewerker#ComponentId"" uuid,
855    ""VerzekeraarVoorMedewerker"" boolean,
856    ""IsWoningverhuur"" boolean,
857    ""Woningverhuur#Id"" uuid,
858    ""Woningverhuur#ComponentId"" uuid,
859    ""Woningverhuur"" boolean,
860    ""9cSTu7fkjOZm08FFQUHvclQHSWY_"" boolean,
861    ""Goederenstroomadministratie#Id"" uuid,
862    ""Goederenstroomadministratie#ComponentId"" uuid,
863    ""Goederenstroomadministratie"" boolean,
864    ""IsConcurrent"" boolean,
865    ""Concurrent#Id"" uuid,
866    ""Concurrent#ComponentId"" uuid,
867    ""Concurrent"" boolean,
868    ""IsArbodienst"" boolean,
869    ""Arbodienst#Id"" uuid,
870    ""Arbodienst#ComponentId"" uuid,
871    ""Arbodienst"" boolean,
872    ""IsUitvoerderSociaalFonds"" boolean,
873    ""UitvoerderSociaalFonds#Id"" uuid,
874    ""UitvoerderSociaalFonds#ComponentId"" uuid,
875    ""UitvoerderSociaalFonds"" boolean,
876    ""IsPensioenuitvoerder"" boolean,
877    ""Pensioenuitvoerder#Id"" uuid,
878    ""Pensioenuitvoerder#ComponentId"" uuid,
879    ""Pensioenuitvoerder"" boolean,
880    ""IsProspect"" boolean,
881    ""Prospect#Id"" uuid,
882    ""Prospect#ComponentId"" uuid,
883    ""Prospect"" boolean,
884    ""IsProspectadministratie"" boolean,
885    ""Prospectadministratie#Id"" uuid,
886    ""Prospectadministratie#ComponentId"" uuid,
887    ""Prospectadministratie"" boolean,
888    ""IsArtikelbeheeradministratie"" boolean,
889    ""Artikelbeheeradministratie#Id"" uuid,
890    ""Artikelbeheeradministratie#ComponentId"" uuid,
891    ""Artikelbeheeradministratie"" boolean,
892    ""v1J4Rq2eNZy9GBvGhuCBKqga0Rg_"" boolean,
893    ""g4i3gYZGL0yu0T6UwmiZTaUDI8Y_#Id"" uuid,
894    ""g4i3gYZGL0yu0T6UwmiZTaUDI8Y_#ComponentId"" uuid,
895    ""g4i3gYZGL0yu0T6UwmiZTaUDI8Y_"" boolean,
896    ""IsSociaalFonds"" boolean,
897    ""SociaalFonds#Id"" uuid,
898    ""SociaalFonds#ComponentId"" uuid,
899    ""SociaalFonds"" boolean,
900    ""IsWagenparkadministratie"" boolean,
901    ""Wagenparkadministratie#Id"" uuid,
902    ""Wagenparkadministratie#ComponentId"" uuid,
903    ""Wagenparkadministratie"" boolean,
904    ""IsLeverancier"" boolean,
905    ""Leverancier#Id"" uuid,
906    ""Leverancier#ComponentId"" uuid,
907    ""Leverancier"" boolean,
908    ""IsWagenparkAfnemer"" boolean,
909    ""WagenparkAfnemer#Id"" uuid,
910    ""WagenparkAfnemer#ComponentId"" uuid,
911    ""WagenparkAfnemer"" boolean,
912    ""IsEvenementadministratie"" boolean,
913    ""Evenementadministratie#Id"" uuid,
914    ""Evenementadministratie#ComponentId"" uuid,
915    ""Evenementadministratie"" boolean,
916    ""IsCrediteur"" boolean,
917    ""Crediteur#Id"" uuid,
918    ""Crediteur#ComponentId"" uuid,
919    ""Crediteur"" boolean,
920    ""IsFinancieleAdministratie"" boolean,
921    ""FinancieleAdministratie#Id"" uuid,
922    ""FinancieleAdministratie#ComponentId"" uuid,
923    ""FinancieleAdministratie"" boolean,
924    ""IsSociaalSecretariaat"" boolean,
925    ""SociaalSecretariaat#Id"" uuid,
926    ""SociaalSecretariaat#ComponentId"" uuid,
927    ""SociaalSecretariaat"" boolean,
928    ""IsBank"" boolean,
929    ""Bank#Id"" uuid,
930    ""Bank#ComponentId"" uuid,
931    ""Bank"" boolean,
932    ""IsWerkgever"" boolean,
933    ""Werkgever#Id"" uuid,
934    ""Werkgever#ComponentId"" uuid,
935    ""Werkgever"" boolean,
936    ""IsVerkoopadministratie"" boolean,
937    ""Verkoopadministratie#Id"" uuid,
938    ""Verkoopadministratie#ComponentId"" uuid,
939    ""Verkoopadministratie"" boolean,
940    ""IsInkoopadministratie"" boolean,
941    ""Inkoopadministratie#Id"" uuid,
942    ""Inkoopadministratie#ComponentId"" uuid,
943    ""Inkoopadministratie"" boolean,
944    ""IsSubsidient"" boolean,
945    ""Subsidient#Id"" uuid,
946    ""Subsidient#ComponentId"" uuid,
947    ""Subsidient"" boolean,
948    ""IsEnqueteadministratie"" boolean,
949    ""Enqueteadministratie#Id"" uuid,
950    ""Enqueteadministratie#ComponentId"" uuid,
951    ""Enqueteadministratie"" boolean,
952    ""XWiQaVjEbD041r7QN0kj2aKeCys_"" boolean,
953    ""X_TVE5FRBaQ97JJQbT7LmX4HBVY_"" boolean,
954    ""BrancheDescription"" character varying(250),
955    ""AdresDescription"" character varying(250),
956    ""PicMWY7oCqeiZMTdDqwFqi1U508_"" character varying(250),
957    ""ProfitDescription"" character varying(100),
958    ""TaalDescription"" character varying(250),
959    ""PostadresDescription"" character varying(250),
960    ""TitelEnAanhefDescription"" character varying(250),
961    ""RechtsvormDescription"" character varying(250),
962    ""LandVanVestigingDescription"" character varying(250),
963    ""AangebrachtDoorDescription"" character varying(250),
964    ""KFEDo6ZYK_ffNCeHuujBCshlPVs_"" character varying(250),
965    ""VerantwoordelijkeDescription"" character varying(250),
966    ""FunctionalState"" integer,
967    ""KlantFinancieleAdministratie#Id"" uuid,
968    ""KlantFinancieleAdministratie#ComponentId"" uuid,
969    ""KlantFinancieleAdministratie"" boolean,
970    ""KlantVerkoopadministratie#Id"" uuid,
971    ""KlantVerkoopadministratie#ComponentId"" uuid,
972    ""KlantVerkoopadministratie"" boolean,
973    ""NQwaM_lfzxIm_JPrPhwruL0YOXY_#Id"" uuid,
974    ""NQwaM_lfzxIm_JPrPhwruL0YOXY_#ComponentId"" uuid,
975    ""NQwaM_lfzxIm_JPrPhwruL0YOXY_"" boolean,
976    ""uSf1yseW4YQ1K6EoHNlzCxPofm0_#Id"" uuid,
977    ""uSf1yseW4YQ1K6EoHNlzCxPofm0_#ComponentId"" uuid,
978    ""uSf1yseW4YQ1K6EoHNlzCxPofm0_"" boolean,
979    ""KlantEvenementadministratie#Id"" uuid,
980    ""KlantEvenementadministratie#ComponentId"" uuid,
981    ""KlantEvenementadministratie"" boolean,
982    ""KlantCursusadministratie#Id"" uuid,
983    ""KlantCursusadministratie#ComponentId"" uuid,
984    ""KlantCursusadministratie"" boolean,
985    ""KlantProspectadministratie#Id"" uuid,
986    ""KlantProspectadministratie#ComponentId"" uuid,
987    ""KlantProspectadministratie"" boolean,
988    ""KlantInkoopadministratie#Id"" uuid,
989    ""KlantInkoopadministratie#ComponentId"" uuid,
990    ""KlantInkoopadministratie"" boolean,
991    ""KlantProjectadministratie#Id"" uuid,
992    ""KlantProjectadministratie#ComponentId"" uuid,
993    ""KlantProjectadministratie"" boolean,
994    ""P0gBTGcrSbl2kK8BM4_24fIeMvk_#Id"" uuid,
995    ""P0gBTGcrSbl2kK8BM4_24fIeMvk_#ComponentId"" uuid,
996    ""P0gBTGcrSbl2kK8BM4_24fIeMvk_"" boolean,
997    ""KlantMain#Id"" uuid,
998    ""KlantMain#ComponentId"" uuid,
999    ""KlantMain"" boolean,
1000    ""8awXARDcCdVtrvN6IRlwAk5UcrI_#Id"" uuid,
1001    ""8awXARDcCdVtrvN6IRlwAk5UcrI_#ComponentId"" uuid,
1002    ""8awXARDcCdVtrvN6IRlwAk5UcrI_"" boolean,
1003    ""MjgFAhRfH64O3M9Ts_5b0ENQDBE_#Id"" uuid,
1004    ""MjgFAhRfH64O3M9Ts_5b0ENQDBE_#ComponentId"" uuid,
1005    ""MjgFAhRfH64O3M9Ts_5b0ENQDBE_"" boolean,
1006    ""LeverancierMain#Id"" uuid,
1007    ""LeverancierMain#ComponentId"" uuid,
1008    ""LeverancierMain"" boolean,
1009    ""2CaNQvGgtPNHP2XCsoKBQEpwmYA_#Id"" uuid,
1010    ""2CaNQvGgtPNHP2XCsoKBQEpwmYA_#ComponentId"" uuid,
1011    ""2CaNQvGgtPNHP2XCsoKBQEpwmYA_"" boolean,
1012    ""kleo39GG1utTUtP0F15mWkXZBFQ_#Id"" uuid,
1013    ""kleo39GG1utTUtP0F15mWkXZBFQ_#ComponentId"" uuid,
1014    ""kleo39GG1utTUtP0F15mWkXZBFQ_"" boolean,
1015    ""d9jEYARbghWBrZU6jKbtZPyZUAk_#Id"" uuid,
1016    ""d9jEYARbghWBrZU6jKbtZPyZUAk_#ComponentId"" uuid,
1017    ""d9jEYARbghWBrZU6jKbtZPyZUAk_"" boolean,
1018    ""CrediteurMain#Id"" uuid,
1019    ""CrediteurMain#ComponentId"" uuid,
1020    ""CrediteurMain"" boolean,
1021    CONSTRAINT ""pk_OrganisatieQmo_Organisatie_QueryModelObjects_Imp"" PRIMARY KEY (""Id"")
1022  )";
1023      #endregion Bug1285
1024      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2849")]
1025      public async Task Chunked_string_write_buffer_encoding_space()
1026      {
1027          await using var dataSource = CreateDataSource(csb => csb.WriteBufferSize = 8192);
1028          await using var conn = await dataSource.OpenConnectionAsync();
1029          var tableName = await CreateTempTable(conn, "col1 text, col2 text");
1030          await using var binaryImporter = await conn.BeginBinaryImportAsync($"COPY {tableName} FROM STDIN (FORMAT BINARY);");
1031          await binaryImporter.StartRowAsync();
1032          var almostBufferFillingString = new string('a', 8152);
1033          await binaryImporter.WriteAsync(almostBufferFillingString, NpgsqlDbType.Text);
1034          var unicodeCharacterThatEncodesToThreeBytesInUtf8 = '\uD55C';
1035          var longStringStartingWithAforementionedUnicodeCharacter = unicodeCharacterThatEncodesToThreeBytesInUtf8 + new string('a', 10000);
1036          await binaryImporter.WriteAsync(longStringStartingWithAforementionedUnicodeCharacter, NpgsqlDbType.Text);
1037          await binaryImporter.CompleteAsync();
1038      }
1039      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2849")]
1040      public async Task Chunked_char_array_write_buffer_encoding_space()
1041      {
1042          await using var dataSource = CreateDataSource(csb => csb.WriteBufferSize = 8192);
1043          await using var conn = await dataSource.OpenConnectionAsync();
1044          var tableName = await CreateTempTable(conn, "col1 text, col2 text");
1045          await using var binaryImporter = await conn.BeginBinaryImportAsync($"COPY {tableName} FROM STDIN (FORMAT BINARY);");
1046          await binaryImporter.StartRowAsync();
1047          var almostBufferFillingString = new string('a', 8152);
1048          await binaryImporter.WriteAsync(almostBufferFillingString, NpgsqlDbType.Text);
1049          var unicodeCharacterThatEncodesToThreeBytesInUtf8 = '\uD55C';
1050          var longStringStartingWithAforementionedUnicodeCharacter = unicodeCharacterThatEncodesToThreeBytesInUtf8 + new string('a', 10000);
1051          await binaryImporter.WriteAsync(longStringStartingWithAforementionedUnicodeCharacter.ToCharArray(), NpgsqlDbType.Text);
1052          await binaryImporter.CompleteAsync();
1053      }
1054      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2371")]
1055      public async Task NRE_in_BeginTextExport()
1056      {
1057          await using var conn = await OpenConnectionAsync();
1058          var funcName = await GetTempFunctionName(conn);
1059          await using var transaction = await conn.BeginTransactionAsync();
1060          await conn.ExecuteNonQueryAsync($"CREATE OR REPLACE FUNCTION {funcName}() RETURNS TABLE (i INT) AS $$ BEGIN RETURN QUERY SELECT s.a FROM pg_stat_activity p; end; $$ LANGUAGE plpgsql;");
1061          using var reader = await conn.BeginTextExportAsync($"copy (select * FROM {funcName}())  TO STDOUT WITH (format csv)");
1062          Assert.That(() => reader.ReadLine(), Throws.Exception
1063              .TypeOf<PostgresException>()
1064              .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.UndefinedTable)
1065          );
1066      }
1067      public enum TestEnum
1068      {
1069          One,
1070          Two
1071      }
1072      class SomeComposite
1073      {
1074          public TestEnum Test { get; set; }
1075          public int X { get; set; }
1076          public string SomeText { get; set; } = "";
1077      }
1078      [Test]
1079      public async Task CompositePostgresType()
1080      {
1081          await using var adminConnection = await OpenConnectionAsync();
1082          var type = await GetTempTypeName(adminConnection);
1083          var func = await GetTempFunctionName(adminConnection);
1084          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} as (x int, some_text text, test int)");
1085          var dataSourceBuilder = CreateDataSourceBuilder();
1086          dataSourceBuilder.MapComposite<SomeComposite>(type);
1087          await using var dataSource = dataSourceBuilder.Build();
1088          await using var connection = await dataSource.OpenConnectionAsync();
1089          await connection.ExecuteNonQueryAsync(@$"
1090  CREATE OR REPLACE FUNCTION {func}(id int, out comp1 {type}, OUT comp2 {type}[])
1091  LANGUAGE plpgsql AS
1092  $$
1093  BEGIN
1094      comp1 = ROW(9, 'bar', 1)::{type};
1095      comp2 = ARRAY[ROW(9, 'bar', 1)::{type}];
1096  END;
1097  $$;");
1098          Assert.ThrowsAsync<InvalidCastException>(async () => await connection.ExecuteScalarAsync($"SELECT {func}(0)"));
1099      }
1100      [Test]
1101      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3117")]
1102      public void Bug3117()
1103      {
1104          const string OkCommand = "SELECT 1";
1105          const string ErrorCommand = "SELECT * FROM public.imnotexist";
1106          using var dataSource = CreateDataSource();
1107          using (var conn = dataSource.OpenConnection())
1108          {
1109              var okCommand = new NpgsqlCommand(OkCommand, conn);
1110              okCommand.Prepare();
1111              using (okCommand.ExecuteReader()) { }
1112              var errorCommand = new NpgsqlCommand(ErrorCommand, conn);
1113              Assert.That(() => errorCommand.Prepare(), Throws.Exception
1114                  .TypeOf<PostgresException>()
1115                  .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.UndefinedTable));
1116          }
1117          using (var conn = dataSource.OpenConnection())
1118          {
1119              var okCommand = new NpgsqlCommand(OkCommand, conn);
1120              okCommand.Prepare();
1121              using (okCommand.ExecuteReader()) { }
1122          }
1123      }
1124      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3209")]
1125      public async Task Bug3209()
1126      {
1127          await using var conn = CreateConnection();
1128          await conn.CloseAsync();
1129          await conn.OpenAsync();
1130          await conn.CloseAsync();
1131          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
1132      }
1133      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3373")]
1134      public async Task Bug3373()
1135      {
1136          await using var conn = await OpenConnectionAsync();
1137          using var cmd = conn.CreateCommand();
1138          cmd.CommandText = "SELECT repeat('1', 10000); SELECT * from pg_sleep(3)";
1139          cmd.CommandTimeout = 0;
1140          await using var reader = await cmd.ExecuteReaderAsync();
1141          Assert.DoesNotThrowAsync(async () => await reader.NextResultAsync());
1142      }
1143      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3649")]
1144      public async Task Bug3649()
1145      {
1146          await using var conn = await OpenConnectionAsync();
1147          var table = await CreateTempTable(conn, "value integer");
1148          using (var importer = await conn.BeginBinaryImportAsync($"COPY {table} (value) FROM STDIN (FORMAT binary)"))
1149          {
1150              await importer.StartRowAsync();
1151              await importer.WriteAsync(DBNull.Value, NpgsqlDbType.Integer);
1152              await importer.StartRowAsync();
1153              await importer.WriteAsync(1, NpgsqlDbType.Integer);
1154              await importer.StartRowAsync();
1155              await importer.WriteAsync(2, NpgsqlDbType.Integer);
1156              await importer.CompleteAsync();
1157          }
1158          using (var exporter = await conn.BeginBinaryExportAsync($"COPY {table} (value) TO STDIN (FORMAT binary)"))
1159          {
1160              await exporter.StartRowAsync();
1161              Assert.IsTrue(exporter.IsNull);
1162              await exporter.SkipAsync();
1163              await exporter.StartRowAsync();
1164              Assert.AreEqual(1, await exporter.ReadAsync<int?>());
1165              await exporter.StartRowAsync();
1166              Assert.AreEqual(2, await exporter.ReadAsync<int?>());
1167          }
1168      }
1169      [Test]
1170      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3839")]
1171      public async Task SingleThreadedSynchronizationContext_deadlock()
1172      {
1173          var syncContext = new SingleThreadSynchronizationContext(nameof(SingleThreadedSynchronizationContext_deadlock));
1174          using (var _ = syncContext.Enter())
1175          {
1176              await Task.Yield();
1177              using var connection = OpenConnection();
1178              var data = new string('x', 5_000_000);
1179              using var cmd = new NpgsqlCommand("SELECT generate_series(1, 500000); SELECT @p", connection);
1180              cmd.Parameters.AddWithValue("p", NpgsqlDbType.Text, data);
1181              cmd.ExecuteNonQuery();
1182          }
1183          await Task.Yield();
1184      }
1185      [Test]
1186      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3924")]
1187      public async Task Bug3924()
1188      {
1189          var csb = new NpgsqlConnectionStringBuilder(ConnectionString)
1190          {
1191              CommandTimeout = 10,
1192              KeepAlive = 5,
1193          };
1194          await using var postmaster = PgPostmasterMock.Start(csb.ConnectionString);
1195          await using var dataSource = CreateDataSource(postmaster.ConnectionString);
1196          await using var conn = await dataSource.OpenConnectionAsync();
1197          var serverMock = await postmaster.WaitForServerConnection();
1198          using (var cmd = conn.CreateCommand())
1199          {
1200              cmd.CommandTimeout = 1;
1201              cmd.CommandText = "SELECT 1";
1202              var queryTask = cmd.ExecuteNonQueryAsync();
1203              await serverMock.ExpectExtendedQuery();
1204              _ = serverMock.WriteScalarResponseAndFlush(1);
1205              await queryTask;
1206          }
1207          await serverMock.ExpectMessage(FrontendMessageCode.Sync);
1208          await Task.Delay(1000);
1209          _ = serverMock.WriteReadyForQuery().FlushAsync();
1210          using (var cmd = conn.CreateCommand())
1211          {
1212              cmd.CommandTimeout = 1;
1213              cmd.CommandText = "SELECT 1";
1214              var queryTask = cmd.ExecuteNonQueryAsync();
1215              await serverMock.ExpectExtendedQuery();
1216              _ = serverMock.WriteScalarResponseAndFlush(1);
1217              Assert.DoesNotThrowAsync(async () => await queryTask);
1218          }
1219      }
1220      [Test]
1221      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4099")]
1222      public async Task Bug4099()
1223      {
1224          var csb = new NpgsqlConnectionStringBuilder(ConnectionString)
1225          {
1226              Multiplexing = true,
1227              MaxPoolSize = 1
1228          };
1229          await using var postmaster = PgPostmasterMock.Start(csb.ConnectionString);
1230          await using var dataSource = CreateDataSource(postmaster.ConnectionString);
1231          await using var firstConn = await dataSource.OpenConnectionAsync();
1232          await using var secondConn = await dataSource.OpenConnectionAsync();
1233          var firstQuery = firstConn.ExecuteScalarAsync("SELECT data");
1234          var server = await postmaster.WaitForServerConnection();
1235          await server.ExpectExtendedQuery();
1236          var secondQuery = secondConn.ExecuteScalarAsync("SELECT other_data");
1237          await server.ExpectExtendedQuery();
1238          var data = new byte[10000];
1239          await server
1240              .WriteParseComplete()
1241              .WriteBindComplete()
1242              .WriteRowDescription(new FieldDescription(PostgresTypeOIDs.Bytea))
1243              .WriteDataRowWithFlush(data);
1244          var otherData = new byte[10];
1245          await server
1246              .WriteCommandComplete()
1247              .WriteReadyForQuery()
1248              .WriteParseComplete()
1249              .WriteBindComplete()
1250              .WriteRowDescription(new FieldDescription(PostgresTypeOIDs.Bytea))
1251              .WriteDataRow(otherData)
1252              .WriteCommandComplete()
1253              .WriteReadyForQuery()
1254              .FlushAsync();
1255          Assert.That(data, Is.EquivalentTo((byte[])(await firstQuery)!));
1256          Assert.That(otherData, Is.EquivalentTo((byte[])(await secondQuery)!));
1257      }
1258      [Test]
1259      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4123")]
1260      public async Task Bug4123()
1261      {
1262          await using var conn = await OpenConnectionAsync();
1263          await using var cmd = new NpgsqlCommand("SELECT 1", conn);
1264          await using var rdr = await cmd.ExecuteReaderAsync();
1265          await rdr.ReadAsync();
1266          await using var stream = await rdr.GetStreamAsync(0);
1267          Assert.DoesNotThrowAsync(stream.FlushAsync);
1268          Assert.DoesNotThrow(stream.Flush);
1269      }
1270  }
</code></pre>
        </div>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-MultipleHostsTests.cs</h3>
            <pre><code>1  using Npgsql.Internal;
2  using Npgsql.Tests.Support;
3  using NUnit.Framework;
4  using System;
5  using System.Collections.Generic;
6  using System.Data;
7  using System.IO;
8  using System.Linq;
9  using System.Net;
10  using System.Net.Sockets;
11  using System.Runtime.InteropServices;
12  using System.Threading;
13  using System.Threading.Tasks;
14  using System.Transactions;
15  using Npgsql.Properties;
16  using static Npgsql.Tests.Support.MockState;
17  using static Npgsql.Tests.TestUtil;
18  using IsolationLevel = System.Transactions.IsolationLevel;
19  using TransactionStatus = Npgsql.Internal.TransactionStatus;
20  namespace Npgsql.Tests;
21  public class MultipleHostsTests : TestBase
22  {
23      static readonly object[] MyCases =
24      {
25          new object[] { TargetSessionAttributes.Standby,        new[] { Primary,         Standby         }, 1 },
26          new object[] { TargetSessionAttributes.Standby,        new[] { PrimaryReadOnly, Standby         }, 1 },
27          new object[] { TargetSessionAttributes.PreferStandby,  new[] { Primary,         Standby         }, 1 },
28          new object[] { TargetSessionAttributes.PreferStandby,  new[] { PrimaryReadOnly, Standby         }, 1 },
29          new object[] { TargetSessionAttributes.PreferStandby,  new[] { Primary,         Primary         }, 0 },
30          new object[] { TargetSessionAttributes.Primary,        new[] { Standby,         Primary         }, 1 },
31          new object[] { TargetSessionAttributes.Primary,        new[] { Standby,         PrimaryReadOnly }, 1 },
32          new object[] { TargetSessionAttributes.PreferPrimary,  new[] { Standby,         Primary         }, 1 },
33          new object[] { TargetSessionAttributes.PreferPrimary,  new[] { Standby,         PrimaryReadOnly }, 1 },
34          new object[] { TargetSessionAttributes.PreferPrimary,  new[] { Standby,         Standby         }, 0 },
35          new object[] { TargetSessionAttributes.Any,            new[] { Standby,         Primary         }, 0 },
36          new object[] { TargetSessionAttributes.Any,            new[] { Primary,         Standby         }, 0 },
37          new object[] { TargetSessionAttributes.Any,            new[] { PrimaryReadOnly, Standby         }, 0 },
38          new object[] { TargetSessionAttributes.ReadWrite,      new[] { Standby,         Primary         }, 1 },
39          new object[] { TargetSessionAttributes.ReadWrite,      new[] { PrimaryReadOnly, Primary         }, 1 },
40          new object[] { TargetSessionAttributes.ReadOnly,       new[] { Primary,         Standby         }, 1 },
41          new object[] { TargetSessionAttributes.ReadOnly,       new[] { PrimaryReadOnly, Standby         }, 0 }
42      };
43      [Test]
44      [TestCaseSource(nameof(MyCases))]
45      public async Task Connect_to_correct_host_pooled(TargetSessionAttributes targetSessionAttributes, MockState[] servers, int expectedServer)
46      {
47          var postmasters = servers.Select(s => PgPostmasterMock.Start(state: s)).ToArray();
48          await using var __ = new DisposableWrapper(postmasters);
49          var connectionStringBuilder = new NpgsqlConnectionStringBuilder
50          {
51              Host = MultipleHosts(postmasters),
52              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
53              Pooling = true
54          };
55          await using var dataSource = new NpgsqlDataSourceBuilder(connectionStringBuilder.ConnectionString)
56              .BuildMultiHost();
57          await using var conn = await dataSource.OpenConnectionAsync(targetSessionAttributes);
58          Assert.That(conn.Port, Is.EqualTo(postmasters[expectedServer].Port));
59          for (var i = 0; i <= expectedServer; i++)
60              _ = await postmasters[i].WaitForServerConnection();
61      }
62      [Test]
63      [TestCaseSource(nameof(MyCases))]
64      public async Task Connect_to_correct_host_unpooled(TargetSessionAttributes targetSessionAttributes, MockState[] servers, int expectedServer)
65      {
66          var postmasters = servers.Select(s => PgPostmasterMock.Start(state: s)).ToArray();
67          await using var __ = new DisposableWrapper(postmasters);
68          var connectionStringBuilder = new NpgsqlConnectionStringBuilder
69          {
70              Host = MultipleHosts(postmasters),
71              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
72              Pooling = false
73          };
74          await using var dataSource = new NpgsqlDataSourceBuilder(connectionStringBuilder.ConnectionString)
75              .BuildMultiHost();
76          await using var conn = await dataSource.OpenConnectionAsync(targetSessionAttributes);
77          Assert.That(conn.Port, Is.EqualTo(postmasters[expectedServer].Port));
78          for (var i = 0; i <= expectedServer; i++)
79              _ = await postmasters[i].WaitForServerConnection();
80      }
81      [Test]
82      [TestCaseSource(nameof(MyCases))]
83      public async Task Connect_to_correct_host_with_available_idle(
84          TargetSessionAttributes targetSessionAttributes, MockState[] servers, int expectedServer)
85      {
86          var postmasters = servers.Select(s => PgPostmasterMock.Start(state: s)).ToArray();
87          await using var __ = new DisposableWrapper(postmasters);
88          var connectionStringBuilder = new NpgsqlConnectionStringBuilder
89          {
90              Host = MultipleHosts(postmasters),
91              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
92          };
93          await using var dataSource = new NpgsqlDataSourceBuilder(connectionStringBuilder.ConnectionString)
94              .BuildMultiHost();
95          var idleConnTargetSessionAttributes = servers[0] switch
96          {
97              Primary => TargetSessionAttributes.ReadWrite,
98              PrimaryReadOnly => TargetSessionAttributes.ReadOnly,
99              Standby => TargetSessionAttributes.Standby,
100              _ => throw new ArgumentOutOfRangeException()
101          };
102          await using (_ = await dataSource.OpenConnectionAsync(idleConnTargetSessionAttributes))
103          {
104          }
105          await using var conn = await dataSource.OpenConnectionAsync(targetSessionAttributes);
106          Assert.That(conn.Port, Is.EqualTo(postmasters[expectedServer].Port));
107          for (var i = 0; i <= expectedServer; i++)
108              _ = await postmasters[i].WaitForServerConnection();
109      }
110      [Test]
111      [TestCase(TargetSessionAttributes.Standby,   new[] { Primary,         Primary })]
112      [TestCase(TargetSessionAttributes.Primary,   new[] { Standby,         Standby })]
113      [TestCase(TargetSessionAttributes.ReadWrite, new[] { PrimaryReadOnly, Standby })]
114      [TestCase(TargetSessionAttributes.ReadOnly,  new[] { Primary,         Primary })]
115      public async Task Valid_host_not_found(TargetSessionAttributes targetSessionAttributes, MockState[] servers)
116      {
117          var postmasters = servers.Select(s => PgPostmasterMock.Start(state: s)).ToArray();
118          await using var __ = new DisposableWrapper(postmasters);
119          var connectionStringBuilder = new NpgsqlConnectionStringBuilder
120          {
121              Host = MultipleHosts(postmasters),
122              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
123          };
124          await using var dataSource = new NpgsqlDataSourceBuilder(connectionStringBuilder.ConnectionString)
125              .BuildMultiHost();
126          var exception = Assert.ThrowsAsync<NpgsqlException>(async () => await dataSource.OpenConnectionAsync(targetSessionAttributes))!;
127          Assert.That(exception.Message, Is.EqualTo("No suitable host was found."));
128          Assert.That(exception.InnerException, Is.Null);
129          for (var i = 0; i < servers.Length; i++)
130              _ = await postmasters[i].WaitForServerConnection();
131      }
132      [Test, Platform(Exclude = "MacOsX", Reason = "#3786")]
133      public void All_hosts_are_down()
134      {
135          if (RuntimeInformation.FrameworkDescription.StartsWith(".NET Core 3.1"))
136              return;
137          var endpoint = new IPEndPoint(IPAddress.Loopback, 0);
138          using var socket1 = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
139          socket1.Bind(endpoint);
140          var localEndPoint1 = (IPEndPoint)socket1.LocalEndPoint!;
141          using var socket2 = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
142          socket2.Bind(endpoint);
143          var localEndPoint2 = (IPEndPoint)socket2.LocalEndPoint!;
144          var connectionString = new NpgsqlConnectionStringBuilder
145          {
146              Host = $"{localEndPoint1.Address}:{localEndPoint1.Port},{localEndPoint2.Address}:{localEndPoint2.Port}"
147          }.ConnectionString;
148          using var dataSource = new NpgsqlDataSourceBuilder(connectionString).BuildMultiHost();
149          var exception = Assert.ThrowsAsync<NpgsqlException>(async () => await dataSource.OpenConnectionAsync(TargetSessionAttributes.Any))!;
150          var aggregateException = (AggregateException)exception.InnerException!;
151          Assert.That(aggregateException.InnerExceptions, Has.Count.EqualTo(2));
152          for (var i = 0; i < aggregateException.InnerExceptions.Count; i++)
153          {
154              Assert.That(aggregateException.InnerExceptions[i], Is.TypeOf<NpgsqlException>()
155                  .With.InnerException.TypeOf<SocketException>()
156                  .With.InnerException.Property(nameof(SocketException.SocketErrorCode)).EqualTo(SocketError.ConnectionRefused));
157          }
158      }
159      [Test]
160      public async Task All_hosts_are_unavailable(
161          [Values] bool pooling,
162          [Values(PostgresErrorCodes.InvalidCatalogName, PostgresErrorCodes.CannotConnectNow)] string errorCode)
163      {
164          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary, startupErrorCode: errorCode);
165          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby, startupErrorCode: errorCode);
166          var builder = new NpgsqlConnectionStringBuilder
167          {
168              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
169              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
170              Pooling = pooling,
171          };
172          await using var dataSource = new NpgsqlDataSourceBuilder(builder.ConnectionString).BuildMultiHost();
173          var ex = Assert.ThrowsAsync<PostgresException>(async () => await dataSource.OpenConnectionAsync(TargetSessionAttributes.Any))!;
174          Assert.That(ex.SqlState, Is.EqualTo(errorCode));
175      }
176      [Test]
177      [Platform(Exclude = "MacOsX", Reason = "Flaky in CI on Mac")]
178      public async Task First_host_is_down()
179      {
180          using var socket = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
181          var endpoint = new IPEndPoint(IPAddress.Loopback, 0);
182          socket.Bind(endpoint);
183          var localEndPoint = (IPEndPoint)socket.LocalEndPoint!;
184          await using var postmaster = PgPostmasterMock.Start(state: Primary);
185          var connectionString = new NpgsqlConnectionStringBuilder
186          {
187              Host = $"{localEndPoint.Address}:{localEndPoint.Port},{postmaster.Host}:{postmaster.Port}",
188              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading
189          }.ConnectionString;
190          await using var dataSource = new NpgsqlDataSourceBuilder(connectionString).BuildMultiHost();
191          await using var conn = await dataSource.OpenConnectionAsync(TargetSessionAttributes.Any);
192          Assert.That(conn.Port, Is.EqualTo(postmaster.Port));
193      }
194      [Test]
195      [TestCase("any")]
196      [TestCase("primary")]
197      [TestCase("standby")]
198      [TestCase("prefer-primary")]
199      [TestCase("prefer-standby")]
200      [TestCase("read-write")]
201      [TestCase("read-only")]
202      public async Task TargetSessionAttributes_with_single_host(string targetSessionAttributes)
203      {
204          var connectionString = new NpgsqlConnectionStringBuilder(ConnectionString)
205          {
206              TargetSessionAttributes = targetSessionAttributes
207          }.ConnectionString;
208          if (targetSessionAttributes == "any")
209          {
210              await using var postmasterMock = PgPostmasterMock.Start(ConnectionString);
211              using var pool = CreateTempPool(postmasterMock.ConnectionString, out connectionString);
212              await using var conn = new NpgsqlConnection(connectionString);
213              await conn.OpenAsync();
214              _ = await postmasterMock.WaitForServerConnection();
215          }
216          else
217          {
218              Assert.That(() => new NpgsqlConnection(connectionString), Throws.Exception.TypeOf<NotSupportedException>());
219          }
220      }
221      [Test]
222      public void TargetSessionAttributes_default_is_null()
223          => Assert.That(new NpgsqlConnectionStringBuilder().TargetSessionAttributes, Is.Null);
224      [Test]
225      [NonParallelizable] 
226      public async Task TargetSessionAttributes_uses_environment_variable()
227      {
228          using var envVarResetter = SetEnvironmentVariable("PGTARGETSESSIONATTRS", "prefer-standby");
229          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary);
230          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby);
231          var builder = new NpgsqlConnectionStringBuilder
232          {
233              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
234              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading
235          };
236          Assert.That(builder.TargetSessionAttributes, Is.Null);
237          await using var dataSource = new NpgsqlDataSourceBuilder(builder.ConnectionString)
238              .BuildMultiHost();
239          await using var conn = await dataSource.OpenConnectionAsync();
240          Assert.That(conn.Port, Is.EqualTo(standbyPostmaster.Port));
241      }
242      [Test]
243      public void TargetSessionAttributes_invalid_throws()
244          => Assert.Throws<ArgumentException>(() =>
245              new NpgsqlConnectionStringBuilder
246              {
247                  TargetSessionAttributes = nameof(TargetSessionAttributes_invalid_throws)
248              });
249      [Test]
250      public void HostRecheckSeconds_default_value()
251      {
252          var builder = new NpgsqlConnectionStringBuilder();
253          Assert.That(builder.HostRecheckSeconds, Is.EqualTo(10));
254          Assert.That(builder.HostRecheckSecondsTranslated, Is.EqualTo(TimeSpan.FromSeconds(10)));
255      }
256      [Test]
257      public void HostRecheckSeconds_zero_value()
258      {
259          var builder = new NpgsqlConnectionStringBuilder
260          {
261              HostRecheckSeconds = 0,
262          };
263          Assert.That(builder.HostRecheckSeconds, Is.EqualTo(0));
264          Assert.That(builder.HostRecheckSecondsTranslated, Is.EqualTo(TimeSpan.FromSeconds(-1)));
265      }
266      [Test]
267      public void HostRecheckSeconds_invalid_throws()
268          => Assert.Throws<ArgumentException>(() =>
269              new NpgsqlConnectionStringBuilder
270              {
271                  HostRecheckSeconds = -1
272              });
273      [Test]
274      public async Task Connect_with_load_balancing()
275      {
276          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary);
277          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby);
278          var defaultCsb = new NpgsqlConnectionStringBuilder
279          {
280              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
281              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
282              MaxPoolSize = 1,
283              LoadBalanceHosts = true,
284          };
285          await using var dataSource = new NpgsqlDataSourceBuilder(defaultCsb.ConnectionString)
286              .BuildMultiHost();
287          NpgsqlConnector firstConnector;
288          NpgsqlConnector secondConnector;
289          await using (var firstConnection = await dataSource.OpenConnectionAsync())
290          {
291              firstConnector = firstConnection.Connector!;
292          }
293          await using (var secondConnection = await dataSource.OpenConnectionAsync())
294          {
295              secondConnector = secondConnection.Connector!;
296          }
297          Assert.AreNotSame(firstConnector, secondConnector);
298          await using (var firstBalancedConnection = await dataSource.OpenConnectionAsync())
299          {
300              Assert.AreSame(firstConnector, firstBalancedConnection.Connector);
301          }
302          await using (var secondBalancedConnection = await dataSource.OpenConnectionAsync())
303          {
304              Assert.AreSame(secondConnector, secondBalancedConnection.Connector);
305          }
306          await using (var thirdBalancedConnection = await dataSource.OpenConnectionAsync())
307          {
308              Assert.AreSame(firstConnector, thirdBalancedConnection.Connector);
309          }
310      }
311      [Test]
312      public async Task Connect_without_load_balancing()
313      {
314          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary);
315          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby);
316          var defaultCsb = new NpgsqlConnectionStringBuilder
317          {
318              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
319              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
320              MaxPoolSize = 1,
321              LoadBalanceHosts = false,
322          };
323          await using var dataSource = new NpgsqlDataSourceBuilder(defaultCsb.ConnectionString)
324              .BuildMultiHost();
325          NpgsqlConnector firstConnector;
326          NpgsqlConnector secondConnector;
327          await using (var firstConnection = await dataSource.OpenConnectionAsync())
328          {
329              firstConnector = firstConnection.Connector!;
330          }
331          await using (var secondConnection = await dataSource.OpenConnectionAsync())
332          {
333              Assert.AreSame(firstConnector, secondConnection.Connector);
334          }
335          await using (var firstConnection = await dataSource.OpenConnectionAsync())
336          await using (var secondConnection = await dataSource.OpenConnectionAsync())
337          {
338              secondConnector = secondConnection.Connector!;
339          }
340          Assert.AreNotSame(firstConnector, secondConnector);
341          await using (var firstUnbalancedConnection = await dataSource.OpenConnectionAsync())
342          {
343              Assert.AreSame(firstConnector, firstUnbalancedConnection.Connector);
344          }
345          await using (var secondUnbalancedConnection = await dataSource.OpenConnectionAsync())
346          {
347              Assert.AreSame(firstConnector, secondUnbalancedConnection.Connector);
348          }
349      }
350      [Test]
351      public async Task Connect_state_changing_hosts([Values] bool alwaysCheckHostState)
352      {
353          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary);
354          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby);
355          var defaultCsb = new NpgsqlConnectionStringBuilder
356          {
357              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
358              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
359              MaxPoolSize = 1,
360              HostRecheckSeconds = alwaysCheckHostState ? 0 : int.MaxValue,
361              NoResetOnClose = true,
362          };
363          await using var dataSource = new NpgsqlDataSourceBuilder(defaultCsb.ConnectionString)
364              .BuildMultiHost();
365          NpgsqlConnector firstConnector;
366          NpgsqlConnector secondConnector;
367          var firstServerTask = Task.Run(async () =>
368          {
369              var server = await primaryPostmaster.WaitForServerConnection();
370              if (!alwaysCheckHostState)
371                  return;
372              await server.SendMockState(Primary);
373              await server.SendMockState(Standby);
374          });
375          var secondServerTask = Task.Run(async () =>
376          {
377              var server = await standbyPostmaster.WaitForServerConnection();
378              if (!alwaysCheckHostState)
379                  return;
380              await server.SendMockState(Standby);
381              await server.SendMockState(Standby);
382              await server.SendMockState(Primary);
383          });
384          await using (var firstConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.PreferPrimary))
385          await using (var secondConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.PreferPrimary))
386          {
387              firstConnector = firstConnection.Connector!;
388              secondConnector = secondConnection.Connector!;
389          }
390          await using var thirdConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.PreferPrimary);
391          Assert.AreSame(alwaysCheckHostState ? secondConnector : firstConnector, thirdConnection.Connector);
392          await firstServerTask;
393          await secondServerTask;
394      }
395      [Test]
396      public void Database_state_cache_basic()
397      {
398          using var dataSource = CreateDataSource();
399          var timeStamp = DateTime.UtcNow;
400          dataSource.UpdateDatabaseState(DatabaseState.PrimaryReadWrite, timeStamp, TimeSpan.Zero);
401          Assert.AreEqual(DatabaseState.PrimaryReadWrite, dataSource.GetDatabaseState());
402          dataSource.UpdateDatabaseState(DatabaseState.Standby, timeStamp, TimeSpan.Zero);
403          Assert.AreEqual(DatabaseState.PrimaryReadWrite, dataSource.GetDatabaseState());
404          timeStamp = timeStamp.AddSeconds(1);
405          dataSource.UpdateDatabaseState(DatabaseState.PrimaryReadOnly, timeStamp, TimeSpan.Zero);
406          Assert.AreEqual(DatabaseState.PrimaryReadOnly, dataSource.GetDatabaseState());
407          timeStamp = timeStamp.AddSeconds(1);
408          dataSource.UpdateDatabaseState(DatabaseState.PrimaryReadWrite, timeStamp, TimeSpan.FromSeconds(-1));
409          Assert.AreEqual(DatabaseState.Unknown, dataSource.GetDatabaseState(ignoreExpiration: false));
410          Assert.AreEqual(DatabaseState.PrimaryReadWrite, dataSource.GetDatabaseState(ignoreExpiration: true));
411      }
412      [Test]
413      public async Task Offline_state_on_connection_failure()
414      {
415          await using var server = PgPostmasterMock.Start(ConnectionString, startupErrorCode: PostgresErrorCodes.ConnectionFailure);
416          await using var dataSource = server.CreateDataSource();
417          await using var conn = dataSource.CreateConnection();
418          var ex = Assert.ThrowsAsync<PostgresException>(conn.OpenAsync)!;
419          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.ConnectionFailure));
420          var state = conn.NpgsqlDataSource.GetDatabaseState();
421          Assert.That(state, Is.EqualTo(DatabaseState.Offline));
422      }
423      [Test]
424      public async Task Unknown_state_on_connection_authentication_failure()
425      {
426          await using var server = PgPostmasterMock.Start(ConnectionString, startupErrorCode: PostgresErrorCodes.InvalidAuthorizationSpecification);
427          await using var dataSource = server.CreateDataSource();
428          await using var conn = dataSource.CreateConnection();
429          var ex = Assert.ThrowsAsync<PostgresException>(conn.OpenAsync)!;
430          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.InvalidAuthorizationSpecification));
431          var state = conn.NpgsqlDataSource.GetDatabaseState();
432          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
433      }
434      [Test]
435      public async Task Offline_state_on_query_execution_pg_critical_failure()
436      {
437          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
438          await using var dataSource = postmaster.CreateDataSource();
439          await using var conn = await dataSource.OpenConnectionAsync();
440          await using var anotherConn = await dataSource.OpenConnectionAsync();
441          await anotherConn.CloseAsync();
442          var state = conn.NpgsqlDataSource.GetDatabaseState();
443          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
444          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
445          var server = await postmaster.WaitForServerConnection();
446          await server.WriteErrorResponse(PostgresErrorCodes.CrashShutdown).FlushAsync();
447          var ex = Assert.ThrowsAsync<PostgresException>(() => conn.ExecuteNonQueryAsync("SELECT 1"))!;
448          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.CrashShutdown));
449          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
450          state = conn.NpgsqlDataSource.GetDatabaseState();
451          Assert.That(state, Is.EqualTo(DatabaseState.Offline));
452          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(0));
453      }
454      [Test, NonParallelizable]
455      public async Task Offline_state_on_query_execution_pg_non_critical_failure()
456      {
457          await using var dataSource = CreateDataSource();
458          await using var conn = await dataSource.OpenConnectionAsync();
459          var expectedState = conn.PostgreSqlVersion.Major > 13 ? DatabaseState.PrimaryReadWrite : DatabaseState.Unknown;
460          var state = dataSource.GetDatabaseState();
461          Assert.That(state, Is.EqualTo(expectedState));
462          Assert.That(dataSource.Statistics.Total, Is.EqualTo(1));
463          var ex = Assert.ThrowsAsync<PostgresException>(() => conn.ExecuteNonQueryAsync("SELECT abc"))!;
464          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.UndefinedColumn));
465          Assert.That(conn.State, Is.EqualTo(ConnectionState.Open));
466          state = dataSource.GetDatabaseState();
467          Assert.That(state, Is.EqualTo(expectedState));
468          Assert.That(dataSource.Statistics.Total, Is.EqualTo(1));
469      }
470      [Test]
471      public async Task Offline_state_on_query_execution_IOException()
472      {
473          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
474          await using var dataSource = postmaster.CreateDataSource();
475          await using var conn = await dataSource.OpenConnectionAsync();
476          await using var anotherConn = await dataSource.OpenConnectionAsync();
477          await anotherConn.CloseAsync();
478          var state = conn.NpgsqlDataSource.GetDatabaseState();
479          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
480          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
481          var server = await postmaster.WaitForServerConnection();
482          server.Close();
483          var ex = Assert.ThrowsAsync<NpgsqlException>(() => conn.ExecuteNonQueryAsync("SELECT 1"))!;
484          Assert.That(ex.InnerException, Is.InstanceOf<IOException>());
485          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
486          state = conn.NpgsqlDataSource.GetDatabaseState();
487          Assert.That(state, Is.EqualTo(DatabaseState.Offline));
488          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(0));
489      }
490      [Test]
491      public async Task Offline_state_on_query_execution_TimeoutException()
492      {
493          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
494          var dataSourceBuilder = postmaster.GetDataSourceBuilder();
495          dataSourceBuilder.ConnectionStringBuilder.CommandTimeout = 1;
496          dataSourceBuilder.ConnectionStringBuilder.CancellationTimeout = 1;
497          await using var dataSource = dataSourceBuilder.Build();
498          await using var conn = await dataSource.OpenConnectionAsync();
499          await using var anotherConn = await dataSource.OpenConnectionAsync();
500          await anotherConn.CloseAsync();
501          var state = conn.NpgsqlDataSource.GetDatabaseState();
502          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
503          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
504          var ex = Assert.ThrowsAsync<NpgsqlException>(() => conn.ExecuteNonQueryAsync("SELECT 1"))!;
505          Assert.That(ex.InnerException, Is.TypeOf<TimeoutException>());
506          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
507          state = conn.NpgsqlDataSource.GetDatabaseState();
508          Assert.That(state, Is.EqualTo(DatabaseState.Offline));
509          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(0));
510      }
511      [Test]
512      public async Task Unknown_state_on_query_execution_TimeoutException_with_disabled_cancellation()
513      {
514          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
515          var dataSourceBuilder = postmaster.GetDataSourceBuilder();
516          dataSourceBuilder.ConnectionStringBuilder.CommandTimeout = 1;
517          dataSourceBuilder.ConnectionStringBuilder.CancellationTimeout = -1;
518          await using var dataSource = dataSourceBuilder.Build();
519          await using var conn = await dataSource.OpenConnectionAsync();
520          await using var anotherConn = await dataSource.OpenConnectionAsync();
521          await anotherConn.CloseAsync();
522          var state = conn.NpgsqlDataSource.GetDatabaseState();
523          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
524          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
525          var ex = Assert.ThrowsAsync<NpgsqlException>(() => conn.ExecuteNonQueryAsync("SELECT 1"))!;
526          Assert.That(ex.InnerException, Is.TypeOf<TimeoutException>());
527          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
528          state = conn.NpgsqlDataSource.GetDatabaseState();
529          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
530          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
531      }
532      [Test]
533      public async Task Unknown_state_on_query_execution_cancellation_with_disabled_cancellation_timeout()
534      {
535          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
536          var dataSourceBuilder = postmaster.GetDataSourceBuilder();
537          dataSourceBuilder.ConnectionStringBuilder.CommandTimeout = 30;
538          dataSourceBuilder.ConnectionStringBuilder.CancellationTimeout = -1;
539          await using var dataSource = dataSourceBuilder.Build();
540          await using var conn = await dataSource.OpenConnectionAsync();
541          await using var anotherConn = await dataSource.OpenConnectionAsync();
542          await anotherConn.CloseAsync();
543          var state = conn.NpgsqlDataSource.GetDatabaseState();
544          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
545          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
546          using var cts = new CancellationTokenSource();
547          var query = conn.ExecuteNonQueryAsync("SELECT 1", cancellationToken: cts.Token);
548          cts.Cancel();
549          var ex = Assert.ThrowsAsync<OperationCanceledException>(async () => await query)!;
550          Assert.That(ex.InnerException, Is.TypeOf<TimeoutException>());
551          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
552          state = conn.NpgsqlDataSource.GetDatabaseState();
553          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
554          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
555      }
556      [Test]
557      public async Task Unknown_state_on_query_execution_TimeoutException_with_cancellation_failure()
558      {
559          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
560          var dataSourceBuilder = postmaster.GetDataSourceBuilder();
561          dataSourceBuilder.ConnectionStringBuilder.CommandTimeout = 1;
562          dataSourceBuilder.ConnectionStringBuilder.CancellationTimeout = 0;
563          await using var dataSource = dataSourceBuilder.Build();
564          await using var conn = await dataSource.OpenConnectionAsync();
565          var state = conn.NpgsqlDataSource.GetDatabaseState();
566          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
567          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
568          var server = await postmaster.WaitForServerConnection();
569          var query = conn.ExecuteNonQueryAsync("SELECT 1");
570          await postmaster.WaitForCancellationRequest();
571          await server.WriteCancellationResponse().WriteReadyForQuery().FlushAsync();
572          var ex = Assert.ThrowsAsync<NpgsqlException>(async () => await query)!;
573          Assert.That(ex.InnerException, Is.TypeOf<TimeoutException>());
574          Assert.That(conn.State, Is.EqualTo(ConnectionState.Open));
575          state = conn.NpgsqlDataSource.GetDatabaseState();
576          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
577          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
578      }
579      [Test]
580      public async Task Clear_pool_one_host_only_on_admin_shutdown()
581      {
582          await using var primaryPostmaster = PgPostmasterMock.Start(ConnectionString, state: Primary);
583          await using var standbyPostmaster = PgPostmasterMock.Start(ConnectionString, state: Standby);
584          var dataSourceBuilder = new NpgsqlDataSourceBuilder
585          {
586              ConnectionStringBuilder =
587              {
588                  Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
589                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
590                  MaxPoolSize = 2
591              }
592          };
593          await using var multiHostDataSource = dataSourceBuilder.BuildMultiHost();
594          await using var preferPrimaryDataSource = multiHostDataSource.WithTargetSession(TargetSessionAttributes.PreferPrimary);
595          await using var primaryConn = await preferPrimaryDataSource.OpenConnectionAsync();
596          await using var anotherPrimaryConn = await preferPrimaryDataSource.OpenConnectionAsync();
597          await using var standbyConn = await preferPrimaryDataSource.OpenConnectionAsync();
598          var primaryDataSource = primaryConn.Connector!.DataSource;
599          var standbyDataSource = standbyConn.Connector!.DataSource;
600          await anotherPrimaryConn.CloseAsync();
601          await standbyConn.CloseAsync();
602          Assert.That(primaryDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.PrimaryReadWrite));
603          Assert.That(standbyDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Standby));
604          Assert.That(primaryConn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(3));
605          var server = await primaryPostmaster.WaitForServerConnection();
606          await server.WriteErrorResponse(PostgresErrorCodes.AdminShutdown).FlushAsync();
607          var ex = Assert.ThrowsAsync<PostgresException>(() => primaryConn.ExecuteNonQueryAsync("SELECT 1"))!;
608          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.AdminShutdown));
609          Assert.That(primaryConn.State, Is.EqualTo(ConnectionState.Closed));
610          Assert.That(primaryDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Offline));
611          Assert.That(standbyDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Standby));
612          Assert.That(primaryConn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
613          multiHostDataSource.ClearDatabaseStates();
614          Assert.That(primaryDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Unknown));
615          Assert.That(standbyDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Unknown));
616      }
617      [Test]
618      [TestCase("any", true)]
619      [TestCase("primary", true)]
620      [TestCase("standby", false)]
621      [TestCase("prefer-primary", true)]
622      [TestCase("prefer-standby", false)]
623      [TestCase("read-write", true)]
624      [TestCase("read-only", false)]
625      public async Task Transaction_enlist_reuses_connection(string targetSessionAttributes, bool primary)
626      {
627          await using var primaryPostmaster = PgPostmasterMock.Start(ConnectionString, state: Primary);
628          await using var standbyPostmaster = PgPostmasterMock.Start(ConnectionString, state: Standby);
629          var csb = new NpgsqlConnectionStringBuilder
630          {
631              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
632              TargetSessionAttributes = targetSessionAttributes,
633              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
634              MaxPoolSize = 10,
635          };
636          using var _ = CreateTempPool(csb, out var connString);
637          using var scope = new TransactionScope(TransactionScopeOption.Required,
638              new TransactionOptions { IsolationLevel = IsolationLevel.ReadCommitted }, TransactionScopeAsyncFlowOption.Enabled);
639          var query1Task = Query(connString);
640          var server = primary
641              ? await primaryPostmaster.WaitForServerConnection()
642              : await standbyPostmaster.WaitForServerConnection();
643          await server
644              .WriteCommandComplete()
645              .WriteReadyForQuery(TransactionStatus.InTransactionBlock)
646              .WriteParseComplete()
647              .WriteBindComplete()
648              .WriteNoData()
649              .WriteCommandComplete()
650              .WriteReadyForQuery(TransactionStatus.InTransactionBlock)
651              .FlushAsync();
652          await query1Task;
653          var query2Task = Query(connString);
654          await server
655              .WriteParseComplete()
656              .WriteBindComplete()
657              .WriteNoData()
658              .WriteCommandComplete()
659              .WriteReadyForQuery(TransactionStatus.InTransactionBlock)
660              .FlushAsync();
661          await query2Task;
662          await server
663              .WriteCommandComplete()
664              .WriteReadyForQuery()
665              .FlushAsync();
666          scope.Complete();
667          async Task Query(string connectionString)
668          {
669              await using var conn = new NpgsqlConnection(connectionString);
670              await conn.OpenAsync();
671              await using var cmd = conn.CreateCommand();
<span onclick='openModal()' class='match'>672              cmd.CommandText = "SELECT 1";
673              await cmd.ExecuteNonQueryAsync();
674          }
</span>675      }
676      [Test]
677      public async Task Primary_host_failover_can_connect()
678      {
679          await using var firstPostmaster = PgPostmasterMock.Start(ConnectionString, state: Primary);
680          await using var secondPostmaster = PgPostmasterMock.Start(ConnectionString, state: Standby);
681          var dataSourceBuilder = new NpgsqlDataSourceBuilder
682          {
683              ConnectionStringBuilder =
684              {
685                  Host = MultipleHosts(firstPostmaster, secondPostmaster),
686                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
687                  HostRecheckSeconds = 5
688              }
689          };
690          await using var multiHostDataSource = dataSourceBuilder.BuildMultiHost();
691          var (firstDataSource, secondDataSource) = (multiHostDataSource.Pools[0], multiHostDataSource.Pools[1]);
692          await using var primaryDataSource = multiHostDataSource.WithTargetSession(TargetSessionAttributes.Primary);
693          await using var conn = await primaryDataSource.OpenConnectionAsync();
694          Assert.That(conn.Port, Is.EqualTo(firstPostmaster.Port));
695          var firstServer = await firstPostmaster.WaitForServerConnection();
696          await firstServer
697              .WriteErrorResponse(PostgresErrorCodes.AdminShutdown)
698              .FlushAsync();
699          var failoverEx = Assert.ThrowsAsync<PostgresException>(async () => await conn.ExecuteNonQueryAsync("SELECT 1"))!;
700          Assert.That(failoverEx.SqlState, Is.EqualTo(PostgresErrorCodes.AdminShutdown));
701          var noHostFoundEx = Assert.ThrowsAsync<NpgsqlException>(async () => await conn.OpenAsync())!;
702          Assert.That(noHostFoundEx.Message, Is.EqualTo("No suitable host was found."));
703          Assert.That(firstDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Offline));
704          Assert.That(secondDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Standby));
705          firstPostmaster.State = Standby;
706          secondPostmaster.State = Primary;
707          var secondServer = await secondPostmaster.WaitForServerConnection();
708          await secondServer.SendMockState(Primary);
709          await Task.Delay(TimeSpan.FromSeconds(10));
710          Assert.That(firstDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Unknown));
711          Assert.That(secondDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Unknown));
712          await conn.OpenAsync();
713          Assert.That(conn.Port, Is.EqualTo(secondPostmaster.Port));
714          Assert.That(firstDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Standby));
715          Assert.That(secondDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.PrimaryReadWrite));
716      }
717      [Test, NonParallelizable]
718      public void IntegrationTest([Values] bool loadBalancing, [Values] bool alwaysCheckHostState)
719      {
720          PoolManager.Reset();
721          var dataSourceBuilder = new NpgsqlDataSourceBuilder(ConnectionString)
722          {
723              ConnectionStringBuilder =
724              {
725                  Host = "localhost,127.0.0.1",
726                  Pooling = true,
727                  MaxPoolSize = 2,
728                  LoadBalanceHosts = loadBalancing,
729                  HostRecheckSeconds = alwaysCheckHostState ? 0 : 10,
730              }
731          };
732          using var dataSource = dataSourceBuilder.BuildMultiHost();
733          var queriesDone = 0;
734          var clientsTask = Task.WhenAll(
735              Client(dataSource, TargetSessionAttributes.Any),
736              Client(dataSource, TargetSessionAttributes.Primary),
737              Client(dataSource, TargetSessionAttributes.PreferPrimary),
738              Client(dataSource, TargetSessionAttributes.PreferStandby),
739              Client(dataSource, TargetSessionAttributes.ReadWrite));
740          var onlyStandbyClient = Client(dataSource, TargetSessionAttributes.Standby);
741          var readOnlyClient = Client(dataSource, TargetSessionAttributes.ReadOnly);
742          Assert.DoesNotThrowAsync(() => clientsTask);
743          Assert.ThrowsAsync<NpgsqlException>(() => onlyStandbyClient);
744          Assert.ThrowsAsync<NpgsqlException>(() => readOnlyClient);
745          Assert.AreEqual(125, queriesDone);
746          Task Client(NpgsqlMultiHostDataSource multiHostDataSource, TargetSessionAttributes targetSessionAttributes)
747          {
748              var dataSource = multiHostDataSource.WithTargetSession(targetSessionAttributes);
749              var tasks = new List<Task>(5);
750              for (var i = 0; i < 5; i++)
751              {
752                  tasks.Add(Task.Run(() => Query(dataSource)));
753              }
754              return Task.WhenAll(tasks);
755          }
756          async Task Query(NpgsqlDataSource dataSource)
757          {
758              await using var conn = dataSource.CreateConnection();
759              for (var i = 0; i < 5; i++)
760              {
761                  await conn.OpenAsync();
762                  await conn.ExecuteNonQueryAsync("SELECT 1");
763                  await conn.CloseAsync();
764                  Interlocked.Increment(ref queriesDone);
765              }
766          }
767      }
768      [Test]
769      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/5055")]
770      [NonParallelizable] 
771      public async Task Multiple_hosts_with_disabled_sql_rewriting()
772      {
773          using var _ = DisableSqlRewriting();
774          var dataSourceBuilder = new NpgsqlDataSourceBuilder(ConnectionString)
775          {
776              ConnectionStringBuilder =
777              {
778                  Host = "localhost,127.0.0.1",
779                  Pooling = true,
780                  HostRecheckSeconds = 0
781              }
782          };
783          await using var dataSource = dataSourceBuilder.BuildMultiHost();
784          await using var conn = await dataSource.OpenConnectionAsync();
785      }
786      [Test]
787      public async Task DataSource_with_wrappers()
788      {
789          await using var primaryPostmasterMock = PgPostmasterMock.Start(state: Primary);
790          await using var standbyPostmasterMock = PgPostmasterMock.Start(state: Standby);
791          var builder = new NpgsqlDataSourceBuilder
792          {
793              ConnectionStringBuilder =
794              {
795                  Host = MultipleHosts(primaryPostmasterMock, standbyPostmasterMock),
796                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
797              }
798          };
799          await using var dataSource = builder.BuildMultiHost();
800          await using var primaryDataSource = dataSource.WithTargetSession(TargetSessionAttributes.Primary);
801          await using var standbyDataSource = dataSource.WithTargetSession(TargetSessionAttributes.Standby);
802          await using var primaryConnection = await primaryDataSource.OpenConnectionAsync();
803          Assert.That(primaryConnection.Port, Is.EqualTo(primaryPostmasterMock.Port));
804          await using var standbyConnection = await standbyDataSource.OpenConnectionAsync();
805          Assert.That(standbyConnection.Port, Is.EqualTo(standbyPostmasterMock.Port));
806      }
807      [Test]
808      public async Task DataSource_without_wrappers()
809      {
810          await using var primaryPostmasterMock = PgPostmasterMock.Start(state: Primary);
811          await using var standbyPostmasterMock = PgPostmasterMock.Start(state: Standby);
812          var builder = new NpgsqlDataSourceBuilder
813          {
814              ConnectionStringBuilder =
815              {
816                  Host = MultipleHosts(primaryPostmasterMock, standbyPostmasterMock),
817                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
818              }
819          };
820          await using var dataSource = builder.BuildMultiHost();
821          await using var primaryConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.Primary);
822          Assert.That(primaryConnection.Port, Is.EqualTo(primaryPostmasterMock.Port));
823          await using var standbyConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.Standby);
824          Assert.That(standbyConnection.Port, Is.EqualTo(standbyPostmasterMock.Port));
825      }
826      [Test]
827      public void DataSource_with_TargetSessionAttributes_is_not_supported()
828      {
829          var builder = new NpgsqlDataSourceBuilder("Host=foo,bar;Target Session Attributes=primary");
830          Assert.That(() => builder.BuildMultiHost(), Throws.Exception.TypeOf<InvalidOperationException>()
831              .With.Message.EqualTo(NpgsqlStrings.CannotSpecifyTargetSessionAttributes));
832      }
833      [Test]
834      public async Task BuildMultiHost_with_single_host_is_supported()
835      {
836          var builder = new NpgsqlDataSourceBuilder(ConnectionString);
837          await using var dataSource = builder.BuildMultiHost();
838          await using var connection = await dataSource.OpenConnectionAsync();
839          Assert.That(await connection.ExecuteScalarAsync("SELECT 1"), Is.EqualTo(1));
840      }
841      [Test]
842      public async Task Build_with_multiple_hosts_is_supported()
843      {
844          await using var primaryPostmasterMock = PgPostmasterMock.Start(state: Primary);
845          await using var standbyPostmasterMock = PgPostmasterMock.Start(state: Standby);
846          var builder = new NpgsqlDataSourceBuilder
847          {
848              ConnectionStringBuilder =
849              {
850                  Host = MultipleHosts(primaryPostmasterMock, standbyPostmasterMock),
851                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
852              }
853          };
854          await using var dataSource = builder.Build();
855          await using var connection = await dataSource.OpenConnectionAsync();
856      }
857      static string MultipleHosts(params PgPostmasterMock[] postmasters)
858          => string.Join(",", postmasters.Select(p => $"{p.Host}:{p.Port}"));
859      class DisposableWrapper : IAsyncDisposable
860      {
861          readonly IEnumerable<IAsyncDisposable> _disposables;
862          public DisposableWrapper(IEnumerable<IAsyncDisposable> disposables) => _disposables = disposables;
863          public async ValueTask DisposeAsync()
864          {
865              foreach (var disposable in _disposables)
866                  await disposable.DisposeAsync();
867          }
868      }
869  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-BugTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-MultipleHostsTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>331          cmd.CommandText = "SELECT 1";
332          await cmd.ExecuteScalarAsync();
333          await cmd.ExecuteScalarAsync();
</pre></code></div>
                <div class="column column_space"><pre><code>672              cmd.CommandText = "SELECT 1";
673              await cmd.ExecuteNonQueryAsync();
674          }
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    