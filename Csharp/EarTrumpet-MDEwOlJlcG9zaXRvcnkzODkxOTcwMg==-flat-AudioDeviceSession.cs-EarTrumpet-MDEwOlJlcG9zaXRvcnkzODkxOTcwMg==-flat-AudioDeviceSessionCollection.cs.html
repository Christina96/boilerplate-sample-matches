
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 17, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>EarTrumpet-MDEwOlJlcG9zaXRvcnkzODkxOTcwMg==-flat-AudioDeviceSession.cs</h3>
            <pre><code>1  using EarTrumpet.DataModel.AppInformation;
2  using EarTrumpet.DataModel.Audio;
3  using EarTrumpet.Extensions;
4  using EarTrumpet.Interop;
5  using EarTrumpet.Interop.MMDeviceAPI;
6  using System;
7  using System.Collections.Generic;
8  using System.Collections.ObjectModel;
9  using System.Diagnostics;
10  using System.Runtime.InteropServices;
11  using System.Text;
12  using System.Threading.Tasks;
13  using System.Windows.Threading;
14  namespace EarTrumpet.DataModel.WindowsAudio.Internal
15  {
16      class AudioDeviceSession : BindableBase, IAudioSessionEvents, IAudioDeviceSession, IAudioDeviceSessionInternal
17      {
18          public IAudioDevice Parent
19          {
20              get
21              {
22                  if (_parent.TryGetTarget(out var parent))
23                  {
24                      return parent;
25                  }
26                  return null;
27              }
28          }
29          public float Volume
30          {
31              get => _volume;
32              set
33              {
34                  value = value.Bound(0, 1f);
35                  if (value != _volume)
36                  {
37                      try
38                      {
39                          _volume = value;
40                          Guid dummy = Guid.Empty;
41                          _simpleVolume.SetMasterVolume(value, ref dummy);
42                      }
43                      catch (Exception ex) when (ex.Is(HRESULT.AUDCLNT_E_DEVICE_INVALIDATED))
44                      {
45                      }
46                      IsMuted = _volume.ToVolumeInt() == 0;
47                  }
48              }
49          }
50          public bool IsMuted
51          {
52              get => _isMuted;
53              set
54              {
55                  if (value != _isMuted)
56                  {
57                      try
58                      {
59                          Guid dummy = Guid.Empty;
60                          _simpleVolume.SetMute(value ? 1 : 0, ref dummy);
61                      }
62                      catch (Exception ex) when (ex.Is(HRESULT.AUDCLNT_E_DEVICE_INVALIDATED))
63                      {
64                      }
65                  }
66              }
67          }
68          public string DisplayName { get; private set; }
69          public string ExeName => _appInfo.ExeName;
70          public string IconPath { get; private set; }
71          public Guid GroupingParam { get; private set; }
72          public float PeakValue1 { get; private set; }
73          public float PeakValue2 { get; private set; }
74          public bool IsDesktopApp => _appInfo.IsDesktopApp;
75          public string AppId => _appInfo.PackageInstallPath;
76          public SessionState State
77          {
78              get
79              {
80                  if (_isDisconnected)
81                  {
82                      return SessionState.Expired;
83                  }
84                  else if (_isMoved)
85                  {
86                      return SessionState.Moved;
87                  }
88                  switch (_state)
89                  {
90                      case AudioSessionState.Active:
91                          return SessionState.Active;
92                      case AudioSessionState.Inactive:
93                          return SessionState.Inactive;
94                      case AudioSessionState.Expired:
95                          return SessionState.Expired;
96                      default:
97                          throw new NotImplementedException();
98                  }
99              }
100          }
101          public int ProcessId { get; }
102          public string Id => _id;
103          public bool IsSystemSoundsSession { get; }
104          public ObservableCollection<IAudioDeviceSession> Children { get; private set; }
105          public IEnumerable<IAudioDeviceSessionChannel> Channels => _channels.Channels;
106          private readonly string _id;
107          private readonly IAudioSessionControl _session;
108          private readonly ISimpleAudioVolume _simpleVolume;
109          private readonly IAudioMeterInformation _meter;
110          private readonly Dispatcher _dispatcher;
111          private readonly IAppInfo _appInfo;
112          private readonly AudioDeviceSessionChannelCollection _channels;
113          private float _volume;
114          private AudioSessionState _state;
115          private bool _isMuted;
116          private bool _isDisconnected;
117          private bool _isMoved;
118          private bool _moveOnInactive;
119          private bool _isRegistered;
120          private WeakReference<IAudioDevice> _parent;
121          public AudioDeviceSession(IAudioDevice parent, IAudioSessionControl session, Dispatcher foregroundDispatcher)
122          {
123              _dispatcher = foregroundDispatcher;
124              _session = session;
125              _meter = (IAudioMeterInformation)_session;
126              _simpleVolume = (ISimpleAudioVolume)session;
127              _channels = new AudioDeviceSessionChannelCollection((IChannelAudioVolume)session, _dispatcher);
128              _state = _session.GetState();
129              GroupingParam = _session.GetGroupingParam();
130              _simpleVolume.GetMasterVolume(out _volume);
131              _isMuted = _simpleVolume.GetMute() != 0;
132              IsSystemSoundsSession = ((IAudioSessionControl2)_session).IsSystemSoundsSession() == HRESULT.S_OK;
133              ProcessId = ReadProcessId();
134              _parent = new WeakReference<IAudioDevice>(parent);
135              _appInfo = AppInformationFactory.CreateForProcess(ProcessId, trackProcess: true);
136              _appInfo.Stopped += _ => DisconnectSession();
137              _session.RegisterAudioSessionNotification(this);
138              _isRegistered = true;
139              ((IAudioSessionControl2)_session).GetSessionInstanceIdentifier(out _id);
140              Trace.WriteLine($"AudioDeviceSession Create {ExeName} {_id}");
141              ChooseIconPath(session.GetIconPath());
142              ChooseDisplayName(ReadSessionDisplayName());
143              if (parent.Parent != null)
144              {
145                  if (parent.Parent.Kind == AudioDeviceKind.Recording.ToString())
146                  {
147                      _isDisconnected = IsSystemSoundsSession;
148                  }
149                  else
150                  {
151                      SyncPersistedEndpoint(parent);
152                  }
153              }
154          }
155          ~AudioDeviceSession()
156          {
157              try
158              {
159                  if (_isRegistered)
160                  {
161                      _session.UnregisterAudioSessionNotification(this);
162                  }
163              }
164              catch (Exception ex)
165              {
166                  Trace.WriteLine($"AudioDeviceSession dtor Failed: {ex}");
167              }
168          }
169          public void Hide()
170          {
171              Trace.WriteLine($"AudioDeviceSession MoveFromDevice {ExeName} {Id}");
172              if (_state == AudioSessionState.Active)
173              {
174                  _moveOnInactive = true;
175              }
176              else
177              {
178                  _isMoved = true;
179                  RaisePropertyChanged(nameof(State));
180              }
181          }
182          public void UnHide()
183          {
184              Trace.WriteLine($"AudioDeviceSession UnHide {ExeName} {Id}");
185              _isMoved = false;
186              _moveOnInactive = false;
187              RaisePropertyChanged(nameof(State));
188          }
189          public void MoveToDevice(string id, bool hide)
190          {
191              if (_parent.TryGetTarget(out var parent))
192              {
193                  ((IAudioDeviceManagerWindowsAudio)parent.Parent).SetDefaultEndPoint(id, ProcessId);
194              }
195          }
196          public void UpdatePeakValueBackground()
197          {
198              var newValues = Helpers.ReadPeakValues(_meter);
199              PeakValue1 = newValues[0];
200              PeakValue2 = newValues[1];
201          }
202          private void ChooseDisplayName(string displayNameFromSession)
203          {
204              if (!string.IsNullOrWhiteSpace(displayNameFromSession))
205              {
206                  DisplayName = displayNameFromSession;
207              }
208              else if (!string.IsNullOrWhiteSpace(_appInfo.DisplayName))
209              {
210                  DisplayName = _appInfo.DisplayName;
211              }
212              else
213              {
214                  DisplayName = _appInfo.ExeName;
215              }
216          }
217          private void ChooseIconPath(string iconPathFromSession)
218          {
219              if (!string.IsNullOrWhiteSpace(iconPathFromSession) && !IsSystemSoundsSession)
220              {
221                  IconPath = iconPathFromSession;
222              }
223              else if (!string.IsNullOrWhiteSpace(_appInfo.SmallLogoPath))
224              {
225                  IconPath = _appInfo.SmallLogoPath;
226              }
227              else
228              {
229                  IconPath = null;
230              }
231          }
232          private int ReadProcessId()
233          {
234              var hr = ((IAudioSessionControl2)_session).GetProcessId(out uint pid);
235              if (hr == (int)HRESULT.AUDCLNT_S_NO_SINGLE_PROCESS ||
236                  hr == (int)HRESULT.S_OK)
237              {
238                  return IsSystemSoundsSession ? 0 : (int)pid;
239              }
240              throw Marshal.GetExceptionForHR(hr);
241          }
242          private void SyncPersistedEndpoint(IAudioDevice parent)
243          {
244              var persistedDeviceId = ((IAudioDeviceManagerWindowsAudio)Parent.Parent).GetDefaultEndPoint(ProcessId);
245              if (!string.IsNullOrWhiteSpace(persistedDeviceId))
246              {
247                  if (parent.Id != persistedDeviceId)
248                  {
249                      Trace.WriteLine($"FORCE-MOVE: {_state} {parent.Id} -> {persistedDeviceId}");
250                      MoveToDevice(persistedDeviceId, false);
251                      var delay = Task.Delay(TimeSpan.FromMilliseconds(200));
252                      delay.ContinueWith((_) =>
253                      {
254                          _dispatcher.BeginInvoke((Action)(() =>
255                          {
256                              if (_state == AudioSessionState.Active)
257                              {
258                                  _moveOnInactive = true;
259                              }
260                              else
261                              {
262                                  _isMoved = true;
263                              }
264                              RaisePropertyChanged(nameof(State));
265                          }));
266                      });
267                  }
268              }
269          }
270          private string ReadSessionDisplayName()
271          {
272              try
273              {
274                  var displayName = _session.GetDisplayName();
275                  if (displayName.StartsWith("@"))
276                  {
277                      StringBuilder sb = new StringBuilder(512);
278                      if (Shlwapi.SHLoadIndirectString(displayName, sb, sb.Capacity, IntPtr.Zero) == 0)
279                      {
280                          displayName = sb.ToString();
281                      }
282                  }
283                  return displayName;
284              }
285              catch (Exception ex) when (ex.Is(HRESULT.AUDCLNT_E_DEVICE_INVALIDATED))
286              {
287              }
288              return null;
289          }
290          private void DisconnectSession()
291          {
292              Trace.WriteLine($"AudioDeviceSession DisconnectSession {ExeName} {Id}");
293              _isDisconnected = true;
294              _dispatcher.BeginInvoke((Action)(() =>
295              {
296                  RaisePropertyChanged(nameof(State));
297              }));
298          }
299          void IAudioSessionEvents.OnSimpleVolumeChanged(float NewVolume, int NewMute, ref Guid EventContext)
300          {
301              _volume = NewVolume;
302              _isMuted = NewMute != 0;
303              _dispatcher.BeginInvoke((Action)(() =>
304              {
305                  RaisePropertyChanged(nameof(Volume));
306                  RaisePropertyChanged(nameof(IsMuted));
307              }));
308          }
309          void IAudioSessionEvents.OnGroupingParamChanged(ref Guid NewGroupingParam, ref Guid EventContext)
310          {
311              GroupingParam = NewGroupingParam;
312              Trace.WriteLine($"AudioDeviceSession OnGroupingParamChanged {ExeName} {Id}");
313              _dispatcher.BeginInvoke((Action)(() =>
314              {
315                  RaisePropertyChanged(nameof(GroupingParam));
316              }));
317          }
<span onclick='openModal()' class='match'>318          void IAudioSessionEvents.OnStateChanged(AudioSessionState NewState)
319          {
320              Trace.WriteLine($"AudioDeviceSession OnStateChanged {NewState} {ExeName} {Id}");
321              _state = NewState;
</span>322              if (_isMoved && NewState == AudioSessionState.Active)
323              {
324                  _isMoved = false;
325              }
326              else if (_moveOnInactive && NewState == AudioSessionState.Inactive)
327              {
328                  _isMoved = true;
329                  _moveOnInactive = false;
330              }
331              _dispatcher.BeginInvoke((Action)(() =>
332              {
333                  RaisePropertyChanged(nameof(State));
334              }));
335          }
336          void IAudioSessionEvents.OnDisplayNameChanged(string NewDisplayName, ref Guid EventContext)
337          {
338              ChooseDisplayName(NewDisplayName);
339              _dispatcher.BeginInvoke((Action)(() =>
340              {
341                  RaisePropertyChanged(nameof(DisplayName));
342              }));
343          }
344          void IAudioSessionEvents.OnSessionDisconnected(AudioSessionDisconnectReason DisconnectReason) => DisconnectSession();
345          void IAudioSessionEvents.OnChannelVolumeChanged(uint ChannelCount, IntPtr afNewChannelVolume, uint ChangedChannel, ref Guid EventContext)
346          {
347              var channelVolumesValues = new float[ChannelCount];
348              Marshal.Copy(afNewChannelVolume, channelVolumesValues, 0, (int)ChannelCount);
349              for (var i = 0; i < ChannelCount; i++)
350              {
351                  _channels.Channels[i].SetLevel(channelVolumesValues[i]);
352              }
353          }
354          void IAudioSessionEvents.OnIconPathChanged(string NewIconPath, ref Guid EventContext)
355          {
356              IconPath = NewIconPath;
357              RaisePropertyChanged(nameof(IconPath));
358          }
359      }
360  }
</code></pre>
        </div>
        <div class="column">
            <h3>EarTrumpet-MDEwOlJlcG9zaXRvcnkzODkxOTcwMg==-flat-AudioDeviceSessionCollection.cs</h3>
            <pre><code>1  using EarTrumpet.DataModel.Audio;
2  using EarTrumpet.Interop.MMDeviceAPI;
3  using System;
4  using System.Collections.Generic;
5  using System.Collections.ObjectModel;
6  using System.Diagnostics;
7  using System.Linq;
8  using System.Windows.Threading;
9  namespace EarTrumpet.DataModel.WindowsAudio.Internal
10  {
11      class AudioDeviceSessionCollection : IAudioSessionNotification
12      {
13          public ObservableCollection<IAudioDeviceSession> Sessions => _sessions;
14          private readonly Dispatcher _dispatcher;
15          private readonly ObservableCollection<IAudioDeviceSession> _sessions = new ObservableCollection<IAudioDeviceSession>();
16          private readonly List<IAudioDeviceSession> _movedSessions = new List<IAudioDeviceSession>();
17          private IAudioSessionManager2 _sessionManager;
18          private WeakReference<IAudioDevice> _parent;
19          public AudioDeviceSessionCollection(IAudioDevice parent, IMMDevice device, Dispatcher foregroundDispatcher)
20          {
21              _parent = new WeakReference<IAudioDevice>(parent);
22              _dispatcher = foregroundDispatcher;
23              try
24              {
25                  _sessionManager = device.Activate<IAudioSessionManager2>();
26                  _sessionManager.RegisterSessionNotification(this);
27                  var enumerator = _sessionManager.GetSessionEnumerator();
28                  int count = enumerator.GetCount();
29                  for (int i = 0; i < count; i++)
30                  {
31                      CreateAndAddSession(enumerator.GetSession(i));
32                  }
33              }
34              catch (Exception ex)
35              {
36                  Trace.WriteLine($"AudioDeviceSessionCollection Create dev={device.GetId()} {ex}");
37              }
38          }
39          ~AudioDeviceSessionCollection()
40          {
41              foreach (var session in _sessions)
42              {
43                  session.PropertyChanged -= Session_PropertyChanged;
44              }
45              foreach (var session in _movedSessions)
46              {
47                  session.PropertyChanged -= MovedSession_PropertyChanged;
48              }
49              _sessionManager.UnregisterSessionNotification(this);
50          }
51          private void CreateAndAddSession(IAudioSessionControl session)
52          {
53              try
54              {
55                  if (!_parent.TryGetTarget(out IAudioDevice parent))
56                  {
57                      throw new Exception("Device session parent is invalid but device is still notifying.");
58                  }
59                  var newSession = new AudioDeviceSession(parent, session, _dispatcher);
60                  _dispatcher.BeginInvoke((Action)(() =>
61                  {
62                      if (newSession.State == SessionState.Moved)
63                      {
64                          _movedSessions.Add(newSession);
65                          newSession.PropertyChanged += MovedSession_PropertyChanged;
66                      }
67                      else if (newSession.State != SessionState.Expired)
68                      {
69                          AddSession(newSession);
70                      }
71                  }));
72              }
73              catch (Exception ex)
74              {
75                  Trace.WriteLine($"AudioDeviceSessionCollection CreateAndAddSession {ex}");
76              }
77          }
<span onclick='openModal()' class='match'>78          void IAudioSessionNotification.OnSessionCreated(IAudioSessionControl NewSession)
79          {
80              Trace.WriteLine($"AudioDeviceSessionCollection OnSessionCreated");
81              CreateAndAddSession(NewSession);
</span>82          }
83          private void AddSession(IAudioDeviceSession session)
84          {
85              Trace.WriteLine($"AudioDeviceSessionCollection AddSession {session.ExeName} {session.Id}");
86              session.PropertyChanged += Session_PropertyChanged;
87              if (_parent.TryGetTarget(out var parent))
88              {
89                  foreach (AudioDeviceSessionGroup appGroup in _sessions)
90                  {
91                      if (appGroup.AppId == session.AppId)
92                      {
93                          foreach (AudioDeviceSessionGroup appSessionGroup in appGroup.Sessions)
94                          {
95                              if (appSessionGroup.GroupingParam == ((IAudioDeviceSessionInternal)session).GroupingParam)
96                              {
97                                  session.IsMuted = session.IsMuted || appSessionGroup.IsMuted;
98                                  appSessionGroup.AddSession(session);
99                                  return;
100                              }
101                          }
102                          session.IsMuted = session.IsMuted || appGroup.IsMuted;
103                          appGroup.AddSession(new AudioDeviceSessionGroup(parent, session));
104                          return;
105                      }
106                  }
107                  _sessions.Add(new AudioDeviceSessionGroup(parent, new AudioDeviceSessionGroup(parent, session)));
108              }
109          }
110          internal void UnHideSessionsForProcessId(int processId)
111          {
112              foreach (var session in _movedSessions.ToArray())  
113              {
114                  if (session.ProcessId == processId)
115                  {
116                      _movedSessions.Remove(session);
117                      session.PropertyChanged -= MovedSession_PropertyChanged;
118                      ((IAudioDeviceSessionInternal)session).UnHide();
119                      AddSession(session);
120                  }
121              }
122          }
123          public void MoveHiddenAppsToDevice(string appId, string id)
124          {
125              foreach (var session in _movedSessions)
126              {
127                  if (session.AppId == appId)
128                  {
129                      ((IAudioDeviceSessionInternal)session).MoveToDevice(id, false);
130                  }
131              }
132          }
133          private void RemoveSession(IAudioDeviceSession session)
134          {
135              Trace.WriteLine($"AudioDeviceSessionCollection RemoveSession {session.ExeName} {session.Id}");
136              session.PropertyChanged -= Session_PropertyChanged;
137              foreach (AudioDeviceSessionGroup appGroup in _sessions)
138              {
139                  foreach (AudioDeviceSessionGroup appSessionGroup in appGroup.Sessions)
140                  {
141                      if (appSessionGroup.Sessions.Contains(session))
142                      {
143                          appSessionGroup.RemoveSession(session);
144                          if (!appSessionGroup.Sessions.Any())
145                          {
146                              appGroup.RemoveSession(appSessionGroup);
147                              break;
148                          }
149                      }
150                  }
151                  if (!appGroup.Sessions.Any())
152                  {
153                      _sessions.Remove(appGroup);
154                      break;
155                  }
156              }
157          }
158          private void Session_PropertyChanged(object sender, System.ComponentModel.PropertyChangedEventArgs e)
159          {
160              var session = (IAudioDeviceSession)sender;
161              if (e.PropertyName == nameof(session.State))
162              {
163                  if (session.State == SessionState.Expired)
164                  {
165                      RemoveSession(session);
166                  }
167                  else if (session.State == SessionState.Moved)
168                  {
169                      RemoveSession(session);
170                      _movedSessions.Add(session);
171                      session.PropertyChanged += MovedSession_PropertyChanged;
172                  }
173              }
174          }
175          private void MovedSession_PropertyChanged(object sender, System.ComponentModel.PropertyChangedEventArgs e)
176          {
177              var session = (IAudioDeviceSession)sender;
178              if (e.PropertyName == nameof(session.State) && session.State == SessionState.Active)
179              {
180                  _movedSessions.Remove(session);
181                  session.PropertyChanged -= MovedSession_PropertyChanged;
182                  AddSession(session);
183              }
184          }
185      }
186  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from EarTrumpet-MDEwOlJlcG9zaXRvcnkzODkxOTcwMg==-flat-AudioDeviceSession.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from EarTrumpet-MDEwOlJlcG9zaXRvcnkzODkxOTcwMg==-flat-AudioDeviceSessionCollection.cs</div>
                </div>
                <div class="column column_space"><pre><code>318          void IAudioSessionEvents.OnStateChanged(AudioSessionState NewState)
319          {
320              Trace.WriteLine($"AudioDeviceSession OnStateChanged {NewState} {ExeName} {Id}");
321              _state = NewState;
</pre></code></div>
                <div class="column column_space"><pre><code>78          void IAudioSessionNotification.OnSessionCreated(IAudioSessionControl NewSession)
79          {
80              Trace.WriteLine($"AudioDeviceSessionCollection OnSessionCreated");
81              CreateAndAddSession(NewSession);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    