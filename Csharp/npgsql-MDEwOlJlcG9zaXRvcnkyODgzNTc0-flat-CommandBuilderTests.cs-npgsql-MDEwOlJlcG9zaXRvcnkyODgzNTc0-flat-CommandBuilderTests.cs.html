
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 24, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-CommandBuilderTests.cs</h3>
            <pre><code>1  using System;
2  using System.Data;
3  using System.Threading.Tasks;
4  using Npgsql.PostgresTypes;
5  using NpgsqlTypes;
6  using NUnit.Framework;
7  using static Npgsql.Tests.TestUtil;
8  namespace Npgsql.Tests;
9  class CommandBuilderTests : TestBase
10  {
11      [Test, Description("Tests parameter derivation for parameterized queries (CommandType.Text)")]
12      public async Task DeriveParameters_text_one_parameter_with_same_type()
13      {
14          using var conn = await OpenConnectionAsync();
15          var table = await CreateTempTable(conn, "id int, val text");
16          var cmd = new NpgsqlCommand(
17              $@"INSERT INTO {table} VALUES(:x, 'some value');
18                      UPDATE {table} SET val = 'changed value' WHERE id = :x;
19                      SELECT val FROM {table} WHERE id = :x;",
20              conn);
21          NpgsqlCommandBuilder.DeriveParameters(cmd);
22          Assert.That(cmd.Parameters, Has.Count.EqualTo(1));
23          Assert.That(cmd.Parameters[0].Direction, Is.EqualTo(ParameterDirection.Input));
24          Assert.That(cmd.Parameters[0].ParameterName, Is.EqualTo("x"));
25          Assert.That(cmd.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Integer));
26          cmd.Parameters[0].Value = 42;
27          var retVal = await cmd.ExecuteScalarAsync();
28          Assert.That(retVal, Is.EqualTo("changed value"));
29      }
30      [Test, Description("Tests parameter derivation for parameterized queries (CommandType.Text) where different types would be inferred for placeholders with the same name.")]
31      public async Task DeriveParameters_text_one_parameter_with_different_types()
32      {
33          using var conn = await OpenConnectionAsync();
34          var table = await CreateTempTable(conn, "id int, val text");
35          var cmd = new NpgsqlCommand(
36              $@"INSERT INTO {table} VALUES(:x, 'some value');
37                      UPDATE {table} SET val = 'changed value' WHERE id = :x::double precision;
38                      SELECT val FROM {table} WHERE id = :x::numeric;",
39              conn);
40          var ex = Assert.Throws<NpgsqlException>(() => NpgsqlCommandBuilder.DeriveParameters(cmd))!;
41          Assert.That(ex.Message, Is.EqualTo("The backend parser inferred different types for parameters with the same name. Please try explicit casting within your SQL statement or batch or use different placeholder names."));
42      }
43      [Test, Description("Tests parameter derivation for parameterized queries (CommandType.Text) with multiple parameters")]
44      public async Task DeriveParameters_multiple_parameters()
45      {
46          using var conn = await OpenConnectionAsync();
47          var table = await CreateTempTable(conn, "id int, val text");
48          var cmd = new NpgsqlCommand(
49              $@"INSERT INTO {table} VALUES(:x, 'some value');
50                      UPDATE {table} SET val = 'changed value' WHERE id = @y::double precision;
51                      SELECT val FROM {table} WHERE id = :z::numeric;",
52              conn);
53          NpgsqlCommandBuilder.DeriveParameters(cmd);
54          Assert.That(cmd.Parameters, Has.Count.EqualTo(3));
55          Assert.That(cmd.Parameters[0].ParameterName, Is.EqualTo("x"));
56          Assert.That(cmd.Parameters[1].ParameterName, Is.EqualTo("y"));
57          Assert.That(cmd.Parameters[2].ParameterName, Is.EqualTo("z"));
58          Assert.That(cmd.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Integer));
59          Assert.That(cmd.Parameters[1].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Double));
60          Assert.That(cmd.Parameters[2].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Numeric));
61          cmd.Parameters[0].Value = 42;
62          cmd.Parameters[1].Value = 42d;
63          cmd.Parameters[2].Value = 42;
64          var retVal = await cmd.ExecuteScalarAsync();
65          Assert.That(retVal, Is.EqualTo("changed value"));
66      }
67      [Test, Description("Tests parameter derivation a parameterized query (CommandType.Text) that is already prepared.")]
68      public async Task DeriveParameters_text_prepared_statement()
69      {
70          const string query = "SELECT @p::integer";
71          const int answer = 42;
72          await using var dataSource = CreateDataSource();
73          await using var conn = await dataSource.OpenConnectionAsync();
74          await using var cmd = new NpgsqlCommand(query, conn);
75          cmd.Parameters.AddWithValue("@p", NpgsqlDbType.Integer, answer);
76          cmd.Prepare();
77          Assert.That(conn.Connector!.PreparedStatementManager.NumPrepared, Is.EqualTo(1));
78          var ex = Assert.Throws<NpgsqlException>(() =>
79          {
80              NpgsqlCommandBuilder.DeriveParameters(cmd);
81          })!;
82          Assert.That(ex.Message, Is.EqualTo("Deriving parameters isn't supported for commands that are already prepared."));
83          Assert.That(cmd.Parameters.Count, Is.EqualTo(1));
84          Assert.That(cmd.Parameters[0].ParameterName, Is.EqualTo("@p"));
85          Assert.That(conn.Connector.PreparedStatementManager.NumPrepared, Is.EqualTo(1));
86          cmd.Parameters["@p"].Value = answer;
87          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(answer));
88      }
89      [Test, Description("Tests parameter derivation for array parameters in parameterized queries (CommandType.Text)")]
90      public async Task DeriveParameters_text_array()
91      {
92          using var conn = await OpenConnectionAsync();
93          var cmd = new NpgsqlCommand("SELECT :a::integer[]", conn);
94          var val = new[] { 7, 42 };
95          NpgsqlCommandBuilder.DeriveParameters(cmd);
96          Assert.That(cmd.Parameters, Has.Count.EqualTo(1));
97          Assert.That(cmd.Parameters[0].ParameterName, Is.EqualTo("a"));
98          Assert.That(cmd.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Integer | NpgsqlDbType.Array));
99          cmd.Parameters[0].Value = val;
100          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SingleResult | CommandBehavior.SingleRow);
101          Assert.That(reader.Read(), Is.True);
102          Assert.That(reader.GetFieldValue<int[]>(0), Is.EqualTo(val));
103      }
104      [Test, Description("Tests parameter derivation for domain parameters in parameterized queries (CommandType.Text)")]
105      public async Task DeriveParameters_text_domain()
106      {
107          using var conn = await OpenConnectionAsync();
108          MinimumPgVersion(conn, "11.0", "Arrays of domains and domains over arrays were introduced in PostgreSQL 11");
109          var domainType = await GetTempTypeName(conn);
110          var domainArrayType = await GetTempTypeName(conn);
111          await conn.ExecuteNonQueryAsync($@"
112  CREATE DOMAIN {domainType} AS integer CHECK (VALUE > 0);
113  CREATE DOMAIN {domainArrayType} AS int[] CHECK(array_length(VALUE, 1) = 2);");
114          conn.ReloadTypes();
115          var cmd = new NpgsqlCommand($"SELECT :a::{domainType}, :b::{domainType}[], :c::{domainArrayType}", conn);
116          var val = 23;
117          var arrayVal = new[] { 7, 42 };
118          NpgsqlCommandBuilder.DeriveParameters(cmd);
119          Assert.That(cmd.Parameters, Has.Count.EqualTo(3));
120          Assert.That(cmd.Parameters[0].ParameterName, Is.EqualTo("a"));
121          Assert.That(cmd.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Integer));
122          Assert.That(cmd.Parameters[0].DataTypeName, Does.EndWith(domainType));
123          Assert.That(cmd.Parameters[1].ParameterName, Is.EqualTo("b"));
124          Assert.That(cmd.Parameters[1].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Integer | NpgsqlDbType.Array));
125          Assert.That(cmd.Parameters[1].DataTypeName, Does.EndWith(domainType + "[]"));
126          Assert.That(cmd.Parameters[2].ParameterName, Is.EqualTo("c"));
127          Assert.That(cmd.Parameters[2].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Integer | NpgsqlDbType.Array));
128          Assert.That(cmd.Parameters[2].DataTypeName, Does.EndWith(domainArrayType));
129          cmd.Parameters[0].Value = val;
130          cmd.Parameters[1].Value = arrayVal;
131          cmd.Parameters[2].Value = arrayVal;
132          using var reader = await cmd.ExecuteReaderAsync();
133          reader.Read();
134          Assert.That(reader.GetFieldValue<int>(0), Is.EqualTo(val));
135          Assert.That(reader.GetFieldValue<int[]>(1), Is.EqualTo(arrayVal));
136          Assert.That(reader.GetFieldValue<int[]>(2), Is.EqualTo(arrayVal));
137      }
138      [Test, Description("Tests parameter derivation for unmapped enum parameters in parameterized queries (CommandType.Text)")]
139      public async Task DeriveParameters_text_unmapped_enum()
140      {
141          using var conn = await OpenConnectionAsync();
142          var type = await GetTempTypeName(conn);
143          await conn.ExecuteNonQueryAsync($@"CREATE TYPE {type} AS ENUM ('Apple', 'Cherry', 'Plum')");
144          conn.ReloadTypes();
145          var cmd = new NpgsqlCommand($"SELECT :x::{type}", conn);
146          const string val1 = "Apple";
147          var val2 = new string[] { "Cherry", "Plum" };
148          NpgsqlCommandBuilder.DeriveParameters(cmd);
149          Assert.That(cmd.Parameters, Has.Count.EqualTo(1));
150          Assert.That(cmd.Parameters[0].ParameterName, Is.EqualTo("x"));
151          Assert.That(cmd.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Unknown));
152          Assert.That(cmd.Parameters[0].PostgresType, Is.InstanceOf<PostgresEnumType>());
153          Assert.That(cmd.Parameters[0].PostgresType!.Name, Is.EqualTo(type));
154          Assert.That(cmd.Parameters[0].DataTypeName, Does.EndWith(type));
155          cmd.Parameters[0].Value = val1;
156          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SingleResult | CommandBehavior.SingleRow);
157          Assert.That(reader.Read(), Is.True);
158          Assert.That(reader.GetString(0), Is.EqualTo(val1));
159      }
160      enum Fruit { Apple, Cherry, Plum }
161      [Test, Description("Tests parameter derivation for mapped enum parameters in parameterized queries (CommandType.Text)")]
162      public async Task DeriveParameters_text_mapped_enum()
163      {
164          await using var adminConnection = await OpenConnectionAsync();
165          var type = await GetTempTypeName(adminConnection);
166          await adminConnection.ExecuteNonQueryAsync($@"CREATE TYPE {type} AS ENUM ('apple', 'cherry', 'plum')");
167          var dataSourceBuilder = CreateDataSourceBuilder();
168          dataSourceBuilder.MapEnum<Fruit>(type);
169          await using var dataSource = dataSourceBuilder.Build();
170          await using var connection = await dataSource.OpenConnectionAsync();
171          var cmd = new NpgsqlCommand($"SELECT :x::{type}, :y::{type}[]", connection);
172          const Fruit val1 = Fruit.Apple;
173          var val2 = new[] { Fruit.Cherry, Fruit.Plum };
174          NpgsqlCommandBuilder.DeriveParameters(cmd);
175          Assert.That(cmd.Parameters, Has.Count.EqualTo(2));
176          Assert.That(cmd.Parameters[0].ParameterName, Is.EqualTo("x"));
177          Assert.That(cmd.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Unknown));
178          Assert.That(cmd.Parameters[0].PostgresType, Is.InstanceOf<PostgresEnumType>());
179          Assert.That(cmd.Parameters[0].DataTypeName, Does.EndWith(type));
180          Assert.That(cmd.Parameters[1].ParameterName, Is.EqualTo("y"));
181          Assert.That(cmd.Parameters[1].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Unknown));
182          Assert.That(cmd.Parameters[1].PostgresType, Is.InstanceOf<PostgresArrayType>());
183          Assert.That(cmd.Parameters[1].DataTypeName, Does.EndWith(type + "[]"));
184          cmd.Parameters[0].Value = val1;
185          cmd.Parameters[1].Value = val2;
186          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SingleResult | CommandBehavior.SingleRow);
187          Assert.That(reader.Read(), Is.True);
188          Assert.That(reader.GetFieldValue<Fruit>(0), Is.EqualTo(val1));
<span onclick='openModal()' class='match'>189          Assert.That(reader.GetFieldValue<Fruit[]>(1), Is.EqualTo(val2));
190      }
</span>191      class SomeComposite
192      {
193          public int X { get; set; }
194          [PgName("some_text")]
195          public string SomeText { get; set; } = "";
196      }
197      [Test]
198      public async Task DeriveParameters_text_mapped_composite()
199      {
200          await using var adminConnection = await OpenConnectionAsync();
201          var type = await GetTempTypeName(adminConnection);
202          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} AS (x int, some_text text)");
203          var dataSourceBuilder = CreateDataSourceBuilder();
204          dataSourceBuilder.MapComposite<SomeComposite>(type);
205          await using var dataSource = dataSourceBuilder.Build();
206          await using var connection = await dataSource.OpenConnectionAsync();
207          var expected1 = new SomeComposite { X = 8, SomeText = "foo" };
208          var expected2 = new[] { expected1, new SomeComposite {X = 9, SomeText = "bar"} };
209          await using var cmd = new NpgsqlCommand($"SELECT @p1::{type}, @p2::{type}[]", connection);
210          NpgsqlCommandBuilder.DeriveParameters(cmd);
211          Assert.That(cmd.Parameters, Has.Count.EqualTo(2));
212          Assert.That(cmd.Parameters[0].ParameterName, Is.EqualTo("p1"));
213          Assert.That(cmd.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Unknown));
214          Assert.That(cmd.Parameters[0].PostgresType, Is.InstanceOf<PostgresCompositeType>());
215          Assert.That(cmd.Parameters[0].DataTypeName, Does.EndWith(type));
216          var p1Fields = ((PostgresCompositeType)cmd.Parameters[0].PostgresType!).Fields;
217          Assert.That(p1Fields[0].Name, Is.EqualTo("x"));
218          Assert.That(p1Fields[1].Name, Is.EqualTo("some_text"));
219          Assert.That(cmd.Parameters[1].ParameterName, Is.EqualTo("p2"));
220          Assert.That(cmd.Parameters[1].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Unknown));
221          Assert.That(cmd.Parameters[1].PostgresType, Is.InstanceOf<PostgresArrayType>());
222          Assert.That(cmd.Parameters[1].DataTypeName, Does.EndWith(type + "[]"));
223          var p2Element = ((PostgresArrayType)cmd.Parameters[1].PostgresType!).Element;
224          Assert.That(p2Element, Is.InstanceOf<PostgresCompositeType>());
225          Assert.That(p2Element.Name, Is.EqualTo(type));
226          var p2Fields = ((PostgresCompositeType)p2Element).Fields;
227          Assert.That(p2Fields[0].Name, Is.EqualTo("x"));
228          Assert.That(p2Fields[1].Name, Is.EqualTo("some_text"));
229          cmd.Parameters[0].Value = expected1;
230          cmd.Parameters[1].Value = expected2;
231          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SingleResult | CommandBehavior.SingleRow);
232          Assert.That(reader.Read(), Is.True);
233          Assert.That(reader.GetFieldValue<SomeComposite>(0).SomeText, Is.EqualTo(expected1.SomeText));
234          Assert.That(reader.GetFieldValue<SomeComposite>(0).X, Is.EqualTo(expected1.X));
235          for (var i = 0; i < 2; i++)
236          {
237              Assert.That(reader.GetFieldValue<SomeComposite[]>(1)[i].SomeText, Is.EqualTo(expected2[i].SomeText));
238              Assert.That(reader.GetFieldValue<SomeComposite[]>(1)[i].X, Is.EqualTo(expected2[i].X));
239          }
240      }
241      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1591")]
242      public async Task Get_update_command_infers_parameters_with_NpgsqDbType()
243      {
244          using var conn = await OpenConnectionAsync();
245          var table = await GetTempTableName(conn);
246          await conn.ExecuteNonQueryAsync($@"
247  CREATE TABLE {table} (
248      Cod varchar(5) NOT NULL,
249      Descr varchar(40),
250      Data date,
251      DataOra timestamp,
252      Intero smallInt NOT NULL,
253      Decimale money,
254      Singolo float,
255      Booleano bit,
256      Nota varchar(255),
257      BigIntArr bigint[],
258      VarCharArr character varying(20)[],
259      PRIMARY KEY (Cod)
260  );
261  INSERT INTO {table} VALUES('key1', 'description', '2018-07-03', '2018-07-03 07:02:00', 123, 123.4, 1234.5, B'1', 'note')");
262          var daDataAdapter =
263              new NpgsqlDataAdapter(
264                  $"SELECT Cod, Descr, Data, DataOra, Intero, Decimale, Singolo, Booleano, Nota, BigIntArr, VarCharArr FROM {table}", conn);
265          var cbCommandBuilder = new NpgsqlCommandBuilder(daDataAdapter);
266          var dtTable = new DataTable();
267          daDataAdapter.InsertCommand = cbCommandBuilder.GetInsertCommand();
268          daDataAdapter.UpdateCommand = cbCommandBuilder.GetUpdateCommand();
269          daDataAdapter.DeleteCommand = cbCommandBuilder.GetDeleteCommand();
270          Assert.That(daDataAdapter.UpdateCommand.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Varchar));
271          Assert.That(daDataAdapter.UpdateCommand.Parameters[1].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Varchar));
272          Assert.That(daDataAdapter.UpdateCommand.Parameters[2].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Date));
273          Assert.That(daDataAdapter.UpdateCommand.Parameters[3].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Timestamp));
274          Assert.That(daDataAdapter.UpdateCommand.Parameters[4].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Smallint));
275          Assert.That(daDataAdapter.UpdateCommand.Parameters[5].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Money));
276          Assert.That(daDataAdapter.UpdateCommand.Parameters[6].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Double));
277          Assert.That(daDataAdapter.UpdateCommand.Parameters[7].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Bit));
278          Assert.That(daDataAdapter.UpdateCommand.Parameters[8].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Varchar));
279          Assert.That(daDataAdapter.UpdateCommand.Parameters[9].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Array | NpgsqlDbType.Bigint));
280          Assert.That(daDataAdapter.UpdateCommand.Parameters[10].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Array | NpgsqlDbType.Varchar));
281          Assert.That(daDataAdapter.UpdateCommand.Parameters[11].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Varchar));
282          Assert.That(daDataAdapter.UpdateCommand.Parameters[13].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Varchar));
283          Assert.That(daDataAdapter.UpdateCommand.Parameters[15].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Date));
284          Assert.That(daDataAdapter.UpdateCommand.Parameters[17].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Timestamp));
285          Assert.That(daDataAdapter.UpdateCommand.Parameters[18].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Smallint));
286          Assert.That(daDataAdapter.UpdateCommand.Parameters[20].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Money));
287          Assert.That(daDataAdapter.UpdateCommand.Parameters[22].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Double));
288          Assert.That(daDataAdapter.UpdateCommand.Parameters[24].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Bit));
289          Assert.That(daDataAdapter.UpdateCommand.Parameters[26].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Varchar));
290          Assert.That(daDataAdapter.UpdateCommand.Parameters[28].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Array | NpgsqlDbType.Bigint));
291          Assert.That(daDataAdapter.UpdateCommand.Parameters[30].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Array | NpgsqlDbType.Varchar));
292          daDataAdapter.Fill(dtTable);
293          var row = dtTable.Rows[0];
294          Assert.That(row[0], Is.EqualTo("key1"));
295          Assert.That(row[1], Is.EqualTo("description"));
296          Assert.That(row[2], Is.EqualTo(new DateTime(2018, 7, 3)));
297          Assert.That(row[3], Is.EqualTo(new DateTime(2018, 7, 3, 7, 2, 0)));
298          Assert.That(row[4], Is.EqualTo(123));
299          Assert.That(row[5], Is.EqualTo(123.4));
300          Assert.That(row[6], Is.EqualTo(1234.5));
301          Assert.That(row[7], Is.EqualTo(true));
302          Assert.That(row[8], Is.EqualTo("note"));
303          dtTable.Rows[0]["Singolo"] = 1.1D;
304          Assert.That(daDataAdapter.Update(dtTable), Is.EqualTo(1));
305      }
306      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2560")]
307      public async Task Get_update_command_with_column_aliases()
308      {
309          using var conn = await OpenConnectionAsync();
310          var table = await CreateTempTable(conn, "Cod varchar(5) PRIMARY KEY, Descr varchar(40), Data date");
311          using var cmd = new NpgsqlCommand($"SELECT Cod as CodAlias, Descr as DescrAlias, Data as DataAlias FROM {table}", conn);
312          using var daDataAdapter = new NpgsqlDataAdapter(cmd);
313          using var cbCommandBuilder = new NpgsqlCommandBuilder(daDataAdapter);
314          daDataAdapter.UpdateCommand = cbCommandBuilder.GetUpdateCommand();
315          Assert.True(daDataAdapter.UpdateCommand.CommandText.Contains("SET \"cod\" = @p1, \"descr\" = @p2, \"data\" = @p3 WHERE ((\"cod\" = @p4) AND ((@p5 = 1 AND \"descr\" IS NULL) OR (\"descr\" = @p6)) AND ((@p7 = 1 AND \"data\" IS NULL) OR (\"data\" = @p8)))"));
316      }
317      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2846")]
318      public async Task Get_update_command_with_array_column_type()
319      {
320          using var conn = await OpenConnectionAsync();
321          var table = await CreateTempTable(conn, "Cod varchar(5) PRIMARY KEY, Vettore character varying(20)[]");
322          using var daDataAdapter = new NpgsqlDataAdapter($"SELECT cod, vettore FROM {table} ORDER By cod", conn);
323          using var cbCommandBuilder = new NpgsqlCommandBuilder(daDataAdapter);
324          var dtTable = new DataTable();
325          cbCommandBuilder.SetAllValues = true;
326          daDataAdapter.UpdateCommand = cbCommandBuilder.GetUpdateCommand();
327          daDataAdapter.Fill(dtTable);
328          dtTable.Rows.Add();
329          dtTable.Rows[0]["cod"] = '0';
330          dtTable.Rows[0]["vettore"] = new[] { "aaa", "bbb" };
331          daDataAdapter.Update(dtTable);
332      }
333  }
</code></pre>
        </div>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-CommandBuilderTests.cs</h3>
            <pre><code>1  using System;
2  using System.Data;
3  using System.Threading.Tasks;
4  using Npgsql.PostgresTypes;
5  using NpgsqlTypes;
6  using NUnit.Framework;
7  using static Npgsql.Tests.TestUtil;
8  namespace Npgsql.Tests;
9  class CommandBuilderTests : TestBase
10  {
11      [Test, Description("Tests parameter derivation for parameterized queries (CommandType.Text)")]
12      public async Task DeriveParameters_text_one_parameter_with_same_type()
13      {
14          using var conn = await OpenConnectionAsync();
15          var table = await CreateTempTable(conn, "id int, val text");
16          var cmd = new NpgsqlCommand(
17              $@"INSERT INTO {table} VALUES(:x, 'some value');
18                      UPDATE {table} SET val = 'changed value' WHERE id = :x;
19                      SELECT val FROM {table} WHERE id = :x;",
20              conn);
21          NpgsqlCommandBuilder.DeriveParameters(cmd);
22          Assert.That(cmd.Parameters, Has.Count.EqualTo(1));
23          Assert.That(cmd.Parameters[0].Direction, Is.EqualTo(ParameterDirection.Input));
24          Assert.That(cmd.Parameters[0].ParameterName, Is.EqualTo("x"));
25          Assert.That(cmd.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Integer));
26          cmd.Parameters[0].Value = 42;
27          var retVal = await cmd.ExecuteScalarAsync();
28          Assert.That(retVal, Is.EqualTo("changed value"));
29      }
30      [Test, Description("Tests parameter derivation for parameterized queries (CommandType.Text) where different types would be inferred for placeholders with the same name.")]
31      public async Task DeriveParameters_text_one_parameter_with_different_types()
32      {
33          using var conn = await OpenConnectionAsync();
34          var table = await CreateTempTable(conn, "id int, val text");
35          var cmd = new NpgsqlCommand(
36              $@"INSERT INTO {table} VALUES(:x, 'some value');
37                      UPDATE {table} SET val = 'changed value' WHERE id = :x::double precision;
38                      SELECT val FROM {table} WHERE id = :x::numeric;",
39              conn);
40          var ex = Assert.Throws<NpgsqlException>(() => NpgsqlCommandBuilder.DeriveParameters(cmd))!;
41          Assert.That(ex.Message, Is.EqualTo("The backend parser inferred different types for parameters with the same name. Please try explicit casting within your SQL statement or batch or use different placeholder names."));
42      }
43      [Test, Description("Tests parameter derivation for parameterized queries (CommandType.Text) with multiple parameters")]
44      public async Task DeriveParameters_multiple_parameters()
45      {
46          using var conn = await OpenConnectionAsync();
47          var table = await CreateTempTable(conn, "id int, val text");
48          var cmd = new NpgsqlCommand(
49              $@"INSERT INTO {table} VALUES(:x, 'some value');
50                      UPDATE {table} SET val = 'changed value' WHERE id = @y::double precision;
51                      SELECT val FROM {table} WHERE id = :z::numeric;",
52              conn);
53          NpgsqlCommandBuilder.DeriveParameters(cmd);
54          Assert.That(cmd.Parameters, Has.Count.EqualTo(3));
55          Assert.That(cmd.Parameters[0].ParameterName, Is.EqualTo("x"));
56          Assert.That(cmd.Parameters[1].ParameterName, Is.EqualTo("y"));
57          Assert.That(cmd.Parameters[2].ParameterName, Is.EqualTo("z"));
58          Assert.That(cmd.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Integer));
59          Assert.That(cmd.Parameters[1].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Double));
60          Assert.That(cmd.Parameters[2].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Numeric));
61          cmd.Parameters[0].Value = 42;
62          cmd.Parameters[1].Value = 42d;
63          cmd.Parameters[2].Value = 42;
64          var retVal = await cmd.ExecuteScalarAsync();
65          Assert.That(retVal, Is.EqualTo("changed value"));
66      }
67      [Test, Description("Tests parameter derivation a parameterized query (CommandType.Text) that is already prepared.")]
68      public async Task DeriveParameters_text_prepared_statement()
69      {
70          const string query = "SELECT @p::integer";
71          const int answer = 42;
72          await using var dataSource = CreateDataSource();
73          await using var conn = await dataSource.OpenConnectionAsync();
74          await using var cmd = new NpgsqlCommand(query, conn);
75          cmd.Parameters.AddWithValue("@p", NpgsqlDbType.Integer, answer);
76          cmd.Prepare();
77          Assert.That(conn.Connector!.PreparedStatementManager.NumPrepared, Is.EqualTo(1));
78          var ex = Assert.Throws<NpgsqlException>(() =>
79          {
80              NpgsqlCommandBuilder.DeriveParameters(cmd);
81          })!;
82          Assert.That(ex.Message, Is.EqualTo("Deriving parameters isn't supported for commands that are already prepared."));
83          Assert.That(cmd.Parameters.Count, Is.EqualTo(1));
84          Assert.That(cmd.Parameters[0].ParameterName, Is.EqualTo("@p"));
85          Assert.That(conn.Connector.PreparedStatementManager.NumPrepared, Is.EqualTo(1));
86          cmd.Parameters["@p"].Value = answer;
87          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(answer));
88      }
89      [Test, Description("Tests parameter derivation for array parameters in parameterized queries (CommandType.Text)")]
90      public async Task DeriveParameters_text_array()
91      {
92          using var conn = await OpenConnectionAsync();
93          var cmd = new NpgsqlCommand("SELECT :a::integer[]", conn);
94          var val = new[] { 7, 42 };
95          NpgsqlCommandBuilder.DeriveParameters(cmd);
96          Assert.That(cmd.Parameters, Has.Count.EqualTo(1));
97          Assert.That(cmd.Parameters[0].ParameterName, Is.EqualTo("a"));
98          Assert.That(cmd.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Integer | NpgsqlDbType.Array));
99          cmd.Parameters[0].Value = val;
100          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SingleResult | CommandBehavior.SingleRow);
101          Assert.That(reader.Read(), Is.True);
102          Assert.That(reader.GetFieldValue<int[]>(0), Is.EqualTo(val));
103      }
104      [Test, Description("Tests parameter derivation for domain parameters in parameterized queries (CommandType.Text)")]
105      public async Task DeriveParameters_text_domain()
106      {
107          using var conn = await OpenConnectionAsync();
108          MinimumPgVersion(conn, "11.0", "Arrays of domains and domains over arrays were introduced in PostgreSQL 11");
109          var domainType = await GetTempTypeName(conn);
110          var domainArrayType = await GetTempTypeName(conn);
111          await conn.ExecuteNonQueryAsync($@"
112  CREATE DOMAIN {domainType} AS integer CHECK (VALUE > 0);
113  CREATE DOMAIN {domainArrayType} AS int[] CHECK(array_length(VALUE, 1) = 2);");
114          conn.ReloadTypes();
115          var cmd = new NpgsqlCommand($"SELECT :a::{domainType}, :b::{domainType}[], :c::{domainArrayType}", conn);
116          var val = 23;
117          var arrayVal = new[] { 7, 42 };
118          NpgsqlCommandBuilder.DeriveParameters(cmd);
119          Assert.That(cmd.Parameters, Has.Count.EqualTo(3));
120          Assert.That(cmd.Parameters[0].ParameterName, Is.EqualTo("a"));
121          Assert.That(cmd.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Integer));
122          Assert.That(cmd.Parameters[0].DataTypeName, Does.EndWith(domainType));
123          Assert.That(cmd.Parameters[1].ParameterName, Is.EqualTo("b"));
124          Assert.That(cmd.Parameters[1].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Integer | NpgsqlDbType.Array));
125          Assert.That(cmd.Parameters[1].DataTypeName, Does.EndWith(domainType + "[]"));
126          Assert.That(cmd.Parameters[2].ParameterName, Is.EqualTo("c"));
127          Assert.That(cmd.Parameters[2].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Integer | NpgsqlDbType.Array));
128          Assert.That(cmd.Parameters[2].DataTypeName, Does.EndWith(domainArrayType));
129          cmd.Parameters[0].Value = val;
130          cmd.Parameters[1].Value = arrayVal;
131          cmd.Parameters[2].Value = arrayVal;
132          using var reader = await cmd.ExecuteReaderAsync();
133          reader.Read();
134          Assert.That(reader.GetFieldValue<int>(0), Is.EqualTo(val));
135          Assert.That(reader.GetFieldValue<int[]>(1), Is.EqualTo(arrayVal));
136          Assert.That(reader.GetFieldValue<int[]>(2), Is.EqualTo(arrayVal));
137      }
138      [Test, Description("Tests parameter derivation for unmapped enum parameters in parameterized queries (CommandType.Text)")]
139      public async Task DeriveParameters_text_unmapped_enum()
140      {
141          using var conn = await OpenConnectionAsync();
142          var type = await GetTempTypeName(conn);
143          await conn.ExecuteNonQueryAsync($@"CREATE TYPE {type} AS ENUM ('Apple', 'Cherry', 'Plum')");
144          conn.ReloadTypes();
145          var cmd = new NpgsqlCommand($"SELECT :x::{type}", conn);
146          const string val1 = "Apple";
147          var val2 = new string[] { "Cherry", "Plum" };
148          NpgsqlCommandBuilder.DeriveParameters(cmd);
149          Assert.That(cmd.Parameters, Has.Count.EqualTo(1));
150          Assert.That(cmd.Parameters[0].ParameterName, Is.EqualTo("x"));
151          Assert.That(cmd.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Unknown));
152          Assert.That(cmd.Parameters[0].PostgresType, Is.InstanceOf<PostgresEnumType>());
153          Assert.That(cmd.Parameters[0].PostgresType!.Name, Is.EqualTo(type));
154          Assert.That(cmd.Parameters[0].DataTypeName, Does.EndWith(type));
155          cmd.Parameters[0].Value = val1;
156          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SingleResult | CommandBehavior.SingleRow);
157          Assert.That(reader.Read(), Is.True);
158          Assert.That(reader.GetString(0), Is.EqualTo(val1));
159      }
160      enum Fruit { Apple, Cherry, Plum }
161      [Test, Description("Tests parameter derivation for mapped enum parameters in parameterized queries (CommandType.Text)")]
162      public async Task DeriveParameters_text_mapped_enum()
163      {
164          await using var adminConnection = await OpenConnectionAsync();
165          var type = await GetTempTypeName(adminConnection);
166          await adminConnection.ExecuteNonQueryAsync($@"CREATE TYPE {type} AS ENUM ('apple', 'cherry', 'plum')");
167          var dataSourceBuilder = CreateDataSourceBuilder();
168          dataSourceBuilder.MapEnum<Fruit>(type);
169          await using var dataSource = dataSourceBuilder.Build();
170          await using var connection = await dataSource.OpenConnectionAsync();
171          var cmd = new NpgsqlCommand($"SELECT :x::{type}, :y::{type}[]", connection);
172          const Fruit val1 = Fruit.Apple;
173          var val2 = new[] { Fruit.Cherry, Fruit.Plum };
174          NpgsqlCommandBuilder.DeriveParameters(cmd);
175          Assert.That(cmd.Parameters, Has.Count.EqualTo(2));
176          Assert.That(cmd.Parameters[0].ParameterName, Is.EqualTo("x"));
177          Assert.That(cmd.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Unknown));
178          Assert.That(cmd.Parameters[0].PostgresType, Is.InstanceOf<PostgresEnumType>());
179          Assert.That(cmd.Parameters[0].DataTypeName, Does.EndWith(type));
180          Assert.That(cmd.Parameters[1].ParameterName, Is.EqualTo("y"));
181          Assert.That(cmd.Parameters[1].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Unknown));
182          Assert.That(cmd.Parameters[1].PostgresType, Is.InstanceOf<PostgresArrayType>());
183          Assert.That(cmd.Parameters[1].DataTypeName, Does.EndWith(type + "[]"));
184          cmd.Parameters[0].Value = val1;
185          cmd.Parameters[1].Value = val2;
186          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SingleResult | CommandBehavior.SingleRow);
187          Assert.That(reader.Read(), Is.True);
188          Assert.That(reader.GetFieldValue<Fruit>(0), Is.EqualTo(val1));
<span onclick='openModal()' class='match'>189          Assert.That(reader.GetFieldValue<Fruit[]>(1), Is.EqualTo(val2));
190      }
</span>191      class SomeComposite
192      {
193          public int X { get; set; }
194          [PgName("some_text")]
195          public string SomeText { get; set; } = "";
196      }
197      [Test]
198      public async Task DeriveParameters_text_mapped_composite()
199      {
200          await using var adminConnection = await OpenConnectionAsync();
201          var type = await GetTempTypeName(adminConnection);
202          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} AS (x int, some_text text)");
203          var dataSourceBuilder = CreateDataSourceBuilder();
204          dataSourceBuilder.MapComposite<SomeComposite>(type);
205          await using var dataSource = dataSourceBuilder.Build();
206          await using var connection = await dataSource.OpenConnectionAsync();
207          var expected1 = new SomeComposite { X = 8, SomeText = "foo" };
208          var expected2 = new[] { expected1, new SomeComposite {X = 9, SomeText = "bar"} };
209          await using var cmd = new NpgsqlCommand($"SELECT @p1::{type}, @p2::{type}[]", connection);
210          NpgsqlCommandBuilder.DeriveParameters(cmd);
211          Assert.That(cmd.Parameters, Has.Count.EqualTo(2));
212          Assert.That(cmd.Parameters[0].ParameterName, Is.EqualTo("p1"));
213          Assert.That(cmd.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Unknown));
214          Assert.That(cmd.Parameters[0].PostgresType, Is.InstanceOf<PostgresCompositeType>());
215          Assert.That(cmd.Parameters[0].DataTypeName, Does.EndWith(type));
216          var p1Fields = ((PostgresCompositeType)cmd.Parameters[0].PostgresType!).Fields;
217          Assert.That(p1Fields[0].Name, Is.EqualTo("x"));
218          Assert.That(p1Fields[1].Name, Is.EqualTo("some_text"));
219          Assert.That(cmd.Parameters[1].ParameterName, Is.EqualTo("p2"));
220          Assert.That(cmd.Parameters[1].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Unknown));
221          Assert.That(cmd.Parameters[1].PostgresType, Is.InstanceOf<PostgresArrayType>());
222          Assert.That(cmd.Parameters[1].DataTypeName, Does.EndWith(type + "[]"));
223          var p2Element = ((PostgresArrayType)cmd.Parameters[1].PostgresType!).Element;
224          Assert.That(p2Element, Is.InstanceOf<PostgresCompositeType>());
225          Assert.That(p2Element.Name, Is.EqualTo(type));
226          var p2Fields = ((PostgresCompositeType)p2Element).Fields;
227          Assert.That(p2Fields[0].Name, Is.EqualTo("x"));
228          Assert.That(p2Fields[1].Name, Is.EqualTo("some_text"));
229          cmd.Parameters[0].Value = expected1;
230          cmd.Parameters[1].Value = expected2;
231          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SingleResult | CommandBehavior.SingleRow);
232          Assert.That(reader.Read(), Is.True);
233          Assert.That(reader.GetFieldValue<SomeComposite>(0).SomeText, Is.EqualTo(expected1.SomeText));
234          Assert.That(reader.GetFieldValue<SomeComposite>(0).X, Is.EqualTo(expected1.X));
235          for (var i = 0; i < 2; i++)
236          {
237              Assert.That(reader.GetFieldValue<SomeComposite[]>(1)[i].SomeText, Is.EqualTo(expected2[i].SomeText));
238              Assert.That(reader.GetFieldValue<SomeComposite[]>(1)[i].X, Is.EqualTo(expected2[i].X));
239          }
240      }
241      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1591")]
242      public async Task Get_update_command_infers_parameters_with_NpgsqDbType()
243      {
244          using var conn = await OpenConnectionAsync();
245          var table = await GetTempTableName(conn);
246          await conn.ExecuteNonQueryAsync($@"
247  CREATE TABLE {table} (
248      Cod varchar(5) NOT NULL,
249      Descr varchar(40),
250      Data date,
251      DataOra timestamp,
252      Intero smallInt NOT NULL,
253      Decimale money,
254      Singolo float,
255      Booleano bit,
256      Nota varchar(255),
257      BigIntArr bigint[],
258      VarCharArr character varying(20)[],
259      PRIMARY KEY (Cod)
260  );
261  INSERT INTO {table} VALUES('key1', 'description', '2018-07-03', '2018-07-03 07:02:00', 123, 123.4, 1234.5, B'1', 'note')");
262          var daDataAdapter =
263              new NpgsqlDataAdapter(
264                  $"SELECT Cod, Descr, Data, DataOra, Intero, Decimale, Singolo, Booleano, Nota, BigIntArr, VarCharArr FROM {table}", conn);
265          var cbCommandBuilder = new NpgsqlCommandBuilder(daDataAdapter);
266          var dtTable = new DataTable();
267          daDataAdapter.InsertCommand = cbCommandBuilder.GetInsertCommand();
268          daDataAdapter.UpdateCommand = cbCommandBuilder.GetUpdateCommand();
269          daDataAdapter.DeleteCommand = cbCommandBuilder.GetDeleteCommand();
270          Assert.That(daDataAdapter.UpdateCommand.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Varchar));
271          Assert.That(daDataAdapter.UpdateCommand.Parameters[1].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Varchar));
272          Assert.That(daDataAdapter.UpdateCommand.Parameters[2].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Date));
273          Assert.That(daDataAdapter.UpdateCommand.Parameters[3].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Timestamp));
274          Assert.That(daDataAdapter.UpdateCommand.Parameters[4].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Smallint));
275          Assert.That(daDataAdapter.UpdateCommand.Parameters[5].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Money));
276          Assert.That(daDataAdapter.UpdateCommand.Parameters[6].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Double));
277          Assert.That(daDataAdapter.UpdateCommand.Parameters[7].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Bit));
278          Assert.That(daDataAdapter.UpdateCommand.Parameters[8].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Varchar));
279          Assert.That(daDataAdapter.UpdateCommand.Parameters[9].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Array | NpgsqlDbType.Bigint));
280          Assert.That(daDataAdapter.UpdateCommand.Parameters[10].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Array | NpgsqlDbType.Varchar));
281          Assert.That(daDataAdapter.UpdateCommand.Parameters[11].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Varchar));
282          Assert.That(daDataAdapter.UpdateCommand.Parameters[13].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Varchar));
283          Assert.That(daDataAdapter.UpdateCommand.Parameters[15].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Date));
284          Assert.That(daDataAdapter.UpdateCommand.Parameters[17].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Timestamp));
285          Assert.That(daDataAdapter.UpdateCommand.Parameters[18].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Smallint));
286          Assert.That(daDataAdapter.UpdateCommand.Parameters[20].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Money));
287          Assert.That(daDataAdapter.UpdateCommand.Parameters[22].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Double));
288          Assert.That(daDataAdapter.UpdateCommand.Parameters[24].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Bit));
289          Assert.That(daDataAdapter.UpdateCommand.Parameters[26].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Varchar));
290          Assert.That(daDataAdapter.UpdateCommand.Parameters[28].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Array | NpgsqlDbType.Bigint));
291          Assert.That(daDataAdapter.UpdateCommand.Parameters[30].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Array | NpgsqlDbType.Varchar));
292          daDataAdapter.Fill(dtTable);
293          var row = dtTable.Rows[0];
294          Assert.That(row[0], Is.EqualTo("key1"));
295          Assert.That(row[1], Is.EqualTo("description"));
296          Assert.That(row[2], Is.EqualTo(new DateTime(2018, 7, 3)));
297          Assert.That(row[3], Is.EqualTo(new DateTime(2018, 7, 3, 7, 2, 0)));
298          Assert.That(row[4], Is.EqualTo(123));
299          Assert.That(row[5], Is.EqualTo(123.4));
300          Assert.That(row[6], Is.EqualTo(1234.5));
301          Assert.That(row[7], Is.EqualTo(true));
302          Assert.That(row[8], Is.EqualTo("note"));
303          dtTable.Rows[0]["Singolo"] = 1.1D;
304          Assert.That(daDataAdapter.Update(dtTable), Is.EqualTo(1));
305      }
306      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2560")]
307      public async Task Get_update_command_with_column_aliases()
308      {
309          using var conn = await OpenConnectionAsync();
310          var table = await CreateTempTable(conn, "Cod varchar(5) PRIMARY KEY, Descr varchar(40), Data date");
311          using var cmd = new NpgsqlCommand($"SELECT Cod as CodAlias, Descr as DescrAlias, Data as DataAlias FROM {table}", conn);
312          using var daDataAdapter = new NpgsqlDataAdapter(cmd);
313          using var cbCommandBuilder = new NpgsqlCommandBuilder(daDataAdapter);
314          daDataAdapter.UpdateCommand = cbCommandBuilder.GetUpdateCommand();
315          Assert.True(daDataAdapter.UpdateCommand.CommandText.Contains("SET \"cod\" = @p1, \"descr\" = @p2, \"data\" = @p3 WHERE ((\"cod\" = @p4) AND ((@p5 = 1 AND \"descr\" IS NULL) OR (\"descr\" = @p6)) AND ((@p7 = 1 AND \"data\" IS NULL) OR (\"data\" = @p8)))"));
316      }
317      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2846")]
318      public async Task Get_update_command_with_array_column_type()
319      {
320          using var conn = await OpenConnectionAsync();
321          var table = await CreateTempTable(conn, "Cod varchar(5) PRIMARY KEY, Vettore character varying(20)[]");
322          using var daDataAdapter = new NpgsqlDataAdapter($"SELECT cod, vettore FROM {table} ORDER By cod", conn);
323          using var cbCommandBuilder = new NpgsqlCommandBuilder(daDataAdapter);
324          var dtTable = new DataTable();
325          cbCommandBuilder.SetAllValues = true;
326          daDataAdapter.UpdateCommand = cbCommandBuilder.GetUpdateCommand();
327          daDataAdapter.Fill(dtTable);
328          dtTable.Rows.Add();
329          dtTable.Rows[0]["cod"] = '0';
330          dtTable.Rows[0]["vettore"] = new[] { "aaa", "bbb" };
331          daDataAdapter.Update(dtTable);
332      }
333  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-CommandBuilderTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-CommandBuilderTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>189          Assert.That(reader.GetFieldValue<Fruit[]>(1), Is.EqualTo(val2));
190      }
</pre></code></div>
                <div class="column column_space"><pre><code>189          Assert.That(reader.GetFieldValue<Fruit[]>(1), Is.EqualTo(val2));
190      }
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    