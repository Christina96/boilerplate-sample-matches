
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 33, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-CompositeTests.cs</h3>
            <pre><code>1  using System;
2  using System.Linq;
3  using System.Threading.Tasks;
4  using Npgsql.PostgresTypes;
5  using NpgsqlTypes;
6  using NUnit.Framework;
7  using static Npgsql.Tests.TestUtil;
8  namespace Npgsql.Tests.Types;
9  public class CompositeTests : MultiplexingTestBase
10  {
11      [Test]
12      public async Task Basic()
13      {
14          await using var adminConnection = await OpenConnectionAsync();
15          var type = await GetTempTypeName(adminConnection);
16          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} AS (x int, some_text text)");
17          var dataSourceBuilder = CreateDataSourceBuilder();
18          dataSourceBuilder.MapComposite<SomeComposite>(type);
19          await using var dataSource = dataSourceBuilder.Build();
20          await using var connection = await dataSource.OpenConnectionAsync();
21          await AssertType(
22              connection,
23              new SomeComposite { SomeText = "foo", X = 8 },
24              "(8,foo)",
25              type,
26              npgsqlDbType: null);
27      }
28  #pragma warning disable CS0618 
29      [Test, NonParallelizable]
30      public async Task Global_mapping()
31      {
32          await using var adminConnection = await OpenConnectionAsync();
33          var type = await GetTempTypeName(adminConnection);
34          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} AS (x int, some_text text)");
35          NpgsqlConnection.GlobalTypeMapper.MapComposite<SomeComposite>(type);
36          try
37          {
38              var dataSourceBuilder = CreateDataSourceBuilder();
39              dataSourceBuilder.MapComposite<SomeComposite>(type);
40              await using var dataSource = dataSourceBuilder.Build();
41              await using var connection = await dataSource.OpenConnectionAsync();
42              await connection.ReloadTypesAsync();
43              await AssertType(
44                  connection,
45                  new SomeComposite { SomeText = "foo", X = 8 },
46                  "(8,foo)",
47                  type,
48                  npgsqlDbType: null);
49          }
50          finally
51          {
52              NpgsqlConnection.GlobalTypeMapper.Reset();
53          }
54      }
55  #pragma warning restore CS0618 
56      [Test]
57      public async Task Nested()
58      {
59          await using var adminConnection = await OpenConnectionAsync();
60          var containerType = await GetTempTypeName(adminConnection);
61          var containeeType = await GetTempTypeName(adminConnection);
62          await adminConnection.ExecuteNonQueryAsync($@"
63  CREATE TYPE {containeeType} AS (x int, some_text text);
64  CREATE TYPE {containerType} AS (a int, containee {containeeType});");
65          var dataSourceBuilder = CreateDataSourceBuilder();
66          dataSourceBuilder
67              .MapComposite<SomeCompositeContainer>(containerType)
68              .MapComposite<SomeComposite>(containeeType);
69          await using var dataSource = dataSourceBuilder.Build();
70          await using var connection = await dataSource.OpenConnectionAsync();
71          await AssertType(
72              connection,
73              new SomeCompositeContainer { A = 8, Containee = new() { SomeText = "foo", X = 9 } },
74              @"(8,""(9,foo)"")",
75              containerType,
76              npgsqlDbType: null);
77      }
78      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1168")]
79      public async Task With_schema()
80      {
81          await using var adminConnection = await OpenConnectionAsync();
82          var schema = await CreateTempSchema(adminConnection);
83          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {schema}.some_composite AS (x int, some_text text)");
84          var dataSourceBuilder = CreateDataSourceBuilder();
85          dataSourceBuilder.MapComposite<SomeComposite>($"{schema}.some_composite");
86          await using var dataSource = dataSourceBuilder.Build();
87          await using var connection = await dataSource.OpenConnectionAsync();
88          await AssertType(
89              connection,
90              new SomeComposite { SomeText = "foo", X = 8 },
91              "(8,foo)",
92              $"{schema}.some_composite",
93              npgsqlDbType: null);
94      }
95      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4365")]
96      public async Task In_different_schemas_same_type_with_nested()
97      {
98          await using var adminConnection = await OpenConnectionAsync();
99          var firstSchemaName = await CreateTempSchema(adminConnection);
100          var secondSchemaName = await CreateTempSchema(adminConnection);
101          await adminConnection.ExecuteNonQueryAsync($@"
102  CREATE TYPE {firstSchemaName}.containee AS (x int, some_text text);
103  CREATE TYPE {firstSchemaName}.container AS (a int, containee {firstSchemaName}.containee);
104  CREATE TYPE {secondSchemaName}.containee AS (x int, some_text text);
105  CREATE TYPE {secondSchemaName}.container AS (a int, containee {secondSchemaName}.containee);");
106          var dataSourceBuilder = CreateDataSourceBuilder();
107          dataSourceBuilder
108              .MapComposite<SomeComposite>($"{firstSchemaName}.containee")
109              .MapComposite<SomeCompositeContainer>($"{firstSchemaName}.container")
110              .MapComposite<SomeComposite>($"{secondSchemaName}.containee")
111              .MapComposite<SomeCompositeContainer>($"{secondSchemaName}.container");
112          await using var dataSource = dataSourceBuilder.Build();
113          await using var connection = await dataSource.OpenConnectionAsync();
114          await AssertType(
115              connection,
116              new SomeCompositeContainer { A = 8, Containee = new() { SomeText = "foo", X = 9 } },
117              @"(8,""(9,foo)"")",
118              $"{secondSchemaName}.container",
119              npgsqlDbType: null);
<span onclick='openModal()' class='match'>120          await AssertType(
121              connection,
122              new SomeCompositeContainer { A = 8, Containee = new() { SomeText = "foo", X = 9 } },
123              @"(8,""(9,foo)"")",
124              $"{firstSchemaName}.container",
</span>125              npgsqlDbType: null,
126              isDefaultForWriting: false);
127      }
128      [Test]
129      public async Task Struct()
130      {
131          await using var adminConnection = await OpenConnectionAsync();
132          var type = await GetTempTypeName(adminConnection);
133          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} AS (x int, some_text text)");
134          var dataSourceBuilder = CreateDataSourceBuilder();
135          dataSourceBuilder.MapComposite<SomeCompositeStruct>(type);
136          await using var dataSource = dataSourceBuilder.Build();
137          await using var connection = await dataSource.OpenConnectionAsync();
138          await AssertType(
139              connection,
140              new SomeCompositeStruct { SomeText = "foo", X = 8 },
141              "(8,foo)",
142              type,
143              npgsqlDbType: null);
144      }
145      [Test]
146      public async Task Array()
147      {
148          await using var adminConnection = await OpenConnectionAsync();
149          var type = await GetTempTypeName(adminConnection);
150          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} AS (x int, some_text text)");
151          var dataSourceBuilder = CreateDataSourceBuilder();
152          dataSourceBuilder.MapComposite<SomeComposite>(type);
153          await using var dataSource = dataSourceBuilder.Build();
154          await using var connection = await dataSource.OpenConnectionAsync();
155          await AssertType(
156              connection,
157              new SomeComposite[] { new() { SomeText = "foo", X = 8 }, new() { SomeText = "bar", X = 9 }},
158              @"{""(8,foo)"",""(9,bar)""}",
159              type + "[]",
160              npgsqlDbType: null);
161      }
162      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/859")]
163      public async Task Name_translation()
164      {
165          await using var adminConnection = await OpenConnectionAsync();
166          var type = await GetTempTypeName(adminConnection);
167          await adminConnection.ExecuteNonQueryAsync(@$"
168  CREATE TYPE {type} AS (simple int, two_words int, some_database_name int)");
169          var dataSourceBuilder = CreateDataSourceBuilder();
170          dataSourceBuilder.MapComposite<NameTranslationComposite>(type);
171          await using var dataSource = dataSourceBuilder.Build();
172          await using var connection = await dataSource.OpenConnectionAsync();
173          await AssertType(
174              connection,
175              new NameTranslationComposite { Simple = 2, TwoWords = 3, SomeClrName = 4 },
176              "(2,3,4)",
177              type,
178              npgsqlDbType: null);
179      }
180      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/856")]
181      public async Task Composite_containing_domain_type()
182      {
183          await using var adminConnection = await OpenConnectionAsync();
184          var domainType = await GetTempTypeName(adminConnection);
185          var compositeType = await GetTempTypeName(adminConnection);
186          await adminConnection.ExecuteNonQueryAsync($@"
187  CREATE DOMAIN {domainType} AS TEXT;
188  CREATE TYPE {compositeType} AS (street TEXT, postal_code {domainType})");
189          var dataSourceBuilder = CreateDataSourceBuilder();
190          dataSourceBuilder.MapComposite<Address>(compositeType);
191          await using var dataSource = dataSourceBuilder.Build();
192          await using var connection = await dataSource.OpenConnectionAsync();
193          await AssertType(
194              connection,
195              new Address { PostalCode = "12345", Street = "Main St." },
196              @"(""Main St."",12345)",
197              compositeType,
198              npgsqlDbType: null);
199      }
200      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/990")]
201      public async Task Table_as_composite([Values] bool enabled)
202      {
203          await using var adminConnection = await OpenConnectionAsync();
204          var table = await CreateTempTable(adminConnection, "x int, some_text text");
205          var dataSourceBuilder = CreateDataSourceBuilder();
206          dataSourceBuilder.MapComposite<SomeComposite>(table);
207          if (enabled)
208              dataSourceBuilder.ConnectionStringBuilder.LoadTableComposites = true;
209          await using var dataSource = dataSourceBuilder.Build();
210          await using var connection = await dataSource.OpenConnectionAsync();
211          if (enabled)
212              await DoAssertion();
213          else
214          {
215              Assert.ThrowsAsync<ArgumentException>(DoAssertion);
216              await using var tx = await connection.BeginTransactionAsync();
217              Assert.Null(connection.Connector!.DatabaseInfo.CompositeTypes.SingleOrDefault(c => c.Name.Contains(table)));
218              Assert.Null(connection.Connector!.DatabaseInfo.ArrayTypes.SingleOrDefault(c => c.Name.Contains(table)));
219          }
220          Task DoAssertion()
221              => AssertType(
222              connection,
223              new SomeComposite { SomeText = "foo", X = 8 },
224              "(8,foo)",
225              table,
226              npgsqlDbType: null);
227      }
228      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1267")]
229      public async Task Table_as_composite_with_deleted_columns()
230      {
231          await using var adminConnection = await OpenConnectionAsync();
232          var table = await CreateTempTable(adminConnection, "x int, some_text text, bar int");
233          await adminConnection.ExecuteNonQueryAsync($"ALTER TABLE {table} DROP COLUMN bar;");
234          var dataSourceBuilder = CreateDataSourceBuilder();
235          dataSourceBuilder.ConnectionStringBuilder.LoadTableComposites = true;
236          dataSourceBuilder.MapComposite<SomeComposite>(table);
237          await using var dataSource = dataSourceBuilder.Build();
238          await using var connection = await dataSource.OpenConnectionAsync();
239          await AssertType(
240              connection,
241              new SomeComposite { SomeText = "foo", X = 8 },
242              "(8,foo)",
243              table,
244              npgsqlDbType: null);
245      }
246      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1125")]
247      public async Task Nullable_property_in_class_composite()
248      {
249          await using var adminConnection = await OpenConnectionAsync();
250          var type = await GetTempTypeName(adminConnection);
251          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} AS (foo INT)");
252          var dataSourceBuilder = CreateDataSourceBuilder();
253          dataSourceBuilder.MapComposite<ClassWithNullableProperty>(type);
254          await using var dataSource = dataSourceBuilder.Build();
255          await using var connection = await dataSource.OpenConnectionAsync();
256          await AssertType(
257              connection,
258              new ClassWithNullableProperty { Foo = 8 },
259              "(8)",
260              type,
261              npgsqlDbType: null);
262          await AssertType(
263              connection,
264              new ClassWithNullableProperty { Foo = null },
265              "()",
266              type,
267              npgsqlDbType: null);
268      }
269      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1125")]
270      public async Task Nullable_property_in_struct_composite()
271      {
272          await using var adminConnection = await OpenConnectionAsync();
273          var type = await GetTempTypeName(adminConnection);
274          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} AS (foo INT)");
275          var dataSourceBuilder = CreateDataSourceBuilder();
276          dataSourceBuilder.MapComposite<StructWithNullableProperty>(type);
277          await using var dataSource = dataSourceBuilder.Build();
278          await using var connection = await dataSource.OpenConnectionAsync();
279          await AssertType(
280              connection,
281              new StructWithNullableProperty { Foo = 8 },
282              "(8)",
283              type,
284              npgsqlDbType: null);
285          await AssertType(
286              connection,
287              new StructWithNullableProperty { Foo = null },
288              "()",
289              type,
290              npgsqlDbType: null);
291      }
292      [Test]
293      public async Task PostgresType()
294      {
295          await using var connection = await OpenConnectionAsync();
296          var type1 = await GetTempTypeName(connection);
297          var type2 = await GetTempTypeName(connection);
298          await connection.ExecuteNonQueryAsync(@$"
299  CREATE TYPE {type1} AS (x int, some_text text);
300  CREATE TYPE {type2} AS (comp {type1}, comps {type1}[]);");
301          await connection.ReloadTypesAsync();
302          await using var cmd = new NpgsqlCommand(
303              $"SELECT ROW(ROW(8, 'foo')::{type1}, ARRAY[ROW(9, 'bar')::{type1}, ROW(10, 'baz')::{type1}])::{type2}",
304              connection);
305          await using var reader = await cmd.ExecuteReaderAsync();
306          await reader.ReadAsync();
307          var comp2Type = (PostgresCompositeType)reader.GetPostgresType(0);
308          Assert.That(comp2Type.Name, Is.EqualTo(type2));
309          Assert.That(comp2Type.FullName, Is.EqualTo($"public.{type2}"));
310          Assert.That(comp2Type.Fields, Has.Count.EqualTo(2));
311          var field1 = comp2Type.Fields[0];
312          var field2 = comp2Type.Fields[1];
313          Assert.That(field1.Name, Is.EqualTo("comp"));
314          Assert.That(field2.Name, Is.EqualTo("comps"));
315          var comp1Type = (PostgresCompositeType)field1.Type;
316          Assert.That(comp1Type.Name, Is.EqualTo(type1));
317          var arrType = (PostgresArrayType)field2.Type;
318          Assert.That(arrType.Name, Is.EqualTo(type1 + "[]"));
319          var elemType = arrType.Element;
320          Assert.That(elemType, Is.SameAs(comp1Type));
321      }
322      #region Test Types
323      record SomeComposite
324      {
325          public int X { get; set; }
326          public string SomeText { get; set; } = null!;
327      }
328      record SomeCompositeContainer
329      {
330          public int A { get; set; }
331          public SomeComposite Containee { get; set; }  = null!;
332      }
333      struct SomeCompositeStruct
334      {
335          public int X { get; set; }
336          public string SomeText { get; set; }
337      }
338      record NameTranslationComposite
339      {
340          public int Simple { get; set; }
341          public int TwoWords { get; set; }
342          [PgName("some_database_name")]
343          public int SomeClrName { get; set; }
344      }
345      record Address
346      {
347          public string Street { get; set; } = default!;
348          public string PostalCode { get; set; } = default!;
349      }
350      record ClassWithNullableProperty
351      {
352          public int? Foo { get; set; }
353      }
354      struct StructWithNullableProperty
355      {
356          public int? Foo { get; set; }
357      }
358      public CompositeTests(MultiplexingMode multiplexingMode) : base(multiplexingMode) {}
359      #endregion
360  }
</code></pre>
        </div>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-CompositeTests.cs</h3>
            <pre><code>1  using System;
2  using System.Linq;
3  using System.Threading.Tasks;
4  using Npgsql.PostgresTypes;
5  using NpgsqlTypes;
6  using NUnit.Framework;
7  using static Npgsql.Tests.TestUtil;
8  namespace Npgsql.Tests.Types;
9  public class CompositeTests : MultiplexingTestBase
10  {
11      [Test]
12      public async Task Basic()
13      {
14          await using var adminConnection = await OpenConnectionAsync();
15          var type = await GetTempTypeName(adminConnection);
16          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} AS (x int, some_text text)");
17          var dataSourceBuilder = CreateDataSourceBuilder();
18          dataSourceBuilder.MapComposite<SomeComposite>(type);
19          await using var dataSource = dataSourceBuilder.Build();
20          await using var connection = await dataSource.OpenConnectionAsync();
21          await AssertType(
22              connection,
23              new SomeComposite { SomeText = "foo", X = 8 },
24              "(8,foo)",
25              type,
26              npgsqlDbType: null);
27      }
28  #pragma warning disable CS0618 
29      [Test, NonParallelizable]
30      public async Task Global_mapping()
31      {
32          await using var adminConnection = await OpenConnectionAsync();
33          var type = await GetTempTypeName(adminConnection);
34          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} AS (x int, some_text text)");
35          NpgsqlConnection.GlobalTypeMapper.MapComposite<SomeComposite>(type);
36          try
37          {
38              var dataSourceBuilder = CreateDataSourceBuilder();
39              dataSourceBuilder.MapComposite<SomeComposite>(type);
40              await using var dataSource = dataSourceBuilder.Build();
41              await using var connection = await dataSource.OpenConnectionAsync();
42              await connection.ReloadTypesAsync();
43              await AssertType(
44                  connection,
45                  new SomeComposite { SomeText = "foo", X = 8 },
46                  "(8,foo)",
47                  type,
48                  npgsqlDbType: null);
49          }
50          finally
51          {
52              NpgsqlConnection.GlobalTypeMapper.Reset();
53          }
54      }
55  #pragma warning restore CS0618 
56      [Test]
57      public async Task Nested()
58      {
59          await using var adminConnection = await OpenConnectionAsync();
60          var containerType = await GetTempTypeName(adminConnection);
61          var containeeType = await GetTempTypeName(adminConnection);
62          await adminConnection.ExecuteNonQueryAsync($@"
63  CREATE TYPE {containeeType} AS (x int, some_text text);
64  CREATE TYPE {containerType} AS (a int, containee {containeeType});");
65          var dataSourceBuilder = CreateDataSourceBuilder();
66          dataSourceBuilder
67              .MapComposite<SomeCompositeContainer>(containerType)
68              .MapComposite<SomeComposite>(containeeType);
69          await using var dataSource = dataSourceBuilder.Build();
70          await using var connection = await dataSource.OpenConnectionAsync();
71          await AssertType(
72              connection,
73              new SomeCompositeContainer { A = 8, Containee = new() { SomeText = "foo", X = 9 } },
74              @"(8,""(9,foo)"")",
75              containerType,
76              npgsqlDbType: null);
77      }
78      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1168")]
79      public async Task With_schema()
80      {
81          await using var adminConnection = await OpenConnectionAsync();
82          var schema = await CreateTempSchema(adminConnection);
83          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {schema}.some_composite AS (x int, some_text text)");
84          var dataSourceBuilder = CreateDataSourceBuilder();
85          dataSourceBuilder.MapComposite<SomeComposite>($"{schema}.some_composite");
86          await using var dataSource = dataSourceBuilder.Build();
87          await using var connection = await dataSource.OpenConnectionAsync();
88          await AssertType(
89              connection,
90              new SomeComposite { SomeText = "foo", X = 8 },
91              "(8,foo)",
92              $"{schema}.some_composite",
93              npgsqlDbType: null);
94      }
95      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4365")]
96      public async Task In_different_schemas_same_type_with_nested()
97      {
98          await using var adminConnection = await OpenConnectionAsync();
99          var firstSchemaName = await CreateTempSchema(adminConnection);
100          var secondSchemaName = await CreateTempSchema(adminConnection);
101          await adminConnection.ExecuteNonQueryAsync($@"
102  CREATE TYPE {firstSchemaName}.containee AS (x int, some_text text);
103  CREATE TYPE {firstSchemaName}.container AS (a int, containee {firstSchemaName}.containee);
104  CREATE TYPE {secondSchemaName}.containee AS (x int, some_text text);
105  CREATE TYPE {secondSchemaName}.container AS (a int, containee {secondSchemaName}.containee);");
106          var dataSourceBuilder = CreateDataSourceBuilder();
107          dataSourceBuilder
108              .MapComposite<SomeComposite>($"{firstSchemaName}.containee")
109              .MapComposite<SomeCompositeContainer>($"{firstSchemaName}.container")
110              .MapComposite<SomeComposite>($"{secondSchemaName}.containee")
111              .MapComposite<SomeCompositeContainer>($"{secondSchemaName}.container");
112          await using var dataSource = dataSourceBuilder.Build();
113          await using var connection = await dataSource.OpenConnectionAsync();
<span onclick='openModal()' class='match'>114          await AssertType(
115              connection,
116              new SomeCompositeContainer { A = 8, Containee = new() { SomeText = "foo", X = 9 } },
117              @"(8,""(9,foo)"")",
118              $"{secondSchemaName}.container",
</span>119              npgsqlDbType: null);
120          await AssertType(
121              connection,
122              new SomeCompositeContainer { A = 8, Containee = new() { SomeText = "foo", X = 9 } },
123              @"(8,""(9,foo)"")",
124              $"{firstSchemaName}.container",
125              npgsqlDbType: null,
126              isDefaultForWriting: false);
127      }
128      [Test]
129      public async Task Struct()
130      {
131          await using var adminConnection = await OpenConnectionAsync();
132          var type = await GetTempTypeName(adminConnection);
133          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} AS (x int, some_text text)");
134          var dataSourceBuilder = CreateDataSourceBuilder();
135          dataSourceBuilder.MapComposite<SomeCompositeStruct>(type);
136          await using var dataSource = dataSourceBuilder.Build();
137          await using var connection = await dataSource.OpenConnectionAsync();
138          await AssertType(
139              connection,
140              new SomeCompositeStruct { SomeText = "foo", X = 8 },
141              "(8,foo)",
142              type,
143              npgsqlDbType: null);
144      }
145      [Test]
146      public async Task Array()
147      {
148          await using var adminConnection = await OpenConnectionAsync();
149          var type = await GetTempTypeName(adminConnection);
150          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} AS (x int, some_text text)");
151          var dataSourceBuilder = CreateDataSourceBuilder();
152          dataSourceBuilder.MapComposite<SomeComposite>(type);
153          await using var dataSource = dataSourceBuilder.Build();
154          await using var connection = await dataSource.OpenConnectionAsync();
155          await AssertType(
156              connection,
157              new SomeComposite[] { new() { SomeText = "foo", X = 8 }, new() { SomeText = "bar", X = 9 }},
158              @"{""(8,foo)"",""(9,bar)""}",
159              type + "[]",
160              npgsqlDbType: null);
161      }
162      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/859")]
163      public async Task Name_translation()
164      {
165          await using var adminConnection = await OpenConnectionAsync();
166          var type = await GetTempTypeName(adminConnection);
167          await adminConnection.ExecuteNonQueryAsync(@$"
168  CREATE TYPE {type} AS (simple int, two_words int, some_database_name int)");
169          var dataSourceBuilder = CreateDataSourceBuilder();
170          dataSourceBuilder.MapComposite<NameTranslationComposite>(type);
171          await using var dataSource = dataSourceBuilder.Build();
172          await using var connection = await dataSource.OpenConnectionAsync();
173          await AssertType(
174              connection,
175              new NameTranslationComposite { Simple = 2, TwoWords = 3, SomeClrName = 4 },
176              "(2,3,4)",
177              type,
178              npgsqlDbType: null);
179      }
180      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/856")]
181      public async Task Composite_containing_domain_type()
182      {
183          await using var adminConnection = await OpenConnectionAsync();
184          var domainType = await GetTempTypeName(adminConnection);
185          var compositeType = await GetTempTypeName(adminConnection);
186          await adminConnection.ExecuteNonQueryAsync($@"
187  CREATE DOMAIN {domainType} AS TEXT;
188  CREATE TYPE {compositeType} AS (street TEXT, postal_code {domainType})");
189          var dataSourceBuilder = CreateDataSourceBuilder();
190          dataSourceBuilder.MapComposite<Address>(compositeType);
191          await using var dataSource = dataSourceBuilder.Build();
192          await using var connection = await dataSource.OpenConnectionAsync();
193          await AssertType(
194              connection,
195              new Address { PostalCode = "12345", Street = "Main St." },
196              @"(""Main St."",12345)",
197              compositeType,
198              npgsqlDbType: null);
199      }
200      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/990")]
201      public async Task Table_as_composite([Values] bool enabled)
202      {
203          await using var adminConnection = await OpenConnectionAsync();
204          var table = await CreateTempTable(adminConnection, "x int, some_text text");
205          var dataSourceBuilder = CreateDataSourceBuilder();
206          dataSourceBuilder.MapComposite<SomeComposite>(table);
207          if (enabled)
208              dataSourceBuilder.ConnectionStringBuilder.LoadTableComposites = true;
209          await using var dataSource = dataSourceBuilder.Build();
210          await using var connection = await dataSource.OpenConnectionAsync();
211          if (enabled)
212              await DoAssertion();
213          else
214          {
215              Assert.ThrowsAsync<ArgumentException>(DoAssertion);
216              await using var tx = await connection.BeginTransactionAsync();
217              Assert.Null(connection.Connector!.DatabaseInfo.CompositeTypes.SingleOrDefault(c => c.Name.Contains(table)));
218              Assert.Null(connection.Connector!.DatabaseInfo.ArrayTypes.SingleOrDefault(c => c.Name.Contains(table)));
219          }
220          Task DoAssertion()
221              => AssertType(
222              connection,
223              new SomeComposite { SomeText = "foo", X = 8 },
224              "(8,foo)",
225              table,
226              npgsqlDbType: null);
227      }
228      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1267")]
229      public async Task Table_as_composite_with_deleted_columns()
230      {
231          await using var adminConnection = await OpenConnectionAsync();
232          var table = await CreateTempTable(adminConnection, "x int, some_text text, bar int");
233          await adminConnection.ExecuteNonQueryAsync($"ALTER TABLE {table} DROP COLUMN bar;");
234          var dataSourceBuilder = CreateDataSourceBuilder();
235          dataSourceBuilder.ConnectionStringBuilder.LoadTableComposites = true;
236          dataSourceBuilder.MapComposite<SomeComposite>(table);
237          await using var dataSource = dataSourceBuilder.Build();
238          await using var connection = await dataSource.OpenConnectionAsync();
239          await AssertType(
240              connection,
241              new SomeComposite { SomeText = "foo", X = 8 },
242              "(8,foo)",
243              table,
244              npgsqlDbType: null);
245      }
246      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1125")]
247      public async Task Nullable_property_in_class_composite()
248      {
249          await using var adminConnection = await OpenConnectionAsync();
250          var type = await GetTempTypeName(adminConnection);
251          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} AS (foo INT)");
252          var dataSourceBuilder = CreateDataSourceBuilder();
253          dataSourceBuilder.MapComposite<ClassWithNullableProperty>(type);
254          await using var dataSource = dataSourceBuilder.Build();
255          await using var connection = await dataSource.OpenConnectionAsync();
256          await AssertType(
257              connection,
258              new ClassWithNullableProperty { Foo = 8 },
259              "(8)",
260              type,
261              npgsqlDbType: null);
262          await AssertType(
263              connection,
264              new ClassWithNullableProperty { Foo = null },
265              "()",
266              type,
267              npgsqlDbType: null);
268      }
269      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1125")]
270      public async Task Nullable_property_in_struct_composite()
271      {
272          await using var adminConnection = await OpenConnectionAsync();
273          var type = await GetTempTypeName(adminConnection);
274          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} AS (foo INT)");
275          var dataSourceBuilder = CreateDataSourceBuilder();
276          dataSourceBuilder.MapComposite<StructWithNullableProperty>(type);
277          await using var dataSource = dataSourceBuilder.Build();
278          await using var connection = await dataSource.OpenConnectionAsync();
279          await AssertType(
280              connection,
281              new StructWithNullableProperty { Foo = 8 },
282              "(8)",
283              type,
284              npgsqlDbType: null);
285          await AssertType(
286              connection,
287              new StructWithNullableProperty { Foo = null },
288              "()",
289              type,
290              npgsqlDbType: null);
291      }
292      [Test]
293      public async Task PostgresType()
294      {
295          await using var connection = await OpenConnectionAsync();
296          var type1 = await GetTempTypeName(connection);
297          var type2 = await GetTempTypeName(connection);
298          await connection.ExecuteNonQueryAsync(@$"
299  CREATE TYPE {type1} AS (x int, some_text text);
300  CREATE TYPE {type2} AS (comp {type1}, comps {type1}[]);");
301          await connection.ReloadTypesAsync();
302          await using var cmd = new NpgsqlCommand(
303              $"SELECT ROW(ROW(8, 'foo')::{type1}, ARRAY[ROW(9, 'bar')::{type1}, ROW(10, 'baz')::{type1}])::{type2}",
304              connection);
305          await using var reader = await cmd.ExecuteReaderAsync();
306          await reader.ReadAsync();
307          var comp2Type = (PostgresCompositeType)reader.GetPostgresType(0);
308          Assert.That(comp2Type.Name, Is.EqualTo(type2));
309          Assert.That(comp2Type.FullName, Is.EqualTo($"public.{type2}"));
310          Assert.That(comp2Type.Fields, Has.Count.EqualTo(2));
311          var field1 = comp2Type.Fields[0];
312          var field2 = comp2Type.Fields[1];
313          Assert.That(field1.Name, Is.EqualTo("comp"));
314          Assert.That(field2.Name, Is.EqualTo("comps"));
315          var comp1Type = (PostgresCompositeType)field1.Type;
316          Assert.That(comp1Type.Name, Is.EqualTo(type1));
317          var arrType = (PostgresArrayType)field2.Type;
318          Assert.That(arrType.Name, Is.EqualTo(type1 + "[]"));
319          var elemType = arrType.Element;
320          Assert.That(elemType, Is.SameAs(comp1Type));
321      }
322      #region Test Types
323      record SomeComposite
324      {
325          public int X { get; set; }
326          public string SomeText { get; set; } = null!;
327      }
328      record SomeCompositeContainer
329      {
330          public int A { get; set; }
331          public SomeComposite Containee { get; set; }  = null!;
332      }
333      struct SomeCompositeStruct
334      {
335          public int X { get; set; }
336          public string SomeText { get; set; }
337      }
338      record NameTranslationComposite
339      {
340          public int Simple { get; set; }
341          public int TwoWords { get; set; }
342          [PgName("some_database_name")]
343          public int SomeClrName { get; set; }
344      }
345      record Address
346      {
347          public string Street { get; set; } = default!;
348          public string PostalCode { get; set; } = default!;
349      }
350      record ClassWithNullableProperty
351      {
352          public int? Foo { get; set; }
353      }
354      struct StructWithNullableProperty
355      {
356          public int? Foo { get; set; }
357      }
358      public CompositeTests(MultiplexingMode multiplexingMode) : base(multiplexingMode) {}
359      #endregion
360  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-CompositeTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-CompositeTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>120          await AssertType(
121              connection,
122              new SomeCompositeContainer { A = 8, Containee = new() { SomeText = "foo", X = 9 } },
123              @"(8,""(9,foo)"")",
124              $"{firstSchemaName}.container",
</pre></code></div>
                <div class="column column_space"><pre><code>114          await AssertType(
115              connection,
116              new SomeCompositeContainer { A = 8, Containee = new() { SomeText = "foo", X = 9 } },
117              @"(8,""(9,foo)"")",
118              $"{secondSchemaName}.container",
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    