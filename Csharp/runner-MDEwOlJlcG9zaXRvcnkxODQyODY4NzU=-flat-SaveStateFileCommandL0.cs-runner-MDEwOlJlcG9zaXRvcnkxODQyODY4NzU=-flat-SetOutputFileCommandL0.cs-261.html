
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 15, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-SaveStateFileCommandL0.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Globalization;
4  using System.IO;
5  using System.Linq;
6  using System.Text;
7  using System.Threading;
8  using System.Threading.Tasks;
9  using System.Runtime.CompilerServices;
10  using GitHub.Runner.Common.Util;
11  using GitHub.Runner.Sdk;
12  using GitHub.Runner.Worker;
13  using GitHub.Runner.Worker.Container;
14  using GitHub.Runner.Worker.Handlers;
15  using Moq;
16  using Xunit;
17  using DTWebApi = GitHub.DistributedTask.WebApi;
18  namespace GitHub.Runner.Common.Tests.Worker
19  {
20      public sealed class SaveStateFileCommandL0
21      {
22          private Mock&lt;IExecutionContext&gt; _executionContext;
23          private List&lt;Tuple&lt;DTWebApi.Issue, string&gt;&gt; _issues;
24          private string _rootDirectory;
25          private SaveStateFileCommand _saveStateFileCommand;
26          private Dictionary&lt;string, string&gt; _intraActionState;
27          private ITraceWriter _trace;
28          [Fact]
29          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
30          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
31          public void SaveStateFileCommand_DirectoryNotFound()
32          {
33              using (var hostContext = Setup())
34              {
35                  var stateFile = Path.Combine(_rootDirectory, &quot;directory-not-found&quot;, &quot;env&quot;);
36                  _saveStateFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
37                  Assert.Equal(0, _issues.Count);
38                  Assert.Equal(0, _intraActionState.Count);
39              }
40          }
41          [Fact]
42          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
43          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
44          public void SaveStateFileCommand_NotFound()
45          {
46              using (var hostContext = Setup())
47              {
48                  var stateFile = Path.Combine(_rootDirectory, &quot;file-not-found&quot;);
49                  _saveStateFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
50                  Assert.Equal(0, _issues.Count);
51                  Assert.Equal(0, _intraActionState.Count);
52              }
53          }
54          [Fact]
55          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
56          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
57          public void SaveStateFileCommand_EmptyFile()
58          {
59              using (var hostContext = Setup())
60              {
61                  var stateFile = Path.Combine(_rootDirectory, &quot;empty-file&quot;);
62                  var content = new List&lt;string&gt;();
63                  WriteContent(stateFile, content);
64                  _saveStateFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
65                  Assert.Equal(0, _issues.Count);
66                  Assert.Equal(0, _intraActionState.Count);
67              }
68          }
69          [Fact]
70          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
71          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
72          public void SaveStateFileCommand_Simple()
73          {
74              using (var hostContext = Setup())
75              {
76                  var stateFile = Path.Combine(_rootDirectory, &quot;simple&quot;);
77                  var content = new List&lt;string&gt;
78                  {
79                      &quot;MY_STATE=MY VALUE&quot;,
80                  };
81                  WriteContent(stateFile, content);
82                  _saveStateFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
83                  Assert.Equal(0, _issues.Count);
84                  Assert.Equal(1, _intraActionState.Count);
85                  Assert.Equal(&quot;MY VALUE&quot;, _intraActionState[&quot;MY_STATE&quot;]);
86              }
87          }
88          [Fact]
89          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
90          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
91          public void SaveStateFileCommand_Simple_SkipEmptyLines()
92          {
93              using (var hostContext = Setup())
94              {
95                  var stateFile = Path.Combine(_rootDirectory, &quot;simple&quot;);
<span onclick='openModal()' class='match'>96                  var content = new List&lt;string&gt;
97                  {
98                      string.Empty,
99                      &quot;MY_STATE=my value&quot;,
100                      string.Empty,
</span>101                      &quot;MY_STATE_2=my second value&quot;,
102                      string.Empty,
103                  };
104                  WriteContent(stateFile, content);
105                  _saveStateFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
106                  Assert.Equal(0, _issues.Count);
107                  Assert.Equal(2, _intraActionState.Count);
108                  Assert.Equal(&quot;my value&quot;, _intraActionState[&quot;MY_STATE&quot;]);
109                  Assert.Equal(&quot;my second value&quot;, _intraActionState[&quot;MY_STATE_2&quot;]);
110              }
111          }
112          [Fact]
113          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
114          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
115          public void SaveStateFileCommand_Simple_EmptyValue()
116          {
117              using (var hostContext = Setup())
118              {
119                  var stateFile = Path.Combine(_rootDirectory, &quot;simple-empty-value&quot;);
120                  var content = new List&lt;string&gt;
121                  {
122                      &quot;MY_STATE=&quot;,
123                  };
124                  WriteContent(stateFile, content);
125                  _saveStateFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
126                  Assert.Equal(0, _issues.Count);
127                  Assert.Equal(1, _intraActionState.Count);
128                  Assert.Equal(string.Empty, _intraActionState[&quot;MY_STATE&quot;]);
129              }
130          }
131          [Fact]
132          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
133          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
134          public void SaveStateFileCommand_Simple_MultipleValues()
135          {
136              using (var hostContext = Setup())
137              {
138                  var stateFile = Path.Combine(_rootDirectory, &quot;simple&quot;);
139                  var content = new List&lt;string&gt;
140                  {
141                      &quot;MY_STATE=my value&quot;,
142                      &quot;MY_STATE_2=&quot;,
143                      &quot;MY_STATE_3=my third value&quot;,
144                  };
145                  WriteContent(stateFile, content);
146                  _saveStateFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
147                  Assert.Equal(0, _issues.Count);
148                  Assert.Equal(3, _intraActionState.Count);
149                  Assert.Equal(&quot;my value&quot;, _intraActionState[&quot;MY_STATE&quot;]);
150                  Assert.Equal(string.Empty, _intraActionState[&quot;MY_STATE_2&quot;]);
151                  Assert.Equal(&quot;my third value&quot;, _intraActionState[&quot;MY_STATE_3&quot;]);
152              }
153          }
154          [Fact]
155          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
156          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
157          public void SaveStateFileCommand_Simple_SpecialCharacters()
158          {
159              using (var hostContext = Setup())
160              {
161                  var stateFile = Path.Combine(_rootDirectory, &quot;simple&quot;);
162                  var content = new List&lt;string&gt;
163                  {
164                      &quot;MY_STATE==abc&quot;,
165                      &quot;MY_STATE_2=def=ghi&quot;,
166                      &quot;MY_STATE_3=jkl=&quot;,
167                  };
168                  WriteContent(stateFile, content);
169                  _saveStateFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
170                  Assert.Equal(0, _issues.Count);
171                  Assert.Equal(3, _intraActionState.Count);
172                  Assert.Equal(&quot;=abc&quot;, _intraActionState[&quot;MY_STATE&quot;]);
173                  Assert.Equal(&quot;def=ghi&quot;, _intraActionState[&quot;MY_STATE_2&quot;]);
174                  Assert.Equal(&quot;jkl=&quot;, _intraActionState[&quot;MY_STATE_3&quot;]);
175              }
176          }
177          [Fact]
178          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
179          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
180          public void SaveStateFileCommand_Heredoc()
181          {
182              using (var hostContext = Setup())
183              {
184                  var stateFile = Path.Combine(_rootDirectory, &quot;heredoc&quot;);
185                  var content = new List&lt;string&gt;
186                  {
187                      &quot;MY_STATE&lt;&lt;EOF&quot;,
188                      &quot;line one&quot;,
189                      &quot;line two&quot;,
190                      &quot;line three&quot;,
191                      &quot;EOF&quot;,
192                  };
193                  WriteContent(stateFile, content);
194                  _saveStateFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
195                  Assert.Equal(0, _issues.Count);
196                  Assert.Equal(1, _intraActionState.Count);
197                  Assert.Equal($&quot;line one{Environment.NewLine}line two{Environment.NewLine}line three&quot;, _intraActionState[&quot;MY_STATE&quot;]);
198              }
199          }
200          [Fact]
201          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
202          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
203          public void SaveStateFileCommand_Heredoc_EmptyValue()
204          {
205              using (var hostContext = Setup())
206              {
207                  var stateFile = Path.Combine(_rootDirectory, &quot;heredoc&quot;);
208                  var content = new List&lt;string&gt;
209                  {
210                      &quot;MY_STATE&lt;&lt;EOF&quot;,
211                      &quot;EOF&quot;,
212                  };
213                  WriteContent(stateFile, content);
214                  _saveStateFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
215                  Assert.Equal(0, _issues.Count);
216                  Assert.Equal(1, _intraActionState.Count);
217                  Assert.Equal(string.Empty, _intraActionState[&quot;MY_STATE&quot;]);
218              }
219          }
220          [Fact]
221          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
222          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
223          public void SaveStateFileCommand_Heredoc_SkipEmptyLines()
224          {
225              using (var hostContext = Setup())
226              {
227                  var stateFile = Path.Combine(_rootDirectory, &quot;heredoc&quot;);
228                  var content = new List&lt;string&gt;
229                  {
230                      string.Empty,
231                      &quot;MY_STATE&lt;&lt;EOF&quot;,
232                      &quot;hello&quot;,
233                      &quot;world&quot;,
234                      &quot;EOF&quot;,
235                      string.Empty,
236                      &quot;MY_STATE_2&lt;&lt;EOF&quot;,
237                      &quot;HELLO&quot;,
238                      &quot;AGAIN&quot;,
239                      &quot;EOF&quot;,
240                      string.Empty,
241                  };
242                  WriteContent(stateFile, content);
243                  _saveStateFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
244                  Assert.Equal(0, _issues.Count);
245                  Assert.Equal(2, _intraActionState.Count);
246                  Assert.Equal($&quot;hello{Environment.NewLine}world&quot;, _intraActionState[&quot;MY_STATE&quot;]);
247                  Assert.Equal($&quot;HELLO{Environment.NewLine}AGAIN&quot;, _intraActionState[&quot;MY_STATE_2&quot;]);
248              }
249          }
250          [Fact]
251          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
252          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
253          public void SaveStateFileCommand_Heredoc_SpecialCharacters()
254          {
255              using (var hostContext = Setup())
256              {
257                  var stateFile = Path.Combine(_rootDirectory, &quot;heredoc&quot;);
258                  var content = new List&lt;string&gt;
259                  {
260                      &quot;MY_STATE&lt;&lt;=EOF&quot;,
261                      &quot;hello&quot;,
262                      &quot;one&quot;,
263                      &quot;=EOF&quot;,
264                      &quot;MY_STATE_2&lt;&lt;&lt;EOF&quot;,
265                      &quot;hello&quot;,
266                      &quot;two&quot;,
267                      &quot;&lt;EOF&quot;,
268                      &quot;MY_STATE_3&lt;&lt;EOF&quot;,
269                      &quot;hello&quot;,
270                      string.Empty,
271                      &quot;three&quot;,
272                      string.Empty,
273                      &quot;EOF&quot;,
274                      &quot;MY_STATE_4&lt;&lt;EOF&quot;,
275                      &quot;hello=four&quot;,
276                      &quot;EOF&quot;,
277                      &quot;MY_STATE_5&lt;&lt;EOF&quot;,
278                      &quot; EOF&quot;,
279                      &quot;EOF&quot;,
280                  };
281                  WriteContent(stateFile, content);
282                  _saveStateFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
283                  Assert.Equal(0, _issues.Count);
284                  Assert.Equal(5, _intraActionState.Count);
285                  Assert.Equal($&quot;hello{Environment.NewLine}one&quot;, _intraActionState[&quot;MY_STATE&quot;]);
286                  Assert.Equal($&quot;hello{Environment.NewLine}two&quot;, _intraActionState[&quot;MY_STATE_2&quot;]);
287                  Assert.Equal($&quot;hello{Environment.NewLine}{Environment.NewLine}three{Environment.NewLine}&quot;, _intraActionState[&quot;MY_STATE_3&quot;]);
288                  Assert.Equal($&quot;hello=four&quot;, _intraActionState[&quot;MY_STATE_4&quot;]);
289                  Assert.Equal($&quot; EOF&quot;, _intraActionState[&quot;MY_STATE_5&quot;]);
290              }
291          }
292          [Fact]
293          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
294          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
295          public void SaveStateFileCommand_Heredoc_MissingNewLine()
296          {
297              using (var hostContext = Setup())
298              {
299                  var stateFile = Path.Combine(_rootDirectory, &quot;heredoc&quot;);
300                  var content = new List&lt;string&gt;
301                  {
302                      &quot;MY_STATE&lt;&lt;EOF&quot;,
303                      &quot;line one&quot;,
304                      &quot;line two&quot;,
305                      &quot;line three&quot;,
306                      &quot;EOF&quot;,
307                  };
308                  WriteContent(stateFile, content, &quot; &quot;);
309                  var ex = Assert.Throws&lt;Exception&gt;(() =&gt; _saveStateFileCommand.ProcessCommand(_executionContext.Object, stateFile, null));
310                  Assert.Contains(&quot;Matching delimiter not found&quot;, ex.Message);
311              }
312          }
313          [Fact]
314          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
315          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
316          public void SaveStateFileCommand_Heredoc_MissingNewLineMultipleLines()
317          {
318              using (var hostContext = Setup())
319              {
320                  var stateFile = Path.Combine(_rootDirectory, &quot;heredoc&quot;);
321                  var content = new List&lt;string&gt;
322                  {
323                      &quot;MY_STATE&lt;&lt;EOF&quot;,
324                      @&quot;line one
325                      line two
326                      line three&quot;,
327                      &quot;EOF&quot;,
328                  };
329                  WriteContent(stateFile, content, &quot; &quot;);
330                  var ex = Assert.Throws&lt;Exception&gt;(() =&gt; _saveStateFileCommand.ProcessCommand(_executionContext.Object, stateFile, null));
331                  Assert.Contains(&quot;EOF marker missing new line&quot;, ex.Message);
332              }
333          }
334  #if OS_WINDOWS
335          [Fact]
336          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
337          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
338          public void SaveStateFileCommand_Heredoc_PreservesNewline()
339          {
340              using (var hostContext = Setup())
341              {
342                  var newline = &quot;\n&quot;;
343                  var stateFile = Path.Combine(_rootDirectory, &quot;heredoc&quot;);
344                  var content = new List&lt;string&gt;
345                  {
346                      &quot;MY_STATE&lt;&lt;EOF&quot;,
347                      &quot;hello&quot;,
348                      &quot;world&quot;,
349                      &quot;EOF&quot;,
350                  };
351                  WriteContent(stateFile, content, newline: newline);
352                  _saveStateFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
353                  Assert.Equal(0, _issues.Count);
354                  Assert.Equal(1, _intraActionState.Count);
355                  Assert.Equal($&quot;hello{newline}world&quot;, _intraActionState[&quot;MY_STATE&quot;]);
356              }
357          }
358  #endif
359          private void WriteContent(
360              string path,
361              List&lt;string&gt; content,
362              string newline = null)
363          {
364              if (string.IsNullOrEmpty(newline))
365              {
366                  newline = Environment.NewLine;
367              }
368              var encoding = new UTF8Encoding(true); 
369              var contentStr = string.Join(newline, content);
370              File.WriteAllText(path, contentStr, encoding);
371          }
372          private TestHostContext Setup([CallerMemberName] string name = &quot;&quot;)
373          {
374              _issues = new List&lt;Tuple&lt;DTWebApi.Issue, string&gt;&gt;();
375              _intraActionState = new Dictionary&lt;string, string&gt;();
376              var hostContext = new TestHostContext(this, name);
377              _trace = hostContext.GetTrace();
378              var workDirectory = hostContext.GetDirectory(WellKnownDirectory.Work);
379              ArgUtil.NotNullOrEmpty(workDirectory, nameof(workDirectory));
380              Directory.CreateDirectory(workDirectory);
381              _rootDirectory = Path.Combine(workDirectory, nameof(SaveStateFileCommandL0));
382              Directory.CreateDirectory(_rootDirectory);
383              _executionContext = new Mock&lt;IExecutionContext&gt;();
384              _executionContext.Setup(x =&gt; x.Global)
385                  .Returns(new GlobalContext
386                  {
387                      EnvironmentVariables = new Dictionary&lt;string, string&gt;(VarUtil.EnvironmentVariableKeyComparer),
388                      WriteDebug = true,
389                  });
390              _executionContext.Setup(x =&gt; x.AddIssue(It.IsAny&lt;DTWebApi.Issue&gt;(), It.IsAny&lt;ExecutionContextLogOptions&gt;()))
391                  .Callback((DTWebApi.Issue issue, ExecutionContextLogOptions logOptions) =&gt;
392                  {
393                      var resolvedMessage = issue.Message;
394                      if (logOptions.WriteToLog &amp;&amp; !string.IsNullOrEmpty(logOptions.LogMessageOverride))
395                      {
396                          resolvedMessage = logOptions.LogMessageOverride;
397                      }
398                      _issues.Add(new(issue, resolvedMessage));
399                      _trace.Info($&quot;Issue &#x27;{issue.Type}&#x27;: {resolvedMessage}&quot;);
400                  });
401              _executionContext.Setup(x =&gt; x.Write(It.IsAny&lt;string&gt;(), It.IsAny&lt;string&gt;()))
402                  .Callback((string tag, string message) =&gt;
403                  {
404                      _trace.Info($&quot;{tag}{message}&quot;);
405                  });
406              _executionContext.Setup(x =&gt; x.IntraActionState)
407                .Returns(_intraActionState);
408              _saveStateFileCommand = new SaveStateFileCommand();
409              _saveStateFileCommand.Initialize(hostContext);
410              return hostContext;
411          }
412      }
413  }
</code></pre>
        </div>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-SetOutputFileCommandL0.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Globalization;
4  using System.IO;
5  using System.Linq;
6  using System.Text;
7  using System.Threading;
8  using System.Threading.Tasks;
9  using System.Runtime.CompilerServices;
10  using GitHub.Runner.Common.Util;
11  using GitHub.Runner.Sdk;
12  using GitHub.Runner.Worker;
13  using GitHub.Runner.Worker.Container;
14  using GitHub.Runner.Worker.Handlers;
15  using Moq;
16  using Xunit;
17  using DTWebApi = GitHub.DistributedTask.WebApi;
18  namespace GitHub.Runner.Common.Tests.Worker
19  {
20      public sealed class SetOutputFileCommandL0
21      {
22          private Mock&lt;IExecutionContext&gt; _executionContext;
23          private List&lt;Tuple&lt;DTWebApi.Issue, string&gt;&gt; _issues;
24          private Dictionary&lt;string, string&gt; _outputs;
25          private string _rootDirectory;
26          private SetOutputFileCommand _setOutputFileCommand;
27          private ITraceWriter _trace;
28          [Fact]
29          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
30          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
31          public void SetOutputFileCommand_DirectoryNotFound()
32          {
33              using (var hostContext = Setup())
34              {
35                  var stateFile = Path.Combine(_rootDirectory, &quot;directory-not-found&quot;, &quot;env&quot;);
36                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
37                  Assert.Equal(0, _issues.Count);
38                  Assert.Equal(0, _outputs.Count);
39              }
40          }
41          [Fact]
42          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
43          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
44          public void SetOutputFileCommand_NotFound()
45          {
46              using (var hostContext = Setup())
47              {
48                  var stateFile = Path.Combine(_rootDirectory, &quot;file-not-found&quot;);
49                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
50                  Assert.Equal(0, _issues.Count);
51                  Assert.Equal(0, _outputs.Count);
52              }
53          }
54          [Fact]
55          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
56          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
57          public void SetOutputFileCommand_EmptyFile()
58          {
59              using (var hostContext = Setup())
60              {
61                  var stateFile = Path.Combine(_rootDirectory, &quot;empty-file&quot;);
62                  var content = new List&lt;string&gt;();
63                  WriteContent(stateFile, content);
64                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
65                  Assert.Equal(0, _issues.Count);
66                  Assert.Equal(0, _outputs.Count);
67              }
68          }
69          [Fact]
70          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
71          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
72          public void SetOutputFileCommand_Simple()
73          {
74              using (var hostContext = Setup())
75              {
76                  var stateFile = Path.Combine(_rootDirectory, &quot;simple&quot;);
77                  var content = new List&lt;string&gt;
78                  {
79                      &quot;MY_OUTPUT=MY VALUE&quot;,
80                  };
81                  WriteContent(stateFile, content);
82                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
83                  Assert.Equal(0, _issues.Count);
84                  Assert.Equal(1, _outputs.Count);
85                  Assert.Equal(&quot;MY VALUE&quot;, _outputs[&quot;MY_OUTPUT&quot;]);
86              }
87          }
88          [Fact]
89          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
90          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
91          public void SetOutputFileCommand_Simple_SkipEmptyLines()
92          {
93              using (var hostContext = Setup())
94              {
95                  var stateFile = Path.Combine(_rootDirectory, &quot;simple&quot;);
<span onclick='openModal()' class='match'>96                  var content = new List&lt;string&gt;
97                  {
98                      string.Empty,
99                      &quot;MY_OUTPUT=my value&quot;,
100                      string.Empty,
</span>101                      &quot;MY_OUTPUT_2=my second value&quot;,
102                      string.Empty,
103                  };
104                  WriteContent(stateFile, content);
105                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
106                  Assert.Equal(0, _issues.Count);
107                  Assert.Equal(2, _outputs.Count);
108                  Assert.Equal(&quot;my value&quot;, _outputs[&quot;MY_OUTPUT&quot;]);
109                  Assert.Equal(&quot;my second value&quot;, _outputs[&quot;MY_OUTPUT_2&quot;]);
110              }
111          }
112          [Fact]
113          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
114          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
115          public void SetOutputFileCommand_Simple_EmptyValue()
116          {
117              using (var hostContext = Setup())
118              {
119                  var stateFile = Path.Combine(_rootDirectory, &quot;simple-empty-value&quot;);
120                  var content = new List&lt;string&gt;
121                  {
122                      &quot;MY_OUTPUT=&quot;,
123                  };
124                  WriteContent(stateFile, content);
125                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
126                  Assert.Equal(0, _issues.Count);
127                  Assert.Equal(1, _outputs.Count);
128                  Assert.Equal(string.Empty, _outputs[&quot;MY_OUTPUT&quot;]);
129              }
130          }
131          [Fact]
132          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
133          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
134          public void SetOutputFileCommand_Simple_MultipleValues()
135          {
136              using (var hostContext = Setup())
137              {
138                  var stateFile = Path.Combine(_rootDirectory, &quot;simple&quot;);
139                  var content = new List&lt;string&gt;
140                  {
141                      &quot;MY_OUTPUT=my value&quot;,
142                      &quot;MY_OUTPUT_2=&quot;,
143                      &quot;MY_OUTPUT_3=my third value&quot;,
144                  };
145                  WriteContent(stateFile, content);
146                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
147                  Assert.Equal(0, _issues.Count);
148                  Assert.Equal(3, _outputs.Count);
149                  Assert.Equal(&quot;my value&quot;, _outputs[&quot;MY_OUTPUT&quot;]);
150                  Assert.Equal(string.Empty, _outputs[&quot;MY_OUTPUT_2&quot;]);
151                  Assert.Equal(&quot;my third value&quot;, _outputs[&quot;MY_OUTPUT_3&quot;]);
152              }
153          }
154          [Fact]
155          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
156          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
157          public void SetOutputFileCommand_Simple_SpecialCharacters()
158          {
159              using (var hostContext = Setup())
160              {
161                  var stateFile = Path.Combine(_rootDirectory, &quot;simple&quot;);
162                  var content = new List&lt;string&gt;
163                  {
164                      &quot;MY_OUTPUT==abc&quot;,
165                      &quot;MY_OUTPUT_2=def=ghi&quot;,
166                      &quot;MY_OUTPUT_3=jkl=&quot;,
167                  };
168                  WriteContent(stateFile, content);
169                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
170                  Assert.Equal(0, _issues.Count);
171                  Assert.Equal(3, _outputs.Count);
172                  Assert.Equal(&quot;=abc&quot;, _outputs[&quot;MY_OUTPUT&quot;]);
173                  Assert.Equal(&quot;def=ghi&quot;, _outputs[&quot;MY_OUTPUT_2&quot;]);
174                  Assert.Equal(&quot;jkl=&quot;, _outputs[&quot;MY_OUTPUT_3&quot;]);
175              }
176          }
177          [Fact]
178          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
179          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
180          public void SetOutputFileCommand_Heredoc()
181          {
182              using (var hostContext = Setup())
183              {
184                  var stateFile = Path.Combine(_rootDirectory, &quot;heredoc&quot;);
185                  var content = new List&lt;string&gt;
186                  {
187                      &quot;MY_OUTPUT&lt;&lt;EOF&quot;,
188                      &quot;line one&quot;,
189                      &quot;line two&quot;,
190                      &quot;line three&quot;,
191                      &quot;EOF&quot;,
192                  };
193                  WriteContent(stateFile, content);
194                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
195                  Assert.Equal(0, _issues.Count);
196                  Assert.Equal(1, _outputs.Count);
197                  Assert.Equal($&quot;line one{Environment.NewLine}line two{Environment.NewLine}line three&quot;, _outputs[&quot;MY_OUTPUT&quot;]);
198              }
199          }
200          [Fact]
201          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
202          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
203          public void SetOutputFileCommand_Heredoc_EmptyValue()
204          {
205              using (var hostContext = Setup())
206              {
207                  var stateFile = Path.Combine(_rootDirectory, &quot;heredoc&quot;);
208                  var content = new List&lt;string&gt;
209                  {
210                      &quot;MY_OUTPUT&lt;&lt;EOF&quot;,
211                      &quot;EOF&quot;,
212                  };
213                  WriteContent(stateFile, content);
214                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
215                  Assert.Equal(0, _issues.Count);
216                  Assert.Equal(1, _outputs.Count);
217                  Assert.Equal(string.Empty, _outputs[&quot;MY_OUTPUT&quot;]);
218              }
219          }
220          [Fact]
221          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
222          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
223          public void SetOutputFileCommand_Heredoc_SkipEmptyLines()
224          {
225              using (var hostContext = Setup())
226              {
227                  var stateFile = Path.Combine(_rootDirectory, &quot;heredoc&quot;);
228                  var content = new List&lt;string&gt;
229                  {
230                      string.Empty,
231                      &quot;MY_OUTPUT&lt;&lt;EOF&quot;,
232                      &quot;hello&quot;,
233                      &quot;world&quot;,
234                      &quot;EOF&quot;,
235                      string.Empty,
236                      &quot;MY_OUTPUT_2&lt;&lt;EOF&quot;,
237                      &quot;HELLO&quot;,
238                      &quot;AGAIN&quot;,
239                      &quot;EOF&quot;,
240                      string.Empty,
241                  };
242                  WriteContent(stateFile, content);
243                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
244                  Assert.Equal(0, _issues.Count);
245                  Assert.Equal(2, _outputs.Count);
246                  Assert.Equal($&quot;hello{Environment.NewLine}world&quot;, _outputs[&quot;MY_OUTPUT&quot;]);
247                  Assert.Equal($&quot;HELLO{Environment.NewLine}AGAIN&quot;, _outputs[&quot;MY_OUTPUT_2&quot;]);
248              }
249          }
250          [Fact]
251          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
252          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
253          public void SetOutputFileCommand_Heredoc_SpecialCharacters()
254          {
255              using (var hostContext = Setup())
256              {
257                  var stateFile = Path.Combine(_rootDirectory, &quot;heredoc&quot;);
258                  var content = new List&lt;string&gt;
259                  {
260                      &quot;MY_OUTPUT&lt;&lt;=EOF&quot;,
261                      &quot;hello&quot;,
262                      &quot;one&quot;,
263                      &quot;=EOF&quot;,
264                      &quot;MY_OUTPUT_2&lt;&lt;&lt;EOF&quot;,
265                      &quot;hello&quot;,
266                      &quot;two&quot;,
267                      &quot;&lt;EOF&quot;,
268                      &quot;MY_OUTPUT_3&lt;&lt;EOF&quot;,
269                      &quot;hello&quot;,
270                      string.Empty,
271                      &quot;three&quot;,
272                      string.Empty,
273                      &quot;EOF&quot;,
274                      &quot;MY_OUTPUT_4&lt;&lt;EOF&quot;,
275                      &quot;hello=four&quot;,
276                      &quot;EOF&quot;,
277                      &quot;MY_OUTPUT_5&lt;&lt;EOF&quot;,
278                      &quot; EOF&quot;,
279                      &quot;EOF&quot;,
280                  };
281                  WriteContent(stateFile, content);
282                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
283                  Assert.Equal(0, _issues.Count);
284                  Assert.Equal(5, _outputs.Count);
285                  Assert.Equal($&quot;hello{Environment.NewLine}one&quot;, _outputs[&quot;MY_OUTPUT&quot;]);
286                  Assert.Equal($&quot;hello{Environment.NewLine}two&quot;, _outputs[&quot;MY_OUTPUT_2&quot;]);
287                  Assert.Equal($&quot;hello{Environment.NewLine}{Environment.NewLine}three{Environment.NewLine}&quot;, _outputs[&quot;MY_OUTPUT_3&quot;]);
288                  Assert.Equal($&quot;hello=four&quot;, _outputs[&quot;MY_OUTPUT_4&quot;]);
289                  Assert.Equal($&quot; EOF&quot;, _outputs[&quot;MY_OUTPUT_5&quot;]);
290              }
291          }
292          [Fact]
293          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
294          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
295          public void SetOutputFileCommand_Heredoc_MissingNewLine()
296          {
297              using (var hostContext = Setup())
298              {
299                  var stateFile = Path.Combine(_rootDirectory, &quot;heredoc&quot;);
300                  var content = new List&lt;string&gt;
301                  {
302                      &quot;MY_OUTPUT&lt;&lt;EOF&quot;,
303                      &quot;line one&quot;,
304                      &quot;line two&quot;,
305                      &quot;line three&quot;,
306                      &quot;EOF&quot;,
307                  };
308                  WriteContent(stateFile, content, &quot; &quot;);
309                  var ex = Assert.Throws&lt;Exception&gt;(() =&gt; _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null));
310                  Assert.Contains(&quot;Matching delimiter not found&quot;, ex.Message);
311              }
312          }
313          [Fact]
314          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
315          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
316          public void SetOutputFileCommand_Heredoc_MissingNewLineMultipleLines()
317          {
318              using (var hostContext = Setup())
319              {
320                  var stateFile = Path.Combine(_rootDirectory, &quot;heredoc&quot;);
321                  var content = new List&lt;string&gt;
322                  {
323                      &quot;MY_OUTPUT&lt;&lt;EOF&quot;,
324                      @&quot;line one
325                      line two
326                      line three&quot;,
327                      &quot;EOF&quot;,
328                  };
329                  WriteContent(stateFile, content, &quot; &quot;);
330                  var ex = Assert.Throws&lt;Exception&gt;(() =&gt; _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null));
331                  Assert.Contains(&quot;EOF marker missing new line&quot;, ex.Message);
332              }
333          }
334  #if OS_WINDOWS
335          [Fact]
336          [Trait(&quot;Level&quot;, &quot;L0&quot;)]
337          [Trait(&quot;Category&quot;, &quot;Worker&quot;)]
338          public void SetOutputFileCommand_Heredoc_PreservesNewline()
339          {
340              using (var hostContext = Setup())
341              {
342                  var newline = &quot;\n&quot;;
343                  var stateFile = Path.Combine(_rootDirectory, &quot;heredoc&quot;);
344                  var content = new List&lt;string&gt;
345                  {
346                      &quot;MY_OUTPUT&lt;&lt;EOF&quot;,
347                      &quot;hello&quot;,
348                      &quot;world&quot;,
349                      &quot;EOF&quot;,
350                  };
351                  WriteContent(stateFile, content, newline: newline);
352                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
353                  Assert.Equal(0, _issues.Count);
354                  Assert.Equal(1, _outputs.Count);
355                  Assert.Equal($&quot;hello{newline}world&quot;, _outputs[&quot;MY_OUTPUT&quot;]);
356              }
357          }
358  #endif
359          private void WriteContent(
360              string path,
361              List&lt;string&gt; content,
362              string newline = null)
363          {
364              if (string.IsNullOrEmpty(newline))
365              {
366                  newline = Environment.NewLine;
367              }
368              var encoding = new UTF8Encoding(true); 
369              var contentStr = string.Join(newline, content);
370              File.WriteAllText(path, contentStr, encoding);
371          }
372          private TestHostContext Setup([CallerMemberName] string name = &quot;&quot;)
373          {
374              _issues = new List&lt;Tuple&lt;DTWebApi.Issue, string&gt;&gt;();
375              _outputs = new Dictionary&lt;string, string&gt;();
376              var hostContext = new TestHostContext(this, name);
377              _trace = hostContext.GetTrace();
378              var workDirectory = hostContext.GetDirectory(WellKnownDirectory.Work);
379              ArgUtil.NotNullOrEmpty(workDirectory, nameof(workDirectory));
380              Directory.CreateDirectory(workDirectory);
381              _rootDirectory = Path.Combine(workDirectory, nameof(SetOutputFileCommandL0));
382              Directory.CreateDirectory(_rootDirectory);
383              _executionContext = new Mock&lt;IExecutionContext&gt;();
384              _executionContext.Setup(x =&gt; x.Global)
385                  .Returns(new GlobalContext
386                  {
387                      EnvironmentVariables = new Dictionary&lt;string, string&gt;(VarUtil.EnvironmentVariableKeyComparer),
388                      WriteDebug = true,
389                  });
390              _executionContext.Setup(x =&gt; x.AddIssue(It.IsAny&lt;DTWebApi.Issue&gt;(), It.IsAny&lt;ExecutionContextLogOptions&gt;()))
391                  .Callback((DTWebApi.Issue issue, ExecutionContextLogOptions logOptions) =&gt;
392                  {
393                      var resolvedMessage = issue.Message;
394                      if (logOptions.WriteToLog &amp;&amp; !string.IsNullOrEmpty(logOptions.LogMessageOverride))
395                      {
396                          resolvedMessage = logOptions.LogMessageOverride;
397                      }
398                      _issues.Add(new(issue, resolvedMessage));
399                      _trace.Info($&quot;Issue &#x27;{issue.Type}&#x27;: {resolvedMessage}&quot;);
400                  });
401              _executionContext.Setup(x =&gt; x.Write(It.IsAny&lt;string&gt;(), It.IsAny&lt;string&gt;()))
402                  .Callback((string tag, string message) =&gt;
403                  {
404                      _trace.Info($&quot;{tag}{message}&quot;);
405                  });
406              var reference = string.Empty;
407              _executionContext.Setup(x =&gt; x.SetOutput(It.IsAny&lt;string&gt;(), It.IsAny&lt;string&gt;(), out reference))
408                .Callback((string name, string value, out string reference) =&gt;
409                {
410                    reference = value;
411                    _outputs[name] = value;
412                });
413              _setOutputFileCommand = new SetOutputFileCommand();
414              _setOutputFileCommand.Initialize(hostContext);
415              return hostContext;
416          }
417      }
418  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-SaveStateFileCommandL0.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-SetOutputFileCommandL0.cs</div>
                </div>
                <div class="column column_space"><pre><code>96                  var content = new List&lt;string&gt;
97                  {
98                      string.Empty,
99                      &quot;MY_STATE=my value&quot;,
100                      string.Empty,
</pre></code></div>
                <div class="column column_space"><pre><code>96                  var content = new List&lt;string&gt;
97                  {
98                      string.Empty,
99                      &quot;MY_OUTPUT=my value&quot;,
100                      string.Empty,
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    