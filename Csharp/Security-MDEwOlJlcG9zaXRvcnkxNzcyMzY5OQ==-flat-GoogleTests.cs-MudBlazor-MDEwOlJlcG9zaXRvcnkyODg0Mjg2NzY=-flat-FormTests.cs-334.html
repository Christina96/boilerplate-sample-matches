
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 12, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-GoogleTests.cs</h3>
            <pre><code>1  using Microsoft.AspNetCore.Authentication.OAuth;
2  using Microsoft.AspNetCore.Builder;
3  using Microsoft.AspNetCore.DataProtection;
4  using Microsoft.AspNetCore.Hosting;
5  using Microsoft.AspNetCore.Http;
6  using Microsoft.AspNetCore.TestHost;
7  using Microsoft.AspNetCore.WebUtilities;
8  using Microsoft.Extensions.DependencyInjection;
9  using Microsoft.Extensions.Logging.Abstractions;
10  using Newtonsoft.Json;
11  using System;
12  using System.Collections.Generic;
13  using System.Linq;
14  using System.Net;
15  using System.Net.Http;
16  using System.Security.Claims;
17  using System.Text;
18  using System.Text.Encodings.Web;
19  using System.Threading.Tasks;
20  using Xunit;
21  namespace Microsoft.AspNetCore.Authentication.Google
22  {
23      public class GoogleTests : RemoteAuthenticationTests&lt;GoogleOptions&gt;
24      {
25          protected override string DefaultScheme =&gt; GoogleDefaults.AuthenticationScheme;
26          protected override Type HandlerType =&gt; typeof(GoogleHandler);
27          protected override bool SupportsSignIn { get =&gt; false; }
28          protected override bool SupportsSignOut { get =&gt; false; }
29          protected override void RegisterAuth(AuthenticationBuilder services, Action&lt;GoogleOptions&gt; configure)
30          {
31              services.AddGoogle(o =&gt;
32              {
33                  ConfigureDefaults(o);
34                  configure.Invoke(o);
35              });
36          }
37          protected override void ConfigureDefaults(GoogleOptions o)
38          {
39              o.ClientId = &quot;whatever&quot;;
40              o.ClientSecret = &quot;whatever&quot;;
41              o.SignInScheme = &quot;auth1&quot;;
42          }
43          [Fact]
44          public async Task ChallengeWillTriggerRedirection()
45          {
46              var server = CreateServer(o =&gt;
47              {
48                  o.ClientId = &quot;Test Id&quot;;
49                  o.ClientSecret = &quot;Test Secret&quot;;
50              });
51              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/challenge&quot;);
52              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
53              var location = transaction.Response.Headers.Location.ToString();
54              Assert.Contains(&quot;https:&amp;bsol;&amp;bsol;accounts.google.com/o/oauth2/v2/auth?response_type=code&quot;, location);
55              Assert.Contains(&quot;&amp;client_id=&quot;, location);
56              Assert.Contains(&quot;&amp;redirect_uri=&quot;, location);
57              Assert.Contains(&quot;&amp;scope=&quot;, location);
58              Assert.Contains(&quot;&amp;state=&quot;, location);
59              Assert.DoesNotContain(&quot;access_type=&quot;, location);
60              Assert.DoesNotContain(&quot;prompt=&quot;, location);
61              Assert.DoesNotContain(&quot;approval_prompt=&quot;, location);
62              Assert.DoesNotContain(&quot;login_hint=&quot;, location);
63              Assert.DoesNotContain(&quot;include_granted_scopes=&quot;, location);
64          }
65          [Fact]
66          public async Task SignInThrows()
67          {
68              var server = CreateServer(o =&gt;
69              {
70                  o.ClientId = &quot;Test Id&quot;;
71                  o.ClientSecret = &quot;Test Secret&quot;;
72              });
73              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signIn&quot;);
74              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
75          }
76          [Fact]
77          public async Task SignOutThrows()
78          {
79              var server = CreateServer(o =&gt;
80              {
81                  o.ClientId = &quot;Test Id&quot;;
82                  o.ClientSecret = &quot;Test Secret&quot;;
83              });
84              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signOut&quot;);
85              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
86          }
87          [Fact]
88          public async Task ForbidThrows()
89          {
90              var server = CreateServer(o =&gt;
91              {
92                  o.ClientId = &quot;Test Id&quot;;
93                  o.ClientSecret = &quot;Test Secret&quot;;
94              });
95              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signOut&quot;);
96              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
97          }
98          [Fact]
99          public async Task Challenge401WillNotTriggerRedirection()
100          {
101              var server = CreateServer(o =&gt;
102              {
103                  o.ClientId = &quot;Test Id&quot;;
104                  o.ClientSecret = &quot;Test Secret&quot;;
105              });
106              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/401&quot;);
107              Assert.Equal(HttpStatusCode.Unauthorized, transaction.Response.StatusCode);
108          }
109          [Fact]
110          public async Task ChallengeWillSetCorrelationCookie()
111          {
112              var server = CreateServer(o =&gt;
113              {
114                  o.ClientId = &quot;Test Id&quot;;
115                  o.ClientSecret = &quot;Test Secret&quot;;
116              });
117              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/challenge&quot;);
118              Assert.Contains(transaction.SetCookie, cookie =&gt; cookie.StartsWith(&quot;.AspNetCore.Correlation.Google.&quot;));
119          }
120          [Fact]
121          public async Task ChallengeWillSetDefaultScope()
122          {
123              var server = CreateServer(o =&gt;
124              {
125                  o.ClientId = &quot;Test Id&quot;;
126                  o.ClientSecret = &quot;Test Secret&quot;;
127              });
128              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/challenge&quot;);
129              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
130              var query = transaction.Response.Headers.Location.Query;
131              Assert.Contains(&quot;&amp;scope=&quot; + UrlEncoder.Default.Encode(&quot;openid profile email&quot;), query);
132          }
133          [Fact]
134          public async Task ChallengeWillUseAuthenticationPropertiesParametersAsQueryArguments()
135          {
136              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
137              var server = CreateServer(o =&gt;
138              {
139                  o.ClientId = &quot;Test Id&quot;;
140                  o.ClientSecret = &quot;Test Secret&quot;;
141                  o.StateDataFormat = stateFormat;
142              },
143              context =&gt;
144              {
145                  var req = context.Request;
146                  var res = context.Response;
147                  if (req.Path == new PathString(&quot;/challenge2&quot;))
148                  {
149                      return context.ChallengeAsync(&quot;Google&quot;, new GoogleChallengeProperties
150                      {
151                          Scope = new string[] { &quot;openid&quot;, &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/auth/plus.login&quot; },
152                          AccessType = &quot;offline&quot;,
153                          ApprovalPrompt = &quot;force&quot;,
154                          Prompt = &quot;consent&quot;,
155                          LoginHint = &quot;test@example.com&quot;,
156                          IncludeGrantedScopes = false,
157                      });
158                  }
159                  return Task.FromResult&lt;object&gt;(null);
160              });
161              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/challenge2&quot;);
162              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
163              var query = QueryHelpers.ParseQuery(transaction.Response.Headers.Location.Query);
164              Assert.Equal(&quot;openid https:&amp;bsol;&amp;bsol;www.googleapis.com/auth/plus.login&quot;, query[&quot;scope&quot;]);
165              Assert.Equal(&quot;offline&quot;, query[&quot;access_type&quot;]);
166              Assert.Equal(&quot;force&quot;, query[&quot;approval_prompt&quot;]);
167              Assert.Equal(&quot;consent&quot;, query[&quot;prompt&quot;]);
168              Assert.Equal(&quot;false&quot;, query[&quot;include_granted_scopes&quot;]);
169              Assert.Equal(&quot;test@example.com&quot;, query[&quot;login_hint&quot;]);
170              var stateProperties = stateFormat.Unprotect(query[&quot;state&quot;]);
171              Assert.DoesNotContain(&quot;scope&quot;, stateProperties.Items.Keys);
172              Assert.DoesNotContain(&quot;access_type&quot;, stateProperties.Items.Keys);
173              Assert.DoesNotContain(&quot;include_granted_scopes&quot;, stateProperties.Items.Keys);
174              Assert.DoesNotContain(&quot;approval_prompt&quot;, stateProperties.Items.Keys);
175              Assert.DoesNotContain(&quot;prompt&quot;, stateProperties.Items.Keys);
176              Assert.DoesNotContain(&quot;login_hint&quot;, stateProperties.Items.Keys);
177          }
178          [Fact]
179          public async Task ChallengeWillUseAuthenticationPropertiesItemsAsParameters()
180          {
181              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
182              var server = CreateServer(o =&gt;
183              {
184                  o.ClientId = &quot;Test Id&quot;;
185                  o.ClientSecret = &quot;Test Secret&quot;;
186                  o.StateDataFormat = stateFormat;
187              },
188              context =&gt;
189              {
190                  var req = context.Request;
191                  var res = context.Response;
192                  if (req.Path == new PathString(&quot;/challenge2&quot;))
193                  {
194                      return context.ChallengeAsync(&quot;Google&quot;, new AuthenticationProperties(new Dictionary&lt;string, string&gt;()
195                      {
196                          { &quot;scope&quot;, &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/auth/plus.login&quot; },
197                          { &quot;access_type&quot;, &quot;offline&quot; },
198                          { &quot;approval_prompt&quot;, &quot;force&quot; },
199                          { &quot;prompt&quot;, &quot;consent&quot; },
200                          { &quot;login_hint&quot;, &quot;test@example.com&quot; },
201                          { &quot;include_granted_scopes&quot;, &quot;false&quot; }
202                      }));
203                  }
204                  return Task.FromResult&lt;object&gt;(null);
205              });
206              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/challenge2&quot;);
207              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
208              var query = QueryHelpers.ParseQuery(transaction.Response.Headers.Location.Query);
209              Assert.Equal(&quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/auth/plus.login&quot;, query[&quot;scope&quot;]);
210              Assert.Equal(&quot;offline&quot;, query[&quot;access_type&quot;]);
211              Assert.Equal(&quot;force&quot;, query[&quot;approval_prompt&quot;]);
212              Assert.Equal(&quot;consent&quot;, query[&quot;prompt&quot;]);
213              Assert.Equal(&quot;false&quot;, query[&quot;include_granted_scopes&quot;]);
214              Assert.Equal(&quot;test@example.com&quot;, query[&quot;login_hint&quot;]);
215              var stateProperties = stateFormat.Unprotect(query[&quot;state&quot;]);
216              Assert.DoesNotContain(&quot;scope&quot;, stateProperties.Items.Keys);
217              Assert.DoesNotContain(&quot;access_type&quot;, stateProperties.Items.Keys);
218              Assert.DoesNotContain(&quot;include_granted_scopes&quot;, stateProperties.Items.Keys);
219              Assert.DoesNotContain(&quot;approval_prompt&quot;, stateProperties.Items.Keys);
220              Assert.DoesNotContain(&quot;prompt&quot;, stateProperties.Items.Keys);
221              Assert.DoesNotContain(&quot;login_hint&quot;, stateProperties.Items.Keys);
222          }
223          [Fact]
224          public async Task ChallengeWillUseAuthenticationPropertiesItemsAsQueryArgumentsButParametersWillOverwrite()
225          {
226              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
227              var server = CreateServer(o =&gt;
228              {
229                  o.ClientId = &quot;Test Id&quot;;
230                  o.ClientSecret = &quot;Test Secret&quot;;
231                  o.StateDataFormat = stateFormat;
232              },
233              context =&gt;
234              {
235                  var req = context.Request;
236                  var res = context.Response;
237                  if (req.Path == new PathString(&quot;/challenge2&quot;))
238                  {
239                      return context.ChallengeAsync(&quot;Google&quot;, new GoogleChallengeProperties(new Dictionary&lt;string, string&gt;
240                      {
241                          [&quot;scope&quot;] = &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/auth/plus.login&quot;,
242                          [&quot;access_type&quot;] = &quot;offline&quot;,
243                          [&quot;include_granted_scopes&quot;] = &quot;false&quot;,
244                          [&quot;approval_prompt&quot;] = &quot;force&quot;,
245                          [&quot;prompt&quot;] = &quot;login&quot;,
246                          [&quot;login_hint&quot;] = &quot;this-will-be-overwritten@example.com&quot;,
247                      })
248                      {
249                          Prompt = &quot;consent&quot;,
250                          LoginHint = &quot;test@example.com&quot;,
251                      });
252                  }
253                  return Task.FromResult&lt;object&gt;(null);
254              });
255              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/challenge2&quot;);
256              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
257              var query = QueryHelpers.ParseQuery(transaction.Response.Headers.Location.Query);
258              Assert.Equal(&quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/auth/plus.login&quot;, query[&quot;scope&quot;]);
259              Assert.Equal(&quot;offline&quot;, query[&quot;access_type&quot;]);
260              Assert.Equal(&quot;force&quot;, query[&quot;approval_prompt&quot;]);
261              Assert.Equal(&quot;consent&quot;, query[&quot;prompt&quot;]);
262              Assert.Equal(&quot;false&quot;, query[&quot;include_granted_scopes&quot;]);
263              Assert.Equal(&quot;test@example.com&quot;, query[&quot;login_hint&quot;]);
264              var stateProperties = stateFormat.Unprotect(query[&quot;state&quot;]);
265              Assert.DoesNotContain(&quot;scope&quot;, stateProperties.Items.Keys);
266              Assert.DoesNotContain(&quot;access_type&quot;, stateProperties.Items.Keys);
267              Assert.DoesNotContain(&quot;include_granted_scopes&quot;, stateProperties.Items.Keys);
268              Assert.DoesNotContain(&quot;approval_prompt&quot;, stateProperties.Items.Keys);
269              Assert.DoesNotContain(&quot;prompt&quot;, stateProperties.Items.Keys);
270              Assert.DoesNotContain(&quot;login_hint&quot;, stateProperties.Items.Keys);
271          }
272          [Fact]
273          public async Task ChallengeWillTriggerApplyRedirectEvent()
274          {
275              var server = CreateServer(o =&gt;
276              {
277                  o.ClientId = &quot;Test Id&quot;;
278                  o.ClientSecret = &quot;Test Secret&quot;;
279                  o.Events = new OAuthEvents
280                  {
281                      OnRedirectToAuthorizationEndpoint = context =&gt;
282                      {
283                          context.Response.Redirect(context.RedirectUri + &quot;&amp;custom=test&quot;);
284                          return Task.FromResult(0);
285                      }
286                  };
287              });
288              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/challenge&quot;);
289              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
290              var query = transaction.Response.Headers.Location.Query;
291              Assert.Contains(&quot;custom=test&quot;, query);
292          }
293          [Fact]
294          public async Task AuthenticateWithoutCookieWillFail()
295          {
296              var server = CreateServer(o =&gt;
297              {
298                  o.ClientId = &quot;Test Id&quot;;
299                  o.ClientSecret = &quot;Test Secret&quot;;
300              },
301              async context =&gt;
302              {
303                  var req = context.Request;
304                  var res = context.Response;
305                  if (req.Path == new PathString(&quot;/auth&quot;))
306                  {
307                      var result = await context.AuthenticateAsync(&quot;Google&quot;);
308                      Assert.NotNull(result.Failure);
309                  }
310              });
311              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/auth&quot;);
312              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
313          }
314          [Fact]
315          public async Task ReplyPathWithoutStateQueryStringWillBeRejected()
316          {
317              var server = CreateServer(o =&gt;
318              {
319                  o.ClientId = &quot;Test Id&quot;;
320                  o.ClientSecret = &quot;Test Secret&quot;;
321              });
322              var error = await Assert.ThrowsAnyAsync&lt;Exception&gt;(() =&gt; server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&quot;));
323              Assert.Equal(&quot;The oauth state was missing or invalid.&quot;, error.GetBaseException().Message);
324          }
325          [Theory]
326          [InlineData(true)]
327          [InlineData(false)]
328          public async Task ReplyPathWithAccessDeniedErrorFails(bool redirect)
329          {
330              var server = CreateServer(o =&gt;
331              {
332                  o.ClientId = &quot;Test Id&quot;;
333                  o.ClientSecret = &quot;Test Secret&quot;;
334                  o.StateDataFormat = new TestStateDataFormat();
335                  o.Events = redirect ? new OAuthEvents()
336                  {
337                      OnAccessDenied = ctx =&gt;
338                      {
339                          ctx.Response.Redirect(&quot;/error?FailureMessage=AccessDenied&quot;);
340                          ctx.HandleResponse();
341                          return Task.FromResult(0);
342                      }
343                  } : new OAuthEvents();
344              });
345              var sendTask = server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?error=access_denied&amp;error_description=SoBad&amp;error_uri=foobar&amp;state=protected_state&quot;,
346                  &quot;.AspNetCore.Correlation.Google.correlationId=N&quot;);
347              if (redirect)
348              {
349                  var transaction = await sendTask;
350                  Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
351                  Assert.Equal(&quot;/error?FailureMessage=AccessDenied&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
352              }
353              else
354              {
355                  var error = await Assert.ThrowsAnyAsync&lt;Exception&gt;(() =&gt; sendTask);
356                  Assert.Equal(&quot;Access was denied by the resource owner or by the remote server.&quot;, error.GetBaseException().Message);
357              }
358          }
359          [Fact]
360          public async Task ReplyPathWithAccessDeniedError_AllowsCustomizingPath()
361          {
362              var server = CreateServer(o =&gt;
363              {
364                  o.ClientId = &quot;Test Id&quot;;
365                  o.ClientSecret = &quot;Test Secret&quot;;
366                  o.StateDataFormat = new TestStateDataFormat();
367                  o.AccessDeniedPath = &quot;/access-denied&quot;;
368                  o.Events = new OAuthEvents()
369                  {
370                      OnAccessDenied = ctx =&gt;
371                      {
372                          Assert.Equal(&quot;/access-denied&quot;, ctx.AccessDeniedPath.Value);
373                          Assert.Equal(&quot;http:&amp;bsol;&amp;bsol;testhost/redirect&quot;, ctx.ReturnUrl);
374                          Assert.Equal(&quot;ReturnUrl&quot;, ctx.ReturnUrlParameter);
375                          ctx.AccessDeniedPath = &quot;/custom-denied-page&quot;;
376                          ctx.ReturnUrl = &quot;http:&amp;bsol;&amp;bsol;www.google.com/&quot;;
377                          ctx.ReturnUrlParameter = &quot;rurl&quot;;
378                          return Task.FromResult(0);
379                      }
380                  };
381              });
382              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?error=access_denied&amp;error_description=SoBad&amp;error_uri=foobar&amp;state=protected_state&quot;,
383                  &quot;.AspNetCore.Correlation.Google.correlationId=N&quot;);
384              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
385              Assert.Equal(&quot;/custom-denied-page?rurl=http%3A%2F%2Fwww.google.com%2F&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
386          }
387          [Theory]
388          [InlineData(true)]
389          [InlineData(false)]
390          public async Task ReplyPathWithErrorFails(bool redirect)
391          {
392              var server = CreateServer(o =&gt;
393              {
394                  o.ClientId = &quot;Test Id&quot;;
395                  o.ClientSecret = &quot;Test Secret&quot;;
396                  o.StateDataFormat = new TestStateDataFormat();
397                  o.Events = redirect ? new OAuthEvents()
398                  {
399                      OnRemoteFailure = ctx =&gt;
400                      {
401                          ctx.Response.Redirect(&quot;/error?FailureMessage=&quot; + UrlEncoder.Default.Encode(ctx.Failure.Message));
402                          ctx.HandleResponse();
403                          return Task.FromResult(0);
404                      }
405                  } : new OAuthEvents();
406              });
<span onclick='openModal()' class='match'>407              var sendTask = server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?error=OMG&amp;error_description=SoBad&amp;error_uri=foobar&amp;state=protected_state&quot;,
408                  &quot;.AspNetCore.Correlation.Google.correlationId=N&quot;);
409              if (redirect)
</span>410              {
411                  var transaction = await sendTask;
412                  Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
413                  Assert.Equal(&quot;/error?FailureMessage=OMG&quot; + UrlEncoder.Default.Encode(&quot;;Description=SoBad;Uri=foobar&quot;), transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
414              }
415              else
416              {
417                  var error = await Assert.ThrowsAnyAsync&lt;Exception&gt;(() =&gt; sendTask);
418                  Assert.Equal(&quot;OMG;Description=SoBad;Uri=foobar&quot;, error.GetBaseException().Message);
419              }
420          }
421          [Theory]
422          [InlineData(null)]
423          [InlineData(&quot;CustomIssuer&quot;)]
424          public async Task ReplyPathWillAuthenticateValidAuthorizeCodeAndState(string claimsIssuer)
425          {
426              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
427              var server = CreateServer(o =&gt;
428              {
429                  o.ClientId = &quot;Test Id&quot;;
430                  o.ClientSecret = &quot;Test Secret&quot;;
431                  o.SaveTokens = true;
432                  o.StateDataFormat = stateFormat;
433                  if (claimsIssuer != null)
434                  {
435                      o.ClaimsIssuer = claimsIssuer;
436                  }
437                  o.BackchannelHttpHandler = new TestHttpMessageHandler
438                  {
439                      Sender = req =&gt;
440                      {
441                          if (req.RequestUri.AbsoluteUri == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/oauth2/v4/token&quot;)
442                          {
443                              return ReturnJsonResponse(new
444                              {
445                                  access_token = &quot;Test Access Token&quot;,
446                                  expires_in = 3600,
447                                  token_type = &quot;Bearer&quot;
448                              });
449                          }
450                          else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/plus/v1/people/me&quot;)
451                          {
452                              return ReturnJsonResponse(new
453                              {
454                                  id = &quot;Test User ID&quot;,
455                                  displayName = &quot;Test Name&quot;,
456                                  name = new
457                                  {
458                                      familyName = &quot;Test Family Name&quot;,
459                                      givenName = &quot;Test Given Name&quot;
460                                  },
461                                  url = &quot;Profile link&quot;,
462                                  emails = new[]
463                                  {
464                                      new
465                                      {
466                                          value = &quot;Test email&quot;,
467                                          type = &quot;account&quot;
468                                      }
469                                  }
470                              });
471                          }
472                          throw new NotImplementedException(req.RequestUri.AbsoluteUri);
473                      }
474                  };
475              });
476              var properties = new AuthenticationProperties();
477              var correlationKey = &quot;.xsrf&quot;;
478              var correlationValue = &quot;TestCorrelationId&quot;;
479              properties.Items.Add(correlationKey, correlationValue);
480              properties.RedirectUri = &quot;/me&quot;;
481              var state = stateFormat.Protect(properties);
482              var transaction = await server.SendAsync(
483                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
484                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
485              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
486              Assert.Equal(&quot;/me&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
487              Assert.Equal(2, transaction.SetCookie.Count);
488              Assert.Contains($&quot;.AspNetCore.Correlation.Google.{correlationValue}&quot;, transaction.SetCookie[0]);
489              Assert.Contains(&quot;.AspNetCore.&quot; + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
490              var authCookie = transaction.AuthenticationCookieValue;
491              transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/me&quot;, authCookie);
492              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
493              var expectedIssuer = claimsIssuer ?? GoogleDefaults.AuthenticationScheme;
494              Assert.Equal(&quot;Test Name&quot;, transaction.FindClaimValue(ClaimTypes.Name, expectedIssuer));
495              Assert.Equal(&quot;Test User ID&quot;, transaction.FindClaimValue(ClaimTypes.NameIdentifier, expectedIssuer));
496              Assert.Equal(&quot;Test Given Name&quot;, transaction.FindClaimValue(ClaimTypes.GivenName, expectedIssuer));
497              Assert.Equal(&quot;Test Family Name&quot;, transaction.FindClaimValue(ClaimTypes.Surname, expectedIssuer));
498              Assert.Equal(&quot;Test email&quot;, transaction.FindClaimValue(ClaimTypes.Email, expectedIssuer));
499              Assert.Equal(&quot;yup&quot;, transaction.FindClaimValue(&quot;xform&quot;));
500              transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/tokens&quot;, authCookie);
501              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
502              Assert.Equal(&quot;Test Access Token&quot;, transaction.FindTokenValue(&quot;access_token&quot;));
503              Assert.Equal(&quot;Bearer&quot;, transaction.FindTokenValue(&quot;token_type&quot;));
504              Assert.NotNull(transaction.FindTokenValue(&quot;expires_at&quot;));
505          }
506          [Theory]
507          [InlineData(true)]
508          [InlineData(false)]
509          public async Task ReplyPathWillThrowIfCodeIsInvalid(bool redirect)
510          {
511              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
512              var server = CreateServer(o =&gt;
513              {
514                  o.ClientId = &quot;Test Id&quot;;
515                  o.ClientSecret = &quot;Test Secret&quot;;
516                  o.StateDataFormat = stateFormat;
517                  o.BackchannelHttpHandler = new TestHttpMessageHandler
518                  {
519                      Sender = req =&gt;
520                      {
521                          return ReturnJsonResponse(new { Error = &quot;Error&quot; },
522                              HttpStatusCode.BadRequest);
523                      }
524                  };
525                  o.Events = redirect ? new OAuthEvents()
526                  {
527                      OnRemoteFailure = ctx =&gt;
528                      {
529                          ctx.Response.Redirect(&quot;/error?FailureMessage=&quot; + UrlEncoder.Default.Encode(ctx.Failure.Message));
530                          ctx.HandleResponse();
531                          return Task.FromResult(0);
532                      }
533                  } : new OAuthEvents();
534              });
535              var properties = new AuthenticationProperties();
536              var correlationKey = &quot;.xsrf&quot;;
537              var correlationValue = &quot;TestCorrelationId&quot;;
538              properties.Items.Add(correlationKey, correlationValue);
539              properties.RedirectUri = &quot;/me&quot;;
540              var state = stateFormat.Protect(properties);
541              var sendTask = server.SendAsync(
542                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
543                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
544              if (redirect)
545              {
546                  var transaction = await sendTask;
547                  Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
548                  Assert.Equal(&quot;/error?FailureMessage=&quot; + UrlEncoder.Default.Encode(&quot;OAuth token endpoint failure: Status: BadRequest;Headers: ;Body: {\&quot;Error\&quot;:\&quot;Error\&quot;};&quot;),
549                      transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
550              }
551              else
552              {
553                  var error = await Assert.ThrowsAnyAsync&lt;Exception&gt;(() =&gt; sendTask);
554                  Assert.Equal(&quot;OAuth token endpoint failure: Status: BadRequest;Headers: ;Body: {\&quot;Error\&quot;:\&quot;Error\&quot;};&quot;, error.GetBaseException().Message);
555              }
556          }
557          [Theory]
558          [InlineData(true)]
559          [InlineData(false)]
560          public async Task ReplyPathWillRejectIfAccessTokenIsMissing(bool redirect)
561          {
562              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
563              var server = CreateServer(o =&gt;
564              {
565                  o.ClientId = &quot;Test Id&quot;;
566                  o.ClientSecret = &quot;Test Secret&quot;;
567                  o.StateDataFormat = stateFormat;
568                  o.BackchannelHttpHandler = new TestHttpMessageHandler
569                  {
570                      Sender = req =&gt;
571                      {
572                          return ReturnJsonResponse(new object());
573                      }
574                  };
575                  o.Events = redirect ? new OAuthEvents()
576                  {
577                      OnRemoteFailure = ctx =&gt;
578                      {
579                          ctx.Response.Redirect(&quot;/error?FailureMessage=&quot; + UrlEncoder.Default.Encode(ctx.Failure.Message));
580                          ctx.HandleResponse();
581                          return Task.FromResult(0);
582                      }
583                  } : new OAuthEvents();
584              });
585              var properties = new AuthenticationProperties();
586              var correlationKey = &quot;.xsrf&quot;;
587              var correlationValue = &quot;TestCorrelationId&quot;;
588              properties.Items.Add(correlationKey, correlationValue);
589              properties.RedirectUri = &quot;/me&quot;;
590              var state = stateFormat.Protect(properties);
591              var sendTask = server.SendAsync(
592                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
593                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
594              if (redirect)
595              {
596                  var transaction = await sendTask;
597                  Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
598                  Assert.Equal(&quot;/error?FailureMessage=&quot; + UrlEncoder.Default.Encode(&quot;Failed to retrieve access token.&quot;),
599                      transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
600              }
601              else
602              {
603                  var error = await Assert.ThrowsAnyAsync&lt;Exception&gt;(() =&gt; sendTask);
604                  Assert.Equal(&quot;Failed to retrieve access token.&quot;, error.GetBaseException().Message);
605              }
606          }
607          [Fact]
608          public async Task AuthenticatedEventCanGetRefreshToken()
609          {
610              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
611              var server = CreateServer(o =&gt;
612              {
613                  o.ClientId = &quot;Test Id&quot;;
614                  o.ClientSecret = &quot;Test Secret&quot;;
615                  o.StateDataFormat = stateFormat;
616                  o.BackchannelHttpHandler = new TestHttpMessageHandler
617                  {
618                      Sender = req =&gt;
619                      {
620                          if (req.RequestUri.AbsoluteUri == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/oauth2/v4/token&quot;)
621                          {
622                              return ReturnJsonResponse(new
623                              {
624                                  access_token = &quot;Test Access Token&quot;,
625                                  expires_in = 3600,
626                                  token_type = &quot;Bearer&quot;,
627                                  refresh_token = &quot;Test Refresh Token&quot;
628                              });
629                          }
630                          else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/plus/v1/people/me&quot;)
631                          {
632                              return ReturnJsonResponse(new
633                              {
634                                  id = &quot;Test User ID&quot;,
635                                  displayName = &quot;Test Name&quot;,
636                                  name = new
637                                  {
638                                      familyName = &quot;Test Family Name&quot;,
639                                      givenName = &quot;Test Given Name&quot;
640                                  },
641                                  url = &quot;Profile link&quot;,
642                                  emails = new[]
643                                      {
644                                          new
645                                          {
646                                              value = &quot;Test email&quot;,
647                                              type = &quot;account&quot;
648                                          }
649                                      }
650                              });
651                          }
652                          throw new NotImplementedException(req.RequestUri.AbsoluteUri);
653                      }
654                  };
655                  o.Events = new OAuthEvents
656                  {
657                      OnCreatingTicket = context =&gt;
658                      {
659                          var refreshToken = context.RefreshToken;
660                          context.Principal.AddIdentity(new ClaimsIdentity(new Claim[] { new Claim(&quot;RefreshToken&quot;, refreshToken, ClaimValueTypes.String, &quot;Google&quot;) }, &quot;Google&quot;));
661                          return Task.FromResult(0);
662                      }
663                  };
664              });
665              var properties = new AuthenticationProperties();
666              var correlationKey = &quot;.xsrf&quot;;
667              var correlationValue = &quot;TestCorrelationId&quot;;
668              properties.Items.Add(correlationKey, correlationValue);
669              properties.RedirectUri = &quot;/me&quot;;
670              var state = stateFormat.Protect(properties);
671              var transaction = await server.SendAsync(
672                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
673                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
674              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
675              Assert.Equal(&quot;/me&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
676              Assert.Equal(2, transaction.SetCookie.Count);
677              Assert.Contains($&quot;.AspNetCore.Correlation.Google.{correlationValue}&quot;, transaction.SetCookie[0]);
678              Assert.Contains(&quot;.AspNetCore.&quot; + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
679              var authCookie = transaction.AuthenticationCookieValue;
680              transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/me&quot;, authCookie);
681              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
682              Assert.Equal(&quot;Test Refresh Token&quot;, transaction.FindClaimValue(&quot;RefreshToken&quot;));
683          }
684          [Fact]
685          public async Task NullRedirectUriWillRedirectToSlash()
686          {
687              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
688              var server = CreateServer(o =&gt;
689              {
690                  o.ClientId = &quot;Test Id&quot;;
691                  o.ClientSecret = &quot;Test Secret&quot;;
692                  o.StateDataFormat = stateFormat;
693                  o.BackchannelHttpHandler = new TestHttpMessageHandler
694                  {
695                      Sender = req =&gt;
696                      {
697                          if (req.RequestUri.AbsoluteUri == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/oauth2/v4/token&quot;)
698                          {
699                              return ReturnJsonResponse(new
700                              {
701                                  access_token = &quot;Test Access Token&quot;,
702                                  expires_in = 3600,
703                                  token_type = &quot;Bearer&quot;,
704                                  refresh_token = &quot;Test Refresh Token&quot;
705                              });
706                          }
707                          else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/plus/v1/people/me&quot;)
708                          {
709                              return ReturnJsonResponse(new
710                              {
711                                  id = &quot;Test User ID&quot;,
712                                  displayName = &quot;Test Name&quot;,
713                                  name = new
714                                  {
715                                      familyName = &quot;Test Family Name&quot;,
716                                      givenName = &quot;Test Given Name&quot;
717                                  },
718                                  url = &quot;Profile link&quot;,
719                                  emails = new[]
720                                      {
721                                          new
722                                          {
723                                              value = &quot;Test email&quot;,
724                                              type = &quot;account&quot;
725                                          }
726                                      }
727                              });
728                          }
729                          throw new NotImplementedException(req.RequestUri.AbsoluteUri);
730                      }
731                  };
732                  o.Events = new OAuthEvents
733                  {
734                      OnTicketReceived = context =&gt;
735                      {
736                          context.Properties.RedirectUri = null;
737                          return Task.FromResult(0);
738                      }
739                  };
740              });
741              var properties = new AuthenticationProperties();
742              var correlationKey = &quot;.xsrf&quot;;
743              var correlationValue = &quot;TestCorrelationId&quot;;
744              properties.Items.Add(correlationKey, correlationValue);
745              var state = stateFormat.Protect(properties);
746              var transaction = await server.SendAsync(
747                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
748                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
749              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
750              Assert.Equal(&quot;/&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
751              Assert.Equal(2, transaction.SetCookie.Count);
752              Assert.Contains($&quot;.AspNetCore.Correlation.Google.{correlationValue}&quot;, transaction.SetCookie[0]);
753              Assert.Contains(&quot;.AspNetCore.&quot; + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
754          }
755          [Fact]
756          public async Task ValidateAuthenticatedContext()
757          {
758              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
759              var server = CreateServer(o =&gt;
760              {
761                  o.ClientId = &quot;Test Id&quot;;
762                  o.ClientSecret = &quot;Test Secret&quot;;
763                  o.StateDataFormat = stateFormat;
764                  o.AccessType = &quot;offline&quot;;
765                  o.Events = new OAuthEvents()
766                  {
767                      OnCreatingTicket = context =&gt;
768                      {
769                          Assert.NotNull(context.User);
770                          Assert.Equal(&quot;Test Access Token&quot;, context.AccessToken);
771                          Assert.Equal(&quot;Test Refresh Token&quot;, context.RefreshToken);
772                          Assert.Equal(TimeSpan.FromSeconds(3600), context.ExpiresIn);
773                          Assert.Equal(&quot;Test email&quot;, context.Identity.FindFirst(ClaimTypes.Email)?.Value);
774                          Assert.Equal(&quot;Test User ID&quot;, context.Identity.FindFirst(ClaimTypes.NameIdentifier)?.Value);
775                          Assert.Equal(&quot;Test Name&quot;, context.Identity.FindFirst(ClaimTypes.Name)?.Value);
776                          Assert.Equal(&quot;Test Family Name&quot;, context.Identity.FindFirst(ClaimTypes.Surname)?.Value);
777                          Assert.Equal(&quot;Test Given Name&quot;, context.Identity.FindFirst(ClaimTypes.GivenName)?.Value);
778                          return Task.FromResult(0);
779                      }
780                  };
781                  o.BackchannelHttpHandler = new TestHttpMessageHandler
782                  {
783                      Sender = req =&gt;
784                      {
785                          if (req.RequestUri.AbsoluteUri == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/oauth2/v4/token&quot;)
786                          {
787                              return ReturnJsonResponse(new
788                              {
789                                  access_token = &quot;Test Access Token&quot;,
790                                  expires_in = 3600,
791                                  token_type = &quot;Bearer&quot;,
792                                  refresh_token = &quot;Test Refresh Token&quot;
793                              });
794                          }
795                          else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/plus/v1/people/me&quot;)
796                          {
797                              return ReturnJsonResponse(new
798                              {
799                                  id = &quot;Test User ID&quot;,
800                                  displayName = &quot;Test Name&quot;,
801                                  name = new
802                                  {
803                                      familyName = &quot;Test Family Name&quot;,
804                                      givenName = &quot;Test Given Name&quot;
805                                  },
806                                  url = &quot;Profile link&quot;,
807                                  emails = new[]
808                                      {
809                                          new
810                                          {
811                                              value = &quot;Test email&quot;,
812                                              type = &quot;account&quot;
813                                          }
814                                      }
815                              });
816                          }
817                          throw new NotImplementedException(req.RequestUri.AbsoluteUri);
818                      }
819                  };
820              });
821              var properties = new AuthenticationProperties();
822              var correlationKey = &quot;.xsrf&quot;;
823              var correlationValue = &quot;TestCorrelationId&quot;;
824              properties.Items.Add(correlationKey, correlationValue);
825              properties.RedirectUri = &quot;/foo&quot;;
826              var state = stateFormat.Protect(properties);
827              var transaction = await server.SendAsync(
828                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
829                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
830              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
831              Assert.Equal(&quot;/foo&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
832          }
833          [Fact]
834          public async Task NoStateCausesException()
835          {
836              var server = CreateServer(o =&gt;
837              {
838                  o.ClientId = &quot;Test Id&quot;;
839                  o.ClientSecret = &quot;Test Secret&quot;;
840              });
841              var error = await Assert.ThrowsAnyAsync&lt;Exception&gt;(() =&gt; server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&quot;));
842              Assert.Equal(&quot;The oauth state was missing or invalid.&quot;, error.GetBaseException().Message);
843          }
844          [Fact]
845          public async Task CanRedirectOnError()
846          {
847              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
848              var server = CreateServer(o =&gt;
849              {
850                  o.ClientId = &quot;Test Id&quot;;
851                  o.ClientSecret = &quot;Test Secret&quot;;
852                  o.Events = new OAuthEvents()
853                  {
854                      OnRemoteFailure = ctx =&gt;
855                      {
856                          ctx.Response.Redirect(&quot;/error?FailureMessage=&quot; + UrlEncoder.Default.Encode(ctx.Failure.Message));
857                          ctx.HandleResponse();
858                          return Task.FromResult(0);
859                      }
860                  };
861              });
862              var transaction = await server.SendAsync(
863                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&quot;);
864              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
865              Assert.Equal(&quot;/error?FailureMessage=&quot; + UrlEncoder.Default.Encode(&quot;The oauth state was missing or invalid.&quot;),
866                  transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
867          }
868          [Fact]
869          public async Task AuthenticateAutomaticWhenAlreadySignedInSucceeds()
870          {
871              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
872              var server = CreateServer(o =&gt;
873              {
874                  o.ClientId = &quot;Test Id&quot;;
875                  o.ClientSecret = &quot;Test Secret&quot;;
876                  o.StateDataFormat = stateFormat;
877                  o.SaveTokens = true;
878                  o.BackchannelHttpHandler = CreateBackchannel();
879              });
880              var properties = new AuthenticationProperties();
881              var correlationKey = &quot;.xsrf&quot;;
882              var correlationValue = &quot;TestCorrelationId&quot;;
883              properties.Items.Add(correlationKey, correlationValue);
884              properties.RedirectUri = &quot;/me&quot;;
885              var state = stateFormat.Protect(properties);
886              var transaction = await server.SendAsync(
887                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
888                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
889              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
890              Assert.Equal(&quot;/me&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
891              Assert.Equal(2, transaction.SetCookie.Count);
892              Assert.Contains($&quot;.AspNetCore.Correlation.Google.{correlationValue}&quot;, transaction.SetCookie[0]); 
893              Assert.Contains(&quot;.AspNetCore.&quot; + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
894              var authCookie = transaction.AuthenticationCookieValue;
895              transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/authenticate&quot;, authCookie);
896              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
897              Assert.Equal(&quot;Test Name&quot;, transaction.FindClaimValue(ClaimTypes.Name));
898              Assert.Equal(&quot;Test User ID&quot;, transaction.FindClaimValue(ClaimTypes.NameIdentifier));
899              Assert.Equal(&quot;Test Given Name&quot;, transaction.FindClaimValue(ClaimTypes.GivenName));
900              Assert.Equal(&quot;Test Family Name&quot;, transaction.FindClaimValue(ClaimTypes.Surname));
901              Assert.Equal(&quot;Test email&quot;, transaction.FindClaimValue(ClaimTypes.Email));
902              Assert.Equal(&quot;yup&quot;, transaction.FindClaimValue(&quot;xform&quot;));
903          }
904          [Fact]
905          public async Task AuthenticateGoogleWhenAlreadySignedInSucceeds()
906          {
907              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
908              var server = CreateServer(o =&gt;
909              {
910                  o.ClientId = &quot;Test Id&quot;;
911                  o.ClientSecret = &quot;Test Secret&quot;;
912                  o.StateDataFormat = stateFormat;
913                  o.SaveTokens = true;
914                  o.BackchannelHttpHandler = CreateBackchannel();
915              });
916              var properties = new AuthenticationProperties();
917              var correlationKey = &quot;.xsrf&quot;;
918              var correlationValue = &quot;TestCorrelationId&quot;;
919              properties.Items.Add(correlationKey, correlationValue);
920              properties.RedirectUri = &quot;/me&quot;;
921              var state = stateFormat.Protect(properties);
922              var transaction = await server.SendAsync(
923                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
924                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
925              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
926              Assert.Equal(&quot;/me&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
927              Assert.Equal(2, transaction.SetCookie.Count);
928              Assert.Contains($&quot;.AspNetCore.Correlation.Google.{correlationValue}&quot;, transaction.SetCookie[0]); 
929              Assert.Contains(&quot;.AspNetCore.&quot; + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
930              var authCookie = transaction.AuthenticationCookieValue;
931              transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/authenticateGoogle&quot;, authCookie);
932              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
933              Assert.Equal(&quot;Test Name&quot;, transaction.FindClaimValue(ClaimTypes.Name));
934              Assert.Equal(&quot;Test User ID&quot;, transaction.FindClaimValue(ClaimTypes.NameIdentifier));
935              Assert.Equal(&quot;Test Given Name&quot;, transaction.FindClaimValue(ClaimTypes.GivenName));
936              Assert.Equal(&quot;Test Family Name&quot;, transaction.FindClaimValue(ClaimTypes.Surname));
937              Assert.Equal(&quot;Test email&quot;, transaction.FindClaimValue(ClaimTypes.Email));
938              Assert.Equal(&quot;yup&quot;, transaction.FindClaimValue(&quot;xform&quot;));
939          }
940          [Fact]
941          public async Task AuthenticateFacebookWhenAlreadySignedWithGoogleReturnsNull()
942          {
943              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
944              var server = CreateServer(o =&gt;
945              {
946                  o.ClientId = &quot;Test Id&quot;;
947                  o.ClientSecret = &quot;Test Secret&quot;;
948                  o.StateDataFormat = stateFormat;
949                  o.SaveTokens = true;
950                  o.BackchannelHttpHandler = CreateBackchannel();
951              });
952              var properties = new AuthenticationProperties();
953              var correlationKey = &quot;.xsrf&quot;;
954              var correlationValue = &quot;TestCorrelationId&quot;;
955              properties.Items.Add(correlationKey, correlationValue);
956              properties.RedirectUri = &quot;/me&quot;;
957              var state = stateFormat.Protect(properties);
958              var transaction = await server.SendAsync(
959                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
960                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
961              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
962              Assert.Equal(&quot;/me&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
963              Assert.Equal(2, transaction.SetCookie.Count);
964              Assert.Contains($&quot;.AspNetCore.Correlation.Google.{correlationValue}&quot;, transaction.SetCookie[0]); 
965              Assert.Contains(&quot;.AspNetCore.&quot; + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
966              var authCookie = transaction.AuthenticationCookieValue;
967              transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/authenticateFacebook&quot;, authCookie);
968              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
969              Assert.Null(transaction.FindClaimValue(ClaimTypes.Name));
970          }
971          [Fact]
972          public async Task ChallengeFacebookWhenAlreadySignedWithGoogleSucceeds()
973          {
974              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
975              var server = CreateServer(o =&gt;
976              {
977                  o.ClientId = &quot;Test Id&quot;;
978                  o.ClientSecret = &quot;Test Secret&quot;;
979                  o.StateDataFormat = stateFormat;
980                  o.SaveTokens = true;
981                  o.BackchannelHttpHandler = CreateBackchannel();
982              });
983              var properties = new AuthenticationProperties();
984              var correlationKey = &quot;.xsrf&quot;;
985              var correlationValue = &quot;TestCorrelationId&quot;;
986              properties.Items.Add(correlationKey, correlationValue);
987              properties.RedirectUri = &quot;/me&quot;;
988              var state = stateFormat.Protect(properties);
989              var transaction = await server.SendAsync(
990                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
991                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
992              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
993              Assert.Equal(&quot;/me&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
994              Assert.Equal(2, transaction.SetCookie.Count);
995              Assert.Contains($&quot;.AspNetCore.Correlation.Google.{correlationValue}&quot;, transaction.SetCookie[0]); 
996              Assert.Contains(&quot;.AspNetCore.&quot; + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
997              var authCookie = transaction.AuthenticationCookieValue;
998              transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/challengeFacebook&quot;, authCookie);
999              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
1000              Assert.StartsWith(&quot;https:&amp;bsol;&amp;bsol;www.facebook.com/&quot;, transaction.Response.Headers.Location.OriginalString);
1001          }
1002          private HttpMessageHandler CreateBackchannel()
1003          {
1004              return new TestHttpMessageHandler()
1005              {
1006                  Sender = req =&gt;
1007                  {
1008                      if (req.RequestUri.AbsoluteUri == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/oauth2/v4/token&quot;)
1009                      {
1010                          return ReturnJsonResponse(new
1011                          {
1012                              access_token = &quot;Test Access Token&quot;,
1013                              expires_in = 3600,
1014                              token_type = &quot;Bearer&quot;
1015                          });
1016                      }
1017                      else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/plus/v1/people/me&quot;)
1018                      {
1019                          return ReturnJsonResponse(new
1020                          {
1021                              id = &quot;Test User ID&quot;,
1022                              displayName = &quot;Test Name&quot;,
1023                              name = new
1024                              {
1025                                  familyName = &quot;Test Family Name&quot;,
1026                                  givenName = &quot;Test Given Name&quot;
1027                              },
1028                              url = &quot;Profile link&quot;,
1029                              emails = new[]
1030                              {
1031                                  new
1032                                  {
1033                                      value = &quot;Test email&quot;,
1034                                      type = &quot;account&quot;
1035                                  }
1036                              }
1037                          });
1038                      }
1039                      throw new NotImplementedException(req.RequestUri.AbsoluteUri);
1040                  }
1041              };
1042          }
1043          private static HttpResponseMessage ReturnJsonResponse(object content, HttpStatusCode code = HttpStatusCode.OK)
1044          {
1045              var res = new HttpResponseMessage(code);
1046              var text = JsonConvert.SerializeObject(content);
1047              res.Content = new StringContent(text, Encoding.UTF8, &quot;application/json&quot;);
1048              return res;
1049          }
1050          private class ClaimsTransformer : IClaimsTransformation
1051          {
1052              public Task&lt;ClaimsPrincipal&gt; TransformAsync(ClaimsPrincipal p)
1053              {
1054                  if (!p.Identities.Any(i =&gt; i.AuthenticationType == &quot;xform&quot;))
1055                  {
1056                      var id = new ClaimsIdentity(&quot;xform&quot;);
1057                      id.AddClaim(new Claim(&quot;xform&quot;, &quot;yup&quot;));
1058                      p.AddIdentity(id);
1059                  }
1060                  return Task.FromResult(p);
1061              }
1062          }
1063          private static TestServer CreateServer(Action&lt;GoogleOptions&gt; configureOptions, Func&lt;HttpContext, Task&gt; testpath = null)
1064          {
1065              var builder = new WebHostBuilder()
1066                  .Configure(app =&gt;
1067                  {
1068                      app.UseAuthentication();
1069                      app.Use(async (context, next) =&gt;
1070                      {
1071                          var req = context.Request;
1072                          var res = context.Response;
1073                          if (req.Path == new PathString(&quot;/challenge&quot;))
1074                          {
1075                              await context.ChallengeAsync();
1076                          }
1077                          else if (req.Path == new PathString(&quot;/challengeFacebook&quot;))
1078                          {
1079                              await context.ChallengeAsync(&quot;Facebook&quot;);
1080                          }
1081                          else if (req.Path == new PathString(&quot;/tokens&quot;))
1082                          {
1083                              var result = await context.AuthenticateAsync(TestExtensions.CookieAuthenticationScheme);
1084                              var tokens = result.Properties.GetTokens();
1085                              res.Describe(tokens);
1086                          }
1087                          else if (req.Path == new PathString(&quot;/me&quot;))
1088                          {
1089                              res.Describe(context.User);
1090                          }
1091                          else if (req.Path == new PathString(&quot;/authenticate&quot;))
1092                          {
1093                              var result = await context.AuthenticateAsync(TestExtensions.CookieAuthenticationScheme);
1094                              res.Describe(result.Principal);
1095                          }
1096                          else if (req.Path == new PathString(&quot;/authenticateGoogle&quot;))
1097                          {
1098                              var result = await context.AuthenticateAsync(&quot;Google&quot;);
1099                              res.Describe(result?.Principal);
1100                          }
1101                          else if (req.Path == new PathString(&quot;/authenticateFacebook&quot;))
1102                          {
1103                              var result = await context.AuthenticateAsync(&quot;Facebook&quot;);
1104                              res.Describe(result?.Principal);
1105                          }
1106                          else if (req.Path == new PathString(&quot;/unauthorized&quot;))
1107                          {
1108                              var result = await context.AuthenticateAsync(&quot;Google&quot;);
1109                              await context.ChallengeAsync(&quot;Google&quot;);
1110                          }
1111                          else if (req.Path == new PathString(&quot;/unauthorizedAuto&quot;))
1112                          {
1113                              var result = await context.AuthenticateAsync(&quot;Google&quot;);
1114                              await context.ChallengeAsync(&quot;Google&quot;);
1115                          }
1116                          else if (req.Path == new PathString(&quot;/401&quot;))
1117                          {
1118                              res.StatusCode = 401;
1119                          }
1120                          else if (req.Path == new PathString(&quot;/signIn&quot;))
1121                          {
1122                              await Assert.ThrowsAsync&lt;InvalidOperationException&gt;(() =&gt; context.SignInAsync(&quot;Google&quot;, new ClaimsPrincipal()));
1123                          }
1124                          else if (req.Path == new PathString(&quot;/signOut&quot;))
1125                          {
1126                              await Assert.ThrowsAsync&lt;InvalidOperationException&gt;(() =&gt; context.SignOutAsync(&quot;Google&quot;));
1127                          }
1128                          else if (req.Path == new PathString(&quot;/forbid&quot;))
1129                          {
1130                              await Assert.ThrowsAsync&lt;InvalidOperationException&gt;(() =&gt; context.ForbidAsync(&quot;Google&quot;));
1131                          }
1132                          else if (testpath != null)
1133                          {
1134                              await testpath(context);
1135                          }
1136                          else
1137                          {
1138                              await next();
1139                          }
1140                      });
1141                  })
1142                  .ConfigureServices(services =&gt;
1143                  {
1144                      services.AddTransient&lt;IClaimsTransformation, ClaimsTransformer&gt;();
1145                      services.AddAuthentication(TestExtensions.CookieAuthenticationScheme)
1146                          .AddCookie(TestExtensions.CookieAuthenticationScheme, o =&gt; o.ForwardChallenge = GoogleDefaults.AuthenticationScheme)
1147                          .AddGoogle(configureOptions)
1148                          .AddFacebook(o =&gt;
1149                          {
1150                              o.ClientId = &quot;Test ClientId&quot;;
1151                              o.ClientSecret = &quot;Test AppSecrent&quot;;
1152                          });
1153                  });
1154              return new TestServer(builder);
1155          }
1156          private class TestStateDataFormat : ISecureDataFormat&lt;AuthenticationProperties&gt;
1157          {
1158              private AuthenticationProperties Data { get; set; }
1159              public string Protect(AuthenticationProperties data)
1160              {
1161                  return &quot;protected_state&quot;;
1162              }
1163              public string Protect(AuthenticationProperties data, string purpose)
1164              {
1165                  throw new NotImplementedException();
1166              }
1167              public AuthenticationProperties Unprotect(string protectedText)
1168              {
1169                  Assert.Equal(&quot;protected_state&quot;, protectedText);
1170                  var properties = new AuthenticationProperties(new Dictionary&lt;string, string&gt;()
1171                  {
1172                      { &quot;.xsrf&quot;, &quot;correlationId&quot; },
1173                      { &quot;testkey&quot;, &quot;testvalue&quot; }
1174                  });
1175                  properties.RedirectUri = &quot;http:&amp;bsol;&amp;bsol;testhost/redirect&quot;;
1176                  return properties;
1177              }
1178              public AuthenticationProperties Unprotect(string protectedText, string purpose)
1179              {
1180                  throw new NotImplementedException();
1181              }
1182          }
1183      }
1184  }
</code></pre>
        </div>
        <div class="column">
            <h3>MudBlazor-MDEwOlJlcG9zaXRvcnkyODg0Mjg2NzY=-flat-FormTests.cs</h3>
            <pre><code>1  #pragma warning disable CS1998 
2  using System;
3  using System.Collections.Generic;
4  using System.Globalization;
5  using System.Linq;
6  using System.Linq.Expressions;
7  using System.Threading.Tasks;
8  using AngleSharp.Dom;
9  using Bunit;
10  using FluentAssertions;
11  using Microsoft.AspNetCore.Components;
12  using Microsoft.AspNetCore.Components.Forms;
13  using MudBlazor.Docs.Examples;
14  using MudBlazor.UnitTests.TestComponents;
15  using MudBlazor.UnitTests.TestComponents.Form;
16  using MudBlazor.Utilities;
17  using NUnit.Framework;
18  namespace MudBlazor.UnitTests.Components
19  {
20      [TestFixture]
21      public class FormTests : BunitTest
22      {
23          [Test]
24          public async Task FormIsValidTest()
25          {
26              var comp = Context.RenderComponent&lt;FormIsValidTest&gt;();
27              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
28              var textFieldcomp = comp.FindComponent&lt;MudTextField&lt;string&gt;&gt;();
29              var textField = textFieldcomp.Instance;
30              form.IsValid.Should().Be(false);
31              textField.Error.Should().BeFalse();
32              textField.ErrorText.Should().BeNullOrEmpty();
33              textFieldcomp.Find(&quot;input&quot;).Change(&quot;Marilyn Manson&quot;);
34              form.IsValid.Should().Be(true);
35              form.Errors.Length.Should().Be(0);
36              textField.Error.Should().BeFalse();
37              textField.ErrorText.Should().BeNullOrEmpty();
38              textFieldcomp.Find(&quot;input&quot;).Change(null);
39              form.IsValid.Should().Be(false);
40              form.Errors.Length.Should().Be(1);
41              form.Errors[0].Should().Be(&quot;Enter a rock star&quot;);
42              textField.Error.Should().BeTrue();
43              textField.ErrorText.Should().Be(&quot;Enter a rock star&quot;);
44              textFieldcomp.Find(&quot;input&quot;).Change(&quot;&quot;);
45              form.IsValid.Should().Be(false);
46              form.Errors.Length.Should().Be(1);
47              form.Errors[0].Should().Be(&quot;Enter a rock star&quot;);
48              textField.Error.Should().BeTrue();
49              textField.ErrorText.Should().Be(&quot;Enter a rock star&quot;);
50              textFieldcomp.Find(&quot;input&quot;).Change(&quot;Kurt Cobain&quot;);
51              form.IsValid.Should().Be(true);
52              form.Errors.Length.Should().Be(0);
53              textField.Error.Should().BeFalse();
54              textField.ErrorText.Should().BeNullOrEmpty();
55          }
56          [Test]
57          public async Task FormIsValidTest2()
58          {
59              var comp = Context.RenderComponent&lt;FormIsValidTest2&gt;();
60              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
61              var textFieldcomp = comp.FindComponent&lt;MudTextField&lt;string&gt;&gt;();
62              form.IsValid.Should().Be(true);
63              textFieldcomp.Find(&quot;input&quot;).Change(&quot;This value doesn&#x27;t matter&quot;);
64              form.IsValid.Should().Be(true);
65          }
66          [Test]
67          public async Task FormIsValidTest3()
68          {
69              var comp = Context.RenderComponent&lt;FormIsValidTest3&gt;();
70              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
71              var textFields = comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;();
72              form.IsValid.Should().Be(false);
73              form.IsTouched.Should().Be(false);
74              comp.FindComponents&lt;MudSwitch&lt;bool&gt;&gt;()[0].Instance.Checked.Should().Be(false);
75              comp.FindComponents&lt;MudSwitch&lt;bool&gt;&gt;()[1].Instance.Checked.Should().Be(false);
76              textFields[1].Find(&quot;input&quot;).Change(&quot;Fill in the required field to make this form valid&quot;);
77              form.IsValid.Should().Be(true);
78              comp.FindComponents&lt;MudSwitch&lt;bool&gt;&gt;()[0].Instance.Checked.Should().Be(true);
79              comp.FindComponents&lt;MudSwitch&lt;bool&gt;&gt;()[1].Instance.Checked.Should().Be(true);
80          }
81          [Test]
82          public async Task FormIsValidTest4()
83          {
84              var comp = Context.RenderComponent&lt;FormIsValidTest4&gt;();
85              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
86              comp.WaitForAssertion(() =&gt; form.IsValid.Should().Be(true));
87              comp.WaitForAssertion(() =&gt; comp.FindComponent&lt;MudSwitch&lt;bool&gt;&gt;().Instance.Checked.Should().Be(true));
88          }
89          [Test]
90          public async Task FormIsTouchedTest()
91          {
92              var comp = Context.RenderComponent&lt;FormIsTouchedTest&gt;();
93              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
94              var textFieldcomp = comp.FindComponent&lt;MudTextField&lt;string&gt;&gt;();
95              var textField = textFieldcomp.Instance;
96              var dateComp = comp.FindComponent&lt;MudDatePicker&gt;();
97              var dateField = dateComp.Instance;
98              form.IsTouched.Should().Be(false);
99              dateComp.Find(&quot;input&quot;).Change(&quot;2001-01-31&quot;);
100              form.IsTouched.Should().Be(true);
101              await comp.InvokeAsync(() =&gt; form.ResetAsync());
102              form.IsTouched.Should().Be(false);
103              textFieldcomp.Find(&quot;input&quot;).Change(&quot;value is changed&quot;);
104              form.IsTouched.Should().Be(true);
105              await comp.InvokeAsync(() =&gt; form.ResetValidation());
106              form.IsTouched.Should().Be(true);
107          }
108          [Test]
109          public async Task FormIsTouchedAndNestedFormIsNotTouchedWhenParentFormFieldIsTouchedTest()
110          {
111              var comp = Context.RenderComponent&lt;FormIsTouchedNestedTest&gt;();
112              var formsComp = comp.FindComponents&lt;MudForm&gt;();
113              var textCompFields = comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;();
114              var dateCompFields = comp.FindComponents&lt;MudDatePicker&gt;();
115              var form = formsComp[0].Instance;
116              var textField = textCompFields[0].Instance;
117              var dateField = dateCompFields[0].Instance;
118              var nestedForm = formsComp[1].Instance;
119              var nestedFormTextField = textCompFields[1].Instance;
120              var nestedFormDateField = dateCompFields[1].Instance;
121              form.IsTouched.Should().Be(false);
122              nestedForm.IsTouched.Should().Be(false);
123              textCompFields[0].Find(&quot;input&quot;).Change(&quot;2001-01-31&quot;);
124              form.IsTouched.Should().Be(true);
125              nestedForm.IsTouched.Should().Be(false);
126              await comp.InvokeAsync(() =&gt; form.ResetAsync());
127              form.IsTouched.Should().Be(false);
128              nestedForm.IsTouched.Should().Be(false);
129              textCompFields[0].Find(&quot;input&quot;).Change(&quot;value is changed&quot;);
130              form.IsTouched.Should().Be(true);
131              nestedForm.IsTouched.Should().Be(false);
132              await comp.InvokeAsync(() =&gt; form.ResetValidation());
133              form.IsTouched.Should().Be(true);
134              nestedForm.IsTouched.Should().Be(false);
135          }
136          [Test]
137          public async Task FormIsUnTouchedWhenNestedFormTouchedTest()
138          {
139              var comp = Context.RenderComponent&lt;FormIsTouchedNestedTest&gt;();
140              var formsComp = comp.FindComponents&lt;MudForm&gt;();
141              var textCompFields = comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;();
142              var dateCompFields = comp.FindComponents&lt;MudDatePicker&gt;();
143              var form = formsComp[0].Instance;
144              var textField = textCompFields[0].Instance;
145              var dateField = dateCompFields[0].Instance;
146              var nestedForm = formsComp[1].Instance;
147              var nestedFormTextField = textCompFields[1].Instance;
148              var nestedFormDateField = dateCompFields[1].Instance;
149              form.IsTouched.Should().Be(false);
150              nestedForm.IsTouched.Should().Be(false);
151              textCompFields[1].Find(&quot;input&quot;).Change(&quot;2001-01-31&quot;);
152              form.IsTouched.Should().Be(true);
153              nestedForm.IsTouched.Should().Be(true);
154              await comp.InvokeAsync(() =&gt; form.ResetAsync());
155              form.IsTouched.Should().Be(false);
156              nestedForm.IsTouched.Should().Be(false);
157              textCompFields[3].Find(&quot;input&quot;).Change(&quot;value is changed&quot;);
158              form.IsTouched.Should().Be(false);
159              nestedForm.IsTouched.Should().Be(true);
160              await comp.InvokeAsync(() =&gt; nestedFormDateField.ResetValidation());
161              form.IsTouched.Should().Be(false);
162              nestedForm.IsTouched.Should().Be(true);
163          }
164          [Test]
165          public async Task FormValidationTest1()
166          {
167              var validationFunc = new Func&lt;string, bool&gt;(x =&gt; x?.StartsWith(&quot;Marilyn&quot;) == true);
168              var comp = Context.RenderComponent&lt;FormValidationTest&gt;(ComponentParameter.CreateParameter(&quot;validation&quot;, validationFunc));
169              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
170              var textFieldcomp = comp.FindComponent&lt;MudTextField&lt;string&gt;&gt;();
171              var textField = textFieldcomp.Instance;
172              form.IsValid.Should().Be(false);
173              textField.Error.Should().BeFalse();
174              textField.ErrorText.Should().BeNullOrEmpty();
175              textFieldcomp.Find(&quot;input&quot;).Change(&quot;Marilyn Manson&quot;);
176              form.IsValid.Should().Be(true);
177              form.Errors.Length.Should().Be(0);
178              textField.Error.Should().BeFalse();
179              textField.ErrorText.Should().BeNullOrEmpty();
180              textFieldcomp.Find(&quot;input&quot;).Change(&quot;Kurt Cobain&quot;);
181              form.IsValid.Should().Be(false);
182              form.Errors.Length.Should().Be(1);
183              textField.Error.Should().BeTrue();
184              textField.ErrorText.Should().Be(&quot;Invalid&quot;);
185              textFieldcomp.Find(&quot;input&quot;).Change(&quot;Marilyn Monroe&quot;);
186              form.IsValid.Should().Be(true);
187              form.Errors.Length.Should().Be(0);
188              textField.Error.Should().BeFalse();
189              textField.ErrorText.Should().BeNullOrEmpty();
190          }
191          [Test]
192          public async Task FormValidationTest2()
193          {
194              var validationFunc = new Func&lt;string, string&gt;(s =&gt;
195              {
196                  if (!(s.StartsWith(&quot;Marilyn&quot;) || s.EndsWith(&quot;Manson&quot;)))
197                      return &quot;Not a star!&quot;;
198                  return null;
199              });
200              var comp = Context.RenderComponent&lt;FormValidationTest&gt;(ComponentParameter.CreateParameter(&quot;validation&quot;, validationFunc));
201              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
202              var textFieldcomp = comp.FindComponent&lt;MudTextField&lt;string&gt;&gt;();
203              form.IsValid.Should().Be(false);
204              textFieldcomp.Find(&quot;input&quot;).Change(&quot;Marilyn Manson&quot;);
205              form.IsValid.Should().Be(true);
206              textFieldcomp.Find(&quot;input&quot;).Change(&quot;Charles Manson&quot;);
207              form.IsValid.Should().Be(true);
208              textFieldcomp.Find(&quot;input&quot;).Change(&quot;Marilyn Monroe&quot;);
209              form.IsValid.Should().Be(true);
210              textFieldcomp.Find(&quot;input&quot;).Change(&quot;Manson Marilyn&quot;);
211              form.IsValid.Should().Be(false);
212          }
213          [Test]
214          public async Task FormValidationTest3()
215          {
216              var comp = Context.RenderComponent&lt;FormValidationTest&gt;();
217              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
218              var textFieldcomp = comp.FindComponent&lt;MudTextField&lt;string&gt;&gt;();
219              var textField = textFieldcomp.Instance;
220              form.IsValid.Should().Be(false);
221              textFieldcomp.Find(&quot;input&quot;).Change(&quot;Some value&quot;);
222              form.IsValid.Should().Be(true);
223              await comp.InvokeAsync(() =&gt; form.ResetAsync());
224              textField.Value.Should().Be(null);
225              textField.Text.Should().Be(null);
226              form.IsValid.Should().Be(false); 
227          }
228          [Test]
229          public async Task FormAsyncValidationTest()
230          {
231              const int ValidDelay = 100;
232              const int InvalidDelay = 200;
233              var validationFunc = new Func&lt;string, Task&lt;string&gt;&gt;(async s =&gt;
234              {
235                  if (s == null)
236                      return null;
237                  var valid = (s == &quot;abc&quot;);
238                  await Task.Delay(valid ? ValidDelay : InvalidDelay);
239                  return valid ? null : &quot;invalid&quot;;
240              });
241              var comp = Context.RenderComponent&lt;FormValidationTest&gt;(ComponentParameter.CreateParameter(&quot;validation&quot;, validationFunc));
242              var textFieldComp = comp.FindComponent&lt;MudTextField&lt;string&gt;&gt;();
243              var textField = textFieldComp.Instance;
244              textField.ValidationErrors.Should().BeEmpty();
245              textFieldComp.Find(&quot;input&quot;).Change(&quot;def&quot;);
246              comp.WaitForAssertion(() =&gt; textField.ValidationErrors.Should().ContainSingle(&quot;invalid&quot;), TimeSpan.FromSeconds(5));
247              textFieldComp.Find(&quot;input&quot;).Change(&quot;abc&quot;);
248              comp.WaitForAssertion(() =&gt; textField.ValidationErrors.Should().BeEmpty(), TimeSpan.FromSeconds(5));
249              textFieldComp.Find(&quot;input&quot;).Change(&quot;def&quot;);
250              textFieldComp.Find(&quot;input&quot;).Change(&quot;abc&quot;);
251              comp.WaitForAssertion(() =&gt; textField.ValidationErrors.Should().BeEmpty(), TimeSpan.FromSeconds(5));
252          }
253          [Test]
254          public async Task EditFormOnFieldChangedTest()
255          {
256              var comp = Context.RenderComponent&lt;EditFormOnFieldChangedTest&gt;();
257              var textFields = comp.FindAll(&quot;input&quot;);
258              textFields.Count.Should().Be(3);
259              var chips = comp.FindAll(&quot;span.mud-chip-content&quot;);
260              chips.Count.Should().Be(3);
261              foreach (var chip in chips)
262                  chip.TextContent.Trim().Should().EndWith(&quot;not changed&quot;);
263              comp.FindAll(&quot;input&quot;)[0].Change(new ChangeEventArgs() { Value = &quot;asdf&quot; });
264              comp.FindAll(&quot;input&quot;)[0].Blur();
265              comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;()[0].Instance.Text.Should().Be(&quot;asdf&quot;);
266              comp.FindAll(&quot;span.mud-chip-content&quot;)[0].TextContent.Trim().Should().Be(&quot;Field1 changed&quot;);
267              comp.FindAll(&quot;span.mud-chip-content&quot;)[1].TextContent.Trim().Should().EndWith(&quot;not changed&quot;);
268              comp.FindAll(&quot;span.mud-chip-content&quot;)[2].TextContent.Trim().Should().EndWith(&quot;not changed&quot;);
269              comp.FindAll(&quot;input&quot;)[1].Change(new ChangeEventArgs() { Value = &quot;yxcv&quot; });
270              comp.FindAll(&quot;input&quot;)[1].Blur();
271              comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;()[1].Instance.Text.Should().Be(&quot;yxcv&quot;);
272              comp.FindAll(&quot;span.mud-chip-content&quot;)[0].TextContent.Trim().Should().Be(&quot;Field1 changed&quot;);
273              comp.FindAll(&quot;span.mud-chip-content&quot;)[1].TextContent.Trim().Should().EndWith(&quot;not changed&quot;, &quot;Because it has no For, so the change can not be forwarded to the edit context for lack of a FieldIdentifier&quot;);
274              comp.FindAll(&quot;span.mud-chip-content&quot;)[2].TextContent.Trim().Should().EndWith(&quot;not changed&quot;);
275              comp.FindAll(&quot;input&quot;)[2].Change(new ChangeEventArgs() { Value = &quot;qwer&quot; });
276              comp.FindAll(&quot;input&quot;)[2].Blur();
277              comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;()[2].Instance.Text.Should().Be(&quot;qwer&quot;);
278              comp.FindAll(&quot;span.mud-chip-content&quot;)[0].TextContent.Trim().Should().Be(&quot;Field1 changed&quot;);
279              comp.FindAll(&quot;span.mud-chip-content&quot;)[1].TextContent.Trim().Should().EndWith(&quot;not changed&quot;);
280              comp.FindAll(&quot;span.mud-chip-content&quot;)[2].TextContent.Trim().Should().EndWith(&quot;Field3 changed&quot;);
281          }
282          [Test]
283          public async Task FormWithCheckboxTest()
284          {
285              var comp = Context.RenderComponent&lt;FormWithCheckboxTest&gt;();
286              var textFields = comp.FindAll(&quot;input&quot;);
287              textFields.Count.Should().Be(4); 
288              comp.FindAll(&quot;input&quot;)[0].Change(&quot;Garfield&quot;);
289              comp.FindAll(&quot;input&quot;)[0].Blur();
290              comp.FindAll(&quot;input&quot;)[1].Change(&quot;Jon&quot;);
291              comp.FindAll(&quot;input&quot;)[1].Blur();
292              comp.FindAll(&quot;input&quot;)[2].Change(&quot;17&quot;); 
293              comp.FindAll(&quot;input&quot;)[2].Blur();
294              foreach (var tf in comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;())
295                  tf.Instance.Text.Should().NotBeNullOrEmpty();
296              comp.FindComponent&lt;MudTextField&lt;int&gt;&gt;().Instance.Value.Should().Be(17);
297              comp.FindComponent&lt;MudCheckBox&lt;bool&gt;&gt;().Instance.Checked.Should().Be(true);
298              comp.FindAll(&quot;input&quot;)[3].Change(false); 
299              comp.FindComponent&lt;MudCheckBox&lt;bool&gt;&gt;().Instance.Checked.Should().Be(false);
300              foreach (var tf in comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;())
301                  tf.Instance.Text.Should().NotBeNullOrEmpty();
302              comp.FindComponent&lt;MudTextField&lt;int&gt;&gt;().Instance.Value.Should().Be(17);
303          }
304          [Test]
305          public async Task FormWithCheckboxTest2()
306          {
307              var comp = Context.RenderComponent&lt;FormWithCheckboxTest&gt;();
308              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
309              form.IsValid.Should().BeTrue(because: &quot;none of the fields are required&quot;);
310          }
311          [Test]
312          public async Task Form_Should_BecomeValidIfUntouchedFieldsAreNotRequired()
313          {
314              var comp = Context.RenderComponent&lt;FormValidationTest2&gt;();
315              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
316              form.IsValid.Should().BeFalse(because: &quot;textfield is required&quot;);
317              var textfield = comp.FindComponent&lt;MudTextField&lt;string&gt;&gt;();
318              textfield.Find(&quot;input&quot;).Change(&quot;Moby Dick&quot;);
319              form.IsValid.Should().BeTrue(because: &quot;select is not required&quot;);
320          }
321          [Test]
322          public async Task Form_Should_BecomeInValidWhenAConversionErrorOccurs()
323          {
324              var comp = Context.RenderComponent&lt;FormConversionErrorTest&gt;();
325              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
326              form.IsValid.Should().BeTrue();
327              var textfield = comp.FindComponent&lt;MudTextField&lt;int&gt;&gt;();
328              textfield.Find(&quot;input&quot;).Input(&quot;Not and int&quot;);
329              form.IsValid.Should().BeFalse(because: &quot;conversion error is forwarded to form&quot;);
330              textfield.Find(&quot;input&quot;).Input(&quot;17&quot;);
331              form.IsValid.Should().BeTrue(because: &quot;conversion error is gone&quot;);
332          }
333          [Test]
334          public async Task MudFormExampleTest()
335          {
336              var comp = Context.RenderComponent&lt;MudFormExample&gt;();
337              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
338              comp.FindComponent&lt;MudForm&gt;().SetParam(x =&gt; x.ValidationDelay, 0);
339              comp.WaitForAssertion(() =&gt; form.IsValid.Should().BeFalse(because: &quot;it contains required fields that are not filled out&quot;));
340              var buttons = comp.FindComponents&lt;MudButton&gt;();
341              var validateButton = buttons[1];
342              validateButton.Find(&quot;button&quot;).Click();
343              var textfields = comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;();
344              comp.WaitForAssertion(() =&gt; textfields[0].Instance.HasErrors.Should().BeTrue());
345              textfields[0].Instance.ErrorText.Should().Be(&quot;User name is required!&quot;);
346              comp.WaitForAssertion(() =&gt; textfields[1].Instance.HasErrors.Should().BeTrue());
347              textfields[1].Instance.ErrorText.Should().Be(&quot;Email is required!&quot;);
348              comp.WaitForAssertion(() =&gt; textfields[2].Instance.HasErrors.Should().BeTrue());
349              textfields[2].Instance.ErrorText.Should().Be(&quot;Password is required!&quot;);
350              var checkbox = comp.FindComponent&lt;MudCheckBox&lt;bool&gt;&gt;();
351              comp.WaitForAssertion(() =&gt; checkbox.Instance.HasErrors.Should().BeTrue());
352              checkbox.Instance.ErrorText.Should().Be(&quot;You must agree&quot;);
353              var resetValidationButton = buttons[3];
354              resetValidationButton.Find(&quot;button&quot;).Click();
355              comp.WaitForState(() =&gt; form.Errors.Length == 0);
356              comp.WaitForAssertion(() =&gt; textfields[0].Instance.HasErrors.Should().BeFalse());
357              textfields[0].Instance.ErrorText.Should().BeNullOrEmpty();
358              comp.WaitForAssertion(() =&gt; textfields[1].Instance.HasErrors.Should().BeFalse());
359              textfields[1].Instance.ErrorText.Should().BeNullOrEmpty();
360              comp.WaitForAssertion(() =&gt; textfields[2].Instance.HasErrors.Should().BeFalse());
361              textfields[2].Instance.ErrorText.Should().BeNullOrEmpty();
362              comp.WaitForAssertion(() =&gt; checkbox.Instance.HasErrors.Should().BeFalse());
363              checkbox.Instance.ErrorText.Should().BeNullOrEmpty();
364              textfields[0].Find(&quot;input&quot;).Change(&quot;Rick Sanchez&quot;);
365              textfields[1].Find(&quot;input&quot;).Change(&quot;rick.sanchez@citadel-of-ricks.com&quot;);
366              textfields[2].Find(&quot;input&quot;).Change(&quot;Wabalabadubdub1234!&quot;);
367              textfields[3].Find(&quot;input&quot;).Change(&quot;Wabalabadubdub1234!&quot;);
368              checkbox.Find(&quot;input&quot;).Change(true);
369              comp.WaitForAssertion(() =&gt; form.IsValid.Should().BeTrue());
370              comp.WaitForState(() =&gt; form.Errors.Length == 0);
371              var resetButton = buttons[2];
372              resetButton.Find(&quot;button&quot;).Click();
373              comp.WaitForState(() =&gt; form.Errors.Length == 0);
374              comp.WaitForAssertion(() =&gt; textfields[0].Instance.HasErrors.Should().BeFalse());
375              textfields[0].Instance.ErrorText.Should().BeNullOrEmpty();
376              textfields[0].Instance.Text.Should().BeNullOrEmpty();
377              comp.WaitForAssertion(() =&gt; textfields[1].Instance.HasErrors.Should().BeFalse());
378              textfields[1].Instance.ErrorText.Should().BeNullOrEmpty();
379              textfields[1].Instance.Text.Should().BeNullOrEmpty();
380              comp.WaitForAssertion(() =&gt; textfields[2].Instance.HasErrors.Should().BeFalse());
381              textfields[2].Instance.ErrorText.Should().BeNullOrEmpty();
382              textfields[2].Instance.Text.Should().BeNullOrEmpty();
383              comp.WaitForAssertion(() =&gt; checkbox.Instance.HasErrors.Should().BeFalse());
384              checkbox.Instance.ErrorText.Should().BeNullOrEmpty();
385              comp.WaitForAssertion(() =&gt; checkbox.Instance.Checked.Should().BeFalse());
386          }
387          [Test]
388          public async Task FormWithRadioGroupIsValidTest()
389          {
390              var comp = Context.RenderComponent&lt;FormWithRadioGroupTest&gt;();
391              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
392              var radioGroupcomp = comp.FindComponent&lt;MudRadioGroup&lt;string&gt;&gt;();
393              var radioGroup = radioGroupcomp.Instance;
394              form.IsValid.Should().Be(false);
395              radioGroup.Error.Should().BeFalse();
396              radioGroup.ErrorText.Should().BeNullOrEmpty();
397              radioGroupcomp.Find(&quot;input&quot;).Click();
398              form.IsValid.Should().Be(true);
399              form.Errors.Length.Should().Be(0);
400              radioGroup.Error.Should().BeFalse();
401              radioGroup.ErrorText.Should().BeNullOrEmpty();
402              comp.SetParam(&quot;Selected&quot;, null);
403              form.IsValid.Should().Be(false);
404              form.Errors.Length.Should().Be(1);
405              form.Errors[0].Should().Be(&quot;Required&quot;);
406              radioGroup.Error.Should().BeTrue();
407              radioGroup.ErrorText.Should().Be(&quot;Required&quot;);
408          }
409          [Test]
410          public async Task Form_Should_Validate_ColorPicker_When_ColorSelectedViaInputs()
411          {
412              var comp = Context.RenderComponent&lt;FormWithColorPickerTest&gt;();
413              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
414              var colorPickerComp = comp.FindComponent&lt;MudColorPicker&gt;();
415              var colorPicker = comp.FindComponent&lt;MudColorPicker&gt;().Instance;
416              var forbiddenColor = colorPicker.Value;
417              colorPickerComp.SetParam(x =&gt; x.Validation, new Func&lt;MudColor?, string&gt;(color =&gt; color != null &amp;&amp; color.Value == forbiddenColor.Value ? $&quot;{forbiddenColor.Value} is not allowed&quot; : null));
418              form.IsTouched.Should().BeFalse();
419              form.IsValid.Should().BeFalse();
420              colorPicker.Error.Should().BeFalse();
421              colorPicker.ErrorText.Should().BeNullOrEmpty();
422              await comp.InvokeAsync(() =&gt; colorPickerComp.FindAll(&quot;input&quot;)[0].Change(&quot;#111111&quot;));
423              form.IsTouched.Should().BeTrue();
424              form.IsValid.Should().BeTrue();
425              form.Errors.Length.Should().Be(0);
426              colorPicker.Error.Should().BeFalse();
427              colorPicker.ErrorText.Should().BeNullOrEmpty();
428              comp.SetParam(x =&gt; x.ColorValue, forbiddenColor);
429              form.IsValid.Should().Be(false);
430              form.Errors.Length.Should().Be(1);
431              form.Errors[0].Should().Be($&quot;{forbiddenColor.Value} is not allowed&quot;);
432              colorPicker.Error.Should().BeTrue();
433              colorPicker.ErrorText.Should().Be($&quot;{forbiddenColor.Value} is not allowed&quot;);
434          }
435          [Test]
436          public async Task Form_Should_ValidateColorPickerTest_When_ColorSelectedViaPicker()
437          {
438              var comp = Context.RenderComponent&lt;FormWithColorPickerTest&gt;();
439              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
440              var colorPickerComp = comp.FindComponent&lt;MudColorPicker&gt;();
441              var colorPicker = comp.FindComponent&lt;MudColorPicker&gt;().Instance;
442              var forbiddenColor = colorPicker.Palette.First();
443              colorPickerComp.SetParam(x =&gt; x.Validation, new Func&lt;MudColor?, string&gt;(color =&gt; color != null &amp;&amp; color.Value == forbiddenColor.Value ? $&quot;{forbiddenColor.Value} is not allowed&quot; : null));
444              form.IsTouched.Should().BeFalse();
445              form.IsValid.Should().BeFalse();
446              await comp.InvokeAsync(() =&gt; comp.Find(&quot;input&quot;).Click());
447              comp.WaitForAssertion(() =&gt; comp.FindAll(&quot;div.mud-picker-open&quot;).Count.Should().Be(1));
448              await comp.InvokeAsync(() =&gt; comp.Find(&quot;div.mud-picker-color-dot-current&quot;).Click());
449              comp.WaitForAssertion(() =&gt; comp.FindAll(&quot;div.mud-picker-color-collection&quot;).Count.Should().Be(1));
450              await comp.InvokeAsync(() =&gt; comp.FindAll(&quot;div.mud-picker-color-collection&gt;div.mud-picker-color-dot&quot;).Skip(1).First().Click());
451              comp.WaitForAssertion(() =&gt; comp.FindAll(&quot;div.mud-picker-color-collection&quot;).Count.Should().Be(0));
452              form.IsTouched.Should().BeTrue();
453              form.IsValid.Should().BeTrue();
454              form.Errors.Length.Should().Be(0);
455              colorPicker.Error.Should().BeFalse();
456              colorPicker.ErrorText.Should().BeNullOrEmpty();
457              await comp.InvokeAsync(() =&gt; comp.Find(&quot;div.mud-picker-color-dot-current&quot;).Click());
458              comp.WaitForAssertion(() =&gt; comp.FindAll(&quot;div.mud-picker-color-collection&quot;).Count.Should().Be(1));
459              await comp.InvokeAsync(() =&gt; comp.FindAll(&quot;div.mud-picker-color-collection&gt;div.mud-picker-color-dot&quot;).First().Click());
460              comp.WaitForAssertion(() =&gt; comp.FindAll(&quot;div.mud-picker-color-collection&quot;).Count.Should().Be(0));
461              form.IsTouched.Should().BeTrue();
462              form.IsValid.Should().BeFalse();
463              form.Errors.Length.Should().Be(1);
464              form.Errors[0].Should().Be($&quot;{forbiddenColor.Value} is not allowed&quot;);
465              colorPicker.Error.Should().BeTrue();
466              colorPicker.ErrorText.Should().Be($&quot;{forbiddenColor.Value} is not allowed&quot;);
467          }
468          [Test]
469          public async Task FormWithDatePickerTest()
470          {
471              var comp = Context.RenderComponent&lt;FormWithDatePickerTest&gt;();
472              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
473              var dateComp = comp.FindComponent&lt;MudDatePicker&gt;();
474              var datepicker = comp.FindComponent&lt;MudDatePicker&gt;().Instance;
475              form.IsValid.Should().Be(false);
476              datepicker.Error.Should().BeFalse();
477              datepicker.ErrorText.Should().BeNullOrEmpty();
478              dateComp.Find(&quot;input&quot;).Change(new DateTime(2001, 01, 31).ToShortDateString());
479              form.IsValid.Should().Be(true);
480              form.Errors.Length.Should().Be(0);
481              datepicker.Error.Should().BeFalse();
482              datepicker.ErrorText.Should().BeNullOrEmpty();
483              comp.SetParam(x =&gt; x.Date, null);
484              form.IsValid.Should().Be(false);
485              form.Errors.Length.Should().Be(1);
486              form.Errors[0].Should().Be(&quot;Required&quot;);
487              datepicker.Error.Should().BeTrue();
488              datepicker.ErrorText.Should().Be(&quot;Required&quot;);
489          }
490          [Test]
491          public async Task Form_Should_ValidateDatePickerTest()
492          {
493              var comp = Context.RenderComponent&lt;FormWithDatePickerTest&gt;();
494              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
495              var dateComp = comp.FindComponent&lt;MudDatePicker&gt;();
496              var datepicker = comp.FindComponent&lt;MudDatePicker&gt;().Instance;
497              dateComp.SetParam(x =&gt; x.Validation, new Func&lt;DateTime?, string&gt;(date =&gt; date != null &amp;&amp; date.Value.Year &gt;= 2000 ? null : &quot;Year must be &gt;= 2000&quot;));
498              dateComp.Find(&quot;input&quot;).Change(new DateTime(2001, 01, 31).ToShortDateString());
499              form.IsValid.Should().Be(true);
500              form.Errors.Length.Should().Be(0);
501              datepicker.Error.Should().BeFalse();
502              datepicker.ErrorText.Should().BeNullOrEmpty();
503              comp.SetParam(x =&gt; x.Date, (DateTime?)new DateTime(1999, 1, 1));
504              form.IsValid.Should().Be(false);
505              form.Errors.Length.Should().Be(1);
506              form.Errors[0].Should().Be(&quot;Year must be &gt;= 2000&quot;);
507              datepicker.Error.Should().BeTrue();
508              datepicker.ErrorText.Should().Be(&quot;Year must be &gt;= 2000&quot;);
509          }
510          [Test]
511          public async Task Form_Should_Validate_DateRangePicker_When_DateRangeSelectedViaInputs()
512          {
513              var comp = Context.RenderComponent&lt;FormWithDateRangePickerTest&gt;();
514              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
515              var dateRangeComp = comp.FindComponent&lt;MudDateRangePicker&gt;();
516              var dateRangePicker = comp.FindComponent&lt;MudDateRangePicker&gt;().Instance;
517              var firstDateTime = new DateTime(2023, 01, 20);
518              var secondDateTime = new DateTime(2023, 02, 20);
519              form.IsValid.Should().Be(false);
520              dateRangePicker.Error.Should().BeFalse();
521              dateRangePicker.ErrorText.Should().BeNullOrEmpty();
522              await comp.InvokeAsync(() =&gt; dateRangeComp.FindAll(&quot;input&quot;)[0].Change(firstDateTime.ToString(CultureInfo.CurrentCulture.DateTimeFormat.ShortDatePattern)));
523              await comp.InvokeAsync(() =&gt; dateRangeComp.FindAll(&quot;input&quot;)[1].Change(secondDateTime.ToString(CultureInfo.CurrentCulture.DateTimeFormat.ShortDatePattern)));
524              form.IsValid.Should().Be(true);
525              form.Errors.Length.Should().Be(0);
526              dateRangePicker.Error.Should().BeFalse();
527              dateRangePicker.ErrorText.Should().BeNullOrEmpty();
528              comp.SetParam(x =&gt; x.DateRange, null);
529              form.IsValid.Should().Be(false);
530              form.Errors.Length.Should().Be(1);
531              form.Errors[0].Should().Be(&quot;Required&quot;);
532              dateRangePicker.Error.Should().BeTrue();
533              dateRangePicker.ErrorText.Should().Be(&quot;Required&quot;);
534          }
535          [Test]
536          public async Task Form_Should_Validate_DateRangePicker_When_DateRangeSelectedViaPicker()
537          {
538              var comp = Context.RenderComponent&lt;FormWithDateRangePickerTest&gt;();
539              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
540              var dateRangePicker = comp.FindComponent&lt;MudDateRangePicker&gt;().Instance;
541              form.IsValid.Should().Be(false);
542              dateRangePicker.Error.Should().BeFalse();
543              dateRangePicker.ErrorText.Should().BeNullOrEmpty();
544              comp.Find(&quot;input&quot;).Click();
545              await comp.InvokeAsync(() =&gt; comp.FindAll(&quot;button.mud-picker-calendar-day&quot;).First(x =&gt; x.TrimmedText().Equals(&quot;10&quot;)).Click());
546              await comp.InvokeAsync(() =&gt; comp.FindAll(&quot;button.mud-picker-calendar-day&quot;).First(x =&gt; x.TrimmedText().Equals(&quot;11&quot;)).Click());
547              comp.WaitForAssertion(() =&gt; comp.FindAll(&quot;div.mud-popover-open&quot;).Count.Should().Be(0));
548              comp.WaitForAssertion(() =&gt; comp.FindAll(&quot;div.mud-popover&quot;).Count.Should().Be(1));
549              form.IsTouched.Should().Be(true);
550              form.IsValid.Should().Be(true);
551              form.Errors.Length.Should().Be(0);
552              dateRangePicker.Error.Should().BeFalse();
553              dateRangePicker.ErrorText.Should().BeNullOrEmpty();
554              comp.SetParam(x =&gt; x.DateRange, null);
555              form.IsValid.Should().Be(false);
556              form.Errors.Length.Should().Be(1);
557              form.Errors[0].Should().Be(&quot;Required&quot;);
558              dateRangePicker.Error.Should().BeTrue();
559              dateRangePicker.ErrorText.Should().Be(&quot;Required&quot;);
560          }
561          [Test]
562          public async Task FormWithTimePickerTest()
563          {
564              var comp = Context.RenderComponent&lt;FormWithTimePickerTest&gt;();
565              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
566              var timePickerComp = comp.FindComponent&lt;MudTimePicker&gt;();
567              var timePicker = comp.FindComponent&lt;MudTimePicker&gt;().Instance;
568              form.IsValid.Should().Be(false);
569              timePicker.Error.Should().BeFalse();
570              timePicker.ErrorText.Should().BeNullOrEmpty();
571              timePickerComp.Find(&quot;input&quot;).Change(&quot;09:30&quot;);
572              form.IsValid.Should().Be(true);
573              form.Errors.Length.Should().Be(0);
574              timePicker.Error.Should().BeFalse();
575              timePicker.ErrorText.Should().BeNullOrEmpty();
576              comp.SetParam(x =&gt; x.Time, null);
577              form.IsValid.Should().Be(false);
578              form.Errors.Length.Should().Be(1);
579              form.Errors[0].Should().Be(&quot;Required&quot;);
580              timePicker.Error.Should().BeTrue();
581              timePicker.ErrorText.Should().Be(&quot;Required&quot;);
582          }
583          [Test]
584          public async Task Form_Should_ValidateTimePickerTest()
585          {
586              var comp = Context.RenderComponent&lt;FormWithTimePickerTest&gt;();
587              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
588              var timeComp = comp.FindComponent&lt;MudTimePicker&gt;();
589              var timePicker = comp.FindComponent&lt;MudTimePicker&gt;().Instance;
590              timeComp.SetParam(x =&gt; x.Validation, new Func&lt;TimeSpan?, string&gt;(time =&gt; time != null &amp;&amp; time.Value.Minutes == 0 ? null : &quot;Only full hours allowed&quot;));
591              timeComp.Find(&quot;input&quot;).Change(&quot;09:00&quot;);
592              form.IsValid.Should().Be(true);
593              form.Errors.Length.Should().Be(0);
594              timePicker.Error.Should().BeFalse();
595              timePicker.ErrorText.Should().BeNullOrEmpty();
596              comp.SetParam(x =&gt; x.Time, (TimeSpan?)new TimeSpan(0, 17, 05, 00)); 
597              form.IsValid.Should().Be(false);
598              form.Errors.Length.Should().Be(1);
599              form.Errors[0].Should().Be(&quot;Only full hours allowed&quot;);
600              timePicker.Error.Should().BeTrue();
601              timePicker.ErrorText.Should().Be(&quot;Only full hours allowed&quot;);
602          }
603          [Test]
604          public async Task FormWithTimePickerTest_When_TimeSelectedViaPicker()
605          {
606              var comp = Context.RenderComponent&lt;FormWithTimePickerTest&gt;();
607              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
608              var timePicker = comp.FindComponent&lt;MudTimePicker&gt;().Instance;
609              form.IsValid.Should().Be(false);
610              timePicker.Error.Should().BeFalse();
611              timePicker.ErrorText.Should().BeNullOrEmpty();
612              comp.Find(&quot;input&quot;).Click();
613              comp.FindAll(&quot;div.mud-picker-stick-inner.mud-hour&quot;)[8].Click();
614              comp.FindAll(&quot;div.mud-minute&quot;)[30].Click();
615              comp.WaitForAssertion(() =&gt; comp.FindAll(&quot;div.mud-picker-open&quot;).Count.Should().Be(0));
616              form.IsTouched.Should().Be(true);
617              form.IsValid.Should().Be(true);
618              form.Errors.Length.Should().Be(0);
619              timePicker.Error.Should().BeFalse();
620              timePicker.ErrorText.Should().BeNullOrEmpty();
621              comp.SetParam(x =&gt; x.Time, null);
622              form.IsValid.Should().Be(false);
623              form.Errors.Length.Should().Be(1);
624              form.Errors[0].Should().Be(&quot;Required&quot;);
625              timePicker.Error.Should().BeTrue();
626              timePicker.ErrorText.Should().Be(&quot;Required&quot;);
627          }
628          [Test]
629          public async Task Form_Should_ValidateTimePickerTest_When_TimeSelectedViaPicker()
630          {
631              var comp = Context.RenderComponent&lt;FormWithTimePickerTest&gt;();
632              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
633              var timePickerComp = comp.FindComponent&lt;MudTimePicker&gt;();
634              var timePicker = comp.FindComponent&lt;MudTimePicker&gt;().Instance;
635              timePickerComp.SetParam(x =&gt; x.Validation, new Func&lt;TimeSpan?, string&gt;(time =&gt; time != null &amp;&amp; time.Value.Minutes == 0 ? null : &quot;Only full hours allowed&quot;));
636              await comp.InvokeAsync(() =&gt; comp.Find(&quot;input&quot;).Click());
637              comp.WaitForAssertion(() =&gt; comp.FindAll(&quot;div.mud-picker-open&quot;).Count.Should().Be(1));
638              await comp.InvokeAsync(() =&gt; comp.FindAll(&quot;div.mud-picker-stick-inner.mud-hour&quot;)[8].Click());
639              await comp.InvokeAsync(() =&gt; comp.FindAll(&quot;div.mud-minute&quot;)[0].Click());
640              comp.WaitForAssertion(() =&gt; comp.FindAll(&quot;div.mud-picker-open&quot;).Count.Should().Be(0));
641              form.IsTouched.Should().Be(true);
642              form.IsValid.Should().Be(true);
643              form.Errors.Length.Should().Be(0);
644              timePicker.Error.Should().BeFalse();
645              timePicker.ErrorText.Should().BeNullOrEmpty();
646              await comp.InvokeAsync(() =&gt; comp.Find(&quot;input&quot;).Click());
647              comp.WaitForAssertion(() =&gt; comp.FindAll(&quot;div.mud-picker-open&quot;).Count.Should().Be(1));
648              await comp.InvokeAsync(() =&gt; comp.FindAll(&quot;div.mud-picker-stick-outer.mud-hour&quot;)[4].Click());
649              await comp.InvokeAsync(() =&gt; comp.FindAll(&quot;div.mud-minute&quot;)[5].Click());
650              form.IsValid.Should().Be(false);
651              form.Errors.Length.Should().Be(1);
652              form.Errors[0].Should().Be(&quot;Only full hours allowed&quot;);
653              timePicker.Error.Should().BeTrue();
654              timePicker.ErrorText.Should().Be(&quot;Only full hours allowed&quot;);
655          }
656          [Test]
657          public async Task EditFormExample_EmptyValidation()
658          {
659              var comp = Context.RenderComponent&lt;EditFormExample&gt;();
660              comp.Find(&quot;form&quot;).Submit();
661              var textfields = comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;();
662              textfields[0].Instance.HasErrors.Should().BeTrue();
663              textfields[0].Instance.ErrorText.Should().Be(&quot;The Username field is required.&quot;);
664              textfields[1].Instance.HasErrors.Should().BeTrue();
665              textfields[1].Instance.ErrorText.Should().Be(&quot;The Email field is required.&quot;);
666              textfields[2].Instance.HasErrors.Should().BeTrue();
667              textfields[2].Instance.ErrorText.Should().Be(&quot;The Password field is required.&quot;);
668              textfields[3].Instance.HasErrors.Should().BeTrue();
669              textfields[3].Instance.ErrorText.Should().Be(&quot;The Password2 field is required.&quot;);
670          }
671          [Test]
672          public async Task EditFormExample_FillInValues()
673          {
674              var comp = Context.RenderComponent&lt;EditFormExample&gt;();
675              comp.FindAll(&quot;input&quot;)[0].Change(&quot;Rick Sanchez&quot;);
676              comp.FindAll(&quot;input&quot;)[0].Blur();
677              comp.FindAll(&quot;input&quot;)[1].Change(&quot;rick.sanchez@citadel-of-ricks.com&quot;);
678              comp.FindAll(&quot;input&quot;)[1].Blur();
679              comp.FindAll(&quot;input&quot;)[2].Change(&quot;Wabalabadubdub1234!&quot;);
680              comp.FindAll(&quot;input&quot;)[2].Blur();
681              comp.FindAll(&quot;input&quot;)[3].Change(&quot;Wabalabadubdub1234!&quot;);
682              comp.FindAll(&quot;input&quot;)[3].Blur();
683              comp.Find(&quot;form&quot;).Submit();
684              var textfields = comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;();
685              textfields[0].Instance.ErrorText.Should().Be(&quot;Name length can&#x27;t be more than 8.&quot;);
686              textfields[0].Instance.HasErrors.Should().BeTrue();
687              textfields[1].Instance.HasErrors.Should().BeFalse();
688              textfields[1].Instance.ErrorText.Should().BeNullOrEmpty();
689              textfields[2].Instance.HasErrors.Should().BeFalse();
690              textfields[2].Instance.ErrorText.Should().BeNullOrEmpty();
691              textfields[3].Instance.HasErrors.Should().BeFalse();
692              textfields[3].Instance.ErrorText.Should().BeNullOrEmpty();
693          }
694          [Test]
695          public async Task EditForm_Validation_NullContext()
696          {
697              var comp = Context.RenderComponent&lt;EditFormIssue1229&gt;();
698              EditFormIssue1229.TestAttribute.ValidationContextOnCall.Should().BeEmpty();
699              var input = comp.Find(&quot;input&quot;);
700              input.Change(&quot;Test&quot;);
701              input.Blur();
702              EditFormIssue1229.TestAttribute.ValidationContextOnCall.Should().NotBeEmpty();
703              foreach (var vc in EditFormIssue1229.TestAttribute.ValidationContextOnCall)
704              {
705                  vc.Should().NotBeNull();
706              }
707          }
708          [Test]
709          public async Task MudForm_MustNot_ValidateOnInitialRender()
710          {
711              var comp = Context.RenderComponent&lt;MudFormExample&gt;();
712              await Task.Delay(100);
713              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
714              form.Errors.Should().BeEmpty();
715          }
716          [Test]
717          public async Task MudFormExample_FillInValuesRootForm()
718          {
719              var comp = Context.RenderComponent&lt;FluentValidationComplexExample&gt;();
720              comp.FindAll(&quot;input&quot;)[0].Input(&quot;Rick Sanchez&quot;);
721              comp.FindAll(&quot;input&quot;)[0].Blur();
722              comp.FindAll(&quot;input&quot;)[1].Input(&quot;rick.sanchez@citadel-of-ricks.com&quot;);
723              comp.FindAll(&quot;input&quot;)[1].Blur();
724              comp.FindAll(&quot;input&quot;)[3].Input(&quot;Wabalabadubdub1234!&quot;);
725              comp.FindAll(&quot;input&quot;)[3].Blur();
726              comp.FindAll(&quot;input&quot;)[4].Input(&quot;sdfsfsdf!&quot;);
727              comp.FindAll(&quot;input&quot;)[4].Blur();
728              comp.FindAll(&quot;input&quot;)[5].Input(&quot;adsadasad!&quot;);
729              comp.FindAll(&quot;input&quot;)[5].Blur();
730              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
731              await comp.InvokeAsync(() =&gt; form.Validate());
732              form.IsValid.Should().BeFalse();
733              var textfields = comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;();
734              var numericFields = comp.FindComponents&lt;MudNumericField&lt;decimal&gt;&gt;();
735              textfields[0].Instance.HasErrors.Should().BeFalse();
736              textfields[0].Instance.ErrorText.Should().BeNullOrEmpty();
737              textfields[1].Instance.HasErrors.Should().BeFalse();
738              textfields[1].Instance.ErrorText.Should().BeNullOrEmpty();
739              textfields[2].Instance.HasErrors.Should().BeFalse();
740              textfields[2].Instance.ErrorText.Should().BeNullOrEmpty();
741              textfields[3].Instance.HasErrors.Should().BeFalse();
742              textfields[3].Instance.ErrorText.Should().BeNullOrEmpty();
743              textfields[4].Instance.HasErrors.Should().BeFalse();
744              textfields[4].Instance.ErrorText.Should().BeNullOrEmpty();
745              textfields[5].Instance.HasErrors.Should().BeFalse();
746              textfields[5].Instance.ErrorText.Should().BeNullOrEmpty();
747              textfields[6].Instance.HasErrors.Should().BeFalse();
748              textfields[6].Instance.ErrorText.Should().BeNullOrEmpty();
749              numericFields[0].Instance.HasErrors.Should().BeFalse();
750              numericFields[0].Instance.ErrorText.Should().BeNullOrEmpty();
751              textfields[7].Instance.HasErrors.Should().BeTrue();
752              textfields[7].Instance.ErrorText.Should().NotBeNullOrEmpty();
753              numericFields[1].Instance.HasErrors.Should().BeTrue();
754              numericFields[1].Instance.ErrorText.Should().NotBeNullOrEmpty();
755          }
756          [Test]
757          public async Task MudFormExample_FillInValuesNestedForm()
758          {
759              var comp = Context.RenderComponent&lt;FluentValidationComplexExample&gt;();
760              comp.FindAll(&quot;input&quot;)[8].Change(&quot;SomeWork&quot;);
761              comp.FindAll(&quot;input&quot;)[8].Blur();
762              comp.FindAll(&quot;input&quot;)[9].Change(&quot;99&quot;);
763              comp.FindAll(&quot;input&quot;)[9].Blur();
764              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
765              await comp.InvokeAsync(() =&gt; form.Validate());
766              form.IsValid.Should().BeFalse();
767              var textfields = comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;();
768              var numericFields = comp.FindComponents&lt;MudNumericField&lt;decimal&gt;&gt;();
769              textfields[0].Instance.HasErrors.Should().BeTrue();
770              textfields[0].Instance.ErrorText.Should().NotBeNullOrEmpty();
771              textfields[1].Instance.HasErrors.Should().BeTrue();
772              textfields[1].Instance.ErrorText.Should().NotBeNullOrEmpty();
773              textfields[2].Instance.HasErrors.Should().BeFalse();
774              textfields[2].Instance.ErrorText.Should().BeNullOrEmpty();
775              textfields[3].Instance.HasErrors.Should().BeTrue();
776              textfields[3].Instance.ErrorText.Should().NotBeNullOrEmpty();
777              textfields[4].Instance.HasErrors.Should().BeTrue();
778              textfields[4].Instance.ErrorText.Should().NotBeNullOrEmpty();
779              textfields[5].Instance.HasErrors.Should().BeTrue();
780              textfields[5].Instance.ErrorText.Should().NotBeNullOrEmpty();
781              textfields[6].Instance.HasErrors.Should().BeFalse();
782              textfields[6].Instance.ErrorText.Should().BeNullOrEmpty();
783              numericFields[0].Instance.HasErrors.Should().BeFalse();
784              numericFields[0].Instance.ErrorText.Should().BeNullOrEmpty();
785              textfields[7].Instance.HasErrors.Should().BeFalse();
786              textfields[7].Instance.ErrorText.Should().BeNullOrEmpty();
787              numericFields[1].Instance.HasErrors.Should().BeFalse();
788              numericFields[1].Instance.ErrorText.Should().BeNullOrEmpty();
789          }
790          [Test]
791          public async Task MudFormExample_FillInValues()
792          {
793              var comp = Context.RenderComponent&lt;FluentValidationComplexExample&gt;();
794              comp.FindAll(&quot;input&quot;)[0].Input(&quot;Rick Sanchez&quot;);
795              comp.FindAll(&quot;input&quot;)[0].Blur();
796              comp.FindAll(&quot;input&quot;)[1].Input(&quot;rick.sanchez@citadel-of-ricks.com&quot;);
797              comp.FindAll(&quot;input&quot;)[1].Blur();
798              comp.FindAll(&quot;input&quot;)[3].Input(&quot;Wabalabadubdub1234!&quot;);
799              comp.FindAll(&quot;input&quot;)[3].Blur();
800              comp.FindAll(&quot;input&quot;)[4].Input(&quot;sdfsfsdf!&quot;);
801              comp.FindAll(&quot;input&quot;)[4].Blur();
802              comp.FindAll(&quot;input&quot;)[5].Input(&quot;adsadasad!&quot;);
803              comp.FindAll(&quot;input&quot;)[5].Blur();
804              comp.FindAll(&quot;input&quot;)[8].Change(&quot;SomeWork&quot;);
805              comp.FindAll(&quot;input&quot;)[8].Blur();
806              comp.FindAll(&quot;input&quot;)[9].Change(&quot;99&quot;);
807              comp.FindAll(&quot;input&quot;)[9].Blur();
808              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
809              await comp.InvokeAsync(() =&gt; form.Validate());
810              form.IsValid.Should().BeTrue();
811              var textfields = comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;();
812              var numericFields = comp.FindComponents&lt;MudNumericField&lt;decimal&gt;&gt;();
813              textfields[0].Instance.HasErrors.Should().BeFalse();
814              textfields[0].Instance.ErrorText.Should().BeNullOrEmpty();
815              textfields[1].Instance.HasErrors.Should().BeFalse();
816              textfields[1].Instance.ErrorText.Should().BeNullOrEmpty();
817              textfields[2].Instance.HasErrors.Should().BeFalse();
818              textfields[2].Instance.ErrorText.Should().BeNullOrEmpty();
819              textfields[3].Instance.HasErrors.Should().BeFalse();
820              textfields[3].Instance.ErrorText.Should().BeNullOrEmpty();
821              textfields[4].Instance.HasErrors.Should().BeFalse();
822              textfields[4].Instance.ErrorText.Should().BeNullOrEmpty();
823              textfields[5].Instance.HasErrors.Should().BeFalse();
824              textfields[5].Instance.ErrorText.Should().BeNullOrEmpty();
825              textfields[6].Instance.HasErrors.Should().BeFalse();
826              textfields[6].Instance.ErrorText.Should().BeNullOrEmpty();
827              numericFields[0].Instance.HasErrors.Should().BeFalse();
828              numericFields[0].Instance.ErrorText.Should().BeNullOrEmpty();
829              textfields[7].Instance.HasErrors.Should().BeFalse();
830              textfields[7].Instance.ErrorText.Should().BeNullOrEmpty();
831              numericFields[1].Instance.HasErrors.Should().BeFalse();
832              numericFields[1].Instance.ErrorText.Should().BeNullOrEmpty();
833          }
834          [Test]
835          public async Task MudFormComponent_ValidationWithModel_UnexpectedErrorInValidationFunc3()
836          {
837              var comp = Context.RenderComponent&lt;FormWithSingleTextField&gt;();
838              var form = comp.FindComponent&lt;MudForm&gt;();
839              var model = new { data = &quot;asdf&quot; };
840              form.SetParam(nameof(MudForm.Model), model);
841              var tf = comp.FindComponent&lt;MudTextField&lt;string&gt;&gt;();
842              var validationFunc = new Func&lt;object, string, IEnumerable&lt;string&gt;&gt;((obj, property) =&gt;
843              {
844                  throw new InvalidOperationException(&quot;User error&quot;);
845              });
846              tf.SetParam(nameof(MudTextField&lt;string&gt;.Validation), validationFunc);
847              Expression&lt;Func&lt;string&gt;&gt; expression = () =&gt; model.data;
848              tf.SetParam(nameof(MudTextField&lt;string&gt;.For), expression);
849              await comp.InvokeAsync(tf.Instance.Validate);
850              tf.Instance.Error.Should().Be(true);
851              tf.Instance.ErrorText.Should().Be(&quot;Error in validation func: User error&quot;);
852          }
853          [Test]
854          public async Task MudFormComponent_ValidationWithModelWithNoFor_ShouldShow_ExpectedError()
855          {
856              var comp = Context.RenderComponent&lt;FormWithSingleTextField&gt;();
857              var form = comp.FindComponent&lt;MudForm&gt;();
858              var model = new { data = &quot;asdf&quot; };
859              form.SetParam(nameof(MudForm.Model), model);
860              var tf = comp.FindComponent&lt;MudTextField&lt;string&gt;&gt;();
861              var validationFunc = new Func&lt;object, string, IEnumerable&lt;string&gt;&gt;((obj, property) =&gt;
862              {
863                  throw new InvalidOperationException(&quot;User error&quot;);
864              });
865              tf.SetParam(nameof(MudTextField&lt;string&gt;.Validation), validationFunc);
866              await comp.InvokeAsync(tf.Instance.Validate);
867              tf.Instance.Error.Should().Be(true);
868              tf.Instance.ErrorText.Should().Be(&quot;For is null, please set parameter For on the form input component of type MudTextField`1&quot;);
869          }
870          [Test]
871          public async Task MudFormComponent_AsyncValidationWithModelWithNoFor_ShouldShow_ExpectedError()
872          {
873              var comp = Context.RenderComponent&lt;FormWithSingleTextField&gt;();
874              var form = comp.FindComponent&lt;MudForm&gt;();
875              var model = new { data = &quot;asdf&quot; };
876              form.SetParam(nameof(MudForm.Model), model);
877              var tf = comp.FindComponent&lt;MudTextField&lt;string&gt;&gt;();
878              var validationFunc = new Func&lt;object, string, Task&lt;IEnumerable&lt;string&gt;&gt;&gt;((obj, property) =&gt;
879              {
880                  throw new InvalidOperationException(&quot;User error&quot;);
881              });
882              tf.SetParam(nameof(MudTextField&lt;string&gt;.Validation), validationFunc);
883              await comp.InvokeAsync(tf.Instance.Validate);
884              tf.Instance.Error.Should().Be(true);
885              tf.Instance.ErrorText.Should().Be(&quot;For is null, please set parameter For on the form input component of type MudTextField`1&quot;);
886          }
887          [Test]
888          public async Task MudFormComponent_ValidationWithModel_UnexpectedErrorInValidationFunc5()
889          {
890              var comp = Context.RenderComponent&lt;FormWithSingleTextField&gt;();
891              var form = comp.FindComponent&lt;MudForm&gt;();
892              var model = new { data = &quot;asdf&quot; };
893              form.SetParam(nameof(MudForm.Model), model);
894              var tf = comp.FindComponent&lt;MudTextField&lt;string&gt;&gt;();
895              var validationFunc = new Func&lt;object, string, IEnumerable&lt;string&gt;&gt;((obj, property) =&gt;
896              {
897                  obj.Should().Be(model);
898                  property.Should().Be(&quot;data&quot;);
899                  return new[] { &quot;Error1&quot;, &quot;Error2&quot; };
900              });
901              tf.SetParam(nameof(MudTextField&lt;string&gt;.Validation), validationFunc);
902              Expression&lt;Func&lt;string&gt;&gt; expression = () =&gt; model.data;
903              tf.SetParam(nameof(MudTextField&lt;string&gt;.For), expression);
904              await comp.InvokeAsync(tf.Instance.Validate);
905              tf.Instance.Error.Should().Be(true);
906              tf.Instance.ErrorText.Should().Be(&quot;Error1&quot;);
907          }
908          [Test]
909          public async Task FormReset_Should_ClearTextField()
910          {
911              var comp = Context.RenderComponent&lt;FormResetTest&gt;();
912              var form = comp.FindComponent&lt;MudForm&gt;();
913              var textFieldComp = comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;()[1]; 
914              var textField = textFieldComp.Instance;
915              textFieldComp.Find(&quot;input&quot;).Input(&quot;asdf&quot;);
916              textField.Value.Should().Be(&quot;asdf&quot;);
917              textField.Text.Should().Be(&quot;asdf&quot;);
918              await comp.InvokeAsync(() =&gt; form.Instance.ResetAsync());
919              textField.Value.Should().BeNullOrEmpty();
920              textField.Text.Should().BeNullOrEmpty();
921              textFieldComp.Find(&quot;input&quot;).Input(&quot;asdf&quot;);
922              textField.Value.Should().Be(&quot;asdf&quot;);
923              textField.Text.Should().Be(&quot;asdf&quot;);
924              comp.Find(&quot;button.reset&quot;).Click();
925              textField.Value.Should().BeNullOrEmpty();
926              textField.Text.Should().BeNullOrEmpty();
927          }
928          [Test]
929          public async Task FormReset_Should_ClearNumericField()
930          {
931              var comp = Context.RenderComponent&lt;FormResetTest&gt;();
932              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
933              var numericFieldComp = comp.FindComponent&lt;MudNumericField&lt;int?&gt;&gt;();
934              var numericField = numericFieldComp.Instance;
935              numericFieldComp.Find(&quot;input&quot;).Input(10);
936              numericField.Value.Should().Be(10);
937              numericField.Text.Should().Be(&quot;10&quot;);
938              await comp.InvokeAsync(() =&gt; form.ResetAsync());
939              numericField.Value.Should().BeNull();
940              numericField.Text.Should().BeNullOrEmpty();
941              numericFieldComp.Find(&quot;input&quot;).Input(20);
942              numericField.Value.Should().Be(20);
943              numericField.Text.Should().Be(&quot;20&quot;);
944              comp.Find(&quot;button.reset&quot;).Click();
945              numericField.Value.Should().BeNull();
946              numericField.Text.Should().BeNullOrEmpty();
947          }
948          [Test]
949          public async Task FormReset_Should_ClearDatePicker()
950          {
951              var comp = Context.RenderComponent&lt;FormResetTest&gt;();
952              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
953              var datePickerComp = comp.FindComponent&lt;MudDatePicker&gt;();
954              var datePicker = datePickerComp.Instance;
955              var testDate = new DateTime(2020, 05, 24);
956              var testDateString = testDate.ToShortDateString();  
957              datePickerComp.Find(&quot;input&quot;).Change(testDateString);
958              datePicker.Date.Should().Be(testDate);
959              datePicker.Text.Should().Be(testDateString);
960              await comp.InvokeAsync(() =&gt; form.ResetAsync());
961              datePicker.Date.Should().BeNull();
962              datePicker.Text.Should().BeNullOrEmpty();
963              datePickerComp.Find(&quot;input&quot;).Change(testDateString);
964              datePicker.Date.Should().Be(testDate);
965              datePicker.Text.Should().Be(testDateString);
966              comp.Find(&quot;button.reset&quot;).Click();
967              datePicker.Date.Should().BeNull();
968              datePicker.Text.Should().BeNullOrEmpty();
969          }
970          [Test]
971          public async Task FormReset_Should_ResetFormStateForFieldsThatWrapMudInput()
972          {
973              var comp = Context.RenderComponent&lt;FormResetTest&gt;();
974              var form = comp.FindComponent&lt;MudForm&gt;().Instance;
975              var datePickerComp = comp.FindComponent&lt;MudDatePicker&gt;();
976              var textFieldComp = comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;()[1]; 
977              var numericFieldComp = comp.FindComponent&lt;MudNumericField&lt;int?&gt;&gt;();
978              var testDate = new DateTime(2022, 07, 29);
979              var testDateString = testDate.ToShortDateString();  
980              form.IsValid.Should().Be(false);
981              datePickerComp.Find(&quot;input&quot;).Change(testDateString);
982              form.IsValid.Should().Be(false);
983              textFieldComp.Find(&quot;input&quot;).Input(&quot;Some value&quot;);
984              form.IsValid.Should().Be(false);
985              numericFieldComp.Find(&quot;input&quot;).Input(&quot;1&quot;);
986              form.IsValid.Should().Be(true);
987              await comp.InvokeAsync(() =&gt; form.ResetAsync());
988              form.IsValid.Should().Be(false); 
989          }
990          [Test]
991          public async Task MudForm_Should_RegisterOnlyTopSubscribeToParentFormFormControls()
992          {
993              var comp = Context.RenderComponent&lt;FormShouldRegisterOnlyTopSubscribeToParentFormFormControlsTest&gt;();
994              var form = comp.FindComponent&lt;MudFormTestable&gt;().Instance;
995              Assert.AreEqual(14, form.FormControls.Count);
996          }
997          [Test]
998          public async Task MudForm_Validation_Should_OverrideFieldValidation()
999          {
1000              var comp = Context.RenderComponent&lt;FormValidationOverrideFieldValidationTest&gt;();
1001              var textFields = comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;();
1002              var numericFields = comp.FindComponents&lt;MudNumericField&lt;int&gt;&gt;();
1003              var defaultValidation = &quot;v&quot;;
1004              textFields[0].Instance.Validation.Should().Be(defaultValidation);
1005              textFields[1].Instance.Validation.Should().Be(defaultValidation);
1006              textFields[2].Instance.Validation.Should().Be(defaultValidation);
1007              textFields[3].Instance.Validation.Should().Be(&quot;a&quot;);
1008              numericFields[0].Instance.Validation.Should().Be(defaultValidation);
1009              numericFields[1].Instance.Validation.Should().NotBe(defaultValidation);
1010              numericFields[2].Instance.Validation.Should().Be(defaultValidation);
1011              numericFields[3].Instance.Validation.Should().Be(&quot;b&quot;);
1012          }
1013          [Test]
1014          public async Task FieldValidationWithoutRequiredForm_ShouldNot_Validate()
1015          {
1016              var comp = Context.RenderComponent&lt;FieldValidationWithoutRequiredFormTest&gt;();
1017              Assert.Throws&lt;ElementNotFoundException&gt;(() =&gt; comp.Find(&quot;.mud-input-error&quot;));
1018          }
1019          [Test]
1020          public async Task FieldChangedEventShouldTriggerTest()
1021          {
1022              var comp = Context.RenderComponent&lt;FormFieldChangedTest&gt;();
1023              var formsComp = comp.FindComponents&lt;MudForm&gt;();
1024              var textField = comp.FindComponent&lt;MudTextField&lt;string&gt;&gt;().Instance;
1025              var numeric = comp.FindComponent&lt;MudNumericField&lt;int&gt;&gt;().Instance;
1026              var radioGroup = comp.FindComponent&lt;MudRadioGroup&lt;string&gt;&gt;().Instance;
1027              comp.Instance.FormFieldChangedEventArgs.Should().BeNull();
1028              await comp.InvokeAsync(() =&gt; textField.SetText(&quot;new value&quot;));
1029              comp.Instance.FormFieldChangedEventArgs.NewValue.Should().Be(&quot;new value&quot;);
1030              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, textField);
1031              numeric.Value.Should().Be(0);
1032              await comp.InvokeAsync(() =&gt; numeric.Increment());
1033              comp.Instance.FormFieldChangedEventArgs.NewValue.Should().Be(1);
1034              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, numeric);
1035              var inputs = comp.FindAll(&quot;input&quot;).ToArray();
1036              radioGroup.SelectedOption.Should().Be(null);
1037              inputs[2].Click();
1038              radioGroup.SelectedOption.Should().Be(&quot;1&quot;);
1039              comp.Instance.FormFieldChangedEventArgs.NewValue.Should().Be(&quot;1&quot;);
1040              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, radioGroup);
<span onclick='openModal()' class='match'>1041              var fileContent = InputFileContent.CreateFromText(&quot;&quot;, &quot;upload.txt&quot;);
1042              var mudFile = comp.FindComponent&lt;MudFileUpload&lt;IBrowserFile&gt;&gt;().Instance;
</span>1043              var input = comp.FindComponent&lt;InputFile&gt;();
1044              input.UploadFiles(fileContent);
1045              (comp.Instance.FormFieldChangedEventArgs.NewValue is IBrowserFile).Should().BeTrue();
1046              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, mudFile);
1047          }
1048          [Test]
1049          public async Task FieldChangedEventShouldTriggerPickerTest()
1050          {
1051              var comp = Context.RenderComponent&lt;FormFieldChangedPickerTest&gt;();
1052              var formsComp = comp.FindComponents&lt;MudForm&gt;();
1053              var datePicker = comp.FindComponent&lt;MudDatePicker&gt;();
1054              var timePicker = comp.FindComponent&lt;MudTimePicker&gt;();
1055              var colorPicker = comp.FindComponent&lt;MudColorPicker&gt;();
1056              comp.Instance.FormFieldChangedEventArgs.Should().BeNull();
1057              var dateString = new DateTime(2022, 04, 03).ToShortDateString();
1058              await comp.InvokeAsync(() =&gt; datePicker.Find(&quot;input&quot;).Change(dateString));
1059              comp.Instance.FormFieldChangedEventArgs.NewValue.Should().Be(new DateTime(2022, 04, 03));
1060              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, datePicker.Instance);
1061              await comp.InvokeAsync(() =&gt; timePicker.Find(&quot;input&quot;).Change(&quot;00:45&quot;));
1062              comp.Instance.FormFieldChangedEventArgs.NewValue.Should().Be(new TimeSpan(00, 45, 00));
1063              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, timePicker.Instance);
1064              await comp.InvokeAsync(() =&gt; colorPicker.Find(&quot;input&quot;).Change(&quot;#180f6fff&quot;));
1065              comp.Instance.FormFieldChangedEventArgs.NewValue.Should().Be(new MudColor(&quot;#180f6fff&quot;));
1066              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, colorPicker.Instance);
1067          }
1068          [Test]
1069          public async Task FormAutoValidationSetTest()
1070          {
1071              var comp = Context.RenderComponent&lt;FormAutomaticValidationTest&gt;();
1072              var textComps = comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;();
1073              var dateComps = comp.FindComponents&lt;MudDatePicker&gt;();
1074              textComps[0].Instance.For.Should().NotBeNull(); 
1075              textComps[1].Instance.For.Should().BeNull(); 
1076              dateComps[0].Instance.For.Should().NotBeNull(); 
1077              dateComps[1].Instance.For.Should().BeNull(); 
1078              textComps[0].Instance.Validation.Should().NotBeNull(); 
1079              textComps[1].Instance.Validation.Should().BeNull(); 
1080              dateComps[0].Instance.Validation.Should().NotBeNull(); 
1081              dateComps[1].Instance.Validation.Should().BeNull(); 
1082          }
1083          [Test]
1084          public async Task FormReadonlyTest()
1085          {
1086              var comp = Context.RenderComponent&lt;FormReadOnlyDisabledTest&gt;();
1087              var textField = comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;()[0];
1088              var maskedTextField = comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;()[1];
1089              var checkBox = comp.FindComponent&lt;MudCheckBox&lt;bool&gt;&gt;();
1090              var radioGroup = comp.FindComponent&lt;MudRadioGroup&lt;string&gt;&gt;();
1091              var switch_ = comp.FindComponent&lt;MudSwitch&lt;bool&gt;&gt;();
1092              var select = comp.FindComponent&lt;MudSelect&lt;string&gt;&gt;(); 
1093              var colorPicker = comp.FindComponent&lt;MudColorPicker&gt;();
1094              var datePicker = comp.FindComponent&lt;MudDatePicker&gt;();
1095              var dateRangePicker = comp.FindComponent&lt;MudDateRangePicker&gt;();
1096              var timePicker = comp.FindComponent&lt;MudTimePicker&gt;();
1097              var autocomplete = comp.FindComponent&lt;MudAutocomplete&lt;string&gt;&gt;();
1098              var numericField = comp.FindComponent&lt;MudNumericField&lt;int&gt;&gt;();
1099              var fileUpload = comp.FindComponent&lt;MudFileUpload&lt;IBrowserFile&gt;&gt;();
1100              textField.Find(&quot;input&quot;).HasAttribute(&quot;readonly&quot;).Should().BeFalse();
1101              maskedTextField.Find(&quot;input&quot;).HasAttribute(&quot;readonly&quot;).Should().BeFalse();
1102              checkBox.Find(&quot;label&quot;).ClassList.Should().NotContain(&quot;mud-readonly&quot;);
1103              radioGroup.Find(&quot;label&quot;).ClassList.Should().NotContain(&quot;mud-readonly&quot;);
1104              switch_.Find(&quot;label&quot;).ClassList.Should().NotContain(&quot;mud-readonly&quot;);
1105              autocomplete.Find(&quot;input&quot;).HasAttribute(&quot;readonly&quot;).Should().BeFalse();
1106              numericField.Find(&quot;input&quot;).HasAttribute(&quot;readonly&quot;).Should().BeFalse();
1107              fileUpload.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse(); 
1108              comp.SetParametersAndRender(parameters =&gt; parameters.Add(p =&gt; p.FormReadOnly, true).Add(p =&gt; p.CompReadOnly, false));
1109              textField.Find(&quot;input&quot;).HasAttribute(&quot;readonly&quot;).Should().BeTrue();
1110              maskedTextField.Find(&quot;input&quot;).HasAttribute(&quot;readonly&quot;).Should().BeTrue();
1111              checkBox.Find(&quot;label&quot;).ClassList.Should().Contain(&quot;mud-readonly&quot;);
1112              radioGroup.Find(&quot;label&quot;).ClassList.Should().Contain(&quot;mud-readonly&quot;);
1113              switch_.Find(&quot;label&quot;).ClassList.Should().Contain(&quot;mud-readonly&quot;);
1114              autocomplete.Find(&quot;input&quot;).HasAttribute(&quot;readonly&quot;).Should().BeTrue();
1115              numericField.Find(&quot;input&quot;).HasAttribute(&quot;readonly&quot;).Should().BeTrue();
1116              fileUpload.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1117              comp.SetParametersAndRender(parameters =&gt; parameters.Add(p =&gt; p.FormReadOnly, false).Add(p =&gt; p.CompReadOnly, true));
1118              textField.Find(&quot;input&quot;).HasAttribute(&quot;readonly&quot;).Should().BeTrue();
1119              maskedTextField.Find(&quot;input&quot;).HasAttribute(&quot;readonly&quot;).Should().BeTrue();
1120              checkBox.Find(&quot;label&quot;).ClassList.Should().Contain(&quot;mud-readonly&quot;);
1121              radioGroup.Find(&quot;label&quot;).ClassList.Should().Contain(&quot;mud-readonly&quot;);
1122              switch_.Find(&quot;label&quot;).ClassList.Should().Contain(&quot;mud-readonly&quot;);
1123              autocomplete.Find(&quot;input&quot;).HasAttribute(&quot;readonly&quot;).Should().BeTrue();
1124              numericField.Find(&quot;input&quot;).HasAttribute(&quot;readonly&quot;).Should().BeTrue();
1125              fileUpload.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse(); 
1126              comp.SetParametersAndRender(parameters =&gt; parameters.Add(p =&gt; p.FormReadOnly, false).Add(p =&gt; p.CompReadOnly, false));
1127              textField.Find(&quot;input&quot;).HasAttribute(&quot;readonly&quot;).Should().BeFalse();
1128              maskedTextField.Find(&quot;input&quot;).HasAttribute(&quot;readonly&quot;).Should().BeFalse();
1129              checkBox.Find(&quot;label&quot;).ClassList.Should().NotContain(&quot;mud-readonly&quot;);
1130              radioGroup.Find(&quot;label&quot;).ClassList.Should().NotContain(&quot;mud-readonly&quot;);
1131              switch_.Find(&quot;label&quot;).ClassList.Should().NotContain(&quot;mud-readonly&quot;);
1132              autocomplete.Find(&quot;input&quot;).HasAttribute(&quot;readonly&quot;).Should().BeFalse();
1133              numericField.Find(&quot;input&quot;).HasAttribute(&quot;readonly&quot;).Should().BeFalse();
1134              fileUpload.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1135          }
1136          [Test]
1137          public async Task FormDisabledTest()
1138          {
1139              var comp = Context.RenderComponent&lt;FormReadOnlyDisabledTest&gt;();
1140              var textField = comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;()[0];
1141              var maskedTextField = comp.FindComponents&lt;MudTextField&lt;string&gt;&gt;()[1];
1142              var checkBox = comp.FindComponent&lt;MudCheckBox&lt;bool&gt;&gt;();
1143              var radioGroup = comp.FindComponent&lt;MudRadioGroup&lt;string&gt;&gt;();
1144              var switch_ = comp.FindComponent&lt;MudSwitch&lt;bool&gt;&gt;();
1145              var select = comp.FindComponent&lt;MudSelect&lt;string&gt;&gt;();
1146              var colorPicker = comp.FindComponent&lt;MudColorPicker&gt;();
1147              var datePicker = comp.FindComponent&lt;MudDatePicker&gt;();
1148              var dateRangePicker = comp.FindComponent&lt;MudDateRangePicker&gt;();
1149              var timePicker = comp.FindComponent&lt;MudTimePicker&gt;();
1150              var autocomplete = comp.FindComponent&lt;MudAutocomplete&lt;string&gt;&gt;();
1151              var numericField = comp.FindComponent&lt;MudNumericField&lt;int&gt;&gt;();
1152              var fileUpload = comp.FindComponent&lt;MudFileUpload&lt;IBrowserFile&gt;&gt;();
1153              textField.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1154              maskedTextField.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1155              checkBox.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1156              radioGroup.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1157              switch_.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1158              select.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1159              colorPicker.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1160              datePicker.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1161              dateRangePicker.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1162              timePicker.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1163              autocomplete.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1164              numericField.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1165              fileUpload.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1166              comp.SetParametersAndRender(parameters =&gt; parameters.Add(p =&gt; p.FormDisabled, true).Add(p =&gt; p.CompDisabled, false));
1167              textField.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1168              maskedTextField.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1169              checkBox.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1170              radioGroup.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1171              switch_.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1172              select.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1173              colorPicker.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1174              datePicker.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1175              dateRangePicker.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1176              timePicker.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1177              autocomplete.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1178              numericField.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1179              fileUpload.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1180              comp.SetParametersAndRender(parameters =&gt; parameters.Add(p =&gt; p.FormDisabled, false).Add(p =&gt; p.CompDisabled, true));
1181              textField.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1182              maskedTextField.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1183              checkBox.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1184              radioGroup.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1185              switch_.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1186              select.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1187              colorPicker.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1188              datePicker.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1189              dateRangePicker.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1190              timePicker.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1191              autocomplete.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1192              numericField.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1193              fileUpload.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeTrue();
1194              comp.SetParametersAndRender(parameters =&gt; parameters.Add(p =&gt; p.FormDisabled, false).Add(p =&gt; p.CompDisabled, false));
1195              textField.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1196              maskedTextField.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1197              checkBox.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1198              radioGroup.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1199              switch_.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1200              select.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1201              colorPicker.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1202              datePicker.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1203              dateRangePicker.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1204              timePicker.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1205              autocomplete.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1206              numericField.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1207              fileUpload.Find(&quot;input&quot;).HasAttribute(&quot;disabled&quot;).Should().BeFalse();
1208          }
1209          [Test]
1210          public async Task FormNestedReadOnlyTest()
1211          {
1212              var comp = Context.RenderComponent&lt;FormNestedReadOnlyDisabledTest&gt;();
1213              comp.FindAll(&quot;.mud-checkbox.mud-readonly&quot;).Count.Should().Be(0);
1214              comp.SetParametersAndRender(parameters =&gt; parameters.Add(p =&gt; p.ReadOnly, true));
1215              comp.FindAll(&quot;.mud-checkbox.mud-readonly&quot;).Count.Should().Be(1);
1216              comp.SetParametersAndRender(parameters =&gt; parameters.Add(p =&gt; p.NestedReadOnly, true));
1217              comp.FindAll(&quot;.mud-checkbox.mud-readonly&quot;).Count.Should().Be(1);
1218              comp.SetParametersAndRender(parameters =&gt; parameters.Add(p =&gt; p.ReadOnly, true).Add(p =&gt; p.NestedReadOnly, true));
1219              comp.FindAll(&quot;.mud-checkbox.mud-readonly&quot;).Count.Should().Be(1);
1220              comp.SetParametersAndRender(parameters =&gt; parameters.Add(p =&gt; p.ReadOnly, false).Add(p =&gt; p.NestedReadOnly, false));
1221              comp.FindAll(&quot;.mud-checkbox.mud-readonly&quot;).Count.Should().Be(0);
1222          }
1223          [Test]
1224          public async Task FormNestedDisabledTest()
1225          {
1226              var comp = Context.RenderComponent&lt;FormNestedReadOnlyDisabledTest&gt;();
1227              comp.FindAll(&quot;.mud-checkbox.mud-disabled&quot;).Count.Should().Be(0);
1228              comp.SetParametersAndRender(parameters =&gt; parameters.Add(p =&gt; p.Disabled, true));
1229              comp.FindAll(&quot;.mud-checkbox.mud-disabled&quot;).Count.Should().Be(1);
1230              comp.SetParametersAndRender(parameters =&gt; parameters.Add(p =&gt; p.NestedDisabled, true));
1231              comp.FindAll(&quot;.mud-checkbox.mud-disabled&quot;).Count.Should().Be(1);
1232              comp.SetParametersAndRender(parameters =&gt; parameters.Add(p =&gt; p.Disabled, true).Add(p =&gt; p.NestedDisabled, true));
1233              comp.FindAll(&quot;.mud-checkbox.mud-disabled&quot;).Count.Should().Be(1);
1234              comp.SetParametersAndRender(parameters =&gt; parameters.Add(p =&gt; p.Disabled, false).Add(p =&gt; p.NestedDisabled, false));
1235              comp.FindAll(&quot;.mud-checkbox.mud-disabled&quot;).Count.Should().Be(0);
1236          }
1237          [Test]
1238          public async Task FormWithChildFormTest()
1239          {
1240              var comp = Context.RenderComponent&lt;FormWithChildForm&gt;();
1241              var childFormSwitch = comp.Find(&quot;.mud-switch-input&quot;);
1242              var parentForm = comp.FindComponent&lt;MudForm&gt;().Instance;
1243              var parentTextFieldCmp = comp.FindComponent&lt;MudTextField&lt;string&gt;&gt;();
1244              var parentTextField = parentTextFieldCmp.Instance;
1245              parentForm.IsValid.Should().Be(false);
1246              parentTextField.Error.Should().BeFalse();
1247              parentTextField.ErrorText.Should().BeNullOrEmpty();
1248              parentTextFieldCmp.Find(&quot;input&quot;).Change(&quot;Marilyn Manson&quot;);
1249              parentForm.IsValid.Should().Be(true);
1250              parentForm.Errors.Length.Should().Be(0);
1251              parentTextField.Error.Should().BeFalse();
1252              parentTextField.ErrorText.Should().BeNullOrEmpty();
1253              childFormSwitch.Change(true);
1254              var forms = comp.FindComponents&lt;MudForm&gt;();
1255              forms.Count.Should().Be(2);
1256              var childForm = forms[1];
1257              childForm.Instance.IsValid.Should().BeFalse();
1258              parentForm.IsValid.Should().Be(false);
1259              childFormSwitch.Change(false);
1260              forms = comp.FindComponents&lt;MudForm&gt;();
1261              forms.Count.Should().Be(1);
1262              parentForm.IsValid.Should().BeTrue();
1263          }
1264      }
1265  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-GoogleTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from MudBlazor-MDEwOlJlcG9zaXRvcnkyODg0Mjg2NzY=-flat-FormTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>407              var sendTask = server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?error=OMG&amp;error_description=SoBad&amp;error_uri=foobar&amp;state=protected_state&quot;,
408                  &quot;.AspNetCore.Correlation.Google.correlationId=N&quot;);
409              if (redirect)
</pre></code></div>
                <div class="column column_space"><pre><code>1041              var fileContent = InputFileContent.CreateFromText(&quot;&quot;, &quot;upload.txt&quot;);
1042              var mudFile = comp.FindComponent&lt;MudFileUpload&lt;IBrowserFile&gt;&gt;().Instance;
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    