
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 12.527634487840825%, Tokens: 10, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-NestedDataReaderTests.cs</h3>
            <pre><code>1  using NUnit.Framework;
2  using System;
3  using System.Threading.Tasks;
4  using static Npgsql.Tests.TestUtil;
5  namespace Npgsql.Tests;
6  public class NestedDataReaderTests : TestBase
7  {
8      [Test]
9      public async Task Basic()
10      {
11          await using var conn = await OpenConnectionAsync();
12          await using var command = new NpgsqlCommand(@"SELECT ARRAY[ROW(1, 2, 3), ROW(4, 5, 6)]
13                                                      UNION ALL
14                                                      SELECT ARRAY[ROW(7, 8, 9), ROW(10, 11, 12)]", conn);
15          await using var reader = await command.ExecuteReaderAsync();
16          for (var i = 0; i < 2; i++)
17          {
18              await reader.ReadAsync();
19              using var nestedReader = reader.GetData(0);
20              Assert.That(nestedReader.HasRows, Is.True);
21              for (var j = 0; j < 2; j++)
22              {
23                  Assert.That(nestedReader.Read(), Is.True);
24                  Assert.That(nestedReader.FieldCount, Is.EqualTo(3));
25                  Assert.That(nestedReader.GetFieldType(0), Is.EqualTo(typeof(int)));
26                  Assert.That(nestedReader.GetDataTypeName(0), Is.EqualTo("integer"));
27                  Assert.That(nestedReader.GetName(0), Is.EqualTo("?column?"));
28                  Assert.Throws<NotSupportedException>(() => nestedReader.GetOrdinal("c0"));
29                  for (var k = 0; k < 3; k++)
30                  {
31                      Assert.That(nestedReader.GetInt32(k), Is.EqualTo(1 + 6 * i + j * 3 + k));
32                      Assert.That(nestedReader.GetValue(k), Is.EqualTo(1 + 6 * i + j * 3 + k));
33                  }
34              }
35              if (i == 0)
36                  Assert.That(nestedReader.Read(), Is.False);
37              Assert.That(nestedReader.NextResult(), Is.False);
38              Assert.That(nestedReader.HasRows, Is.False);
39          }
40      }
41      [Test]
42      public async Task Different_field_count()
43      {
44          await using var conn = await OpenConnectionAsync();
45          await using var command = new NpgsqlCommand(@"SELECT ARRAY[ROW(1), ROW(), ROW('2'::TEXT, 3), ROW(4)]", conn);
46          await using var reader = await command.ExecuteReaderAsync();
47          Assert.That(await reader.ReadAsync(), Is.True);
48          using var nestedReader = reader.GetData(0);
49          Assert.That(nestedReader.Read(), Is.True);
50          Assert.That(nestedReader.FieldCount, Is.EqualTo(1));
51          Assert.That(nestedReader.GetFieldType(0), Is.EqualTo(typeof(int)));
52          Assert.That(nestedReader.GetInt32(0), Is.EqualTo(1));
53          Assert.That(nestedReader.Read(), Is.True);
54          Assert.That(nestedReader.FieldCount, Is.EqualTo(0));
55          Assert.That(nestedReader.Read(), Is.True);
56          Assert.That(nestedReader.FieldCount, Is.EqualTo(2));
57          Assert.That(nestedReader.GetFieldType(0), Is.EqualTo(typeof(string)));
58          Assert.That(nestedReader.GetFieldType(1), Is.EqualTo(typeof(int)));
59          Assert.That(nestedReader.GetString(0), Is.EqualTo("2"));
60          Assert.That(nestedReader.GetInt32(1), Is.EqualTo(3));
61          Assert.That(nestedReader.Read(), Is.True);
62          Assert.That(nestedReader.GetFieldType(0), Is.EqualTo(typeof(int)));
63          Assert.That(nestedReader.GetInt32(0), Is.EqualTo(4));
64          Assert.That(nestedReader.Read(), Is.False);
65      }
66      [Test]
67      public async Task Nested()
68      {
69          await using var conn = await OpenConnectionAsync();
70          await using var command = new NpgsqlCommand(@"SELECT
71                  ARRAY[
72                      ROW(
73                          ARRAY[
74                              ROW('row000'::TEXT, NULL::TEXT),
75                              ROW('row010'::TEXT, 'row011'::TEXT)
76                          ]
77                      ),
78                      ROW(
79                          ARRAY[
80                              ROW('row100'::TEXT, NULL::TEXT),
81                              ROW('row110'::TEXT, 'row111'::TEXT)
82                          ]
83                      )
84                  ], 2", conn);
85          await using var reader = await command.ExecuteReaderAsync();
86          for (var i = 0; i < 1; i++)
87          {
88              await reader.ReadAsync();
89              using var nestedReader = reader.GetData(0);
90              for (var j = 0; j < 2; j++)
91              {
92                  Assert.That(nestedReader.Read(), Is.True);
93                  var nestedReader2 = nestedReader.GetData(0);
94                  for (var k = 0; k < 2; k++)
95                  {
96                      Assert.That(nestedReader2.Read(), Is.True);
97                      for (var l = 0; l < 2; l++)
98                      {
99                          if (k == 0 && l == 1)
100                          {
101                              Assert.That(nestedReader2.IsDBNull(l), Is.True);
102                              Assert.That(nestedReader2.GetValue(l), Is.EqualTo(DBNull.Value));
103                              Assert.That(nestedReader2.GetProviderSpecificValue(l), Is.EqualTo(DBNull.Value));
104                          }
105                          else
106                          {
107                              Assert.That(nestedReader2.GetString(l), Is.EqualTo("row" + j + k + l));
108                          }
109                      }
110                  }
111              }
112              Assert.That(reader.GetInt32(1), Is.EqualTo(2));
113          }
114      }
115      [Test]
116      public async Task Single_row()
117      {
118          await using var conn = await OpenConnectionAsync();
119          await using var command = new NpgsqlCommand("SELECT ROW(1, ARRAY[ROW(2), ROW(3)])", conn);
120          await using var reader = await command.ExecuteReaderAsync();
121          await reader.ReadAsync();
122          using var nestedReader = reader.GetData(0);
123          Assert.That(nestedReader.Read(), Is.True);
124          Assert.That(nestedReader.FieldCount, Is.EqualTo(2));
125          Assert.That(nestedReader.GetInt32(0), Is.EqualTo(1));
126          using var nestedReader2 = nestedReader.GetData(1);
127          for (var i = 0; i < 2; i++)
128          {
129              Assert.That(nestedReader2.Read(), Is.True);
130              Assert.That(nestedReader2.FieldCount, Is.EqualTo(1));
131              Assert.That(nestedReader2.GetInt32(0), Is.EqualTo(2 + i));
132          }
133          Assert.That(nestedReader2.Read(), Is.False);
134      }
135      [Test]
136      public async Task Empty_array()
137      {
138          await using var conn = await OpenConnectionAsync();
139          await using var command = new NpgsqlCommand("SELECT ARRAY[]::RECORD[]", conn);
140          await using var reader = await command.ExecuteReaderAsync();
141          await reader.ReadAsync();
142          using var nestedReader = reader.GetData(0);
143          Assert.That(nestedReader.Read(), Is.False);
144          Assert.That(nestedReader.NextResult(), Is.False);
145      }
146      [Test]
147      public async Task Composite()
148      {
149          await using var conn = await OpenConnectionAsync();
150          var typeName = await GetTempTypeName(conn);
151          await conn.ExecuteNonQueryAsync($"CREATE TYPE {typeName} AS (c0 integer, c1 text)");
152          conn.ReloadTypes();
153          var sqls = new string[]
154          {
155              $"SELECT ROW('1', '2')::{typeName}",
156              $"SELECT ARRAY[ROW('1', '2')::{typeName}]"
157          };
158          foreach (var sql in sqls)
159          {
160              await using var command = new NpgsqlCommand(sql, conn);
161              await using var reader = await command.ExecuteReaderAsync();
162              await reader.ReadAsync();
163              using var nestedReader = reader.GetData(0);
164              nestedReader.Read();
165              Assert.That(nestedReader.GetDataTypeName(0), Is.EqualTo("integer"));
166              Assert.That(nestedReader.GetDataTypeName(1), Is.EqualTo("text"));
167              Assert.That(nestedReader.GetInt32(0), Is.EqualTo(1));
168              Assert.That(nestedReader.GetString(1), Is.EqualTo("2"));
169              Assert.That(nestedReader.GetName(0), Is.EqualTo("c0"));
170              Assert.That(nestedReader.GetName(1), Is.EqualTo("c1"));
171              Assert.That(nestedReader.GetOrdinal("C1"), Is.EqualTo(1));
172              Assert.That(nestedReader["C1"], Is.EqualTo("2"));
173              Assert.Throws<IndexOutOfRangeException>(() => nestedReader.GetOrdinal("ABC"));
174          }
175      }
176      [Test]
177      public void GetBytes()
178      {
179          using var conn = OpenConnection();
180          using var command = new NpgsqlCommand(@"SELECT ROW('\x010203'::BYTEA, NULL::BYTEA)", conn);
181          using var reader = command.ExecuteReader();
182          reader.Read();
183          using var nestedReader = reader.GetData(0);
184          nestedReader.Read();
185          Assert.That(nestedReader.GetFieldType(0), Is.EqualTo(typeof(byte[])));
186          var buf = new byte[4];
187          Assert.That(nestedReader.GetBytes(0, 0, null, 0, 3), Is.EqualTo(3));
188          Assert.That(nestedReader.GetBytes(0, 0, null, 0, 4), Is.EqualTo(3));
189          Assert.That(nestedReader.GetBytes(0, 0, buf, 0, 3), Is.EqualTo(3));
190          Assert.That(nestedReader.GetBytes(0, 0, buf, 0, 4), Is.EqualTo(3));
191          CollectionAssert.AreEqual(new byte[] { 1, 2, 3, 0 }, buf);
192          buf = new byte[2];
193          Assert.That(nestedReader.GetBytes(0, 0, buf, 0, 2), Is.EqualTo(2));
194          CollectionAssert.AreEqual(new byte[] { 1, 2 }, buf);
195          buf = new byte[2];
196          Assert.That(nestedReader.GetBytes(0, 1, buf, 1, 1), Is.EqualTo(1));
197          CollectionAssert.AreEqual(new byte[] { 0, 2 }, buf);
198          Assert.That(nestedReader.GetBytes(0, 2, buf, 1, 1), Is.EqualTo(1));
199          CollectionAssert.AreEqual(new byte[] { 0, 3 }, buf);
200          Assert.Throws<InvalidCastException>(() => nestedReader.GetBytes(1, 0, buf, 0, 1));
201          Assert.Throws<ArgumentOutOfRangeException>(() => nestedReader.GetBytes(0, 4, buf, 0, 1));
202      }
203      [Test]
204      public async Task Throw_after_next_row()
205      {
206          await using var conn = await OpenConnectionAsync();
207          await using var command = new NpgsqlCommand(@"SELECT ROW(1) UNION ALL SELECT ROW(2) UNION ALL SELECT ROW(3)", conn);
208          await using var reader = await command.ExecuteReaderAsync();
209          Assert.That(await reader.ReadAsync(), Is.True);
<span onclick='openModal()' class='match'>210          var nestedReader = reader.GetData(0);
211          nestedReader.Read();
212          await reader.ReadAsync();
213          Assert.Throws<InvalidOperationException>(() => nestedReader.IsDBNull(0));
214          nestedReader = reader.GetData(0);
215          reader.Read();
216          Assert.Throws<InvalidOperationException>(() => nestedReader.Read());
</span>217          nestedReader = reader.GetData(0);
218          nestedReader.Read();
219          Assert.That(nestedReader.IsDBNull(0), Is.False);
220      }
221  }
</code></pre>
        </div>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-GoogleTests.cs</h3>
            <pre><code>1  using Microsoft.AspNetCore.Authentication.OAuth;
2  using Microsoft.AspNetCore.Builder;
3  using Microsoft.AspNetCore.DataProtection;
4  using Microsoft.AspNetCore.Hosting;
5  using Microsoft.AspNetCore.Http;
6  using Microsoft.AspNetCore.TestHost;
7  using Microsoft.AspNetCore.WebUtilities;
8  using Microsoft.Extensions.DependencyInjection;
9  using Microsoft.Extensions.Logging.Abstractions;
10  using Newtonsoft.Json;
11  using System;
12  using System.Collections.Generic;
13  using System.Linq;
14  using System.Net;
15  using System.Net.Http;
16  using System.Security.Claims;
17  using System.Text;
18  using System.Text.Encodings.Web;
19  using System.Threading.Tasks;
20  using Xunit;
21  namespace Microsoft.AspNetCore.Authentication.Google
22  {
23      public class GoogleTests : RemoteAuthenticationTests<GoogleOptions>
24      {
25          protected override string DefaultScheme => GoogleDefaults.AuthenticationScheme;
26          protected override Type HandlerType => typeof(GoogleHandler);
27          protected override bool SupportsSignIn { get => false; }
28          protected override bool SupportsSignOut { get => false; }
29          protected override void RegisterAuth(AuthenticationBuilder services, Action<GoogleOptions> configure)
30          {
31              services.AddGoogle(o =>
32              {
33                  ConfigureDefaults(o);
34                  configure.Invoke(o);
35              });
36          }
37          protected override void ConfigureDefaults(GoogleOptions o)
38          {
39              o.ClientId = "whatever";
40              o.ClientSecret = "whatever";
41              o.SignInScheme = "auth1";
42          }
43          [Fact]
44          public async Task ChallengeWillTriggerRedirection()
45          {
46              var server = CreateServer(o =>
47              {
48                  o.ClientId = "Test Id";
49                  o.ClientSecret = "Test Secret";
50              });
51              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/challenge");
52              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
53              var location = transaction.Response.Headers.Location.ToString();
54              Assert.Contains("https:&bsol;&bsol;accounts.google.com/o/oauth2/v2/auth?response_type=code", location);
55              Assert.Contains("&client_id=", location);
56              Assert.Contains("&redirect_uri=", location);
57              Assert.Contains("&scope=", location);
58              Assert.Contains("&state=", location);
59              Assert.DoesNotContain("access_type=", location);
60              Assert.DoesNotContain("prompt=", location);
61              Assert.DoesNotContain("approval_prompt=", location);
62              Assert.DoesNotContain("login_hint=", location);
63              Assert.DoesNotContain("include_granted_scopes=", location);
64          }
65          [Fact]
66          public async Task SignInThrows()
67          {
68              var server = CreateServer(o =>
69              {
70                  o.ClientId = "Test Id";
71                  o.ClientSecret = "Test Secret";
72              });
73              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/signIn");
74              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
75          }
76          [Fact]
77          public async Task SignOutThrows()
78          {
79              var server = CreateServer(o =>
80              {
81                  o.ClientId = "Test Id";
82                  o.ClientSecret = "Test Secret";
83              });
84              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/signOut");
85              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
86          }
87          [Fact]
88          public async Task ForbidThrows()
89          {
90              var server = CreateServer(o =>
91              {
92                  o.ClientId = "Test Id";
93                  o.ClientSecret = "Test Secret";
94              });
95              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/signOut");
96              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
97          }
98          [Fact]
99          public async Task Challenge401WillNotTriggerRedirection()
100          {
101              var server = CreateServer(o =>
102              {
103                  o.ClientId = "Test Id";
104                  o.ClientSecret = "Test Secret";
105              });
106              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/401");
107              Assert.Equal(HttpStatusCode.Unauthorized, transaction.Response.StatusCode);
108          }
109          [Fact]
110          public async Task ChallengeWillSetCorrelationCookie()
111          {
112              var server = CreateServer(o =>
113              {
114                  o.ClientId = "Test Id";
115                  o.ClientSecret = "Test Secret";
116              });
117              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/challenge");
118              Assert.Contains(transaction.SetCookie, cookie => cookie.StartsWith(".AspNetCore.Correlation.Google."));
119          }
120          [Fact]
121          public async Task ChallengeWillSetDefaultScope()
122          {
123              var server = CreateServer(o =>
124              {
125                  o.ClientId = "Test Id";
126                  o.ClientSecret = "Test Secret";
127              });
128              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/challenge");
129              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
130              var query = transaction.Response.Headers.Location.Query;
131              Assert.Contains("&scope=" + UrlEncoder.Default.Encode("openid profile email"), query);
132          }
133          [Fact]
134          public async Task ChallengeWillUseAuthenticationPropertiesParametersAsQueryArguments()
135          {
136              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
137              var server = CreateServer(o =>
138              {
139                  o.ClientId = "Test Id";
140                  o.ClientSecret = "Test Secret";
141                  o.StateDataFormat = stateFormat;
142              },
143              context =>
144              {
145                  var req = context.Request;
146                  var res = context.Response;
147                  if (req.Path == new PathString("/challenge2"))
148                  {
149                      return context.ChallengeAsync("Google", new GoogleChallengeProperties
150                      {
151                          Scope = new string[] { "openid", "https:&bsol;&bsol;www.googleapis.com/auth/plus.login" },
152                          AccessType = "offline",
153                          ApprovalPrompt = "force",
154                          Prompt = "consent",
155                          LoginHint = "test@example.com",
156                          IncludeGrantedScopes = false,
157                      });
158                  }
159                  return Task.FromResult<object>(null);
160              });
161              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/challenge2");
162              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
163              var query = QueryHelpers.ParseQuery(transaction.Response.Headers.Location.Query);
164              Assert.Equal("openid https:&bsol;&bsol;www.googleapis.com/auth/plus.login", query["scope"]);
165              Assert.Equal("offline", query["access_type"]);
166              Assert.Equal("force", query["approval_prompt"]);
167              Assert.Equal("consent", query["prompt"]);
168              Assert.Equal("false", query["include_granted_scopes"]);
169              Assert.Equal("test@example.com", query["login_hint"]);
170              var stateProperties = stateFormat.Unprotect(query["state"]);
171              Assert.DoesNotContain("scope", stateProperties.Items.Keys);
172              Assert.DoesNotContain("access_type", stateProperties.Items.Keys);
173              Assert.DoesNotContain("include_granted_scopes", stateProperties.Items.Keys);
174              Assert.DoesNotContain("approval_prompt", stateProperties.Items.Keys);
175              Assert.DoesNotContain("prompt", stateProperties.Items.Keys);
176              Assert.DoesNotContain("login_hint", stateProperties.Items.Keys);
177          }
178          [Fact]
179          public async Task ChallengeWillUseAuthenticationPropertiesItemsAsParameters()
180          {
181              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
182              var server = CreateServer(o =>
183              {
184                  o.ClientId = "Test Id";
185                  o.ClientSecret = "Test Secret";
186                  o.StateDataFormat = stateFormat;
187              },
188              context =>
189              {
190                  var req = context.Request;
191                  var res = context.Response;
192                  if (req.Path == new PathString("/challenge2"))
193                  {
194                      return context.ChallengeAsync("Google", new AuthenticationProperties(new Dictionary<string, string>()
195                      {
196                          { "scope", "https:&bsol;&bsol;www.googleapis.com/auth/plus.login" },
197                          { "access_type", "offline" },
198                          { "approval_prompt", "force" },
199                          { "prompt", "consent" },
200                          { "login_hint", "test@example.com" },
201                          { "include_granted_scopes", "false" }
202                      }));
203                  }
204                  return Task.FromResult<object>(null);
205              });
206              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/challenge2");
207              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
208              var query = QueryHelpers.ParseQuery(transaction.Response.Headers.Location.Query);
209              Assert.Equal("https:&bsol;&bsol;www.googleapis.com/auth/plus.login", query["scope"]);
210              Assert.Equal("offline", query["access_type"]);
211              Assert.Equal("force", query["approval_prompt"]);
212              Assert.Equal("consent", query["prompt"]);
213              Assert.Equal("false", query["include_granted_scopes"]);
214              Assert.Equal("test@example.com", query["login_hint"]);
215              var stateProperties = stateFormat.Unprotect(query["state"]);
216              Assert.DoesNotContain("scope", stateProperties.Items.Keys);
217              Assert.DoesNotContain("access_type", stateProperties.Items.Keys);
218              Assert.DoesNotContain("include_granted_scopes", stateProperties.Items.Keys);
219              Assert.DoesNotContain("approval_prompt", stateProperties.Items.Keys);
220              Assert.DoesNotContain("prompt", stateProperties.Items.Keys);
221              Assert.DoesNotContain("login_hint", stateProperties.Items.Keys);
222          }
223          [Fact]
224          public async Task ChallengeWillUseAuthenticationPropertiesItemsAsQueryArgumentsButParametersWillOverwrite()
225          {
226              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
227              var server = CreateServer(o =>
228              {
229                  o.ClientId = "Test Id";
230                  o.ClientSecret = "Test Secret";
231                  o.StateDataFormat = stateFormat;
232              },
233              context =>
234              {
235                  var req = context.Request;
236                  var res = context.Response;
237                  if (req.Path == new PathString("/challenge2"))
238                  {
239                      return context.ChallengeAsync("Google", new GoogleChallengeProperties(new Dictionary<string, string>
240                      {
241                          ["scope"] = "https:&bsol;&bsol;www.googleapis.com/auth/plus.login",
242                          ["access_type"] = "offline",
243                          ["include_granted_scopes"] = "false",
244                          ["approval_prompt"] = "force",
245                          ["prompt"] = "login",
246                          ["login_hint"] = "this-will-be-overwritten@example.com",
247                      })
248                      {
249                          Prompt = "consent",
250                          LoginHint = "test@example.com",
251                      });
252                  }
253                  return Task.FromResult<object>(null);
254              });
255              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/challenge2");
256              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
257              var query = QueryHelpers.ParseQuery(transaction.Response.Headers.Location.Query);
258              Assert.Equal("https:&bsol;&bsol;www.googleapis.com/auth/plus.login", query["scope"]);
259              Assert.Equal("offline", query["access_type"]);
260              Assert.Equal("force", query["approval_prompt"]);
261              Assert.Equal("consent", query["prompt"]);
262              Assert.Equal("false", query["include_granted_scopes"]);
263              Assert.Equal("test@example.com", query["login_hint"]);
264              var stateProperties = stateFormat.Unprotect(query["state"]);
265              Assert.DoesNotContain("scope", stateProperties.Items.Keys);
266              Assert.DoesNotContain("access_type", stateProperties.Items.Keys);
267              Assert.DoesNotContain("include_granted_scopes", stateProperties.Items.Keys);
268              Assert.DoesNotContain("approval_prompt", stateProperties.Items.Keys);
269              Assert.DoesNotContain("prompt", stateProperties.Items.Keys);
270              Assert.DoesNotContain("login_hint", stateProperties.Items.Keys);
271          }
272          [Fact]
273          public async Task ChallengeWillTriggerApplyRedirectEvent()
274          {
275              var server = CreateServer(o =>
276              {
277                  o.ClientId = "Test Id";
278                  o.ClientSecret = "Test Secret";
279                  o.Events = new OAuthEvents
280                  {
281                      OnRedirectToAuthorizationEndpoint = context =>
282                      {
283                          context.Response.Redirect(context.RedirectUri + "&custom=test");
284                          return Task.FromResult(0);
285                      }
286                  };
287              });
288              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/challenge");
289              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
290              var query = transaction.Response.Headers.Location.Query;
291              Assert.Contains("custom=test", query);
292          }
293          [Fact]
294          public async Task AuthenticateWithoutCookieWillFail()
295          {
296              var server = CreateServer(o =>
297              {
298                  o.ClientId = "Test Id";
299                  o.ClientSecret = "Test Secret";
300              },
301              async context =>
302              {
303                  var req = context.Request;
304                  var res = context.Response;
305                  if (req.Path == new PathString("/auth"))
306                  {
307                      var result = await context.AuthenticateAsync("Google");
308                      Assert.NotNull(result.Failure);
309                  }
310              });
311              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/auth");
312              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
313          }
314          [Fact]
315          public async Task ReplyPathWithoutStateQueryStringWillBeRejected()
316          {
317              var server = CreateServer(o =>
318              {
319                  o.ClientId = "Test Id";
320                  o.ClientSecret = "Test Secret";
321              });
322              var error = await Assert.ThrowsAnyAsync<Exception>(() => server.SendAsync("https:&bsol;&bsol;example.com/signin-google?code=TestCode"));
323              Assert.Equal("The oauth state was missing or invalid.", error.GetBaseException().Message);
324          }
325          [Theory]
326          [InlineData(true)]
327          [InlineData(false)]
328          public async Task ReplyPathWithAccessDeniedErrorFails(bool redirect)
329          {
330              var server = CreateServer(o =>
331              {
332                  o.ClientId = "Test Id";
333                  o.ClientSecret = "Test Secret";
334                  o.StateDataFormat = new TestStateDataFormat();
335                  o.Events = redirect ? new OAuthEvents()
336                  {
337                      OnAccessDenied = ctx =>
338                      {
339                          ctx.Response.Redirect("/error?FailureMessage=AccessDenied");
340                          ctx.HandleResponse();
341                          return Task.FromResult(0);
342                      }
343                  } : new OAuthEvents();
344              });
345              var sendTask = server.SendAsync("https:&bsol;&bsol;example.com/signin-google?error=access_denied&error_description=SoBad&error_uri=foobar&state=protected_state",
346                  ".AspNetCore.Correlation.Google.correlationId=N");
347              if (redirect)
348              {
349                  var transaction = await sendTask;
350                  Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
351                  Assert.Equal("/error?FailureMessage=AccessDenied", transaction.Response.Headers.GetValues("Location").First());
352              }
353              else
354              {
355                  var error = await Assert.ThrowsAnyAsync<Exception>(() => sendTask);
356                  Assert.Equal("Access was denied by the resource owner or by the remote server.", error.GetBaseException().Message);
357              }
358          }
359          [Fact]
360          public async Task ReplyPathWithAccessDeniedError_AllowsCustomizingPath()
361          {
362              var server = CreateServer(o =>
363              {
364                  o.ClientId = "Test Id";
365                  o.ClientSecret = "Test Secret";
366                  o.StateDataFormat = new TestStateDataFormat();
367                  o.AccessDeniedPath = "/access-denied";
368                  o.Events = new OAuthEvents()
369                  {
370                      OnAccessDenied = ctx =>
371                      {
372                          Assert.Equal("/access-denied", ctx.AccessDeniedPath.Value);
373                          Assert.Equal("http:&bsol;&bsol;testhost/redirect", ctx.ReturnUrl);
374                          Assert.Equal("ReturnUrl", ctx.ReturnUrlParameter);
375                          ctx.AccessDeniedPath = "/custom-denied-page";
376                          ctx.ReturnUrl = "http:&bsol;&bsol;www.google.com/";
377                          ctx.ReturnUrlParameter = "rurl";
378                          return Task.FromResult(0);
379                      }
380                  };
381              });
382              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/signin-google?error=access_denied&error_description=SoBad&error_uri=foobar&state=protected_state",
383                  ".AspNetCore.Correlation.Google.correlationId=N");
384              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
385              Assert.Equal("/custom-denied-page?rurl=http%3A%2F%2Fwww.google.com%2F", transaction.Response.Headers.GetValues("Location").First());
386          }
387          [Theory]
388          [InlineData(true)]
389          [InlineData(false)]
390          public async Task ReplyPathWithErrorFails(bool redirect)
391          {
392              var server = CreateServer(o =>
393              {
394                  o.ClientId = "Test Id";
395                  o.ClientSecret = "Test Secret";
396                  o.StateDataFormat = new TestStateDataFormat();
397                  o.Events = redirect ? new OAuthEvents()
398                  {
399                      OnRemoteFailure = ctx =>
400                      {
401                          ctx.Response.Redirect("/error?FailureMessage=" + UrlEncoder.Default.Encode(ctx.Failure.Message));
402                          ctx.HandleResponse();
403                          return Task.FromResult(0);
404                      }
405                  } : new OAuthEvents();
406              });
407              var sendTask = server.SendAsync("https:&bsol;&bsol;example.com/signin-google?error=OMG&error_description=SoBad&error_uri=foobar&state=protected_state",
408                  ".AspNetCore.Correlation.Google.correlationId=N");
409              if (redirect)
410              {
411                  var transaction = await sendTask;
412                  Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
413                  Assert.Equal("/error?FailureMessage=OMG" + UrlEncoder.Default.Encode(";Description=SoBad;Uri=foobar"), transaction.Response.Headers.GetValues("Location").First());
414              }
415              else
416              {
417                  var error = await Assert.ThrowsAnyAsync<Exception>(() => sendTask);
418                  Assert.Equal("OMG;Description=SoBad;Uri=foobar", error.GetBaseException().Message);
419              }
420          }
421          [Theory]
422          [InlineData(null)]
423          [InlineData("CustomIssuer")]
424          public async Task ReplyPathWillAuthenticateValidAuthorizeCodeAndState(string claimsIssuer)
425          {
426              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
427              var server = CreateServer(o =>
428              {
429                  o.ClientId = "Test Id";
430                  o.ClientSecret = "Test Secret";
431                  o.SaveTokens = true;
432                  o.StateDataFormat = stateFormat;
433                  if (claimsIssuer != null)
434                  {
435                      o.ClaimsIssuer = claimsIssuer;
436                  }
437                  o.BackchannelHttpHandler = new TestHttpMessageHandler
438                  {
439                      Sender = req =>
440                      {
441                          if (req.RequestUri.AbsoluteUri == "https:&bsol;&bsol;www.googleapis.com/oauth2/v4/token")
442                          {
443                              return ReturnJsonResponse(new
444                              {
445                                  access_token = "Test Access Token",
446                                  expires_in = 3600,
447                                  token_type = "Bearer"
448                              });
449                          }
450                          else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == "https:&bsol;&bsol;www.googleapis.com/plus/v1/people/me")
451                          {
452                              return ReturnJsonResponse(new
453                              {
454                                  id = "Test User ID",
455                                  displayName = "Test Name",
456                                  name = new
457                                  {
458                                      familyName = "Test Family Name",
459                                      givenName = "Test Given Name"
460                                  },
461                                  url = "Profile link",
462                                  emails = new[]
463                                  {
464                                      new
465                                      {
466                                          value = "Test email",
467                                          type = "account"
468                                      }
469                                  }
470                              });
471                          }
472                          throw new NotImplementedException(req.RequestUri.AbsoluteUri);
473                      }
474                  };
475              });
476              var properties = new AuthenticationProperties();
477              var correlationKey = ".xsrf";
478              var correlationValue = "TestCorrelationId";
479              properties.Items.Add(correlationKey, correlationValue);
480              properties.RedirectUri = "/me";
481              var state = stateFormat.Protect(properties);
482              var transaction = await server.SendAsync(
483                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
484                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
485              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
486              Assert.Equal("/me", transaction.Response.Headers.GetValues("Location").First());
487              Assert.Equal(2, transaction.SetCookie.Count);
488              Assert.Contains($".AspNetCore.Correlation.Google.{correlationValue}", transaction.SetCookie[0]);
489              Assert.Contains(".AspNetCore." + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
490              var authCookie = transaction.AuthenticationCookieValue;
491              transaction = await server.SendAsync("https:&bsol;&bsol;example.com/me", authCookie);
492              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
493              var expectedIssuer = claimsIssuer ?? GoogleDefaults.AuthenticationScheme;
494              Assert.Equal("Test Name", transaction.FindClaimValue(ClaimTypes.Name, expectedIssuer));
<span onclick='openModal()' class='match'>495              Assert.Equal("Test User ID", transaction.FindClaimValue(ClaimTypes.NameIdentifier, expectedIssuer));
496              Assert.Equal("Test Given Name", transaction.FindClaimValue(ClaimTypes.GivenName, expectedIssuer));
497              Assert.Equal("Test Family Name", transaction.FindClaimValue(ClaimTypes.Surname, expectedIssuer));
498              Assert.Equal("Test email", transaction.FindClaimValue(ClaimTypes.Email, expectedIssuer));
499              Assert.Equal("yup", transaction.FindClaimValue("xform"));
500              transaction = await server.SendAsync("https:&bsol;&bsol;example.com/tokens", authCookie);
501              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
502              Assert.Equal("Test Access Token", transaction.FindTokenValue("access_token"));
503              Assert.Equal("Bearer", transaction.FindTokenValue("token_type"));
</span>504              Assert.NotNull(transaction.FindTokenValue("expires_at"));
505          }
506          [Theory]
507          [InlineData(true)]
508          [InlineData(false)]
509          public async Task ReplyPathWillThrowIfCodeIsInvalid(bool redirect)
510          {
511              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
512              var server = CreateServer(o =>
513              {
514                  o.ClientId = "Test Id";
515                  o.ClientSecret = "Test Secret";
516                  o.StateDataFormat = stateFormat;
517                  o.BackchannelHttpHandler = new TestHttpMessageHandler
518                  {
519                      Sender = req =>
520                      {
521                          return ReturnJsonResponse(new { Error = "Error" },
522                              HttpStatusCode.BadRequest);
523                      }
524                  };
525                  o.Events = redirect ? new OAuthEvents()
526                  {
527                      OnRemoteFailure = ctx =>
528                      {
529                          ctx.Response.Redirect("/error?FailureMessage=" + UrlEncoder.Default.Encode(ctx.Failure.Message));
530                          ctx.HandleResponse();
531                          return Task.FromResult(0);
532                      }
533                  } : new OAuthEvents();
534              });
535              var properties = new AuthenticationProperties();
536              var correlationKey = ".xsrf";
537              var correlationValue = "TestCorrelationId";
538              properties.Items.Add(correlationKey, correlationValue);
539              properties.RedirectUri = "/me";
540              var state = stateFormat.Protect(properties);
541              var sendTask = server.SendAsync(
542                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
543                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
544              if (redirect)
545              {
546                  var transaction = await sendTask;
547                  Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
548                  Assert.Equal("/error?FailureMessage=" + UrlEncoder.Default.Encode("OAuth token endpoint failure: Status: BadRequest;Headers: ;Body: {\"Error\":\"Error\"};"),
549                      transaction.Response.Headers.GetValues("Location").First());
550              }
551              else
552              {
553                  var error = await Assert.ThrowsAnyAsync<Exception>(() => sendTask);
554                  Assert.Equal("OAuth token endpoint failure: Status: BadRequest;Headers: ;Body: {\"Error\":\"Error\"};", error.GetBaseException().Message);
555              }
556          }
557          [Theory]
558          [InlineData(true)]
559          [InlineData(false)]
560          public async Task ReplyPathWillRejectIfAccessTokenIsMissing(bool redirect)
561          {
562              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
563              var server = CreateServer(o =>
564              {
565                  o.ClientId = "Test Id";
566                  o.ClientSecret = "Test Secret";
567                  o.StateDataFormat = stateFormat;
568                  o.BackchannelHttpHandler = new TestHttpMessageHandler
569                  {
570                      Sender = req =>
571                      {
572                          return ReturnJsonResponse(new object());
573                      }
574                  };
575                  o.Events = redirect ? new OAuthEvents()
576                  {
577                      OnRemoteFailure = ctx =>
578                      {
579                          ctx.Response.Redirect("/error?FailureMessage=" + UrlEncoder.Default.Encode(ctx.Failure.Message));
580                          ctx.HandleResponse();
581                          return Task.FromResult(0);
582                      }
583                  } : new OAuthEvents();
584              });
585              var properties = new AuthenticationProperties();
586              var correlationKey = ".xsrf";
587              var correlationValue = "TestCorrelationId";
588              properties.Items.Add(correlationKey, correlationValue);
589              properties.RedirectUri = "/me";
590              var state = stateFormat.Protect(properties);
591              var sendTask = server.SendAsync(
592                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
593                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
594              if (redirect)
595              {
596                  var transaction = await sendTask;
597                  Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
598                  Assert.Equal("/error?FailureMessage=" + UrlEncoder.Default.Encode("Failed to retrieve access token."),
599                      transaction.Response.Headers.GetValues("Location").First());
600              }
601              else
602              {
603                  var error = await Assert.ThrowsAnyAsync<Exception>(() => sendTask);
604                  Assert.Equal("Failed to retrieve access token.", error.GetBaseException().Message);
605              }
606          }
607          [Fact]
608          public async Task AuthenticatedEventCanGetRefreshToken()
609          {
610              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
611              var server = CreateServer(o =>
612              {
613                  o.ClientId = "Test Id";
614                  o.ClientSecret = "Test Secret";
615                  o.StateDataFormat = stateFormat;
616                  o.BackchannelHttpHandler = new TestHttpMessageHandler
617                  {
618                      Sender = req =>
619                      {
620                          if (req.RequestUri.AbsoluteUri == "https:&bsol;&bsol;www.googleapis.com/oauth2/v4/token")
621                          {
622                              return ReturnJsonResponse(new
623                              {
624                                  access_token = "Test Access Token",
625                                  expires_in = 3600,
626                                  token_type = "Bearer",
627                                  refresh_token = "Test Refresh Token"
628                              });
629                          }
630                          else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == "https:&bsol;&bsol;www.googleapis.com/plus/v1/people/me")
631                          {
632                              return ReturnJsonResponse(new
633                              {
634                                  id = "Test User ID",
635                                  displayName = "Test Name",
636                                  name = new
637                                  {
638                                      familyName = "Test Family Name",
639                                      givenName = "Test Given Name"
640                                  },
641                                  url = "Profile link",
642                                  emails = new[]
643                                      {
644                                          new
645                                          {
646                                              value = "Test email",
647                                              type = "account"
648                                          }
649                                      }
650                              });
651                          }
652                          throw new NotImplementedException(req.RequestUri.AbsoluteUri);
653                      }
654                  };
655                  o.Events = new OAuthEvents
656                  {
657                      OnCreatingTicket = context =>
658                      {
659                          var refreshToken = context.RefreshToken;
660                          context.Principal.AddIdentity(new ClaimsIdentity(new Claim[] { new Claim("RefreshToken", refreshToken, ClaimValueTypes.String, "Google") }, "Google"));
661                          return Task.FromResult(0);
662                      }
663                  };
664              });
665              var properties = new AuthenticationProperties();
666              var correlationKey = ".xsrf";
667              var correlationValue = "TestCorrelationId";
668              properties.Items.Add(correlationKey, correlationValue);
669              properties.RedirectUri = "/me";
670              var state = stateFormat.Protect(properties);
671              var transaction = await server.SendAsync(
672                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
673                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
674              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
675              Assert.Equal("/me", transaction.Response.Headers.GetValues("Location").First());
676              Assert.Equal(2, transaction.SetCookie.Count);
677              Assert.Contains($".AspNetCore.Correlation.Google.{correlationValue}", transaction.SetCookie[0]);
678              Assert.Contains(".AspNetCore." + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
679              var authCookie = transaction.AuthenticationCookieValue;
680              transaction = await server.SendAsync("https:&bsol;&bsol;example.com/me", authCookie);
681              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
682              Assert.Equal("Test Refresh Token", transaction.FindClaimValue("RefreshToken"));
683          }
684          [Fact]
685          public async Task NullRedirectUriWillRedirectToSlash()
686          {
687              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
688              var server = CreateServer(o =>
689              {
690                  o.ClientId = "Test Id";
691                  o.ClientSecret = "Test Secret";
692                  o.StateDataFormat = stateFormat;
693                  o.BackchannelHttpHandler = new TestHttpMessageHandler
694                  {
695                      Sender = req =>
696                      {
697                          if (req.RequestUri.AbsoluteUri == "https:&bsol;&bsol;www.googleapis.com/oauth2/v4/token")
698                          {
699                              return ReturnJsonResponse(new
700                              {
701                                  access_token = "Test Access Token",
702                                  expires_in = 3600,
703                                  token_type = "Bearer",
704                                  refresh_token = "Test Refresh Token"
705                              });
706                          }
707                          else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == "https:&bsol;&bsol;www.googleapis.com/plus/v1/people/me")
708                          {
709                              return ReturnJsonResponse(new
710                              {
711                                  id = "Test User ID",
712                                  displayName = "Test Name",
713                                  name = new
714                                  {
715                                      familyName = "Test Family Name",
716                                      givenName = "Test Given Name"
717                                  },
718                                  url = "Profile link",
719                                  emails = new[]
720                                      {
721                                          new
722                                          {
723                                              value = "Test email",
724                                              type = "account"
725                                          }
726                                      }
727                              });
728                          }
729                          throw new NotImplementedException(req.RequestUri.AbsoluteUri);
730                      }
731                  };
732                  o.Events = new OAuthEvents
733                  {
734                      OnTicketReceived = context =>
735                      {
736                          context.Properties.RedirectUri = null;
737                          return Task.FromResult(0);
738                      }
739                  };
740              });
741              var properties = new AuthenticationProperties();
742              var correlationKey = ".xsrf";
743              var correlationValue = "TestCorrelationId";
744              properties.Items.Add(correlationKey, correlationValue);
745              var state = stateFormat.Protect(properties);
746              var transaction = await server.SendAsync(
747                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
748                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
749              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
750              Assert.Equal("/", transaction.Response.Headers.GetValues("Location").First());
751              Assert.Equal(2, transaction.SetCookie.Count);
752              Assert.Contains($".AspNetCore.Correlation.Google.{correlationValue}", transaction.SetCookie[0]);
753              Assert.Contains(".AspNetCore." + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
754          }
755          [Fact]
756          public async Task ValidateAuthenticatedContext()
757          {
758              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
759              var server = CreateServer(o =>
760              {
761                  o.ClientId = "Test Id";
762                  o.ClientSecret = "Test Secret";
763                  o.StateDataFormat = stateFormat;
764                  o.AccessType = "offline";
765                  o.Events = new OAuthEvents()
766                  {
767                      OnCreatingTicket = context =>
768                      {
769                          Assert.NotNull(context.User);
770                          Assert.Equal("Test Access Token", context.AccessToken);
771                          Assert.Equal("Test Refresh Token", context.RefreshToken);
772                          Assert.Equal(TimeSpan.FromSeconds(3600), context.ExpiresIn);
773                          Assert.Equal("Test email", context.Identity.FindFirst(ClaimTypes.Email)?.Value);
774                          Assert.Equal("Test User ID", context.Identity.FindFirst(ClaimTypes.NameIdentifier)?.Value);
775                          Assert.Equal("Test Name", context.Identity.FindFirst(ClaimTypes.Name)?.Value);
776                          Assert.Equal("Test Family Name", context.Identity.FindFirst(ClaimTypes.Surname)?.Value);
777                          Assert.Equal("Test Given Name", context.Identity.FindFirst(ClaimTypes.GivenName)?.Value);
778                          return Task.FromResult(0);
779                      }
780                  };
781                  o.BackchannelHttpHandler = new TestHttpMessageHandler
782                  {
783                      Sender = req =>
784                      {
785                          if (req.RequestUri.AbsoluteUri == "https:&bsol;&bsol;www.googleapis.com/oauth2/v4/token")
786                          {
787                              return ReturnJsonResponse(new
788                              {
789                                  access_token = "Test Access Token",
790                                  expires_in = 3600,
791                                  token_type = "Bearer",
792                                  refresh_token = "Test Refresh Token"
793                              });
794                          }
795                          else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == "https:&bsol;&bsol;www.googleapis.com/plus/v1/people/me")
796                          {
797                              return ReturnJsonResponse(new
798                              {
799                                  id = "Test User ID",
800                                  displayName = "Test Name",
801                                  name = new
802                                  {
803                                      familyName = "Test Family Name",
804                                      givenName = "Test Given Name"
805                                  },
806                                  url = "Profile link",
807                                  emails = new[]
808                                      {
809                                          new
810                                          {
811                                              value = "Test email",
812                                              type = "account"
813                                          }
814                                      }
815                              });
816                          }
817                          throw new NotImplementedException(req.RequestUri.AbsoluteUri);
818                      }
819                  };
820              });
821              var properties = new AuthenticationProperties();
822              var correlationKey = ".xsrf";
823              var correlationValue = "TestCorrelationId";
824              properties.Items.Add(correlationKey, correlationValue);
825              properties.RedirectUri = "/foo";
826              var state = stateFormat.Protect(properties);
827              var transaction = await server.SendAsync(
828                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
829                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
830              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
831              Assert.Equal("/foo", transaction.Response.Headers.GetValues("Location").First());
832          }
833          [Fact]
834          public async Task NoStateCausesException()
835          {
836              var server = CreateServer(o =>
837              {
838                  o.ClientId = "Test Id";
839                  o.ClientSecret = "Test Secret";
840              });
841              var error = await Assert.ThrowsAnyAsync<Exception>(() => server.SendAsync("https:&bsol;&bsol;example.com/signin-google?code=TestCode"));
842              Assert.Equal("The oauth state was missing or invalid.", error.GetBaseException().Message);
843          }
844          [Fact]
845          public async Task CanRedirectOnError()
846          {
847              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
848              var server = CreateServer(o =>
849              {
850                  o.ClientId = "Test Id";
851                  o.ClientSecret = "Test Secret";
852                  o.Events = new OAuthEvents()
853                  {
854                      OnRemoteFailure = ctx =>
855                      {
856                          ctx.Response.Redirect("/error?FailureMessage=" + UrlEncoder.Default.Encode(ctx.Failure.Message));
857                          ctx.HandleResponse();
858                          return Task.FromResult(0);
859                      }
860                  };
861              });
862              var transaction = await server.SendAsync(
863                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode");
864              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
865              Assert.Equal("/error?FailureMessage=" + UrlEncoder.Default.Encode("The oauth state was missing or invalid."),
866                  transaction.Response.Headers.GetValues("Location").First());
867          }
868          [Fact]
869          public async Task AuthenticateAutomaticWhenAlreadySignedInSucceeds()
870          {
871              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
872              var server = CreateServer(o =>
873              {
874                  o.ClientId = "Test Id";
875                  o.ClientSecret = "Test Secret";
876                  o.StateDataFormat = stateFormat;
877                  o.SaveTokens = true;
878                  o.BackchannelHttpHandler = CreateBackchannel();
879              });
880              var properties = new AuthenticationProperties();
881              var correlationKey = ".xsrf";
882              var correlationValue = "TestCorrelationId";
883              properties.Items.Add(correlationKey, correlationValue);
884              properties.RedirectUri = "/me";
885              var state = stateFormat.Protect(properties);
886              var transaction = await server.SendAsync(
887                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
888                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
889              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
890              Assert.Equal("/me", transaction.Response.Headers.GetValues("Location").First());
891              Assert.Equal(2, transaction.SetCookie.Count);
892              Assert.Contains($".AspNetCore.Correlation.Google.{correlationValue}", transaction.SetCookie[0]); 
893              Assert.Contains(".AspNetCore." + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
894              var authCookie = transaction.AuthenticationCookieValue;
895              transaction = await server.SendAsync("https:&bsol;&bsol;example.com/authenticate", authCookie);
896              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
897              Assert.Equal("Test Name", transaction.FindClaimValue(ClaimTypes.Name));
898              Assert.Equal("Test User ID", transaction.FindClaimValue(ClaimTypes.NameIdentifier));
899              Assert.Equal("Test Given Name", transaction.FindClaimValue(ClaimTypes.GivenName));
900              Assert.Equal("Test Family Name", transaction.FindClaimValue(ClaimTypes.Surname));
901              Assert.Equal("Test email", transaction.FindClaimValue(ClaimTypes.Email));
902              Assert.Equal("yup", transaction.FindClaimValue("xform"));
903          }
904          [Fact]
905          public async Task AuthenticateGoogleWhenAlreadySignedInSucceeds()
906          {
907              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
908              var server = CreateServer(o =>
909              {
910                  o.ClientId = "Test Id";
911                  o.ClientSecret = "Test Secret";
912                  o.StateDataFormat = stateFormat;
913                  o.SaveTokens = true;
914                  o.BackchannelHttpHandler = CreateBackchannel();
915              });
916              var properties = new AuthenticationProperties();
917              var correlationKey = ".xsrf";
918              var correlationValue = "TestCorrelationId";
919              properties.Items.Add(correlationKey, correlationValue);
920              properties.RedirectUri = "/me";
921              var state = stateFormat.Protect(properties);
922              var transaction = await server.SendAsync(
923                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
924                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
925              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
926              Assert.Equal("/me", transaction.Response.Headers.GetValues("Location").First());
927              Assert.Equal(2, transaction.SetCookie.Count);
928              Assert.Contains($".AspNetCore.Correlation.Google.{correlationValue}", transaction.SetCookie[0]); 
929              Assert.Contains(".AspNetCore." + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
930              var authCookie = transaction.AuthenticationCookieValue;
931              transaction = await server.SendAsync("https:&bsol;&bsol;example.com/authenticateGoogle", authCookie);
932              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
933              Assert.Equal("Test Name", transaction.FindClaimValue(ClaimTypes.Name));
934              Assert.Equal("Test User ID", transaction.FindClaimValue(ClaimTypes.NameIdentifier));
935              Assert.Equal("Test Given Name", transaction.FindClaimValue(ClaimTypes.GivenName));
936              Assert.Equal("Test Family Name", transaction.FindClaimValue(ClaimTypes.Surname));
937              Assert.Equal("Test email", transaction.FindClaimValue(ClaimTypes.Email));
938              Assert.Equal("yup", transaction.FindClaimValue("xform"));
939          }
940          [Fact]
941          public async Task AuthenticateFacebookWhenAlreadySignedWithGoogleReturnsNull()
942          {
943              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
944              var server = CreateServer(o =>
945              {
946                  o.ClientId = "Test Id";
947                  o.ClientSecret = "Test Secret";
948                  o.StateDataFormat = stateFormat;
949                  o.SaveTokens = true;
950                  o.BackchannelHttpHandler = CreateBackchannel();
951              });
952              var properties = new AuthenticationProperties();
953              var correlationKey = ".xsrf";
954              var correlationValue = "TestCorrelationId";
955              properties.Items.Add(correlationKey, correlationValue);
956              properties.RedirectUri = "/me";
957              var state = stateFormat.Protect(properties);
958              var transaction = await server.SendAsync(
959                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
960                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
961              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
962              Assert.Equal("/me", transaction.Response.Headers.GetValues("Location").First());
963              Assert.Equal(2, transaction.SetCookie.Count);
964              Assert.Contains($".AspNetCore.Correlation.Google.{correlationValue}", transaction.SetCookie[0]); 
965              Assert.Contains(".AspNetCore." + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
966              var authCookie = transaction.AuthenticationCookieValue;
967              transaction = await server.SendAsync("https:&bsol;&bsol;example.com/authenticateFacebook", authCookie);
968              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
969              Assert.Null(transaction.FindClaimValue(ClaimTypes.Name));
970          }
971          [Fact]
972          public async Task ChallengeFacebookWhenAlreadySignedWithGoogleSucceeds()
973          {
974              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
975              var server = CreateServer(o =>
976              {
977                  o.ClientId = "Test Id";
978                  o.ClientSecret = "Test Secret";
979                  o.StateDataFormat = stateFormat;
980                  o.SaveTokens = true;
981                  o.BackchannelHttpHandler = CreateBackchannel();
982              });
983              var properties = new AuthenticationProperties();
984              var correlationKey = ".xsrf";
985              var correlationValue = "TestCorrelationId";
986              properties.Items.Add(correlationKey, correlationValue);
987              properties.RedirectUri = "/me";
988              var state = stateFormat.Protect(properties);
989              var transaction = await server.SendAsync(
990                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
991                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
992              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
993              Assert.Equal("/me", transaction.Response.Headers.GetValues("Location").First());
994              Assert.Equal(2, transaction.SetCookie.Count);
995              Assert.Contains($".AspNetCore.Correlation.Google.{correlationValue}", transaction.SetCookie[0]); 
996              Assert.Contains(".AspNetCore." + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
997              var authCookie = transaction.AuthenticationCookieValue;
998              transaction = await server.SendAsync("https:&bsol;&bsol;example.com/challengeFacebook", authCookie);
999              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
1000              Assert.StartsWith("https:&bsol;&bsol;www.facebook.com/", transaction.Response.Headers.Location.OriginalString);
1001          }
1002          private HttpMessageHandler CreateBackchannel()
1003          {
1004              return new TestHttpMessageHandler()
1005              {
1006                  Sender = req =>
1007                  {
1008                      if (req.RequestUri.AbsoluteUri == "https:&bsol;&bsol;www.googleapis.com/oauth2/v4/token")
1009                      {
1010                          return ReturnJsonResponse(new
1011                          {
1012                              access_token = "Test Access Token",
1013                              expires_in = 3600,
1014                              token_type = "Bearer"
1015                          });
1016                      }
1017                      else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == "https:&bsol;&bsol;www.googleapis.com/plus/v1/people/me")
1018                      {
1019                          return ReturnJsonResponse(new
1020                          {
1021                              id = "Test User ID",
1022                              displayName = "Test Name",
1023                              name = new
1024                              {
1025                                  familyName = "Test Family Name",
1026                                  givenName = "Test Given Name"
1027                              },
1028                              url = "Profile link",
1029                              emails = new[]
1030                              {
1031                                  new
1032                                  {
1033                                      value = "Test email",
1034                                      type = "account"
1035                                  }
1036                              }
1037                          });
1038                      }
1039                      throw new NotImplementedException(req.RequestUri.AbsoluteUri);
1040                  }
1041              };
1042          }
1043          private static HttpResponseMessage ReturnJsonResponse(object content, HttpStatusCode code = HttpStatusCode.OK)
1044          {
1045              var res = new HttpResponseMessage(code);
1046              var text = JsonConvert.SerializeObject(content);
1047              res.Content = new StringContent(text, Encoding.UTF8, "application/json");
1048              return res;
1049          }
1050          private class ClaimsTransformer : IClaimsTransformation
1051          {
1052              public Task<ClaimsPrincipal> TransformAsync(ClaimsPrincipal p)
1053              {
1054                  if (!p.Identities.Any(i => i.AuthenticationType == "xform"))
1055                  {
1056                      var id = new ClaimsIdentity("xform");
1057                      id.AddClaim(new Claim("xform", "yup"));
1058                      p.AddIdentity(id);
1059                  }
1060                  return Task.FromResult(p);
1061              }
1062          }
1063          private static TestServer CreateServer(Action<GoogleOptions> configureOptions, Func<HttpContext, Task> testpath = null)
1064          {
1065              var builder = new WebHostBuilder()
1066                  .Configure(app =>
1067                  {
1068                      app.UseAuthentication();
1069                      app.Use(async (context, next) =>
1070                      {
1071                          var req = context.Request;
1072                          var res = context.Response;
1073                          if (req.Path == new PathString("/challenge"))
1074                          {
1075                              await context.ChallengeAsync();
1076                          }
1077                          else if (req.Path == new PathString("/challengeFacebook"))
1078                          {
1079                              await context.ChallengeAsync("Facebook");
1080                          }
1081                          else if (req.Path == new PathString("/tokens"))
1082                          {
1083                              var result = await context.AuthenticateAsync(TestExtensions.CookieAuthenticationScheme);
1084                              var tokens = result.Properties.GetTokens();
1085                              res.Describe(tokens);
1086                          }
1087                          else if (req.Path == new PathString("/me"))
1088                          {
1089                              res.Describe(context.User);
1090                          }
1091                          else if (req.Path == new PathString("/authenticate"))
1092                          {
1093                              var result = await context.AuthenticateAsync(TestExtensions.CookieAuthenticationScheme);
1094                              res.Describe(result.Principal);
1095                          }
1096                          else if (req.Path == new PathString("/authenticateGoogle"))
1097                          {
1098                              var result = await context.AuthenticateAsync("Google");
1099                              res.Describe(result?.Principal);
1100                          }
1101                          else if (req.Path == new PathString("/authenticateFacebook"))
1102                          {
1103                              var result = await context.AuthenticateAsync("Facebook");
1104                              res.Describe(result?.Principal);
1105                          }
1106                          else if (req.Path == new PathString("/unauthorized"))
1107                          {
1108                              var result = await context.AuthenticateAsync("Google");
1109                              await context.ChallengeAsync("Google");
1110                          }
1111                          else if (req.Path == new PathString("/unauthorizedAuto"))
1112                          {
1113                              var result = await context.AuthenticateAsync("Google");
1114                              await context.ChallengeAsync("Google");
1115                          }
1116                          else if (req.Path == new PathString("/401"))
1117                          {
1118                              res.StatusCode = 401;
1119                          }
1120                          else if (req.Path == new PathString("/signIn"))
1121                          {
1122                              await Assert.ThrowsAsync<InvalidOperationException>(() => context.SignInAsync("Google", new ClaimsPrincipal()));
1123                          }
1124                          else if (req.Path == new PathString("/signOut"))
1125                          {
1126                              await Assert.ThrowsAsync<InvalidOperationException>(() => context.SignOutAsync("Google"));
1127                          }
1128                          else if (req.Path == new PathString("/forbid"))
1129                          {
1130                              await Assert.ThrowsAsync<InvalidOperationException>(() => context.ForbidAsync("Google"));
1131                          }
1132                          else if (testpath != null)
1133                          {
1134                              await testpath(context);
1135                          }
1136                          else
1137                          {
1138                              await next();
1139                          }
1140                      });
1141                  })
1142                  .ConfigureServices(services =>
1143                  {
1144                      services.AddTransient<IClaimsTransformation, ClaimsTransformer>();
1145                      services.AddAuthentication(TestExtensions.CookieAuthenticationScheme)
1146                          .AddCookie(TestExtensions.CookieAuthenticationScheme, o => o.ForwardChallenge = GoogleDefaults.AuthenticationScheme)
1147                          .AddGoogle(configureOptions)
1148                          .AddFacebook(o =>
1149                          {
1150                              o.ClientId = "Test ClientId";
1151                              o.ClientSecret = "Test AppSecrent";
1152                          });
1153                  });
1154              return new TestServer(builder);
1155          }
1156          private class TestStateDataFormat : ISecureDataFormat<AuthenticationProperties>
1157          {
1158              private AuthenticationProperties Data { get; set; }
1159              public string Protect(AuthenticationProperties data)
1160              {
1161                  return "protected_state";
1162              }
1163              public string Protect(AuthenticationProperties data, string purpose)
1164              {
1165                  throw new NotImplementedException();
1166              }
1167              public AuthenticationProperties Unprotect(string protectedText)
1168              {
1169                  Assert.Equal("protected_state", protectedText);
1170                  var properties = new AuthenticationProperties(new Dictionary<string, string>()
1171                  {
1172                      { ".xsrf", "correlationId" },
1173                      { "testkey", "testvalue" }
1174                  });
1175                  properties.RedirectUri = "http:&bsol;&bsol;testhost/redirect";
1176                  return properties;
1177              }
1178              public AuthenticationProperties Unprotect(string protectedText, string purpose)
1179              {
1180                  throw new NotImplementedException();
1181              }
1182          }
1183      }
1184  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-NestedDataReaderTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-GoogleTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>210          var nestedReader = reader.GetData(0);
211          nestedReader.Read();
212          await reader.ReadAsync();
213          Assert.Throws<InvalidOperationException>(() => nestedReader.IsDBNull(0));
214          nestedReader = reader.GetData(0);
215          reader.Read();
216          Assert.Throws<InvalidOperationException>(() => nestedReader.Read());
</pre></code></div>
                <div class="column column_space"><pre><code>495              Assert.Equal("Test User ID", transaction.FindClaimValue(ClaimTypes.NameIdentifier, expectedIssuer));
496              Assert.Equal("Test Given Name", transaction.FindClaimValue(ClaimTypes.GivenName, expectedIssuer));
497              Assert.Equal("Test Family Name", transaction.FindClaimValue(ClaimTypes.Surname, expectedIssuer));
498              Assert.Equal("Test email", transaction.FindClaimValue(ClaimTypes.Email, expectedIssuer));
499              Assert.Equal("yup", transaction.FindClaimValue("xform"));
500              transaction = await server.SendAsync("https:&bsol;&bsol;example.com/tokens", authCookie);
501              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
502              Assert.Equal("Test Access Token", transaction.FindTokenValue("access_token"));
503              Assert.Equal("Bearer", transaction.FindTokenValue("token_type"));
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    