
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 18, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-Worker.cs</h3>
            <pre><code>1  using GitHub.DistributedTask.WebApi;
2  using Pipelines = GitHub.DistributedTask.Pipelines;
3  using GitHub.Runner.Common.Util;
4  using Newtonsoft.Json;
5  using System;
6  using System.Collections.Generic;
7  using System.Threading;
8  using System.Threading.Tasks;
9  using GitHub.Services.WebApi;
10  using GitHub.Runner.Common;
11  using GitHub.Runner.Sdk;
12  using System.Text;
13  namespace GitHub.Runner.Worker
14  {
15      [ServiceLocator(Default = typeof(Worker))]
16      public interface IWorker : IRunnerService
17      {
18          Task<int> RunAsync(string pipeIn, string pipeOut);
19      }
20      public sealed class Worker : RunnerService, IWorker
21      {
22          private readonly TimeSpan _workerStartTimeout = TimeSpan.FromSeconds(30);
23          private ManualResetEvent _completedCommand = new(false);
24          private static HashSet<String> SecretVariableMaskWhitelist = new(StringComparer.OrdinalIgnoreCase)
25          {
26              Constants.Variables.Actions.StepDebug,
27              Constants.Variables.Actions.RunnerDebug
28          };
29          public async Task<int> RunAsync(string pipeIn, string pipeOut)
30          {
31              try
32              {
33                  _completedCommand.Reset();
34                  HostContext.Unloading += Worker_Unloading;
35                  ArgUtil.NotNullOrEmpty(pipeIn, nameof(pipeIn));
36                  ArgUtil.NotNullOrEmpty(pipeOut, nameof(pipeOut));
37                  VssUtil.InitializeVssClientSettings(HostContext.UserAgents, HostContext.WebProxy);
38                  var jobRunner = HostContext.CreateService<IJobRunner>();
39                  var terminal = HostContext.GetService<ITerminal>();
40                  using (var channel = HostContext.CreateService<IProcessChannel>())
41                  using (var jobRequestCancellationToken = CancellationTokenSource.CreateLinkedTokenSource(HostContext.RunnerShutdownToken))
42                  using (var channelTokenSource = new CancellationTokenSource())
43                  {
44                      channel.StartClient(pipeIn, pipeOut);
45                      HostContext.WritePerfCounter("WorkerWaitingForJobMessage");
46                      Trace.Info("Waiting to receive the job message from the channel.");
47                      WorkerMessage channelMessage;
48                      using (var csChannelMessage = new CancellationTokenSource(_workerStartTimeout))
49                      {
50                          channelMessage = await channel.ReceiveAsync(csChannelMessage.Token);
51                      }
52                      Trace.Info("Message received.");
53                      ArgUtil.Equal(MessageType.NewJobRequest, channelMessage.MessageType, nameof(channelMessage.MessageType));
54                      ArgUtil.NotNullOrEmpty(channelMessage.Body, nameof(channelMessage.Body));
55                      Pipelines.AgentJobRequestMessage jobMessage = null;
56                      try
57                      {
58                          jobMessage = StringUtil.ConvertFromJson<Pipelines.AgentJobRequestMessage>(channelMessage.Body);
59                      }
60                      catch (JsonReaderException ex)
61                      {
62                          if (channelMessage.Body.Length > ex.LinePosition + 10)
63                          {
64                              var errorChunk = channelMessage.Body.Substring(ex.LinePosition - 10, 20);
65                              terminal.WriteError($"Worker received invalid Json at position '{ex.LinePosition}': {errorChunk} ({Convert.ToBase64String(Encoding.UTF8.GetBytes(errorChunk))})");
66                          }
67                          throw;
68                      }
69                      ArgUtil.NotNull(jobMessage, nameof(jobMessage));
70                      HostContext.WritePerfCounter($"WorkerJobMessageReceived_{jobMessage.RequestId.ToString()}");
71                      InitializeSecretMasker(jobMessage);
72                      SetCulture(jobMessage);
73                      Trace.Info($"Job message:{Environment.NewLine} {StringUtil.ConvertToJson(jobMessage)}");
74                      Task<TaskResult> jobRunnerTask = jobRunner.RunAsync(jobMessage, jobRequestCancellationToken.Token);
75                      Trace.Info("Listening for cancel message from the channel.");
76                      Task<WorkerMessage> channelTask = channel.ReceiveAsync(channelTokenSource.Token);
77                      Trace.Info("Waiting for the job to complete or for a cancel message from the channel.");
78                      Task.WaitAny(jobRunnerTask, channelTask);
79                      if (jobRunnerTask.IsCompleted)
80                      {
81                          Trace.Info("Job completed.");
82                          channelTokenSource.Cancel(); 
83                          return TaskResultUtil.TranslateToReturnCode(await jobRunnerTask);
84                      }
85                      Trace.Info("Cancellation/Shutdown message received.");
86                      channelMessage = await channelTask;
87                      switch (channelMessage.MessageType)
88                      {
<span onclick='openModal()' class='match'>89                          case MessageType.CancelRequest:
90                              jobRequestCancellationToken.Cancel();   
91                              break;
92                          case MessageType.RunnerShutdown:
93                              HostContext.ShutdownRunner(ShutdownReason.UserCancelled);
</span>94                              break;
95                          case MessageType.OperatingSystemShutdown:
96                              HostContext.ShutdownRunner(ShutdownReason.OperatingSystemShutdown);
97                              break;
98                          default:
99                              throw new ArgumentOutOfRangeException(nameof(channelMessage.MessageType), channelMessage.MessageType, nameof(channelMessage.MessageType));
100                      }
101                      return TaskResultUtil.TranslateToReturnCode(await jobRunnerTask);
102                  }
103              }
104              finally
105              {
106                  HostContext.Unloading -= Worker_Unloading;
107                  _completedCommand.Set();
108              }
109          }
110          private void InitializeSecretMasker(Pipelines.AgentJobRequestMessage message)
111          {
112              Trace.Entering();
113              ArgUtil.NotNull(message, nameof(message));
114              ArgUtil.NotNull(message.Resources, nameof(message.Resources));
115              foreach (var variable in (message.Variables ?? new Dictionary<string, VariableValue>()))
116              {
117                  if (variable.Value.IsSecret && !SecretVariableMaskWhitelist.Contains(variable.Key))
118                  {
119                      var value = variable.Value.Value?.Trim() ?? string.Empty;
120                      HostContext.SecretMasker.AddValue(value);
121                      var split = value.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
122                      foreach (var item in split)
123                      {
124                          HostContext.SecretMasker.AddValue(item);
125                      }
126                  }
127              }
128              foreach (MaskHint maskHint in (message.MaskHints ?? new List<MaskHint>()))
129              {
130                  if (maskHint.Type == MaskType.Regex)
131                  {
132                      HostContext.SecretMasker.AddRegex(maskHint.Value);
133                      HostContext.SecretMasker.AddValue(maskHint.Value);
134                  }
135                  else
136                  {
137                      Trace.Warning($"Unsupported mask type '{maskHint.Type}'.");
138                  }
139              }
140              foreach (ServiceEndpoint endpoint in message.Resources.Endpoints ?? new List<ServiceEndpoint>())
141              {
142                  foreach (string value in endpoint.Authorization?.Parameters?.Values ?? new string[0])
143                  {
144                      if (!string.IsNullOrEmpty(value))
145                      {
146                          HostContext.SecretMasker.AddValue(value);
147                      }
148                  }
149              }
150          }
151          private void SetCulture(Pipelines.AgentJobRequestMessage message)
152          {
153              VariableValue culture;
154              ArgUtil.NotNull(message, nameof(message));
155              ArgUtil.NotNull(message.Variables, nameof(message.Variables));
156              if (message.Variables.TryGetValue(Constants.Variables.System.Culture, out culture))
157              {
158                  HostContext.SetDefaultCulture(culture.Value);
159              }
160          }
161          private void Worker_Unloading(object sender, EventArgs e)
162          {
163              if (!HostContext.RunnerShutdownToken.IsCancellationRequested)
164              {
165                  HostContext.ShutdownRunner(ShutdownReason.UserCancelled);
166                  _completedCommand.WaitOne(Constants.Runner.ExitOnUnloadTimeout);
167              }
168          }
169      }
170  }
</code></pre>
        </div>
        <div class="column">
            <h3>EarTrumpet-MDEwOlJlcG9zaXRvcnkzODkxOTcwMg==-flat-FlyoutViewModel.cs</h3>
            <pre><code>1  using EarTrumpet.UI.Helpers;
2  using System;
3  using System.Collections.ObjectModel;
4  using System.Collections.Specialized;
5  using System.Diagnostics;
6  using System.Linq;
7  using System.Windows;
8  using System.Windows.Input;
9  using System.Windows.Threading;
10  namespace EarTrumpet.UI.ViewModels
11  {
12      public class FlyoutViewModel : BindableBase, IPopupHostViewModel, IFlyoutViewModel
13      {
14          public event EventHandler<object> WindowSizeInvalidated;
15          public event EventHandler<object> StateChanged;
16          public ModalDialogViewModel Dialog { get; }
17          public bool IsExpanded { get; private set; }
18          public bool IsExpandingOrCollapsing { get; private set; }
19          public bool CanExpand => _mainViewModel.AllDevices.Count > 1;
20          public string DeviceNameText => Devices.Count > 0 ? Devices[0].DisplayName : null;
21          public FlyoutViewState State { get; private set; }
22          public ObservableCollection<DeviceViewModel> Devices { get; private set; }
23          public ICommand ExpandCollapse { get; private set; }
24          public InputType LastInput { get; private set; }
25          public ICommand DisplaySettingsChanged { get; }
26          private readonly DeviceCollectionViewModel _mainViewModel;
27          private readonly DispatcherTimer _deBounceTimer;
28          private readonly Dispatcher _currentDispatcher = Dispatcher.CurrentDispatcher;
29          private readonly Action _returnFocusToTray;
30          private readonly AppSettings _settings;
31          private bool _closedDuringOpen;
32          public FlyoutViewModel(DeviceCollectionViewModel mainViewModel, Action returnFocusToTray, AppSettings settings)
33          {
34              _settings = settings;
35              IsExpanded = _settings.IsExpanded;
36              Dialog = new ModalDialogViewModel();
37              Devices = new ObservableCollection<DeviceViewModel>();
38              _returnFocusToTray = returnFocusToTray;
39              _mainViewModel = mainViewModel;
40              _mainViewModel.DefaultChanged += OnDefaultPlaybackDeviceChanged;
41              _mainViewModel.AllDevices.CollectionChanged += AllDevices_CollectionChanged;
42              AllDevices_CollectionChanged(null, new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Reset));
43              _deBounceTimer = new DispatcherTimer { Interval = TimeSpan.FromMilliseconds(300) };
44              _deBounceTimer.Tick += OnDeBounceTimerTick;
45              ExpandCollapse = new RelayCommand(() =>
46              {
47                  IsExpandingOrCollapsing = true;
48                  BeginClose(LastInput);
49              });
50              DisplaySettingsChanged = new RelayCommand(() => BeginClose(InputType.Command));
51          }
52          private void OnDeBounceTimerTick(object sender, EventArgs e)
53          {
54              Debug.Assert(State == FlyoutViewState.Closing_Stage2);
55              _deBounceTimer.IsEnabled = false;
56              ChangeState(FlyoutViewState.Hidden);
57          }
58          private void AddDevice(DeviceViewModel device)
59          {
60              if (IsExpanded || Devices.Count == 0)
61              {
62                  device.Apps.CollectionChanged += Apps_CollectionChanged;
63                  Devices.Insert(0, device);
64              }
65          }
66          private void Apps_CollectionChanged(object sender, NotifyCollectionChangedEventArgs e)
67          {
68              switch (e.Action)
69              {
70                  case NotifyCollectionChangedAction.Remove:
71                      if (Dialog.Focused is FocusedAppItemViewModel &&
72                          (IAppItemViewModel)e.OldItems[0] == ((FocusedAppItemViewModel)Dialog.Focused)?.App)
73                      {
74                          Dialog.IsVisible = false;
75                      }
76                      break;
77              }
78              InvalidateWindowSize();
79          }
80          private void RemoveDevice(string id)
81          {
82              var existing = Devices.FirstOrDefault(d => d.Id == id);
83              if (existing != null)
84              {
85                  existing.Apps.CollectionChanged -= Apps_CollectionChanged;
86                  Devices.Remove(existing);
87              }
88          }
89          private void AllDevices_CollectionChanged(object sender, System.Collections.Specialized.NotifyCollectionChangedEventArgs e)
90          {
91              switch (e.Action)
92              {
93                  case NotifyCollectionChangedAction.Add:
94                      AddDevice((DeviceViewModel)e.NewItems[0]);
95                      break;
96                  case NotifyCollectionChangedAction.Remove:
97                      RemoveDevice(((DeviceViewModel)e.OldItems[0]).Id);
98                      break;
99                  case NotifyCollectionChangedAction.Reset:
100                      for (int i = Devices.Count - 1; i >= 0; i--)
101                      {
102                          RemoveDevice(Devices[i].Id);
103                      }
104                      foreach (var device in _mainViewModel.AllDevices)
105                      {
106                          AddDevice(device);
107                      }
108                      OnDefaultPlaybackDeviceChanged(null, _mainViewModel.Default);
109                      break;
110                  default:
111                      throw new NotImplementedException();
112              }
113              UpdateTextVisibility();
114              RaiseDevicesChanged();
115          }
116          private void RaiseDevicesChanged()
117          {
118              RaisePropertyChanged(nameof(IsExpanded));
119              RaisePropertyChanged(nameof(CanExpand));
120              RaisePropertyChanged(nameof(DeviceNameText));
121              InvalidateWindowSize();
122          }
123          private void OnDefaultPlaybackDeviceChanged(object sender, DeviceViewModel e)
124          {
125              if (e == null) return;
126              var foundDevice = Devices.FirstOrDefault(d => d.Id == e.Id);
127              if (foundDevice != null)
128              {
129                  Devices.Move(Devices.IndexOf(foundDevice), Devices.Count - 1);
130              }
131              else
132              {
133                  var foundAllDevice = _mainViewModel.AllDevices.FirstOrDefault(d => d.Id == e.Id);
134                  if (foundAllDevice != null)
135                  {
136                      Devices.Clear();
137                      foundAllDevice.Apps.CollectionChanged += Apps_CollectionChanged;
138                      Devices.Add(foundAllDevice);
139                  }
140              }
141              UpdateTextVisibility();
142              RaiseDevicesChanged();
143          }
144          private void UpdateTextVisibility()
145          {
146              for (var i = 0; i < Devices.Count; i++)
147              {
148                  Devices[i].IsDisplayNameVisible = i > 0;
149              }
150          }
151          public void DoExpandCollapse()
152          {
153              IsExpanded = !IsExpanded;
154              _settings.IsExpanded = IsExpanded;
155              if (IsExpanded)
156              {
157                  foreach (var device in _mainViewModel.AllDevices)
158                  {
159                      if (!Devices.Contains(device))
160                      {
161                          device.Apps.CollectionChanged += Apps_CollectionChanged;
162                          Devices.Insert(0, device);
163                      }
164                  }
165              }
166              else
167              {
168                  for (int i = Devices.Count - 1; i >= 0; i--)
169                  {
170                      var device = Devices[i];
171                      if (device.Id != _mainViewModel.Default?.Id)
172                      {
173                          device.Apps.CollectionChanged -= Apps_CollectionChanged;
174                          Devices.Remove(device);
175                      }
176                  }
177              }
178              UpdateTextVisibility();
179              RaiseDevicesChanged();
180          }
181          private void InvalidateWindowSize()
182          {
183              _currentDispatcher.BeginInvoke((Action)(() =>
184              {
185                  WindowSizeInvalidated?.Invoke(this, null);
186              }));
187          }
188          public void ChangeState(FlyoutViewState state)
189          {
190              Trace.WriteLine($"FlyoutViewModel ChangeState {state}");
191              ValidateStateChange(state);
192              State = state;
193              StateChanged?.Invoke(this, null);
194              switch (State)
195              {
196                  case FlyoutViewState.Open:
197                      _mainViewModel.OnTrayFlyoutShown();
198                      if (_closedDuringOpen)
199                      {
200                          _closedDuringOpen = false;
201                          BeginClose(InputType.Command);
202                      }
203                      break;
204                  case FlyoutViewState.Closing_Stage1:
205                      _mainViewModel.OnTrayFlyoutHidden();
206                      Dialog.IsVisible = false;
207                      if (LastInput == InputType.Keyboard && !IsExpandingOrCollapsing)
208                      {
209                          _returnFocusToTray.Invoke();
210                      }
211                      break;
<span onclick='openModal()' class='match'>212                  case FlyoutViewState.Closing_Stage2:
213                      _deBounceTimer.Start();
214                      break;
215                  case FlyoutViewState.Hidden:
216                      if (IsExpandingOrCollapsing)
</span>217                      {
218                          IsExpandingOrCollapsing = false;
219                          DoExpandCollapse();
220                          BeginOpen(LastInput);
221                      }
222                      break;
223              }
224          }
225          private void ValidateStateChange(FlyoutViewState newState)
226          {
227              var oldState = State;
228              bool isValidStateTransition =
229                  (oldState == FlyoutViewState.NotLoaded && newState == FlyoutViewState.Hidden) ||
230                  (oldState == FlyoutViewState.Hidden && newState == FlyoutViewState.Opening) ||
231                  (oldState == FlyoutViewState.Opening && newState == FlyoutViewState.Open) ||
232                  (oldState == FlyoutViewState.Open && newState == FlyoutViewState.Closing_Stage1) ||
233                  (oldState == FlyoutViewState.Closing_Stage1 && newState == FlyoutViewState.Closing_Stage2) ||
234                  (oldState == FlyoutViewState.Closing_Stage1 && newState == FlyoutViewState.Hidden) ||
235                  (oldState == FlyoutViewState.Closing_Stage2 && newState == FlyoutViewState.Hidden);
236              Debug.Assert(isValidStateTransition);
237          }
238          public void OpenPopup(object vm, FrameworkElement container)
239          {
240              Dialog.IsVisible = false;
241              if (vm is IAppItemViewModel)
242              {
243                  Dialog.Focused = new FocusedAppItemViewModel(_mainViewModel, (IAppItemViewModel)vm);
244              }
245              else if (vm is DeviceViewModel)
246              {
247                  var deviceViewModel = new FocusedDeviceViewModel(_mainViewModel, (DeviceViewModel)vm);
248                  if (deviceViewModel.IsApplicable)
249                  {
250                      Dialog.Focused = deviceViewModel;
251                  }
252              }
253              else
254              {
255                  Dialog.Focused = (IFocusedViewModel)vm;
256              }
257              if (Dialog.Focused != null)
258              {
259                  Dialog.Focused.RequestClose += () => Dialog.IsVisible = false;
260                  Dialog.Source = container;
261                  Dialog.IsVisible = true;
262              }
263          }
264          public void BeginOpen(InputType inputType)
265          {
266              if (State == FlyoutViewState.Hidden)
267              {
268                  LastInput = inputType;
269                  ChangeState(FlyoutViewState.Opening);
270              }
271          }
272          public void BeginClose(InputType inputType)
273          {
274              if (State == FlyoutViewState.Open)
275              {
276                  LastInput = inputType;
277                  ChangeState(FlyoutViewState.Closing_Stage1);
278              }
279              else if (State == FlyoutViewState.Opening)
280              {
281                  _closedDuringOpen = true;
282              }
283          }
284          public void OpenFlyout(InputType inputType)
285          {
286              switch (State)
287              {
288                  case FlyoutViewState.Hidden:
289                      BeginOpen(inputType);
290                      break;
291                  case FlyoutViewState.Open:
292                      BeginClose(inputType);
293                      break;
294              }
295          }
296          public void OnDeactivated(object sender, EventArgs e)
297          {
298              BeginClose(InputType.Command);
299          }
300          public void OnPreviewKeyDown(object sender, KeyEventArgs e)
301          {
302              if (e.Key == Key.Escape)
303              {
304                  if (Dialog.IsVisible)
305                  {
306                      Dialog.IsVisible = false;
307                  }
308                  else
309                  {
310                      BeginClose(InputType.Keyboard);
311                  }
312              }
313              else if (Keyboard.Modifiers == ModifierKeys.Alt && e.SystemKey == Key.Space)
314              {
315                  e.Handled = true;
316              }
317          }
318          public void OnClosing(object sender, System.ComponentModel.CancelEventArgs e)
319          {
320              e.Cancel = true;
321              BeginClose(InputType.Keyboard);
322          }
323          public void OnLightDismissBorderPreviewMouseDown(object sender, MouseButtonEventArgs e)
324          {
325              Dialog.IsVisible = false;
326              e.Handled = true;
327          }
328      }
329  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-Worker.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from EarTrumpet-MDEwOlJlcG9zaXRvcnkzODkxOTcwMg==-flat-FlyoutViewModel.cs</div>
                </div>
                <div class="column column_space"><pre><code>89                          case MessageType.CancelRequest:
90                              jobRequestCancellationToken.Cancel();   
91                              break;
92                          case MessageType.RunnerShutdown:
93                              HostContext.ShutdownRunner(ShutdownReason.UserCancelled);
</pre></code></div>
                <div class="column column_space"><pre><code>212                  case FlyoutViewState.Closing_Stage2:
213                      _deBounceTimer.Start();
214                      break;
215                  case FlyoutViewState.Hidden:
216                      if (IsExpandingOrCollapsing)
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    