
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 16, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-TemplateSchema.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.ComponentModel;
4  using System.Text.RegularExpressions;
5  using System.Threading;
6  using GitHub.DistributedTask.ObjectTemplating.Tokens;
7  namespace GitHub.DistributedTask.ObjectTemplating.Schema
8  {
9      [EditorBrowsable(EditorBrowsableState.Never)]
10      public sealed class TemplateSchema
11      {
12          internal TemplateSchema()
13              : this(null)
14          {
15          }
16          private TemplateSchema(MappingToken mapping)
17          {
18              var nullDefinition = new NullDefinition();
19              Definitions.Add(TemplateConstants.Null, nullDefinition);
20              var booleanDefinition = new BooleanDefinition();
21              Definitions.Add(TemplateConstants.Boolean, booleanDefinition);
22              var numberDefinition = new NumberDefinition();
23              Definitions.Add(TemplateConstants.Number, numberDefinition);
24              var stringDefinition = new StringDefinition();
25              Definitions.Add(TemplateConstants.String, stringDefinition);
26              var sequenceDefinition = new SequenceDefinition { ItemType = TemplateConstants.Any };
27              Definitions.Add(TemplateConstants.Sequence, sequenceDefinition);
28              var mappingDefinition = new MappingDefinition { LooseKeyType = TemplateConstants.String, LooseValueType = TemplateConstants.Any };
29              Definitions.Add(TemplateConstants.Mapping, mappingDefinition);
30              var anyDefinition = new OneOfDefinition();
31              anyDefinition.OneOf.Add(TemplateConstants.Null);
32              anyDefinition.OneOf.Add(TemplateConstants.Boolean);
33              anyDefinition.OneOf.Add(TemplateConstants.Number);
34              anyDefinition.OneOf.Add(TemplateConstants.String);
35              anyDefinition.OneOf.Add(TemplateConstants.Sequence);
36              anyDefinition.OneOf.Add(TemplateConstants.Mapping);
37              Definitions.Add(TemplateConstants.Any, anyDefinition);
38              if (mapping != null)
39              {
40                  foreach (var pair in mapping)
41                  {
42                      var key = pair.Key.AssertString($"{TemplateConstants.TemplateSchema} key");
43                      switch (key.Value)
44                      {
45                          case TemplateConstants.Version:
46                              var version = pair.Value.AssertString(TemplateConstants.Version);
47                              Version = version.Value;
48                              break;
49                          case TemplateConstants.Definitions:
50                              var definitions = pair.Value.AssertMapping(TemplateConstants.Definitions);
51                              foreach (var definitionsPair in definitions)
52                              {
53                                  var definitionsKey = definitionsPair.Key.AssertString($"{TemplateConstants.Definitions} key");
54                                  var definitionsValue = definitionsPair.Value.AssertMapping(TemplateConstants.Definition);
55                                  var definition = default(Definition);
56                                  foreach (var definitionPair in definitionsValue)
57                                  {
58                                      var definitionKey = definitionPair.Key.AssertString($"{TemplateConstants.Definition} key");
59                                      switch (definitionKey.Value)
60                                      {
61                                          case TemplateConstants.Null:
62                                              definition = new NullDefinition(definitionsValue);
63                                              break;
64                                          case TemplateConstants.Boolean:
65                                              definition = new BooleanDefinition(definitionsValue);
66                                              break;
67                                          case TemplateConstants.Number:
68                                              definition = new NumberDefinition(definitionsValue);
69                                              break;
70                                          case TemplateConstants.String:
71                                              definition = new StringDefinition(definitionsValue);
72                                              break;
73                                          case TemplateConstants.Sequence:
74                                              definition = new SequenceDefinition(definitionsValue);
75                                              break;
76                                          case TemplateConstants.Mapping:
77                                              definition = new MappingDefinition(definitionsValue);
78                                              break;
79                                          case TemplateConstants.OneOf:
80                                              definition = new OneOfDefinition(definitionsValue);
81                                              break;
82                                          case TemplateConstants.Context:
83                                          case TemplateConstants.Description:
84                                              continue;
85                                          default:
86                                              definitionKey.AssertUnexpectedValue("definition mapping key"); 
87                                              break;
88                                      }
89                                      break;
90                                  }
91                                  if (definition == null)
92                                  {
93                                      throw new ArgumentException($"Unable to determine definition details. Specify the '{TemplateConstants.Structure}' property");
94                                  }
95                                  Definitions.Add(definitionsKey.Value, definition);
96                              }
97                              break;
98                          default:
99                              key.AssertUnexpectedValue($"{TemplateConstants.TemplateSchema} key"); 
100                              break;
101                      }
102                  }
103              }
104          }
105          internal Dictionary<String, Definition> Definitions { get; } = new Dictionary<String, Definition>(StringComparer.Ordinal);
106          internal String Version { get; }
107          internal static TemplateSchema Load(IObjectReader objectReader)
108          {
109              var context = new TemplateContext
110              {
111                  CancellationToken = CancellationToken.None,
112                  Errors = new TemplateValidationErrors(maxErrors: 10, maxMessageLength: 500),
113                  Memory = new TemplateMemory(
114                      maxDepth: 50,
115                      maxEvents: 1000000, 
116                      maxBytes: 1024 * 1024), 
117                  TraceWriter = new EmptyTraceWriter(),
118              };
119              var value = TemplateReader.Read(context, TemplateConstants.TemplateSchema, objectReader, null, Schema, out _);
120              if (context.Errors.Count > 0)
121              {
122                  throw new TemplateValidationException(context.Errors);
123              }
124              var mapping = value.AssertMapping(TemplateConstants.TemplateSchema);
125              var schema = new TemplateSchema(mapping);
126              schema.Validate();
127              return schema;
128          }
129          internal IEnumerable<T> Get<T>(Definition definition)
130              where T : Definition
131          {
132              if (definition is T match)
133              {
134                  yield return match;
135              }
136              else if (definition is OneOfDefinition oneOf)
137              {
138                  foreach (var reference in oneOf.OneOf)
139                  {
140                      var nestedDefinition = GetDefinition(reference);
141                      if (nestedDefinition is T match2)
142                      {
143                          yield return match2;
144                      }
145                  }
146              }
147          }
148          internal Definition GetDefinition(String type)
149          {
150              if (Definitions.TryGetValue(type, out Definition value))
151              {
152                  return value;
153              }
154              throw new ArgumentException($"Schema definition '{type}' not found");
155          }
156          internal Boolean HasProperties(MappingDefinition definition)
157          {
158              for (int i = 0; i < 10; i++)
159              {
160                  if (definition.Properties.Count > 0)
161                  {
<span onclick='openModal()' class='match'>162                      return true;
163                  }
164                  if (String.IsNullOrEmpty(definition.Inherits))
165                  {
166                      return false;
</span>167                  }
168                  definition = GetDefinition(definition.Inherits) as MappingDefinition;
169              }
170              throw new InvalidOperationException("Inheritance depth exceeded 10");
171          }
172          internal Boolean TryGetProperty(
173              MappingDefinition definition,
174              String name,
175              out String type)
176          {
177              for (int i = 0; i < 10; i++)
178              {
179                  if (definition.Properties.TryGetValue(name, out PropertyValue property))
180                  {
181                      type = property.Type;
182                      return true;
183                  }
184                  if (String.IsNullOrEmpty(definition.Inherits))
185                  {
186                      type = default;
187                      return false;
188                  }
189                  definition = GetDefinition(definition.Inherits) as MappingDefinition;
190              }
191              throw new InvalidOperationException("Inheritance depth exceeded 10");
192          }
193          internal Boolean TryMatchKey(
194              List<MappingDefinition> definitions,
195              String key,
196              out String valueType)
197          {
198              valueType = null;
199              var notFoundInSome = false;
200              for (var i = 0; i < definitions.Count; i++)
201              {
202                  var definition = definitions[i];
203                  if (TryGetProperty(definition, key, out String t))
204                  {
205                      if (valueType == null)
206                      {
207                          valueType = t;
208                      }
209                  }
210                  else
211                  {
212                      notFoundInSome = true;
213                  }
214              }
215              if (valueType != null)
216              {
217                  if (notFoundInSome)
218                  {
219                      for (var i = 0; i < definitions.Count;)
220                      {
221                          if (TryGetProperty(definitions[i], key, out _))
222                          {
223                              i++;
224                          }
225                          else
226                          {
227                              definitions.RemoveAt(i);
228                          }
229                      }
230                  }
231                  return true;
232              }
233              return false;
234          }
235          private static TemplateSchema Schema
236          {
237              get
238              {
239                  if (s_schema == null)
240                  {
241                      var schema = new TemplateSchema();
242                      StringDefinition stringDefinition;
243                      SequenceDefinition sequenceDefinition;
244                      MappingDefinition mappingDefinition;
245                      OneOfDefinition oneOfDefinition;
246                      mappingDefinition = new MappingDefinition();
247                      mappingDefinition.Properties.Add(TemplateConstants.Version, new PropertyValue(new StringToken(null, null, null, TemplateConstants.NonEmptyString)));
248                      mappingDefinition.Properties.Add(TemplateConstants.Definitions, new PropertyValue(new StringToken(null, null, null, TemplateConstants.Definitions)));
249                      schema.Definitions.Add(TemplateConstants.TemplateSchema, mappingDefinition);
250                      mappingDefinition = new MappingDefinition();
251                      mappingDefinition.LooseKeyType = TemplateConstants.NonEmptyString;
252                      mappingDefinition.LooseValueType = TemplateConstants.Definition;
253                      schema.Definitions.Add(TemplateConstants.Definitions, mappingDefinition);
254                      oneOfDefinition = new OneOfDefinition();
255                      oneOfDefinition.OneOf.Add(TemplateConstants.NullDefinition);
256                      oneOfDefinition.OneOf.Add(TemplateConstants.BooleanDefinition);
257                      oneOfDefinition.OneOf.Add(TemplateConstants.NumberDefinition);
258                      oneOfDefinition.OneOf.Add(TemplateConstants.StringDefinition);
259                      oneOfDefinition.OneOf.Add(TemplateConstants.SequenceDefinition);
260                      oneOfDefinition.OneOf.Add(TemplateConstants.MappingDefinition);
261                      oneOfDefinition.OneOf.Add(TemplateConstants.OneOfDefinition);
262                      schema.Definitions.Add(TemplateConstants.Definition, oneOfDefinition);
263                      mappingDefinition = new MappingDefinition();
264                      mappingDefinition.Properties.Add(TemplateConstants.Description, new PropertyValue(new StringToken(null, null, null, TemplateConstants.String)));
265                      mappingDefinition.Properties.Add(TemplateConstants.Context, new PropertyValue(new StringToken(null, null, null, TemplateConstants.SequenceOfNonEmptyString)));
266                      mappingDefinition.Properties.Add(TemplateConstants.Null, new PropertyValue(new StringToken(null, null, null, TemplateConstants.NullDefinitionProperties)));
267                      schema.Definitions.Add(TemplateConstants.NullDefinition, mappingDefinition);
268                      mappingDefinition = new MappingDefinition();
269                      schema.Definitions.Add(TemplateConstants.NullDefinitionProperties, mappingDefinition);
270                      mappingDefinition = new MappingDefinition();
271                      mappingDefinition.Properties.Add(TemplateConstants.Description, new PropertyValue(new StringToken(null, null, null, TemplateConstants.String)));
272                      mappingDefinition.Properties.Add(TemplateConstants.Context, new PropertyValue(new StringToken(null, null, null, TemplateConstants.SequenceOfNonEmptyString)));
273                      mappingDefinition.Properties.Add(TemplateConstants.Boolean, new PropertyValue(new StringToken(null, null, null, TemplateConstants.BooleanDefinitionProperties)));
274                      schema.Definitions.Add(TemplateConstants.BooleanDefinition, mappingDefinition);
275                      mappingDefinition = new MappingDefinition();
276                      schema.Definitions.Add(TemplateConstants.BooleanDefinitionProperties, mappingDefinition);
277                      mappingDefinition = new MappingDefinition();
278                      mappingDefinition.Properties.Add(TemplateConstants.Description, new PropertyValue(new StringToken(null, null, null, TemplateConstants.String)));
279                      mappingDefinition.Properties.Add(TemplateConstants.Context, new PropertyValue(new StringToken(null, null, null, TemplateConstants.SequenceOfNonEmptyString)));
280                      mappingDefinition.Properties.Add(TemplateConstants.Number, new PropertyValue(new StringToken(null, null, null, TemplateConstants.NumberDefinitionProperties)));
281                      schema.Definitions.Add(TemplateConstants.NumberDefinition, mappingDefinition);
282                      mappingDefinition = new MappingDefinition();
283                      schema.Definitions.Add(TemplateConstants.NumberDefinitionProperties, mappingDefinition);
284                      mappingDefinition = new MappingDefinition();
285                      mappingDefinition.Properties.Add(TemplateConstants.Description, new PropertyValue(new StringToken(null, null, null, TemplateConstants.String)));
286                      mappingDefinition.Properties.Add(TemplateConstants.Context, new PropertyValue(new StringToken(null, null, null, TemplateConstants.SequenceOfNonEmptyString)));
287                      mappingDefinition.Properties.Add(TemplateConstants.String, new PropertyValue(new StringToken(null, null, null, TemplateConstants.StringDefinitionProperties)));
288                      schema.Definitions.Add(TemplateConstants.StringDefinition, mappingDefinition);
289                      mappingDefinition = new MappingDefinition();
290                      mappingDefinition.Properties.Add(TemplateConstants.Constant, new PropertyValue(new StringToken(null, null, null, TemplateConstants.NonEmptyString)));
291                      mappingDefinition.Properties.Add(TemplateConstants.IgnoreCase, new PropertyValue(new StringToken(null, null, null, TemplateConstants.Boolean)));
292                      mappingDefinition.Properties.Add(TemplateConstants.RequireNonEmpty, new PropertyValue(new StringToken(null, null, null, TemplateConstants.Boolean)));
293                      schema.Definitions.Add(TemplateConstants.StringDefinitionProperties, mappingDefinition);
294                      mappingDefinition = new MappingDefinition();
295                      mappingDefinition.Properties.Add(TemplateConstants.Description, new PropertyValue(new StringToken(null, null, null, TemplateConstants.String)));
296                      mappingDefinition.Properties.Add(TemplateConstants.Context, new PropertyValue(new StringToken(null, null, null, TemplateConstants.SequenceOfNonEmptyString)));
297                      mappingDefinition.Properties.Add(TemplateConstants.Sequence, new PropertyValue(new StringToken(null, null, null, TemplateConstants.SequenceDefinitionProperties)));
298                      schema.Definitions.Add(TemplateConstants.SequenceDefinition, mappingDefinition);
299                      mappingDefinition = new MappingDefinition();
300                      mappingDefinition.Properties.Add(TemplateConstants.ItemType, new PropertyValue(new StringToken(null, null, null, TemplateConstants.NonEmptyString)));
301                      schema.Definitions.Add(TemplateConstants.SequenceDefinitionProperties, mappingDefinition);
302                      mappingDefinition = new MappingDefinition();
303                      mappingDefinition.Properties.Add(TemplateConstants.Description, new PropertyValue(new StringToken(null, null, null, TemplateConstants.String)));
304                      mappingDefinition.Properties.Add(TemplateConstants.Context, new PropertyValue(new StringToken(null, null, null, TemplateConstants.SequenceOfNonEmptyString)));
305                      mappingDefinition.Properties.Add(TemplateConstants.Mapping, new PropertyValue(new StringToken(null, null, null, TemplateConstants.MappingDefinitionProperties)));
306                      schema.Definitions.Add(TemplateConstants.MappingDefinition, mappingDefinition);
307                      mappingDefinition = new MappingDefinition();
308                      mappingDefinition.Properties.Add(TemplateConstants.Properties, new PropertyValue(new StringToken(null, null, null, TemplateConstants.Properties)));
309                      mappingDefinition.Properties.Add(TemplateConstants.LooseKeyType, new PropertyValue(new StringToken(null, null, null, TemplateConstants.NonEmptyString)));
310                      mappingDefinition.Properties.Add(TemplateConstants.LooseValueType, new PropertyValue(new StringToken(null, null, null, TemplateConstants.NonEmptyString)));
311                      schema.Definitions.Add(TemplateConstants.MappingDefinitionProperties, mappingDefinition);
312                      mappingDefinition = new MappingDefinition();
313                      mappingDefinition.LooseKeyType = TemplateConstants.NonEmptyString;
314                      mappingDefinition.LooseValueType = TemplateConstants.PropertyValue;
315                      schema.Definitions.Add(TemplateConstants.Properties, mappingDefinition);
316                      oneOfDefinition = new OneOfDefinition();
317                      oneOfDefinition.OneOf.Add(TemplateConstants.NonEmptyString);
318                      oneOfDefinition.OneOf.Add(TemplateConstants.MappingPropertyValue);
319                      schema.Definitions.Add(TemplateConstants.PropertyValue, oneOfDefinition);
320                      mappingDefinition = new MappingDefinition();
321                      mappingDefinition.Properties.Add(TemplateConstants.Type, new PropertyValue(new StringToken(null, null, null, TemplateConstants.NonEmptyString)));
322                      mappingDefinition.Properties.Add(TemplateConstants.Required, new PropertyValue(new StringToken(null, null, null, TemplateConstants.Boolean)));
323                      schema.Definitions.Add(TemplateConstants.MappingPropertyValue, mappingDefinition);
324                      mappingDefinition = new MappingDefinition();
325                      mappingDefinition.Properties.Add(TemplateConstants.Description, new PropertyValue(new StringToken(null, null, null, TemplateConstants.String)));
326                      mappingDefinition.Properties.Add(TemplateConstants.Context, new PropertyValue(new StringToken(null, null, null, TemplateConstants.SequenceOfNonEmptyString)));
327                      mappingDefinition.Properties.Add(TemplateConstants.OneOf, new PropertyValue(new StringToken(null, null, null, TemplateConstants.SequenceOfNonEmptyString)));
328                      schema.Definitions.Add(TemplateConstants.OneOfDefinition, mappingDefinition);
329                      stringDefinition = new StringDefinition();
330                      stringDefinition.RequireNonEmpty = true;
331                      schema.Definitions.Add(TemplateConstants.NonEmptyString, stringDefinition);
332                      sequenceDefinition = new SequenceDefinition();
333                      sequenceDefinition.ItemType = TemplateConstants.NonEmptyString;
334                      schema.Definitions.Add(TemplateConstants.SequenceOfNonEmptyString, sequenceDefinition);
335                      schema.Validate();
336                      Interlocked.CompareExchange(ref s_schema, schema, null);
337                  }
338                  return s_schema;
339              }
340          }
341          private void Validate()
342          {
343              var oneOfPairs = new List<KeyValuePair<String, OneOfDefinition>>();
344              foreach (var pair in Definitions)
345              {
346                  var name = pair.Key;
347                  if (!s_definitionNameRegex.IsMatch(name ?? String.Empty))
348                  {
349                      throw new ArgumentException($"Invalid definition name '{name}'");
350                  }
351                  var definition = pair.Value;
352                  if (definition is OneOfDefinition oneOf)
353                  {
354                      oneOfPairs.Add(new KeyValuePair<String, OneOfDefinition>(name, oneOf));
355                  }
356                  else
357                  {
358                      definition.Validate(this, name);
359                  }
360              }
361              foreach (var pair in oneOfPairs)
362              {
363                  var name = pair.Key;
364                  var oneOf = pair.Value;
365                  oneOf.Validate(this, name);
366              }
367          }
368          private static readonly Regex s_definitionNameRegex = new Regex("^[a-zA-Z_][a-zA-Z0-9_-]*$", RegexOptions.Compiled);
369          private static TemplateSchema s_schema;
370      }
371  }
</code></pre>
        </div>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-TemplateSchema.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.ComponentModel;
4  using System.Text.RegularExpressions;
5  using System.Threading;
6  using GitHub.DistributedTask.ObjectTemplating.Tokens;
7  namespace GitHub.DistributedTask.ObjectTemplating.Schema
8  {
9      [EditorBrowsable(EditorBrowsableState.Never)]
10      public sealed class TemplateSchema
11      {
12          internal TemplateSchema()
13              : this(null)
14          {
15          }
16          private TemplateSchema(MappingToken mapping)
17          {
18              var nullDefinition = new NullDefinition();
19              Definitions.Add(TemplateConstants.Null, nullDefinition);
20              var booleanDefinition = new BooleanDefinition();
21              Definitions.Add(TemplateConstants.Boolean, booleanDefinition);
22              var numberDefinition = new NumberDefinition();
23              Definitions.Add(TemplateConstants.Number, numberDefinition);
24              var stringDefinition = new StringDefinition();
25              Definitions.Add(TemplateConstants.String, stringDefinition);
26              var sequenceDefinition = new SequenceDefinition { ItemType = TemplateConstants.Any };
27              Definitions.Add(TemplateConstants.Sequence, sequenceDefinition);
28              var mappingDefinition = new MappingDefinition { LooseKeyType = TemplateConstants.String, LooseValueType = TemplateConstants.Any };
29              Definitions.Add(TemplateConstants.Mapping, mappingDefinition);
30              var anyDefinition = new OneOfDefinition();
31              anyDefinition.OneOf.Add(TemplateConstants.Null);
32              anyDefinition.OneOf.Add(TemplateConstants.Boolean);
33              anyDefinition.OneOf.Add(TemplateConstants.Number);
34              anyDefinition.OneOf.Add(TemplateConstants.String);
35              anyDefinition.OneOf.Add(TemplateConstants.Sequence);
36              anyDefinition.OneOf.Add(TemplateConstants.Mapping);
37              Definitions.Add(TemplateConstants.Any, anyDefinition);
38              if (mapping != null)
39              {
40                  foreach (var pair in mapping)
41                  {
42                      var key = pair.Key.AssertString($"{TemplateConstants.TemplateSchema} key");
43                      switch (key.Value)
44                      {
45                          case TemplateConstants.Version:
46                              var version = pair.Value.AssertString(TemplateConstants.Version);
47                              Version = version.Value;
48                              break;
49                          case TemplateConstants.Definitions:
50                              var definitions = pair.Value.AssertMapping(TemplateConstants.Definitions);
51                              foreach (var definitionsPair in definitions)
52                              {
53                                  var definitionsKey = definitionsPair.Key.AssertString($"{TemplateConstants.Definitions} key");
54                                  var definitionsValue = definitionsPair.Value.AssertMapping(TemplateConstants.Definition);
55                                  var definition = default(Definition);
56                                  foreach (var definitionPair in definitionsValue)
57                                  {
58                                      var definitionKey = definitionPair.Key.AssertString($"{TemplateConstants.Definition} key");
59                                      switch (definitionKey.Value)
60                                      {
61                                          case TemplateConstants.Null:
62                                              definition = new NullDefinition(definitionsValue);
63                                              break;
64                                          case TemplateConstants.Boolean:
65                                              definition = new BooleanDefinition(definitionsValue);
66                                              break;
67                                          case TemplateConstants.Number:
68                                              definition = new NumberDefinition(definitionsValue);
69                                              break;
70                                          case TemplateConstants.String:
71                                              definition = new StringDefinition(definitionsValue);
72                                              break;
73                                          case TemplateConstants.Sequence:
74                                              definition = new SequenceDefinition(definitionsValue);
75                                              break;
76                                          case TemplateConstants.Mapping:
77                                              definition = new MappingDefinition(definitionsValue);
78                                              break;
79                                          case TemplateConstants.OneOf:
80                                              definition = new OneOfDefinition(definitionsValue);
81                                              break;
82                                          case TemplateConstants.Context:
83                                          case TemplateConstants.Description:
84                                              continue;
85                                          default:
86                                              definitionKey.AssertUnexpectedValue("definition mapping key"); 
87                                              break;
88                                      }
89                                      break;
90                                  }
91                                  if (definition == null)
92                                  {
93                                      throw new ArgumentException($"Unable to determine definition details. Specify the '{TemplateConstants.Structure}' property");
94                                  }
95                                  Definitions.Add(definitionsKey.Value, definition);
96                              }
97                              break;
98                          default:
99                              key.AssertUnexpectedValue($"{TemplateConstants.TemplateSchema} key"); 
100                              break;
101                      }
102                  }
103              }
104          }
105          internal Dictionary<String, Definition> Definitions { get; } = new Dictionary<String, Definition>(StringComparer.Ordinal);
106          internal String Version { get; }
107          internal static TemplateSchema Load(IObjectReader objectReader)
108          {
109              var context = new TemplateContext
110              {
111                  CancellationToken = CancellationToken.None,
112                  Errors = new TemplateValidationErrors(maxErrors: 10, maxMessageLength: 500),
113                  Memory = new TemplateMemory(
114                      maxDepth: 50,
115                      maxEvents: 1000000, 
116                      maxBytes: 1024 * 1024), 
117                  TraceWriter = new EmptyTraceWriter(),
118              };
119              var value = TemplateReader.Read(context, TemplateConstants.TemplateSchema, objectReader, null, Schema, out _);
120              if (context.Errors.Count > 0)
121              {
122                  throw new TemplateValidationException(context.Errors);
123              }
124              var mapping = value.AssertMapping(TemplateConstants.TemplateSchema);
125              var schema = new TemplateSchema(mapping);
126              schema.Validate();
127              return schema;
128          }
129          internal IEnumerable<T> Get<T>(Definition definition)
130              where T : Definition
131          {
132              if (definition is T match)
133              {
134                  yield return match;
135              }
136              else if (definition is OneOfDefinition oneOf)
137              {
138                  foreach (var reference in oneOf.OneOf)
139                  {
140                      var nestedDefinition = GetDefinition(reference);
141                      if (nestedDefinition is T match2)
142                      {
143                          yield return match2;
144                      }
145                  }
146              }
147          }
148          internal Definition GetDefinition(String type)
149          {
150              if (Definitions.TryGetValue(type, out Definition value))
151              {
152                  return value;
153              }
154              throw new ArgumentException($"Schema definition '{type}' not found");
155          }
156          internal Boolean HasProperties(MappingDefinition definition)
157          {
158              for (int i = 0; i < 10; i++)
159              {
160                  if (definition.Properties.Count > 0)
161                  {
<span onclick='openModal()' class='match'>162                      return true;
163                  }
164                  if (String.IsNullOrEmpty(definition.Inherits))
165                  {
166                      return false;
</span>167                  }
168                  definition = GetDefinition(definition.Inherits) as MappingDefinition;
169              }
170              throw new InvalidOperationException("Inheritance depth exceeded 10");
171          }
172          internal Boolean TryGetProperty(
173              MappingDefinition definition,
174              String name,
175              out String type)
176          {
177              for (int i = 0; i < 10; i++)
178              {
179                  if (definition.Properties.TryGetValue(name, out PropertyValue property))
180                  {
181                      type = property.Type;
182                      return true;
183                  }
184                  if (String.IsNullOrEmpty(definition.Inherits))
185                  {
186                      type = default;
187                      return false;
188                  }
189                  definition = GetDefinition(definition.Inherits) as MappingDefinition;
190              }
191              throw new InvalidOperationException("Inheritance depth exceeded 10");
192          }
193          internal Boolean TryMatchKey(
194              List<MappingDefinition> definitions,
195              String key,
196              out String valueType)
197          {
198              valueType = null;
199              var notFoundInSome = false;
200              for (var i = 0; i < definitions.Count; i++)
201              {
202                  var definition = definitions[i];
203                  if (TryGetProperty(definition, key, out String t))
204                  {
205                      if (valueType == null)
206                      {
207                          valueType = t;
208                      }
209                  }
210                  else
211                  {
212                      notFoundInSome = true;
213                  }
214              }
215              if (valueType != null)
216              {
217                  if (notFoundInSome)
218                  {
219                      for (var i = 0; i < definitions.Count;)
220                      {
221                          if (TryGetProperty(definitions[i], key, out _))
222                          {
223                              i++;
224                          }
225                          else
226                          {
227                              definitions.RemoveAt(i);
228                          }
229                      }
230                  }
231                  return true;
232              }
233              return false;
234          }
235          private static TemplateSchema Schema
236          {
237              get
238              {
239                  if (s_schema == null)
240                  {
241                      var schema = new TemplateSchema();
242                      StringDefinition stringDefinition;
243                      SequenceDefinition sequenceDefinition;
244                      MappingDefinition mappingDefinition;
245                      OneOfDefinition oneOfDefinition;
246                      mappingDefinition = new MappingDefinition();
247                      mappingDefinition.Properties.Add(TemplateConstants.Version, new PropertyValue(new StringToken(null, null, null, TemplateConstants.NonEmptyString)));
248                      mappingDefinition.Properties.Add(TemplateConstants.Definitions, new PropertyValue(new StringToken(null, null, null, TemplateConstants.Definitions)));
249                      schema.Definitions.Add(TemplateConstants.TemplateSchema, mappingDefinition);
250                      mappingDefinition = new MappingDefinition();
251                      mappingDefinition.LooseKeyType = TemplateConstants.NonEmptyString;
252                      mappingDefinition.LooseValueType = TemplateConstants.Definition;
253                      schema.Definitions.Add(TemplateConstants.Definitions, mappingDefinition);
254                      oneOfDefinition = new OneOfDefinition();
255                      oneOfDefinition.OneOf.Add(TemplateConstants.NullDefinition);
256                      oneOfDefinition.OneOf.Add(TemplateConstants.BooleanDefinition);
257                      oneOfDefinition.OneOf.Add(TemplateConstants.NumberDefinition);
258                      oneOfDefinition.OneOf.Add(TemplateConstants.StringDefinition);
259                      oneOfDefinition.OneOf.Add(TemplateConstants.SequenceDefinition);
260                      oneOfDefinition.OneOf.Add(TemplateConstants.MappingDefinition);
261                      oneOfDefinition.OneOf.Add(TemplateConstants.OneOfDefinition);
262                      schema.Definitions.Add(TemplateConstants.Definition, oneOfDefinition);
263                      mappingDefinition = new MappingDefinition();
264                      mappingDefinition.Properties.Add(TemplateConstants.Description, new PropertyValue(new StringToken(null, null, null, TemplateConstants.String)));
265                      mappingDefinition.Properties.Add(TemplateConstants.Context, new PropertyValue(new StringToken(null, null, null, TemplateConstants.SequenceOfNonEmptyString)));
266                      mappingDefinition.Properties.Add(TemplateConstants.Null, new PropertyValue(new StringToken(null, null, null, TemplateConstants.NullDefinitionProperties)));
267                      schema.Definitions.Add(TemplateConstants.NullDefinition, mappingDefinition);
268                      mappingDefinition = new MappingDefinition();
269                      schema.Definitions.Add(TemplateConstants.NullDefinitionProperties, mappingDefinition);
270                      mappingDefinition = new MappingDefinition();
271                      mappingDefinition.Properties.Add(TemplateConstants.Description, new PropertyValue(new StringToken(null, null, null, TemplateConstants.String)));
272                      mappingDefinition.Properties.Add(TemplateConstants.Context, new PropertyValue(new StringToken(null, null, null, TemplateConstants.SequenceOfNonEmptyString)));
273                      mappingDefinition.Properties.Add(TemplateConstants.Boolean, new PropertyValue(new StringToken(null, null, null, TemplateConstants.BooleanDefinitionProperties)));
274                      schema.Definitions.Add(TemplateConstants.BooleanDefinition, mappingDefinition);
275                      mappingDefinition = new MappingDefinition();
276                      schema.Definitions.Add(TemplateConstants.BooleanDefinitionProperties, mappingDefinition);
277                      mappingDefinition = new MappingDefinition();
278                      mappingDefinition.Properties.Add(TemplateConstants.Description, new PropertyValue(new StringToken(null, null, null, TemplateConstants.String)));
279                      mappingDefinition.Properties.Add(TemplateConstants.Context, new PropertyValue(new StringToken(null, null, null, TemplateConstants.SequenceOfNonEmptyString)));
280                      mappingDefinition.Properties.Add(TemplateConstants.Number, new PropertyValue(new StringToken(null, null, null, TemplateConstants.NumberDefinitionProperties)));
281                      schema.Definitions.Add(TemplateConstants.NumberDefinition, mappingDefinition);
282                      mappingDefinition = new MappingDefinition();
283                      schema.Definitions.Add(TemplateConstants.NumberDefinitionProperties, mappingDefinition);
284                      mappingDefinition = new MappingDefinition();
285                      mappingDefinition.Properties.Add(TemplateConstants.Description, new PropertyValue(new StringToken(null, null, null, TemplateConstants.String)));
286                      mappingDefinition.Properties.Add(TemplateConstants.Context, new PropertyValue(new StringToken(null, null, null, TemplateConstants.SequenceOfNonEmptyString)));
287                      mappingDefinition.Properties.Add(TemplateConstants.String, new PropertyValue(new StringToken(null, null, null, TemplateConstants.StringDefinitionProperties)));
288                      schema.Definitions.Add(TemplateConstants.StringDefinition, mappingDefinition);
289                      mappingDefinition = new MappingDefinition();
290                      mappingDefinition.Properties.Add(TemplateConstants.Constant, new PropertyValue(new StringToken(null, null, null, TemplateConstants.NonEmptyString)));
291                      mappingDefinition.Properties.Add(TemplateConstants.IgnoreCase, new PropertyValue(new StringToken(null, null, null, TemplateConstants.Boolean)));
292                      mappingDefinition.Properties.Add(TemplateConstants.RequireNonEmpty, new PropertyValue(new StringToken(null, null, null, TemplateConstants.Boolean)));
293                      schema.Definitions.Add(TemplateConstants.StringDefinitionProperties, mappingDefinition);
294                      mappingDefinition = new MappingDefinition();
295                      mappingDefinition.Properties.Add(TemplateConstants.Description, new PropertyValue(new StringToken(null, null, null, TemplateConstants.String)));
296                      mappingDefinition.Properties.Add(TemplateConstants.Context, new PropertyValue(new StringToken(null, null, null, TemplateConstants.SequenceOfNonEmptyString)));
297                      mappingDefinition.Properties.Add(TemplateConstants.Sequence, new PropertyValue(new StringToken(null, null, null, TemplateConstants.SequenceDefinitionProperties)));
298                      schema.Definitions.Add(TemplateConstants.SequenceDefinition, mappingDefinition);
299                      mappingDefinition = new MappingDefinition();
300                      mappingDefinition.Properties.Add(TemplateConstants.ItemType, new PropertyValue(new StringToken(null, null, null, TemplateConstants.NonEmptyString)));
301                      schema.Definitions.Add(TemplateConstants.SequenceDefinitionProperties, mappingDefinition);
302                      mappingDefinition = new MappingDefinition();
303                      mappingDefinition.Properties.Add(TemplateConstants.Description, new PropertyValue(new StringToken(null, null, null, TemplateConstants.String)));
304                      mappingDefinition.Properties.Add(TemplateConstants.Context, new PropertyValue(new StringToken(null, null, null, TemplateConstants.SequenceOfNonEmptyString)));
305                      mappingDefinition.Properties.Add(TemplateConstants.Mapping, new PropertyValue(new StringToken(null, null, null, TemplateConstants.MappingDefinitionProperties)));
306                      schema.Definitions.Add(TemplateConstants.MappingDefinition, mappingDefinition);
307                      mappingDefinition = new MappingDefinition();
308                      mappingDefinition.Properties.Add(TemplateConstants.Properties, new PropertyValue(new StringToken(null, null, null, TemplateConstants.Properties)));
309                      mappingDefinition.Properties.Add(TemplateConstants.LooseKeyType, new PropertyValue(new StringToken(null, null, null, TemplateConstants.NonEmptyString)));
310                      mappingDefinition.Properties.Add(TemplateConstants.LooseValueType, new PropertyValue(new StringToken(null, null, null, TemplateConstants.NonEmptyString)));
311                      schema.Definitions.Add(TemplateConstants.MappingDefinitionProperties, mappingDefinition);
312                      mappingDefinition = new MappingDefinition();
313                      mappingDefinition.LooseKeyType = TemplateConstants.NonEmptyString;
314                      mappingDefinition.LooseValueType = TemplateConstants.PropertyValue;
315                      schema.Definitions.Add(TemplateConstants.Properties, mappingDefinition);
316                      oneOfDefinition = new OneOfDefinition();
317                      oneOfDefinition.OneOf.Add(TemplateConstants.NonEmptyString);
318                      oneOfDefinition.OneOf.Add(TemplateConstants.MappingPropertyValue);
319                      schema.Definitions.Add(TemplateConstants.PropertyValue, oneOfDefinition);
320                      mappingDefinition = new MappingDefinition();
321                      mappingDefinition.Properties.Add(TemplateConstants.Type, new PropertyValue(new StringToken(null, null, null, TemplateConstants.NonEmptyString)));
322                      mappingDefinition.Properties.Add(TemplateConstants.Required, new PropertyValue(new StringToken(null, null, null, TemplateConstants.Boolean)));
323                      schema.Definitions.Add(TemplateConstants.MappingPropertyValue, mappingDefinition);
324                      mappingDefinition = new MappingDefinition();
325                      mappingDefinition.Properties.Add(TemplateConstants.Description, new PropertyValue(new StringToken(null, null, null, TemplateConstants.String)));
326                      mappingDefinition.Properties.Add(TemplateConstants.Context, new PropertyValue(new StringToken(null, null, null, TemplateConstants.SequenceOfNonEmptyString)));
327                      mappingDefinition.Properties.Add(TemplateConstants.OneOf, new PropertyValue(new StringToken(null, null, null, TemplateConstants.SequenceOfNonEmptyString)));
328                      schema.Definitions.Add(TemplateConstants.OneOfDefinition, mappingDefinition);
329                      stringDefinition = new StringDefinition();
330                      stringDefinition.RequireNonEmpty = true;
331                      schema.Definitions.Add(TemplateConstants.NonEmptyString, stringDefinition);
332                      sequenceDefinition = new SequenceDefinition();
333                      sequenceDefinition.ItemType = TemplateConstants.NonEmptyString;
334                      schema.Definitions.Add(TemplateConstants.SequenceOfNonEmptyString, sequenceDefinition);
335                      schema.Validate();
336                      Interlocked.CompareExchange(ref s_schema, schema, null);
337                  }
338                  return s_schema;
339              }
340          }
341          private void Validate()
342          {
343              var oneOfPairs = new List<KeyValuePair<String, OneOfDefinition>>();
344              foreach (var pair in Definitions)
345              {
346                  var name = pair.Key;
347                  if (!s_definitionNameRegex.IsMatch(name ?? String.Empty))
348                  {
349                      throw new ArgumentException($"Invalid definition name '{name}'");
350                  }
351                  var definition = pair.Value;
352                  if (definition is OneOfDefinition oneOf)
353                  {
354                      oneOfPairs.Add(new KeyValuePair<String, OneOfDefinition>(name, oneOf));
355                  }
356                  else
357                  {
358                      definition.Validate(this, name);
359                  }
360              }
361              foreach (var pair in oneOfPairs)
362              {
363                  var name = pair.Key;
364                  var oneOf = pair.Value;
365                  oneOf.Validate(this, name);
366              }
367          }
368          private static readonly Regex s_definitionNameRegex = new Regex("^[a-zA-Z_][a-zA-Z0-9_-]*$", RegexOptions.Compiled);
369          private static TemplateSchema s_schema;
370      }
371  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-TemplateSchema.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-TemplateSchema.cs</div>
                </div>
                <div class="column column_space"><pre><code>162                      return true;
163                  }
164                  if (String.IsNullOrEmpty(definition.Inherits))
165                  {
166                      return false;
</pre></code></div>
                <div class="column column_space"><pre><code>162                      return true;
163                  }
164                  if (String.IsNullOrEmpty(definition.Inherits))
165                  {
166                      return false;
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    