
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 19, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-MiscTypeTests.cs</h3>
            <pre><code>1  using System;
2  using System.Data;
3  using System.Threading.Tasks;
4  using Npgsql.Properties;
5  using NpgsqlTypes;
6  using NUnit.Framework;
7  using NUnit.Framework.Constraints;
8  namespace Npgsql.Tests.Types;
9  class MiscTypeTests : MultiplexingTestBase
10  {
11      [Test]
12      public async Task Boolean()
13      {
14          await AssertType(true, "true", "boolean", NpgsqlDbType.Boolean, DbType.Boolean);
15          await AssertType(false, "false", "boolean", NpgsqlDbType.Boolean, DbType.Boolean);
16      }
17      [Test]
18      public Task Uuid()
19          => AssertType(
20              new Guid("a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"),
21              "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11",
22              "uuid", NpgsqlDbType.Uuid, DbType.Guid);
23      [Test, Description("Makes sure that the PostgreSQL 'unknown' type (OID 705) is read properly")]
24      public async Task Read_unknown()
25      {
26          const string expected = "some_text";
27          await using var conn = await OpenConnectionAsync();
28          await using var cmd = new NpgsqlCommand($"SELECT '{expected}'", conn);
29          await using var reader = await cmd.ExecuteReaderAsync();
30          reader.Read();
31          Assert.That(reader.GetString(0), Is.EqualTo(expected));
32          Assert.That(reader.GetValue(0), Is.EqualTo(expected));
33          Assert.That(reader.GetFieldValue<char[]>(0), Is.EqualTo(expected.ToCharArray()));
34          Assert.That(reader.GetFieldType(0), Is.EqualTo(typeof(string)));
35      }
36      [Test]
37      public async Task Null()
38      {
39          await using var conn = await OpenConnectionAsync();
40          await using (var cmd = new NpgsqlCommand("SELECT @p1::TEXT, @p2::TEXT, @p3::TEXT", conn))
41          {
42              cmd.Parameters.AddWithValue("p1", DBNull.Value);
43              cmd.Parameters.Add(new NpgsqlParameter<string?>("p2", null));
44              cmd.Parameters.Add(new NpgsqlParameter<DBNull>("p3", DBNull.Value));
45              await using var reader = await cmd.ExecuteReaderAsync();
46              reader.Read();
47              for (var i = 0; i < cmd.Parameters.Count; i++)
48              {
49                  Assert.That(reader.IsDBNull(i));
50                  Assert.That(reader.GetFieldType(i), Is.EqualTo(typeof(string)));
51              }
52          }
53          await using (var cmd = new NpgsqlCommand("SELECT @p::TEXT", conn))
54          {
55              cmd.Parameters.AddWithValue("p4", NpgsqlDbType.Text, null!);
56              Assert.That(async () => await cmd.ExecuteReaderAsync(), Throws.Exception.TypeOf<InvalidCastException>());
57          }
58      }
59      #region Record
60      [Test]
61      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/724")]
62      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1980")]
63      public async Task Read_Record_as_object_array()
64      {
65          var recordLiteral = "(1,'foo'::text)::record";
66          await using var conn = await OpenConnectionAsync();
67          await using var cmd = new NpgsqlCommand($"SELECT {recordLiteral}, ARRAY[{recordLiteral}, {recordLiteral}]", conn);
68          await using var reader = await cmd.ExecuteReaderAsync();
69          reader.Read();
70          var record = (object[])reader[0];
71          Assert.That(record[0], Is.EqualTo(1));
72          Assert.That(record[1], Is.EqualTo("foo"));
73          var array = (object[][])reader[1];
74          Assert.That(array.Length, Is.EqualTo(2));
75          Assert.That(array[0][0], Is.EqualTo(1));
76          Assert.That(array[1][0], Is.EqualTo(1));
77      }
78      [Test]
79      public async Task Read_Record_as_ValueTuple()
80      {
81          var recordLiteral = "(1,'foo'::text)::record";
82          await using var conn = await OpenConnectionAsync();
83          await using var cmd = new NpgsqlCommand($"SELECT {recordLiteral}, ARRAY[{recordLiteral}, {recordLiteral}]", conn);
84          await using var reader = await cmd.ExecuteReaderAsync();
85          reader.Read();
86          var record = reader.GetFieldValue<(int, string)>(0);
87          Assert.That(record.Item1, Is.EqualTo(1));
88          Assert.That(record.Item2, Is.EqualTo("foo"));
89          var array = (object[][])reader[1];
90          Assert.That(array.Length, Is.EqualTo(2));
91          Assert.That(array[0][0], Is.EqualTo(1));
92          Assert.That(array[1][0], Is.EqualTo(1));
93      }
94      [Test]
95      public async Task Read_Record_as_Tuple()
96      {
97          var recordLiteral = "(1,'foo'::text)::record";
98          await using var conn = await OpenConnectionAsync();
99          await using var cmd = new NpgsqlCommand($"SELECT {recordLiteral}, ARRAY[{recordLiteral}, {recordLiteral}]", conn);
100          await using var reader = await cmd.ExecuteReaderAsync();
101          reader.Read();
102          var record = reader.GetFieldValue<Tuple<int, string>>(0);
103          Assert.That(record.Item1, Is.EqualTo(1));
104          Assert.That(record.Item2, Is.EqualTo("foo"));
105          var array = (object[][])reader[1];
106          Assert.That(array.Length, Is.EqualTo(2));
107          Assert.That(array[0][0], Is.EqualTo(1));
108          Assert.That(array[1][0], Is.EqualTo(1));
109      }
110      [Test]
111      public Task Write_Record_is_not_supported()
112          => AssertTypeUnsupportedWrite<object[], NotSupportedException>(new object[] { 1, "foo" }, "record");
113      [Test]
114      public async Task Records_supported_only_with_EnableRecords([Values] bool withMappings)
115      {
116          Func<IResolveConstraint> assertExpr = () => withMappings
117              ? Throws.Nothing
118              : Throws.Exception
119                  .TypeOf<NotSupportedException>()
120                  .With.Property("Message")
121                  .EqualTo(string.Format(NpgsqlStrings.RecordsNotEnabled, "EnableRecords", "NpgsqlSlimDataSourceBuilder"));
122          var dataSourceBuilder = new NpgsqlSlimDataSourceBuilder(ConnectionString);
123          if (withMappings)
124              dataSourceBuilder.EnableRecords();
125          await using var dataSource = dataSourceBuilder.Build();
126          await using var conn = await dataSource.OpenConnectionAsync();
127          await using var cmd = conn.CreateCommand();
128          cmd.CommandText = "SELECT ('one'::text, 2)";
129          await using var reader = await cmd.ExecuteReaderAsync();
130          await reader.ReadAsync();
131          Assert.That(() => reader.GetValue(0), assertExpr());
132          Assert.That(() => reader.GetFieldValue<object[]>(0), assertExpr());
133      }
134      #endregion Record
135      [Test, Description("Makes sure that setting DbType.Object makes Npgsql infer the type")]
136      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/694")]
137      public async Task DbType_causes_inference()
138      {
139          await using var conn = await OpenConnectionAsync();
140          await using var cmd = new NpgsqlCommand("SELECT @p", conn);
141          cmd.Parameters.Add(new NpgsqlParameter { ParameterName="p", DbType = DbType.Object, Value = 3 });
142          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(3));
143      }
144      #region Unrecognized types
145      [Test, Description("Retrieves a type as an unknown type, i.e. untreated string")]
146      public async Task AllResultTypesAreUnknown()
147      {
148          await using var conn = await OpenConnectionAsync();
149          await using var cmd = new NpgsqlCommand("SELECT TRUE", conn);
150          cmd.AllResultTypesAreUnknown = true;
151          await using var reader = await cmd.ExecuteReaderAsync();
152          reader.Read();
153          Assert.That(reader.GetFieldType(0), Is.EqualTo(typeof(string)));
154          Assert.That(reader.GetString(0), Is.EqualTo("t"));
155      }
156      [Test, Description("Mixes and matches an unknown type with a known type")]
157      public async Task UnknownResultTypeList()
158      {
159          if (IsMultiplexing)
160              return;
161          await using var conn = await OpenConnectionAsync();
162          await using var cmd = new NpgsqlCommand("SELECT TRUE, 8", conn);
163          cmd.UnknownResultTypeList = new[] { true, false };
164          await using var reader = await cmd.ExecuteReaderAsync();
165          reader.Read();
166          Assert.That(reader.GetFieldType(0), Is.EqualTo(typeof(string)));
167          Assert.That(reader.GetString(0), Is.EqualTo("t"));
168          Assert.That(reader.GetInt32(1), Is.EqualTo(8));
169      }
170      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/711")]
171      public async Task Known_type_as_unknown()
172      {
173          await using var conn = await OpenConnectionAsync();
174          await using var cmd = new NpgsqlCommand("SELECT 8", conn);
175          cmd.AllResultTypesAreUnknown = true;
176          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo("8"));
177      }
178      [Test, Description("Sends a null value parameter with no NpgsqlDbType or DbType, but with context for the backend to handle it")]
179      public async Task Unrecognized_null()
180      {
181          await using var conn = await OpenConnectionAsync();
182          await using var cmd = new NpgsqlCommand("SELECT @p::TEXT", conn);
183          var p = new NpgsqlParameter("p", DBNull.Value);
184          cmd.Parameters.Add(p);
185          await using var reader = await cmd.ExecuteReaderAsync();
186          reader.Read();
187          Assert.That(reader.IsDBNull(0));
188          Assert.That(reader.GetFieldType(0), Is.EqualTo(typeof(string)));
189      }
190      [Test, Description("Sends a value parameter with an explicit NpgsqlDbType.Unknown, but with context for the backend to handle it")]
191      public async Task Send_unknown()
192      {
193          await using var conn = await OpenConnectionAsync();
194          await using var cmd = new NpgsqlCommand("SELECT @p::INT4", conn);
195          var p = new NpgsqlParameter("p", "8");
196          cmd.Parameters.Add(p);
197          await using var reader = await cmd.ExecuteReaderAsync();
198          reader.Read();
199          Assert.That(reader.GetFieldType(0), Is.EqualTo(typeof(int)));
<span onclick='openModal()' class='match'>200          Assert.That(reader.GetInt32(0), Is.EqualTo(8));
201      }
</span>202      #endregion
203      [Test]
204      public Task Int2Vector()
205          => AssertType(new short[] { 4, 5, 6 }, "4 5 6", "int2vector", NpgsqlDbType.Int2Vector, isDefault: false);
206      [Test]
207      public Task Oidvector()
208          => AssertType(new uint[] { 4, 5, 6 }, "4 5 6", "oidvector", NpgsqlDbType.Oidvector, isDefault: false);
209      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1138")]
210      public async Task Void()
211      {
212          await using var conn = await OpenConnectionAsync();
213          Assert.That(await conn.ExecuteScalarAsync("SELECT pg_sleep(0)"), Is.SameAs(DBNull.Value));
214      }
215      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1364")]
216      public async Task Unsupported_DbType()
217      {
218          await using var conn = await OpenConnectionAsync();
219          await using var cmd = new NpgsqlCommand("SELECT @p", conn);
220          Assert.That(() => cmd.Parameters.Add(new NpgsqlParameter("p", DbType.UInt32) { Value = 8u }),
221              Throws.Exception.TypeOf<NotSupportedException>());
222      }
223      public MiscTypeTests(MultiplexingMode multiplexingMode) : base(multiplexingMode) {}
224  }
</code></pre>
        </div>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-BugTests.cs</h3>
            <pre><code>1  using Npgsql.BackendMessages;
2  using Npgsql.Tests.Support;
3  using Npgsql.TypeMapping;
4  using NpgsqlTypes;
5  using NUnit.Framework;
6  using System;
7  using System.Data;
8  using System.Text;
9  using System.Threading;
10  using System.Threading.Tasks;
11  using System.Transactions;
12  using static Npgsql.Tests.TestUtil;
13  namespace Npgsql.Tests;
14  public class BugTests : TestBase
15  {
16      #region Sequential reader bugs
17      [Test, Description("In sequential access, performing a null check on a non-first field would check the first field")]
18      public void SequentialNullCheckOnNonFirstField()
19      {
20          using var conn = OpenConnection();
21          using var cmd = new NpgsqlCommand("SELECT 'X', NULL", conn);
22          using var dr = cmd.ExecuteReader(CommandBehavior.SequentialAccess);
23          dr.Read();
24          Assert.That(dr.IsDBNull(1), Is.True);
25      }
26      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1034")]
27      public void SequentialSkipOverFirstRow()
28      {
29          using var conn = OpenConnection();
30          using var cmd = new NpgsqlCommand("SELECT 1; SELECT 2", conn);
31          using var reader = cmd.ExecuteReader(CommandBehavior.SequentialAccess);
32          Assert.That(reader.NextResult(), Is.True);
33          Assert.That(reader.Read(), Is.True);
34          Assert.That(reader.GetInt32(0), Is.EqualTo(2));
35      }
36      [Test]
37      public void SequentialConsumeWithNull()
38      {
39          using var conn = OpenConnection();
40          using var command = new NpgsqlCommand("SELECT 1, NULL", conn);
41          using var reader = command.ExecuteReader(CommandBehavior.SequentialAccess);
42          reader.Read();
43      }
44      #endregion
45      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1210")]
46      public void Many_parameters_with_mixed_FormatCode()
47      {
48          using var conn = OpenConnection();
49          using var cmd = new NpgsqlCommand();
50          cmd.Connection = conn;
51          var sb = new StringBuilder("SELECT @text_param");
52          cmd.Parameters.AddWithValue("@text_param", "some_text");
53          for (var i = 0; i < conn.Settings.WriteBufferSize; i++)
54          {
55              var paramName = $"@binary_param{i}";
56              sb.Append(',');
57              sb.Append(paramName);
58              cmd.Parameters.AddWithValue(paramName, 8);
59          }
60          cmd.CommandText = sb.ToString();
61          var ex = Assert.Throws<PostgresException>(() => cmd.ExecuteNonQuery())!;
62          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.ProgramLimitExceeded)
63              .Or.EqualTo(PostgresErrorCodes.TooManyColumns)); 
64      }
65      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1238")]
66      public void Record_with_non_int_field()
67      {
68          using var conn = OpenConnection();
69          using var cmd = new NpgsqlCommand("SELECT ('one'::TEXT, 2)", conn);
70          using var reader = cmd.ExecuteReader();
71          reader.Read();
72          var record = reader.GetFieldValue<object[]>(0);
73          Assert.That(record[0], Is.EqualTo("one"));
74          Assert.That(record[1], Is.EqualTo(2));
75      }
76      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1450")]
77      public void Bug1450()
78      {
79          using var conn = OpenConnection();
80          using var cmd = new NpgsqlCommand();
81          cmd.Connection = conn;
82          cmd.CommandText = "CREATE TEMP TABLE a (a1 int); CREATE TEMP TABLE b (b1 int);";
83          cmd.ExecuteNonQuery();
84          cmd.CommandText = "CREATE TEMP TABLE c (c1 int);";
85          cmd.ExecuteNonQuery();
86      }
87      [Test]
88      public async Task Bug1645()
89      {
90          await using var conn = await OpenConnectionAsync();
91          var tableName = await CreateTempTable(conn, "field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER");
92          Assert.That(() =>
93              {
94                  using var writer = conn.BeginBinaryImport($"COPY {tableName} (field_text, field_int4) FROM STDIN BINARY");
95                  writer.StartRow();
96                  writer.Write("foo");
97                  writer.Write(8);
98                  writer.StartRow();
99                  throw new InvalidOperationException("Catch me outside the using statement if you can!");
100              }, Throws.Exception
101                  .TypeOf<InvalidOperationException>()
102                  .With.Property(nameof(InvalidOperationException.Message)).EqualTo("Catch me outside the using statement if you can!")
103          );
104          Assert.That(await conn.ExecuteScalarAsync($"SELECT COUNT(*) FROM {tableName}"), Is.Zero);
105      }
106      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3600")]
107      public async Task Bug3600()
108      {
109          var csb = new NpgsqlConnectionStringBuilder(ConnectionString)
110          {
111              CommandTimeout = 1,
112          };
113          await using var postmasterMock = PgPostmasterMock.Start(csb.ConnectionString);
114          await using var dataSource = CreateDataSource(postmasterMock.ConnectionString);
115          await using var conn = await dataSource.OpenConnectionAsync();
116          var serverMock = await postmasterMock.WaitForServerConnection();
117          await serverMock
118              .WriteCopyInResponse()
119              .FlushAsync();
120          var ex = Assert.ThrowsAsync<NpgsqlException>(async () =>
121          {
122              await using var importer = await conn.BeginTextImportAsync($"COPY SomeTable (field_text, field_int4) FROM STDIN");
123          });
124          Assert.That(ex!.InnerException, Is.TypeOf<TimeoutException>());
125      }
126      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1497")]
127      public async Task Bug1497()
128      {
129          await using var conn = await OpenConnectionAsync();
130          var tableName = await CreateTempTable(conn, "id INT4");
131          conn.ExecuteNonQuery($"INSERT INTO {tableName} (id) VALUES (NULL)");
132          await using var cmd = new NpgsqlCommand($"SELECT * FROM {tableName}", conn);
133          await using var reader = await cmd.ExecuteReaderAsync();
134          var dt = new DataTable();
135          dt.Load(reader);
136      }
137      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1558")]
138      public void Bug1558()
139      {
140          using var dataSource = CreateDataSource(csb =>
141          {
142              csb.Pooling = false;
143              csb.Enlist = true;
144          });
145          using var tx = new TransactionScope();
146          using var conn = dataSource.OpenConnection();
147      }
148      [Test]
149      public void Bug1695()
150      {
151          using var dataSource = CreateDataSource(csb =>
152          {
153              csb.Pooling = false;
154              csb.MaxAutoPrepare = 10;
155              csb.AutoPrepareMinUsages = 1;
156          });
157          using var conn = dataSource.OpenConnection();
158          using (var cmd = new NpgsqlCommand("SELECT 1; SELECT 2", conn))
159          using (var reader = cmd.ExecuteReader())
160          {
161              reader.Read();
162          }
163          Assert.That(conn.ExecuteScalar("SELECT 2"), Is.EqualTo(2));
164      }
165      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1700")]
166      public void Bug1700()
167      {
168          Assert.That(() =>
169          {
170              using var conn = OpenConnection();
171              using var tx = conn.BeginTransaction();
172              using var cmd = conn.CreateCommand();
173              cmd.CommandText = "SELECT 1";
174              var reader = cmd.ExecuteReader();
175              while (reader.Read())
176              {
177                  throw new InvalidOperationException("Some problem parsing the returned data");
178              }
179              tx.Commit();
180          }, Throws.InvalidOperationException.With.Message.EqualTo("Some problem parsing the returned data"));
181      }
182      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1964")]
183      public void Bug1964()
184      {
185          using var conn = OpenConnection();
186          using var cmd = new NpgsqlCommand("INVALID SQL", conn);
187          cmd.Parameters.Add(new NpgsqlParameter { ParameterName = "p", Direction = ParameterDirection.Output });
188          Assert.That(() => cmd.ExecuteNonQuery(), Throws.Exception.TypeOf<PostgresException>()
189              .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.SyntaxError));
190      }
191      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1986")]
192      public void Bug1986()
193      {
194          using var conn = OpenConnection();
195          using var cmd = new NpgsqlCommand("SELECT 'hello', 'goodbye'", conn);
196          using var reader = cmd.ExecuteReader();
197          reader.Read();
198          using (var textReader1 = reader.GetTextReader(0))
199          {
200          }
201          using (var textReader2 = reader.GetTextReader(1))
202          {
203          }
204      }
205      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1987")]
206      public async Task Bug1987()
207      {
208          await using var adminConnection = await OpenConnectionAsync();
209          var type = await GetTempTypeName(adminConnection);
210          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} AS ENUM ('sad', 'ok', 'happy')");
211          var dataSourceBuilder = CreateDataSourceBuilder();
212          dataSourceBuilder.MapEnum<Mood>(type);
213          await using var dataSource = dataSourceBuilder.Build();
214          await using var connection = await dataSource.OpenConnectionAsync();
215          for (var i = 0; i < 2; i++)
216          {
217              await using var cmd = new NpgsqlCommand("SELECT @p", connection);
218              cmd.Parameters.AddWithValue("p", Mood.Happy);
219              Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(Mood.Happy));
220          }
221      }
222      enum Mood { Sad, Ok, Happy };
223      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2003")]
224      public void Bug2003()
225      {
226          using var conn = OpenConnection();
227          var longFieldName = new string('x', conn.Settings.ReadBufferSize);
228          using var cmd = new NpgsqlCommand($"SELECT 8 AS {longFieldName}", conn);
229          using var reader = cmd.ExecuteReader(CommandBehavior.SequentialAccess);
230          reader.Read();
<span onclick='openModal()' class='match'>231          Assert.That(reader.GetInt32(0), Is.EqualTo(8));
232      }
</span>233      [Test]
234      public async Task Bug2046()
235      {
236          var expected = 64.27245f;
237          using var conn = OpenConnection();
238          using var cmd = new NpgsqlCommand("SELECT @p = 64.27245::real, 64.27245::real, @p", conn);
239          cmd.Parameters.AddWithValue("p", expected);
240          using var rdr = await cmd.ExecuteReaderAsync();
241          rdr.Read();
242          Assert.That(rdr.GetFieldValue<bool>(0));
243          Assert.That(rdr.GetFieldValue<float>(1), Is.EqualTo(expected));
244          Assert.That(rdr.GetFieldValue<float>(2), Is.EqualTo(expected));
245      }
246      [Test]
247      public void Bug1761()
248      {
249          using var dataSource = CreateDataSource(csb =>
250          {
251              csb.Enlist = true;
252              csb.Pooling = true;
253              csb.MinPoolSize = 1;
254              csb.MaxPoolSize = 1;
255          });
256          for (var i = 0; i < 2; i++)
257          {
258              try
259              {
260                  using var scope = new TransactionScope(TransactionScopeOption.Required, TimeSpan.FromMilliseconds(100));
261                  Thread.Sleep(1000);
262                  using (var connection = dataSource.OpenConnection())
263                  using (var cmd = new NpgsqlCommand("SELECT 1", connection))
264                  {
265                      cmd.CommandText = "select 1;";
266                      cmd.ExecuteNonQuery();
267                  }
268                  scope.Complete();
269              }
270              catch (TransactionException)
271              {
272              }
273          }
274      }
275      [Test]
276      public void Bug2274()
277      {
278          using var conn = OpenConnection();
279          using var cmd = new NpgsqlCommand("SELECT 1", conn);
280          cmd.Parameters.Add(new NpgsqlParameter
281          {
282              ParameterName = "p",
283              Direction = ParameterDirection.Output
284          });
285          using var reader = cmd.ExecuteReader(CommandBehavior.SingleRow);
286          Assert.That(() => reader.GetInt32(0), Throws.Exception.TypeOf<InvalidOperationException>());
287          Assert.That(reader.Read(), Is.True);
288          Assert.That(reader.GetInt32(0), Is.EqualTo(1));
289          Assert.That(reader.Read(), Is.False);
290      }
291      [Test]
292      public async Task Bug2278()
293      {
294          await using var adminConnection = await OpenConnectionAsync();
295          var enumType = await GetTempTypeName(adminConnection);
296          var domainType = await GetTempTypeName(adminConnection);
297          var compositeType = await GetTempTypeName(adminConnection);
298          await adminConnection.ExecuteNonQueryAsync($@"
299  CREATE TYPE {enumType} AS ENUM ('left', 'right');
300  CREATE DOMAIN {domainType} AS {enumType} NOT NULL;
301  CREATE TYPE {compositeType} AS (value {domainType})");
302          var table = await CreateTempTable(adminConnection, $"value {compositeType}");
303          var dataSourceBuilder = CreateDataSourceBuilder();
304          dataSourceBuilder.MapComposite<Bug2278CompositeType>(compositeType);
305          dataSourceBuilder.MapEnum<Bug2278EnumType>(enumType);
306          await using var dataSource = dataSourceBuilder.Build();
307          await using var connection = await dataSource.OpenConnectionAsync();
308          await connection.ExecuteScalarAsync($"SELECT * FROM {table} AS d");
309      }
310      class Bug2278CompositeType
311      {
312          public Bug2278EnumType Value { get; set; }
313      }
314      enum Bug2278EnumType
315      {
316          Left,
317          Right
318      }
319      [Test]
320      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2178")]
321      public async Task Bug2178()
322      {
323          await using var dataSource = CreateDataSource(csb =>
324          {
325              csb.AutoPrepareMinUsages = 2;
326              csb.MaxAutoPrepare = 2;
327          });
328          await using var conn = await dataSource.OpenConnectionAsync();
329          await using var cmd = new NpgsqlCommand();
330          cmd.Connection = conn;
331          cmd.CommandText = "SELECT 1";
332          await cmd.ExecuteScalarAsync();
333          await cmd.ExecuteScalarAsync();
334          Assert.That(cmd.IsPrepared);
335          cmd.CommandText = "SELECT * FROM public.dummy_table_name";
336          for (var i = 0; i < 3; ++i)
337          {
338              Assert.ThrowsAsync<PostgresException>(async () => await cmd.ExecuteScalarAsync());
339          }
340          cmd.CommandText = "SELECT 1";
341          await cmd.ExecuteScalarAsync();
342          Assert.That(cmd.IsPrepared);
343      }
344      [Test]
345      public async Task Bug2296()
346      {
347          await using var conn = await OpenConnectionAsync();
348          await conn.ExecuteNonQueryAsync("DROP TYPE IF EXISTS \"boolean\" CASCADE");
349          await conn.ExecuteNonQueryAsync("CREATE DOMAIN pg_temp.\"boolean\" AS bool");
350          conn.ReloadTypes();
351          var tableName = await CreateTempTable(conn, $"mybool \"boolean\"");
352          await conn.ExecuteNonQueryAsync($"INSERT INTO {tableName} (mybool) VALUES (TRUE)");
353          await conn.ExecuteScalarAsync($"SELECT mybool FROM {tableName}");
354      }
355      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2660")]
356      public void Standard_conforming_strings()
357      {
358          using var conn = OpenConnection();
359          var sql = @"
360  SELECT table_name
361  FROM information_schema.views
362  WHERE table_name LIKE @p0 escape '\' AND (is_updatable = 'NO') = @p1";
363          using var cmd = new NpgsqlCommand(sql, conn);
364          cmd.Parameters.AddWithValue("@p0", "%trig%");
365          cmd.Parameters.AddWithValue("@p1", true);
366          using var reader = cmd.ExecuteReader();
367          reader.Read();
368      }
369      #region Bug1285
370      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1285")]
371      public void Bug1285()
372      {
373          using var conn = OpenConnection();
374          using var cmd = new NpgsqlCommand { Connection = conn };
375          cmd.CommandText = Bug1285CreateStatement;
376          cmd.ExecuteNonQuery();
377          cmd.CommandText = Bug1285SelectStatement;
378          cmd.Parameters.Add(new NpgsqlParameter("@1", Guid.NewGuid()));
379          cmd.ExecuteNonQuery();
380      }
381      const string Bug1285SelectStatement =
382          "select " +
383          " \"Afbeelding\"" +
384          ", \"Afbeelding#Id\"" +
385          ", \"Omschrijving\"" +
386          ", \"Website\"" +
387          ", \"EMailadres\"" +
388          ", \"SocialMediaVastleggen\"" +
389          ", \"Facebook\"" +
390          ", \"Linkedin\"" +
391          ", \"Twitter\"" +
392          ", \"Youtube\"" +
393          ", \"Branche\"" +
394          ", \"Branche#Id\"" +
395          ", \"Branche#ComponentId\"" +
396          ", \"Telefoonnummer\"" +
397          ", \"Overheidsidentificatienummer\"" +
398          ", \"Adres\"" +
399          ", \"Adres#Id\"" +
400          ", \"Adres#ComponentId\"" +
401          ", \"2gIKz62kaTdGxw82_OrzTc4ANSM_\"" +
402          ", \"OnderdeelVanOrganisatie\"" +
403          ", \"OnderdeelVanOrganisatie#Id\"" +
404          ", \"OnderdeelVanOrganisatie#ComponentId\"" +
405          ", \"Profit\"" +
406          ", \"Profit#Id\"" +
407          ", \"Profit#ComponentId\"" +
408          ", \"Taal\"" +
409          ", \"Taal#Id\"" +
410          ", \"Taal#ComponentId\"" +
411          ", \"KlantSinds\"" +
412          ", \"BarcodeKlant\"" +
413          ", \"BarcodeKlant#BarcodeType\"" +
414          ", \"BarcodeKlant#Value\"" +
415          ", \"Postadres\"" +
416          ", \"Postadres#Id\"" +
417          ", \"Postadres#ComponentId\"" +
418          ", \"LeverancierSinds\"" +
419          ", \"BarcodeLeverancier\"" +
420          ", \"BarcodeLeverancier#BarcodeType\"" +
421          ", \"BarcodeLeverancier#Value\"" +
422          ", \"Zoeknaam\"" +
423          ", \"TitelEnAanhef\"" +
424          ", \"TitelEnAanhef#Id\"" +
425          ", \"TitelEnAanhef#ComponentId\"" +
426          ", \"Rechtsvorm\"" +
427          ", \"Rechtsvorm#Id\"" +
428          ", \"Rechtsvorm#ComponentId\"" +
429          ", \"LandVanVestiging\"" +
430          ", \"LandVanVestiging#Id\"" +
431          ", \"LandVanVestiging#ComponentId\"" +
432          ", \"AantalMedewerkers\"" +
433          ", \"NaamStatutair\"" +
434          ", \"VestigingStatutair\"" +
435          ", \"Correspondentie\"" +
436          ", \"Medium\"" +
437          ", \"FiscaalNummer\"" +
438          ", \"AangebrachtDoor\"" +
439          ", \"AangebrachtDoor#Id\"" +
440          ", \"AangebrachtDoor#ComponentId\"" +
441          ", \"Status\"" +
442          ", \"NummerKamerVanKoophandel\"" +
443          ", \"zII9SOHbwUPS_jKSlcRrQzuEr6A_\"" +
444          ", \"Code\"" +
445          ", \"OrganisatorischeEenheid\"" +
446          ", \"OrganisatorischeEenheid#Id\"" +
447          ", \"OrganisatorischeEenheid#ComponentId\"" +
448          ", \"PJlr3asVdeHVoqmAyHIF2fF1gVM_\"" +
449          ", \"IsUwv\"" +
450          ", \"Uwv\"" +
451          ", \"Uwv#Id\"" +
452          ", \"Uwv#ComponentId\"" +
453          ", \"IsVerzekeraarVoorWerkgever\"" +
454          ", \"VerzekeraarVoorWerkgever\"" +
455          ", \"VerzekeraarVoorWerkgever#Id\"" +
456          ", \"VerzekeraarVoorWerkgever#ComponentId\"" +
457          ", \"IsAbonnementsadministratie\"" +
458          ", \"Abonnementsadministratie\"" +
459          ", \"Abonnementsadministratie#Id\"" +
460          ", \"Abonnementsadministratie#ComponentId\"" +
461          ", \"IsPensioenfonds\"" +
462          ", \"Pensioenfonds\"" +
463          ", \"Pensioenfonds#Id\"" +
464          ", \"Pensioenfonds#ComponentId\"" +
465          ", \"IsProfit\"" +
466          ", \"Profit1\"" +
467          ", \"Profit1#Id\"" +
468          ", \"Profit1#ComponentId\"" +
469          ", \"Verantwoordelijke\"" +
470          ", \"Verantwoordelijke#Id\"" +
471          ", \"Verantwoordelijke#ComponentId\"" +
472          ", \"IsKlant\"" +
473          ", \"Klant\"" +
474          ", \"Klant#Id\"" +
475          ", \"Klant#ComponentId\"" +
476          ", \"IsFactureringsadministratie\"" +
477          ", \"Factureringsadministratie\"" +
478          ", \"Factureringsadministratie#Id\"" +
479          ", \"Factureringsadministratie#ComponentId\"" +
480          ", \"IsLeninggever\"" +
481          ", \"Leninggever\"" +
482          ", \"Leninggever#Id\"" +
483          ", \"Leninggever#ComponentId\"" +
484          ", \"IsProjectadministratie\"" +
485          ", \"Projectadministratie\"" +
486          ", \"Projectadministratie#Id\"" +
487          ", \"Projectadministratie#ComponentId\"" +
488          ", \"IsVervangingsfonds\"" +
489          ", \"Vervangingsfonds\"" +
490          ", \"Vervangingsfonds#Id\"" +
491          ", \"Vervangingsfonds#ComponentId\"" +
492          ", \"IsPensioen\"" +
493          ", \"Pensioen\"" +
494          ", \"Pensioen#Id\"" +
495          ", \"Pensioen#ComponentId\"" +
496          ", \"IsVasteActivaAdministratie\"" +
497          ", \"VasteActivaAdministratie\"" +
498          ", \"VasteActivaAdministratie#Id\"" +
499          ", \"VasteActivaAdministratie#ComponentId\"" +
500          ", \"IsBelastingdienst\"" +
501          ", \"Belastingdienst\"" +
502          ", \"Belastingdienst#Id\"" +
503          ", \"Belastingdienst#ComponentId\"" +
504          ", \"IsCursusadministratie\"" +
505          ", \"Cursusadministratie\"" +
506          ", \"Cursusadministratie#Id\"" +
507          ", \"Cursusadministratie#ComponentId\"" +
508          ", \"IsUitvoerderVervangingsfonds\"" +
509          ", \"UitvoerderVervangingsfonds\"" +
510          ", \"UitvoerderVervangingsfonds#Id\"" +
511          ", \"UitvoerderVervangingsfonds#ComponentId\"" +
512          ", \"IsAssemblageadministratie\"" +
513          ", \"Assemblageadministratie\"" +
514          ", \"Assemblageadministratie#Id\"" +
515          ", \"Assemblageadministratie#ComponentId\"" +
516          ", \"IsLeasemaatschappij\"" +
517          ", \"Leasemaatschappij\"" +
518          ", \"Leasemaatschappij#Id\"" +
519          ", \"Leasemaatschappij#ComponentId\"" +
520          ", \"IsBeslaglegger\"" +
521          ", \"Beslaglegger\"" +
522          ", \"Beslaglegger#Id\"" +
523          ", \"Beslaglegger#ComponentId\"" +
524          ", \"IsVerzekeraarVoorMedewerker\"" +
525          ", \"VerzekeraarVoorMedewerker\"" +
526          ", \"VerzekeraarVoorMedewerker#Id\"" +
527          ", \"VerzekeraarVoorMedewerker#ComponentId\"" +
528          ", \"IsWoningverhuur\"" +
529          ", \"Woningverhuur\"" +
530          ", \"Woningverhuur#Id\"" +
531          ", \"Woningverhuur#ComponentId\"" +
532          ", \"9cSTu7fkjOZm08FFQUHvclQHSWY_\"" +
533          ", \"Goederenstroomadministratie\"" +
534          ", \"Goederenstroomadministratie#Id\"" +
535          ", \"Goederenstroomadministratie#ComponentId\"" +
536          ", \"IsConcurrent\"" +
537          ", \"Concurrent\"" +
538          ", \"Concurrent#Id\"" +
539          ", \"Concurrent#ComponentId\"" +
540          ", \"IsArbodienst\"" +
541          ", \"Arbodienst\"" +
542          ", \"Arbodienst#Id\"" +
543          ", \"Arbodienst#ComponentId\"" +
544          ", \"IsUitvoerderSociaalFonds\"" +
545          ", \"UitvoerderSociaalFonds\"" +
546          ", \"UitvoerderSociaalFonds#Id\"" +
547          ", \"UitvoerderSociaalFonds#ComponentId\"" +
548          ", \"IsPensioenuitvoerder\"" +
549          ", \"Pensioenuitvoerder\"" +
550          ", \"Pensioenuitvoerder#Id\"" +
551          ", \"Pensioenuitvoerder#ComponentId\"" +
552          ", \"IsProspect\"" +
553          ", \"Prospect\"" +
554          ", \"Prospect#Id\"" +
555          ", \"Prospect#ComponentId\"" +
556          ", \"IsProspectadministratie\"" +
557          ", \"Prospectadministratie\"" +
558          ", \"Prospectadministratie#Id\"" +
559          ", \"Prospectadministratie#ComponentId\"" +
560          ", \"IsArtikelbeheeradministratie\"" +
561          ", \"Artikelbeheeradministratie\"" +
562          ", \"Artikelbeheeradministratie#Id\"" +
563          ", \"Artikelbeheeradministratie#ComponentId\"" +
564          ", \"v1J4Rq2eNZy9GBvGhuCBKqga0Rg_\"" +
565          ", \"g4i3gYZGL0yu0T6UwmiZTaUDI8Y_\"" +
566          ", \"g4i3gYZGL0yu0T6UwmiZTaUDI8Y_#Id\"" +
567          ", \"g4i3gYZGL0yu0T6UwmiZTaUDI8Y_#ComponentId\"" +
568          ", \"IsSociaalFonds\"" +
569          ", \"SociaalFonds\"" +
570          ", \"SociaalFonds#Id\"" +
571          ", \"SociaalFonds#ComponentId\"" +
572          ", \"IsWagenparkadministratie\"" +
573          ", \"Wagenparkadministratie\"" +
574          ", \"Wagenparkadministratie#Id\"" +
575          ", \"Wagenparkadministratie#ComponentId\"" +
576          ", \"IsLeverancier\"" +
577          ", \"Leverancier\"" +
578          ", \"Leverancier#Id\"" +
579          ", \"Leverancier#ComponentId\"" +
580          ", \"IsWagenparkAfnemer\"" +
581          ", \"WagenparkAfnemer\"" +
582          ", \"WagenparkAfnemer#Id\"" +
583          ", \"WagenparkAfnemer#ComponentId\"" +
584          ", \"IsEvenementadministratie\"" +
585          ", \"Evenementadministratie\"" +
586          ", \"Evenementadministratie#Id\"" +
587          ", \"Evenementadministratie#ComponentId\"" +
588          ", \"IsCrediteur\"" +
589          ", \"Crediteur\"" +
590          ", \"Crediteur#Id\"" +
591          ", \"Crediteur#ComponentId\"" +
592          ", \"IsFinancieleAdministratie\"" +
593          ", \"FinancieleAdministratie\"" +
594          ", \"FinancieleAdministratie#Id\"" +
595          ", \"FinancieleAdministratie#ComponentId\"" +
596          ", \"IsSociaalSecretariaat\"" +
597          ", \"SociaalSecretariaat\"" +
598          ", \"SociaalSecretariaat#Id\"" +
599          ", \"SociaalSecretariaat#ComponentId\"" +
600          ", \"IsBank\"" +
601          ", \"Bank\"" +
602          ", \"Bank#Id\"" +
603          ", \"Bank#ComponentId\"" +
604          ", \"IsWerkgever\"" +
605          ", \"Werkgever\"" +
606          ", \"Werkgever#Id\"" +
607          ", \"Werkgever#ComponentId\"" +
608          ", \"IsVerkoopadministratie\"" +
609          ", \"Verkoopadministratie\"" +
610          ", \"Verkoopadministratie#Id\"" +
611          ", \"Verkoopadministratie#ComponentId\"" +
612          ", \"IsInkoopadministratie\"" +
613          ", \"Inkoopadministratie\"" +
614          ", \"Inkoopadministratie#Id\"" +
615          ", \"Inkoopadministratie#ComponentId\"" +
616          ", \"IsSubsidient\"" +
617          ", \"Subsidient\"" +
618          ", \"Subsidient#Id\"" +
619          ", \"Subsidient#ComponentId\"" +
620          ", \"IsEnqueteadministratie\"" +
621          ", \"Enqueteadministratie\"" +
622          ", \"Enqueteadministratie#Id\"" +
623          ", \"Enqueteadministratie#ComponentId\"" +
624          ", \"XWiQaVjEbD041r7QN0kj2aKeCys_\"" +
625          ", \"X_TVE5FRBaQ97JJQbT7LmX4HBVY_\"" +
626          ", \"BrancheDescription\"" +
627          ", \"AdresDescription\"" +
628          ", \"PicMWY7oCqeiZMTdDqwFqi1U508_\"" +
629          ", \"ProfitDescription\"" +
630          ", \"TaalDescription\"" +
631          ", \"PostadresDescription\"" +
632          ", \"TitelEnAanhefDescription\"" +
633          ", \"RechtsvormDescription\"" +
634          ", \"LandVanVestigingDescription\"" +
635          ", \"AangebrachtDoorDescription\"" +
636          ", \"KFEDo6ZYK_ffNCeHuujBCshlPVs_\"" +
637          ", \"VerantwoordelijkeDescription\"" +
638          ", \"FunctionalState\"" +
639          ", \"KlantFinancieleAdministratie\"" +
640          ", \"KlantFinancieleAdministratie#Id\"" +
641          ", \"KlantFinancieleAdministratie#ComponentId\"" +
642          ", \"KlantVerkoopadministratie\"" +
643          ", \"KlantVerkoopadministratie#Id\"" +
644          ", \"KlantVerkoopadministratie#ComponentId\"" +
645          ", \"NQwaM_lfzxIm_JPrPhwruL0YOXY_\"" +
646          ", \"NQwaM_lfzxIm_JPrPhwruL0YOXY_#Id\"" +
647          ", \"NQwaM_lfzxIm_JPrPhwruL0YOXY_#ComponentId\"" +
648          ", \"uSf1yseW4YQ1K6EoHNlzCxPofm0_\"" +
649          ", \"uSf1yseW4YQ1K6EoHNlzCxPofm0_#Id\"" +
650          ", \"uSf1yseW4YQ1K6EoHNlzCxPofm0_#ComponentId\"" +
651          ", \"KlantEvenementadministratie\"" +
652          ", \"KlantEvenementadministratie#Id\"" +
653          ", \"KlantEvenementadministratie#ComponentId\"" +
654          ", \"KlantCursusadministratie\"" +
655          ", \"KlantCursusadministratie#Id\"" +
656          ", \"KlantCursusadministratie#ComponentId\"" +
657          ", \"KlantProspectadministratie\"" +
658          ", \"KlantProspectadministratie#Id\"" +
659          ", \"KlantProspectadministratie#ComponentId\"" +
660          ", \"KlantInkoopadministratie\"" +
661          ", \"KlantInkoopadministratie#Id\"" +
662          ", \"KlantInkoopadministratie#ComponentId\"" +
663          ", \"KlantProjectadministratie\"" +
664          ", \"KlantProjectadministratie#Id\"" +
665          ", \"KlantProjectadministratie#ComponentId\"" +
666          ", \"P0gBTGcrSbl2kK8BM4_24fIeMvk_\"" +
667          ", \"P0gBTGcrSbl2kK8BM4_24fIeMvk_#Id\"" +
668          ", \"P0gBTGcrSbl2kK8BM4_24fIeMvk_#ComponentId\"" +
669          ", \"KlantMain\"" +
670          ", \"KlantMain#Id\"" +
671          ", \"KlantMain#ComponentId\"" +
672          ", \"8awXARDcCdVtrvN6IRlwAk5UcrI_\"" +
673          ", \"8awXARDcCdVtrvN6IRlwAk5UcrI_#Id\"" +
674          ", \"8awXARDcCdVtrvN6IRlwAk5UcrI_#ComponentId\"" +
675          ", \"MjgFAhRfH64O3M9Ts_5b0ENQDBE_\"" +
676          ", \"MjgFAhRfH64O3M9Ts_5b0ENQDBE_#Id\"" +
677          ", \"MjgFAhRfH64O3M9Ts_5b0ENQDBE_#ComponentId\"" +
678          ", \"LeverancierMain\"" +
679          ", \"LeverancierMain#Id\"" +
680          ", \"LeverancierMain#ComponentId\"" +
681          ", \"2CaNQvGgtPNHP2XCsoKBQEpwmYA_\"" +
682          ", \"2CaNQvGgtPNHP2XCsoKBQEpwmYA_#Id\"" +
683          ", \"2CaNQvGgtPNHP2XCsoKBQEpwmYA_#ComponentId\"" +
684          ", \"kleo39GG1utTUtP0F15mWkXZBFQ_\"" +
685          ", \"kleo39GG1utTUtP0F15mWkXZBFQ_#Id\"" +
686          ", \"kleo39GG1utTUtP0F15mWkXZBFQ_#ComponentId\"" +
687          ", \"d9jEYARbghWBrZU6jKbtZPyZUAk_\"" +
688          ", \"d9jEYARbghWBrZU6jKbtZPyZUAk_#Id\"" +
689          ", \"d9jEYARbghWBrZU6jKbtZPyZUAk_#ComponentId\"" +
690          ", \"CrediteurMain\"" +
691          ", \"CrediteurMain#Id\"" +
692          ", \"CrediteurMain#ComponentId\"" +
693          ", \"TTStart\"" +
694          ", \"TTEnd\"" +
695          ", \"InstanceId\"" +
696          ", \"StartDate\"" +
697          ", \"EndDate\"" +
698          ", \"UserId\"" +
699          ", \"Id\"" +
700          " from \"OrganisatieQmo_Organisatie_QueryModelObjects_Imp\" WHERE (\"InstanceId\" = @1) AND ((\"StartDate\" IS NULL) AND (\"TTEnd\" IS NULL)) ORDER BY \"Id\" ASC NULLS FIRST OFFSET 0 ROWS FETCH NEXT 2 ROWS ONLY;";
701      const string Bug1285CreateStatement = @"
702  CREATE TEMP TABLE ""OrganisatieQmo_Organisatie_QueryModelObjects_Imp""
703  (
704    ""Id"" uuid NOT NULL,
705    ""InstanceId"" uuid,
706    ""UserId"" text,
707    ""StartDate"" timestamp(3) without time zone,
708    ""EndDate"" timestamp(3) without time zone,
709    ""TTStart"" timestamp(3) without time zone,
710    ""TTEnd"" timestamp(3) without time zone,
711    ""Afbeelding#Id"" uuid,
712    ""Afbeelding"" boolean,
713    ""Omschrijving"" character varying(250),
714    ""Website"" text,
715    ""EMailadres"" character varying(255),
716    ""SocialMediaVastleggen"" boolean,
717    ""Facebook"" text,
718    ""Linkedin"" text,
719    ""Twitter"" text,
720    ""Youtube"" text,
721    ""Branche#Id"" uuid,
722    ""Branche#ComponentId"" uuid,
723    ""Branche"" boolean,
724    ""Telefoonnummer"" character varying(18),
725    ""Overheidsidentificatienummer"" character varying(40),
726    ""Adres#Id"" uuid,
727    ""Adres#ComponentId"" uuid,
728    ""Adres"" boolean,
729    ""2gIKz62kaTdGxw82_OrzTc4ANSM_"" boolean,
730    ""OnderdeelVanOrganisatie#Id"" uuid,
731    ""OnderdeelVanOrganisatie#ComponentId"" uuid,
732    ""OnderdeelVanOrganisatie"" boolean,
733    ""Profit#Id"" uuid,
734    ""Profit#ComponentId"" uuid,
735    ""Profit"" boolean,
736    ""Taal#Id"" uuid,
737    ""Taal#ComponentId"" uuid,
738    ""Taal"" boolean,
739    ""KlantSinds"" timestamp(3) without time zone,
740    ""BarcodeKlant#BarcodeType"" uuid,
741    ""BarcodeKlant#Value"" text,
742    ""BarcodeKlant"" boolean,
743    ""Postadres#Id"" uuid,
744    ""Postadres#ComponentId"" uuid,
745    ""Postadres"" boolean,
746    ""LeverancierSinds"" timestamp(3) without time zone,
747    ""BarcodeLeverancier#BarcodeType"" uuid,
748    ""BarcodeLeverancier#Value"" text,
749    ""BarcodeLeverancier"" boolean,
750    ""Zoeknaam"" character varying(255),
751    ""TitelEnAanhef#Id"" uuid,
752    ""TitelEnAanhef#ComponentId"" uuid,
753    ""TitelEnAanhef"" boolean,
754    ""Rechtsvorm#Id"" uuid,
755    ""Rechtsvorm#ComponentId"" uuid,
756    ""Rechtsvorm"" boolean,
757    ""LandVanVestiging#Id"" uuid,
758    ""LandVanVestiging#ComponentId"" uuid,
759    ""LandVanVestiging"" boolean,
760    ""AantalMedewerkers"" character varying(50),
761    ""NaamStatutair"" character varying(255),
762    ""VestigingStatutair"" character varying(255),
763    ""Correspondentie"" boolean,
764    ""Medium"" character varying(255),
765    ""FiscaalNummer"" character varying(9),
766    ""AangebrachtDoor#Id"" uuid,
767    ""AangebrachtDoor#ComponentId"" uuid,
768    ""AangebrachtDoor"" boolean,
769    ""Status"" character varying(255),
770    ""NummerKamerVanKoophandel"" character varying(30),
771    ""zII9SOHbwUPS_jKSlcRrQzuEr6A_"" timestamp(3) without time zone,
772    ""Code"" character varying(255),
773    ""OrganisatorischeEenheid#Id"" uuid,
774    ""OrganisatorischeEenheid#ComponentId"" uuid,
775    ""OrganisatorischeEenheid"" boolean,
776    ""PJlr3asVdeHVoqmAyHIF2fF1gVM_"" uuid,
777    ""IsUwv"" boolean,
778    ""Uwv#Id"" uuid,
779    ""Uwv#ComponentId"" uuid,
780    ""Uwv"" boolean,
781    ""IsVerzekeraarVoorWerkgever"" boolean,
782    ""VerzekeraarVoorWerkgever#Id"" uuid,
783    ""VerzekeraarVoorWerkgever#ComponentId"" uuid,
784    ""VerzekeraarVoorWerkgever"" boolean,
785    ""IsAbonnementsadministratie"" boolean,
786    ""Abonnementsadministratie#Id"" uuid,
787    ""Abonnementsadministratie#ComponentId"" uuid,
788    ""Abonnementsadministratie"" boolean,
789    ""IsPensioenfonds"" boolean,
790    ""Pensioenfonds#Id"" uuid,
791    ""Pensioenfonds#ComponentId"" uuid,
792    ""Pensioenfonds"" boolean,
793    ""IsProfit"" boolean,
794    ""Profit1#Id"" uuid,
795    ""Profit1#ComponentId"" uuid,
796    ""Profit1"" boolean,
797    ""Verantwoordelijke#Id"" uuid,
798    ""Verantwoordelijke#ComponentId"" uuid,
799    ""Verantwoordelijke"" boolean,
800    ""IsKlant"" boolean,
801    ""Klant#Id"" uuid,
802    ""Klant#ComponentId"" uuid,
803    ""Klant"" boolean,
804    ""IsFactureringsadministratie"" boolean,
805    ""Factureringsadministratie#Id"" uuid,
806    ""Factureringsadministratie#ComponentId"" uuid,
807    ""Factureringsadministratie"" boolean,
808    ""IsLeninggever"" boolean,
809    ""Leninggever#Id"" uuid,
810    ""Leninggever#ComponentId"" uuid,
811    ""Leninggever"" boolean,
812    ""IsProjectadministratie"" boolean,
813    ""Projectadministratie#Id"" uuid,
814    ""Projectadministratie#ComponentId"" uuid,
815    ""Projectadministratie"" boolean,
816    ""IsVervangingsfonds"" boolean,
817    ""Vervangingsfonds#Id"" uuid,
818    ""Vervangingsfonds#ComponentId"" uuid,
819    ""Vervangingsfonds"" boolean,
820    ""IsPensioen"" boolean,
821    ""Pensioen#Id"" uuid,
822    ""Pensioen#ComponentId"" uuid,
823    ""Pensioen"" boolean,
824    ""IsVasteActivaAdministratie"" boolean,
825    ""VasteActivaAdministratie#Id"" uuid,
826    ""VasteActivaAdministratie#ComponentId"" uuid,
827    ""VasteActivaAdministratie"" boolean,
828    ""IsBelastingdienst"" boolean,
829    ""Belastingdienst#Id"" uuid,
830    ""Belastingdienst#ComponentId"" uuid,
831    ""Belastingdienst"" boolean,
832    ""IsCursusadministratie"" boolean,
833    ""Cursusadministratie#Id"" uuid,
834    ""Cursusadministratie#ComponentId"" uuid,
835    ""Cursusadministratie"" boolean,
836    ""IsUitvoerderVervangingsfonds"" boolean,
837    ""UitvoerderVervangingsfonds#Id"" uuid,
838    ""UitvoerderVervangingsfonds#ComponentId"" uuid,
839    ""UitvoerderVervangingsfonds"" boolean,
840    ""IsAssemblageadministratie"" boolean,
841    ""Assemblageadministratie#Id"" uuid,
842    ""Assemblageadministratie#ComponentId"" uuid,
843    ""Assemblageadministratie"" boolean,
844    ""IsLeasemaatschappij"" boolean,
845    ""Leasemaatschappij#Id"" uuid,
846    ""Leasemaatschappij#ComponentId"" uuid,
847    ""Leasemaatschappij"" boolean,
848    ""IsBeslaglegger"" boolean,
849    ""Beslaglegger#Id"" uuid,
850    ""Beslaglegger#ComponentId"" uuid,
851    ""Beslaglegger"" boolean,
852    ""IsVerzekeraarVoorMedewerker"" boolean,
853    ""VerzekeraarVoorMedewerker#Id"" uuid,
854    ""VerzekeraarVoorMedewerker#ComponentId"" uuid,
855    ""VerzekeraarVoorMedewerker"" boolean,
856    ""IsWoningverhuur"" boolean,
857    ""Woningverhuur#Id"" uuid,
858    ""Woningverhuur#ComponentId"" uuid,
859    ""Woningverhuur"" boolean,
860    ""9cSTu7fkjOZm08FFQUHvclQHSWY_"" boolean,
861    ""Goederenstroomadministratie#Id"" uuid,
862    ""Goederenstroomadministratie#ComponentId"" uuid,
863    ""Goederenstroomadministratie"" boolean,
864    ""IsConcurrent"" boolean,
865    ""Concurrent#Id"" uuid,
866    ""Concurrent#ComponentId"" uuid,
867    ""Concurrent"" boolean,
868    ""IsArbodienst"" boolean,
869    ""Arbodienst#Id"" uuid,
870    ""Arbodienst#ComponentId"" uuid,
871    ""Arbodienst"" boolean,
872    ""IsUitvoerderSociaalFonds"" boolean,
873    ""UitvoerderSociaalFonds#Id"" uuid,
874    ""UitvoerderSociaalFonds#ComponentId"" uuid,
875    ""UitvoerderSociaalFonds"" boolean,
876    ""IsPensioenuitvoerder"" boolean,
877    ""Pensioenuitvoerder#Id"" uuid,
878    ""Pensioenuitvoerder#ComponentId"" uuid,
879    ""Pensioenuitvoerder"" boolean,
880    ""IsProspect"" boolean,
881    ""Prospect#Id"" uuid,
882    ""Prospect#ComponentId"" uuid,
883    ""Prospect"" boolean,
884    ""IsProspectadministratie"" boolean,
885    ""Prospectadministratie#Id"" uuid,
886    ""Prospectadministratie#ComponentId"" uuid,
887    ""Prospectadministratie"" boolean,
888    ""IsArtikelbeheeradministratie"" boolean,
889    ""Artikelbeheeradministratie#Id"" uuid,
890    ""Artikelbeheeradministratie#ComponentId"" uuid,
891    ""Artikelbeheeradministratie"" boolean,
892    ""v1J4Rq2eNZy9GBvGhuCBKqga0Rg_"" boolean,
893    ""g4i3gYZGL0yu0T6UwmiZTaUDI8Y_#Id"" uuid,
894    ""g4i3gYZGL0yu0T6UwmiZTaUDI8Y_#ComponentId"" uuid,
895    ""g4i3gYZGL0yu0T6UwmiZTaUDI8Y_"" boolean,
896    ""IsSociaalFonds"" boolean,
897    ""SociaalFonds#Id"" uuid,
898    ""SociaalFonds#ComponentId"" uuid,
899    ""SociaalFonds"" boolean,
900    ""IsWagenparkadministratie"" boolean,
901    ""Wagenparkadministratie#Id"" uuid,
902    ""Wagenparkadministratie#ComponentId"" uuid,
903    ""Wagenparkadministratie"" boolean,
904    ""IsLeverancier"" boolean,
905    ""Leverancier#Id"" uuid,
906    ""Leverancier#ComponentId"" uuid,
907    ""Leverancier"" boolean,
908    ""IsWagenparkAfnemer"" boolean,
909    ""WagenparkAfnemer#Id"" uuid,
910    ""WagenparkAfnemer#ComponentId"" uuid,
911    ""WagenparkAfnemer"" boolean,
912    ""IsEvenementadministratie"" boolean,
913    ""Evenementadministratie#Id"" uuid,
914    ""Evenementadministratie#ComponentId"" uuid,
915    ""Evenementadministratie"" boolean,
916    ""IsCrediteur"" boolean,
917    ""Crediteur#Id"" uuid,
918    ""Crediteur#ComponentId"" uuid,
919    ""Crediteur"" boolean,
920    ""IsFinancieleAdministratie"" boolean,
921    ""FinancieleAdministratie#Id"" uuid,
922    ""FinancieleAdministratie#ComponentId"" uuid,
923    ""FinancieleAdministratie"" boolean,
924    ""IsSociaalSecretariaat"" boolean,
925    ""SociaalSecretariaat#Id"" uuid,
926    ""SociaalSecretariaat#ComponentId"" uuid,
927    ""SociaalSecretariaat"" boolean,
928    ""IsBank"" boolean,
929    ""Bank#Id"" uuid,
930    ""Bank#ComponentId"" uuid,
931    ""Bank"" boolean,
932    ""IsWerkgever"" boolean,
933    ""Werkgever#Id"" uuid,
934    ""Werkgever#ComponentId"" uuid,
935    ""Werkgever"" boolean,
936    ""IsVerkoopadministratie"" boolean,
937    ""Verkoopadministratie#Id"" uuid,
938    ""Verkoopadministratie#ComponentId"" uuid,
939    ""Verkoopadministratie"" boolean,
940    ""IsInkoopadministratie"" boolean,
941    ""Inkoopadministratie#Id"" uuid,
942    ""Inkoopadministratie#ComponentId"" uuid,
943    ""Inkoopadministratie"" boolean,
944    ""IsSubsidient"" boolean,
945    ""Subsidient#Id"" uuid,
946    ""Subsidient#ComponentId"" uuid,
947    ""Subsidient"" boolean,
948    ""IsEnqueteadministratie"" boolean,
949    ""Enqueteadministratie#Id"" uuid,
950    ""Enqueteadministratie#ComponentId"" uuid,
951    ""Enqueteadministratie"" boolean,
952    ""XWiQaVjEbD041r7QN0kj2aKeCys_"" boolean,
953    ""X_TVE5FRBaQ97JJQbT7LmX4HBVY_"" boolean,
954    ""BrancheDescription"" character varying(250),
955    ""AdresDescription"" character varying(250),
956    ""PicMWY7oCqeiZMTdDqwFqi1U508_"" character varying(250),
957    ""ProfitDescription"" character varying(100),
958    ""TaalDescription"" character varying(250),
959    ""PostadresDescription"" character varying(250),
960    ""TitelEnAanhefDescription"" character varying(250),
961    ""RechtsvormDescription"" character varying(250),
962    ""LandVanVestigingDescription"" character varying(250),
963    ""AangebrachtDoorDescription"" character varying(250),
964    ""KFEDo6ZYK_ffNCeHuujBCshlPVs_"" character varying(250),
965    ""VerantwoordelijkeDescription"" character varying(250),
966    ""FunctionalState"" integer,
967    ""KlantFinancieleAdministratie#Id"" uuid,
968    ""KlantFinancieleAdministratie#ComponentId"" uuid,
969    ""KlantFinancieleAdministratie"" boolean,
970    ""KlantVerkoopadministratie#Id"" uuid,
971    ""KlantVerkoopadministratie#ComponentId"" uuid,
972    ""KlantVerkoopadministratie"" boolean,
973    ""NQwaM_lfzxIm_JPrPhwruL0YOXY_#Id"" uuid,
974    ""NQwaM_lfzxIm_JPrPhwruL0YOXY_#ComponentId"" uuid,
975    ""NQwaM_lfzxIm_JPrPhwruL0YOXY_"" boolean,
976    ""uSf1yseW4YQ1K6EoHNlzCxPofm0_#Id"" uuid,
977    ""uSf1yseW4YQ1K6EoHNlzCxPofm0_#ComponentId"" uuid,
978    ""uSf1yseW4YQ1K6EoHNlzCxPofm0_"" boolean,
979    ""KlantEvenementadministratie#Id"" uuid,
980    ""KlantEvenementadministratie#ComponentId"" uuid,
981    ""KlantEvenementadministratie"" boolean,
982    ""KlantCursusadministratie#Id"" uuid,
983    ""KlantCursusadministratie#ComponentId"" uuid,
984    ""KlantCursusadministratie"" boolean,
985    ""KlantProspectadministratie#Id"" uuid,
986    ""KlantProspectadministratie#ComponentId"" uuid,
987    ""KlantProspectadministratie"" boolean,
988    ""KlantInkoopadministratie#Id"" uuid,
989    ""KlantInkoopadministratie#ComponentId"" uuid,
990    ""KlantInkoopadministratie"" boolean,
991    ""KlantProjectadministratie#Id"" uuid,
992    ""KlantProjectadministratie#ComponentId"" uuid,
993    ""KlantProjectadministratie"" boolean,
994    ""P0gBTGcrSbl2kK8BM4_24fIeMvk_#Id"" uuid,
995    ""P0gBTGcrSbl2kK8BM4_24fIeMvk_#ComponentId"" uuid,
996    ""P0gBTGcrSbl2kK8BM4_24fIeMvk_"" boolean,
997    ""KlantMain#Id"" uuid,
998    ""KlantMain#ComponentId"" uuid,
999    ""KlantMain"" boolean,
1000    ""8awXARDcCdVtrvN6IRlwAk5UcrI_#Id"" uuid,
1001    ""8awXARDcCdVtrvN6IRlwAk5UcrI_#ComponentId"" uuid,
1002    ""8awXARDcCdVtrvN6IRlwAk5UcrI_"" boolean,
1003    ""MjgFAhRfH64O3M9Ts_5b0ENQDBE_#Id"" uuid,
1004    ""MjgFAhRfH64O3M9Ts_5b0ENQDBE_#ComponentId"" uuid,
1005    ""MjgFAhRfH64O3M9Ts_5b0ENQDBE_"" boolean,
1006    ""LeverancierMain#Id"" uuid,
1007    ""LeverancierMain#ComponentId"" uuid,
1008    ""LeverancierMain"" boolean,
1009    ""2CaNQvGgtPNHP2XCsoKBQEpwmYA_#Id"" uuid,
1010    ""2CaNQvGgtPNHP2XCsoKBQEpwmYA_#ComponentId"" uuid,
1011    ""2CaNQvGgtPNHP2XCsoKBQEpwmYA_"" boolean,
1012    ""kleo39GG1utTUtP0F15mWkXZBFQ_#Id"" uuid,
1013    ""kleo39GG1utTUtP0F15mWkXZBFQ_#ComponentId"" uuid,
1014    ""kleo39GG1utTUtP0F15mWkXZBFQ_"" boolean,
1015    ""d9jEYARbghWBrZU6jKbtZPyZUAk_#Id"" uuid,
1016    ""d9jEYARbghWBrZU6jKbtZPyZUAk_#ComponentId"" uuid,
1017    ""d9jEYARbghWBrZU6jKbtZPyZUAk_"" boolean,
1018    ""CrediteurMain#Id"" uuid,
1019    ""CrediteurMain#ComponentId"" uuid,
1020    ""CrediteurMain"" boolean,
1021    CONSTRAINT ""pk_OrganisatieQmo_Organisatie_QueryModelObjects_Imp"" PRIMARY KEY (""Id"")
1022  )";
1023      #endregion Bug1285
1024      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2849")]
1025      public async Task Chunked_string_write_buffer_encoding_space()
1026      {
1027          await using var dataSource = CreateDataSource(csb => csb.WriteBufferSize = 8192);
1028          await using var conn = await dataSource.OpenConnectionAsync();
1029          var tableName = await CreateTempTable(conn, "col1 text, col2 text");
1030          await using var binaryImporter = await conn.BeginBinaryImportAsync($"COPY {tableName} FROM STDIN (FORMAT BINARY);");
1031          await binaryImporter.StartRowAsync();
1032          var almostBufferFillingString = new string('a', 8152);
1033          await binaryImporter.WriteAsync(almostBufferFillingString, NpgsqlDbType.Text);
1034          var unicodeCharacterThatEncodesToThreeBytesInUtf8 = '\uD55C';
1035          var longStringStartingWithAforementionedUnicodeCharacter = unicodeCharacterThatEncodesToThreeBytesInUtf8 + new string('a', 10000);
1036          await binaryImporter.WriteAsync(longStringStartingWithAforementionedUnicodeCharacter, NpgsqlDbType.Text);
1037          await binaryImporter.CompleteAsync();
1038      }
1039      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2849")]
1040      public async Task Chunked_char_array_write_buffer_encoding_space()
1041      {
1042          await using var dataSource = CreateDataSource(csb => csb.WriteBufferSize = 8192);
1043          await using var conn = await dataSource.OpenConnectionAsync();
1044          var tableName = await CreateTempTable(conn, "col1 text, col2 text");
1045          await using var binaryImporter = await conn.BeginBinaryImportAsync($"COPY {tableName} FROM STDIN (FORMAT BINARY);");
1046          await binaryImporter.StartRowAsync();
1047          var almostBufferFillingString = new string('a', 8152);
1048          await binaryImporter.WriteAsync(almostBufferFillingString, NpgsqlDbType.Text);
1049          var unicodeCharacterThatEncodesToThreeBytesInUtf8 = '\uD55C';
1050          var longStringStartingWithAforementionedUnicodeCharacter = unicodeCharacterThatEncodesToThreeBytesInUtf8 + new string('a', 10000);
1051          await binaryImporter.WriteAsync(longStringStartingWithAforementionedUnicodeCharacter.ToCharArray(), NpgsqlDbType.Text);
1052          await binaryImporter.CompleteAsync();
1053      }
1054      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2371")]
1055      public async Task NRE_in_BeginTextExport()
1056      {
1057          await using var conn = await OpenConnectionAsync();
1058          var funcName = await GetTempFunctionName(conn);
1059          await using var transaction = await conn.BeginTransactionAsync();
1060          await conn.ExecuteNonQueryAsync($"CREATE OR REPLACE FUNCTION {funcName}() RETURNS TABLE (i INT) AS $$ BEGIN RETURN QUERY SELECT s.a FROM pg_stat_activity p; end; $$ LANGUAGE plpgsql;");
1061          using var reader = await conn.BeginTextExportAsync($"copy (select * FROM {funcName}())  TO STDOUT WITH (format csv)");
1062          Assert.That(() => reader.ReadLine(), Throws.Exception
1063              .TypeOf<PostgresException>()
1064              .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.UndefinedTable)
1065          );
1066      }
1067      public enum TestEnum
1068      {
1069          One,
1070          Two
1071      }
1072      class SomeComposite
1073      {
1074          public TestEnum Test { get; set; }
1075          public int X { get; set; }
1076          public string SomeText { get; set; } = "";
1077      }
1078      [Test]
1079      public async Task CompositePostgresType()
1080      {
1081          await using var adminConnection = await OpenConnectionAsync();
1082          var type = await GetTempTypeName(adminConnection);
1083          var func = await GetTempFunctionName(adminConnection);
1084          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} as (x int, some_text text, test int)");
1085          var dataSourceBuilder = CreateDataSourceBuilder();
1086          dataSourceBuilder.MapComposite<SomeComposite>(type);
1087          await using var dataSource = dataSourceBuilder.Build();
1088          await using var connection = await dataSource.OpenConnectionAsync();
1089          await connection.ExecuteNonQueryAsync(@$"
1090  CREATE OR REPLACE FUNCTION {func}(id int, out comp1 {type}, OUT comp2 {type}[])
1091  LANGUAGE plpgsql AS
1092  $$
1093  BEGIN
1094      comp1 = ROW(9, 'bar', 1)::{type};
1095      comp2 = ARRAY[ROW(9, 'bar', 1)::{type}];
1096  END;
1097  $$;");
1098          Assert.ThrowsAsync<InvalidCastException>(async () => await connection.ExecuteScalarAsync($"SELECT {func}(0)"));
1099      }
1100      [Test]
1101      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3117")]
1102      public void Bug3117()
1103      {
1104          const string OkCommand = "SELECT 1";
1105          const string ErrorCommand = "SELECT * FROM public.imnotexist";
1106          using var dataSource = CreateDataSource();
1107          using (var conn = dataSource.OpenConnection())
1108          {
1109              var okCommand = new NpgsqlCommand(OkCommand, conn);
1110              okCommand.Prepare();
1111              using (okCommand.ExecuteReader()) { }
1112              var errorCommand = new NpgsqlCommand(ErrorCommand, conn);
1113              Assert.That(() => errorCommand.Prepare(), Throws.Exception
1114                  .TypeOf<PostgresException>()
1115                  .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.UndefinedTable));
1116          }
1117          using (var conn = dataSource.OpenConnection())
1118          {
1119              var okCommand = new NpgsqlCommand(OkCommand, conn);
1120              okCommand.Prepare();
1121              using (okCommand.ExecuteReader()) { }
1122          }
1123      }
1124      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3209")]
1125      public async Task Bug3209()
1126      {
1127          await using var conn = CreateConnection();
1128          await conn.CloseAsync();
1129          await conn.OpenAsync();
1130          await conn.CloseAsync();
1131          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
1132      }
1133      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3373")]
1134      public async Task Bug3373()
1135      {
1136          await using var conn = await OpenConnectionAsync();
1137          using var cmd = conn.CreateCommand();
1138          cmd.CommandText = "SELECT repeat('1', 10000); SELECT * from pg_sleep(3)";
1139          cmd.CommandTimeout = 0;
1140          await using var reader = await cmd.ExecuteReaderAsync();
1141          Assert.DoesNotThrowAsync(async () => await reader.NextResultAsync());
1142      }
1143      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3649")]
1144      public async Task Bug3649()
1145      {
1146          await using var conn = await OpenConnectionAsync();
1147          var table = await CreateTempTable(conn, "value integer");
1148          using (var importer = await conn.BeginBinaryImportAsync($"COPY {table} (value) FROM STDIN (FORMAT binary)"))
1149          {
1150              await importer.StartRowAsync();
1151              await importer.WriteAsync(DBNull.Value, NpgsqlDbType.Integer);
1152              await importer.StartRowAsync();
1153              await importer.WriteAsync(1, NpgsqlDbType.Integer);
1154              await importer.StartRowAsync();
1155              await importer.WriteAsync(2, NpgsqlDbType.Integer);
1156              await importer.CompleteAsync();
1157          }
1158          using (var exporter = await conn.BeginBinaryExportAsync($"COPY {table} (value) TO STDIN (FORMAT binary)"))
1159          {
1160              await exporter.StartRowAsync();
1161              Assert.IsTrue(exporter.IsNull);
1162              await exporter.SkipAsync();
1163              await exporter.StartRowAsync();
1164              Assert.AreEqual(1, await exporter.ReadAsync<int?>());
1165              await exporter.StartRowAsync();
1166              Assert.AreEqual(2, await exporter.ReadAsync<int?>());
1167          }
1168      }
1169      [Test]
1170      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3839")]
1171      public async Task SingleThreadedSynchronizationContext_deadlock()
1172      {
1173          var syncContext = new SingleThreadSynchronizationContext(nameof(SingleThreadedSynchronizationContext_deadlock));
1174          using (var _ = syncContext.Enter())
1175          {
1176              await Task.Yield();
1177              using var connection = OpenConnection();
1178              var data = new string('x', 5_000_000);
1179              using var cmd = new NpgsqlCommand("SELECT generate_series(1, 500000); SELECT @p", connection);
1180              cmd.Parameters.AddWithValue("p", NpgsqlDbType.Text, data);
1181              cmd.ExecuteNonQuery();
1182          }
1183          await Task.Yield();
1184      }
1185      [Test]
1186      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3924")]
1187      public async Task Bug3924()
1188      {
1189          var csb = new NpgsqlConnectionStringBuilder(ConnectionString)
1190          {
1191              CommandTimeout = 10,
1192              KeepAlive = 5,
1193          };
1194          await using var postmaster = PgPostmasterMock.Start(csb.ConnectionString);
1195          await using var dataSource = CreateDataSource(postmaster.ConnectionString);
1196          await using var conn = await dataSource.OpenConnectionAsync();
1197          var serverMock = await postmaster.WaitForServerConnection();
1198          using (var cmd = conn.CreateCommand())
1199          {
1200              cmd.CommandTimeout = 1;
1201              cmd.CommandText = "SELECT 1";
1202              var queryTask = cmd.ExecuteNonQueryAsync();
1203              await serverMock.ExpectExtendedQuery();
1204              _ = serverMock.WriteScalarResponseAndFlush(1);
1205              await queryTask;
1206          }
1207          await serverMock.ExpectMessage(FrontendMessageCode.Sync);
1208          await Task.Delay(1000);
1209          _ = serverMock.WriteReadyForQuery().FlushAsync();
1210          using (var cmd = conn.CreateCommand())
1211          {
1212              cmd.CommandTimeout = 1;
1213              cmd.CommandText = "SELECT 1";
1214              var queryTask = cmd.ExecuteNonQueryAsync();
1215              await serverMock.ExpectExtendedQuery();
1216              _ = serverMock.WriteScalarResponseAndFlush(1);
1217              Assert.DoesNotThrowAsync(async () => await queryTask);
1218          }
1219      }
1220      [Test]
1221      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4099")]
1222      public async Task Bug4099()
1223      {
1224          var csb = new NpgsqlConnectionStringBuilder(ConnectionString)
1225          {
1226              Multiplexing = true,
1227              MaxPoolSize = 1
1228          };
1229          await using var postmaster = PgPostmasterMock.Start(csb.ConnectionString);
1230          await using var dataSource = CreateDataSource(postmaster.ConnectionString);
1231          await using var firstConn = await dataSource.OpenConnectionAsync();
1232          await using var secondConn = await dataSource.OpenConnectionAsync();
1233          var firstQuery = firstConn.ExecuteScalarAsync("SELECT data");
1234          var server = await postmaster.WaitForServerConnection();
1235          await server.ExpectExtendedQuery();
1236          var secondQuery = secondConn.ExecuteScalarAsync("SELECT other_data");
1237          await server.ExpectExtendedQuery();
1238          var data = new byte[10000];
1239          await server
1240              .WriteParseComplete()
1241              .WriteBindComplete()
1242              .WriteRowDescription(new FieldDescription(PostgresTypeOIDs.Bytea))
1243              .WriteDataRowWithFlush(data);
1244          var otherData = new byte[10];
1245          await server
1246              .WriteCommandComplete()
1247              .WriteReadyForQuery()
1248              .WriteParseComplete()
1249              .WriteBindComplete()
1250              .WriteRowDescription(new FieldDescription(PostgresTypeOIDs.Bytea))
1251              .WriteDataRow(otherData)
1252              .WriteCommandComplete()
1253              .WriteReadyForQuery()
1254              .FlushAsync();
1255          Assert.That(data, Is.EquivalentTo((byte[])(await firstQuery)!));
1256          Assert.That(otherData, Is.EquivalentTo((byte[])(await secondQuery)!));
1257      }
1258      [Test]
1259      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4123")]
1260      public async Task Bug4123()
1261      {
1262          await using var conn = await OpenConnectionAsync();
1263          await using var cmd = new NpgsqlCommand("SELECT 1", conn);
1264          await using var rdr = await cmd.ExecuteReaderAsync();
1265          await rdr.ReadAsync();
1266          await using var stream = await rdr.GetStreamAsync(0);
1267          Assert.DoesNotThrowAsync(stream.FlushAsync);
1268          Assert.DoesNotThrow(stream.Flush);
1269      }
1270  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-MiscTypeTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-BugTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>200          Assert.That(reader.GetInt32(0), Is.EqualTo(8));
201      }
</pre></code></div>
                <div class="column column_space"><pre><code>231          Assert.That(reader.GetInt32(0), Is.EqualTo(8));
232      }
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    