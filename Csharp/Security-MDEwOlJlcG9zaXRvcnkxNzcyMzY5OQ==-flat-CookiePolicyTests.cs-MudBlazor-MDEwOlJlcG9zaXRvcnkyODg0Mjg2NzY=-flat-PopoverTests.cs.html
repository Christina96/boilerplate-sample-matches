
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 14.241960183767228%, Tokens: 13, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-CookiePolicyTests.cs</h3>
            <pre><code>1  using System;
2  using System.Security.Claims;
3  using System.Security.Principal;
4  using System.Threading.Tasks;
5  using Microsoft.AspNetCore.Authentication;
6  using Microsoft.AspNetCore.Authentication.Cookies;
7  using Microsoft.AspNetCore.Builder;
8  using Microsoft.AspNetCore.Hosting;
9  using Microsoft.AspNetCore.Http;
10  using Microsoft.AspNetCore.Http.Features;
11  using Microsoft.AspNetCore.TestHost;
12  using Microsoft.Extensions.DependencyInjection;
13  using Microsoft.Net.Http.Headers;
14  using Xunit;
15  namespace Microsoft.AspNetCore.CookiePolicy.Test
16  {
17      public class CookiePolicyTests
18      {
19          private RequestDelegate SecureCookieAppends = context =>
20          {
21              context.Response.Cookies.Append("A", "A");
22              context.Response.Cookies.Append("B", "B", new CookieOptions { Secure = false });
23              context.Response.Cookies.Append("C", "C", new CookieOptions());
24              context.Response.Cookies.Append("D", "D", new CookieOptions { Secure = true });
25              return Task.FromResult(0);
26          };
27          private RequestDelegate HttpCookieAppends = context =>
28          {
29              context.Response.Cookies.Append("A", "A");
30              context.Response.Cookies.Append("B", "B", new CookieOptions { HttpOnly = false });
31              context.Response.Cookies.Append("C", "C", new CookieOptions());
32              context.Response.Cookies.Append("D", "D", new CookieOptions { HttpOnly = true });
33              return Task.FromResult(0);
34          };
35          private RequestDelegate SameSiteCookieAppends = context =>
36          {
37              context.Response.Cookies.Append("A", "A");
38              context.Response.Cookies.Append("B", "B", new CookieOptions { SameSite = Http.SameSiteMode.None });
39              context.Response.Cookies.Append("C", "C", new CookieOptions());
40              context.Response.Cookies.Append("D", "D", new CookieOptions { SameSite = Http.SameSiteMode.Lax });
41              context.Response.Cookies.Append("E", "E", new CookieOptions { SameSite = Http.SameSiteMode.Strict });
42              return Task.FromResult(0);
43          };
44          [Fact]
45          public async Task SecureAlwaysSetsSecure()
46          {
47              await RunTest("/secureAlways",
48                  new CookiePolicyOptions
49                  {
50                      Secure = CookieSecurePolicy.Always
51                  },
52                  SecureCookieAppends,
53                  new RequestTest("http:&bsol;&bsol;example.com/secureAlways",
54                      transaction =>
55                      {
56                          Assert.NotNull(transaction.SetCookie);
57                          Assert.Equal("A=A; path=/; secure; samesite=lax", transaction.SetCookie[0]);
58                          Assert.Equal("B=B; path=/; secure; samesite=lax", transaction.SetCookie[1]);
59                          Assert.Equal("C=C; path=/; secure; samesite=lax", transaction.SetCookie[2]);
60                          Assert.Equal("D=D; path=/; secure; samesite=lax", transaction.SetCookie[3]);
61                      }));
62          }
63          [Fact]
64          public async Task SecureNoneLeavesSecureUnchanged()
65          {
66              await RunTest("/secureNone",
67                  new CookiePolicyOptions
68                  {
69                      Secure = CookieSecurePolicy.None
70                  },
71                  SecureCookieAppends,
72                  new RequestTest("http:&bsol;&bsol;example.com/secureNone",
73                      transaction =>
74                      {
75                          Assert.NotNull(transaction.SetCookie);
76                          Assert.Equal("A=A; path=/; samesite=lax", transaction.SetCookie[0]);
77                          Assert.Equal("B=B; path=/; samesite=lax", transaction.SetCookie[1]);
78                          Assert.Equal("C=C; path=/; samesite=lax", transaction.SetCookie[2]);
79                          Assert.Equal("D=D; path=/; secure; samesite=lax", transaction.SetCookie[3]);
80                      }));
81          }
82          [Fact]
83          public async Task SecureSameUsesRequest()
84          {
85              await RunTest("/secureSame",
86                  new CookiePolicyOptions
87                  {
88                      Secure = CookieSecurePolicy.SameAsRequest
89                  },
90                  SecureCookieAppends,
91                  new RequestTest("http:&bsol;&bsol;example.com/secureSame",
92                      transaction =>
93                      {
94                          Assert.NotNull(transaction.SetCookie);
95                          Assert.Equal("A=A; path=/; samesite=lax", transaction.SetCookie[0]);
96                          Assert.Equal("B=B; path=/; samesite=lax", transaction.SetCookie[1]);
97                          Assert.Equal("C=C; path=/; samesite=lax", transaction.SetCookie[2]);
98                          Assert.Equal("D=D; path=/; secure; samesite=lax", transaction.SetCookie[3]);
99                      }),
100                  new RequestTest("https:&bsol;&bsol;example.com/secureSame",
101                      transaction =>
102                      {
103                          Assert.NotNull(transaction.SetCookie);
104                          Assert.Equal("A=A; path=/; secure; samesite=lax", transaction.SetCookie[0]);
105                          Assert.Equal("B=B; path=/; secure; samesite=lax", transaction.SetCookie[1]);
106                          Assert.Equal("C=C; path=/; secure; samesite=lax", transaction.SetCookie[2]);
107                          Assert.Equal("D=D; path=/; secure; samesite=lax", transaction.SetCookie[3]);
108                      }));
109          }
110          [Fact]
111          public async Task HttpOnlyAlwaysSetsItAlways()
112          {
113              await RunTest("/httpOnlyAlways",
114                  new CookiePolicyOptions
115                  {
116                      HttpOnly = HttpOnlyPolicy.Always
117                  },
118                  HttpCookieAppends,
119                  new RequestTest("http:&bsol;&bsol;example.com/httpOnlyAlways",
120                  transaction =>
121                  {
122                      Assert.NotNull(transaction.SetCookie);
123                      Assert.Equal("A=A; path=/; samesite=lax; httponly", transaction.SetCookie[0]);
124                      Assert.Equal("B=B; path=/; samesite=lax; httponly", transaction.SetCookie[1]);
125                      Assert.Equal("C=C; path=/; samesite=lax; httponly", transaction.SetCookie[2]);
126                      Assert.Equal("D=D; path=/; samesite=lax; httponly", transaction.SetCookie[3]);
127                  }));
128          }
129          [Fact]
130          public async Task HttpOnlyNoneLeavesItAlone()
131          {
132              await RunTest("/httpOnlyNone",
133                  new CookiePolicyOptions
134                  {
135                      HttpOnly = HttpOnlyPolicy.None
136                  },
137                  HttpCookieAppends,
138                  new RequestTest("http:&bsol;&bsol;example.com/httpOnlyNone",
139                  transaction =>
140                  {
141                      Assert.NotNull(transaction.SetCookie);
142                      Assert.Equal("A=A; path=/; samesite=lax", transaction.SetCookie[0]);
143                      Assert.Equal("B=B; path=/; samesite=lax", transaction.SetCookie[1]);
144                      Assert.Equal("C=C; path=/; samesite=lax", transaction.SetCookie[2]);
145                      Assert.Equal("D=D; path=/; samesite=lax; httponly", transaction.SetCookie[3]);
146                  }));
147          }
148          [Fact]
149          public async Task SameSiteStrictSetsItAlways()
150          {
151              await RunTest("/sameSiteStrict",
152                  new CookiePolicyOptions
153                  {
154                      MinimumSameSitePolicy = Http.SameSiteMode.Strict
155                  },
156                  SameSiteCookieAppends,
157                  new RequestTest("http:&bsol;&bsol;example.com/sameSiteStrict",
158                  transaction =>
159                  {
160                      Assert.NotNull(transaction.SetCookie);
161                      Assert.Equal("A=A; path=/; samesite=strict", transaction.SetCookie[0]);
162                      Assert.Equal("B=B; path=/; samesite=strict", transaction.SetCookie[1]);
163                      Assert.Equal("C=C; path=/; samesite=strict", transaction.SetCookie[2]);
164                      Assert.Equal("D=D; path=/; samesite=strict", transaction.SetCookie[3]);
165                      Assert.Equal("E=E; path=/; samesite=strict", transaction.SetCookie[4]);
166                  }));
167          }
168          [Fact]
169          public async Task SameSiteLaxSetsItAlways()
170          {
171              await RunTest("/sameSiteLax",
172                  new CookiePolicyOptions
173                  {
174                      MinimumSameSitePolicy = Http.SameSiteMode.Lax
175                  },
176                  SameSiteCookieAppends,
177                  new RequestTest("http:&bsol;&bsol;example.com/sameSiteLax",
178                  transaction =>
179                  {
180                      Assert.NotNull(transaction.SetCookie);
181                      Assert.Equal("A=A; path=/; samesite=lax", transaction.SetCookie[0]);
182                      Assert.Equal("B=B; path=/; samesite=lax", transaction.SetCookie[1]);
183                      Assert.Equal("C=C; path=/; samesite=lax", transaction.SetCookie[2]);
184                      Assert.Equal("D=D; path=/; samesite=lax", transaction.SetCookie[3]);
185                      Assert.Equal("E=E; path=/; samesite=strict", transaction.SetCookie[4]);
186                  }));
187          }
188          [Fact]
189          public async Task SameSiteNoneLeavesItAlone()
190          {
191              await RunTest("/sameSiteNone",
192                  new CookiePolicyOptions
193                  {
194                      MinimumSameSitePolicy = Http.SameSiteMode.None
195                  },
196                  SameSiteCookieAppends,
197                  new RequestTest("http:&bsol;&bsol;example.com/sameSiteNone",
198                  transaction =>
199                  {
<span onclick='openModal()' class='match'>200                      Assert.NotNull(transaction.SetCookie);
201                      Assert.Equal("A=A; path=/", transaction.SetCookie[0]);
202                      Assert.Equal("B=B; path=/", transaction.SetCookie[1]);
203                      Assert.Equal("C=C; path=/; samesite=lax", transaction.SetCookie[2]);
204                      Assert.Equal("D=D; path=/; samesite=lax", transaction.SetCookie[3]);
205                      Assert.Equal("E=E; path=/; samesite=strict", transaction.SetCookie[4]);
206                  }));
207          }
208          [Fact]
209          public async Task CookiePolicyCanHijackAppend()
210          {
211              var builder = new WebHostBuilder()
212                  .Configure(app =>
213                  {
214                      app.UseCookiePolicy(new CookiePolicyOptions
</span>215                      {
216                          OnAppendCookie = ctx => ctx.CookieName = ctx.CookieValue = "Hao"
217                      });
218                      app.Run(context =>
219                      {
220                          context.Response.Cookies.Append("A", "A");
221                          context.Response.Cookies.Append("B", "B", new CookieOptions { Secure = false });
222                          context.Response.Cookies.Append("C", "C", new CookieOptions());
223                          context.Response.Cookies.Append("D", "D", new CookieOptions { Secure = true });
224                          return Task.FromResult(0);
225                      });
226                  });
227              var server = new TestServer(builder);
228              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/login");
229              Assert.NotNull(transaction.SetCookie);
230              Assert.Equal("Hao=Hao; path=/; samesite=lax", transaction.SetCookie[0]);
231              Assert.Equal("Hao=Hao; path=/; samesite=lax", transaction.SetCookie[1]);
232              Assert.Equal("Hao=Hao; path=/; samesite=lax", transaction.SetCookie[2]);
233              Assert.Equal("Hao=Hao; path=/; secure; samesite=lax", transaction.SetCookie[3]);
234          }
235          [Fact]
236          public async Task CookiePolicyCanHijackDelete()
237          {
238              var builder = new WebHostBuilder()
239                  .Configure(app =>
240              {
241                  app.UseCookiePolicy(new CookiePolicyOptions
242                  {
243                      OnDeleteCookie = ctx => ctx.CookieName = "A"
244                  });
245                  app.Run(context =>
246                  {
247                      context.Response.Cookies.Delete("A");
248                      context.Response.Cookies.Delete("B", new CookieOptions { Secure = false });
249                      context.Response.Cookies.Delete("C", new CookieOptions());
250                      context.Response.Cookies.Delete("D", new CookieOptions { Secure = true });
251                      return Task.FromResult(0);
252                  });
253              });
254              var server = new TestServer(builder);
255              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/login");
256              Assert.NotNull(transaction.SetCookie);
257              Assert.Equal(1, transaction.SetCookie.Count);
258              Assert.Equal("A=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; secure; samesite=lax", transaction.SetCookie[0]);
259          }
260          [Fact]
261          public async Task CookiePolicyCallsCookieFeature()
262          {
263              var builder = new WebHostBuilder()
264                  .Configure(app =>
265              {
266                  app.Use(next => context =>
267                  {
268                      context.Features.Set<IResponseCookiesFeature>(new TestCookieFeature());
269                      return next(context);
270                  });
271                  app.UseCookiePolicy(new CookiePolicyOptions
272                  {
273                      OnDeleteCookie = ctx => ctx.CookieName = "A"
274                  });
275                  app.Run(context =>
276                  {
277                      Assert.Throws<NotImplementedException>(() => context.Response.Cookies.Delete("A"));
278                      Assert.Throws<NotImplementedException>(() => context.Response.Cookies.Delete("A", new CookieOptions()));
279                      Assert.Throws<NotImplementedException>(() => context.Response.Cookies.Append("A", "A"));
280                      Assert.Throws<NotImplementedException>(() => context.Response.Cookies.Append("A", "A", new CookieOptions()));
281                      return context.Response.WriteAsync("Done");
282                  });
283              });
284              var server = new TestServer(builder);
285              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/login");
286              Assert.Equal("Done", transaction.ResponseText);
287          }
288          [Fact]
289          public async Task CookiePolicyAppliesToCookieAuth()
290          {
291              var builder = new WebHostBuilder()
292                  .ConfigureServices(services =>
293                  {
294                      services.AddAuthentication().AddCookie(o =>
295                      {
296                          o.Cookie.Name = "TestCookie";
297                          o.Cookie.HttpOnly = false;
298                          o.Cookie.SecurePolicy = CookieSecurePolicy.None;
299                      });
300                  })
301                  .Configure(app =>
302                  {
303                      app.UseCookiePolicy(new CookiePolicyOptions
304                      {
305                          HttpOnly = HttpOnlyPolicy.Always,
306                          Secure = CookieSecurePolicy.Always,
307                      });
308                      app.UseAuthentication();
309                      app.Run(context =>
310                      {
311                          return context.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme,
312                              new ClaimsPrincipal(new ClaimsIdentity(new GenericIdentity("TestUser", "Cookies"))));
313                      });
314                  });
315              var server = new TestServer(builder);
316              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/login");
317              Assert.NotNull(transaction.SetCookie);
318              Assert.Equal(1, transaction.SetCookie.Count);
319              var cookie = SetCookieHeaderValue.Parse(transaction.SetCookie[0]);
320              Assert.Equal("TestCookie", cookie.Name);
321              Assert.True(cookie.HttpOnly);
322              Assert.True(cookie.Secure);
323              Assert.Equal("/", cookie.Path);
324          }
325          [Fact]
326          public async Task CookiePolicyAppliesToCookieAuthChunks()
327          {
328              var builder = new WebHostBuilder()
329                  .ConfigureServices(services =>
330                  {
331                      services.AddAuthentication().AddCookie(o =>
332                      {
333                          o.Cookie.Name = "TestCookie";
334                          o.Cookie.HttpOnly = false;
335                          o.Cookie.SecurePolicy = CookieSecurePolicy.None;
336                      });
337                  })
338                  .Configure(app =>
339                  {
340                      app.UseCookiePolicy(new CookiePolicyOptions
341                      {
342                          HttpOnly = HttpOnlyPolicy.Always,
343                          Secure = CookieSecurePolicy.Always,
344                      });
345                      app.UseAuthentication();
346                      app.Run(context =>
347                      {
348                          return context.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme,
349                              new ClaimsPrincipal(new ClaimsIdentity(new GenericIdentity(new string('c', 1024 * 5), "Cookies"))));
350                      });
351                  });
352              var server = new TestServer(builder);
353              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/login");
354              Assert.NotNull(transaction.SetCookie);
355              Assert.Equal(3, transaction.SetCookie.Count);
356              var cookie = SetCookieHeaderValue.Parse(transaction.SetCookie[0]);
357              Assert.Equal("TestCookie", cookie.Name);
358              Assert.Equal("chunks-2", cookie.Value);
359              Assert.True(cookie.HttpOnly);
360              Assert.True(cookie.Secure);
361              Assert.Equal("/", cookie.Path);
362              cookie = SetCookieHeaderValue.Parse(transaction.SetCookie[1]);
363              Assert.Equal("TestCookieC1", cookie.Name);
364              Assert.True(cookie.HttpOnly);
365              Assert.True(cookie.Secure);
366              Assert.Equal("/", cookie.Path);
367              cookie = SetCookieHeaderValue.Parse(transaction.SetCookie[2]);
368              Assert.Equal("TestCookieC2", cookie.Name);
369              Assert.True(cookie.HttpOnly);
370              Assert.True(cookie.Secure);
371              Assert.Equal("/", cookie.Path);
372          }
373          private class TestCookieFeature : IResponseCookiesFeature
374          {
375              public IResponseCookies Cookies { get; } = new BadCookies();
376              private class BadCookies : IResponseCookies
377              {
378                  public void Append(string key, string value)
379                  {
380                      throw new NotImplementedException();
381                  }
382                  public void Append(string key, string value, CookieOptions options)
383                  {
384                      throw new NotImplementedException();
385                  }
386                  public void Delete(string key)
387                  {
388                      throw new NotImplementedException();
389                  }
390                  public void Delete(string key, CookieOptions options)
391                  {
392                      throw new NotImplementedException();
393                  }
394              }
395          }
396          private class RequestTest
397          {
398              public RequestTest(string testUri, Action<Transaction> verify)
399              {
400                  TestUri = testUri;
401                  Verification = verify;
402              }
403              public async Task Execute(TestServer server)
404              {
405                  var transaction = await server.SendAsync(TestUri);
406                  Verification(transaction);
407              }
408              public string TestUri { get; set; }
409              public Action<Transaction> Verification { get; set; }
410          }
411          private async Task RunTest(
412              string path,
413              CookiePolicyOptions cookiePolicy,
414              RequestDelegate configureSetup,
415              params RequestTest[] tests)
416          {
417              var builder = new WebHostBuilder()
418                  .Configure(app =>
419                  {
420                      app.Map(path, map =>
421                      {
422                          map.UseCookiePolicy(cookiePolicy);
423                          map.Run(configureSetup);
424                      });
425                  });
426              var server = new TestServer(builder);
427              foreach (var test in tests)
428              {
429                  await test.Execute(server);
430              }
431          }
432      }
433  }
</code></pre>
        </div>
        <div class="column">
            <h3>MudBlazor-MDEwOlJlcG9zaXRvcnkyODg0Mjg2NzY=-flat-PopoverTests.cs</h3>
            <pre><code>1  #pragma warning disable CS1998 
2  using System;
3  using System.Collections.Generic;
4  using System.Threading;
5  using System.Threading.Tasks;
6  using Bunit;
7  using FluentAssertions;
8  using Microsoft.AspNetCore.Components;
9  using Microsoft.AspNetCore.Components.Rendering;
10  using Microsoft.Extensions.DependencyInjection;
11  using Microsoft.Extensions.Options;
12  using Microsoft.JSInterop;
13  using Microsoft.JSInterop.Infrastructure;
14  using Moq;
15  using MudBlazor.UnitTests.TestComponents;
16  using MudBlazor.UnitTests.TestComponents.Popover;
17  using NUnit.Framework;
18  using static Bunit.ComponentParameterFactory;
19  namespace MudBlazor.UnitTests.Components
20  {
21      [TestFixture]
22      public class PopoverTests : BunitTest
23      {
24          [Test]
25          public void PopoverOptions_Defaults()
26          {
27              var options = new PopoverOptions();
28              options.ContainerClass.Should().Be("mudblazor-main-content");
29              options.FlipMargin.Should().Be(0);
30              options.ThrowOnDuplicateProvider.Should().Be(true);
31          }
32          [Test]
33          public void MudPopoverHandler_Constructor()
34          {
35              RenderFragment renderFragement = (tree) => { };
36              var mock = Mock.Of<IJSRuntime>();
37              Action updater = () => { };
38              var handler = new MudPopoverHandler(renderFragement, mock, updater);
39              handler.Id.Should().NotBe(default(Guid));
40              handler.UserAttributes.Should().BeEmpty();
41              handler.Class.Should().BeNull();
42              handler.Tag.Should().BeNull();
43              handler.Fragment.Should().BeSameAs(renderFragement);
44              handler.IsConnected.Should().BeFalse();
45              handler.ShowContent.Should().BeFalse();
46          }
47          [Test]
48          public void MudPopoverHandler_PreventNullValuesInConstructor()
49          {
50              RenderFragment renderFragement = (tree) => { };
51              var mock = Mock.Of<IJSRuntime>();
52              Action updater = () => { };
53              Assert.Throws<ArgumentNullException>(() => new MudPopoverHandler(null, mock, updater));
54              Assert.Throws<ArgumentNullException>(() => new MudPopoverHandler(renderFragement, null, updater));
55              Assert.Throws<ArgumentNullException>(() => new MudPopoverHandler(renderFragement, mock, null));
56          }
57          [Test]
58          public void MudPopoverHandler_SetComponentBaseParameters()
59          {
60              RenderFragment renderFragement = (tree) => { };
61              var mock = Mock.Of<IJSRuntime>();
62              Action updater = () => { };
63              var handler = new MudPopoverHandler(renderFragement, mock, updater);
64              var comp = Context.RenderComponent<MudBadge>(p =>
65              {
66                  p.Add(x => x.UserAttributes, new Dictionary<string, object> { { "myprop1", "myValue1" } });
67                  p.Add(x => x.Tag, "my tag");
68              });
69              handler.SetComponentBaseParameters(comp.Instance, "my-extra-class", "my-extra-style:2px", true);
70              handler.Id.Should().NotBe(default(Guid));
71              handler.UserAttributes.Should().BeEquivalentTo(new Dictionary<string, object> { { "myprop1", "myValue1" } });
72              handler.Class.Should().Be("my-extra-class");
73              handler.Tag.Should().Be("my tag");
74              handler.Fragment.Should().BeSameAs(renderFragement);
75              handler.IsConnected.Should().BeFalse();
76              handler.ShowContent.Should().BeTrue();
77          }
78          [Test(Description = "Remove in v7")]
79          public void MudPopoverHandler_UpdateFragment()
80          {
81              RenderFragment initialRenderFragement = (tree) => { };
82              var mock = Mock.Of<IJSRuntime>();
83              var updateCounter = 0;
84              Action updater = () => { updateCounter++; };
85              var handler = new MudPopoverHandler(initialRenderFragement, mock, updater);
86              var comp = Context.RenderComponent<MudBadge>(p =>
87              {
88                  p.Add(x => x.UserAttributes, new Dictionary<string, object> { { "myprop1", "myValue1" } });
89                  p.Add(x => x.Tag, "my tag");
90              });
91              RenderFragment newRenderFragement = (tree) => { };
92              handler.UpdateFragment(newRenderFragement, comp.Instance, "my-extra-class", "my-extra-style:2px", true);
93              handler.Id.Should().NotBe(default(Guid));
94              handler.UserAttributes.Should().BeEquivalentTo(new Dictionary<string, object> { { "myprop1", "myValue1" } });
95              handler.Class.Should().Be("my-extra-class");
96              handler.Style.Should().Be("my-extra-style:2px");
97              handler.Tag.Should().Be("my tag");
98              handler.Fragment.Should().BeSameAs(newRenderFragement);
99              handler.IsConnected.Should().BeFalse();
100              handler.ShowContent.Should().BeTrue();
101              updateCounter.Should().Be(1);
102          }
103          [Test]
104          public async Task MudPopoverHandler_UpdateFragmentAsync()
105          {
106              var mock = Mock.Of<IJSRuntime>();
107              var updateCounter = 0;
108              RenderFragment initialRenderFragment = _ => { };
109              RenderFragment newRenderFragment = _ => { };
110              void Updater() => updateCounter++;
111              var handler = new MudPopoverHandler(initialRenderFragment, mock, Updater);
112              var comp = Context.RenderComponent<MudBadge>(p =>
113              {
114                  p.Add(x => x.UserAttributes, new Dictionary<string, object> { { "myprop1", "myValue1" } });
115                  p.Add(x => x.Tag, "my tag");
116              });
117              await handler.UpdateFragmentAsync(newRenderFragment, comp.Instance, "my-extra-class", "my-extra-style:2px", true);
118              handler.Id.Should().NotBe(default(Guid));
119              handler.UserAttributes.Should().BeEquivalentTo(new Dictionary<string, object> { { "myprop1", "myValue1" } });
120              handler.Class.Should().Be("my-extra-class");
121              handler.Style.Should().Be("my-extra-style:2px");
122              handler.Tag.Should().Be("my tag");
123              handler.Fragment.Should().BeSameAs(newRenderFragment);
124              handler.IsConnected.Should().BeFalse();
125              handler.ShowContent.Should().BeTrue();
126              updateCounter.Should().Be(1);
127          }
128          [Test]
129          public async Task MudPopoverHandler_DetachAndUpdateFragmentAsync()
130          {
131              var mock = Mock.Of<IJSRuntime>();
132              var updateCounter = 0;
133              RenderFragment initialRenderFragment = _ => { };
134              RenderFragment newRenderFragment = _ => { };
135              void Updater() => updateCounter++;
136              var handler = new MudPopoverHandler(initialRenderFragment, mock, Updater);
137              var comp = Context.RenderComponent<MudBadge>(p =>
138              {
139                  p.Add(x => x.UserAttributes, new Dictionary<string, object> { { "myprop1", "myValue1" } });
140                  p.Add(x => x.Tag, "my tag");
141              });
142              await handler.Detach();
143              await handler.UpdateFragmentAsync(newRenderFragment, comp.Instance, "my-new-extra-class", "my-new-extra-style:2px", true);
144              updateCounter.Should().Be(0);
145          }
146          [Test]
147          public async Task MudPopoverHandler_DetachAndUpdateFragmentConcurrent_UpdateFragmentDoesNotRunInTheSameTimeAsDetach()
148          {
149              var connectTcs = new TaskCompletionSource<IJSVoidResult>();
150              var mock = new Mock<IJSRuntime>();
151              var handler = new MudPopoverHandler((tree) => { }, mock.Object, () => { });
152              mock.Setup(x => x.InvokeAsync<IJSVoidResult>("mudPopover.connect", It.Is<object[]>(y => y.Length == 1 && (Guid)y[0] == handler.Id)))
153                  .ReturnsAsync(Mock.Of<IJSVoidResult>())
154                  .Verifiable();
155              mock.Setup(x => x.InvokeAsync<IJSVoidResult>("mudPopover.disconnect", It.Is<object[]>(y => y.Length == 1 && (Guid)y[0] == handler.Id)))
156                  .Returns(new ValueTask<IJSVoidResult>(connectTcs.Task))
157                  .Verifiable();
158              var comp = Context.RenderComponent<MudBadge>(p =>
159              {
160                  p.Add(x => x.UserAttributes, new Dictionary<string, object> { { "myprop1", "myValue1" } });
161                  p.Add(x => x.Tag, "my tag");
162              });
163              RenderFragment newRenderFragement = (tree) => { };
164              await handler.Initialize();
165              _ = handler.Detach();
166              var task2 = handler.UpdateFragmentAsync(newRenderFragement, comp.Instance, "my-new-extra-class", "my-new-extra-style:2px", true);
167              var completedTask = await Task.WhenAny(Task.Delay(50), task2);
168              completedTask.Should().NotBe(task2);
169              mock.Verify();
170              mock.VerifyNoOtherCalls();
171          }
172          [Test]
173          public async Task MudPopoverHandler_DetachAndUpdateFragmentConcurrent_UpdateFragmentAsyncShouldRunAfterDetach()
174          {
175              var connectTcs = new TaskCompletionSource<IJSVoidResult>();
176              var mock = new Mock<IJSRuntime>();
177              var handler = new MudPopoverHandler(_ => { }, mock.Object, () => { });
178              mock.Setup(x => x.InvokeAsync<IJSVoidResult>("mudPopover.connect", It.Is<object[]>(y => y.Length == 1 && (Guid)y[0] == handler.Id)))
179                  .ReturnsAsync(Mock.Of<IJSVoidResult>())
180                  .Verifiable();
181              mock.Setup(x => x.InvokeAsync<IJSVoidResult>("mudPopover.disconnect", It.Is<object[]>(y => y.Length == 1 && (Guid)y[0] == handler.Id)))
182                  .Returns(new ValueTask<IJSVoidResult>(connectTcs.Task))
183                  .Verifiable();
184              var comp = Context.RenderComponent<MudBadge>(p =>
185              {
186                  p.Add(x => x.UserAttributes, new Dictionary<string, object> { { "myprop1", "myValue1" } });
187                  p.Add(x => x.Tag, "my tag");
188              });
189              RenderFragment newRenderFragement = (tree) => { };
190              await handler.Initialize();
191              var task1 = handler.Detach();
192              var task2 = handler.UpdateFragmentAsync(newRenderFragement, comp.Instance, "my-new-extra-class", "my-new-extra-style:2px", true);
193              connectTcs.SetResult(Mock.Of<IJSVoidResult>());
194              await Task.WhenAll(task1, task2);
195              mock.Verify();
196              mock.VerifyNoOtherCalls();
197          }
198          [Test(Description = "Remove in v7")]
199          public void MudPopoverHandler_UpdaterInvokationTest()
200          {
201              RenderFragment initialRenderFragement = (tree) => { };
202              var mock = Mock.Of<IJSRuntime>();
203              var updateCounter = 0;
204              Action updater = () => { updateCounter++; };
205              var handler = new MudPopoverHandler(initialRenderFragement, mock, updater);
206              var comp = Context.RenderComponent<MudBadge>(p =>
207              {
208                  p.Add(x => x.UserAttributes, new Dictionary<string, object> { { "myprop1", "myValue1" } });
209                  p.Add(x => x.Tag, "my tag");
210              });
211              RenderFragment newRenderFragement = (tree) => { };
212              for (int i = 0; i < 4; i++)
213              {
214                  handler.UpdateFragment(newRenderFragement, comp.Instance, "my-extra-class", "my-extra-style:2px", i % 2 == 0);
215              }
216              updateCounter.Should().Be(4);
217              handler.UpdateFragment(newRenderFragement, comp.Instance, "my-new-extra-class", "my-new-extra-style:2px", true);
218              updateCounter.Should().Be(5);
219              handler.Class.Should().Be("my-new-extra-class");
220              handler.Style.Should().Be("my-new-extra-style:2px");
221          }
222          [Test]
223          public async Task MudPopoverHandler_UpdaterInvocationAsync()
224          {
225              var mock = Mock.Of<IJSRuntime>();
226              var updateCounter = 0;
227              RenderFragment initialRenderFragment = _ => { };
228              RenderFragment newRenderFragment = _ => { };
229              void Updater() => updateCounter++;
230              var handler = new MudPopoverHandler(initialRenderFragment, mock, Updater);
231              var comp = Context.RenderComponent<MudBadge>(p =>
232              {
233                  p.Add(x => x.UserAttributes, new Dictionary<string, object> { { "myprop1", "myValue1" } });
234                  p.Add(x => x.Tag, "my tag");
235              });
236              for (int i = 0; i < 4; i++)
237              {
238                 await handler.UpdateFragmentAsync(newRenderFragment, comp.Instance, "my-extra-class", "my-extra-style:2px", i % 2 == 0);
239              }
240              updateCounter.Should().Be(4);
241              await handler.UpdateFragmentAsync(newRenderFragment, comp.Instance, "my-new-extra-class", "my-new-extra-style:2px", true);
242              updateCounter.Should().Be(5);
243              handler.Class.Should().Be("my-new-extra-class");
244              handler.Style.Should().Be("my-new-extra-style:2px");
245          }
246          [Test]
247          public async Task MudPopoverHandler_InitializeAndDetach()
248          {
249              var handlerId = Guid.NewGuid();
250              RenderFragment renderFragement = (tree) => { };
251              var mock = new Mock<IJSRuntime>();
252              mock.Setup(x =>
253              x.InvokeAsync<IJSVoidResult>(
254                  "mudPopover.connect",
255                  It.Is<object[]>(x => x.Length == 1 && (Guid)x[0] == handlerId))).ReturnsAsync(Mock.Of<IJSVoidResult>).Verifiable();
256              mock.Setup(x =>
257              x.InvokeAsync<IJSVoidResult>(
258                  "mudPopover.disconnect",
259                  It.Is<object[]>(x => x.Length == 1 && (Guid)x[0] == handlerId))).ReturnsAsync(Mock.Of<IJSVoidResult>).Verifiable();
260              var updateCounter = 0;
261              Action updater = () => { updateCounter++; };
262              var handler = new MudPopoverHandler(renderFragement, mock.Object, updater);
263              handlerId = handler.Id;
264              handler.IsConnected.Should().BeFalse();
265              await handler.Initialize();
266              handler.IsConnected.Should().BeTrue();
267              await handler.Detach();
268              handler.IsConnected.Should().BeFalse();
269          }
270          [Test]
271          public async Task MudPopoverHandler_InitializeAndDetach_DetachThrowsTaskCanceledException()
272          {
273              var handlerId = Guid.NewGuid();
274              RenderFragment renderFragement = (tree) => { };
275              var mock = new Mock<IJSRuntime>();
276              mock.Setup(x =>
277              x.InvokeAsync<IJSVoidResult>(
278                  "mudPopover.connect",
279                  It.Is<object[]>(x => x.Length == 1 && (Guid)x[0] == handlerId))).ReturnsAsync(Mock.Of<IJSVoidResult>).Verifiable();
280              mock.Setup(x =>
281              x.InvokeAsync<IJSVoidResult>(
282                  "mudPopover.disconnect",
283                  It.Is<object[]>(x => x.Length == 1 && (Guid)x[0] == handlerId))).ThrowsAsync(new TaskCanceledException()).Verifiable();
284              var updateCounter = 0;
285              Action updater = () => { updateCounter++; };
286              var handler = new MudPopoverHandler(renderFragement, mock.Object, updater);
287              handlerId = handler.Id;
288              await handler.Initialize();
289              await handler.Detach();
290              handler.IsConnected.Should().BeFalse();
291          }
292          [Test]
293          public async Task MudPopoverHandler_InitializeAndDetach_DetachThrowsNotTaskCanceledException()
294          {
295              var handlerId = Guid.NewGuid();
296              RenderFragment renderFragement = (tree) => { };
297              var mock = new Mock<IJSRuntime>();
298              mock.Setup(x =>
299              x.InvokeAsync<IJSVoidResult>(
300                  "mudPopover.connect",
301                  It.Is<object[]>(x => x.Length == 1 && (Guid)x[0] == handlerId))).ReturnsAsync(Mock.Of<IJSVoidResult>).Verifiable();
302              mock.Setup(x =>
303              x.InvokeAsync<IJSVoidResult>(
304                  "mudPopover.disconnect",
305                  It.Is<object[]>(x => x.Length == 1 && (Guid)x[0] == handlerId))).ThrowsAsync(new InvalidOperationException()).Verifiable();
306              var updateCounter = 0;
307              Action updater = () => { updateCounter++; };
308              var handler = new MudPopoverHandler(renderFragement, mock.Object, updater);
309              handlerId = handler.Id;
310              await handler.Initialize();
311              Assert.ThrowsAsync<InvalidOperationException>(async () => await handler.Detach());
312              handler.IsConnected.Should().BeFalse();
313          }
314          [Test]
315          public async Task MudPopoverHandler_InitializeAndDetachConcurrent_DetachDoesNotRunAtSameTimeAsInitialize()
316          {
317              var connectTcs = new TaskCompletionSource<IJSVoidResult>();
318              var mock = new Mock<IJSRuntime>();
319              var handler = new MudPopoverHandler(_ => { }, mock.Object, () => { });
320              mock.Setup(x => x.InvokeAsync<IJSVoidResult>("mudPopover.connect", It.Is<object[]>(y => y.Length == 1 && (Guid)y[0] == handler.Id)))
321                  .Returns(new ValueTask<IJSVoidResult>(connectTcs.Task))
322                  .Verifiable();
323              _ = handler.Initialize();
324              var task2 = handler.Detach();
325              var completedTask = await Task.WhenAny(Task.Delay(50), task2);
326              completedTask.Should().NotBe(task2);
327              mock.Verify();
328              mock.VerifyNoOtherCalls();
329          }
330          [Test]
331          public async Task MudPopoverHandler_InitializeAndDetachConcurrent_DetachRunsAfterInitialize()
332          {
333              var connectTcs = new TaskCompletionSource<IJSVoidResult>();
334              var mock = new Mock<IJSRuntime>();
335              var handler = new MudPopoverHandler(_ => { }, mock.Object, () => { });
336              mock.Setup(x => x.InvokeAsync<IJSVoidResult>("mudPopover.connect", It.Is<object[]>(y => y.Length == 1 && (Guid)y[0] == handler.Id)))
337                  .Returns(new ValueTask<IJSVoidResult>(connectTcs.Task))
338                  .Verifiable();
339              mock.Setup(x => x.InvokeAsync<IJSVoidResult>("mudPopover.disconnect", It.Is<object[]>(y => y.Length == 1 && (Guid)y[0] == handler.Id)))
340                  .ReturnsAsync(Mock.Of<IJSVoidResult>())
341                  .Verifiable();
342              var task1 = handler.Initialize();
343              var task2 = handler.Detach();
344              connectTcs.SetResult(Mock.Of<IJSVoidResult>());
345              await Task.WhenAll(task1, task2);
346              mock.Verify();
347              mock.VerifyNoOtherCalls();
348          }
349          [Test]
350          public async Task MudPopoverHandler_DetachCalledBeforeInitialize_NoInteropShouldOccur()
351          {
352              var mock = new Mock<IJSRuntime>();
353              var handler = new MudPopoverHandler(_ => { }, mock.Object, () => { });
354              await handler.Detach();
355              handler.IsConnected.Should().BeFalse();
356              await handler.Initialize();
357              handler.IsConnected.Should().BeFalse();
358              mock.VerifyNoOtherCalls();
359          }
360          [Test]
361          public void MudPopoverService_Constructor_NoJsInterop()
362          {
363              Assert.Throws<ArgumentNullException>(() => _ = new MudPopoverService(null));
364          }
365          [Test]
366          public async Task MudPopoverService_Constructor_NullOption()
367          {
368              var mock = new Mock<IJSRuntime>();
369              mock.Setup(x =>
370             x.InvokeAsync<IJSVoidResult>(
371                 "mudPopover.initialize",
372                 It.Is<object[]>(x => x.Length == 2 && (string)x[0] == "mudblazor-main-content" && (int)x[1] == 0))).ReturnsAsync(Mock.Of<IJSVoidResult>).Verifiable();
373              {
374                  var service = new MudPopoverService(mock.Object, null);
375                  await service.InitializeIfNeeded();
376              }
377              {
378                  var service = new MudPopoverService(mock.Object);
379                  await service.InitializeIfNeeded();
380              }
381              mock.Verify();
382          }
383          [Test]
384          public async Task MudPopoverService_Initialize_Catch_JSDisconnectedException()
385          {
386              var mock = new Mock<IJSRuntime>();
387              mock.Setup(x =>
388             x.InvokeAsync<IJSVoidResult>(
389                 "mudPopover.initialize",
390                 It.Is<object[]>(x => x.Length == 2 && (string)x[0] == "mudblazor-main-content" && (int)x[1] == 0))).ThrowsAsync(new JSDisconnectedException("JSDisconnectedException")).Verifiable();
391              {
392                  var service = new MudPopoverService(mock.Object);
393                  await service.InitializeIfNeeded();
394              }
395              mock.Verify();
396          }
397          [Test]
398          public async Task MudPopoverService_Initialize_Catch_TaskCanceledException()
399          {
400              var mock = new Mock<IJSRuntime>();
401              mock.Setup(x =>
402             x.InvokeAsync<IJSVoidResult>(
403                 "mudPopover.initialize",
404                 It.Is<object[]>(x => x.Length == 2 && (string)x[0] == "mudblazor-main-content" && (int)x[1] == 0))).ThrowsAsync(new TaskCanceledException()).Verifiable();
405              {
406                  var service = new MudPopoverService(mock.Object);
407                  await service.InitializeIfNeeded();
408              }
409              mock.Verify();
410          }
411          [Test]
412          public async Task MudPopoverService_Constructor_OptionWithCustomClass()
413          {
414              var mock = new Mock<IJSRuntime>();
415              var option = new PopoverOptions
416              {
417                  ContainerClass = "my-custom-class",
418                  FlipMargin = 12,
419              };
420              var optionMock = new Mock<IOptions<PopoverOptions>>();
421              optionMock.SetupGet(x => x.Value).Returns(option);
422              mock.Setup(x =>
423             x.InvokeAsync<IJSVoidResult>(
424                 "mudPopover.initialize",
425                 It.Is<object[]>(x => x.Length == 2 && (string)x[0] == "my-custom-class" && (int)x[1] == 12))).ReturnsAsync(Mock.Of<IJSVoidResult>).Verifiable();
426              var service = new MudPopoverService(mock.Object, optionMock.Object);
427              await service.InitializeIfNeeded();
428              mock.Verify();
429          }
430          [Test]
431          public async Task MudPopoverService_CallInitializeOnlyOnce()
432          {
433              var mock = new Mock<IJSRuntime>();
434              mock.Setup(x =>
435             x.InvokeAsync<IJSVoidResult>(
436                 "mudPopover.initialize",
437                 It.Is<object[]>(x => x.Length == 2 && (string)x[0] == "mudblazor-main-content" && (int)x[1] == 0))).ReturnsAsync(Mock.Of<IJSVoidResult>(), TimeSpan.FromMilliseconds(300)).Verifiable();
438              Task[] tasks = new Task[5];
439              var service = new MudPopoverService(mock.Object);
440              for (int i = 0; i < 5; i++)
441              {
442                  tasks[i] = Task.Run(async () => await service.InitializeIfNeeded());
443              }
444              Task.WaitAll(tasks);
445              mock.Verify(x =>
446             x.InvokeAsync<IJSVoidResult>(
447                 "mudPopover.initialize",
448                 It.Is<object[]>(x => x.Length == 2 && (string)x[0] == "mudblazor-main-content" && (int)x[1] == 0)), Times.Once());
449          }
450          [Test]
451          public async Task MudPopoverService_OnlyDisposeIfConnected()
452          {
453              var service = new MudPopoverService(Mock.Of<IJSRuntime>(MockBehavior.Strict));
454              await service.DisposeAsync();
455          }
456          [Test]
457          public async Task MudPopoverService_DisposeAsync()
458          {
459              var mock = new Mock<IJSRuntime>();
460              mock.Setup(x =>
461             x.InvokeAsync<IJSVoidResult>(
462                 "mudPopover.initialize",
463                 It.Is<object[]>(x => x.Length == 2 && (string)x[0] == "mudblazor-main-content" && (int)x[1] == 0))).ReturnsAsync(Mock.Of<IJSVoidResult>).Verifiable();
464              mock.Setup(x =>
465              x.InvokeAsync<IJSVoidResult>(
466              "mudPopover.dispose",
467              It.Is<object[]>(x => x.Length == 0))).ReturnsAsync(Mock.Of<IJSVoidResult>).Verifiable();
468              var service = new MudPopoverService(mock.Object);
469              await service.InitializeIfNeeded();
470              await service.DisposeAsync();
471              mock.Verify();
472          }
473          [Test]
474          public async Task MudPopoverService_DisposeAsync_WithTaskCancelException()
475          {
476              var mock = new Mock<IJSRuntime>();
477              mock.Setup(x =>
478             x.InvokeAsync<IJSVoidResult>(
479                 "mudPopover.initialize",
480                 It.Is<object[]>(x => x.Length == 2 && (string)x[0] == "mudblazor-main-content" && (int)x[1] == 0))).ReturnsAsync(Mock.Of<IJSVoidResult>).Verifiable();
481              mock.Setup(x =>
482              x.InvokeAsync<IJSVoidResult>(
483              "mudPopover.dispose",
484              It.Is<object[]>(x => x.Length == 0))).ThrowsAsync(new TaskCanceledException()).Verifiable();
485              var service = new MudPopoverService(mock.Object);
486              await service.InitializeIfNeeded();
487              await service.DisposeAsync();
488              mock.Verify();
489          }
490          [Test(Description = "Remove in v7")]
491          public void MudPopoverService_RegisterAndUseHandler()
492          {
493              var service = new MudPopoverService(Mock.Of<IJSRuntime>(MockBehavior.Strict));
494              int fragmentChangedCounter = 0;
495              service.FragmentsChanged += (e, args) =>
496              {
497                  fragmentChangedCounter++;
498              };
499              RenderFragment fragment = (builder) => { };
500              var handler = service.Register(fragment);
501              handler.Should().NotBeNull();
502              fragmentChangedCounter.Should().Be(1);
503              RenderFragment changedFragment = (builder) => { };
504              var comp = Context.RenderComponent<MudBadge>(p =>
505              {
506                  p.Add(x => x.UserAttributes, new Dictionary<string, object> { { "myprop1", "myValue1" } });
507                  p.Add(x => x.Tag, "my tag");
508              });
509              handler.UpdateFragment(changedFragment, comp.Instance, "my-class", "my-style", true);
510              fragmentChangedCounter.Should().Be(1);
511          }
512          [Test]
513          public async Task MudPopoverService_RegisterAndUseHandlerAsync()
514          {
515              var service = new MudPopoverService(Mock.Of<IJSRuntime>(MockBehavior.Strict));
516              int fragmentChangedCounter = 0;
517              service.FragmentsChanged += (_, _) =>
518              {
519                  fragmentChangedCounter++;
520              };
521              RenderFragment fragment = _ => { };
522              RenderFragment changedFragment = _ => { };
523              var handler = service.Register(fragment);
524              handler.Should().NotBeNull();
525              fragmentChangedCounter.Should().Be(1);
526              var comp = Context.RenderComponent<MudBadge>(p =>
527              {
528                  p.Add(x => x.UserAttributes, new Dictionary<string, object> { { "myprop1", "myValue1" } });
529                  p.Add(x => x.Tag, "my tag");
530              });
531              await handler.UpdateFragmentAsync(changedFragment, comp.Instance, "my-class", "my-style", true);
532              fragmentChangedCounter.Should().Be(1);
533          }
534          [Test]
535          public async Task MudPopoverService_Unregister_NullFragment()
536          {
537              var service = new MudPopoverService(Mock.Of<IJSRuntime>(MockBehavior.Strict));
538              var result = await service.Unregister(null);
539              result.Should().BeFalse();
540          }
541          [Test]
542          public async Task MudPopoverService_Unregister_HandlerNotFound()
543          {
544              var service = new MudPopoverService(Mock.Of<IJSRuntime>(MockBehavior.Strict));
545              var handler = new MudPopoverHandler((tree) => { }, Mock.Of<IJSRuntime>(MockBehavior.Strict), () => { });
546              var result = await service.Unregister(handler);
547              result.Should().BeFalse();
548          }
549          [Test]
550          public async Task MudPopoverService_Unregister_NotConnected()
551          {
552              var service = new MudPopoverService(Mock.Of<IJSRuntime>(MockBehavior.Strict));
553              RenderFragment fragment = (builder) => { };
554              var handler = service.Register(fragment);
555              var result = await service.Unregister(handler);
556              result.Should().BeTrue();
557          }
558          [Test]
559          public async Task MudPopoverService_Unregister()
560          {
561              var handlerId = Guid.NewGuid();
562              var mock = new Mock<IJSRuntime>();
563              mock.Setup(x =>
564             x.InvokeAsync<IJSVoidResult>(
565                 "mudPopover.connect",
566                 It.Is<object[]>(x => x.Length == 1 && (Guid)x[0] == handlerId))).ReturnsAsync(Mock.Of<IJSVoidResult>).Verifiable();
567              mock.Setup(x =>
568              x.InvokeAsync<IJSVoidResult>(
569             "mudPopover.disconnect",
570             It.Is<object[]>(x => x.Length == 1 && (Guid)x[0] == handlerId))).ReturnsAsync(Mock.Of<IJSVoidResult>).Verifiable();
571              var service = new MudPopoverService(mock.Object);
572              await service.InitializeIfNeeded();
573              RenderFragment fragment = (builder) => { };
574              var handler = service.Register(fragment);
575              handlerId = handler.Id;
576              await handler.Initialize();
577              int fragmentChangedCounter = 0;
578              service.FragmentsChanged += (e, args) =>
579              {
580                  fragmentChangedCounter++;
581              };
582              var result = await service.Unregister(handler);
583              result.Should().BeTrue();
584              fragmentChangedCounter.Should().Be(1);
585              var secondResult = await service.Unregister(handler);
586              secondResult.Should().BeFalse();
587              mock.Verify();
588          }
589          [Test]
590          public void MudPopover_DefaultValues()
591          {
592              var popover = new MudPopover();
593              popover.MaxHeight.Should().BeNull();
594              popover.Paper.Should().BeTrue();
595              popover.Elevation.Should().Be(8);
596              popover.Square.Should().BeFalse();
597              popover.Open.Should().BeFalse();
598              popover.Fixed.Should().BeFalse();
599              popover.AnchorOrigin.Should().Be(Origin.TopLeft);
600              popover.TransformOrigin.Should().Be(Origin.TopLeft);
601              popover.RelativeWidth.Should().BeFalse();
602              popover.OverflowBehavior.Should().Be(OverflowBehavior.FlipOnOpen);
603              popover.Duration.Should().Be(251);
604          }
605          [Test]
606          public async Task MudPopover_OpenAndClose()
607          {
608              var comp = Context.RenderComponent<PopoverTest>();
609              var provider = comp.Find(".mud-popover-provider");
610              provider.Children.Should().ContainSingle();
611              var popoverNode = comp.Find(".popoverparent").Children[1];
612              popoverNode.Id.Should().StartWith("popover-");
613              var handlerId = Guid.Parse(popoverNode.Id.Substring(8));
614              handlerId.Should().NotBe(Guid.Empty);
615              provider.Children.Should().ContainSingle();
616              provider.FirstElementChild.Id.Should().Be($"popovercontent-{handlerId}");
617              provider.FirstElementChild.Children.Should().BeEmpty();
618              await comp.Instance.Open();
619              provider.FirstElementChild.Children.Should().ContainSingle();
620              provider.FirstElementChild.Children[0].TextContent.Should().Be("Popover content");
621              await comp.Instance.Close();
622              provider.FirstElementChild.Children.Should().BeEmpty();
623          }
624          [Test]
625          public void MudPopover_Property_MaxHeight()
626          {
627              var comp = Context.RenderComponent<PopoverPropertyTest>(p => p.Add(x => x.MaxHeight, 100));
628              var popoverElement = comp.Find(".test-popover-content").ParentElement;
629              popoverElement.GetAttribute("style").Split(';', StringSplitOptions.RemoveEmptyEntries).Should().Contain(new[] { "max-height:100px", "my-custom-style:3px" });
630          }
631          [Test]
632          public void MudPopover_Property_TransitionDuration()
633          {
634              var comp = Context.RenderComponent<PopoverPropertyTest>(p => p.Add(x => x.Duration, 100));
635              var popoverElement = comp.Find(".test-popover-content").ParentElement;
636              popoverElement.GetAttribute("style").Split(';', StringSplitOptions.RemoveEmptyEntries).Should().Contain(new[] { "transition-duration:100ms" });
637          }
638          [Test]
639          public void MudPopover_Property_Fixed()
640          {
641              var comp = Context.RenderComponent<PopoverPropertyTest>(p => p.Add(
642                  x => x.Fixed, true));
643              var popoverElement = comp.Find(".test-popover-content").ParentElement;
644              popoverElement.ClassList.Should().Contain(new[] { "mud-popover-open", "mud-popover-fixed", "my-custom-class" });
645          }
646          [Test]
647          public void MudPopover_Property_RelativeWidth()
648          {
649              var comp = Context.RenderComponent<PopoverPropertyTest>(p => p.Add(
650                  x => x.RelativeWidth, true));
651              var popoverElement = comp.Find(".test-popover-content").ParentElement;
652              popoverElement.ClassList.Should().Contain(new[] { "mud-popover-open", "mud-popover-relative-width", "my-custom-class" });
653          }
654          [Test]
655          public void MudPopover_Property_Paper()
656          {
657              var comp = Context.RenderComponent<PopoverPropertyTest>(p => p.Add(
658                  x => x.Paper, true));
659              var popoverElement = comp.Find(".test-popover-content").ParentElement;
660              popoverElement.ClassList.Should().Contain(new[] { "mud-popover-open", "mud-paper", "mud-elevation-8", "my-custom-class" });
661          }
662          [Test]
663          public void MudPopover_Property_PaperAndSqaure()
664          {
665              var comp = Context.RenderComponent<PopoverPropertyTest>(p =>
666              {
667                  p.Add(x => x.Paper, true);
668                  p.Add(x => x.Square, true);
669              });
670              var popoverElement = comp.Find(".test-popover-content").ParentElement;
671              popoverElement.ClassList.Should().Contain(new[] { "mud-popover-open", "mud-paper-square", "mud-elevation-8", "my-custom-class" });
672          }
673          [Test]
674          public void MudPopover_Property_Elevation()
675          {
676              var comp = Context.RenderComponent<PopoverPropertyTest>(p =>
677              {
678                  p.Add(x => x.Paper, true);
679                  p.Add(x => x.Elevation, 10);
680              });
681              var popoverElement = comp.Find(".test-popover-content").ParentElement;
682              popoverElement.ClassList.Should().Contain(new[] { "mud-popover-open", "mud-paper", "mud-elevation-10", "my-custom-class" });
683          }
684          [Test]
685          [TestCase(Origin.BottomCenter, "bottom-center")]
686          [TestCase(Origin.BottomLeft, "bottom-left")]
687          [TestCase(Origin.BottomRight, "bottom-right")]
688          [TestCase(Origin.CenterCenter, "center-center")]
689          [TestCase(Origin.CenterLeft, "center-left")]
690          [TestCase(Origin.CenterRight, "center-right")]
691          [TestCase(Origin.TopCenter, "top-center")]
692          [TestCase(Origin.TopLeft, "top-left")]
693          [TestCase(Origin.TopRight, "top-right")]
694          public void MudPopover_Property_TransformOrigin(Origin transformOrigin, string expectedClass)
695          {
696              var comp = Context.RenderComponent<PopoverPropertyTest>(p => p.Add(
697                  x => x.TransformOrigin, transformOrigin));
698              var popoverElement = comp.Find(".test-popover-content").ParentElement;
699              popoverElement.ClassList.Should().Contain(new[] { "mud-popover-open", $"mud-popover-{expectedClass}", "my-custom-class" });
700          }
701          [Test]
702          [TestCase(Origin.BottomCenter, "bottom-center")]
703          [TestCase(Origin.BottomLeft, "bottom-left")]
704          [TestCase(Origin.BottomRight, "bottom-right")]
705          [TestCase(Origin.CenterCenter, "center-center")]
706          [TestCase(Origin.CenterLeft, "center-left")]
707          [TestCase(Origin.CenterRight, "center-right")]
708          [TestCase(Origin.TopCenter, "top-center")]
709          [TestCase(Origin.TopLeft, "top-left")]
710          [TestCase(Origin.TopRight, "top-right")]
711          public void MudPopover_Property_AnchorOrigin(Origin anchorOrigin, string expectedClass)
712          {
713              var comp = Context.RenderComponent<PopoverPropertyTest>(p => p.Add(
714                  x => x.AnchorOrigin, anchorOrigin));
715              var popoverElement = comp.Find(".test-popover-content").ParentElement;
716              popoverElement.ClassList.Should().Contain(new[] { "mud-popover-open", $"mud-popover-anchor-{expectedClass}", "my-custom-class" });
717          }
718          [Test]
719          [TestCase(OverflowBehavior.FlipNever, "flip-never")]
720          [TestCase(OverflowBehavior.FlipOnOpen, "flip-onopen")]
721          [TestCase(OverflowBehavior.FlipAlways, "flip-always")]
722          public void MudPopover_Property_OverflowBehavior(OverflowBehavior overflowBehavior, string expectedClass)
723          {
724              var comp = Context.RenderComponent<PopoverPropertyTest>(p => p.Add(
725                  x => x.OverflowBehavior, overflowBehavior));
726              var popoverElement = comp.Find(".test-popover-content").ParentElement;
727              popoverElement.ClassList.Should().Contain(new[] { "mud-popover-open", $"mud-popover-overflow-{expectedClass}", "my-custom-class" });
728          }
729          [Test]
730          public async Task MudPopover_WithDynamicContent()
731          {
732              var comp = Context.RenderComponent<PopoverComplexContent>();
733              var dynamicContentElement = comp.Find(".dynamic-content");
734              dynamicContentElement.ChildNodes.Should().BeEmpty();
735              await comp.Instance.AddRow();
736              dynamicContentElement.ChildNodes.Should().ContainSingle();
737              dynamicContentElement.ChildNodes[0].TextContent.Should().Be("Popover content 0");
738              await comp.Instance.AddRow();
739              dynamicContentElement.ChildNodes.Should().HaveCount(2);
740              dynamicContentElement.ChildNodes[0].TextContent.Should().Be("Popover content 0");
741              dynamicContentElement.ChildNodes[1].TextContent.Should().Be("Popover content 1");
742              await comp.Instance.AddRow();
743              dynamicContentElement.ChildNodes.Should().HaveCount(3);
<span onclick='openModal()' class='match'>744              dynamicContentElement.ChildNodes[0].TextContent.Should().Be("Popover content 0");
745              dynamicContentElement.ChildNodes[1].TextContent.Should().Be("Popover content 1");
746              dynamicContentElement.ChildNodes[2].TextContent.Should().Be("Popover content 2");
747          }
748          [Test]
749          public void MudPopoverProvider_DefaultValue()
750          {
751              var provider = new MudPopoverProvider();
752              provider.IsEnabled.Should().BeTrue();
</span>753          }
754          [Test]
755          public void MudPopoverProvider_RenderElementsBasedOnEnableState()
756          {
757              var comp = Context.RenderComponent<PopoverProviderTest>(p => p.Add(x => x.ProviderIsEnabled, true));
758              comp.Find("#my-content").TextContent.Should().Be("Popover content");
759              for (int i = 0; i < 3; i++)
760              {
761                  comp.SetParametersAndRender(p => p.Add(x => x.ProviderIsEnabled, false));
762                  Assert.Throws<ElementNotFoundException>(() => comp.Find("#my-content"));
763                  comp.SetParametersAndRender(p => p.Add(x => x.ProviderIsEnabled, true));
764                  comp.Find("#my-content").TextContent.Should().Be("Popover content");
765              }
766          }
767          [Test]
768          public void MudPopoverProvider_NoRenderWhenIsEnabledIsFalse()
769          {
770              var comp = Context.RenderComponent<PopoverProviderTest>(p => p.Add(x => x.ProviderIsEnabled, false));
771              Assert.Throws<ElementNotFoundException>(() => comp.Find("#my-content"));
772          }
773          [TestCase(false)]
774          [TestCase(true)]
775          public async Task MudPopoverProvider_ThrowOnDuplicate(bool ThrowOnDuplicateProvider)
776          {
777              var options = new PopoverOptions
778              {
779                  ThrowOnDuplicateProvider = ThrowOnDuplicateProvider
780              };
781              Context.Services.Configure<PopoverOptions>(x => x.ThrowOnDuplicateProvider = ThrowOnDuplicateProvider);
782              Context.JSInterop.Setup<int>("mudpopoverHelper.countProviders").SetResult(ThrowOnDuplicateProvider == true ? 2 : 1);
783              if (ThrowOnDuplicateProvider == true)
784              {
785                  var ex = Assert.Throws<InvalidOperationException>(() => Context.RenderComponent<PopoverDuplicationTest>());
786                  ex.Message.Should().StartWith("Duplicate MudPopoverProvider detected");
787              }
788              else
789              {
790                  var comp = Context.RenderComponent<PopoverDuplicationTest>();
791                  await comp.Instance.Open();
792                  await comp.Instance.Close();
793              }
794          }
795      }
796  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-CookiePolicyTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from MudBlazor-MDEwOlJlcG9zaXRvcnkyODg0Mjg2NzY=-flat-PopoverTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>200                      Assert.NotNull(transaction.SetCookie);
201                      Assert.Equal("A=A; path=/", transaction.SetCookie[0]);
202                      Assert.Equal("B=B; path=/", transaction.SetCookie[1]);
203                      Assert.Equal("C=C; path=/; samesite=lax", transaction.SetCookie[2]);
204                      Assert.Equal("D=D; path=/; samesite=lax", transaction.SetCookie[3]);
205                      Assert.Equal("E=E; path=/; samesite=strict", transaction.SetCookie[4]);
206                  }));
207          }
208          [Fact]
209          public async Task CookiePolicyCanHijackAppend()
210          {
211              var builder = new WebHostBuilder()
212                  .Configure(app =>
213                  {
214                      app.UseCookiePolicy(new CookiePolicyOptions
</pre></code></div>
                <div class="column column_space"><pre><code>744              dynamicContentElement.ChildNodes[0].TextContent.Should().Be("Popover content 0");
745              dynamicContentElement.ChildNodes[1].TextContent.Should().Be("Popover content 1");
746              dynamicContentElement.ChildNodes[2].TextContent.Should().Be("Popover content 2");
747          }
748          [Test]
749          public void MudPopoverProvider_DefaultValue()
750          {
751              var provider = new MudPopoverProvider();
752              provider.IsEnabled.Should().BeTrue();
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    