
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 12, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-GoogleTests.cs</h3>
            <pre><code>1  using Microsoft.AspNetCore.Authentication.OAuth;
2  using Microsoft.AspNetCore.Builder;
3  using Microsoft.AspNetCore.DataProtection;
4  using Microsoft.AspNetCore.Hosting;
5  using Microsoft.AspNetCore.Http;
6  using Microsoft.AspNetCore.TestHost;
7  using Microsoft.AspNetCore.WebUtilities;
8  using Microsoft.Extensions.DependencyInjection;
9  using Microsoft.Extensions.Logging.Abstractions;
10  using Newtonsoft.Json;
11  using System;
12  using System.Collections.Generic;
13  using System.Linq;
14  using System.Net;
15  using System.Net.Http;
16  using System.Security.Claims;
17  using System.Text;
18  using System.Text.Encodings.Web;
19  using System.Threading.Tasks;
20  using Xunit;
21  namespace Microsoft.AspNetCore.Authentication.Google
22  {
23      public class GoogleTests : RemoteAuthenticationTests<GoogleOptions>
24      {
25          protected override string DefaultScheme => GoogleDefaults.AuthenticationScheme;
26          protected override Type HandlerType => typeof(GoogleHandler);
27          protected override bool SupportsSignIn { get => false; }
28          protected override bool SupportsSignOut { get => false; }
29          protected override void RegisterAuth(AuthenticationBuilder services, Action<GoogleOptions> configure)
30          {
31              services.AddGoogle(o =>
32              {
33                  ConfigureDefaults(o);
34                  configure.Invoke(o);
35              });
36          }
37          protected override void ConfigureDefaults(GoogleOptions o)
38          {
39              o.ClientId = "whatever";
40              o.ClientSecret = "whatever";
41              o.SignInScheme = "auth1";
42          }
43          [Fact]
44          public async Task ChallengeWillTriggerRedirection()
45          {
46              var server = CreateServer(o =>
47              {
48                  o.ClientId = "Test Id";
49                  o.ClientSecret = "Test Secret";
50              });
51              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/challenge");
52              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
53              var location = transaction.Response.Headers.Location.ToString();
54              Assert.Contains("https:&bsol;&bsol;accounts.google.com/o/oauth2/v2/auth?response_type=code", location);
55              Assert.Contains("&client_id=", location);
56              Assert.Contains("&redirect_uri=", location);
57              Assert.Contains("&scope=", location);
58              Assert.Contains("&state=", location);
59              Assert.DoesNotContain("access_type=", location);
60              Assert.DoesNotContain("prompt=", location);
61              Assert.DoesNotContain("approval_prompt=", location);
62              Assert.DoesNotContain("login_hint=", location);
63              Assert.DoesNotContain("include_granted_scopes=", location);
64          }
65          [Fact]
66          public async Task SignInThrows()
67          {
68              var server = CreateServer(o =>
69              {
70                  o.ClientId = "Test Id";
71                  o.ClientSecret = "Test Secret";
72              });
73              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/signIn");
74              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
75          }
76          [Fact]
77          public async Task SignOutThrows()
78          {
79              var server = CreateServer(o =>
80              {
81                  o.ClientId = "Test Id";
82                  o.ClientSecret = "Test Secret";
83              });
84              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/signOut");
85              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
86          }
87          [Fact]
88          public async Task ForbidThrows()
89          {
90              var server = CreateServer(o =>
91              {
92                  o.ClientId = "Test Id";
93                  o.ClientSecret = "Test Secret";
94              });
95              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/signOut");
96              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
97          }
98          [Fact]
99          public async Task Challenge401WillNotTriggerRedirection()
100          {
101              var server = CreateServer(o =>
102              {
103                  o.ClientId = "Test Id";
104                  o.ClientSecret = "Test Secret";
105              });
106              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/401");
107              Assert.Equal(HttpStatusCode.Unauthorized, transaction.Response.StatusCode);
108          }
109          [Fact]
110          public async Task ChallengeWillSetCorrelationCookie()
111          {
112              var server = CreateServer(o =>
113              {
114                  o.ClientId = "Test Id";
115                  o.ClientSecret = "Test Secret";
116              });
117              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/challenge");
118              Assert.Contains(transaction.SetCookie, cookie => cookie.StartsWith(".AspNetCore.Correlation.Google."));
119          }
120          [Fact]
121          public async Task ChallengeWillSetDefaultScope()
122          {
123              var server = CreateServer(o =>
124              {
125                  o.ClientId = "Test Id";
126                  o.ClientSecret = "Test Secret";
127              });
128              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/challenge");
129              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
130              var query = transaction.Response.Headers.Location.Query;
131              Assert.Contains("&scope=" + UrlEncoder.Default.Encode("openid profile email"), query);
132          }
133          [Fact]
134          public async Task ChallengeWillUseAuthenticationPropertiesParametersAsQueryArguments()
135          {
136              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
137              var server = CreateServer(o =>
138              {
139                  o.ClientId = "Test Id";
140                  o.ClientSecret = "Test Secret";
141                  o.StateDataFormat = stateFormat;
142              },
143              context =>
144              {
145                  var req = context.Request;
146                  var res = context.Response;
147                  if (req.Path == new PathString("/challenge2"))
148                  {
149                      return context.ChallengeAsync("Google", new GoogleChallengeProperties
150                      {
151                          Scope = new string[] { "openid", "https:&bsol;&bsol;www.googleapis.com/auth/plus.login" },
152                          AccessType = "offline",
153                          ApprovalPrompt = "force",
154                          Prompt = "consent",
155                          LoginHint = "test@example.com",
156                          IncludeGrantedScopes = false,
157                      });
158                  }
159                  return Task.FromResult<object>(null);
160              });
161              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/challenge2");
162              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
163              var query = QueryHelpers.ParseQuery(transaction.Response.Headers.Location.Query);
164              Assert.Equal("openid https:&bsol;&bsol;www.googleapis.com/auth/plus.login", query["scope"]);
165              Assert.Equal("offline", query["access_type"]);
166              Assert.Equal("force", query["approval_prompt"]);
167              Assert.Equal("consent", query["prompt"]);
168              Assert.Equal("false", query["include_granted_scopes"]);
169              Assert.Equal("test@example.com", query["login_hint"]);
170              var stateProperties = stateFormat.Unprotect(query["state"]);
171              Assert.DoesNotContain("scope", stateProperties.Items.Keys);
172              Assert.DoesNotContain("access_type", stateProperties.Items.Keys);
173              Assert.DoesNotContain("include_granted_scopes", stateProperties.Items.Keys);
174              Assert.DoesNotContain("approval_prompt", stateProperties.Items.Keys);
175              Assert.DoesNotContain("prompt", stateProperties.Items.Keys);
176              Assert.DoesNotContain("login_hint", stateProperties.Items.Keys);
177          }
178          [Fact]
179          public async Task ChallengeWillUseAuthenticationPropertiesItemsAsParameters()
180          {
181              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
182              var server = CreateServer(o =>
183              {
184                  o.ClientId = "Test Id";
185                  o.ClientSecret = "Test Secret";
186                  o.StateDataFormat = stateFormat;
187              },
188              context =>
189              {
190                  var req = context.Request;
191                  var res = context.Response;
192                  if (req.Path == new PathString("/challenge2"))
193                  {
194                      return context.ChallengeAsync("Google", new AuthenticationProperties(new Dictionary<string, string>()
195                      {
196                          { "scope", "https:&bsol;&bsol;www.googleapis.com/auth/plus.login" },
197                          { "access_type", "offline" },
198                          { "approval_prompt", "force" },
199                          { "prompt", "consent" },
200                          { "login_hint", "test@example.com" },
201                          { "include_granted_scopes", "false" }
202                      }));
203                  }
204                  return Task.FromResult<object>(null);
205              });
206              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/challenge2");
207              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
208              var query = QueryHelpers.ParseQuery(transaction.Response.Headers.Location.Query);
209              Assert.Equal("https:&bsol;&bsol;www.googleapis.com/auth/plus.login", query["scope"]);
210              Assert.Equal("offline", query["access_type"]);
211              Assert.Equal("force", query["approval_prompt"]);
212              Assert.Equal("consent", query["prompt"]);
213              Assert.Equal("false", query["include_granted_scopes"]);
214              Assert.Equal("test@example.com", query["login_hint"]);
215              var stateProperties = stateFormat.Unprotect(query["state"]);
216              Assert.DoesNotContain("scope", stateProperties.Items.Keys);
217              Assert.DoesNotContain("access_type", stateProperties.Items.Keys);
218              Assert.DoesNotContain("include_granted_scopes", stateProperties.Items.Keys);
219              Assert.DoesNotContain("approval_prompt", stateProperties.Items.Keys);
220              Assert.DoesNotContain("prompt", stateProperties.Items.Keys);
221              Assert.DoesNotContain("login_hint", stateProperties.Items.Keys);
222          }
223          [Fact]
224          public async Task ChallengeWillUseAuthenticationPropertiesItemsAsQueryArgumentsButParametersWillOverwrite()
225          {
226              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
227              var server = CreateServer(o =>
228              {
229                  o.ClientId = "Test Id";
230                  o.ClientSecret = "Test Secret";
231                  o.StateDataFormat = stateFormat;
232              },
233              context =>
234              {
235                  var req = context.Request;
236                  var res = context.Response;
237                  if (req.Path == new PathString("/challenge2"))
238                  {
239                      return context.ChallengeAsync("Google", new GoogleChallengeProperties(new Dictionary<string, string>
240                      {
241                          ["scope"] = "https:&bsol;&bsol;www.googleapis.com/auth/plus.login",
242                          ["access_type"] = "offline",
243                          ["include_granted_scopes"] = "false",
244                          ["approval_prompt"] = "force",
245                          ["prompt"] = "login",
246                          ["login_hint"] = "this-will-be-overwritten@example.com",
247                      })
248                      {
249                          Prompt = "consent",
250                          LoginHint = "test@example.com",
251                      });
252                  }
253                  return Task.FromResult<object>(null);
254              });
255              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/challenge2");
256              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
257              var query = QueryHelpers.ParseQuery(transaction.Response.Headers.Location.Query);
258              Assert.Equal("https:&bsol;&bsol;www.googleapis.com/auth/plus.login", query["scope"]);
259              Assert.Equal("offline", query["access_type"]);
260              Assert.Equal("force", query["approval_prompt"]);
261              Assert.Equal("consent", query["prompt"]);
262              Assert.Equal("false", query["include_granted_scopes"]);
263              Assert.Equal("test@example.com", query["login_hint"]);
264              var stateProperties = stateFormat.Unprotect(query["state"]);
265              Assert.DoesNotContain("scope", stateProperties.Items.Keys);
266              Assert.DoesNotContain("access_type", stateProperties.Items.Keys);
267              Assert.DoesNotContain("include_granted_scopes", stateProperties.Items.Keys);
268              Assert.DoesNotContain("approval_prompt", stateProperties.Items.Keys);
269              Assert.DoesNotContain("prompt", stateProperties.Items.Keys);
270              Assert.DoesNotContain("login_hint", stateProperties.Items.Keys);
271          }
272          [Fact]
273          public async Task ChallengeWillTriggerApplyRedirectEvent()
274          {
275              var server = CreateServer(o =>
276              {
277                  o.ClientId = "Test Id";
278                  o.ClientSecret = "Test Secret";
279                  o.Events = new OAuthEvents
280                  {
281                      OnRedirectToAuthorizationEndpoint = context =>
282                      {
283                          context.Response.Redirect(context.RedirectUri + "&custom=test");
284                          return Task.FromResult(0);
285                      }
286                  };
287              });
288              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/challenge");
289              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
290              var query = transaction.Response.Headers.Location.Query;
291              Assert.Contains("custom=test", query);
292          }
293          [Fact]
294          public async Task AuthenticateWithoutCookieWillFail()
295          {
296              var server = CreateServer(o =>
297              {
298                  o.ClientId = "Test Id";
299                  o.ClientSecret = "Test Secret";
300              },
301              async context =>
302              {
303                  var req = context.Request;
304                  var res = context.Response;
305                  if (req.Path == new PathString("/auth"))
306                  {
307                      var result = await context.AuthenticateAsync("Google");
308                      Assert.NotNull(result.Failure);
309                  }
310              });
311              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/auth");
312              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
313          }
314          [Fact]
315          public async Task ReplyPathWithoutStateQueryStringWillBeRejected()
316          {
317              var server = CreateServer(o =>
318              {
319                  o.ClientId = "Test Id";
320                  o.ClientSecret = "Test Secret";
321              });
322              var error = await Assert.ThrowsAnyAsync<Exception>(() => server.SendAsync("https:&bsol;&bsol;example.com/signin-google?code=TestCode"));
323              Assert.Equal("The oauth state was missing or invalid.", error.GetBaseException().Message);
324          }
325          [Theory]
326          [InlineData(true)]
327          [InlineData(false)]
328          public async Task ReplyPathWithAccessDeniedErrorFails(bool redirect)
329          {
330              var server = CreateServer(o =>
331              {
332                  o.ClientId = "Test Id";
333                  o.ClientSecret = "Test Secret";
334                  o.StateDataFormat = new TestStateDataFormat();
335                  o.Events = redirect ? new OAuthEvents()
336                  {
337                      OnAccessDenied = ctx =>
338                      {
339                          ctx.Response.Redirect("/error?FailureMessage=AccessDenied");
340                          ctx.HandleResponse();
341                          return Task.FromResult(0);
342                      }
343                  } : new OAuthEvents();
344              });
345              var sendTask = server.SendAsync("https:&bsol;&bsol;example.com/signin-google?error=access_denied&error_description=SoBad&error_uri=foobar&state=protected_state",
346                  ".AspNetCore.Correlation.Google.correlationId=N");
347              if (redirect)
348              {
349                  var transaction = await sendTask;
350                  Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
351                  Assert.Equal("/error?FailureMessage=AccessDenied", transaction.Response.Headers.GetValues("Location").First());
352              }
353              else
354              {
355                  var error = await Assert.ThrowsAnyAsync<Exception>(() => sendTask);
356                  Assert.Equal("Access was denied by the resource owner or by the remote server.", error.GetBaseException().Message);
357              }
358          }
359          [Fact]
360          public async Task ReplyPathWithAccessDeniedError_AllowsCustomizingPath()
361          {
362              var server = CreateServer(o =>
363              {
364                  o.ClientId = "Test Id";
365                  o.ClientSecret = "Test Secret";
366                  o.StateDataFormat = new TestStateDataFormat();
367                  o.AccessDeniedPath = "/access-denied";
368                  o.Events = new OAuthEvents()
369                  {
370                      OnAccessDenied = ctx =>
371                      {
372                          Assert.Equal("/access-denied", ctx.AccessDeniedPath.Value);
373                          Assert.Equal("http:&bsol;&bsol;testhost/redirect", ctx.ReturnUrl);
374                          Assert.Equal("ReturnUrl", ctx.ReturnUrlParameter);
375                          ctx.AccessDeniedPath = "/custom-denied-page";
376                          ctx.ReturnUrl = "http:&bsol;&bsol;www.google.com/";
377                          ctx.ReturnUrlParameter = "rurl";
378                          return Task.FromResult(0);
379                      }
380                  };
381              });
382              var transaction = await server.SendAsync("https:&bsol;&bsol;example.com/signin-google?error=access_denied&error_description=SoBad&error_uri=foobar&state=protected_state",
383                  ".AspNetCore.Correlation.Google.correlationId=N");
384              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
385              Assert.Equal("/custom-denied-page?rurl=http%3A%2F%2Fwww.google.com%2F", transaction.Response.Headers.GetValues("Location").First());
386          }
387          [Theory]
388          [InlineData(true)]
389          [InlineData(false)]
390          public async Task ReplyPathWithErrorFails(bool redirect)
391          {
392              var server = CreateServer(o =>
393              {
394                  o.ClientId = "Test Id";
395                  o.ClientSecret = "Test Secret";
396                  o.StateDataFormat = new TestStateDataFormat();
397                  o.Events = redirect ? new OAuthEvents()
398                  {
399                      OnRemoteFailure = ctx =>
400                      {
401                          ctx.Response.Redirect("/error?FailureMessage=" + UrlEncoder.Default.Encode(ctx.Failure.Message));
402                          ctx.HandleResponse();
403                          return Task.FromResult(0);
404                      }
405                  } : new OAuthEvents();
406              });
<span onclick='openModal()' class='match'>407              var sendTask = server.SendAsync("https:&bsol;&bsol;example.com/signin-google?error=OMG&error_description=SoBad&error_uri=foobar&state=protected_state",
408                  ".AspNetCore.Correlation.Google.correlationId=N");
409              if (redirect)
</span>410              {
411                  var transaction = await sendTask;
412                  Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
413                  Assert.Equal("/error?FailureMessage=OMG" + UrlEncoder.Default.Encode(";Description=SoBad;Uri=foobar"), transaction.Response.Headers.GetValues("Location").First());
414              }
415              else
416              {
417                  var error = await Assert.ThrowsAnyAsync<Exception>(() => sendTask);
418                  Assert.Equal("OMG;Description=SoBad;Uri=foobar", error.GetBaseException().Message);
419              }
420          }
421          [Theory]
422          [InlineData(null)]
423          [InlineData("CustomIssuer")]
424          public async Task ReplyPathWillAuthenticateValidAuthorizeCodeAndState(string claimsIssuer)
425          {
426              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
427              var server = CreateServer(o =>
428              {
429                  o.ClientId = "Test Id";
430                  o.ClientSecret = "Test Secret";
431                  o.SaveTokens = true;
432                  o.StateDataFormat = stateFormat;
433                  if (claimsIssuer != null)
434                  {
435                      o.ClaimsIssuer = claimsIssuer;
436                  }
437                  o.BackchannelHttpHandler = new TestHttpMessageHandler
438                  {
439                      Sender = req =>
440                      {
441                          if (req.RequestUri.AbsoluteUri == "https:&bsol;&bsol;www.googleapis.com/oauth2/v4/token")
442                          {
443                              return ReturnJsonResponse(new
444                              {
445                                  access_token = "Test Access Token",
446                                  expires_in = 3600,
447                                  token_type = "Bearer"
448                              });
449                          }
450                          else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == "https:&bsol;&bsol;www.googleapis.com/plus/v1/people/me")
451                          {
452                              return ReturnJsonResponse(new
453                              {
454                                  id = "Test User ID",
455                                  displayName = "Test Name",
456                                  name = new
457                                  {
458                                      familyName = "Test Family Name",
459                                      givenName = "Test Given Name"
460                                  },
461                                  url = "Profile link",
462                                  emails = new[]
463                                  {
464                                      new
465                                      {
466                                          value = "Test email",
467                                          type = "account"
468                                      }
469                                  }
470                              });
471                          }
472                          throw new NotImplementedException(req.RequestUri.AbsoluteUri);
473                      }
474                  };
475              });
476              var properties = new AuthenticationProperties();
477              var correlationKey = ".xsrf";
478              var correlationValue = "TestCorrelationId";
479              properties.Items.Add(correlationKey, correlationValue);
480              properties.RedirectUri = "/me";
481              var state = stateFormat.Protect(properties);
482              var transaction = await server.SendAsync(
483                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
484                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
485              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
486              Assert.Equal("/me", transaction.Response.Headers.GetValues("Location").First());
487              Assert.Equal(2, transaction.SetCookie.Count);
488              Assert.Contains($".AspNetCore.Correlation.Google.{correlationValue}", transaction.SetCookie[0]);
489              Assert.Contains(".AspNetCore." + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
490              var authCookie = transaction.AuthenticationCookieValue;
491              transaction = await server.SendAsync("https:&bsol;&bsol;example.com/me", authCookie);
492              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
493              var expectedIssuer = claimsIssuer ?? GoogleDefaults.AuthenticationScheme;
494              Assert.Equal("Test Name", transaction.FindClaimValue(ClaimTypes.Name, expectedIssuer));
495              Assert.Equal("Test User ID", transaction.FindClaimValue(ClaimTypes.NameIdentifier, expectedIssuer));
496              Assert.Equal("Test Given Name", transaction.FindClaimValue(ClaimTypes.GivenName, expectedIssuer));
497              Assert.Equal("Test Family Name", transaction.FindClaimValue(ClaimTypes.Surname, expectedIssuer));
498              Assert.Equal("Test email", transaction.FindClaimValue(ClaimTypes.Email, expectedIssuer));
499              Assert.Equal("yup", transaction.FindClaimValue("xform"));
500              transaction = await server.SendAsync("https:&bsol;&bsol;example.com/tokens", authCookie);
501              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
502              Assert.Equal("Test Access Token", transaction.FindTokenValue("access_token"));
503              Assert.Equal("Bearer", transaction.FindTokenValue("token_type"));
504              Assert.NotNull(transaction.FindTokenValue("expires_at"));
505          }
506          [Theory]
507          [InlineData(true)]
508          [InlineData(false)]
509          public async Task ReplyPathWillThrowIfCodeIsInvalid(bool redirect)
510          {
511              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
512              var server = CreateServer(o =>
513              {
514                  o.ClientId = "Test Id";
515                  o.ClientSecret = "Test Secret";
516                  o.StateDataFormat = stateFormat;
517                  o.BackchannelHttpHandler = new TestHttpMessageHandler
518                  {
519                      Sender = req =>
520                      {
521                          return ReturnJsonResponse(new { Error = "Error" },
522                              HttpStatusCode.BadRequest);
523                      }
524                  };
525                  o.Events = redirect ? new OAuthEvents()
526                  {
527                      OnRemoteFailure = ctx =>
528                      {
529                          ctx.Response.Redirect("/error?FailureMessage=" + UrlEncoder.Default.Encode(ctx.Failure.Message));
530                          ctx.HandleResponse();
531                          return Task.FromResult(0);
532                      }
533                  } : new OAuthEvents();
534              });
535              var properties = new AuthenticationProperties();
536              var correlationKey = ".xsrf";
537              var correlationValue = "TestCorrelationId";
538              properties.Items.Add(correlationKey, correlationValue);
539              properties.RedirectUri = "/me";
540              var state = stateFormat.Protect(properties);
541              var sendTask = server.SendAsync(
542                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
543                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
544              if (redirect)
545              {
546                  var transaction = await sendTask;
547                  Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
548                  Assert.Equal("/error?FailureMessage=" + UrlEncoder.Default.Encode("OAuth token endpoint failure: Status: BadRequest;Headers: ;Body: {\"Error\":\"Error\"};"),
549                      transaction.Response.Headers.GetValues("Location").First());
550              }
551              else
552              {
553                  var error = await Assert.ThrowsAnyAsync<Exception>(() => sendTask);
554                  Assert.Equal("OAuth token endpoint failure: Status: BadRequest;Headers: ;Body: {\"Error\":\"Error\"};", error.GetBaseException().Message);
555              }
556          }
557          [Theory]
558          [InlineData(true)]
559          [InlineData(false)]
560          public async Task ReplyPathWillRejectIfAccessTokenIsMissing(bool redirect)
561          {
562              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
563              var server = CreateServer(o =>
564              {
565                  o.ClientId = "Test Id";
566                  o.ClientSecret = "Test Secret";
567                  o.StateDataFormat = stateFormat;
568                  o.BackchannelHttpHandler = new TestHttpMessageHandler
569                  {
570                      Sender = req =>
571                      {
572                          return ReturnJsonResponse(new object());
573                      }
574                  };
575                  o.Events = redirect ? new OAuthEvents()
576                  {
577                      OnRemoteFailure = ctx =>
578                      {
579                          ctx.Response.Redirect("/error?FailureMessage=" + UrlEncoder.Default.Encode(ctx.Failure.Message));
580                          ctx.HandleResponse();
581                          return Task.FromResult(0);
582                      }
583                  } : new OAuthEvents();
584              });
585              var properties = new AuthenticationProperties();
586              var correlationKey = ".xsrf";
587              var correlationValue = "TestCorrelationId";
588              properties.Items.Add(correlationKey, correlationValue);
589              properties.RedirectUri = "/me";
590              var state = stateFormat.Protect(properties);
591              var sendTask = server.SendAsync(
592                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
593                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
594              if (redirect)
595              {
596                  var transaction = await sendTask;
597                  Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
598                  Assert.Equal("/error?FailureMessage=" + UrlEncoder.Default.Encode("Failed to retrieve access token."),
599                      transaction.Response.Headers.GetValues("Location").First());
600              }
601              else
602              {
603                  var error = await Assert.ThrowsAnyAsync<Exception>(() => sendTask);
604                  Assert.Equal("Failed to retrieve access token.", error.GetBaseException().Message);
605              }
606          }
607          [Fact]
608          public async Task AuthenticatedEventCanGetRefreshToken()
609          {
610              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
611              var server = CreateServer(o =>
612              {
613                  o.ClientId = "Test Id";
614                  o.ClientSecret = "Test Secret";
615                  o.StateDataFormat = stateFormat;
616                  o.BackchannelHttpHandler = new TestHttpMessageHandler
617                  {
618                      Sender = req =>
619                      {
620                          if (req.RequestUri.AbsoluteUri == "https:&bsol;&bsol;www.googleapis.com/oauth2/v4/token")
621                          {
622                              return ReturnJsonResponse(new
623                              {
624                                  access_token = "Test Access Token",
625                                  expires_in = 3600,
626                                  token_type = "Bearer",
627                                  refresh_token = "Test Refresh Token"
628                              });
629                          }
630                          else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == "https:&bsol;&bsol;www.googleapis.com/plus/v1/people/me")
631                          {
632                              return ReturnJsonResponse(new
633                              {
634                                  id = "Test User ID",
635                                  displayName = "Test Name",
636                                  name = new
637                                  {
638                                      familyName = "Test Family Name",
639                                      givenName = "Test Given Name"
640                                  },
641                                  url = "Profile link",
642                                  emails = new[]
643                                      {
644                                          new
645                                          {
646                                              value = "Test email",
647                                              type = "account"
648                                          }
649                                      }
650                              });
651                          }
652                          throw new NotImplementedException(req.RequestUri.AbsoluteUri);
653                      }
654                  };
655                  o.Events = new OAuthEvents
656                  {
657                      OnCreatingTicket = context =>
658                      {
659                          var refreshToken = context.RefreshToken;
660                          context.Principal.AddIdentity(new ClaimsIdentity(new Claim[] { new Claim("RefreshToken", refreshToken, ClaimValueTypes.String, "Google") }, "Google"));
661                          return Task.FromResult(0);
662                      }
663                  };
664              });
665              var properties = new AuthenticationProperties();
666              var correlationKey = ".xsrf";
667              var correlationValue = "TestCorrelationId";
668              properties.Items.Add(correlationKey, correlationValue);
669              properties.RedirectUri = "/me";
670              var state = stateFormat.Protect(properties);
671              var transaction = await server.SendAsync(
672                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
673                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
674              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
675              Assert.Equal("/me", transaction.Response.Headers.GetValues("Location").First());
676              Assert.Equal(2, transaction.SetCookie.Count);
677              Assert.Contains($".AspNetCore.Correlation.Google.{correlationValue}", transaction.SetCookie[0]);
678              Assert.Contains(".AspNetCore." + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
679              var authCookie = transaction.AuthenticationCookieValue;
680              transaction = await server.SendAsync("https:&bsol;&bsol;example.com/me", authCookie);
681              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
682              Assert.Equal("Test Refresh Token", transaction.FindClaimValue("RefreshToken"));
683          }
684          [Fact]
685          public async Task NullRedirectUriWillRedirectToSlash()
686          {
687              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
688              var server = CreateServer(o =>
689              {
690                  o.ClientId = "Test Id";
691                  o.ClientSecret = "Test Secret";
692                  o.StateDataFormat = stateFormat;
693                  o.BackchannelHttpHandler = new TestHttpMessageHandler
694                  {
695                      Sender = req =>
696                      {
697                          if (req.RequestUri.AbsoluteUri == "https:&bsol;&bsol;www.googleapis.com/oauth2/v4/token")
698                          {
699                              return ReturnJsonResponse(new
700                              {
701                                  access_token = "Test Access Token",
702                                  expires_in = 3600,
703                                  token_type = "Bearer",
704                                  refresh_token = "Test Refresh Token"
705                              });
706                          }
707                          else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == "https:&bsol;&bsol;www.googleapis.com/plus/v1/people/me")
708                          {
709                              return ReturnJsonResponse(new
710                              {
711                                  id = "Test User ID",
712                                  displayName = "Test Name",
713                                  name = new
714                                  {
715                                      familyName = "Test Family Name",
716                                      givenName = "Test Given Name"
717                                  },
718                                  url = "Profile link",
719                                  emails = new[]
720                                      {
721                                          new
722                                          {
723                                              value = "Test email",
724                                              type = "account"
725                                          }
726                                      }
727                              });
728                          }
729                          throw new NotImplementedException(req.RequestUri.AbsoluteUri);
730                      }
731                  };
732                  o.Events = new OAuthEvents
733                  {
734                      OnTicketReceived = context =>
735                      {
736                          context.Properties.RedirectUri = null;
737                          return Task.FromResult(0);
738                      }
739                  };
740              });
741              var properties = new AuthenticationProperties();
742              var correlationKey = ".xsrf";
743              var correlationValue = "TestCorrelationId";
744              properties.Items.Add(correlationKey, correlationValue);
745              var state = stateFormat.Protect(properties);
746              var transaction = await server.SendAsync(
747                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
748                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
749              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
750              Assert.Equal("/", transaction.Response.Headers.GetValues("Location").First());
751              Assert.Equal(2, transaction.SetCookie.Count);
752              Assert.Contains($".AspNetCore.Correlation.Google.{correlationValue}", transaction.SetCookie[0]);
753              Assert.Contains(".AspNetCore." + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
754          }
755          [Fact]
756          public async Task ValidateAuthenticatedContext()
757          {
758              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
759              var server = CreateServer(o =>
760              {
761                  o.ClientId = "Test Id";
762                  o.ClientSecret = "Test Secret";
763                  o.StateDataFormat = stateFormat;
764                  o.AccessType = "offline";
765                  o.Events = new OAuthEvents()
766                  {
767                      OnCreatingTicket = context =>
768                      {
769                          Assert.NotNull(context.User);
770                          Assert.Equal("Test Access Token", context.AccessToken);
771                          Assert.Equal("Test Refresh Token", context.RefreshToken);
772                          Assert.Equal(TimeSpan.FromSeconds(3600), context.ExpiresIn);
773                          Assert.Equal("Test email", context.Identity.FindFirst(ClaimTypes.Email)?.Value);
774                          Assert.Equal("Test User ID", context.Identity.FindFirst(ClaimTypes.NameIdentifier)?.Value);
775                          Assert.Equal("Test Name", context.Identity.FindFirst(ClaimTypes.Name)?.Value);
776                          Assert.Equal("Test Family Name", context.Identity.FindFirst(ClaimTypes.Surname)?.Value);
777                          Assert.Equal("Test Given Name", context.Identity.FindFirst(ClaimTypes.GivenName)?.Value);
778                          return Task.FromResult(0);
779                      }
780                  };
781                  o.BackchannelHttpHandler = new TestHttpMessageHandler
782                  {
783                      Sender = req =>
784                      {
785                          if (req.RequestUri.AbsoluteUri == "https:&bsol;&bsol;www.googleapis.com/oauth2/v4/token")
786                          {
787                              return ReturnJsonResponse(new
788                              {
789                                  access_token = "Test Access Token",
790                                  expires_in = 3600,
791                                  token_type = "Bearer",
792                                  refresh_token = "Test Refresh Token"
793                              });
794                          }
795                          else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == "https:&bsol;&bsol;www.googleapis.com/plus/v1/people/me")
796                          {
797                              return ReturnJsonResponse(new
798                              {
799                                  id = "Test User ID",
800                                  displayName = "Test Name",
801                                  name = new
802                                  {
803                                      familyName = "Test Family Name",
804                                      givenName = "Test Given Name"
805                                  },
806                                  url = "Profile link",
807                                  emails = new[]
808                                      {
809                                          new
810                                          {
811                                              value = "Test email",
812                                              type = "account"
813                                          }
814                                      }
815                              });
816                          }
817                          throw new NotImplementedException(req.RequestUri.AbsoluteUri);
818                      }
819                  };
820              });
821              var properties = new AuthenticationProperties();
822              var correlationKey = ".xsrf";
823              var correlationValue = "TestCorrelationId";
824              properties.Items.Add(correlationKey, correlationValue);
825              properties.RedirectUri = "/foo";
826              var state = stateFormat.Protect(properties);
827              var transaction = await server.SendAsync(
828                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
829                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
830              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
831              Assert.Equal("/foo", transaction.Response.Headers.GetValues("Location").First());
832          }
833          [Fact]
834          public async Task NoStateCausesException()
835          {
836              var server = CreateServer(o =>
837              {
838                  o.ClientId = "Test Id";
839                  o.ClientSecret = "Test Secret";
840              });
841              var error = await Assert.ThrowsAnyAsync<Exception>(() => server.SendAsync("https:&bsol;&bsol;example.com/signin-google?code=TestCode"));
842              Assert.Equal("The oauth state was missing or invalid.", error.GetBaseException().Message);
843          }
844          [Fact]
845          public async Task CanRedirectOnError()
846          {
847              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
848              var server = CreateServer(o =>
849              {
850                  o.ClientId = "Test Id";
851                  o.ClientSecret = "Test Secret";
852                  o.Events = new OAuthEvents()
853                  {
854                      OnRemoteFailure = ctx =>
855                      {
856                          ctx.Response.Redirect("/error?FailureMessage=" + UrlEncoder.Default.Encode(ctx.Failure.Message));
857                          ctx.HandleResponse();
858                          return Task.FromResult(0);
859                      }
860                  };
861              });
862              var transaction = await server.SendAsync(
863                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode");
864              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
865              Assert.Equal("/error?FailureMessage=" + UrlEncoder.Default.Encode("The oauth state was missing or invalid."),
866                  transaction.Response.Headers.GetValues("Location").First());
867          }
868          [Fact]
869          public async Task AuthenticateAutomaticWhenAlreadySignedInSucceeds()
870          {
871              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
872              var server = CreateServer(o =>
873              {
874                  o.ClientId = "Test Id";
875                  o.ClientSecret = "Test Secret";
876                  o.StateDataFormat = stateFormat;
877                  o.SaveTokens = true;
878                  o.BackchannelHttpHandler = CreateBackchannel();
879              });
880              var properties = new AuthenticationProperties();
881              var correlationKey = ".xsrf";
882              var correlationValue = "TestCorrelationId";
883              properties.Items.Add(correlationKey, correlationValue);
884              properties.RedirectUri = "/me";
885              var state = stateFormat.Protect(properties);
886              var transaction = await server.SendAsync(
887                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
888                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
889              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
890              Assert.Equal("/me", transaction.Response.Headers.GetValues("Location").First());
891              Assert.Equal(2, transaction.SetCookie.Count);
892              Assert.Contains($".AspNetCore.Correlation.Google.{correlationValue}", transaction.SetCookie[0]); 
893              Assert.Contains(".AspNetCore." + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
894              var authCookie = transaction.AuthenticationCookieValue;
895              transaction = await server.SendAsync("https:&bsol;&bsol;example.com/authenticate", authCookie);
896              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
897              Assert.Equal("Test Name", transaction.FindClaimValue(ClaimTypes.Name));
898              Assert.Equal("Test User ID", transaction.FindClaimValue(ClaimTypes.NameIdentifier));
899              Assert.Equal("Test Given Name", transaction.FindClaimValue(ClaimTypes.GivenName));
900              Assert.Equal("Test Family Name", transaction.FindClaimValue(ClaimTypes.Surname));
901              Assert.Equal("Test email", transaction.FindClaimValue(ClaimTypes.Email));
902              Assert.Equal("yup", transaction.FindClaimValue("xform"));
903          }
904          [Fact]
905          public async Task AuthenticateGoogleWhenAlreadySignedInSucceeds()
906          {
907              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
908              var server = CreateServer(o =>
909              {
910                  o.ClientId = "Test Id";
911                  o.ClientSecret = "Test Secret";
912                  o.StateDataFormat = stateFormat;
913                  o.SaveTokens = true;
914                  o.BackchannelHttpHandler = CreateBackchannel();
915              });
916              var properties = new AuthenticationProperties();
917              var correlationKey = ".xsrf";
918              var correlationValue = "TestCorrelationId";
919              properties.Items.Add(correlationKey, correlationValue);
920              properties.RedirectUri = "/me";
921              var state = stateFormat.Protect(properties);
922              var transaction = await server.SendAsync(
923                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
924                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
925              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
926              Assert.Equal("/me", transaction.Response.Headers.GetValues("Location").First());
927              Assert.Equal(2, transaction.SetCookie.Count);
928              Assert.Contains($".AspNetCore.Correlation.Google.{correlationValue}", transaction.SetCookie[0]); 
929              Assert.Contains(".AspNetCore." + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
930              var authCookie = transaction.AuthenticationCookieValue;
931              transaction = await server.SendAsync("https:&bsol;&bsol;example.com/authenticateGoogle", authCookie);
932              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
933              Assert.Equal("Test Name", transaction.FindClaimValue(ClaimTypes.Name));
934              Assert.Equal("Test User ID", transaction.FindClaimValue(ClaimTypes.NameIdentifier));
935              Assert.Equal("Test Given Name", transaction.FindClaimValue(ClaimTypes.GivenName));
936              Assert.Equal("Test Family Name", transaction.FindClaimValue(ClaimTypes.Surname));
937              Assert.Equal("Test email", transaction.FindClaimValue(ClaimTypes.Email));
938              Assert.Equal("yup", transaction.FindClaimValue("xform"));
939          }
940          [Fact]
941          public async Task AuthenticateFacebookWhenAlreadySignedWithGoogleReturnsNull()
942          {
943              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
944              var server = CreateServer(o =>
945              {
946                  o.ClientId = "Test Id";
947                  o.ClientSecret = "Test Secret";
948                  o.StateDataFormat = stateFormat;
949                  o.SaveTokens = true;
950                  o.BackchannelHttpHandler = CreateBackchannel();
951              });
952              var properties = new AuthenticationProperties();
953              var correlationKey = ".xsrf";
954              var correlationValue = "TestCorrelationId";
955              properties.Items.Add(correlationKey, correlationValue);
956              properties.RedirectUri = "/me";
957              var state = stateFormat.Protect(properties);
958              var transaction = await server.SendAsync(
959                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
960                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
961              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
962              Assert.Equal("/me", transaction.Response.Headers.GetValues("Location").First());
963              Assert.Equal(2, transaction.SetCookie.Count);
964              Assert.Contains($".AspNetCore.Correlation.Google.{correlationValue}", transaction.SetCookie[0]); 
965              Assert.Contains(".AspNetCore." + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
966              var authCookie = transaction.AuthenticationCookieValue;
967              transaction = await server.SendAsync("https:&bsol;&bsol;example.com/authenticateFacebook", authCookie);
968              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
969              Assert.Null(transaction.FindClaimValue(ClaimTypes.Name));
970          }
971          [Fact]
972          public async Task ChallengeFacebookWhenAlreadySignedWithGoogleSucceeds()
973          {
974              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector("GoogleTest"));
975              var server = CreateServer(o =>
976              {
977                  o.ClientId = "Test Id";
978                  o.ClientSecret = "Test Secret";
979                  o.StateDataFormat = stateFormat;
980                  o.SaveTokens = true;
981                  o.BackchannelHttpHandler = CreateBackchannel();
982              });
983              var properties = new AuthenticationProperties();
984              var correlationKey = ".xsrf";
985              var correlationValue = "TestCorrelationId";
986              properties.Items.Add(correlationKey, correlationValue);
987              properties.RedirectUri = "/me";
988              var state = stateFormat.Protect(properties);
989              var transaction = await server.SendAsync(
990                  "https:&bsol;&bsol;example.com/signin-google?code=TestCode&state=" + UrlEncoder.Default.Encode(state),
991                  $".AspNetCore.Correlation.Google.{correlationValue}=N");
992              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
993              Assert.Equal("/me", transaction.Response.Headers.GetValues("Location").First());
994              Assert.Equal(2, transaction.SetCookie.Count);
995              Assert.Contains($".AspNetCore.Correlation.Google.{correlationValue}", transaction.SetCookie[0]); 
996              Assert.Contains(".AspNetCore." + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
997              var authCookie = transaction.AuthenticationCookieValue;
998              transaction = await server.SendAsync("https:&bsol;&bsol;example.com/challengeFacebook", authCookie);
999              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
1000              Assert.StartsWith("https:&bsol;&bsol;www.facebook.com/", transaction.Response.Headers.Location.OriginalString);
1001          }
1002          private HttpMessageHandler CreateBackchannel()
1003          {
1004              return new TestHttpMessageHandler()
1005              {
1006                  Sender = req =>
1007                  {
1008                      if (req.RequestUri.AbsoluteUri == "https:&bsol;&bsol;www.googleapis.com/oauth2/v4/token")
1009                      {
1010                          return ReturnJsonResponse(new
1011                          {
1012                              access_token = "Test Access Token",
1013                              expires_in = 3600,
1014                              token_type = "Bearer"
1015                          });
1016                      }
1017                      else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == "https:&bsol;&bsol;www.googleapis.com/plus/v1/people/me")
1018                      {
1019                          return ReturnJsonResponse(new
1020                          {
1021                              id = "Test User ID",
1022                              displayName = "Test Name",
1023                              name = new
1024                              {
1025                                  familyName = "Test Family Name",
1026                                  givenName = "Test Given Name"
1027                              },
1028                              url = "Profile link",
1029                              emails = new[]
1030                              {
1031                                  new
1032                                  {
1033                                      value = "Test email",
1034                                      type = "account"
1035                                  }
1036                              }
1037                          });
1038                      }
1039                      throw new NotImplementedException(req.RequestUri.AbsoluteUri);
1040                  }
1041              };
1042          }
1043          private static HttpResponseMessage ReturnJsonResponse(object content, HttpStatusCode code = HttpStatusCode.OK)
1044          {
1045              var res = new HttpResponseMessage(code);
1046              var text = JsonConvert.SerializeObject(content);
1047              res.Content = new StringContent(text, Encoding.UTF8, "application/json");
1048              return res;
1049          }
1050          private class ClaimsTransformer : IClaimsTransformation
1051          {
1052              public Task<ClaimsPrincipal> TransformAsync(ClaimsPrincipal p)
1053              {
1054                  if (!p.Identities.Any(i => i.AuthenticationType == "xform"))
1055                  {
1056                      var id = new ClaimsIdentity("xform");
1057                      id.AddClaim(new Claim("xform", "yup"));
1058                      p.AddIdentity(id);
1059                  }
1060                  return Task.FromResult(p);
1061              }
1062          }
1063          private static TestServer CreateServer(Action<GoogleOptions> configureOptions, Func<HttpContext, Task> testpath = null)
1064          {
1065              var builder = new WebHostBuilder()
1066                  .Configure(app =>
1067                  {
1068                      app.UseAuthentication();
1069                      app.Use(async (context, next) =>
1070                      {
1071                          var req = context.Request;
1072                          var res = context.Response;
1073                          if (req.Path == new PathString("/challenge"))
1074                          {
1075                              await context.ChallengeAsync();
1076                          }
1077                          else if (req.Path == new PathString("/challengeFacebook"))
1078                          {
1079                              await context.ChallengeAsync("Facebook");
1080                          }
1081                          else if (req.Path == new PathString("/tokens"))
1082                          {
1083                              var result = await context.AuthenticateAsync(TestExtensions.CookieAuthenticationScheme);
1084                              var tokens = result.Properties.GetTokens();
1085                              res.Describe(tokens);
1086                          }
1087                          else if (req.Path == new PathString("/me"))
1088                          {
1089                              res.Describe(context.User);
1090                          }
1091                          else if (req.Path == new PathString("/authenticate"))
1092                          {
1093                              var result = await context.AuthenticateAsync(TestExtensions.CookieAuthenticationScheme);
1094                              res.Describe(result.Principal);
1095                          }
1096                          else if (req.Path == new PathString("/authenticateGoogle"))
1097                          {
1098                              var result = await context.AuthenticateAsync("Google");
1099                              res.Describe(result?.Principal);
1100                          }
1101                          else if (req.Path == new PathString("/authenticateFacebook"))
1102                          {
1103                              var result = await context.AuthenticateAsync("Facebook");
1104                              res.Describe(result?.Principal);
1105                          }
1106                          else if (req.Path == new PathString("/unauthorized"))
1107                          {
1108                              var result = await context.AuthenticateAsync("Google");
1109                              await context.ChallengeAsync("Google");
1110                          }
1111                          else if (req.Path == new PathString("/unauthorizedAuto"))
1112                          {
1113                              var result = await context.AuthenticateAsync("Google");
1114                              await context.ChallengeAsync("Google");
1115                          }
1116                          else if (req.Path == new PathString("/401"))
1117                          {
1118                              res.StatusCode = 401;
1119                          }
1120                          else if (req.Path == new PathString("/signIn"))
1121                          {
1122                              await Assert.ThrowsAsync<InvalidOperationException>(() => context.SignInAsync("Google", new ClaimsPrincipal()));
1123                          }
1124                          else if (req.Path == new PathString("/signOut"))
1125                          {
1126                              await Assert.ThrowsAsync<InvalidOperationException>(() => context.SignOutAsync("Google"));
1127                          }
1128                          else if (req.Path == new PathString("/forbid"))
1129                          {
1130                              await Assert.ThrowsAsync<InvalidOperationException>(() => context.ForbidAsync("Google"));
1131                          }
1132                          else if (testpath != null)
1133                          {
1134                              await testpath(context);
1135                          }
1136                          else
1137                          {
1138                              await next();
1139                          }
1140                      });
1141                  })
1142                  .ConfigureServices(services =>
1143                  {
1144                      services.AddTransient<IClaimsTransformation, ClaimsTransformer>();
1145                      services.AddAuthentication(TestExtensions.CookieAuthenticationScheme)
1146                          .AddCookie(TestExtensions.CookieAuthenticationScheme, o => o.ForwardChallenge = GoogleDefaults.AuthenticationScheme)
1147                          .AddGoogle(configureOptions)
1148                          .AddFacebook(o =>
1149                          {
1150                              o.ClientId = "Test ClientId";
1151                              o.ClientSecret = "Test AppSecrent";
1152                          });
1153                  });
1154              return new TestServer(builder);
1155          }
1156          private class TestStateDataFormat : ISecureDataFormat<AuthenticationProperties>
1157          {
1158              private AuthenticationProperties Data { get; set; }
1159              public string Protect(AuthenticationProperties data)
1160              {
1161                  return "protected_state";
1162              }
1163              public string Protect(AuthenticationProperties data, string purpose)
1164              {
1165                  throw new NotImplementedException();
1166              }
1167              public AuthenticationProperties Unprotect(string protectedText)
1168              {
1169                  Assert.Equal("protected_state", protectedText);
1170                  var properties = new AuthenticationProperties(new Dictionary<string, string>()
1171                  {
1172                      { ".xsrf", "correlationId" },
1173                      { "testkey", "testvalue" }
1174                  });
1175                  properties.RedirectUri = "http:&bsol;&bsol;testhost/redirect";
1176                  return properties;
1177              }
1178              public AuthenticationProperties Unprotect(string protectedText, string purpose)
1179              {
1180                  throw new NotImplementedException();
1181              }
1182          }
1183      }
1184  }
</code></pre>
        </div>
        <div class="column">
            <h3>MudBlazor-MDEwOlJlcG9zaXRvcnkyODg0Mjg2NzY=-flat-FormTests.cs</h3>
            <pre><code>1  #pragma warning disable CS1998 
2  using System;
3  using System.Collections.Generic;
4  using System.Globalization;
5  using System.Linq;
6  using System.Linq.Expressions;
7  using System.Threading.Tasks;
8  using AngleSharp.Dom;
9  using Bunit;
10  using FluentAssertions;
11  using Microsoft.AspNetCore.Components;
12  using Microsoft.AspNetCore.Components.Forms;
13  using MudBlazor.Docs.Examples;
14  using MudBlazor.UnitTests.TestComponents;
15  using MudBlazor.UnitTests.TestComponents.Form;
16  using MudBlazor.Utilities;
17  using NUnit.Framework;
18  namespace MudBlazor.UnitTests.Components
19  {
20      [TestFixture]
21      public class FormTests : BunitTest
22      {
23          [Test]
24          public async Task FormIsValidTest()
25          {
26              var comp = Context.RenderComponent<FormIsValidTest>();
27              var form = comp.FindComponent<MudForm>().Instance;
28              var textFieldcomp = comp.FindComponent<MudTextField<string>>();
29              var textField = textFieldcomp.Instance;
30              form.IsValid.Should().Be(false);
31              textField.Error.Should().BeFalse();
32              textField.ErrorText.Should().BeNullOrEmpty();
33              textFieldcomp.Find("input").Change("Marilyn Manson");
34              form.IsValid.Should().Be(true);
35              form.Errors.Length.Should().Be(0);
36              textField.Error.Should().BeFalse();
37              textField.ErrorText.Should().BeNullOrEmpty();
38              textFieldcomp.Find("input").Change(null);
39              form.IsValid.Should().Be(false);
40              form.Errors.Length.Should().Be(1);
41              form.Errors[0].Should().Be("Enter a rock star");
42              textField.Error.Should().BeTrue();
43              textField.ErrorText.Should().Be("Enter a rock star");
44              textFieldcomp.Find("input").Change("");
45              form.IsValid.Should().Be(false);
46              form.Errors.Length.Should().Be(1);
47              form.Errors[0].Should().Be("Enter a rock star");
48              textField.Error.Should().BeTrue();
49              textField.ErrorText.Should().Be("Enter a rock star");
50              textFieldcomp.Find("input").Change("Kurt Cobain");
51              form.IsValid.Should().Be(true);
52              form.Errors.Length.Should().Be(0);
53              textField.Error.Should().BeFalse();
54              textField.ErrorText.Should().BeNullOrEmpty();
55          }
56          [Test]
57          public async Task FormIsValidTest2()
58          {
59              var comp = Context.RenderComponent<FormIsValidTest2>();
60              var form = comp.FindComponent<MudForm>().Instance;
61              var textFieldcomp = comp.FindComponent<MudTextField<string>>();
62              form.IsValid.Should().Be(true);
63              textFieldcomp.Find("input").Change("This value doesn't matter");
64              form.IsValid.Should().Be(true);
65          }
66          [Test]
67          public async Task FormIsValidTest3()
68          {
69              var comp = Context.RenderComponent<FormIsValidTest3>();
70              var form = comp.FindComponent<MudForm>().Instance;
71              var textFields = comp.FindComponents<MudTextField<string>>();
72              form.IsValid.Should().Be(false);
73              form.IsTouched.Should().Be(false);
74              comp.FindComponents<MudSwitch<bool>>()[0].Instance.Checked.Should().Be(false);
75              comp.FindComponents<MudSwitch<bool>>()[1].Instance.Checked.Should().Be(false);
76              textFields[1].Find("input").Change("Fill in the required field to make this form valid");
77              form.IsValid.Should().Be(true);
78              comp.FindComponents<MudSwitch<bool>>()[0].Instance.Checked.Should().Be(true);
79              comp.FindComponents<MudSwitch<bool>>()[1].Instance.Checked.Should().Be(true);
80          }
81          [Test]
82          public async Task FormIsValidTest4()
83          {
84              var comp = Context.RenderComponent<FormIsValidTest4>();
85              var form = comp.FindComponent<MudForm>().Instance;
86              comp.WaitForAssertion(() => form.IsValid.Should().Be(true));
87              comp.WaitForAssertion(() => comp.FindComponent<MudSwitch<bool>>().Instance.Checked.Should().Be(true));
88          }
89          [Test]
90          public async Task FormIsTouchedTest()
91          {
92              var comp = Context.RenderComponent<FormIsTouchedTest>();
93              var form = comp.FindComponent<MudForm>().Instance;
94              var textFieldcomp = comp.FindComponent<MudTextField<string>>();
95              var textField = textFieldcomp.Instance;
96              var dateComp = comp.FindComponent<MudDatePicker>();
97              var dateField = dateComp.Instance;
98              form.IsTouched.Should().Be(false);
99              dateComp.Find("input").Change("2001-01-31");
100              form.IsTouched.Should().Be(true);
101              await comp.InvokeAsync(() => form.ResetAsync());
102              form.IsTouched.Should().Be(false);
103              textFieldcomp.Find("input").Change("value is changed");
104              form.IsTouched.Should().Be(true);
105              await comp.InvokeAsync(() => form.ResetValidation());
106              form.IsTouched.Should().Be(true);
107          }
108          [Test]
109          public async Task FormIsTouchedAndNestedFormIsNotTouchedWhenParentFormFieldIsTouchedTest()
110          {
111              var comp = Context.RenderComponent<FormIsTouchedNestedTest>();
112              var formsComp = comp.FindComponents<MudForm>();
113              var textCompFields = comp.FindComponents<MudTextField<string>>();
114              var dateCompFields = comp.FindComponents<MudDatePicker>();
115              var form = formsComp[0].Instance;
116              var textField = textCompFields[0].Instance;
117              var dateField = dateCompFields[0].Instance;
118              var nestedForm = formsComp[1].Instance;
119              var nestedFormTextField = textCompFields[1].Instance;
120              var nestedFormDateField = dateCompFields[1].Instance;
121              form.IsTouched.Should().Be(false);
122              nestedForm.IsTouched.Should().Be(false);
123              textCompFields[0].Find("input").Change("2001-01-31");
124              form.IsTouched.Should().Be(true);
125              nestedForm.IsTouched.Should().Be(false);
126              await comp.InvokeAsync(() => form.ResetAsync());
127              form.IsTouched.Should().Be(false);
128              nestedForm.IsTouched.Should().Be(false);
129              textCompFields[0].Find("input").Change("value is changed");
130              form.IsTouched.Should().Be(true);
131              nestedForm.IsTouched.Should().Be(false);
132              await comp.InvokeAsync(() => form.ResetValidation());
133              form.IsTouched.Should().Be(true);
134              nestedForm.IsTouched.Should().Be(false);
135          }
136          [Test]
137          public async Task FormIsUnTouchedWhenNestedFormTouchedTest()
138          {
139              var comp = Context.RenderComponent<FormIsTouchedNestedTest>();
140              var formsComp = comp.FindComponents<MudForm>();
141              var textCompFields = comp.FindComponents<MudTextField<string>>();
142              var dateCompFields = comp.FindComponents<MudDatePicker>();
143              var form = formsComp[0].Instance;
144              var textField = textCompFields[0].Instance;
145              var dateField = dateCompFields[0].Instance;
146              var nestedForm = formsComp[1].Instance;
147              var nestedFormTextField = textCompFields[1].Instance;
148              var nestedFormDateField = dateCompFields[1].Instance;
149              form.IsTouched.Should().Be(false);
150              nestedForm.IsTouched.Should().Be(false);
151              textCompFields[1].Find("input").Change("2001-01-31");
152              form.IsTouched.Should().Be(true);
153              nestedForm.IsTouched.Should().Be(true);
154              await comp.InvokeAsync(() => form.ResetAsync());
155              form.IsTouched.Should().Be(false);
156              nestedForm.IsTouched.Should().Be(false);
157              textCompFields[3].Find("input").Change("value is changed");
158              form.IsTouched.Should().Be(false);
159              nestedForm.IsTouched.Should().Be(true);
160              await comp.InvokeAsync(() => nestedFormDateField.ResetValidation());
161              form.IsTouched.Should().Be(false);
162              nestedForm.IsTouched.Should().Be(true);
163          }
164          [Test]
165          public async Task FormValidationTest1()
166          {
167              var validationFunc = new Func<string, bool>(x => x?.StartsWith("Marilyn") == true);
168              var comp = Context.RenderComponent<FormValidationTest>(ComponentParameter.CreateParameter("validation", validationFunc));
169              var form = comp.FindComponent<MudForm>().Instance;
170              var textFieldcomp = comp.FindComponent<MudTextField<string>>();
171              var textField = textFieldcomp.Instance;
172              form.IsValid.Should().Be(false);
173              textField.Error.Should().BeFalse();
174              textField.ErrorText.Should().BeNullOrEmpty();
175              textFieldcomp.Find("input").Change("Marilyn Manson");
176              form.IsValid.Should().Be(true);
177              form.Errors.Length.Should().Be(0);
178              textField.Error.Should().BeFalse();
179              textField.ErrorText.Should().BeNullOrEmpty();
180              textFieldcomp.Find("input").Change("Kurt Cobain");
181              form.IsValid.Should().Be(false);
182              form.Errors.Length.Should().Be(1);
183              textField.Error.Should().BeTrue();
184              textField.ErrorText.Should().Be("Invalid");
185              textFieldcomp.Find("input").Change("Marilyn Monroe");
186              form.IsValid.Should().Be(true);
187              form.Errors.Length.Should().Be(0);
188              textField.Error.Should().BeFalse();
189              textField.ErrorText.Should().BeNullOrEmpty();
190          }
191          [Test]
192          public async Task FormValidationTest2()
193          {
194              var validationFunc = new Func<string, string>(s =>
195              {
196                  if (!(s.StartsWith("Marilyn") || s.EndsWith("Manson")))
197                      return "Not a star!";
198                  return null;
199              });
200              var comp = Context.RenderComponent<FormValidationTest>(ComponentParameter.CreateParameter("validation", validationFunc));
201              var form = comp.FindComponent<MudForm>().Instance;
202              var textFieldcomp = comp.FindComponent<MudTextField<string>>();
203              form.IsValid.Should().Be(false);
204              textFieldcomp.Find("input").Change("Marilyn Manson");
205              form.IsValid.Should().Be(true);
206              textFieldcomp.Find("input").Change("Charles Manson");
207              form.IsValid.Should().Be(true);
208              textFieldcomp.Find("input").Change("Marilyn Monroe");
209              form.IsValid.Should().Be(true);
210              textFieldcomp.Find("input").Change("Manson Marilyn");
211              form.IsValid.Should().Be(false);
212          }
213          [Test]
214          public async Task FormValidationTest3()
215          {
216              var comp = Context.RenderComponent<FormValidationTest>();
217              var form = comp.FindComponent<MudForm>().Instance;
218              var textFieldcomp = comp.FindComponent<MudTextField<string>>();
219              var textField = textFieldcomp.Instance;
220              form.IsValid.Should().Be(false);
221              textFieldcomp.Find("input").Change("Some value");
222              form.IsValid.Should().Be(true);
223              await comp.InvokeAsync(() => form.ResetAsync());
224              textField.Value.Should().Be(null);
225              textField.Text.Should().Be(null);
226              form.IsValid.Should().Be(false); 
227          }
228          [Test]
229          public async Task FormAsyncValidationTest()
230          {
231              const int ValidDelay = 100;
232              const int InvalidDelay = 200;
233              var validationFunc = new Func<string, Task<string>>(async s =>
234              {
235                  if (s == null)
236                      return null;
237                  var valid = (s == "abc");
238                  await Task.Delay(valid ? ValidDelay : InvalidDelay);
239                  return valid ? null : "invalid";
240              });
241              var comp = Context.RenderComponent<FormValidationTest>(ComponentParameter.CreateParameter("validation", validationFunc));
242              var textFieldComp = comp.FindComponent<MudTextField<string>>();
243              var textField = textFieldComp.Instance;
244              textField.ValidationErrors.Should().BeEmpty();
245              textFieldComp.Find("input").Change("def");
246              comp.WaitForAssertion(() => textField.ValidationErrors.Should().ContainSingle("invalid"), TimeSpan.FromSeconds(5));
247              textFieldComp.Find("input").Change("abc");
248              comp.WaitForAssertion(() => textField.ValidationErrors.Should().BeEmpty(), TimeSpan.FromSeconds(5));
249              textFieldComp.Find("input").Change("def");
250              textFieldComp.Find("input").Change("abc");
251              comp.WaitForAssertion(() => textField.ValidationErrors.Should().BeEmpty(), TimeSpan.FromSeconds(5));
252          }
253          [Test]
254          public async Task EditFormOnFieldChangedTest()
255          {
256              var comp = Context.RenderComponent<EditFormOnFieldChangedTest>();
257              var textFields = comp.FindAll("input");
258              textFields.Count.Should().Be(3);
259              var chips = comp.FindAll("span.mud-chip-content");
260              chips.Count.Should().Be(3);
261              foreach (var chip in chips)
262                  chip.TextContent.Trim().Should().EndWith("not changed");
263              comp.FindAll("input")[0].Change(new ChangeEventArgs() { Value = "asdf" });
264              comp.FindAll("input")[0].Blur();
265              comp.FindComponents<MudTextField<string>>()[0].Instance.Text.Should().Be("asdf");
266              comp.FindAll("span.mud-chip-content")[0].TextContent.Trim().Should().Be("Field1 changed");
267              comp.FindAll("span.mud-chip-content")[1].TextContent.Trim().Should().EndWith("not changed");
268              comp.FindAll("span.mud-chip-content")[2].TextContent.Trim().Should().EndWith("not changed");
269              comp.FindAll("input")[1].Change(new ChangeEventArgs() { Value = "yxcv" });
270              comp.FindAll("input")[1].Blur();
271              comp.FindComponents<MudTextField<string>>()[1].Instance.Text.Should().Be("yxcv");
272              comp.FindAll("span.mud-chip-content")[0].TextContent.Trim().Should().Be("Field1 changed");
273              comp.FindAll("span.mud-chip-content")[1].TextContent.Trim().Should().EndWith("not changed", "Because it has no For, so the change can not be forwarded to the edit context for lack of a FieldIdentifier");
274              comp.FindAll("span.mud-chip-content")[2].TextContent.Trim().Should().EndWith("not changed");
275              comp.FindAll("input")[2].Change(new ChangeEventArgs() { Value = "qwer" });
276              comp.FindAll("input")[2].Blur();
277              comp.FindComponents<MudTextField<string>>()[2].Instance.Text.Should().Be("qwer");
278              comp.FindAll("span.mud-chip-content")[0].TextContent.Trim().Should().Be("Field1 changed");
279              comp.FindAll("span.mud-chip-content")[1].TextContent.Trim().Should().EndWith("not changed");
280              comp.FindAll("span.mud-chip-content")[2].TextContent.Trim().Should().EndWith("Field3 changed");
281          }
282          [Test]
283          public async Task FormWithCheckboxTest()
284          {
285              var comp = Context.RenderComponent<FormWithCheckboxTest>();
286              var textFields = comp.FindAll("input");
287              textFields.Count.Should().Be(4); 
288              comp.FindAll("input")[0].Change("Garfield");
289              comp.FindAll("input")[0].Blur();
290              comp.FindAll("input")[1].Change("Jon");
291              comp.FindAll("input")[1].Blur();
292              comp.FindAll("input")[2].Change("17"); 
293              comp.FindAll("input")[2].Blur();
294              foreach (var tf in comp.FindComponents<MudTextField<string>>())
295                  tf.Instance.Text.Should().NotBeNullOrEmpty();
296              comp.FindComponent<MudTextField<int>>().Instance.Value.Should().Be(17);
297              comp.FindComponent<MudCheckBox<bool>>().Instance.Checked.Should().Be(true);
298              comp.FindAll("input")[3].Change(false); 
299              comp.FindComponent<MudCheckBox<bool>>().Instance.Checked.Should().Be(false);
300              foreach (var tf in comp.FindComponents<MudTextField<string>>())
301                  tf.Instance.Text.Should().NotBeNullOrEmpty();
302              comp.FindComponent<MudTextField<int>>().Instance.Value.Should().Be(17);
303          }
304          [Test]
305          public async Task FormWithCheckboxTest2()
306          {
307              var comp = Context.RenderComponent<FormWithCheckboxTest>();
308              var form = comp.FindComponent<MudForm>().Instance;
309              form.IsValid.Should().BeTrue(because: "none of the fields are required");
310          }
311          [Test]
312          public async Task Form_Should_BecomeValidIfUntouchedFieldsAreNotRequired()
313          {
314              var comp = Context.RenderComponent<FormValidationTest2>();
315              var form = comp.FindComponent<MudForm>().Instance;
316              form.IsValid.Should().BeFalse(because: "textfield is required");
317              var textfield = comp.FindComponent<MudTextField<string>>();
318              textfield.Find("input").Change("Moby Dick");
319              form.IsValid.Should().BeTrue(because: "select is not required");
320          }
321          [Test]
322          public async Task Form_Should_BecomeInValidWhenAConversionErrorOccurs()
323          {
324              var comp = Context.RenderComponent<FormConversionErrorTest>();
325              var form = comp.FindComponent<MudForm>().Instance;
326              form.IsValid.Should().BeTrue();
327              var textfield = comp.FindComponent<MudTextField<int>>();
328              textfield.Find("input").Input("Not and int");
329              form.IsValid.Should().BeFalse(because: "conversion error is forwarded to form");
330              textfield.Find("input").Input("17");
331              form.IsValid.Should().BeTrue(because: "conversion error is gone");
332          }
333          [Test]
334          public async Task MudFormExampleTest()
335          {
336              var comp = Context.RenderComponent<MudFormExample>();
337              var form = comp.FindComponent<MudForm>().Instance;
338              comp.FindComponent<MudForm>().SetParam(x => x.ValidationDelay, 0);
339              comp.WaitForAssertion(() => form.IsValid.Should().BeFalse(because: "it contains required fields that are not filled out"));
340              var buttons = comp.FindComponents<MudButton>();
341              var validateButton = buttons[1];
342              validateButton.Find("button").Click();
343              var textfields = comp.FindComponents<MudTextField<string>>();
344              comp.WaitForAssertion(() => textfields[0].Instance.HasErrors.Should().BeTrue());
345              textfields[0].Instance.ErrorText.Should().Be("User name is required!");
346              comp.WaitForAssertion(() => textfields[1].Instance.HasErrors.Should().BeTrue());
347              textfields[1].Instance.ErrorText.Should().Be("Email is required!");
348              comp.WaitForAssertion(() => textfields[2].Instance.HasErrors.Should().BeTrue());
349              textfields[2].Instance.ErrorText.Should().Be("Password is required!");
350              var checkbox = comp.FindComponent<MudCheckBox<bool>>();
351              comp.WaitForAssertion(() => checkbox.Instance.HasErrors.Should().BeTrue());
352              checkbox.Instance.ErrorText.Should().Be("You must agree");
353              var resetValidationButton = buttons[3];
354              resetValidationButton.Find("button").Click();
355              comp.WaitForState(() => form.Errors.Length == 0);
356              comp.WaitForAssertion(() => textfields[0].Instance.HasErrors.Should().BeFalse());
357              textfields[0].Instance.ErrorText.Should().BeNullOrEmpty();
358              comp.WaitForAssertion(() => textfields[1].Instance.HasErrors.Should().BeFalse());
359              textfields[1].Instance.ErrorText.Should().BeNullOrEmpty();
360              comp.WaitForAssertion(() => textfields[2].Instance.HasErrors.Should().BeFalse());
361              textfields[2].Instance.ErrorText.Should().BeNullOrEmpty();
362              comp.WaitForAssertion(() => checkbox.Instance.HasErrors.Should().BeFalse());
363              checkbox.Instance.ErrorText.Should().BeNullOrEmpty();
364              textfields[0].Find("input").Change("Rick Sanchez");
365              textfields[1].Find("input").Change("rick.sanchez@citadel-of-ricks.com");
366              textfields[2].Find("input").Change("Wabalabadubdub1234!");
367              textfields[3].Find("input").Change("Wabalabadubdub1234!");
368              checkbox.Find("input").Change(true);
369              comp.WaitForAssertion(() => form.IsValid.Should().BeTrue());
370              comp.WaitForState(() => form.Errors.Length == 0);
371              var resetButton = buttons[2];
372              resetButton.Find("button").Click();
373              comp.WaitForState(() => form.Errors.Length == 0);
374              comp.WaitForAssertion(() => textfields[0].Instance.HasErrors.Should().BeFalse());
375              textfields[0].Instance.ErrorText.Should().BeNullOrEmpty();
376              textfields[0].Instance.Text.Should().BeNullOrEmpty();
377              comp.WaitForAssertion(() => textfields[1].Instance.HasErrors.Should().BeFalse());
378              textfields[1].Instance.ErrorText.Should().BeNullOrEmpty();
379              textfields[1].Instance.Text.Should().BeNullOrEmpty();
380              comp.WaitForAssertion(() => textfields[2].Instance.HasErrors.Should().BeFalse());
381              textfields[2].Instance.ErrorText.Should().BeNullOrEmpty();
382              textfields[2].Instance.Text.Should().BeNullOrEmpty();
383              comp.WaitForAssertion(() => checkbox.Instance.HasErrors.Should().BeFalse());
384              checkbox.Instance.ErrorText.Should().BeNullOrEmpty();
385              comp.WaitForAssertion(() => checkbox.Instance.Checked.Should().BeFalse());
386          }
387          [Test]
388          public async Task FormWithRadioGroupIsValidTest()
389          {
390              var comp = Context.RenderComponent<FormWithRadioGroupTest>();
391              var form = comp.FindComponent<MudForm>().Instance;
392              var radioGroupcomp = comp.FindComponent<MudRadioGroup<string>>();
393              var radioGroup = radioGroupcomp.Instance;
394              form.IsValid.Should().Be(false);
395              radioGroup.Error.Should().BeFalse();
396              radioGroup.ErrorText.Should().BeNullOrEmpty();
397              radioGroupcomp.Find("input").Click();
398              form.IsValid.Should().Be(true);
399              form.Errors.Length.Should().Be(0);
400              radioGroup.Error.Should().BeFalse();
401              radioGroup.ErrorText.Should().BeNullOrEmpty();
402              comp.SetParam("Selected", null);
403              form.IsValid.Should().Be(false);
404              form.Errors.Length.Should().Be(1);
405              form.Errors[0].Should().Be("Required");
406              radioGroup.Error.Should().BeTrue();
407              radioGroup.ErrorText.Should().Be("Required");
408          }
409          [Test]
410          public async Task Form_Should_Validate_ColorPicker_When_ColorSelectedViaInputs()
411          {
412              var comp = Context.RenderComponent<FormWithColorPickerTest>();
413              var form = comp.FindComponent<MudForm>().Instance;
414              var colorPickerComp = comp.FindComponent<MudColorPicker>();
415              var colorPicker = comp.FindComponent<MudColorPicker>().Instance;
416              var forbiddenColor = colorPicker.Value;
417              colorPickerComp.SetParam(x => x.Validation, new Func<MudColor?, string>(color => color != null && color.Value == forbiddenColor.Value ? $"{forbiddenColor.Value} is not allowed" : null));
418              form.IsTouched.Should().BeFalse();
419              form.IsValid.Should().BeFalse();
420              colorPicker.Error.Should().BeFalse();
421              colorPicker.ErrorText.Should().BeNullOrEmpty();
422              await comp.InvokeAsync(() => colorPickerComp.FindAll("input")[0].Change("#111111"));
423              form.IsTouched.Should().BeTrue();
424              form.IsValid.Should().BeTrue();
425              form.Errors.Length.Should().Be(0);
426              colorPicker.Error.Should().BeFalse();
427              colorPicker.ErrorText.Should().BeNullOrEmpty();
428              comp.SetParam(x => x.ColorValue, forbiddenColor);
429              form.IsValid.Should().Be(false);
430              form.Errors.Length.Should().Be(1);
431              form.Errors[0].Should().Be($"{forbiddenColor.Value} is not allowed");
432              colorPicker.Error.Should().BeTrue();
433              colorPicker.ErrorText.Should().Be($"{forbiddenColor.Value} is not allowed");
434          }
435          [Test]
436          public async Task Form_Should_ValidateColorPickerTest_When_ColorSelectedViaPicker()
437          {
438              var comp = Context.RenderComponent<FormWithColorPickerTest>();
439              var form = comp.FindComponent<MudForm>().Instance;
440              var colorPickerComp = comp.FindComponent<MudColorPicker>();
441              var colorPicker = comp.FindComponent<MudColorPicker>().Instance;
442              var forbiddenColor = colorPicker.Palette.First();
443              colorPickerComp.SetParam(x => x.Validation, new Func<MudColor?, string>(color => color != null && color.Value == forbiddenColor.Value ? $"{forbiddenColor.Value} is not allowed" : null));
444              form.IsTouched.Should().BeFalse();
445              form.IsValid.Should().BeFalse();
446              await comp.InvokeAsync(() => comp.Find("input").Click());
447              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(1));
448              await comp.InvokeAsync(() => comp.Find("div.mud-picker-color-dot-current").Click());
449              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-color-collection").Count.Should().Be(1));
450              await comp.InvokeAsync(() => comp.FindAll("div.mud-picker-color-collection>div.mud-picker-color-dot").Skip(1).First().Click());
451              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-color-collection").Count.Should().Be(0));
452              form.IsTouched.Should().BeTrue();
453              form.IsValid.Should().BeTrue();
454              form.Errors.Length.Should().Be(0);
455              colorPicker.Error.Should().BeFalse();
456              colorPicker.ErrorText.Should().BeNullOrEmpty();
457              await comp.InvokeAsync(() => comp.Find("div.mud-picker-color-dot-current").Click());
458              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-color-collection").Count.Should().Be(1));
459              await comp.InvokeAsync(() => comp.FindAll("div.mud-picker-color-collection>div.mud-picker-color-dot").First().Click());
460              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-color-collection").Count.Should().Be(0));
461              form.IsTouched.Should().BeTrue();
462              form.IsValid.Should().BeFalse();
463              form.Errors.Length.Should().Be(1);
464              form.Errors[0].Should().Be($"{forbiddenColor.Value} is not allowed");
465              colorPicker.Error.Should().BeTrue();
466              colorPicker.ErrorText.Should().Be($"{forbiddenColor.Value} is not allowed");
467          }
468          [Test]
469          public async Task FormWithDatePickerTest()
470          {
471              var comp = Context.RenderComponent<FormWithDatePickerTest>();
472              var form = comp.FindComponent<MudForm>().Instance;
473              var dateComp = comp.FindComponent<MudDatePicker>();
474              var datepicker = comp.FindComponent<MudDatePicker>().Instance;
475              form.IsValid.Should().Be(false);
476              datepicker.Error.Should().BeFalse();
477              datepicker.ErrorText.Should().BeNullOrEmpty();
478              dateComp.Find("input").Change(new DateTime(2001, 01, 31).ToShortDateString());
479              form.IsValid.Should().Be(true);
480              form.Errors.Length.Should().Be(0);
481              datepicker.Error.Should().BeFalse();
482              datepicker.ErrorText.Should().BeNullOrEmpty();
483              comp.SetParam(x => x.Date, null);
484              form.IsValid.Should().Be(false);
485              form.Errors.Length.Should().Be(1);
486              form.Errors[0].Should().Be("Required");
487              datepicker.Error.Should().BeTrue();
488              datepicker.ErrorText.Should().Be("Required");
489          }
490          [Test]
491          public async Task Form_Should_ValidateDatePickerTest()
492          {
493              var comp = Context.RenderComponent<FormWithDatePickerTest>();
494              var form = comp.FindComponent<MudForm>().Instance;
495              var dateComp = comp.FindComponent<MudDatePicker>();
496              var datepicker = comp.FindComponent<MudDatePicker>().Instance;
497              dateComp.SetParam(x => x.Validation, new Func<DateTime?, string>(date => date != null && date.Value.Year >= 2000 ? null : "Year must be >= 2000"));
498              dateComp.Find("input").Change(new DateTime(2001, 01, 31).ToShortDateString());
499              form.IsValid.Should().Be(true);
500              form.Errors.Length.Should().Be(0);
501              datepicker.Error.Should().BeFalse();
502              datepicker.ErrorText.Should().BeNullOrEmpty();
503              comp.SetParam(x => x.Date, (DateTime?)new DateTime(1999, 1, 1));
504              form.IsValid.Should().Be(false);
505              form.Errors.Length.Should().Be(1);
506              form.Errors[0].Should().Be("Year must be >= 2000");
507              datepicker.Error.Should().BeTrue();
508              datepicker.ErrorText.Should().Be("Year must be >= 2000");
509          }
510          [Test]
511          public async Task Form_Should_Validate_DateRangePicker_When_DateRangeSelectedViaInputs()
512          {
513              var comp = Context.RenderComponent<FormWithDateRangePickerTest>();
514              var form = comp.FindComponent<MudForm>().Instance;
515              var dateRangeComp = comp.FindComponent<MudDateRangePicker>();
516              var dateRangePicker = comp.FindComponent<MudDateRangePicker>().Instance;
517              var firstDateTime = new DateTime(2023, 01, 20);
518              var secondDateTime = new DateTime(2023, 02, 20);
519              form.IsValid.Should().Be(false);
520              dateRangePicker.Error.Should().BeFalse();
521              dateRangePicker.ErrorText.Should().BeNullOrEmpty();
522              await comp.InvokeAsync(() => dateRangeComp.FindAll("input")[0].Change(firstDateTime.ToString(CultureInfo.CurrentCulture.DateTimeFormat.ShortDatePattern)));
523              await comp.InvokeAsync(() => dateRangeComp.FindAll("input")[1].Change(secondDateTime.ToString(CultureInfo.CurrentCulture.DateTimeFormat.ShortDatePattern)));
524              form.IsValid.Should().Be(true);
525              form.Errors.Length.Should().Be(0);
526              dateRangePicker.Error.Should().BeFalse();
527              dateRangePicker.ErrorText.Should().BeNullOrEmpty();
528              comp.SetParam(x => x.DateRange, null);
529              form.IsValid.Should().Be(false);
530              form.Errors.Length.Should().Be(1);
531              form.Errors[0].Should().Be("Required");
532              dateRangePicker.Error.Should().BeTrue();
533              dateRangePicker.ErrorText.Should().Be("Required");
534          }
535          [Test]
536          public async Task Form_Should_Validate_DateRangePicker_When_DateRangeSelectedViaPicker()
537          {
538              var comp = Context.RenderComponent<FormWithDateRangePickerTest>();
539              var form = comp.FindComponent<MudForm>().Instance;
540              var dateRangePicker = comp.FindComponent<MudDateRangePicker>().Instance;
541              form.IsValid.Should().Be(false);
542              dateRangePicker.Error.Should().BeFalse();
543              dateRangePicker.ErrorText.Should().BeNullOrEmpty();
544              comp.Find("input").Click();
545              await comp.InvokeAsync(() => comp.FindAll("button.mud-picker-calendar-day").First(x => x.TrimmedText().Equals("10")).Click());
546              await comp.InvokeAsync(() => comp.FindAll("button.mud-picker-calendar-day").First(x => x.TrimmedText().Equals("11")).Click());
547              comp.WaitForAssertion(() => comp.FindAll("div.mud-popover-open").Count.Should().Be(0));
548              comp.WaitForAssertion(() => comp.FindAll("div.mud-popover").Count.Should().Be(1));
549              form.IsTouched.Should().Be(true);
550              form.IsValid.Should().Be(true);
551              form.Errors.Length.Should().Be(0);
552              dateRangePicker.Error.Should().BeFalse();
553              dateRangePicker.ErrorText.Should().BeNullOrEmpty();
554              comp.SetParam(x => x.DateRange, null);
555              form.IsValid.Should().Be(false);
556              form.Errors.Length.Should().Be(1);
557              form.Errors[0].Should().Be("Required");
558              dateRangePicker.Error.Should().BeTrue();
559              dateRangePicker.ErrorText.Should().Be("Required");
560          }
561          [Test]
562          public async Task FormWithTimePickerTest()
563          {
564              var comp = Context.RenderComponent<FormWithTimePickerTest>();
565              var form = comp.FindComponent<MudForm>().Instance;
566              var timePickerComp = comp.FindComponent<MudTimePicker>();
567              var timePicker = comp.FindComponent<MudTimePicker>().Instance;
568              form.IsValid.Should().Be(false);
569              timePicker.Error.Should().BeFalse();
570              timePicker.ErrorText.Should().BeNullOrEmpty();
571              timePickerComp.Find("input").Change("09:30");
572              form.IsValid.Should().Be(true);
573              form.Errors.Length.Should().Be(0);
574              timePicker.Error.Should().BeFalse();
575              timePicker.ErrorText.Should().BeNullOrEmpty();
576              comp.SetParam(x => x.Time, null);
577              form.IsValid.Should().Be(false);
578              form.Errors.Length.Should().Be(1);
579              form.Errors[0].Should().Be("Required");
580              timePicker.Error.Should().BeTrue();
581              timePicker.ErrorText.Should().Be("Required");
582          }
583          [Test]
584          public async Task Form_Should_ValidateTimePickerTest()
585          {
586              var comp = Context.RenderComponent<FormWithTimePickerTest>();
587              var form = comp.FindComponent<MudForm>().Instance;
588              var timeComp = comp.FindComponent<MudTimePicker>();
589              var timePicker = comp.FindComponent<MudTimePicker>().Instance;
590              timeComp.SetParam(x => x.Validation, new Func<TimeSpan?, string>(time => time != null && time.Value.Minutes == 0 ? null : "Only full hours allowed"));
591              timeComp.Find("input").Change("09:00");
592              form.IsValid.Should().Be(true);
593              form.Errors.Length.Should().Be(0);
594              timePicker.Error.Should().BeFalse();
595              timePicker.ErrorText.Should().BeNullOrEmpty();
596              comp.SetParam(x => x.Time, (TimeSpan?)new TimeSpan(0, 17, 05, 00)); 
597              form.IsValid.Should().Be(false);
598              form.Errors.Length.Should().Be(1);
599              form.Errors[0].Should().Be("Only full hours allowed");
600              timePicker.Error.Should().BeTrue();
601              timePicker.ErrorText.Should().Be("Only full hours allowed");
602          }
603          [Test]
604          public async Task FormWithTimePickerTest_When_TimeSelectedViaPicker()
605          {
606              var comp = Context.RenderComponent<FormWithTimePickerTest>();
607              var form = comp.FindComponent<MudForm>().Instance;
608              var timePicker = comp.FindComponent<MudTimePicker>().Instance;
609              form.IsValid.Should().Be(false);
610              timePicker.Error.Should().BeFalse();
611              timePicker.ErrorText.Should().BeNullOrEmpty();
612              comp.Find("input").Click();
613              comp.FindAll("div.mud-picker-stick-inner.mud-hour")[8].Click();
614              comp.FindAll("div.mud-minute")[30].Click();
615              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(0));
616              form.IsTouched.Should().Be(true);
617              form.IsValid.Should().Be(true);
618              form.Errors.Length.Should().Be(0);
619              timePicker.Error.Should().BeFalse();
620              timePicker.ErrorText.Should().BeNullOrEmpty();
621              comp.SetParam(x => x.Time, null);
622              form.IsValid.Should().Be(false);
623              form.Errors.Length.Should().Be(1);
624              form.Errors[0].Should().Be("Required");
625              timePicker.Error.Should().BeTrue();
626              timePicker.ErrorText.Should().Be("Required");
627          }
628          [Test]
629          public async Task Form_Should_ValidateTimePickerTest_When_TimeSelectedViaPicker()
630          {
631              var comp = Context.RenderComponent<FormWithTimePickerTest>();
632              var form = comp.FindComponent<MudForm>().Instance;
633              var timePickerComp = comp.FindComponent<MudTimePicker>();
634              var timePicker = comp.FindComponent<MudTimePicker>().Instance;
635              timePickerComp.SetParam(x => x.Validation, new Func<TimeSpan?, string>(time => time != null && time.Value.Minutes == 0 ? null : "Only full hours allowed"));
636              await comp.InvokeAsync(() => comp.Find("input").Click());
637              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(1));
638              await comp.InvokeAsync(() => comp.FindAll("div.mud-picker-stick-inner.mud-hour")[8].Click());
639              await comp.InvokeAsync(() => comp.FindAll("div.mud-minute")[0].Click());
640              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(0));
641              form.IsTouched.Should().Be(true);
642              form.IsValid.Should().Be(true);
643              form.Errors.Length.Should().Be(0);
644              timePicker.Error.Should().BeFalse();
645              timePicker.ErrorText.Should().BeNullOrEmpty();
646              await comp.InvokeAsync(() => comp.Find("input").Click());
647              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(1));
648              await comp.InvokeAsync(() => comp.FindAll("div.mud-picker-stick-outer.mud-hour")[4].Click());
649              await comp.InvokeAsync(() => comp.FindAll("div.mud-minute")[5].Click());
650              form.IsValid.Should().Be(false);
651              form.Errors.Length.Should().Be(1);
652              form.Errors[0].Should().Be("Only full hours allowed");
653              timePicker.Error.Should().BeTrue();
654              timePicker.ErrorText.Should().Be("Only full hours allowed");
655          }
656          [Test]
657          public async Task EditFormExample_EmptyValidation()
658          {
659              var comp = Context.RenderComponent<EditFormExample>();
660              comp.Find("form").Submit();
661              var textfields = comp.FindComponents<MudTextField<string>>();
662              textfields[0].Instance.HasErrors.Should().BeTrue();
663              textfields[0].Instance.ErrorText.Should().Be("The Username field is required.");
664              textfields[1].Instance.HasErrors.Should().BeTrue();
665              textfields[1].Instance.ErrorText.Should().Be("The Email field is required.");
666              textfields[2].Instance.HasErrors.Should().BeTrue();
667              textfields[2].Instance.ErrorText.Should().Be("The Password field is required.");
668              textfields[3].Instance.HasErrors.Should().BeTrue();
669              textfields[3].Instance.ErrorText.Should().Be("The Password2 field is required.");
670          }
671          [Test]
672          public async Task EditFormExample_FillInValues()
673          {
674              var comp = Context.RenderComponent<EditFormExample>();
675              comp.FindAll("input")[0].Change("Rick Sanchez");
676              comp.FindAll("input")[0].Blur();
677              comp.FindAll("input")[1].Change("rick.sanchez@citadel-of-ricks.com");
678              comp.FindAll("input")[1].Blur();
679              comp.FindAll("input")[2].Change("Wabalabadubdub1234!");
680              comp.FindAll("input")[2].Blur();
681              comp.FindAll("input")[3].Change("Wabalabadubdub1234!");
682              comp.FindAll("input")[3].Blur();
683              comp.Find("form").Submit();
684              var textfields = comp.FindComponents<MudTextField<string>>();
685              textfields[0].Instance.ErrorText.Should().Be("Name length can't be more than 8.");
686              textfields[0].Instance.HasErrors.Should().BeTrue();
687              textfields[1].Instance.HasErrors.Should().BeFalse();
688              textfields[1].Instance.ErrorText.Should().BeNullOrEmpty();
689              textfields[2].Instance.HasErrors.Should().BeFalse();
690              textfields[2].Instance.ErrorText.Should().BeNullOrEmpty();
691              textfields[3].Instance.HasErrors.Should().BeFalse();
692              textfields[3].Instance.ErrorText.Should().BeNullOrEmpty();
693          }
694          [Test]
695          public async Task EditForm_Validation_NullContext()
696          {
697              var comp = Context.RenderComponent<EditFormIssue1229>();
698              EditFormIssue1229.TestAttribute.ValidationContextOnCall.Should().BeEmpty();
699              var input = comp.Find("input");
700              input.Change("Test");
701              input.Blur();
702              EditFormIssue1229.TestAttribute.ValidationContextOnCall.Should().NotBeEmpty();
703              foreach (var vc in EditFormIssue1229.TestAttribute.ValidationContextOnCall)
704              {
705                  vc.Should().NotBeNull();
706              }
707          }
708          [Test]
709          public async Task MudForm_MustNot_ValidateOnInitialRender()
710          {
711              var comp = Context.RenderComponent<MudFormExample>();
712              await Task.Delay(100);
713              var form = comp.FindComponent<MudForm>().Instance;
714              form.Errors.Should().BeEmpty();
715          }
716          [Test]
717          public async Task MudFormExample_FillInValuesRootForm()
718          {
719              var comp = Context.RenderComponent<FluentValidationComplexExample>();
720              comp.FindAll("input")[0].Input("Rick Sanchez");
721              comp.FindAll("input")[0].Blur();
722              comp.FindAll("input")[1].Input("rick.sanchez@citadel-of-ricks.com");
723              comp.FindAll("input")[1].Blur();
724              comp.FindAll("input")[3].Input("Wabalabadubdub1234!");
725              comp.FindAll("input")[3].Blur();
726              comp.FindAll("input")[4].Input("sdfsfsdf!");
727              comp.FindAll("input")[4].Blur();
728              comp.FindAll("input")[5].Input("adsadasad!");
729              comp.FindAll("input")[5].Blur();
730              var form = comp.FindComponent<MudForm>().Instance;
731              await comp.InvokeAsync(() => form.Validate());
732              form.IsValid.Should().BeFalse();
733              var textfields = comp.FindComponents<MudTextField<string>>();
734              var numericFields = comp.FindComponents<MudNumericField<decimal>>();
735              textfields[0].Instance.HasErrors.Should().BeFalse();
736              textfields[0].Instance.ErrorText.Should().BeNullOrEmpty();
737              textfields[1].Instance.HasErrors.Should().BeFalse();
738              textfields[1].Instance.ErrorText.Should().BeNullOrEmpty();
739              textfields[2].Instance.HasErrors.Should().BeFalse();
740              textfields[2].Instance.ErrorText.Should().BeNullOrEmpty();
741              textfields[3].Instance.HasErrors.Should().BeFalse();
742              textfields[3].Instance.ErrorText.Should().BeNullOrEmpty();
743              textfields[4].Instance.HasErrors.Should().BeFalse();
744              textfields[4].Instance.ErrorText.Should().BeNullOrEmpty();
745              textfields[5].Instance.HasErrors.Should().BeFalse();
746              textfields[5].Instance.ErrorText.Should().BeNullOrEmpty();
747              textfields[6].Instance.HasErrors.Should().BeFalse();
748              textfields[6].Instance.ErrorText.Should().BeNullOrEmpty();
749              numericFields[0].Instance.HasErrors.Should().BeFalse();
750              numericFields[0].Instance.ErrorText.Should().BeNullOrEmpty();
751              textfields[7].Instance.HasErrors.Should().BeTrue();
752              textfields[7].Instance.ErrorText.Should().NotBeNullOrEmpty();
753              numericFields[1].Instance.HasErrors.Should().BeTrue();
754              numericFields[1].Instance.ErrorText.Should().NotBeNullOrEmpty();
755          }
756          [Test]
757          public async Task MudFormExample_FillInValuesNestedForm()
758          {
759              var comp = Context.RenderComponent<FluentValidationComplexExample>();
760              comp.FindAll("input")[8].Change("SomeWork");
761              comp.FindAll("input")[8].Blur();
762              comp.FindAll("input")[9].Change("99");
763              comp.FindAll("input")[9].Blur();
764              var form = comp.FindComponent<MudForm>().Instance;
765              await comp.InvokeAsync(() => form.Validate());
766              form.IsValid.Should().BeFalse();
767              var textfields = comp.FindComponents<MudTextField<string>>();
768              var numericFields = comp.FindComponents<MudNumericField<decimal>>();
769              textfields[0].Instance.HasErrors.Should().BeTrue();
770              textfields[0].Instance.ErrorText.Should().NotBeNullOrEmpty();
771              textfields[1].Instance.HasErrors.Should().BeTrue();
772              textfields[1].Instance.ErrorText.Should().NotBeNullOrEmpty();
773              textfields[2].Instance.HasErrors.Should().BeFalse();
774              textfields[2].Instance.ErrorText.Should().BeNullOrEmpty();
775              textfields[3].Instance.HasErrors.Should().BeTrue();
776              textfields[3].Instance.ErrorText.Should().NotBeNullOrEmpty();
777              textfields[4].Instance.HasErrors.Should().BeTrue();
778              textfields[4].Instance.ErrorText.Should().NotBeNullOrEmpty();
779              textfields[5].Instance.HasErrors.Should().BeTrue();
780              textfields[5].Instance.ErrorText.Should().NotBeNullOrEmpty();
781              textfields[6].Instance.HasErrors.Should().BeFalse();
782              textfields[6].Instance.ErrorText.Should().BeNullOrEmpty();
783              numericFields[0].Instance.HasErrors.Should().BeFalse();
784              numericFields[0].Instance.ErrorText.Should().BeNullOrEmpty();
785              textfields[7].Instance.HasErrors.Should().BeFalse();
786              textfields[7].Instance.ErrorText.Should().BeNullOrEmpty();
787              numericFields[1].Instance.HasErrors.Should().BeFalse();
788              numericFields[1].Instance.ErrorText.Should().BeNullOrEmpty();
789          }
790          [Test]
791          public async Task MudFormExample_FillInValues()
792          {
793              var comp = Context.RenderComponent<FluentValidationComplexExample>();
794              comp.FindAll("input")[0].Input("Rick Sanchez");
795              comp.FindAll("input")[0].Blur();
796              comp.FindAll("input")[1].Input("rick.sanchez@citadel-of-ricks.com");
797              comp.FindAll("input")[1].Blur();
798              comp.FindAll("input")[3].Input("Wabalabadubdub1234!");
799              comp.FindAll("input")[3].Blur();
800              comp.FindAll("input")[4].Input("sdfsfsdf!");
801              comp.FindAll("input")[4].Blur();
802              comp.FindAll("input")[5].Input("adsadasad!");
803              comp.FindAll("input")[5].Blur();
804              comp.FindAll("input")[8].Change("SomeWork");
805              comp.FindAll("input")[8].Blur();
806              comp.FindAll("input")[9].Change("99");
807              comp.FindAll("input")[9].Blur();
808              var form = comp.FindComponent<MudForm>().Instance;
809              await comp.InvokeAsync(() => form.Validate());
810              form.IsValid.Should().BeTrue();
811              var textfields = comp.FindComponents<MudTextField<string>>();
812              var numericFields = comp.FindComponents<MudNumericField<decimal>>();
813              textfields[0].Instance.HasErrors.Should().BeFalse();
814              textfields[0].Instance.ErrorText.Should().BeNullOrEmpty();
815              textfields[1].Instance.HasErrors.Should().BeFalse();
816              textfields[1].Instance.ErrorText.Should().BeNullOrEmpty();
817              textfields[2].Instance.HasErrors.Should().BeFalse();
818              textfields[2].Instance.ErrorText.Should().BeNullOrEmpty();
819              textfields[3].Instance.HasErrors.Should().BeFalse();
820              textfields[3].Instance.ErrorText.Should().BeNullOrEmpty();
821              textfields[4].Instance.HasErrors.Should().BeFalse();
822              textfields[4].Instance.ErrorText.Should().BeNullOrEmpty();
823              textfields[5].Instance.HasErrors.Should().BeFalse();
824              textfields[5].Instance.ErrorText.Should().BeNullOrEmpty();
825              textfields[6].Instance.HasErrors.Should().BeFalse();
826              textfields[6].Instance.ErrorText.Should().BeNullOrEmpty();
827              numericFields[0].Instance.HasErrors.Should().BeFalse();
828              numericFields[0].Instance.ErrorText.Should().BeNullOrEmpty();
829              textfields[7].Instance.HasErrors.Should().BeFalse();
830              textfields[7].Instance.ErrorText.Should().BeNullOrEmpty();
831              numericFields[1].Instance.HasErrors.Should().BeFalse();
832              numericFields[1].Instance.ErrorText.Should().BeNullOrEmpty();
833          }
834          [Test]
835          public async Task MudFormComponent_ValidationWithModel_UnexpectedErrorInValidationFunc3()
836          {
837              var comp = Context.RenderComponent<FormWithSingleTextField>();
838              var form = comp.FindComponent<MudForm>();
839              var model = new { data = "asdf" };
840              form.SetParam(nameof(MudForm.Model), model);
841              var tf = comp.FindComponent<MudTextField<string>>();
842              var validationFunc = new Func<object, string, IEnumerable<string>>((obj, property) =>
843              {
844                  throw new InvalidOperationException("User error");
845              });
846              tf.SetParam(nameof(MudTextField<string>.Validation), validationFunc);
847              Expression<Func<string>> expression = () => model.data;
848              tf.SetParam(nameof(MudTextField<string>.For), expression);
849              await comp.InvokeAsync(tf.Instance.Validate);
850              tf.Instance.Error.Should().Be(true);
851              tf.Instance.ErrorText.Should().Be("Error in validation func: User error");
852          }
853          [Test]
854          public async Task MudFormComponent_ValidationWithModelWithNoFor_ShouldShow_ExpectedError()
855          {
856              var comp = Context.RenderComponent<FormWithSingleTextField>();
857              var form = comp.FindComponent<MudForm>();
858              var model = new { data = "asdf" };
859              form.SetParam(nameof(MudForm.Model), model);
860              var tf = comp.FindComponent<MudTextField<string>>();
861              var validationFunc = new Func<object, string, IEnumerable<string>>((obj, property) =>
862              {
863                  throw new InvalidOperationException("User error");
864              });
865              tf.SetParam(nameof(MudTextField<string>.Validation), validationFunc);
866              await comp.InvokeAsync(tf.Instance.Validate);
867              tf.Instance.Error.Should().Be(true);
868              tf.Instance.ErrorText.Should().Be("For is null, please set parameter For on the form input component of type MudTextField`1");
869          }
870          [Test]
871          public async Task MudFormComponent_AsyncValidationWithModelWithNoFor_ShouldShow_ExpectedError()
872          {
873              var comp = Context.RenderComponent<FormWithSingleTextField>();
874              var form = comp.FindComponent<MudForm>();
875              var model = new { data = "asdf" };
876              form.SetParam(nameof(MudForm.Model), model);
877              var tf = comp.FindComponent<MudTextField<string>>();
878              var validationFunc = new Func<object, string, Task<IEnumerable<string>>>((obj, property) =>
879              {
880                  throw new InvalidOperationException("User error");
881              });
882              tf.SetParam(nameof(MudTextField<string>.Validation), validationFunc);
883              await comp.InvokeAsync(tf.Instance.Validate);
884              tf.Instance.Error.Should().Be(true);
885              tf.Instance.ErrorText.Should().Be("For is null, please set parameter For on the form input component of type MudTextField`1");
886          }
887          [Test]
888          public async Task MudFormComponent_ValidationWithModel_UnexpectedErrorInValidationFunc5()
889          {
890              var comp = Context.RenderComponent<FormWithSingleTextField>();
891              var form = comp.FindComponent<MudForm>();
892              var model = new { data = "asdf" };
893              form.SetParam(nameof(MudForm.Model), model);
894              var tf = comp.FindComponent<MudTextField<string>>();
895              var validationFunc = new Func<object, string, IEnumerable<string>>((obj, property) =>
896              {
897                  obj.Should().Be(model);
898                  property.Should().Be("data");
899                  return new[] { "Error1", "Error2" };
900              });
901              tf.SetParam(nameof(MudTextField<string>.Validation), validationFunc);
902              Expression<Func<string>> expression = () => model.data;
903              tf.SetParam(nameof(MudTextField<string>.For), expression);
904              await comp.InvokeAsync(tf.Instance.Validate);
905              tf.Instance.Error.Should().Be(true);
906              tf.Instance.ErrorText.Should().Be("Error1");
907          }
908          [Test]
909          public async Task FormReset_Should_ClearTextField()
910          {
911              var comp = Context.RenderComponent<FormResetTest>();
912              var form = comp.FindComponent<MudForm>();
913              var textFieldComp = comp.FindComponents<MudTextField<string>>()[1]; 
914              var textField = textFieldComp.Instance;
915              textFieldComp.Find("input").Input("asdf");
916              textField.Value.Should().Be("asdf");
917              textField.Text.Should().Be("asdf");
918              await comp.InvokeAsync(() => form.Instance.ResetAsync());
919              textField.Value.Should().BeNullOrEmpty();
920              textField.Text.Should().BeNullOrEmpty();
921              textFieldComp.Find("input").Input("asdf");
922              textField.Value.Should().Be("asdf");
923              textField.Text.Should().Be("asdf");
924              comp.Find("button.reset").Click();
925              textField.Value.Should().BeNullOrEmpty();
926              textField.Text.Should().BeNullOrEmpty();
927          }
928          [Test]
929          public async Task FormReset_Should_ClearNumericField()
930          {
931              var comp = Context.RenderComponent<FormResetTest>();
932              var form = comp.FindComponent<MudForm>().Instance;
933              var numericFieldComp = comp.FindComponent<MudNumericField<int?>>();
934              var numericField = numericFieldComp.Instance;
935              numericFieldComp.Find("input").Input(10);
936              numericField.Value.Should().Be(10);
937              numericField.Text.Should().Be("10");
938              await comp.InvokeAsync(() => form.ResetAsync());
939              numericField.Value.Should().BeNull();
940              numericField.Text.Should().BeNullOrEmpty();
941              numericFieldComp.Find("input").Input(20);
942              numericField.Value.Should().Be(20);
943              numericField.Text.Should().Be("20");
944              comp.Find("button.reset").Click();
945              numericField.Value.Should().BeNull();
946              numericField.Text.Should().BeNullOrEmpty();
947          }
948          [Test]
949          public async Task FormReset_Should_ClearDatePicker()
950          {
951              var comp = Context.RenderComponent<FormResetTest>();
952              var form = comp.FindComponent<MudForm>().Instance;
953              var datePickerComp = comp.FindComponent<MudDatePicker>();
954              var datePicker = datePickerComp.Instance;
955              var testDate = new DateTime(2020, 05, 24);
956              var testDateString = testDate.ToShortDateString();  
957              datePickerComp.Find("input").Change(testDateString);
958              datePicker.Date.Should().Be(testDate);
959              datePicker.Text.Should().Be(testDateString);
960              await comp.InvokeAsync(() => form.ResetAsync());
961              datePicker.Date.Should().BeNull();
962              datePicker.Text.Should().BeNullOrEmpty();
963              datePickerComp.Find("input").Change(testDateString);
964              datePicker.Date.Should().Be(testDate);
965              datePicker.Text.Should().Be(testDateString);
966              comp.Find("button.reset").Click();
967              datePicker.Date.Should().BeNull();
968              datePicker.Text.Should().BeNullOrEmpty();
969          }
970          [Test]
971          public async Task FormReset_Should_ResetFormStateForFieldsThatWrapMudInput()
972          {
973              var comp = Context.RenderComponent<FormResetTest>();
974              var form = comp.FindComponent<MudForm>().Instance;
975              var datePickerComp = comp.FindComponent<MudDatePicker>();
976              var textFieldComp = comp.FindComponents<MudTextField<string>>()[1]; 
977              var numericFieldComp = comp.FindComponent<MudNumericField<int?>>();
978              var testDate = new DateTime(2022, 07, 29);
979              var testDateString = testDate.ToShortDateString();  
980              form.IsValid.Should().Be(false);
981              datePickerComp.Find("input").Change(testDateString);
982              form.IsValid.Should().Be(false);
983              textFieldComp.Find("input").Input("Some value");
984              form.IsValid.Should().Be(false);
985              numericFieldComp.Find("input").Input("1");
986              form.IsValid.Should().Be(true);
987              await comp.InvokeAsync(() => form.ResetAsync());
988              form.IsValid.Should().Be(false); 
989          }
990          [Test]
991          public async Task MudForm_Should_RegisterOnlyTopSubscribeToParentFormFormControls()
992          {
993              var comp = Context.RenderComponent<FormShouldRegisterOnlyTopSubscribeToParentFormFormControlsTest>();
994              var form = comp.FindComponent<MudFormTestable>().Instance;
995              Assert.AreEqual(14, form.FormControls.Count);
996          }
997          [Test]
998          public async Task MudForm_Validation_Should_OverrideFieldValidation()
999          {
1000              var comp = Context.RenderComponent<FormValidationOverrideFieldValidationTest>();
1001              var textFields = comp.FindComponents<MudTextField<string>>();
1002              var numericFields = comp.FindComponents<MudNumericField<int>>();
1003              var defaultValidation = "v";
1004              textFields[0].Instance.Validation.Should().Be(defaultValidation);
1005              textFields[1].Instance.Validation.Should().Be(defaultValidation);
1006              textFields[2].Instance.Validation.Should().Be(defaultValidation);
1007              textFields[3].Instance.Validation.Should().Be("a");
1008              numericFields[0].Instance.Validation.Should().Be(defaultValidation);
1009              numericFields[1].Instance.Validation.Should().NotBe(defaultValidation);
1010              numericFields[2].Instance.Validation.Should().Be(defaultValidation);
1011              numericFields[3].Instance.Validation.Should().Be("b");
1012          }
1013          [Test]
1014          public async Task FieldValidationWithoutRequiredForm_ShouldNot_Validate()
1015          {
1016              var comp = Context.RenderComponent<FieldValidationWithoutRequiredFormTest>();
1017              Assert.Throws<ElementNotFoundException>(() => comp.Find(".mud-input-error"));
1018          }
1019          [Test]
1020          public async Task FieldChangedEventShouldTriggerTest()
1021          {
1022              var comp = Context.RenderComponent<FormFieldChangedTest>();
1023              var formsComp = comp.FindComponents<MudForm>();
1024              var textField = comp.FindComponent<MudTextField<string>>().Instance;
1025              var numeric = comp.FindComponent<MudNumericField<int>>().Instance;
1026              var radioGroup = comp.FindComponent<MudRadioGroup<string>>().Instance;
1027              comp.Instance.FormFieldChangedEventArgs.Should().BeNull();
1028              await comp.InvokeAsync(() => textField.SetText("new value"));
1029              comp.Instance.FormFieldChangedEventArgs.NewValue.Should().Be("new value");
1030              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, textField);
1031              numeric.Value.Should().Be(0);
1032              await comp.InvokeAsync(() => numeric.Increment());
1033              comp.Instance.FormFieldChangedEventArgs.NewValue.Should().Be(1);
1034              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, numeric);
1035              var inputs = comp.FindAll("input").ToArray();
1036              radioGroup.SelectedOption.Should().Be(null);
1037              inputs[2].Click();
1038              radioGroup.SelectedOption.Should().Be("1");
1039              comp.Instance.FormFieldChangedEventArgs.NewValue.Should().Be("1");
1040              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, radioGroup);
<span onclick='openModal()' class='match'>1041              var fileContent = InputFileContent.CreateFromText("", "upload.txt");
1042              var mudFile = comp.FindComponent<MudFileUpload<IBrowserFile>>().Instance;
</span>1043              var input = comp.FindComponent<InputFile>();
1044              input.UploadFiles(fileContent);
1045              (comp.Instance.FormFieldChangedEventArgs.NewValue is IBrowserFile).Should().BeTrue();
1046              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, mudFile);
1047          }
1048          [Test]
1049          public async Task FieldChangedEventShouldTriggerPickerTest()
1050          {
1051              var comp = Context.RenderComponent<FormFieldChangedPickerTest>();
1052              var formsComp = comp.FindComponents<MudForm>();
1053              var datePicker = comp.FindComponent<MudDatePicker>();
1054              var timePicker = comp.FindComponent<MudTimePicker>();
1055              var colorPicker = comp.FindComponent<MudColorPicker>();
1056              comp.Instance.FormFieldChangedEventArgs.Should().BeNull();
1057              var dateString = new DateTime(2022, 04, 03).ToShortDateString();
1058              await comp.InvokeAsync(() => datePicker.Find("input").Change(dateString));
1059              comp.Instance.FormFieldChangedEventArgs.NewValue.Should().Be(new DateTime(2022, 04, 03));
1060              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, datePicker.Instance);
1061              await comp.InvokeAsync(() => timePicker.Find("input").Change("00:45"));
1062              comp.Instance.FormFieldChangedEventArgs.NewValue.Should().Be(new TimeSpan(00, 45, 00));
1063              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, timePicker.Instance);
1064              await comp.InvokeAsync(() => colorPicker.Find("input").Change("#180f6fff"));
1065              comp.Instance.FormFieldChangedEventArgs.NewValue.Should().Be(new MudColor("#180f6fff"));
1066              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, colorPicker.Instance);
1067          }
1068          [Test]
1069          public async Task FormAutoValidationSetTest()
1070          {
1071              var comp = Context.RenderComponent<FormAutomaticValidationTest>();
1072              var textComps = comp.FindComponents<MudTextField<string>>();
1073              var dateComps = comp.FindComponents<MudDatePicker>();
1074              textComps[0].Instance.For.Should().NotBeNull(); 
1075              textComps[1].Instance.For.Should().BeNull(); 
1076              dateComps[0].Instance.For.Should().NotBeNull(); 
1077              dateComps[1].Instance.For.Should().BeNull(); 
1078              textComps[0].Instance.Validation.Should().NotBeNull(); 
1079              textComps[1].Instance.Validation.Should().BeNull(); 
1080              dateComps[0].Instance.Validation.Should().NotBeNull(); 
1081              dateComps[1].Instance.Validation.Should().BeNull(); 
1082          }
1083          [Test]
1084          public async Task FormReadonlyTest()
1085          {
1086              var comp = Context.RenderComponent<FormReadOnlyDisabledTest>();
1087              var textField = comp.FindComponents<MudTextField<string>>()[0];
1088              var maskedTextField = comp.FindComponents<MudTextField<string>>()[1];
1089              var checkBox = comp.FindComponent<MudCheckBox<bool>>();
1090              var radioGroup = comp.FindComponent<MudRadioGroup<string>>();
1091              var switch_ = comp.FindComponent<MudSwitch<bool>>();
1092              var select = comp.FindComponent<MudSelect<string>>(); 
1093              var colorPicker = comp.FindComponent<MudColorPicker>();
1094              var datePicker = comp.FindComponent<MudDatePicker>();
1095              var dateRangePicker = comp.FindComponent<MudDateRangePicker>();
1096              var timePicker = comp.FindComponent<MudTimePicker>();
1097              var autocomplete = comp.FindComponent<MudAutocomplete<string>>();
1098              var numericField = comp.FindComponent<MudNumericField<int>>();
1099              var fileUpload = comp.FindComponent<MudFileUpload<IBrowserFile>>();
1100              textField.Find("input").HasAttribute("readonly").Should().BeFalse();
1101              maskedTextField.Find("input").HasAttribute("readonly").Should().BeFalse();
1102              checkBox.Find("label").ClassList.Should().NotContain("mud-readonly");
1103              radioGroup.Find("label").ClassList.Should().NotContain("mud-readonly");
1104              switch_.Find("label").ClassList.Should().NotContain("mud-readonly");
1105              autocomplete.Find("input").HasAttribute("readonly").Should().BeFalse();
1106              numericField.Find("input").HasAttribute("readonly").Should().BeFalse();
1107              fileUpload.Find("input").HasAttribute("disabled").Should().BeFalse(); 
1108              comp.SetParametersAndRender(parameters => parameters.Add(p => p.FormReadOnly, true).Add(p => p.CompReadOnly, false));
1109              textField.Find("input").HasAttribute("readonly").Should().BeTrue();
1110              maskedTextField.Find("input").HasAttribute("readonly").Should().BeTrue();
1111              checkBox.Find("label").ClassList.Should().Contain("mud-readonly");
1112              radioGroup.Find("label").ClassList.Should().Contain("mud-readonly");
1113              switch_.Find("label").ClassList.Should().Contain("mud-readonly");
1114              autocomplete.Find("input").HasAttribute("readonly").Should().BeTrue();
1115              numericField.Find("input").HasAttribute("readonly").Should().BeTrue();
1116              fileUpload.Find("input").HasAttribute("disabled").Should().BeTrue();
1117              comp.SetParametersAndRender(parameters => parameters.Add(p => p.FormReadOnly, false).Add(p => p.CompReadOnly, true));
1118              textField.Find("input").HasAttribute("readonly").Should().BeTrue();
1119              maskedTextField.Find("input").HasAttribute("readonly").Should().BeTrue();
1120              checkBox.Find("label").ClassList.Should().Contain("mud-readonly");
1121              radioGroup.Find("label").ClassList.Should().Contain("mud-readonly");
1122              switch_.Find("label").ClassList.Should().Contain("mud-readonly");
1123              autocomplete.Find("input").HasAttribute("readonly").Should().BeTrue();
1124              numericField.Find("input").HasAttribute("readonly").Should().BeTrue();
1125              fileUpload.Find("input").HasAttribute("disabled").Should().BeFalse(); 
1126              comp.SetParametersAndRender(parameters => parameters.Add(p => p.FormReadOnly, false).Add(p => p.CompReadOnly, false));
1127              textField.Find("input").HasAttribute("readonly").Should().BeFalse();
1128              maskedTextField.Find("input").HasAttribute("readonly").Should().BeFalse();
1129              checkBox.Find("label").ClassList.Should().NotContain("mud-readonly");
1130              radioGroup.Find("label").ClassList.Should().NotContain("mud-readonly");
1131              switch_.Find("label").ClassList.Should().NotContain("mud-readonly");
1132              autocomplete.Find("input").HasAttribute("readonly").Should().BeFalse();
1133              numericField.Find("input").HasAttribute("readonly").Should().BeFalse();
1134              fileUpload.Find("input").HasAttribute("disabled").Should().BeFalse();
1135          }
1136          [Test]
1137          public async Task FormDisabledTest()
1138          {
1139              var comp = Context.RenderComponent<FormReadOnlyDisabledTest>();
1140              var textField = comp.FindComponents<MudTextField<string>>()[0];
1141              var maskedTextField = comp.FindComponents<MudTextField<string>>()[1];
1142              var checkBox = comp.FindComponent<MudCheckBox<bool>>();
1143              var radioGroup = comp.FindComponent<MudRadioGroup<string>>();
1144              var switch_ = comp.FindComponent<MudSwitch<bool>>();
1145              var select = comp.FindComponent<MudSelect<string>>();
1146              var colorPicker = comp.FindComponent<MudColorPicker>();
1147              var datePicker = comp.FindComponent<MudDatePicker>();
1148              var dateRangePicker = comp.FindComponent<MudDateRangePicker>();
1149              var timePicker = comp.FindComponent<MudTimePicker>();
1150              var autocomplete = comp.FindComponent<MudAutocomplete<string>>();
1151              var numericField = comp.FindComponent<MudNumericField<int>>();
1152              var fileUpload = comp.FindComponent<MudFileUpload<IBrowserFile>>();
1153              textField.Find("input").HasAttribute("disabled").Should().BeFalse();
1154              maskedTextField.Find("input").HasAttribute("disabled").Should().BeFalse();
1155              checkBox.Find("input").HasAttribute("disabled").Should().BeFalse();
1156              radioGroup.Find("input").HasAttribute("disabled").Should().BeFalse();
1157              switch_.Find("input").HasAttribute("disabled").Should().BeFalse();
1158              select.Find("input").HasAttribute("disabled").Should().BeFalse();
1159              colorPicker.Find("input").HasAttribute("disabled").Should().BeFalse();
1160              datePicker.Find("input").HasAttribute("disabled").Should().BeFalse();
1161              dateRangePicker.Find("input").HasAttribute("disabled").Should().BeFalse();
1162              timePicker.Find("input").HasAttribute("disabled").Should().BeFalse();
1163              autocomplete.Find("input").HasAttribute("disabled").Should().BeFalse();
1164              numericField.Find("input").HasAttribute("disabled").Should().BeFalse();
1165              fileUpload.Find("input").HasAttribute("disabled").Should().BeFalse();
1166              comp.SetParametersAndRender(parameters => parameters.Add(p => p.FormDisabled, true).Add(p => p.CompDisabled, false));
1167              textField.Find("input").HasAttribute("disabled").Should().BeTrue();
1168              maskedTextField.Find("input").HasAttribute("disabled").Should().BeTrue();
1169              checkBox.Find("input").HasAttribute("disabled").Should().BeTrue();
1170              radioGroup.Find("input").HasAttribute("disabled").Should().BeTrue();
1171              switch_.Find("input").HasAttribute("disabled").Should().BeTrue();
1172              select.Find("input").HasAttribute("disabled").Should().BeTrue();
1173              colorPicker.Find("input").HasAttribute("disabled").Should().BeTrue();
1174              datePicker.Find("input").HasAttribute("disabled").Should().BeTrue();
1175              dateRangePicker.Find("input").HasAttribute("disabled").Should().BeTrue();
1176              timePicker.Find("input").HasAttribute("disabled").Should().BeTrue();
1177              autocomplete.Find("input").HasAttribute("disabled").Should().BeTrue();
1178              numericField.Find("input").HasAttribute("disabled").Should().BeTrue();
1179              fileUpload.Find("input").HasAttribute("disabled").Should().BeTrue();
1180              comp.SetParametersAndRender(parameters => parameters.Add(p => p.FormDisabled, false).Add(p => p.CompDisabled, true));
1181              textField.Find("input").HasAttribute("disabled").Should().BeTrue();
1182              maskedTextField.Find("input").HasAttribute("disabled").Should().BeTrue();
1183              checkBox.Find("input").HasAttribute("disabled").Should().BeTrue();
1184              radioGroup.Find("input").HasAttribute("disabled").Should().BeTrue();
1185              switch_.Find("input").HasAttribute("disabled").Should().BeTrue();
1186              select.Find("input").HasAttribute("disabled").Should().BeTrue();
1187              colorPicker.Find("input").HasAttribute("disabled").Should().BeTrue();
1188              datePicker.Find("input").HasAttribute("disabled").Should().BeTrue();
1189              dateRangePicker.Find("input").HasAttribute("disabled").Should().BeTrue();
1190              timePicker.Find("input").HasAttribute("disabled").Should().BeTrue();
1191              autocomplete.Find("input").HasAttribute("disabled").Should().BeTrue();
1192              numericField.Find("input").HasAttribute("disabled").Should().BeTrue();
1193              fileUpload.Find("input").HasAttribute("disabled").Should().BeTrue();
1194              comp.SetParametersAndRender(parameters => parameters.Add(p => p.FormDisabled, false).Add(p => p.CompDisabled, false));
1195              textField.Find("input").HasAttribute("disabled").Should().BeFalse();
1196              maskedTextField.Find("input").HasAttribute("disabled").Should().BeFalse();
1197              checkBox.Find("input").HasAttribute("disabled").Should().BeFalse();
1198              radioGroup.Find("input").HasAttribute("disabled").Should().BeFalse();
1199              switch_.Find("input").HasAttribute("disabled").Should().BeFalse();
1200              select.Find("input").HasAttribute("disabled").Should().BeFalse();
1201              colorPicker.Find("input").HasAttribute("disabled").Should().BeFalse();
1202              datePicker.Find("input").HasAttribute("disabled").Should().BeFalse();
1203              dateRangePicker.Find("input").HasAttribute("disabled").Should().BeFalse();
1204              timePicker.Find("input").HasAttribute("disabled").Should().BeFalse();
1205              autocomplete.Find("input").HasAttribute("disabled").Should().BeFalse();
1206              numericField.Find("input").HasAttribute("disabled").Should().BeFalse();
1207              fileUpload.Find("input").HasAttribute("disabled").Should().BeFalse();
1208          }
1209          [Test]
1210          public async Task FormNestedReadOnlyTest()
1211          {
1212              var comp = Context.RenderComponent<FormNestedReadOnlyDisabledTest>();
1213              comp.FindAll(".mud-checkbox.mud-readonly").Count.Should().Be(0);
1214              comp.SetParametersAndRender(parameters => parameters.Add(p => p.ReadOnly, true));
1215              comp.FindAll(".mud-checkbox.mud-readonly").Count.Should().Be(1);
1216              comp.SetParametersAndRender(parameters => parameters.Add(p => p.NestedReadOnly, true));
1217              comp.FindAll(".mud-checkbox.mud-readonly").Count.Should().Be(1);
1218              comp.SetParametersAndRender(parameters => parameters.Add(p => p.ReadOnly, true).Add(p => p.NestedReadOnly, true));
1219              comp.FindAll(".mud-checkbox.mud-readonly").Count.Should().Be(1);
1220              comp.SetParametersAndRender(parameters => parameters.Add(p => p.ReadOnly, false).Add(p => p.NestedReadOnly, false));
1221              comp.FindAll(".mud-checkbox.mud-readonly").Count.Should().Be(0);
1222          }
1223          [Test]
1224          public async Task FormNestedDisabledTest()
1225          {
1226              var comp = Context.RenderComponent<FormNestedReadOnlyDisabledTest>();
1227              comp.FindAll(".mud-checkbox.mud-disabled").Count.Should().Be(0);
1228              comp.SetParametersAndRender(parameters => parameters.Add(p => p.Disabled, true));
1229              comp.FindAll(".mud-checkbox.mud-disabled").Count.Should().Be(1);
1230              comp.SetParametersAndRender(parameters => parameters.Add(p => p.NestedDisabled, true));
1231              comp.FindAll(".mud-checkbox.mud-disabled").Count.Should().Be(1);
1232              comp.SetParametersAndRender(parameters => parameters.Add(p => p.Disabled, true).Add(p => p.NestedDisabled, true));
1233              comp.FindAll(".mud-checkbox.mud-disabled").Count.Should().Be(1);
1234              comp.SetParametersAndRender(parameters => parameters.Add(p => p.Disabled, false).Add(p => p.NestedDisabled, false));
1235              comp.FindAll(".mud-checkbox.mud-disabled").Count.Should().Be(0);
1236          }
1237          [Test]
1238          public async Task FormWithChildFormTest()
1239          {
1240              var comp = Context.RenderComponent<FormWithChildForm>();
1241              var childFormSwitch = comp.Find(".mud-switch-input");
1242              var parentForm = comp.FindComponent<MudForm>().Instance;
1243              var parentTextFieldCmp = comp.FindComponent<MudTextField<string>>();
1244              var parentTextField = parentTextFieldCmp.Instance;
1245              parentForm.IsValid.Should().Be(false);
1246              parentTextField.Error.Should().BeFalse();
1247              parentTextField.ErrorText.Should().BeNullOrEmpty();
1248              parentTextFieldCmp.Find("input").Change("Marilyn Manson");
1249              parentForm.IsValid.Should().Be(true);
1250              parentForm.Errors.Length.Should().Be(0);
1251              parentTextField.Error.Should().BeFalse();
1252              parentTextField.ErrorText.Should().BeNullOrEmpty();
1253              childFormSwitch.Change(true);
1254              var forms = comp.FindComponents<MudForm>();
1255              forms.Count.Should().Be(2);
1256              var childForm = forms[1];
1257              childForm.Instance.IsValid.Should().BeFalse();
1258              parentForm.IsValid.Should().Be(false);
1259              childFormSwitch.Change(false);
1260              forms = comp.FindComponents<MudForm>();
1261              forms.Count.Should().Be(1);
1262              parentForm.IsValid.Should().BeTrue();
1263          }
1264      }
1265  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-GoogleTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from MudBlazor-MDEwOlJlcG9zaXRvcnkyODg0Mjg2NzY=-flat-FormTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>407              var sendTask = server.SendAsync("https:&bsol;&bsol;example.com/signin-google?error=OMG&error_description=SoBad&error_uri=foobar&state=protected_state",
408                  ".AspNetCore.Correlation.Google.correlationId=N");
409              if (redirect)
</pre></code></div>
                <div class="column column_space"><pre><code>1041              var fileContent = InputFileContent.CreateFromText("", "upload.txt");
1042              var mudFile = comp.FindComponent<MudFileUpload<IBrowserFile>>().Instance;
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    