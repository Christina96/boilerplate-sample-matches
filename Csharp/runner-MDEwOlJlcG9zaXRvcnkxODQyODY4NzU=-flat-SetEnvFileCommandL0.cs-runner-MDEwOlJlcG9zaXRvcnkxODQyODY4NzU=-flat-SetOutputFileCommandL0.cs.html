
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 26, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-SetEnvFileCommandL0.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Globalization;
4  using System.IO;
5  using System.Linq;
6  using System.Text;
7  using System.Threading;
8  using System.Threading.Tasks;
9  using System.Runtime.CompilerServices;
10  using GitHub.Runner.Common.Util;
11  using GitHub.Runner.Sdk;
12  using GitHub.Runner.Worker;
13  using GitHub.Runner.Worker.Container;
14  using GitHub.Runner.Worker.Handlers;
15  using Moq;
16  using Xunit;
17  using DTWebApi = GitHub.DistributedTask.WebApi;
18  namespace GitHub.Runner.Common.Tests.Worker
19  {
20      public sealed class SetEnvFileCommandL0
21      {
22          private Mock<IExecutionContext> _executionContext;
23          private List<Tuple<DTWebApi.Issue, string>> _issues;
24          private string _rootDirectory;
25          private SetEnvFileCommand _setEnvFileCommand;
26          private ITraceWriter _trace;
27          [Fact]
28          [Trait("Level", "L0")]
29          [Trait("Category", "Worker")]
30          public void SetEnvFileCommand_DirectoryNotFound()
31          {
32              using (var hostContext = Setup())
33              {
34                  var envFile = Path.Combine(_rootDirectory, "directory-not-found", "env");
35                  _setEnvFileCommand.ProcessCommand(_executionContext.Object, envFile, null);
36                  Assert.Equal(0, _issues.Count);
37                  Assert.Equal(0, _executionContext.Object.Global.EnvironmentVariables.Count);
38              }
39          }
40          [Fact]
41          [Trait("Level", "L0")]
42          [Trait("Category", "Worker")]
43          public void SetEnvFileCommand_NotFound()
44          {
45              using (var hostContext = Setup())
46              {
47                  var envFile = Path.Combine(_rootDirectory, "file-not-found");
48                  _setEnvFileCommand.ProcessCommand(_executionContext.Object, envFile, null);
49                  Assert.Equal(0, _issues.Count);
50                  Assert.Equal(0, _executionContext.Object.Global.EnvironmentVariables.Count);
51              }
52          }
53          [Fact]
54          [Trait("Level", "L0")]
55          [Trait("Category", "Worker")]
56          public void SetEnvFileCommand_EmptyFile()
57          {
58              using (var hostContext = Setup())
59              {
60                  var envFile = Path.Combine(_rootDirectory, "empty-file");
61                  var content = new List<string>();
62                  WriteContent(envFile, content);
63                  _setEnvFileCommand.ProcessCommand(_executionContext.Object, envFile, null);
64                  Assert.Equal(0, _issues.Count);
65                  Assert.Equal(0, _executionContext.Object.Global.EnvironmentVariables.Count);
66              }
67          }
68          [Fact]
69          [Trait("Level", "L0")]
70          [Trait("Category", "Worker")]
71          public void SetEnvFileCommand_Simple()
72          {
73              using (var hostContext = Setup())
74              {
75                  var envFile = Path.Combine(_rootDirectory, "simple");
76                  var content = new List<string>
77                  {
78                      "MY_ENV=MY VALUE",
79                  };
80                  WriteContent(envFile, content);
81                  _setEnvFileCommand.ProcessCommand(_executionContext.Object, envFile, null);
82                  Assert.Equal(0, _issues.Count);
83                  Assert.Equal(1, _executionContext.Object.Global.EnvironmentVariables.Count);
84                  Assert.Equal("MY VALUE", _executionContext.Object.Global.EnvironmentVariables["MY_ENV"]);
85              }
86          }
87          [Fact]
88          [Trait("Level", "L0")]
89          [Trait("Category", "Worker")]
90          public void SetEnvFileCommand_Simple_SkipEmptyLines()
91          {
92              using (var hostContext = Setup())
93              {
94                  var envFile = Path.Combine(_rootDirectory, "simple");
95                  var content = new List<string>
96                  {
97                      string.Empty,
98                      "MY_ENV=my value",
99                      string.Empty,
100                      "MY_ENV_2=my second value",
101                      string.Empty,
102                  };
103                  WriteContent(envFile, content);
104                  _setEnvFileCommand.ProcessCommand(_executionContext.Object, envFile, null);
105                  Assert.Equal(0, _issues.Count);
106                  Assert.Equal(2, _executionContext.Object.Global.EnvironmentVariables.Count);
107                  Assert.Equal("my value", _executionContext.Object.Global.EnvironmentVariables["MY_ENV"]);
108                  Assert.Equal("my second value", _executionContext.Object.Global.EnvironmentVariables["MY_ENV_2"]);
109              }
110          }
111          [Fact]
112          [Trait("Level", "L0")]
113          [Trait("Category", "Worker")]
114          public void SetEnvFileCommand_Simple_EmptyValue()
115          {
116              using (var hostContext = Setup())
117              {
118                  var envFile = Path.Combine(_rootDirectory, "simple-empty-value");
119                  var content = new List<string>
120                  {
121                      "MY_ENV=",
122                  };
123                  WriteContent(envFile, content);
124                  _setEnvFileCommand.ProcessCommand(_executionContext.Object, envFile, null);
125                  Assert.Equal(0, _issues.Count);
126                  Assert.Equal(1, _executionContext.Object.Global.EnvironmentVariables.Count);
127                  Assert.Equal(string.Empty, _executionContext.Object.Global.EnvironmentVariables["MY_ENV"]);
128              }
129          }
130          [Fact]
131          [Trait("Level", "L0")]
132          [Trait("Category", "Worker")]
133          public void SetEnvFileCommand_Simple_MultipleValues()
134          {
135              using (var hostContext = Setup())
136              {
137                  var envFile = Path.Combine(_rootDirectory, "simple");
138                  var content = new List<string>
139                  {
140                      "MY_ENV=my value",
141                      "MY_ENV_2=",
142                      "MY_ENV_3=my third value",
143                  };
144                  WriteContent(envFile, content);
145                  _setEnvFileCommand.ProcessCommand(_executionContext.Object, envFile, null);
146                  Assert.Equal(0, _issues.Count);
147                  Assert.Equal(3, _executionContext.Object.Global.EnvironmentVariables.Count);
148                  Assert.Equal("my value", _executionContext.Object.Global.EnvironmentVariables["MY_ENV"]);
149                  Assert.Equal(string.Empty, _executionContext.Object.Global.EnvironmentVariables["MY_ENV_2"]);
150                  Assert.Equal("my third value", _executionContext.Object.Global.EnvironmentVariables["MY_ENV_3"]);
151              }
152          }
153          [Fact]
154          [Trait("Level", "L0")]
155          [Trait("Category", "Worker")]
156          public void SetEnvFileCommand_Simple_SpecialCharacters()
157          {
158              using (var hostContext = Setup())
159              {
160                  var envFile = Path.Combine(_rootDirectory, "simple");
161                  var content = new List<string>
162                  {
163                      "MY_ENV==abc",
164                      "MY_ENV_2=def=ghi",
165                      "MY_ENV_3=jkl=",
166                  };
167                  WriteContent(envFile, content);
168                  _setEnvFileCommand.ProcessCommand(_executionContext.Object, envFile, null);
169                  Assert.Equal(0, _issues.Count);
170                  Assert.Equal(3, _executionContext.Object.Global.EnvironmentVariables.Count);
171                  Assert.Equal("=abc", _executionContext.Object.Global.EnvironmentVariables["MY_ENV"]);
172                  Assert.Equal("def=ghi", _executionContext.Object.Global.EnvironmentVariables["MY_ENV_2"]);
173                  Assert.Equal("jkl=", _executionContext.Object.Global.EnvironmentVariables["MY_ENV_3"]);
174              }
175          }
176          [Fact]
177          [Trait("Level", "L0")]
178          [Trait("Category", "Worker")]
179          public void SetEnvFileCommand_Heredoc()
180          {
181              using (var hostContext = Setup())
182              {
183                  var envFile = Path.Combine(_rootDirectory, "heredoc");
184                  var content = new List<string>
185                  {
186                      "MY_ENV<<EOF",
187                      "line one",
188                      "line two",
189                      "line three",
190                      "EOF",
191                  };
192                  WriteContent(envFile, content);
193                  _setEnvFileCommand.ProcessCommand(_executionContext.Object, envFile, null);
194                  Assert.Equal(0, _issues.Count);
195                  Assert.Equal(1, _executionContext.Object.Global.EnvironmentVariables.Count);
196                  Assert.Equal($"line one{Environment.NewLine}line two{Environment.NewLine}line three", _executionContext.Object.Global.EnvironmentVariables["MY_ENV"]);
197              }
198          }
199          [Fact]
200          [Trait("Level", "L0")]
201          [Trait("Category", "Worker")]
202          public void SetEnvFileCommand_Heredoc_EmptyValue()
203          {
204              using (var hostContext = Setup())
205              {
206                  var envFile = Path.Combine(_rootDirectory, "heredoc");
207                  var content = new List<string>
208                  {
209                      "MY_ENV<<EOF",
210                      "EOF",
211                  };
212                  WriteContent(envFile, content);
213                  _setEnvFileCommand.ProcessCommand(_executionContext.Object, envFile, null);
214                  Assert.Equal(0, _issues.Count);
215                  Assert.Equal(1, _executionContext.Object.Global.EnvironmentVariables.Count);
216                  Assert.Equal(string.Empty, _executionContext.Object.Global.EnvironmentVariables["MY_ENV"]);
217              }
218          }
219          [Fact]
220          [Trait("Level", "L0")]
221          [Trait("Category", "Worker")]
222          public void SetEnvFileCommand_Heredoc_SkipEmptyLines()
223          {
224              using (var hostContext = Setup())
225              {
226                  var envFile = Path.Combine(_rootDirectory, "heredoc");
227                  var content = new List<string>
228                  {
229                      string.Empty,
230                      "MY_ENV<<EOF",
231                      "hello",
232                      "world",
233                      "EOF",
234                      string.Empty,
235                      "MY_ENV_2<<EOF",
236                      "HELLO",
237                      "AGAIN",
238                      "EOF",
239                      string.Empty,
240                  };
241                  WriteContent(envFile, content);
242                  _setEnvFileCommand.ProcessCommand(_executionContext.Object, envFile, null);
243                  Assert.Equal(0, _issues.Count);
244                  Assert.Equal(2, _executionContext.Object.Global.EnvironmentVariables.Count);
245                  Assert.Equal($"hello{Environment.NewLine}world", _executionContext.Object.Global.EnvironmentVariables["MY_ENV"]);
246                  Assert.Equal($"HELLO{Environment.NewLine}AGAIN", _executionContext.Object.Global.EnvironmentVariables["MY_ENV_2"]);
247              }
248          }
249          [Fact]
250          [Trait("Level", "L0")]
251          [Trait("Category", "Worker")]
252          public void SetEnvFileCommand_Heredoc_SpecialCharacters()
253          {
254              using (var hostContext = Setup())
255              {
256                  var envFile = Path.Combine(_rootDirectory, "heredoc");
257                  var content = new List<string>
258                  {
259                      "MY_ENV<<=EOF",
260                      "hello",
261                      "one",
262                      "=EOF",
263                      "MY_ENV_2<<<EOF",
264                      "hello",
265                      "two",
266                      "<EOF",
267                      "MY_ENV_3<<EOF",
268                      "hello",
269                      string.Empty,
270                      "three",
271                      string.Empty,
272                      "EOF",
273                      "MY_ENV_4<<EOF",
274                      "hello=four",
275                      "EOF",
276                      "MY_ENV_5<<EOF",
277                      " EOF",
278                      "EOF",
279                  };
280                  WriteContent(envFile, content);
281                  _setEnvFileCommand.ProcessCommand(_executionContext.Object, envFile, null);
282                  Assert.Equal(0, _issues.Count);
283                  Assert.Equal(5, _executionContext.Object.Global.EnvironmentVariables.Count);
284                  Assert.Equal($"hello{Environment.NewLine}one", _executionContext.Object.Global.EnvironmentVariables["MY_ENV"]);
285                  Assert.Equal($"hello{Environment.NewLine}two", _executionContext.Object.Global.EnvironmentVariables["MY_ENV_2"]);
286                  Assert.Equal($"hello{Environment.NewLine}{Environment.NewLine}three{Environment.NewLine}", _executionContext.Object.Global.EnvironmentVariables["MY_ENV_3"]);
287                  Assert.Equal($"hello=four", _executionContext.Object.Global.EnvironmentVariables["MY_ENV_4"]);
288                  Assert.Equal($" EOF", _executionContext.Object.Global.EnvironmentVariables["MY_ENV_5"]);
289              }
290          }
291          [Fact]
292          [Trait("Level", "L0")]
293          [Trait("Category", "Worker")]
294          public void SetEnvFileCommand_Heredoc_MissingNewLine()
295          {
296              using (var hostContext = Setup())
297              {
298                  var envFile = Path.Combine(_rootDirectory, "heredoc");
299                  var content = new List<string>
300                  {
301                      "MY_ENV<<EOF",
302                      "line one",
303                      "line two",
304                      "line three",
305                      "EOF",
306                  };
307                  WriteContent(envFile, content, " ");
308                  var ex = Assert.Throws<Exception>(() => _setEnvFileCommand.ProcessCommand(_executionContext.Object, envFile, null));
309                  Assert.Contains("Matching delimiter not found", ex.Message);
310              }
311          }
312          [Fact]
313          [Trait("Level", "L0")]
314          [Trait("Category", "Worker")]
315          public void SetEnvFileCommand_Heredoc_MissingNewLineMultipleLinesEnv()
316          {
317              using (var hostContext = Setup())
318              {
319                  var envFile = Path.Combine(_rootDirectory, "heredoc");
320                  var content = new List<string>
321                  {
322                      "MY_ENV<<EOF",
323                      @"line one
324                      line two
325                      line three",
326                      "EOF",
327                  };
328                  WriteContent(envFile, content, " ");
329                  var ex = Assert.Throws<Exception>(() => _setEnvFileCommand.ProcessCommand(_executionContext.Object, envFile, null));
330                  Assert.Contains("EOF marker missing new line", ex.Message);
331              }
332          }
333  #if OS_WINDOWS
334          [Fact]
335          [Trait("Level", "L0")]
336          [Trait("Category", "Worker")]
337          public void SetEnvFileCommand_Heredoc_PreservesNewline()
338          {
339              using (var hostContext = Setup())
340              {
341                  var newline = "\n";
342                  var envFile = Path.Combine(_rootDirectory, "heredoc");
343                  var content = new List<string>
344                  {
345                      "MY_ENV<<EOF",
346                      "hello",
347                      "world",
348                      "EOF",
349                  };
350                  WriteContent(envFile, content, newline: newline);
351                  _setEnvFileCommand.ProcessCommand(_executionContext.Object, envFile, null);
352                  Assert.Equal(0, _issues.Count);
353                  Assert.Equal(1, _executionContext.Object.Global.EnvironmentVariables.Count);
354                  Assert.Equal($"hello{newline}world", _executionContext.Object.Global.EnvironmentVariables["MY_ENV"]);
355              }
356          }
357  #endif
358          private void WriteContent(
359              string path,
360              List<string> content,
361              string newline = null)
362          {
363              if (string.IsNullOrEmpty(newline))
364              {
365                  newline = Environment.NewLine;
366              }
367              var encoding = new UTF8Encoding(true); 
368              var contentStr = string.Join(newline, content);
369              File.WriteAllText(path, contentStr, encoding);
370          }
371          private TestHostContext Setup([CallerMemberName] string name = "")
372          {
373              _issues = new List<Tuple<DTWebApi.Issue, string>>();
374              var hostContext = new TestHostContext(this, name);
375              _trace = hostContext.GetTrace();
376              var workDirectory = hostContext.GetDirectory(WellKnownDirectory.Work);
377              ArgUtil.NotNullOrEmpty(workDirectory, nameof(workDirectory));
378              Directory.CreateDirectory(workDirectory);
379              _rootDirectory = Path.Combine(workDirectory, nameof(SetEnvFileCommandL0));
380              Directory.CreateDirectory(_rootDirectory);
<span onclick='openModal()' class='match'>381              _executionContext = new Mock<IExecutionContext>();
382              _executionContext.Setup(x => x.Global)
383                  .Returns(new GlobalContext
384                  {
385                      EnvironmentVariables = new Dictionary<string, string>(VarUtil.EnvironmentVariableKeyComparer),
</span>386                      WriteDebug = true,
387                  });
388              _executionContext.Setup(x => x.AddIssue(It.IsAny<DTWebApi.Issue>(), It.IsAny<ExecutionContextLogOptions>()))
389                  .Callback((DTWebApi.Issue issue, ExecutionContextLogOptions logOptions) =>
390                  {
391                      var resolvedMessage = issue.Message;
392                      if (logOptions.WriteToLog && !string.IsNullOrEmpty(logOptions.LogMessageOverride))
393                      {
394                          resolvedMessage = logOptions.LogMessageOverride;
395                      }
396                      _issues.Add(new(issue, resolvedMessage));
397                      _trace.Info($"Issue '{issue.Type}': {resolvedMessage}");
398                  });
399              _executionContext.Setup(x => x.Write(It.IsAny<string>(), It.IsAny<string>()))
400                  .Callback((string tag, string message) =>
401                  {
402                      _trace.Info($"{tag}{message}");
403                  });
404              _setEnvFileCommand = new SetEnvFileCommand();
405              _setEnvFileCommand.Initialize(hostContext);
406              return hostContext;
407          }
408      }
409  }
</code></pre>
        </div>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-SetOutputFileCommandL0.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Globalization;
4  using System.IO;
5  using System.Linq;
6  using System.Text;
7  using System.Threading;
8  using System.Threading.Tasks;
9  using System.Runtime.CompilerServices;
10  using GitHub.Runner.Common.Util;
11  using GitHub.Runner.Sdk;
12  using GitHub.Runner.Worker;
13  using GitHub.Runner.Worker.Container;
14  using GitHub.Runner.Worker.Handlers;
15  using Moq;
16  using Xunit;
17  using DTWebApi = GitHub.DistributedTask.WebApi;
18  namespace GitHub.Runner.Common.Tests.Worker
19  {
20      public sealed class SetOutputFileCommandL0
21      {
22          private Mock<IExecutionContext> _executionContext;
23          private List<Tuple<DTWebApi.Issue, string>> _issues;
24          private Dictionary<string, string> _outputs;
25          private string _rootDirectory;
26          private SetOutputFileCommand _setOutputFileCommand;
27          private ITraceWriter _trace;
28          [Fact]
29          [Trait("Level", "L0")]
30          [Trait("Category", "Worker")]
31          public void SetOutputFileCommand_DirectoryNotFound()
32          {
33              using (var hostContext = Setup())
34              {
35                  var stateFile = Path.Combine(_rootDirectory, "directory-not-found", "env");
36                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
37                  Assert.Equal(0, _issues.Count);
38                  Assert.Equal(0, _outputs.Count);
39              }
40          }
41          [Fact]
42          [Trait("Level", "L0")]
43          [Trait("Category", "Worker")]
44          public void SetOutputFileCommand_NotFound()
45          {
46              using (var hostContext = Setup())
47              {
48                  var stateFile = Path.Combine(_rootDirectory, "file-not-found");
49                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
50                  Assert.Equal(0, _issues.Count);
51                  Assert.Equal(0, _outputs.Count);
52              }
53          }
54          [Fact]
55          [Trait("Level", "L0")]
56          [Trait("Category", "Worker")]
57          public void SetOutputFileCommand_EmptyFile()
58          {
59              using (var hostContext = Setup())
60              {
61                  var stateFile = Path.Combine(_rootDirectory, "empty-file");
62                  var content = new List<string>();
63                  WriteContent(stateFile, content);
64                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
65                  Assert.Equal(0, _issues.Count);
66                  Assert.Equal(0, _outputs.Count);
67              }
68          }
69          [Fact]
70          [Trait("Level", "L0")]
71          [Trait("Category", "Worker")]
72          public void SetOutputFileCommand_Simple()
73          {
74              using (var hostContext = Setup())
75              {
76                  var stateFile = Path.Combine(_rootDirectory, "simple");
77                  var content = new List<string>
78                  {
79                      "MY_OUTPUT=MY VALUE",
80                  };
81                  WriteContent(stateFile, content);
82                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
83                  Assert.Equal(0, _issues.Count);
84                  Assert.Equal(1, _outputs.Count);
85                  Assert.Equal("MY VALUE", _outputs["MY_OUTPUT"]);
86              }
87          }
88          [Fact]
89          [Trait("Level", "L0")]
90          [Trait("Category", "Worker")]
91          public void SetOutputFileCommand_Simple_SkipEmptyLines()
92          {
93              using (var hostContext = Setup())
94              {
95                  var stateFile = Path.Combine(_rootDirectory, "simple");
96                  var content = new List<string>
97                  {
98                      string.Empty,
99                      "MY_OUTPUT=my value",
100                      string.Empty,
101                      "MY_OUTPUT_2=my second value",
102                      string.Empty,
103                  };
104                  WriteContent(stateFile, content);
105                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
106                  Assert.Equal(0, _issues.Count);
107                  Assert.Equal(2, _outputs.Count);
108                  Assert.Equal("my value", _outputs["MY_OUTPUT"]);
109                  Assert.Equal("my second value", _outputs["MY_OUTPUT_2"]);
110              }
111          }
112          [Fact]
113          [Trait("Level", "L0")]
114          [Trait("Category", "Worker")]
115          public void SetOutputFileCommand_Simple_EmptyValue()
116          {
117              using (var hostContext = Setup())
118              {
119                  var stateFile = Path.Combine(_rootDirectory, "simple-empty-value");
120                  var content = new List<string>
121                  {
122                      "MY_OUTPUT=",
123                  };
124                  WriteContent(stateFile, content);
125                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
126                  Assert.Equal(0, _issues.Count);
127                  Assert.Equal(1, _outputs.Count);
128                  Assert.Equal(string.Empty, _outputs["MY_OUTPUT"]);
129              }
130          }
131          [Fact]
132          [Trait("Level", "L0")]
133          [Trait("Category", "Worker")]
134          public void SetOutputFileCommand_Simple_MultipleValues()
135          {
136              using (var hostContext = Setup())
137              {
138                  var stateFile = Path.Combine(_rootDirectory, "simple");
139                  var content = new List<string>
140                  {
141                      "MY_OUTPUT=my value",
142                      "MY_OUTPUT_2=",
143                      "MY_OUTPUT_3=my third value",
144                  };
145                  WriteContent(stateFile, content);
146                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
147                  Assert.Equal(0, _issues.Count);
148                  Assert.Equal(3, _outputs.Count);
149                  Assert.Equal("my value", _outputs["MY_OUTPUT"]);
150                  Assert.Equal(string.Empty, _outputs["MY_OUTPUT_2"]);
151                  Assert.Equal("my third value", _outputs["MY_OUTPUT_3"]);
152              }
153          }
154          [Fact]
155          [Trait("Level", "L0")]
156          [Trait("Category", "Worker")]
157          public void SetOutputFileCommand_Simple_SpecialCharacters()
158          {
159              using (var hostContext = Setup())
160              {
161                  var stateFile = Path.Combine(_rootDirectory, "simple");
162                  var content = new List<string>
163                  {
164                      "MY_OUTPUT==abc",
165                      "MY_OUTPUT_2=def=ghi",
166                      "MY_OUTPUT_3=jkl=",
167                  };
168                  WriteContent(stateFile, content);
169                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
170                  Assert.Equal(0, _issues.Count);
171                  Assert.Equal(3, _outputs.Count);
172                  Assert.Equal("=abc", _outputs["MY_OUTPUT"]);
173                  Assert.Equal("def=ghi", _outputs["MY_OUTPUT_2"]);
174                  Assert.Equal("jkl=", _outputs["MY_OUTPUT_3"]);
175              }
176          }
177          [Fact]
178          [Trait("Level", "L0")]
179          [Trait("Category", "Worker")]
180          public void SetOutputFileCommand_Heredoc()
181          {
182              using (var hostContext = Setup())
183              {
184                  var stateFile = Path.Combine(_rootDirectory, "heredoc");
185                  var content = new List<string>
186                  {
187                      "MY_OUTPUT<<EOF",
188                      "line one",
189                      "line two",
190                      "line three",
191                      "EOF",
192                  };
193                  WriteContent(stateFile, content);
194                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
195                  Assert.Equal(0, _issues.Count);
196                  Assert.Equal(1, _outputs.Count);
197                  Assert.Equal($"line one{Environment.NewLine}line two{Environment.NewLine}line three", _outputs["MY_OUTPUT"]);
198              }
199          }
200          [Fact]
201          [Trait("Level", "L0")]
202          [Trait("Category", "Worker")]
203          public void SetOutputFileCommand_Heredoc_EmptyValue()
204          {
205              using (var hostContext = Setup())
206              {
207                  var stateFile = Path.Combine(_rootDirectory, "heredoc");
208                  var content = new List<string>
209                  {
210                      "MY_OUTPUT<<EOF",
211                      "EOF",
212                  };
213                  WriteContent(stateFile, content);
214                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
215                  Assert.Equal(0, _issues.Count);
216                  Assert.Equal(1, _outputs.Count);
217                  Assert.Equal(string.Empty, _outputs["MY_OUTPUT"]);
218              }
219          }
220          [Fact]
221          [Trait("Level", "L0")]
222          [Trait("Category", "Worker")]
223          public void SetOutputFileCommand_Heredoc_SkipEmptyLines()
224          {
225              using (var hostContext = Setup())
226              {
227                  var stateFile = Path.Combine(_rootDirectory, "heredoc");
228                  var content = new List<string>
229                  {
230                      string.Empty,
231                      "MY_OUTPUT<<EOF",
232                      "hello",
233                      "world",
234                      "EOF",
235                      string.Empty,
236                      "MY_OUTPUT_2<<EOF",
237                      "HELLO",
238                      "AGAIN",
239                      "EOF",
240                      string.Empty,
241                  };
242                  WriteContent(stateFile, content);
243                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
244                  Assert.Equal(0, _issues.Count);
245                  Assert.Equal(2, _outputs.Count);
246                  Assert.Equal($"hello{Environment.NewLine}world", _outputs["MY_OUTPUT"]);
247                  Assert.Equal($"HELLO{Environment.NewLine}AGAIN", _outputs["MY_OUTPUT_2"]);
248              }
249          }
250          [Fact]
251          [Trait("Level", "L0")]
252          [Trait("Category", "Worker")]
253          public void SetOutputFileCommand_Heredoc_SpecialCharacters()
254          {
255              using (var hostContext = Setup())
256              {
257                  var stateFile = Path.Combine(_rootDirectory, "heredoc");
258                  var content = new List<string>
259                  {
260                      "MY_OUTPUT<<=EOF",
261                      "hello",
262                      "one",
263                      "=EOF",
264                      "MY_OUTPUT_2<<<EOF",
265                      "hello",
266                      "two",
267                      "<EOF",
268                      "MY_OUTPUT_3<<EOF",
269                      "hello",
270                      string.Empty,
271                      "three",
272                      string.Empty,
273                      "EOF",
274                      "MY_OUTPUT_4<<EOF",
275                      "hello=four",
276                      "EOF",
277                      "MY_OUTPUT_5<<EOF",
278                      " EOF",
279                      "EOF",
280                  };
281                  WriteContent(stateFile, content);
282                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
283                  Assert.Equal(0, _issues.Count);
284                  Assert.Equal(5, _outputs.Count);
285                  Assert.Equal($"hello{Environment.NewLine}one", _outputs["MY_OUTPUT"]);
286                  Assert.Equal($"hello{Environment.NewLine}two", _outputs["MY_OUTPUT_2"]);
287                  Assert.Equal($"hello{Environment.NewLine}{Environment.NewLine}three{Environment.NewLine}", _outputs["MY_OUTPUT_3"]);
288                  Assert.Equal($"hello=four", _outputs["MY_OUTPUT_4"]);
289                  Assert.Equal($" EOF", _outputs["MY_OUTPUT_5"]);
290              }
291          }
292          [Fact]
293          [Trait("Level", "L0")]
294          [Trait("Category", "Worker")]
295          public void SetOutputFileCommand_Heredoc_MissingNewLine()
296          {
297              using (var hostContext = Setup())
298              {
299                  var stateFile = Path.Combine(_rootDirectory, "heredoc");
300                  var content = new List<string>
301                  {
302                      "MY_OUTPUT<<EOF",
303                      "line one",
304                      "line two",
305                      "line three",
306                      "EOF",
307                  };
308                  WriteContent(stateFile, content, " ");
309                  var ex = Assert.Throws<Exception>(() => _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null));
310                  Assert.Contains("Matching delimiter not found", ex.Message);
311              }
312          }
313          [Fact]
314          [Trait("Level", "L0")]
315          [Trait("Category", "Worker")]
316          public void SetOutputFileCommand_Heredoc_MissingNewLineMultipleLines()
317          {
318              using (var hostContext = Setup())
319              {
320                  var stateFile = Path.Combine(_rootDirectory, "heredoc");
321                  var content = new List<string>
322                  {
323                      "MY_OUTPUT<<EOF",
324                      @"line one
325                      line two
326                      line three",
327                      "EOF",
328                  };
329                  WriteContent(stateFile, content, " ");
330                  var ex = Assert.Throws<Exception>(() => _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null));
331                  Assert.Contains("EOF marker missing new line", ex.Message);
332              }
333          }
334  #if OS_WINDOWS
335          [Fact]
336          [Trait("Level", "L0")]
337          [Trait("Category", "Worker")]
338          public void SetOutputFileCommand_Heredoc_PreservesNewline()
339          {
340              using (var hostContext = Setup())
341              {
342                  var newline = "\n";
343                  var stateFile = Path.Combine(_rootDirectory, "heredoc");
344                  var content = new List<string>
345                  {
346                      "MY_OUTPUT<<EOF",
347                      "hello",
348                      "world",
349                      "EOF",
350                  };
351                  WriteContent(stateFile, content, newline: newline);
352                  _setOutputFileCommand.ProcessCommand(_executionContext.Object, stateFile, null);
353                  Assert.Equal(0, _issues.Count);
354                  Assert.Equal(1, _outputs.Count);
355                  Assert.Equal($"hello{newline}world", _outputs["MY_OUTPUT"]);
356              }
357          }
358  #endif
359          private void WriteContent(
360              string path,
361              List<string> content,
362              string newline = null)
363          {
364              if (string.IsNullOrEmpty(newline))
365              {
366                  newline = Environment.NewLine;
367              }
368              var encoding = new UTF8Encoding(true); 
369              var contentStr = string.Join(newline, content);
370              File.WriteAllText(path, contentStr, encoding);
371          }
372          private TestHostContext Setup([CallerMemberName] string name = "")
373          {
374              _issues = new List<Tuple<DTWebApi.Issue, string>>();
375              _outputs = new Dictionary<string, string>();
376              var hostContext = new TestHostContext(this, name);
377              _trace = hostContext.GetTrace();
378              var workDirectory = hostContext.GetDirectory(WellKnownDirectory.Work);
379              ArgUtil.NotNullOrEmpty(workDirectory, nameof(workDirectory));
380              Directory.CreateDirectory(workDirectory);
381              _rootDirectory = Path.Combine(workDirectory, nameof(SetOutputFileCommandL0));
382              Directory.CreateDirectory(_rootDirectory);
<span onclick='openModal()' class='match'>383              _executionContext = new Mock<IExecutionContext>();
384              _executionContext.Setup(x => x.Global)
385                  .Returns(new GlobalContext
386                  {
387                      EnvironmentVariables = new Dictionary<string, string>(VarUtil.EnvironmentVariableKeyComparer),
</span>388                      WriteDebug = true,
389                  });
390              _executionContext.Setup(x => x.AddIssue(It.IsAny<DTWebApi.Issue>(), It.IsAny<ExecutionContextLogOptions>()))
391                  .Callback((DTWebApi.Issue issue, ExecutionContextLogOptions logOptions) =>
392                  {
393                      var resolvedMessage = issue.Message;
394                      if (logOptions.WriteToLog && !string.IsNullOrEmpty(logOptions.LogMessageOverride))
395                      {
396                          resolvedMessage = logOptions.LogMessageOverride;
397                      }
398                      _issues.Add(new(issue, resolvedMessage));
399                      _trace.Info($"Issue '{issue.Type}': {resolvedMessage}");
400                  });
401              _executionContext.Setup(x => x.Write(It.IsAny<string>(), It.IsAny<string>()))
402                  .Callback((string tag, string message) =>
403                  {
404                      _trace.Info($"{tag}{message}");
405                  });
406              var reference = string.Empty;
407              _executionContext.Setup(x => x.SetOutput(It.IsAny<string>(), It.IsAny<string>(), out reference))
408                .Callback((string name, string value, out string reference) =>
409                {
410                    reference = value;
411                    _outputs[name] = value;
412                });
413              _setOutputFileCommand = new SetOutputFileCommand();
414              _setOutputFileCommand.Initialize(hostContext);
415              return hostContext;
416          }
417      }
418  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-SetEnvFileCommandL0.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-SetOutputFileCommandL0.cs</div>
                </div>
                <div class="column column_space"><pre><code>381              _executionContext = new Mock<IExecutionContext>();
382              _executionContext.Setup(x => x.Global)
383                  .Returns(new GlobalContext
384                  {
385                      EnvironmentVariables = new Dictionary<string, string>(VarUtil.EnvironmentVariableKeyComparer),
</pre></code></div>
                <div class="column column_space"><pre><code>383              _executionContext = new Mock<IExecutionContext>();
384              _executionContext.Setup(x => x.Global)
385                  .Returns(new GlobalContext
386                  {
387                      EnvironmentVariables = new Dictionary<string, string>(VarUtil.EnvironmentVariableKeyComparer),
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    