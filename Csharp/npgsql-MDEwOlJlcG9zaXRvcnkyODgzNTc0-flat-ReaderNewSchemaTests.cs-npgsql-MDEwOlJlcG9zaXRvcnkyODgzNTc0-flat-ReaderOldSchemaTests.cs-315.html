
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 23, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-ReaderNewSchemaTests.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.ObjectModel;
3  using System.Data;
4  using System.Linq;
5  using System.Threading.Tasks;
6  using Npgsql.PostgresTypes;
7  using NUnit.Framework;
8  using static Npgsql.Tests.TestUtil;
9  namespace Npgsql.Tests;
10  public class ReaderNewSchemaTests : SyncOrAsyncTestBase
11  {
12      [Test]
13      public async Task Allow_DBNull()
14      {
15          using var conn = await OpenConnectionAsync();
16          var table = await CreateTempTable(conn, &quot;nullable INTEGER, non_nullable INTEGER NOT NULL&quot;);
17          using var cmd = new NpgsqlCommand($&quot;SELECT nullable,non_nullable,8 FROM {table}&quot;, conn);
18          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
19          var columns = await GetColumnSchema(reader);
20          Assert.That(columns[0].AllowDBNull, Is.True);
21          Assert.That(columns[1].AllowDBNull, Is.False);
22          Assert.That(columns[2].AllowDBNull, Is.Null);
23      }
24      [Test]
25      public async Task BaseCatalogName()
26      {
27          var dbName = new NpgsqlConnectionStringBuilder(ConnectionString).Database;
28          using var conn = await OpenConnectionAsync();
29          var table = await CreateTempTable(conn, &quot;foo INTEGER&quot;);
30          using var cmd = new NpgsqlCommand($&quot;SELECT foo,8 FROM {table}&quot;, conn);
31          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
32          var columns = await GetColumnSchema(reader);
33          Assert.That(columns[0].BaseCatalogName, Is.EqualTo(dbName));
34          Assert.That(columns[1].BaseCatalogName, Is.EqualTo(dbName));
35      }
36      [Test]
37      public async Task BaseColumnName()
38      {
39          await using var conn = await OpenConnectionAsync();
40          var table = await CreateTempTable(conn, &quot;foo INTEGER&quot;);
41          using var cmd = new NpgsqlCommand($&quot;SELECT foo, foo AS foobar, 8 AS bar, 8, &#x27;8&#x27;::VARCHAR(10) FROM {table}&quot;, conn);
42          await using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
43          var columns = await GetColumnSchema(reader);
44          Assert.That(columns[0].BaseColumnName, Is.EqualTo(&quot;foo&quot;));
45          Assert.That(columns[1].BaseColumnName, Is.EqualTo(&quot;foo&quot;));
46          Assert.That(columns[2].BaseColumnName, Is.Null);
47          Assert.That(columns[3].BaseColumnName, Is.Null);
48          Assert.That(columns[4].BaseColumnName, Is.Null);
49      }
50      [Test]
51      public async Task BaseColumnName_with_column_aliases()
52      {
53          using var conn = OpenConnection();
54          conn.ExecuteNonQuery(@&quot;
55                  CREATE TEMP TABLE data (
56                      Cod varchar(5) NOT NULL,
57                      Descr varchar(40),
58                      Date date,
59                      CONSTRAINT PK_test_Cod PRIMARY KEY (Cod)
60                  );
61              &quot;);
62          var cmd = new NpgsqlCommand(&quot;SELECT Cod as CodAlias, Descr as DescrAlias, Date, NULL AS Generated FROM data&quot;, conn);
63          using var dr = cmd.ExecuteReader(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
64          var cols = await GetColumnSchema(dr);
65          Assert.That(cols[0].BaseColumnName, Is.EqualTo(&quot;cod&quot;));
66          Assert.That(cols[0].ColumnName, Is.EqualTo(&quot;codalias&quot;));
67          Assert.That(cols[0].IsAliased, Is.True);
68          Assert.That(cols[1].BaseColumnName, Is.EqualTo(&quot;descr&quot;));
69          Assert.That(cols[1].ColumnName, Is.EqualTo(&quot;descralias&quot;));
70          Assert.That(cols[1].IsAliased, Is.True);
71          Assert.That(cols[2].BaseColumnName, Is.EqualTo(&quot;date&quot;));
72          Assert.That(cols[2].ColumnName, Is.EqualTo(&quot;date&quot;));
73          Assert.That(cols[2].IsAliased, Is.False);
74          Assert.That(cols[3].BaseColumnName, Is.Null);
75          Assert.That(cols[3].ColumnName, Is.EqualTo(&quot;generated&quot;));
76          Assert.That(cols[3].IsAliased, Is.Null);
77      }
78      [Test]
79      public async Task BaseSchemaName()
80      {
81          using var conn = await OpenConnectionAsync();
82          var table = await CreateTempTable(conn, &quot;foo INTEGER&quot;);
83          using var cmd = new NpgsqlCommand($&quot;SELECT foo,8 FROM {table}&quot;, conn);
84          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
85          var columns = await GetColumnSchema(reader);
86          Assert.That(columns[0].BaseSchemaName, Is.EqualTo(&quot;public&quot;));
87          Assert.That(columns[1].BaseSchemaName, Is.Null);
88      }
89      [Test]
90      public async Task BaseServerName()
91      {
92          var host = new NpgsqlConnectionStringBuilder(ConnectionString).Host;
93          using var conn = await OpenConnectionAsync();
94          var table = await CreateTempTable(conn, &quot;foo INTEGER&quot;);
95          using var cmd = new NpgsqlCommand($&quot;SELECT foo,8 FROM {table}&quot;, conn);
96          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
97          var columns = await GetColumnSchema(reader);
98          Assert.That(columns[0].BaseServerName, Is.EqualTo(host));
99          Assert.That(columns[1].BaseServerName, Is.EqualTo(host));
100      }
101      [Test]
102      public async Task BaseTableName()
103      {
104          using var conn = await OpenConnectionAsync();
105          var table = await CreateTempTable(conn, &quot;foo INTEGER&quot;);
106          using var cmd = new NpgsqlCommand($&quot;SELECT foo,8 FROM {table}&quot;, conn);
107          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
108          var columns = await GetColumnSchema(reader);
109          Assert.That(columns[0].BaseTableName, Does.StartWith(&quot;temp_table&quot;));
110          Assert.That(columns[1].BaseTableName, Is.Null);
111      }
112      [Test]
113      public async Task ColumnName()
114      {
115          await using (var conn = await OpenConnectionAsync())
116          {
117              var table = await CreateTempTable(conn, &quot;foo INTEGER&quot;);
118              using var cmd = new NpgsqlCommand($&quot;SELECT foo, foo AS foobar, 8 AS bar, 8, &#x27;8&#x27;::VARCHAR(10) FROM {table}&quot;, conn);
119              using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
120              var columns = await GetColumnSchema(reader);
121              Assert.That(columns[0].ColumnName, Is.EqualTo(&quot;foo&quot;));
122              Assert.That(columns[1].ColumnName, Is.EqualTo(&quot;foobar&quot;));
123              Assert.That(columns[2].ColumnName, Is.EqualTo(&quot;bar&quot;));
124              Assert.That(columns[3].ColumnName, Is.EqualTo(&quot;?column?&quot;));
125              Assert.That(columns[4].ColumnName, Is.EqualTo(&quot;varchar&quot;));
126          }
127          using (var conn = await OpenConnectionAsync())
128          {
129              var table = await CreateTempTable(conn, &quot;col TEXT&quot;);
130              var behavior = CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo;
131              using var command = new NpgsqlCommand($&quot;SELECT col AS col_alias FROM {table}&quot;, conn);
132              using var reader = command.ExecuteReader(behavior);
133              var columns = await GetColumnSchema(reader);
134              Assert.That(columns[0].ColumnName, Is.EqualTo(&quot;col_alias&quot;));
135          }
136      }
137      [Test]
138      public async Task ColumnOrdinal()
139      {
140          using var conn = await OpenConnectionAsync();
141          var table = await CreateTempTable(conn, &quot;first INTEGER, second INTEGER&quot;);
142          using var cmd = new NpgsqlCommand($&quot;SELECT second,first FROM {table}&quot;, conn);
143          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
144          var columns = await GetColumnSchema(reader);
145          Assert.That(columns[0].ColumnName, Is.EqualTo(&quot;second&quot;));
146          Assert.That(columns[0].ColumnOrdinal, Is.EqualTo(0));
147          Assert.That(columns[1].ColumnName, Is.EqualTo(&quot;first&quot;));
148          Assert.That(columns[1].ColumnOrdinal, Is.EqualTo(1));
149      }
150      [Test]
151      public async Task ColumnAttributeNumber()
152      {
153          using var conn = await OpenConnectionAsync();
154          var table = await CreateTempTable(conn, &quot;first INTEGER, second INTEGER&quot;);
155          using var cmd = new NpgsqlCommand($&quot;SELECT second,first FROM {table}&quot;, conn);
156          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
157          var columns = await GetColumnSchema(reader);
158          Assert.That(columns[0].ColumnName, Is.EqualTo(&quot;second&quot;));
159          Assert.That(columns[0].ColumnAttributeNumber, Is.EqualTo(2));
160          Assert.That(columns[1].ColumnName, Is.EqualTo(&quot;first&quot;));
161          Assert.That(columns[1].ColumnAttributeNumber, Is.EqualTo(1));
162      }
163      [Test]
164      public async Task ColumnSize()
165      {
166          using var conn = await OpenConnectionAsync();
167          IgnoreOnRedshift(conn, &quot;Column size is never unlimited on Redshift&quot;);
168          var table = await CreateTempTable(conn, &quot;bounded VARCHAR(30), unbounded VARCHAR&quot;);
169          using var cmd = new NpgsqlCommand($&quot;SELECT bounded,unbounded,&#x27;a&#x27;::VARCHAR(10),&#x27;b&#x27;::VARCHAR FROM {table}&quot;, conn);
170          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
171          var columns = await GetColumnSchema(reader);
172          Assert.That(columns[0].ColumnSize, Is.EqualTo(30));
173          Assert.That(columns[1].ColumnSize, Is.Null);
174          Assert.That(columns[2].ColumnSize, Is.EqualTo(10));
175          Assert.That(columns[3].ColumnSize, Is.Null);
176      }
177      [Test]
178      public async Task IsAutoIncrement()
179      {
180          await using var conn = await OpenConnectionAsync();
181          IgnoreOnRedshift(conn, &quot;Serial columns not support on Redshift&quot;);
182          var table = await CreateTempTable(conn, &quot;serial SERIAL, int INT&quot;);
183          await using var cmd = new NpgsqlCommand($&quot;SELECT serial, int, 8 FROM {table}&quot;, conn);
184          await using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
185          var columns = await GetColumnSchema(reader);
186          Assert.That(columns[0].IsAutoIncrement, Is.True, &quot;Serial not identified as autoincrement&quot;);
187          Assert.That(columns[1].IsAutoIncrement, Is.False, &quot;Regular int column identified as autoincrement&quot;);
188          Assert.That(columns[2].IsAutoIncrement, Is.Null, &quot;Literal int identified as autoincrement&quot;);
189      }
190      [Test]
191      public async Task IsAutoIncrement_identity()
192      {
193          await using var conn = await OpenConnectionAsync();
194          IgnoreOnRedshift(conn, &quot;Identity columns not support on Redshift&quot;);
195          MinimumPgVersion(conn, &quot;10.0&quot;, &quot;IDENTITY introduced in PostgreSQL 10&quot;);
196          var table =
197              await CreateTempTable(conn, &quot;identity1 INT GENERATED BY DEFAULT AS IDENTITY, identity2 INT GENERATED ALWAYS AS IDENTITY&quot;);
198          await using var cmd = new NpgsqlCommand($&quot;SELECT identity1, identity2 FROM {table}&quot;, conn);
199          await using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
200          var columns = await GetColumnSchema(reader);
201          Assert.That(columns[0].IsAutoIncrement, Is.True, &quot;PG 10 IDENTITY not identified as autoincrement&quot;);
202          Assert.That(columns[1].IsAutoIncrement, Is.True, &quot;PG 10 IDENTITY not identified as autoincrement&quot;);
203      }
204      [Test]
205      public async Task IsIdentity()
206      {
207          await using var conn = await OpenConnectionAsync();
208          IgnoreOnRedshift(conn, &quot;Identity columns not support on Redshift&quot;);
209          MinimumPgVersion(conn, &quot;10.0&quot;, &quot;IDENTITY introduced in PostgreSQL 10&quot;);
210          var table = await CreateTempTable(
211              conn,
212              &quot;identity1 INT GENERATED BY DEFAULT AS IDENTITY, identity2 INT GENERATED ALWAYS AS IDENTITY, serial SERIAL, int INT&quot;);
213          await using var cmd = new NpgsqlCommand($&quot;SELECT identity1, identity2, serial, int, 8 FROM {table}&quot;, conn);
214          await using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
215          var columns = await GetColumnSchema(reader);
216          Assert.That(columns[0].IsIdentity, Is.True, &quot;PG 10 IDENTITY not identified as identity&quot;);
217          Assert.That(columns[1].IsIdentity, Is.True, &quot;PG 10 IDENTITY not identified as identity&quot;);
218          Assert.That(columns[2].IsIdentity, Is.False, &quot;Serial identified as identity&quot;);
219          Assert.That(columns[3].IsIdentity, Is.False, &quot;Regular int column identified as identity&quot;);
220          Assert.That(columns[4].IsIdentity, Is.False, &quot;Literal int identified as identity&quot;);
221      }
222      [Test]
223      public async Task IsKey()
224      {
225          using var conn = await OpenConnectionAsync();
226          IgnoreOnRedshift(conn, &quot;Key not supported in reader schema on Redshift&quot;);
227          var table = await CreateTempTable(conn, &quot;id INT PRIMARY KEY, non_id INT, uniq INT UNIQUE&quot;);
228          using var cmd = new NpgsqlCommand($&quot;SELECT id,non_id,uniq,8 FROM {table}&quot;, conn);
229          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
230          var columns = await GetColumnSchema(reader);
231          Assert.That(columns[0].IsKey, Is.True);
232          Assert.That(columns[1].IsKey, Is.False);
233          Assert.That(columns[2].IsKey, Is.False);
234          Assert.That(columns[3].IsKey, Is.Null);
235      }
236      [Test]
237      public async Task IsKey_composite()
238      {
239          using var conn = await OpenConnectionAsync();
240          IgnoreOnRedshift(conn, &quot;Key not supported in reader schema on Redshift&quot;);
241          var table = await CreateTempTable(conn, &quot;id1 INT, id2 INT, PRIMARY KEY (id1, id2)&quot;);
242          using var cmd = new NpgsqlCommand($&quot;SELECT id1,id2 FROM {table}&quot;, conn);
243          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
244          var columns = await GetColumnSchema(reader);
245          Assert.That(columns[0].IsKey, Is.True);
246          Assert.That(columns[1].IsKey, Is.True);
247      }
248      [Test]
249      public async Task IsLong()
250      {
251          using var conn = await OpenConnectionAsync();
252          IgnoreOnRedshift(conn, &quot;bytea not supported on Redshift&quot;);
253          var table = await CreateTempTable(conn, &quot;long BYTEA, non_long INT&quot;);
254          using var cmd = new NpgsqlCommand($&quot;SELECT long, non_long, 8 FROM {table}&quot;, conn);
255          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
256          var columns = await GetColumnSchema(reader);
257          Assert.That(columns[0].IsLong, Is.True);
258          Assert.That(columns[1].IsLong, Is.False);
259          Assert.That(columns[2].IsLong, Is.False);
260      }
261      [Test]
262      public async Task IsReadOnly_on_view()
263      {
264          using var conn = await OpenConnectionAsync();
265          var view = await GetTempViewName(conn);
266          var table = await GetTempTableName(conn);
<span onclick='openModal()' class='match'>267          await conn.ExecuteNonQueryAsync($@&quot;
268  CREATE VIEW {view} AS SELECT 8 AS foo;
269  CREATE TABLE {table} (bar INTEGER)&quot;);
270          using var cmd = new NpgsqlCommand($&quot;SELECT foo,bar FROM {view},{table}&quot;, conn);
271          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
</span>272          var columns = await GetColumnSchema(reader);
273          Assert.That(columns[0].IsReadOnly, Is.True);
274          Assert.That(columns[1].IsReadOnly, Is.False);
275      }
276      [Test]
277      public async Task IsReadOnly_on_non_column()
278      {
279          using var conn = await OpenConnectionAsync();
280          using var cmd = new NpgsqlCommand(&quot;SELECT 8&quot;, conn);
281          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
282          var columns = await GetColumnSchema(reader);
283          Assert.That(columns.Single().IsReadOnly, Is.True);
284      }
285      [Test]
286      public async Task IsUnique()
287      {
288          using var conn = await OpenConnectionAsync();
289          IgnoreOnRedshift(conn, &quot;Unique not supported in reader schema on Redshift&quot;);
290          var table = await GetTempTableName(conn);
291          await conn.ExecuteNonQueryAsync($@&quot;
292  CREATE TABLE {table} (id INT PRIMARY KEY, non_id INT, uniq INT UNIQUE, non_id_second INT, non_id_third INT);
293  CREATE UNIQUE INDEX idx_{table} ON {table} (non_id_second, non_id_third)&quot;);
294          using var cmd = new NpgsqlCommand($&quot;SELECT id,non_id,uniq,8,non_id_second,non_id_third FROM {table}&quot;, conn);
295          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
296          var columns = await GetColumnSchema(reader);
297          Assert.That(columns[0].IsUnique, Is.True);
298          Assert.That(columns[1].IsUnique, Is.False);
299          Assert.That(columns[2].IsUnique, Is.True);
300          Assert.That(columns[3].IsUnique, Is.Null);
301          Assert.That(columns[4].IsUnique, Is.False);
302          Assert.That(columns[5].IsUnique, Is.False);
303      }
304      [Test]
305      public async Task NumericPrecision()
306      {
307          using var conn = await OpenConnectionAsync();
308          IgnoreOnRedshift(conn, &quot;Precision is never unlimited on Redshift&quot;);
309          var table = await CreateTempTable(conn, &quot;a NUMERIC(8), b NUMERIC, c INTEGER&quot;);
310          using var cmd = new NpgsqlCommand($&quot;SELECT a,b,c,8.3::NUMERIC(8) FROM {table}&quot;, conn);
311          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
312          var columns = await GetColumnSchema(reader);
313          Assert.That(columns[0].NumericPrecision, Is.EqualTo(8));
314          Assert.That(columns[1].NumericPrecision, Is.Null);
315          Assert.That(columns[2].NumericPrecision, Is.Null);
316          Assert.That(columns[3].NumericPrecision, Is.EqualTo(8));
317      }
318      [Test]
319      public async Task NumericScale()
320      {
321          using var conn = await OpenConnectionAsync();
322          IgnoreOnRedshift(conn, &quot;Scale is never unlimited on Redshift&quot;);
323          var table = await CreateTempTable(conn, &quot;a NUMERIC(8,5), b NUMERIC, c INTEGER&quot;);
324          using var cmd = new NpgsqlCommand($&quot;SELECT a,b,c,8.3::NUMERIC(8,5) FROM {table}&quot;, conn);
325          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
326          var columns = await GetColumnSchema(reader);
327          Assert.That(columns[0].NumericScale, Is.EqualTo(5));
328          Assert.That(columns[1].NumericScale, Is.Null);
329          Assert.That(columns[2].NumericScale, Is.Null);
330          Assert.That(columns[3].NumericScale, Is.EqualTo(5));
331      }
332      [Test]
333      public async Task DataType()
334      {
335          using var conn = await OpenConnectionAsync();
336          var table = await CreateTempTable(conn, &quot;foo INTEGER&quot;);
337          using var cmd = new NpgsqlCommand($&quot;SELECT foo,8::INTEGER FROM {table}&quot;, conn);
338          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
339          var columns = await GetColumnSchema(reader);
340          Assert.That(columns[0].DataType, Is.SameAs(typeof(int)));
341          Assert.That(columns[1].DataType, Is.SameAs(typeof(int)));
342      }
343      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/1305&quot;)]
344      public async Task DataType_unknown_type()
345      {
346          using var conn = await OpenConnectionAsync();
347          var table = await CreateTempTable(conn, &quot;foo INTEGER&quot;);
348          using var cmd = new NpgsqlCommand($&quot;SELECT foo::INTEGER FROM {table}&quot;, conn);
349          cmd.AllResultTypesAreUnknown = true;
350          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
351          var columns = await GetColumnSchema(reader);
352          Assert.That(columns[0].DataType, Is.SameAs(typeof(int)));
353      }
354      [Test]
355      public async Task DataType_with_composite()
356      {
357          await using var adminConnection = await OpenConnectionAsync();
358          IgnoreOnRedshift(adminConnection, &quot;Composite types not support on Redshift&quot;);
359          var type = await GetTempTypeName(adminConnection);
360          await adminConnection.ExecuteNonQueryAsync($&quot;CREATE TYPE {type} AS (foo int)&quot;);
361          var tableName = await CreateTempTable(adminConnection, $&quot;comp {type}&quot;);
362          var dataSourceBuilder = CreateDataSourceBuilder();
363          dataSourceBuilder.MapComposite&lt;SomeComposite&gt;(type);
364          await using var dataSource = dataSourceBuilder.Build();
365          await using var connection = await dataSource.OpenConnectionAsync();
366          await using var cmd = new NpgsqlCommand($&quot;SELECT comp,&#x27;(4)&#x27;::{type} FROM {tableName}&quot;, connection);
367          await using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
368          var columns = await GetColumnSchema(reader);
369          Assert.That(columns[0].DataType, Is.SameAs(typeof(SomeComposite)));
370          Assert.That(columns[0].UdtAssemblyQualifiedName, Is.EqualTo(typeof(SomeComposite).AssemblyQualifiedName));
371          Assert.That(columns[1].DataType, Is.SameAs(typeof(SomeComposite)));
372          Assert.That(columns[1].UdtAssemblyQualifiedName, Is.EqualTo(typeof(SomeComposite).AssemblyQualifiedName));
373      }
374      [Test]
375      public async Task UdtAssemblyQualifiedName()
376      {
377          using var conn = await OpenConnectionAsync();
378          var table = await CreateTempTable(conn, &quot;foo INTEGER&quot;);
379          using var cmd = new NpgsqlCommand($&quot;SELECT foo,8 FROM {table}&quot;, conn);
380          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
381          var columns = await GetColumnSchema(reader);
382          Assert.That(columns[0].UdtAssemblyQualifiedName, Is.Null);
383          Assert.That(columns[1].UdtAssemblyQualifiedName, Is.Null);
384      }
385      [Test]
386      public async Task PostgresType()
387      {
388          using var conn = await OpenConnectionAsync();
389          var table = await CreateTempTable(conn, &quot;foo INTEGER&quot;);
390          using var cmd = new NpgsqlCommand($&quot;SELECT foo,8 FROM {table}&quot;, conn);
391          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
392          var columns = await GetColumnSchema(reader);
393          var intType = columns[0].PostgresType;
394          Assert.That(columns[1].PostgresType, Is.SameAs(intType));
395          Assert.That(intType.Name, Is.EqualTo(&quot;integer&quot;));
396          Assert.That(intType.InternalName, Is.EqualTo(&quot;int4&quot;));
397      }
398      [Test]
399      public async Task ColumnSchema_with_and_without_KeyInfo()
400      {
401          await using var conn = await OpenConnectionAsync();
402          var table = await CreateTempTable(conn, &quot;foo INTEGER&quot;);
403          using var cmd = new NpgsqlCommand($&quot;SELECT foo, foo AS foobar, 8 AS bar, 8, &#x27;8&#x27;::VARCHAR(10) FROM {table}&quot;, conn);
404          await using (var reader = await cmd.ExecuteReaderAsync())
405          {
406              var columns = await GetColumnSchema(reader);
407              Assert.That(columns[0].ColumnName, Is.EqualTo(&quot;foo&quot;));
408              Assert.That(columns[0].BaseColumnName, Is.Null);
409              Assert.That(columns[0].BaseTableName, Is.Null);
410              Assert.That(columns[0].BaseSchemaName, Is.Null);
411              Assert.That(columns[0].IsAliased, Is.Null);
412              Assert.That(columns[0].IsKey, Is.Null);
413              Assert.That(columns[0].IsUnique, Is.Null);
414              Assert.That(columns[1].ColumnName, Is.EqualTo(&quot;foobar&quot;));
415              Assert.That(columns[1].BaseColumnName, Is.Null);
416              Assert.That(columns[1].BaseTableName, Is.Null);
417              Assert.That(columns[1].BaseSchemaName, Is.Null);
418              Assert.That(columns[1].IsAliased, Is.Null);
419              Assert.That(columns[1].IsKey, Is.Null);
420              Assert.That(columns[1].IsUnique, Is.Null);
421              Assert.That(columns[2].ColumnName, Is.EqualTo(&quot;bar&quot;));
422              Assert.That(columns[2].BaseColumnName, Is.Null);
423              Assert.That(columns[2].BaseTableName, Is.Null);
424              Assert.That(columns[2].BaseSchemaName, Is.Null);
425              Assert.That(columns[2].IsAliased, Is.Null);
426              Assert.That(columns[2].IsKey, Is.Null);
427              Assert.That(columns[2].IsUnique, Is.Null);
428              Assert.That(columns[3].ColumnName, Is.EqualTo(&quot;?column?&quot;));
429              Assert.That(columns[3].BaseColumnName, Is.Null);
430              Assert.That(columns[3].BaseTableName, Is.Null);
431              Assert.That(columns[3].BaseSchemaName, Is.Null);
432              Assert.That(columns[3].IsAliased, Is.Null);
433              Assert.That(columns[3].IsKey, Is.Null);
434              Assert.That(columns[3].IsUnique, Is.Null);
435              Assert.That(columns[4].ColumnName, Is.EqualTo(&quot;varchar&quot;));
436              Assert.That(columns[4].BaseColumnName, Is.Null);
437              Assert.That(columns[4].BaseTableName, Is.Null);
438              Assert.That(columns[4].BaseSchemaName, Is.Null);
439              Assert.That(columns[4].IsAliased, Is.Null);
440              Assert.That(columns[4].IsKey, Is.Null);
441              Assert.That(columns[4].IsUnique, Is.Null);
442          }
443          await using (var readerInfo = await cmd.ExecuteReaderAsync(CommandBehavior.KeyInfo))
444          {
445              var columnsInfo = await GetColumnSchema(readerInfo);
446              Assert.That(columnsInfo[0].ColumnName, Is.EqualTo(&quot;foo&quot;));
447              Assert.That(columnsInfo[0].BaseColumnName, Is.EqualTo(&quot;foo&quot;));
448              Assert.That(columnsInfo[0].BaseSchemaName, Is.EqualTo(&quot;public&quot;));
449              Assert.That(columnsInfo[0].IsAliased, Is.EqualTo(false));
450              Assert.That(columnsInfo[0].IsKey, Is.EqualTo(false));
451              Assert.That(columnsInfo[0].IsUnique, Is.EqualTo(false));
452              Assert.That(columnsInfo[1].ColumnName, Is.EqualTo(&quot;foobar&quot;));
453              Assert.That(columnsInfo[1].BaseColumnName, Is.EqualTo(&quot;foo&quot;));
454              Assert.That(columnsInfo[1].BaseSchemaName, Is.EqualTo(&quot;public&quot;));
455              Assert.That(columnsInfo[1].IsAliased, Is.EqualTo(true));
456              Assert.That(columnsInfo[1].IsKey, Is.EqualTo(false));
457              Assert.That(columnsInfo[1].IsUnique, Is.EqualTo(false));
458              Assert.That(columnsInfo[2].ColumnName, Is.EqualTo(&quot;bar&quot;));
459              Assert.That(columnsInfo[2].BaseColumnName, Is.Null);
460              Assert.That(columnsInfo[2].BaseSchemaName, Is.Null);
461              Assert.That(columnsInfo[2].IsAliased, Is.Null);
462              Assert.That(columnsInfo[2].IsKey, Is.Null);
463              Assert.That(columnsInfo[2].IsUnique, Is.Null);
464              Assert.That(columnsInfo[3].ColumnName, Is.EqualTo(&quot;?column?&quot;));
465              Assert.That(columnsInfo[3].BaseColumnName, Is.Null);
466              Assert.That(columnsInfo[3].BaseSchemaName, Is.Null);
467              Assert.That(columnsInfo[3].IsAliased, Is.Null);
468              Assert.That(columnsInfo[3].IsKey, Is.Null);
469              Assert.That(columnsInfo[3].IsUnique, Is.Null);
470              Assert.That(columnsInfo[4].ColumnName, Is.EqualTo(&quot;varchar&quot;));
471              Assert.That(columnsInfo[4].BaseColumnName, Is.Null);
472              Assert.That(columnsInfo[4].BaseSchemaName, Is.Null);
473              Assert.That(columnsInfo[4].IsAliased, Is.Null);
474              Assert.That(columnsInfo[4].IsKey, Is.Null);
475              Assert.That(columnsInfo[4].IsUnique, Is.Null);
476          }
477      }
478      [Test]
479      [TestCase(&quot;integer&quot;)]
480      [TestCase(&quot;real&quot;)]
481      [TestCase(&quot;integer[]&quot;)]
482      [TestCase(&quot;character varying(10)&quot;, 10)]
483      [TestCase(&quot;character varying&quot;)]
484      [TestCase(&quot;character varying(10)[]&quot;, 10)]
485      [TestCase(&quot;character(10)&quot;, 10)]
486      [TestCase(&quot;character&quot;, 1)]
487      [TestCase(&quot;character(1)&quot;, 1)]
488      [TestCase(&quot;numeric(1000, 2)&quot;, null, 1000, 2)]
489      [TestCase(&quot;numeric(1000)&quot;, null, 1000, null)]
490      [TestCase(&quot;numeric&quot;)]
491      [TestCase(&quot;timestamp without time zone&quot;)]
492      [TestCase(&quot;timestamp(2) without time zone&quot;, null, 2)]
493      [TestCase(&quot;timestamp(2) with time zone&quot;, null, 2)]
494      [TestCase(&quot;time without time zone&quot;)]
495      [TestCase(&quot;time(2) without time zone&quot;, null, 2)]
496      [TestCase(&quot;time(2) with time zone&quot;, null, 2)]
497      [TestCase(&quot;interval&quot;)]
498      [TestCase(&quot;interval(2)&quot;, null, 2)]
499      [TestCase(&quot;bit&quot;, 1)]
500      [TestCase(&quot;bit(3)&quot;, 3)]
501      [TestCase(&quot;bit varying&quot;)]
502      [TestCase(&quot;bit varying(3)&quot;, 3)]
503      public async Task DataTypeName(string typeName, int? size = null, int? precision = null, int? scale = null)
504      {
505          var openingParen = typeName.IndexOf(&#x27;(&#x27;);
506          var typeNameWithoutFacets = openingParen == -1
507              ? typeName
508              : typeName.Substring(0, openingParen) + typeName.Substring(typeName.IndexOf(&#x27;)&#x27;) + 1);
509          using var conn = await OpenConnectionAsync();
510          var table = await CreateTempTable(conn, $&quot;foo {typeName}&quot;);
511          using var cmd = new NpgsqlCommand($&quot;SELECT foo,NULL::{typeName} FROM {table}&quot;, conn);
512          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
513          var columns = await GetColumnSchema(reader);
514          var tableColumn = columns[0];
515          var nonTableColumn = columns[1];
516          Assert.That(tableColumn.DataTypeName, Is.EqualTo(typeNameWithoutFacets));
517          Assert.That(tableColumn.ColumnSize, Is.EqualTo(size));
518          Assert.That(tableColumn.NumericPrecision, Is.EqualTo(precision));
519          Assert.That(tableColumn.NumericScale, Is.EqualTo(scale));
520          Assert.That(nonTableColumn.DataTypeName, Is.EqualTo(typeNameWithoutFacets));
521          Assert.That(nonTableColumn.ColumnSize, Is.EqualTo(size));
522          Assert.That(nonTableColumn.NumericPrecision, Is.EqualTo(precision));
523          Assert.That(nonTableColumn.NumericScale, Is.EqualTo(scale));
524      }
525      [Test]
526      public async Task DefaultValue()
527      {
528          using var conn = await OpenConnectionAsync();
529          var table = await CreateTempTable(conn, &quot;with_default INTEGER DEFAULT(8), without_default INTEGER&quot;);
530          using var cmd = new NpgsqlCommand($&quot;SELECT with_default,without_default,8 FROM {table}&quot;, conn);
531          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
532          var columns = await GetColumnSchema(reader);
533          Assert.That(columns[0].DefaultValue, Is.EqualTo(&quot;8&quot;));
534          Assert.That(columns[1].DefaultValue, Is.Null);
535          Assert.That(columns[2].DefaultValue, Is.Null);
536      }
537      [Test]
538      public async Task Same_column_name()
539      {
540          using var conn = await OpenConnectionAsync();
541          var table1 = await GetTempTableName(conn);
542          var table2 = await GetTempTableName(conn);
543          await conn.ExecuteNonQueryAsync($@&quot;
544  CREATE TABLE {table1} (foo INTEGER);
545  CREATE TABLE {table2} (foo INTEGER)&quot;);
546          using var cmd = new NpgsqlCommand($&quot;SELECT {table1}.foo,{table2}.foo FROM {table1},{table2}&quot;, conn);
547          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
548          var columns = await GetColumnSchema(reader);
549          Assert.That(columns[0].ColumnName, Is.EqualTo(&quot;foo&quot;));
550          Assert.That(columns[0].BaseTableName, Does.StartWith(&quot;temp_table&quot;));
551          Assert.That(columns[1].ColumnName, Is.EqualTo(&quot;foo&quot;));
552          Assert.That(columns[1].BaseTableName, Does.StartWith(&quot;temp_table&quot;));
553          Assert.That(columns[0].BaseTableName, Is.Not.EqualTo(columns[1].BaseTableName));
554      }
555      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/1553&quot;)]
556      public async Task Domain_type()
557      {
558          using var conn = await OpenConnectionAsync();
559          IgnoreOnRedshift(conn, &quot;Domain types not support on Redshift&quot;);
560          const string domainTypeName = &quot;my_domain&quot;;
561          var schema = await CreateTempSchema(conn);
562          var tableName = await GetTempTableName(conn);
563          await conn.ExecuteNonQueryAsync($&quot;CREATE DOMAIN {schema}.{domainTypeName} AS varchar(2)&quot;);
564          conn.ReloadTypes();
565          await conn.ExecuteNonQueryAsync($&quot;CREATE TABLE {tableName} (domain {schema}.{domainTypeName})&quot;);
566          using var cmd = new NpgsqlCommand($&quot;SELECT domain FROM {tableName}&quot;, conn);
567          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
568          var columns = await GetColumnSchema(reader);
569          var domainSchema = columns.Single(c =&gt; c.ColumnName == &quot;domain&quot;);
570          Assert.That(domainSchema.ColumnSize, Is.EqualTo(2));
571          var pgType = domainSchema.PostgresType;
572          Assert.That(pgType, Is.InstanceOf&lt;PostgresDomainType&gt;());
573          Assert.That(((PostgresDomainType)pgType).BaseType.Name, Is.EqualTo(&quot;character varying&quot;));
574      }
575      [Test]
576      public async Task NpgsqlDbType()
577      {
578          using var conn = await OpenConnectionAsync();
579          var table = await CreateTempTable(conn, &quot;foo INTEGER&quot;);
580          using var cmd = new NpgsqlCommand($&quot;SELECT foo,8::INTEGER FROM {table}&quot;, conn);
581          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
582          var columns = await GetColumnSchema(reader);
583          Assert.That(columns[0].NpgsqlDbType, Is.EqualTo(NpgsqlTypes.NpgsqlDbType.Integer));
584          Assert.That(columns[1].NpgsqlDbType, Is.EqualTo(NpgsqlTypes.NpgsqlDbType.Integer));
585      }
586      [Test]
587      [NonParallelizable]
588      public async Task NpgsqlDbType_extension()
589      {
590          using var conn = await OpenConnectionAsync();
591          await EnsureExtensionAsync(conn, &quot;hstore&quot;, &quot;9.1&quot;);
592          using var cmd = new NpgsqlCommand(&quot;SELECT NULL::HSTORE&quot;, conn);
593          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
594          var columns = await GetColumnSchema(reader);
595          Assert.That(columns[0].NpgsqlDbType, Is.EqualTo(NpgsqlTypes.NpgsqlDbType.Hstore));
596      }
597      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/1950&quot;)]
598      public async Task No_resultset()
599      {
600          using var conn = await OpenConnectionAsync();
601          using var cmd = new NpgsqlCommand(&quot;COMMIT&quot;, conn);
602          using var reader = await cmd.ExecuteReaderAsync();
603          reader.Read();
604          await GetColumnSchema(reader);
605      }
606      [Test]
607      public async Task IsAliased()
608      {
609          await using var conn = await OpenConnectionAsync();
610          var table = await CreateTempTable(conn, &quot;foo INTEGER&quot;);
611          using var cmd = new NpgsqlCommand($&quot;SELECT foo, foo AS bar, NULL AS foobar FROM {table}&quot;, conn);
612          await using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
613          var columns = await GetColumnSchema(reader);
614          Assert.That(columns[0].IsAliased, Is.False);
615          Assert.That(columns[1].IsAliased, Is.True);
616          Assert.That(columns[2].IsAliased, Is.Null);
617      }
618      [Test] 
619      public async Task With_parameter_without_value()
620      {
621          await using var conn = await OpenConnectionAsync();
622          var table = await CreateTempTable(conn, &quot;foo INTEGER&quot;);
623          using var cmd = new NpgsqlCommand($&quot;SELECT foo FROM {table} WHERE foo &gt; @p&quot;, conn)
624          {
625              Parameters = { new() { ParameterName = &quot;p&quot;, NpgsqlDbType = NpgsqlTypes.NpgsqlDbType.Integer } }
626          };
627          await using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
628          var columns = await GetColumnSchema(reader);
629          Assert.That(columns[0].ColumnName, Is.EqualTo(&quot;foo&quot;));
630      }
631      #region Not supported
632      [Test]
633      public async Task IsExpression()
634      {
635          using var conn = await OpenConnectionAsync();
636          var table = await CreateTempTable(conn, &quot;foo INTEGER&quot;);
637          using var cmd = new NpgsqlCommand($&quot;SELECT * FROM {table}&quot;, conn);
638          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
639          Assert.That(reader.GetColumnSchema().Single().IsExpression, Is.False);
640      }
641      [Test]
642      public async Task IsHidden()
643      {
644          using var conn = await OpenConnectionAsync();
645          var table = await CreateTempTable(conn, &quot;foo INTEGER&quot;);
646          using var cmd = new NpgsqlCommand($&quot;SELECT * FROM {table}&quot;, conn);
647          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
648          Assert.That(reader.GetColumnSchema().Single().IsHidden, Is.False);
649      }
650      #endregion
651      class SomeComposite
652      {
653          public int Foo { get; set; }
654      }
655      public ReaderNewSchemaTests(SyncOrAsync syncOrAsync) : base(syncOrAsync) { }
656      async Task&lt;ReadOnlyCollection&lt;Schema.NpgsqlDbColumn&gt;&gt; GetColumnSchema(NpgsqlDataReader reader)
657          =&gt; IsAsync ? await reader.GetColumnSchemaAsync() : reader.GetColumnSchema();
658  }
</code></pre>
        </div>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-ReaderOldSchemaTests.cs</h3>
            <pre><code>1  using System;
2  using System.Data;
3  using System.Linq;
4  using System.Threading.Tasks;
5  using NUnit.Framework;
6  using static Npgsql.Tests.TestUtil;
7  namespace Npgsql.Tests;
8  public class ReaderOldSchemaTests : SyncOrAsyncTestBase
9  {
10      [Test]
11      public async Task Primary_key_composite()
12      {
13          using var conn = await OpenConnectionAsync();
14          var table = await GetTempTableName(conn);
<span onclick='openModal()' class='match'>15          await conn.ExecuteNonQueryAsync($@&quot;
16  CREATE TABLE {table} (
17      field_pk1 INT2 NOT NULL,
18      field_pk2 INT2 NOT NULL,
19      field_serial SERIAL,
20      CONSTRAINT {table}_pk PRIMARY KEY (field_pk1, field_pk2)
21  )&quot;);
22          using var command = new NpgsqlCommand($&quot;SELECT * FROM {table}&quot;, conn);
23          using var dr = command.ExecuteReader(CommandBehavior.KeyInfo);
</span>24          dr.Read();
25          var dataTable = await GetSchemaTable(dr);
26          var keyColumns = dataTable!.Rows.Cast&lt;DataRow&gt;().Where(r =&gt; (bool)r[&quot;IsKey&quot;]).ToArray()!;
27          Assert.That(keyColumns, Has.Length.EqualTo(2));
28          Assert.That(keyColumns.Count(c =&gt; (string)c[&quot;ColumnName&quot;] == &quot;field_pk1&quot;), Is.EqualTo(1));
29          Assert.That(keyColumns.Count(c =&gt; (string)c[&quot;ColumnName&quot;] == &quot;field_pk2&quot;), Is.EqualTo(1));
30      }
31      [Test]
32      public async Task Primary_key()
33      {
34          using var conn = await OpenConnectionAsync();
35          var table = await CreateTempTable(conn, &quot;id SERIAL PRIMARY KEY, serial SERIAL&quot;);
36          using var command = new NpgsqlCommand($&quot;SELECT * FROM {table}&quot;, conn);
37          using var dr = command.ExecuteReader(CommandBehavior.KeyInfo);
38          dr.Read();
39          var metadata = await GetSchemaTable(dr);
40          var key = metadata!.Rows.Cast&lt;DataRow&gt;().Single(r =&gt; (bool)r[&quot;IsKey&quot;])!;
41          Assert.That(key[&quot;ColumnName&quot;], Is.EqualTo(&quot;id&quot;));
42      }
43      [Test]
44      public async Task IsAutoIncrement()
45      {
46          await using var conn = await OpenConnectionAsync();
47          IgnoreOnRedshift(conn, &quot;Serial columns not supported on Redshift&quot;);
48          var table = await CreateTempTable(conn, &quot;serial SERIAL, int INT&quot;);
49          var command = new NpgsqlCommand($&quot;SELECT serial, int, 8 FROM {table}&quot;, conn);
50          await using var reader = command.ExecuteReader(CommandBehavior.KeyInfo);
51          var rows = (await GetSchemaTable(reader))!.Rows;
52          Assert.That(rows[0][&quot;IsAutoIncrement&quot;], Is.True);
53          Assert.That(rows[1][&quot;IsAutoIncrement&quot;], Is.False);
54          Assert.That(rows[2][&quot;IsAutoIncrement&quot;], Is.False);
55      }
56      [Test]
57      public async Task IsAutoIncrement_identity()
58      {
59          await using var conn = await OpenConnectionAsync();
60          IgnoreOnRedshift(conn, &quot;Serial columns not supported on Redshift&quot;);
61          MinimumPgVersion(conn, &quot;10.0&quot;, &quot;IDENTITY introduced in PostgreSQL 10&quot;);
62          var table =
63              await CreateTempTable(conn, &quot;identity1 INT GENERATED BY DEFAULT AS IDENTITY, identity2 INT GENERATED ALWAYS AS IDENTITY&quot;);
64          await using var command = new NpgsqlCommand($&quot;SELECT identity1, identity2 FROM {table}&quot;, conn);
65          await using var reader = command.ExecuteReader(CommandBehavior.KeyInfo);
66          var rows = (await GetSchemaTable(reader))!.Rows;
67          Assert.That(rows[0][&quot;IsAutoIncrement&quot;], Is.True);
68          Assert.That(rows[1][&quot;IsAutoIncrement&quot;], Is.True);
69      }
70      [Test]
71      public async Task IsIdentity()
72      {
73          await using var conn = await OpenConnectionAsync();
74          IgnoreOnRedshift(conn, &quot;Identity columns not support on Redshift&quot;);
75          MinimumPgVersion(conn, &quot;10.0&quot;, &quot;IDENTITY introduced in PostgreSQL 10&quot;);
76          var table = await CreateTempTable(
77              conn,
78              &quot;identity1 INT GENERATED BY DEFAULT AS IDENTITY, identity2 INT GENERATED ALWAYS AS IDENTITY, serial SERIAL, int INT&quot;);
79          await using var cmd = new NpgsqlCommand($&quot;SELECT identity1, identity2, serial, int, 8 FROM {table}&quot;, conn);
80          await using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
81          var rows = (await GetSchemaTable(reader))!.Rows;
82          Assert.That(rows[0][&quot;IsIdentity&quot;], Is.True);
83          Assert.That(rows[1][&quot;IsIdentity&quot;], Is.True);
84          Assert.That(rows[2][&quot;IsIdentity&quot;], Is.False);
85          Assert.That(rows[3][&quot;IsIdentity&quot;], Is.False);
86          Assert.That(rows[4][&quot;IsIdentity&quot;], Is.False);
87      }
88      [Test]
89      public async Task IsReadOnly()
90      {
91          using var conn = await OpenConnectionAsync();
92          var table = await GetTempTableName(conn);
93          var view = await GetTempViewName(conn);
94          await conn.ExecuteNonQueryAsync($@&quot;
95  CREATE TABLE {table} (id SERIAL PRIMARY KEY, int2 SMALLINT);
96  CREATE OR REPLACE VIEW {view} (id, int2) AS SELECT id, int2 + int2 AS int2 FROM {table}&quot;);
97          var command = new NpgsqlCommand($&quot;SELECT * FROM {view}&quot;, conn);
98          using var dr = command.ExecuteReader();
99          var metadata = await GetSchemaTable(dr);
100          foreach (var r in metadata!.Rows.OfType&lt;DataRow&gt;())
101          {
102              switch ((string)r[&quot;ColumnName&quot;])
103              {
104              case &quot;field_pk&quot;:
105                  if (conn.PostgreSqlVersion &lt; new Version(&quot;9.4&quot;))
106                  {
107                      Assert.IsTrue((bool)r[&quot;IsReadonly&quot;], &quot;field_pk&quot;);
108                  }
109                  else
110                  {
111                      Assert.IsFalse((bool)r[&quot;IsReadonly&quot;], &quot;field_pk&quot;);
112                  }
113                  break;
114              case &quot;field_int2&quot;:
115                  Assert.IsTrue((bool)r[&quot;IsReadonly&quot;]);
116                  break;
117              }
118          }
119      }
120      [Test]
121      public async Task AllowDBNull()
122      {
123          using var conn = await OpenConnectionAsync();
124          var table = await CreateTempTable(conn, &quot;nullable INTEGER, non_nullable INTEGER NOT NULL&quot;);
125          using var cmd = new NpgsqlCommand($&quot;SELECT * FROM {table}&quot;, conn);
126          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
127          using var metadata = await GetSchemaTable(reader);
128          foreach (var row in metadata!.Rows.OfType&lt;DataRow&gt;())
129          {
130              var isNullable = (bool)row[&quot;AllowDBNull&quot;];
131              switch ((string)row[&quot;ColumnName&quot;])
132              {
133              case &quot;nullable&quot;:
134                  Assert.IsTrue(isNullable);
135                  continue;
136              case &quot;non_nullable&quot;:
137                  Assert.IsFalse(isNullable);
138                  continue;
139              }
140          }
141      }
142      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/1027&quot;)]
143      public async Task Without_result()
144      {
145          using var conn = await OpenConnectionAsync();
146          using var cmd = new NpgsqlCommand(&quot;SELECT 1&quot;, conn);
147          using var reader = await cmd.ExecuteReaderAsync();
148          reader.NextResult();
149          var table = await GetSchemaTable(reader);
150          Assert.That(table, Is.Null);
151      }
152      [Test]
153      public async Task Precision_and_scale()
154      {
155          using var conn = await OpenConnectionAsync();
156          using var cmd = new NpgsqlCommand(&quot;SELECT 1::NUMERIC AS result&quot;, conn);
157          using var reader = await cmd.ExecuteReaderAsync();
158          var schemaTable = await GetSchemaTable(reader);
159          foreach (var myField in schemaTable!.Rows.OfType&lt;DataRow&gt;())
160          {
161              Assert.That(myField[&quot;NumericScale&quot;], Is.EqualTo(0));
162              Assert.That(myField[&quot;NumericPrecision&quot;], Is.EqualTo(0));
163          }
164      }
165      [Test]
166      public async Task SchemaOnly([Values(PrepareOrNot.NotPrepared, PrepareOrNot.Prepared)] PrepareOrNot prepare)
167      {
168          using var conn = await OpenConnectionAsync();
169          var table = await CreateTempTable(conn, &quot;name TEXT&quot;);
170          var query = $@&quot;
171  SELECT 1 AS some_column;
172  UPDATE {table} SET name=&#x27;yo&#x27; WHERE 1=0;
173  SELECT 1 AS some_other_column, 2&quot;;
174          using var cmd = new NpgsqlCommand(query, conn);
175          if (prepare == PrepareOrNot.Prepared)
176              cmd.Prepare();
177          using (var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly))
178          {
179              Assert.That(reader.Read(), Is.False);
180              var t = await GetSchemaTable(reader);
181              Assert.That(t!.Rows[0][&quot;ColumnName&quot;], Is.EqualTo(&quot;some_column&quot;));
182              Assert.That(reader.NextResult(), Is.True);
183              Assert.That(reader.Read(), Is.False);
184              t = await GetSchemaTable(reader);
185              Assert.That(t!.Rows[0][&quot;ColumnName&quot;], Is.EqualTo(&quot;some_other_column&quot;));
186              Assert.That(t.Rows[1][&quot;ColumnName&quot;], Is.EqualTo(&quot;?column?&quot;));
187              Assert.That(reader.NextResult(), Is.False);
188          }
189          using (var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly))
190              reader.Read();
191      }
192      [Test]
193      public async Task BaseColumnName()
194      {
195          using var conn = OpenConnection();
196          conn.ExecuteNonQuery(@&quot;
197                  CREATE TEMP TABLE data (
198                      Cod varchar(5) NOT NULL,
199                      Descr varchar(40),
200                      Date date,
201                      CONSTRAINT PK_test_Cod PRIMARY KEY (Cod)
202                  );
203              &quot;);
204          var cmd = new NpgsqlCommand(&quot;SELECT Cod as CodAlias, Descr as DescrAlias, Date FROM data&quot;, conn);
205          using var dr = cmd.ExecuteReader(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
206          var dt = await GetSchemaTable(dr);
207          Assert.That(dt!.Rows[0][&quot;BaseColumnName&quot;].ToString(), Is.EqualTo(&quot;cod&quot;));
208          Assert.That(dt.Rows[0][&quot;ColumnName&quot;].ToString(), Is.EqualTo(&quot;codalias&quot;));
209          Assert.That(dt.Rows[1][&quot;BaseColumnName&quot;].ToString(), Is.EqualTo(&quot;descr&quot;));
210          Assert.That(dt.Rows[1][&quot;ColumnName&quot;].ToString(), Is.EqualTo(&quot;descralias&quot;));
211          Assert.That(dt.Rows[2][&quot;BaseColumnName&quot;].ToString(), Is.EqualTo(&quot;date&quot;));
212          Assert.That(dt.Rows[2][&quot;ColumnName&quot;].ToString(), Is.EqualTo(&quot;date&quot;));
213      }
214      public ReaderOldSchemaTests(SyncOrAsync syncOrAsync) : base(syncOrAsync) { }
215      async Task&lt;DataTable?&gt; GetSchemaTable(NpgsqlDataReader dr) =&gt; IsAsync ? await dr.GetSchemaTableAsync() : dr.GetSchemaTable();
216  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-ReaderNewSchemaTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-ReaderOldSchemaTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>267          await conn.ExecuteNonQueryAsync($@&quot;
268  CREATE VIEW {view} AS SELECT 8 AS foo;
269  CREATE TABLE {table} (bar INTEGER)&quot;);
270          using var cmd = new NpgsqlCommand($&quot;SELECT foo,bar FROM {view},{table}&quot;, conn);
271          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly | CommandBehavior.KeyInfo);
</pre></code></div>
                <div class="column column_space"><pre><code>15          await conn.ExecuteNonQueryAsync($@&quot;
16  CREATE TABLE {table} (
17      field_pk1 INT2 NOT NULL,
18      field_pk2 INT2 NOT NULL,
19      field_serial SERIAL,
20      CONSTRAINT {table}_pk PRIMARY KEY (field_pk1, field_pk2)
21  )&quot;);
22          using var command = new NpgsqlCommand($&quot;SELECT * FROM {table}&quot;, conn);
23          using var dr = command.ExecuteReader(CommandBehavior.KeyInfo);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    