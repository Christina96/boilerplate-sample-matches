
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 15, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-CookiePolicyTests.cs</h3>
            <pre><code>1  using System;
2  using System.Security.Claims;
3  using System.Security.Principal;
4  using System.Threading.Tasks;
5  using Microsoft.AspNetCore.Authentication;
6  using Microsoft.AspNetCore.Authentication.Cookies;
7  using Microsoft.AspNetCore.Builder;
8  using Microsoft.AspNetCore.Hosting;
9  using Microsoft.AspNetCore.Http;
10  using Microsoft.AspNetCore.Http.Features;
11  using Microsoft.AspNetCore.TestHost;
12  using Microsoft.Extensions.DependencyInjection;
13  using Microsoft.Net.Http.Headers;
14  using Xunit;
15  namespace Microsoft.AspNetCore.CookiePolicy.Test
16  {
17      public class CookiePolicyTests
18      {
19          private RequestDelegate SecureCookieAppends = context =>
20          {
21              context.Response.Cookies.Append("A", "A");
22              context.Response.Cookies.Append("B", "B", new CookieOptions { Secure = false });
23              context.Response.Cookies.Append("C", "C", new CookieOptions());
24              context.Response.Cookies.Append("D", "D", new CookieOptions { Secure = true });
25              return Task.FromResult(0);
26          };
27          private RequestDelegate HttpCookieAppends = context =>
28          {
29              context.Response.Cookies.Append("A", "A");
30              context.Response.Cookies.Append("B", "B", new CookieOptions { HttpOnly = false });
31              context.Response.Cookies.Append("C", "C", new CookieOptions());
32              context.Response.Cookies.Append("D", "D", new CookieOptions { HttpOnly = true });
33              return Task.FromResult(0);
34          };
35          private RequestDelegate SameSiteCookieAppends = context =>
36          {
37              context.Response.Cookies.Append("A", "A");
38              context.Response.Cookies.Append("B", "B", new CookieOptions { SameSite = Http.SameSiteMode.None });
39              context.Response.Cookies.Append("C", "C", new CookieOptions());
40              context.Response.Cookies.Append("D", "D", new CookieOptions { SameSite = Http.SameSiteMode.Lax });
41              context.Response.Cookies.Append("E", "E", new CookieOptions { SameSite = Http.SameSiteMode.Strict });
42              return Task.FromResult(0);
43          };
44          [Fact]
45          public async Task SecureAlwaysSetsSecure()
46          {
47              await RunTest("/secureAlways",
48                  new CookiePolicyOptions
49                  {
50                      Secure = CookieSecurePolicy.Always
51                  },
52                  SecureCookieAppends,
53                  new RequestTest("http:&bsol;&bsol;example.com/secureAlways",
54                      transaction =>
55                      {
56                          Assert.NotNull(transaction.SetCookie);
57                          Assert.Equal("A=A; path=/; secure; samesite=lax", transaction.SetCookie[0]);
58                          Assert.Equal("B=B; path=/; secure; samesite=lax", transaction.SetCookie[1]);
59                          Assert.Equal("C=C; path=/; secure; samesite=lax", transaction.SetCookie[2]);
60                          Assert.Equal("D=D; path=/; secure; samesite=lax", transaction.SetCookie[3]);
61                      }));
62          }
63          [Fact]
64          public async Task SecureNoneLeavesSecureUnchanged()
65          {
66              await RunTest("/secureNone",
67                  new CookiePolicyOptions
68                  {
69                      Secure = CookieSecurePolicy.None
70                  },
71                  SecureCookieAppends,
72                  new RequestTest("http:&bsol;&bsol;example.com/secureNone",
73                      transaction =>
74                      {
75                          Assert.NotNull(transaction.SetCookie);
76                          Assert.Equal("A=A; path=/; samesite=lax", transaction.SetCookie[0]);
77                          Assert.Equal("B=B; path=/; samesite=lax", transaction.SetCookie[1]);
78                          Assert.Equal("C=C; path=/; samesite=lax", transaction.SetCookie[2]);
79                          Assert.Equal("D=D; path=/; secure; samesite=lax", transaction.SetCookie[3]);
80                      }));
81          }
82          [Fact]
83          public async Task SecureSameUsesRequest()
84          {
85              await RunTest("/secureSame",
86                  new CookiePolicyOptions
87                  {
88                      Secure = CookieSecurePolicy.SameAsRequest
89                  },
90                  SecureCookieAppends,
91                  new RequestTest("http:&bsol;&bsol;example.com/secureSame",
92                      transaction =>
93                      {
94                          Assert.NotNull(transaction.SetCookie);
95                          Assert.Equal("A=A; path=/; samesite=lax", transaction.SetCookie[0]);
96                          Assert.Equal("B=B; path=/; samesite=lax", transaction.SetCookie[1]);
97                          Assert.Equal("C=C; path=/; samesite=lax", transaction.SetCookie[2]);
98                          Assert.Equal("D=D; path=/; secure; samesite=lax", transaction.SetCookie[3]);
99                      }),
100                  new RequestTest("https:&bsol;&bsol;example.com/secureSame",
101                      transaction =>
102                      {
103                          Assert.NotNull(transaction.SetCookie);
104                          Assert.Equal("A=A; path=/; secure; samesite=lax", transaction.SetCookie[0]);
105                          Assert.Equal("B=B; path=/; secure; samesite=lax", transaction.SetCookie[1]);
106                          Assert.Equal("C=C; path=/; secure; samesite=lax", transaction.SetCookie[2]);
107                          Assert.Equal("D=D; path=/; secure; samesite=lax", transaction.SetCookie[3]);
108                      }));
109          }
110          [Fact]
111          public async Task HttpOnlyAlwaysSetsItAlways()
112          {
113              await RunTest("/httpOnlyAlways",
114                  new CookiePolicyOptions
115                  {
116                      HttpOnly = HttpOnlyPolicy.Always
117                  },
118                  HttpCookieAppends,
119                  new RequestTest("http:&bsol;&bsol;example.com/httpOnlyAlways",
120                  transaction =>
121                  {
122                      Assert.NotNull(transaction.SetCookie);
123                      Assert.Equal("A=A; path=/; samesite=lax; httponly", transaction.SetCookie[0]);
124                      Assert.Equal("B=B; path=/; samesite=lax; httponly", transaction.SetCookie[1]);
125                      Assert.Equal("C=C; path=/; samesite=lax; httponly", transaction.SetCookie[2]);
126                      Assert.Equal("D=D; path=/; samesite=lax; httponly", transaction.SetCookie[3]);
127                  }));
128          }
129          [Fact]
130          public async Task HttpOnlyNoneLeavesItAlone()
131          {
132              await RunTest("/httpOnlyNone",
133                  new CookiePolicyOptions
134                  {
135                      HttpOnly = HttpOnlyPolicy.None
136                  },
137                  HttpCookieAppends,
138                  new RequestTest("http:&bsol;&bsol;example.com/httpOnlyNone",
139                  transaction =>
140                  {
141                      Assert.NotNull(transaction.SetCookie);
142                      Assert.Equal("A=A; path=/; samesite=lax", transaction.SetCookie[0]);
143                      Assert.Equal("B=B; path=/; samesite=lax", transaction.SetCookie[1]);
144                      Assert.Equal("C=C; path=/; samesite=lax", transaction.SetCookie[2]);
145                      Assert.Equal("D=D; path=/; samesite=lax; httponly", transaction.SetCookie[3]);
146                  }));
147          }
148          [Fact]
149          public async Task SameSiteStrictSetsItAlways()
150          {
151              await RunTest("/sameSiteStrict",
152                  new CookiePolicyOptions
153                  {
154                      MinimumSameSitePolicy = Http.SameSiteMode.Strict
155                  },
156                  SameSiteCookieAppends,
157                  new RequestTest("http:&bsol;&bsol;example.com/sameSiteStrict",
158                  transaction =>
159                  {
160                      Assert.NotNull(transaction.SetCookie);
161                      Assert.Equal("A=A; path=/; samesite=strict", transaction.SetCookie[0]);
162                      Assert.Equal("B=B; path=/; samesite=strict", transaction.SetCookie[1]);
163                      Assert.Equal("C=C; path=/; samesite=strict", transaction.SetCookie[2]);
164                      Assert.Equal("D=D; path=/; samesite=strict", transaction.SetCookie[3]);
165                      Assert.Equal("E=E; path=/; samesite=strict", transaction.SetCookie[4]);
166                  }));
167          }
168          [Fact]
169          public async Task SameSiteLaxSetsItAlways()
170          {
171              await RunTest("/sameSiteLax",
172                  new CookiePolicyOptions
173                  {
174                      MinimumSameSitePolicy = Http.SameSiteMode.Lax
175                  },
176                  SameSiteCookieAppends,
177                  new RequestTest("http:&bsol;&bsol;example.com/sameSiteLax",
178                  transaction =>
179                  {
180                      Assert.NotNull(transaction.SetCookie);
181                      Assert.Equal("A=A; path=/; samesite=lax", transaction.SetCookie[0]);
182                      Assert.Equal("B=B; path=/; samesite=lax", transaction.SetCookie[1]);
183                      Assert.Equal("C=C; path=/; samesite=lax", transaction.SetCookie[2]);
184                      Assert.Equal("D=D; path=/; samesite=lax", transaction.SetCookie[3]);
185                      Assert.Equal("E=E; path=/; samesite=strict", transaction.SetCookie[4]);
186                  }));
187          }
188          [Fact]
189          public async Task SameSiteNoneLeavesItAlone()
190          {
191              await RunTest("/sameSiteNone",
192                  new CookiePolicyOptions
193                  {
194                      MinimumSameSitePolicy = Http.SameSiteMode.None
195                  },
196                  SameSiteCookieAppends,
197                  new RequestTest("http:&bsol;&bsol;example.com/sameSiteNone",
198                  transaction =>
199                  {
200                      Assert.NotNull(transaction.SetCookie);
201                      Assert.Equal("A=A; path=/", transaction.SetCookie[0]);
202                      Assert.Equal("B=B; path=/", transaction.SetCookie[1]);
203                      Assert.Equal("C=C; path=/; samesite=lax", transaction.SetCookie[2]);
204                      Assert.Equal("D=D; path=/; samesite=lax", transaction.SetCookie[3]);
205                      Assert.Equal("E=E; path=/; samesite=strict", transaction.SetCookie[4]);
206                  }));
207          }
208          [Fact]
209          public async Task CookiePolicyCanHijackAppend()
210          {
211              var builder = new WebHostBuilder()
212                  .Configure(app =>
213                  {
214                      app.UseCookiePolicy(new CookiePolicyOptions
215                      {
216                          OnAppendCookie = ctx => ctx.CookieName = ctx.CookieValue = "Hao"
217                      });
218                      app.Run(context =>
219                      {
220                          context.Response.Cookies.Append("A", "A");
221                          context.Response.Cookies.Append("B", "B", new CookieOptions { Secure = false });
222                          context.Response.Cookies.Append("C", "C", new CookieOptions());
223                          context.Response.Cookies.Append("D", "D", new CookieOptions { Secure = true });
224                          return Task.FromResult(0);
225                      });
226                  });
227              var server = new TestServer(builder);
228              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/login");
229              Assert.NotNull(transaction.SetCookie);
230              Assert.Equal("Hao=Hao; path=/; samesite=lax", transaction.SetCookie[0]);
231              Assert.Equal("Hao=Hao; path=/; samesite=lax", transaction.SetCookie[1]);
232              Assert.Equal("Hao=Hao; path=/; samesite=lax", transaction.SetCookie[2]);
233              Assert.Equal("Hao=Hao; path=/; secure; samesite=lax", transaction.SetCookie[3]);
234          }
235          [Fact]
236          public async Task CookiePolicyCanHijackDelete()
237          {
238              var builder = new WebHostBuilder()
239                  .Configure(app =>
240              {
241                  app.UseCookiePolicy(new CookiePolicyOptions
242                  {
243                      OnDeleteCookie = ctx => ctx.CookieName = "A"
244                  });
245                  app.Run(context =>
246                  {
247                      context.Response.Cookies.Delete("A");
248                      context.Response.Cookies.Delete("B", new CookieOptions { Secure = false });
249                      context.Response.Cookies.Delete("C", new CookieOptions());
250                      context.Response.Cookies.Delete("D", new CookieOptions { Secure = true });
251                      return Task.FromResult(0);
252                  });
253              });
254              var server = new TestServer(builder);
255              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/login");
256              Assert.NotNull(transaction.SetCookie);
257              Assert.Equal(1, transaction.SetCookie.Count);
258              Assert.Equal("A=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; secure; samesite=lax", transaction.SetCookie[0]);
259          }
260          [Fact]
261          public async Task CookiePolicyCallsCookieFeature()
262          {
263              var builder = new WebHostBuilder()
264                  .Configure(app =>
265              {
266                  app.Use(next => context =>
267                  {
268                      context.Features.Set<IResponseCookiesFeature>(new TestCookieFeature());
269                      return next(context);
270                  });
271                  app.UseCookiePolicy(new CookiePolicyOptions
272                  {
273                      OnDeleteCookie = ctx => ctx.CookieName = "A"
274                  });
275                  app.Run(context =>
276                  {
277                      Assert.Throws<NotImplementedException>(() => context.Response.Cookies.Delete("A"));
278                      Assert.Throws<NotImplementedException>(() => context.Response.Cookies.Delete("A", new CookieOptions()));
279                      Assert.Throws<NotImplementedException>(() => context.Response.Cookies.Append("A", "A"));
280                      Assert.Throws<NotImplementedException>(() => context.Response.Cookies.Append("A", "A", new CookieOptions()));
281                      return context.Response.WriteAsync("Done");
282                  });
283              });
284              var server = new TestServer(builder);
285              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/login");
286              Assert.Equal("Done", transaction.ResponseText);
287          }
288          [Fact]
289          public async Task CookiePolicyAppliesToCookieAuth()
290          {
291              var builder = new WebHostBuilder()
292                  .ConfigureServices(services =>
293                  {
294                      services.AddAuthentication().AddCookie(o =>
295                      {
296                          o.Cookie.Name = "TestCookie";
297                          o.Cookie.HttpOnly = false;
298                          o.Cookie.SecurePolicy = CookieSecurePolicy.None;
299                      });
300                  })
301                  .Configure(app =>
302                  {
303                      app.UseCookiePolicy(new CookiePolicyOptions
304                      {
305                          HttpOnly = HttpOnlyPolicy.Always,
306                          Secure = CookieSecurePolicy.Always,
307                      });
308                      app.UseAuthentication();
309                      app.Run(context =>
310                      {
311                          return context.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme,
312                              new ClaimsPrincipal(new ClaimsIdentity(new GenericIdentity("TestUser", "Cookies"))));
313                      });
314                  });
315              var server = new TestServer(builder);
316              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/login");
317              Assert.NotNull(transaction.SetCookie);
318              Assert.Equal(1, transaction.SetCookie.Count);
319              var cookie = SetCookieHeaderValue.Parse(transaction.SetCookie[0]);
320              Assert.Equal("TestCookie", cookie.Name);
321              Assert.True(cookie.HttpOnly);
322              Assert.True(cookie.Secure);
323              Assert.Equal("/", cookie.Path);
324          }
325          [Fact]
326          public async Task CookiePolicyAppliesToCookieAuthChunks()
327          {
328              var builder = new WebHostBuilder()
329                  .ConfigureServices(services =>
330                  {
331                      services.AddAuthentication().AddCookie(o =>
332                      {
333                          o.Cookie.Name = "TestCookie";
334                          o.Cookie.HttpOnly = false;
335                          o.Cookie.SecurePolicy = CookieSecurePolicy.None;
336                      });
337                  })
338                  .Configure(app =>
339                  {
340                      app.UseCookiePolicy(new CookiePolicyOptions
341                      {
342                          HttpOnly = HttpOnlyPolicy.Always,
343                          Secure = CookieSecurePolicy.Always,
344                      });
345                      app.UseAuthentication();
346                      app.Run(context =>
347                      {
348                          return context.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme,
349                              new ClaimsPrincipal(new ClaimsIdentity(new GenericIdentity(new string('c', 1024 * 5), "Cookies"))));
350                      });
351                  });
352              var server = new TestServer(builder);
353              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/login");
354              Assert.NotNull(transaction.SetCookie);
355              Assert.Equal(3, transaction.SetCookie.Count);
<span onclick='openModal()' class='match'>356              var cookie = SetCookieHeaderValue.Parse(transaction.SetCookie[0]);
357              Assert.Equal("TestCookie", cookie.Name);
</span>358              Assert.Equal("chunks-2", cookie.Value);
359              Assert.True(cookie.HttpOnly);
360              Assert.True(cookie.Secure);
361              Assert.Equal("/", cookie.Path);
362              cookie = SetCookieHeaderValue.Parse(transaction.SetCookie[1]);
363              Assert.Equal("TestCookieC1", cookie.Name);
364              Assert.True(cookie.HttpOnly);
365              Assert.True(cookie.Secure);
366              Assert.Equal("/", cookie.Path);
367              cookie = SetCookieHeaderValue.Parse(transaction.SetCookie[2]);
368              Assert.Equal("TestCookieC2", cookie.Name);
369              Assert.True(cookie.HttpOnly);
370              Assert.True(cookie.Secure);
371              Assert.Equal("/", cookie.Path);
372          }
373          private class TestCookieFeature : IResponseCookiesFeature
374          {
375              public IResponseCookies Cookies { get; } = new BadCookies();
376              private class BadCookies : IResponseCookies
377              {
378                  public void Append(string key, string value)
379                  {
380                      throw new NotImplementedException();
381                  }
382                  public void Append(string key, string value, CookieOptions options)
383                  {
384                      throw new NotImplementedException();
385                  }
386                  public void Delete(string key)
387                  {
388                      throw new NotImplementedException();
389                  }
390                  public void Delete(string key, CookieOptions options)
391                  {
392                      throw new NotImplementedException();
393                  }
394              }
395          }
396          private class RequestTest
397          {
398              public RequestTest(string testUri, Action<Transaction> verify)
399              {
400                  TestUri = testUri;
401                  Verification = verify;
402              }
403              public async Task Execute(TestServer server)
404              {
405                  var transaction = await server.SendAsync(TestUri);
406                  Verification(transaction);
407              }
408              public string TestUri { get; set; }
409              public Action<Transaction> Verification { get; set; }
410          }
411          private async Task RunTest(
412              string path,
413              CookiePolicyOptions cookiePolicy,
414              RequestDelegate configureSetup,
415              params RequestTest[] tests)
416          {
417              var builder = new WebHostBuilder()
418                  .Configure(app =>
419                  {
420                      app.Map(path, map =>
421                      {
422                          map.UseCookiePolicy(cookiePolicy);
423                          map.Run(configureSetup);
424                      });
425                  });
426              var server = new TestServer(builder);
427              foreach (var test in tests)
428              {
429                  await test.Execute(server);
430              }
431          }
432      }
433  }
</code></pre>
        </div>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-CookiePolicyTests.cs</h3>
            <pre><code>1  using System;
2  using System.Security.Claims;
3  using System.Security.Principal;
4  using System.Threading.Tasks;
5  using Microsoft.AspNetCore.Authentication;
6  using Microsoft.AspNetCore.Authentication.Cookies;
7  using Microsoft.AspNetCore.Builder;
8  using Microsoft.AspNetCore.Hosting;
9  using Microsoft.AspNetCore.Http;
10  using Microsoft.AspNetCore.Http.Features;
11  using Microsoft.AspNetCore.TestHost;
12  using Microsoft.Extensions.DependencyInjection;
13  using Microsoft.Net.Http.Headers;
14  using Xunit;
15  namespace Microsoft.AspNetCore.CookiePolicy.Test
16  {
17      public class CookiePolicyTests
18      {
19          private RequestDelegate SecureCookieAppends = context =>
20          {
21              context.Response.Cookies.Append("A", "A");
22              context.Response.Cookies.Append("B", "B", new CookieOptions { Secure = false });
23              context.Response.Cookies.Append("C", "C", new CookieOptions());
24              context.Response.Cookies.Append("D", "D", new CookieOptions { Secure = true });
25              return Task.FromResult(0);
26          };
27          private RequestDelegate HttpCookieAppends = context =>
28          {
29              context.Response.Cookies.Append("A", "A");
30              context.Response.Cookies.Append("B", "B", new CookieOptions { HttpOnly = false });
31              context.Response.Cookies.Append("C", "C", new CookieOptions());
32              context.Response.Cookies.Append("D", "D", new CookieOptions { HttpOnly = true });
33              return Task.FromResult(0);
34          };
35          private RequestDelegate SameSiteCookieAppends = context =>
36          {
37              context.Response.Cookies.Append("A", "A");
38              context.Response.Cookies.Append("B", "B", new CookieOptions { SameSite = Http.SameSiteMode.None });
39              context.Response.Cookies.Append("C", "C", new CookieOptions());
40              context.Response.Cookies.Append("D", "D", new CookieOptions { SameSite = Http.SameSiteMode.Lax });
41              context.Response.Cookies.Append("E", "E", new CookieOptions { SameSite = Http.SameSiteMode.Strict });
42              return Task.FromResult(0);
43          };
44          [Fact]
45          public async Task SecureAlwaysSetsSecure()
46          {
47              await RunTest("/secureAlways",
48                  new CookiePolicyOptions
49                  {
50                      Secure = CookieSecurePolicy.Always
51                  },
52                  SecureCookieAppends,
53                  new RequestTest("http:&bsol;&bsol;example.com/secureAlways",
54                      transaction =>
55                      {
56                          Assert.NotNull(transaction.SetCookie);
57                          Assert.Equal("A=A; path=/; secure; samesite=lax", transaction.SetCookie[0]);
58                          Assert.Equal("B=B; path=/; secure; samesite=lax", transaction.SetCookie[1]);
59                          Assert.Equal("C=C; path=/; secure; samesite=lax", transaction.SetCookie[2]);
60                          Assert.Equal("D=D; path=/; secure; samesite=lax", transaction.SetCookie[3]);
61                      }));
62          }
63          [Fact]
64          public async Task SecureNoneLeavesSecureUnchanged()
65          {
66              await RunTest("/secureNone",
67                  new CookiePolicyOptions
68                  {
69                      Secure = CookieSecurePolicy.None
70                  },
71                  SecureCookieAppends,
72                  new RequestTest("http:&bsol;&bsol;example.com/secureNone",
73                      transaction =>
74                      {
75                          Assert.NotNull(transaction.SetCookie);
76                          Assert.Equal("A=A; path=/; samesite=lax", transaction.SetCookie[0]);
77                          Assert.Equal("B=B; path=/; samesite=lax", transaction.SetCookie[1]);
78                          Assert.Equal("C=C; path=/; samesite=lax", transaction.SetCookie[2]);
79                          Assert.Equal("D=D; path=/; secure; samesite=lax", transaction.SetCookie[3]);
80                      }));
81          }
82          [Fact]
83          public async Task SecureSameUsesRequest()
84          {
85              await RunTest("/secureSame",
86                  new CookiePolicyOptions
87                  {
88                      Secure = CookieSecurePolicy.SameAsRequest
89                  },
90                  SecureCookieAppends,
91                  new RequestTest("http:&bsol;&bsol;example.com/secureSame",
92                      transaction =>
93                      {
94                          Assert.NotNull(transaction.SetCookie);
95                          Assert.Equal("A=A; path=/; samesite=lax", transaction.SetCookie[0]);
96                          Assert.Equal("B=B; path=/; samesite=lax", transaction.SetCookie[1]);
97                          Assert.Equal("C=C; path=/; samesite=lax", transaction.SetCookie[2]);
98                          Assert.Equal("D=D; path=/; secure; samesite=lax", transaction.SetCookie[3]);
99                      }),
100                  new RequestTest("https:&bsol;&bsol;example.com/secureSame",
101                      transaction =>
102                      {
103                          Assert.NotNull(transaction.SetCookie);
104                          Assert.Equal("A=A; path=/; secure; samesite=lax", transaction.SetCookie[0]);
105                          Assert.Equal("B=B; path=/; secure; samesite=lax", transaction.SetCookie[1]);
106                          Assert.Equal("C=C; path=/; secure; samesite=lax", transaction.SetCookie[2]);
107                          Assert.Equal("D=D; path=/; secure; samesite=lax", transaction.SetCookie[3]);
108                      }));
109          }
110          [Fact]
111          public async Task HttpOnlyAlwaysSetsItAlways()
112          {
113              await RunTest("/httpOnlyAlways",
114                  new CookiePolicyOptions
115                  {
116                      HttpOnly = HttpOnlyPolicy.Always
117                  },
118                  HttpCookieAppends,
119                  new RequestTest("http:&bsol;&bsol;example.com/httpOnlyAlways",
120                  transaction =>
121                  {
122                      Assert.NotNull(transaction.SetCookie);
123                      Assert.Equal("A=A; path=/; samesite=lax; httponly", transaction.SetCookie[0]);
124                      Assert.Equal("B=B; path=/; samesite=lax; httponly", transaction.SetCookie[1]);
125                      Assert.Equal("C=C; path=/; samesite=lax; httponly", transaction.SetCookie[2]);
126                      Assert.Equal("D=D; path=/; samesite=lax; httponly", transaction.SetCookie[3]);
127                  }));
128          }
129          [Fact]
130          public async Task HttpOnlyNoneLeavesItAlone()
131          {
132              await RunTest("/httpOnlyNone",
133                  new CookiePolicyOptions
134                  {
135                      HttpOnly = HttpOnlyPolicy.None
136                  },
137                  HttpCookieAppends,
138                  new RequestTest("http:&bsol;&bsol;example.com/httpOnlyNone",
139                  transaction =>
140                  {
141                      Assert.NotNull(transaction.SetCookie);
142                      Assert.Equal("A=A; path=/; samesite=lax", transaction.SetCookie[0]);
143                      Assert.Equal("B=B; path=/; samesite=lax", transaction.SetCookie[1]);
144                      Assert.Equal("C=C; path=/; samesite=lax", transaction.SetCookie[2]);
145                      Assert.Equal("D=D; path=/; samesite=lax; httponly", transaction.SetCookie[3]);
146                  }));
147          }
148          [Fact]
149          public async Task SameSiteStrictSetsItAlways()
150          {
151              await RunTest("/sameSiteStrict",
152                  new CookiePolicyOptions
153                  {
154                      MinimumSameSitePolicy = Http.SameSiteMode.Strict
155                  },
156                  SameSiteCookieAppends,
157                  new RequestTest("http:&bsol;&bsol;example.com/sameSiteStrict",
158                  transaction =>
159                  {
160                      Assert.NotNull(transaction.SetCookie);
161                      Assert.Equal("A=A; path=/; samesite=strict", transaction.SetCookie[0]);
162                      Assert.Equal("B=B; path=/; samesite=strict", transaction.SetCookie[1]);
163                      Assert.Equal("C=C; path=/; samesite=strict", transaction.SetCookie[2]);
164                      Assert.Equal("D=D; path=/; samesite=strict", transaction.SetCookie[3]);
165                      Assert.Equal("E=E; path=/; samesite=strict", transaction.SetCookie[4]);
166                  }));
167          }
168          [Fact]
169          public async Task SameSiteLaxSetsItAlways()
170          {
171              await RunTest("/sameSiteLax",
172                  new CookiePolicyOptions
173                  {
174                      MinimumSameSitePolicy = Http.SameSiteMode.Lax
175                  },
176                  SameSiteCookieAppends,
177                  new RequestTest("http:&bsol;&bsol;example.com/sameSiteLax",
178                  transaction =>
179                  {
180                      Assert.NotNull(transaction.SetCookie);
181                      Assert.Equal("A=A; path=/; samesite=lax", transaction.SetCookie[0]);
182                      Assert.Equal("B=B; path=/; samesite=lax", transaction.SetCookie[1]);
183                      Assert.Equal("C=C; path=/; samesite=lax", transaction.SetCookie[2]);
184                      Assert.Equal("D=D; path=/; samesite=lax", transaction.SetCookie[3]);
185                      Assert.Equal("E=E; path=/; samesite=strict", transaction.SetCookie[4]);
186                  }));
187          }
188          [Fact]
189          public async Task SameSiteNoneLeavesItAlone()
190          {
191              await RunTest("/sameSiteNone",
192                  new CookiePolicyOptions
193                  {
194                      MinimumSameSitePolicy = Http.SameSiteMode.None
195                  },
196                  SameSiteCookieAppends,
197                  new RequestTest("http:&bsol;&bsol;example.com/sameSiteNone",
198                  transaction =>
199                  {
200                      Assert.NotNull(transaction.SetCookie);
201                      Assert.Equal("A=A; path=/", transaction.SetCookie[0]);
202                      Assert.Equal("B=B; path=/", transaction.SetCookie[1]);
203                      Assert.Equal("C=C; path=/; samesite=lax", transaction.SetCookie[2]);
204                      Assert.Equal("D=D; path=/; samesite=lax", transaction.SetCookie[3]);
205                      Assert.Equal("E=E; path=/; samesite=strict", transaction.SetCookie[4]);
206                  }));
207          }
208          [Fact]
209          public async Task CookiePolicyCanHijackAppend()
210          {
211              var builder = new WebHostBuilder()
212                  .Configure(app =>
213                  {
214                      app.UseCookiePolicy(new CookiePolicyOptions
215                      {
216                          OnAppendCookie = ctx => ctx.CookieName = ctx.CookieValue = "Hao"
217                      });
218                      app.Run(context =>
219                      {
220                          context.Response.Cookies.Append("A", "A");
221                          context.Response.Cookies.Append("B", "B", new CookieOptions { Secure = false });
222                          context.Response.Cookies.Append("C", "C", new CookieOptions());
223                          context.Response.Cookies.Append("D", "D", new CookieOptions { Secure = true });
224                          return Task.FromResult(0);
225                      });
226                  });
227              var server = new TestServer(builder);
228              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/login");
229              Assert.NotNull(transaction.SetCookie);
230              Assert.Equal("Hao=Hao; path=/; samesite=lax", transaction.SetCookie[0]);
231              Assert.Equal("Hao=Hao; path=/; samesite=lax", transaction.SetCookie[1]);
232              Assert.Equal("Hao=Hao; path=/; samesite=lax", transaction.SetCookie[2]);
233              Assert.Equal("Hao=Hao; path=/; secure; samesite=lax", transaction.SetCookie[3]);
234          }
235          [Fact]
236          public async Task CookiePolicyCanHijackDelete()
237          {
238              var builder = new WebHostBuilder()
239                  .Configure(app =>
240              {
241                  app.UseCookiePolicy(new CookiePolicyOptions
242                  {
243                      OnDeleteCookie = ctx => ctx.CookieName = "A"
244                  });
245                  app.Run(context =>
246                  {
247                      context.Response.Cookies.Delete("A");
248                      context.Response.Cookies.Delete("B", new CookieOptions { Secure = false });
249                      context.Response.Cookies.Delete("C", new CookieOptions());
250                      context.Response.Cookies.Delete("D", new CookieOptions { Secure = true });
251                      return Task.FromResult(0);
252                  });
253              });
254              var server = new TestServer(builder);
255              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/login");
256              Assert.NotNull(transaction.SetCookie);
257              Assert.Equal(1, transaction.SetCookie.Count);
258              Assert.Equal("A=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; secure; samesite=lax", transaction.SetCookie[0]);
259          }
260          [Fact]
261          public async Task CookiePolicyCallsCookieFeature()
262          {
263              var builder = new WebHostBuilder()
264                  .Configure(app =>
265              {
266                  app.Use(next => context =>
267                  {
268                      context.Features.Set<IResponseCookiesFeature>(new TestCookieFeature());
269                      return next(context);
270                  });
271                  app.UseCookiePolicy(new CookiePolicyOptions
272                  {
273                      OnDeleteCookie = ctx => ctx.CookieName = "A"
274                  });
275                  app.Run(context =>
276                  {
277                      Assert.Throws<NotImplementedException>(() => context.Response.Cookies.Delete("A"));
278                      Assert.Throws<NotImplementedException>(() => context.Response.Cookies.Delete("A", new CookieOptions()));
279                      Assert.Throws<NotImplementedException>(() => context.Response.Cookies.Append("A", "A"));
280                      Assert.Throws<NotImplementedException>(() => context.Response.Cookies.Append("A", "A", new CookieOptions()));
281                      return context.Response.WriteAsync("Done");
282                  });
283              });
284              var server = new TestServer(builder);
285              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/login");
286              Assert.Equal("Done", transaction.ResponseText);
287          }
288          [Fact]
289          public async Task CookiePolicyAppliesToCookieAuth()
290          {
291              var builder = new WebHostBuilder()
292                  .ConfigureServices(services =>
293                  {
294                      services.AddAuthentication().AddCookie(o =>
295                      {
296                          o.Cookie.Name = "TestCookie";
297                          o.Cookie.HttpOnly = false;
298                          o.Cookie.SecurePolicy = CookieSecurePolicy.None;
299                      });
300                  })
301                  .Configure(app =>
302                  {
303                      app.UseCookiePolicy(new CookiePolicyOptions
304                      {
305                          HttpOnly = HttpOnlyPolicy.Always,
306                          Secure = CookieSecurePolicy.Always,
307                      });
308                      app.UseAuthentication();
309                      app.Run(context =>
310                      {
311                          return context.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme,
312                              new ClaimsPrincipal(new ClaimsIdentity(new GenericIdentity("TestUser", "Cookies"))));
313                      });
314                  });
315              var server = new TestServer(builder);
316              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/login");
317              Assert.NotNull(transaction.SetCookie);
318              Assert.Equal(1, transaction.SetCookie.Count);
<span onclick='openModal()' class='match'>319              var cookie = SetCookieHeaderValue.Parse(transaction.SetCookie[0]);
320              Assert.Equal("TestCookie", cookie.Name);
</span>321              Assert.True(cookie.HttpOnly);
322              Assert.True(cookie.Secure);
323              Assert.Equal("/", cookie.Path);
324          }
325          [Fact]
326          public async Task CookiePolicyAppliesToCookieAuthChunks()
327          {
328              var builder = new WebHostBuilder()
329                  .ConfigureServices(services =>
330                  {
331                      services.AddAuthentication().AddCookie(o =>
332                      {
333                          o.Cookie.Name = "TestCookie";
334                          o.Cookie.HttpOnly = false;
335                          o.Cookie.SecurePolicy = CookieSecurePolicy.None;
336                      });
337                  })
338                  .Configure(app =>
339                  {
340                      app.UseCookiePolicy(new CookiePolicyOptions
341                      {
342                          HttpOnly = HttpOnlyPolicy.Always,
343                          Secure = CookieSecurePolicy.Always,
344                      });
345                      app.UseAuthentication();
346                      app.Run(context =>
347                      {
348                          return context.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme,
349                              new ClaimsPrincipal(new ClaimsIdentity(new GenericIdentity(new string('c', 1024 * 5), "Cookies"))));
350                      });
351                  });
352              var server = new TestServer(builder);
353              var transaction = await server.SendAsync("http:&bsol;&bsol;example.com/login");
354              Assert.NotNull(transaction.SetCookie);
355              Assert.Equal(3, transaction.SetCookie.Count);
356              var cookie = SetCookieHeaderValue.Parse(transaction.SetCookie[0]);
357              Assert.Equal("TestCookie", cookie.Name);
358              Assert.Equal("chunks-2", cookie.Value);
359              Assert.True(cookie.HttpOnly);
360              Assert.True(cookie.Secure);
361              Assert.Equal("/", cookie.Path);
362              cookie = SetCookieHeaderValue.Parse(transaction.SetCookie[1]);
363              Assert.Equal("TestCookieC1", cookie.Name);
364              Assert.True(cookie.HttpOnly);
365              Assert.True(cookie.Secure);
366              Assert.Equal("/", cookie.Path);
367              cookie = SetCookieHeaderValue.Parse(transaction.SetCookie[2]);
368              Assert.Equal("TestCookieC2", cookie.Name);
369              Assert.True(cookie.HttpOnly);
370              Assert.True(cookie.Secure);
371              Assert.Equal("/", cookie.Path);
372          }
373          private class TestCookieFeature : IResponseCookiesFeature
374          {
375              public IResponseCookies Cookies { get; } = new BadCookies();
376              private class BadCookies : IResponseCookies
377              {
378                  public void Append(string key, string value)
379                  {
380                      throw new NotImplementedException();
381                  }
382                  public void Append(string key, string value, CookieOptions options)
383                  {
384                      throw new NotImplementedException();
385                  }
386                  public void Delete(string key)
387                  {
388                      throw new NotImplementedException();
389                  }
390                  public void Delete(string key, CookieOptions options)
391                  {
392                      throw new NotImplementedException();
393                  }
394              }
395          }
396          private class RequestTest
397          {
398              public RequestTest(string testUri, Action<Transaction> verify)
399              {
400                  TestUri = testUri;
401                  Verification = verify;
402              }
403              public async Task Execute(TestServer server)
404              {
405                  var transaction = await server.SendAsync(TestUri);
406                  Verification(transaction);
407              }
408              public string TestUri { get; set; }
409              public Action<Transaction> Verification { get; set; }
410          }
411          private async Task RunTest(
412              string path,
413              CookiePolicyOptions cookiePolicy,
414              RequestDelegate configureSetup,
415              params RequestTest[] tests)
416          {
417              var builder = new WebHostBuilder()
418                  .Configure(app =>
419                  {
420                      app.Map(path, map =>
421                      {
422                          map.UseCookiePolicy(cookiePolicy);
423                          map.Run(configureSetup);
424                      });
425                  });
426              var server = new TestServer(builder);
427              foreach (var test in tests)
428              {
429                  await test.Execute(server);
430              }
431          }
432      }
433  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-CookiePolicyTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-CookiePolicyTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>356              var cookie = SetCookieHeaderValue.Parse(transaction.SetCookie[0]);
357              Assert.Equal("TestCookie", cookie.Name);
</pre></code></div>
                <div class="column column_space"><pre><code>319              var cookie = SetCookieHeaderValue.Parse(transaction.SetCookie[0]);
320              Assert.Equal("TestCookie", cookie.Name);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    