
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 15, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-ByteaTests.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Data;
4  using System.IO;
5  using System.Threading.Tasks;
6  using NpgsqlTypes;
7  using NUnit.Framework;
8  namespace Npgsql.Tests.Types;
9  public class ByteaTests : MultiplexingTestBase
10  {
11      [Test]
12      [TestCase(new byte[] { 1, 2, 3, 4, 5 }, &quot;\\x0102030405&quot;, TestName = &quot;Bytea&quot;)]
13      [TestCase(new byte[] { }, &quot;\\x&quot;, TestName = &quot;Bytea_empty&quot;)]
14      public Task Bytea(byte[] byteArray, string sqlLiteral)
15          =&gt; AssertType(byteArray, sqlLiteral, &quot;bytea&quot;, NpgsqlDbType.Bytea, DbType.Binary);
16      [Test]
17      public async Task Bytea_long()
18      {
19          await using var conn = await OpenConnectionAsync();
<span onclick='openModal()' class='match'>20          var array = new byte[conn.Settings.WriteBufferSize + 100];
21          var sqlLiteral = &quot;\\x&quot; + new string(&#x27;1&#x27;, (conn.Settings.WriteBufferSize + 100) * 2);
</span>22          for (var i = 0; i &lt; array.Length; i++)
23              array[i] = 17;
24          await Bytea(array, sqlLiteral);
25      }
26      [Test]
27      public Task Write_as_Memory()
28          =&gt; AssertTypeWrite(
29              new Memory&lt;byte&gt;(new byte[] { 1, 2, 3 }), &quot;\\x010203&quot;, &quot;bytea&quot;, NpgsqlDbType.Bytea, DbType.Binary, isDefault: false);
30      [Test]
31      public Task Read_as_Memory_not_supported()
32          =&gt; AssertTypeUnsupportedRead&lt;Memory&lt;byte&gt;, NotSupportedException&gt;(&quot;\\x010203&quot;, &quot;bytea&quot;);
33      [Test]
34      public Task Write_as_ReadOnlyMemory()
35          =&gt; AssertTypeWrite(
36              new ReadOnlyMemory&lt;byte&gt;(new byte[] { 1, 2, 3 }), &quot;\\x010203&quot;, &quot;bytea&quot;, NpgsqlDbType.Bytea, DbType.Binary, isDefault: false);
37      [Test]
38      public Task Read_as_ReadOnlyMemory_not_supported()
39          =&gt; AssertTypeUnsupportedRead&lt;ReadOnlyMemory&lt;byte&gt;, NotSupportedException&gt;(&quot;\\x010203&quot;, &quot;bytea&quot;);
40      [Test]
41      public Task Write_as_ArraySegment()
42          =&gt; AssertTypeWrite(
43              new ArraySegment&lt;byte&gt;(new byte[] { 1, 2, 3 }), &quot;\\x010203&quot;, &quot;bytea&quot;, NpgsqlDbType.Bytea, DbType.Binary, isDefault: false);
44      [Test]
45      public Task Read_as_ArraySegment_not_supported()
46          =&gt; AssertTypeUnsupportedRead&lt;ArraySegment&lt;byte&gt;, NotSupportedException&gt;(&quot;\\x010203&quot;, &quot;bytea&quot;);
47      [Test]
48      public Task Write_as_MemoryStream()
49          =&gt; AssertTypeWrite(
50              () =&gt; new MemoryStream(new byte[] { 1, 2, 3 }), &quot;\\x010203&quot;, &quot;bytea&quot;, NpgsqlDbType.Bytea, DbType.Binary, isDefault: false);
51      [Test]
52      public Task Write_as_MemoryStream_truncated()
53      {
54          var msFactory = () =&gt;
55          {
56              var ms = new MemoryStream(new byte[] { 1, 2, 3, 4 });
57              ms.ReadByte();
58              return ms;
59          };
60          return AssertTypeWrite(
61              msFactory, &quot;\\x020304&quot;, &quot;bytea&quot;, NpgsqlDbType.Bytea, DbType.Binary, isDefault: false);
62      }
63      [Test]
64      public async Task Write_as_MemoryStream_long()
65      {
66          var rnd = new Random(1);
67          var bytes = new byte[8192 * 4];
68          rnd.NextBytes(bytes);
69          var expectedSql = &quot;\\x&quot; + ToHex(bytes);
70          await AssertTypeWrite(
71              () =&gt; new MemoryStream(bytes), expectedSql, &quot;bytea&quot;, NpgsqlDbType.Bytea, DbType.Binary, isDefault: false);
72      }
73      [Test]
74      public async Task Write_as_FileStream()
75      {
76          var filePath = Path.GetTempFileName();
77          var fsList = new List&lt;FileStream&gt;();
78          try
79          {
80              await File.WriteAllBytesAsync(filePath, new byte[] { 1, 2, 3 });
81              await AssertTypeWrite(
82                  () =&gt; FileStreamFactory(filePath, fsList), &quot;\\x010203&quot;, &quot;bytea&quot;, NpgsqlDbType.Bytea, DbType.Binary, isDefault: false);
83          }
84          finally
85          {
86              foreach (var fs in fsList)
87                  await fs.DisposeAsync();
88              try
89              {
90                  File.Delete(filePath);
91              }
92              catch {}
93          }
94          FileStream FileStreamFactory(string filePath, List&lt;FileStream&gt; fsList)
95          {
96              var fs = File.OpenRead(filePath);
97              fsList.Add(fs);
98              return fs;
99          }
100      }
101      [Test]
102      public async Task Write_as_FileStream_long()
103      {
104          var filePath = Path.GetTempFileName();
105          var fsList = new List&lt;FileStream&gt;();
106          var rnd = new Random(1);
107          try
108          {
109              var bytes = new byte[8192 * 4];
110              rnd.NextBytes(bytes);
111              await File.WriteAllBytesAsync(filePath, bytes);
112              var expectedSql = &quot;\\x&quot; + ToHex(bytes);
113              await AssertTypeWrite(
114                  () =&gt; FileStreamFactory(filePath, fsList), expectedSql, &quot;bytea&quot;, NpgsqlDbType.Bytea, DbType.Binary, isDefault: false);
115          }
116          finally
117          {
118              foreach (var fs in fsList)
119                  await fs.DisposeAsync();
120              try
121              {
122                  File.Delete(filePath);
123              }
124              catch {}
125          }
126          FileStream FileStreamFactory(string filePath, List&lt;FileStream&gt; fsList)
127          {
128              var fs = File.OpenRead(filePath);
129              fsList.Add(fs);
130              return fs;
131          }
132      }
133      static string ToHex(ReadOnlySpan&lt;byte&gt; bytes)
134      {
135          var c = new char[bytes.Length * 2];
136          byte b;
137          for (int bx = 0, cx = 0; bx &lt; bytes.Length; ++bx, ++cx)
138          {
139              b = (byte)(bytes[bx] &gt;&gt; 4);
140              c[cx] = (char)(b &gt; 9 ? b - 10 + &#x27;a&#x27; : b + &#x27;0&#x27;);
141              b = (byte)(bytes[bx] &amp; 0x0F);
142              c[++cx] = (char)(b &gt; 9 ? b - 10 + &#x27;a&#x27; : b + &#x27;0&#x27;);
143          }
144          return new string(c);
145      }
146      [Test, Description(&quot;Tests that bytea array values are truncated when the NpgsqlParameter&#x27;s Size is set&quot;)]
147      public async Task Truncate_array()
148      {
149          await using var conn = await OpenConnectionAsync();
150          await using var cmd = new NpgsqlCommand(&quot;SELECT @p&quot;, conn);
151          byte[] data = { 1, 2, 3, 4, 5, 6 };
152          var p = new NpgsqlParameter(&quot;p&quot;, data) { Size = 4 };
153          cmd.Parameters.Add(p);
154          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(new byte[] { 1, 2, 3, 4 }));
155          byte[] data2 = { 11, 12, 13, 14, 15, 16 };
156          p.Value = data2;
157          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(new byte[] { 11, 12, 13, 14 }));
158          p.Size = data2.Length + 10;
159          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(data2));
160          p.Size = 0;
161          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(data2));
162          p.Size = -1;
163          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(data2));
164          Assert.That(() =&gt; p.Size = -2, Throws.Exception.TypeOf&lt;ArgumentException&gt;());
165      }
166      [Test, Description(&quot;Tests that bytea stream values are truncated when the NpgsqlParameter&#x27;s Size is set&quot;)]
167      [NonParallelizable] 
168      public async Task Truncate_stream()
169      {
170          await using var conn = await OpenConnectionAsync();
171          await using var cmd = new NpgsqlCommand(&quot;SELECT @p&quot;, conn);
172          byte[] data = { 1, 2, 3, 4, 5, 6 };
173          var p = new NpgsqlParameter(&quot;p&quot;, new MemoryStream(data)) { Size = 4 };
174          cmd.Parameters.Add(p);
175          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(new byte[] { 1, 2, 3, 4 }));
176          byte[] data2 = { 11, 12, 13, 14, 15, 16 };
177          p.Value = new MemoryStream(data2);
178          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(new byte[] { 11, 12, 13, 14 }));
179          var data2ms = new MemoryStream(data2);
180          data2ms.ReadByte();
181          p.Value = data2ms;
182          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(new byte[] { 12, 13, 14, 15 }));
183          p.Size = 0;
184          p.Value = new MemoryStream(data2);
185          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(data2));
186          p.Size = -1;
187          p.Value = new MemoryStream(data2);
188          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(data2));
189          Assert.That(() =&gt; p.Size = -2, Throws.Exception.TypeOf&lt;ArgumentException&gt;());
190          p.Size = data2.Length + 10;
191          p.Value = new MemoryStream(data2);
192          var ex = Assert.ThrowsAsync&lt;NpgsqlException&gt;(async () =&gt; await cmd.ExecuteScalarAsync())!;
193          Assert.That(ex.InnerException, Is.TypeOf&lt;EndOfStreamException&gt;());
194          if (!IsMultiplexing)
195              Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
196      }
197      [Test]
198      public async Task Write_as_NonSeekable_stream()
199      {
200          await using var conn = await OpenConnectionAsync();
201          await using var cmd = new NpgsqlCommand(&quot;SELECT @p&quot;, conn);
202          byte[] data = { 1, 2, 3, 4, 5, 6 };
203          var p = new NpgsqlParameter(&quot;p&quot;, new NonSeekableStream(data)) { Size = 4 };
204          cmd.Parameters.Add(p);
205          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(new byte[] { 1, 2, 3, 4 }));
206          var streamWithOffset = new NonSeekableStream(data);
207          streamWithOffset.ReadByte();
208          p.Value = streamWithOffset;
209          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(new byte[] { 2, 3, 4, 5 }));
210          p.Value = new NonSeekableStream(data);
211          p.Size = 0;
212          Assert.ThrowsAsync&lt;NpgsqlException&gt;(async () =&gt; await cmd.ExecuteScalarAsync());
213          Assert.That(conn.State, Is.EqualTo(ConnectionState.Open));
214      }
215      [Test]
216      public async Task Array_of_bytea()
217      {
218          await using var conn = await OpenConnectionAsync();
219          await using var cmd = new NpgsqlCommand(&quot;SELECT :p1&quot;, conn);
220          var bytes = new byte[] { 1, 2, 3, 4, 5, 34, 39, 48, 49, 50, 51, 52, 92, 127, 128, 255, 254, 253, 252, 251 };
221          var inVal = new[] { bytes, bytes };
222          cmd.Parameters.AddWithValue(&quot;p1&quot;, NpgsqlDbType.Bytea | NpgsqlDbType.Array, inVal);
223          var retVal = (byte[][]?)await cmd.ExecuteScalarAsync();
224          Assert.AreEqual(inVal.Length, retVal!.Length);
225          Assert.AreEqual(inVal[0], retVal[0]);
226          Assert.AreEqual(inVal[1], retVal[1]);
227      }
228      sealed class NonSeekableStream : MemoryStream
229      {
230          public override bool CanSeek =&gt; false;
231          public NonSeekableStream(byte[] data) : base(data)
232          {
233          }
234      }
235      public ByteaTests(MultiplexingMode multiplexingMode) : base(multiplexingMode) {}
236  }
</code></pre>
        </div>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-CopyTests.cs</h3>
            <pre><code>1  using System;
2  using System.Collections;
3  using System.Collections.Generic;
4  using System.Data;
5  using System.IO;
6  using System.Numerics;
7  using System.Text;
8  using System.Threading;
9  using System.Threading.Tasks;
10  using Npgsql.Internal;
11  using NpgsqlTypes;
12  using NUnit.Framework;
13  using static Npgsql.Tests.TestUtil;
14  namespace Npgsql.Tests;
15  public class CopyTests : MultiplexingTestBase
16  {
17      #region Issue 2257
18      [Test, Description(&quot;Reproduce #2257&quot;)]
19      public async Task Issue2257()
20      {
21          await using var conn = await OpenConnectionAsync();
22          var table1 = await GetTempTableName(conn);
23          var table2 = await GetTempTableName(conn);
24          const int rowCount = 1000000;
25          using (var cmd = conn.CreateCommand())
26          {
27              cmd.CommandText = $&quot;CREATE TABLE {table1} AS SELECT * FROM generate_series(1, {rowCount}) id&quot;;
28              await cmd.ExecuteNonQueryAsync();
29              cmd.CommandText = $&quot;ALTER TABLE {table1} ADD CONSTRAINT {table1}_pk PRIMARY KEY (id)&quot;;
30              await cmd.ExecuteNonQueryAsync();
31              cmd.CommandText = $&quot;CREATE TABLE {table2} (master_id integer NOT NULL REFERENCES {table1} (id))&quot;;
32              await cmd.ExecuteNonQueryAsync();
33          }
34          await using var writer = conn.BeginBinaryImport($&quot;COPY {table2} FROM STDIN BINARY&quot;);
35          writer.Timeout = TimeSpan.FromMilliseconds(3);
36          var e = Assert.Throws&lt;NpgsqlException&gt;(() =&gt;
37          {
38              for (var i = 1; i &lt;= rowCount; ++i)
39              {
40                  writer.StartRow();
41                  writer.Write(i);
42              }
43              writer.Complete();
44          })!;
45          Assert.That(e.InnerException, Is.TypeOf&lt;TimeoutException&gt;());
46      }
47      #endregion
48      #region Raw
49      [Test, Description(&quot;Exports data in binary format (raw mode) and then loads it back in&quot;)]
50      public async Task Raw_binary_roundtrip([Values(false, true)] bool async)
51      {
52          using var conn = await OpenConnectionAsync();
53          const int iterations = 500;
54          var table = await GetTempTableName(conn);
55          using (var tx = conn.BeginTransaction())
56          {
57              await conn.ExecuteNonQueryAsync($@&quot;CREATE TABLE {table} (field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER)&quot;);
58              using (var cmd =
59                     new NpgsqlCommand($&quot;INSERT INTO {table} (field_text, field_int4) VALUES (@p1, @p2)&quot;, conn))
60              {
61                  cmd.Parameters.AddWithValue(&quot;p1&quot;, NpgsqlDbType.Text, &quot;HELLO&quot;);
62                  cmd.Parameters.AddWithValue(&quot;p2&quot;, NpgsqlDbType.Integer, 8);
63                  for (var i = 0; i &lt; iterations; i++)
64                  {
65                      await cmd.ExecuteNonQueryAsync();
66                  }
67              }
68              await tx.CommitAsync();
69          }
70          var data = new byte[10000];
71          var len = 0;
72          using (var outStream = async
73                     ? await conn.BeginRawBinaryCopyAsync($&quot;COPY {table} (field_text, field_int4) TO STDIN BINARY&quot;)
74                     : conn.BeginRawBinaryCopy($&quot;COPY {table} (field_text, field_int4) TO STDIN BINARY&quot;))
75          {
76              StateAssertions(conn);
77              while (true)
78              {
79                  var read = outStream.Read(data, len, data.Length - len);
80                  if (read == 0)
81                      break;
82                  len += read;
83              }
84              Assert.That(len, Is.GreaterThan(conn.Settings.ReadBufferSize) &amp; Is.LessThan(data.Length));
85          }
86          await conn.ExecuteNonQueryAsync($&quot;TRUNCATE {table}&quot;);
87          using (var inStream = async
88                     ? await conn.BeginRawBinaryCopyAsync($&quot;COPY {table} (field_text, field_int4) FROM STDIN BINARY&quot;)
89                     : conn.BeginRawBinaryCopy($&quot;COPY {table} (field_text, field_int4) FROM STDIN BINARY&quot;))
90          {
91              StateAssertions(conn);
92              inStream.Write(data, 0, len);
93          }
94          Assert.That(await conn.ExecuteScalarAsync($&quot;SELECT COUNT(*) FROM {table}&quot;), Is.EqualTo(iterations));
95      }
96      [Test, Description(&quot;Disposes a raw binary stream in the middle of an export&quot;)]
97      public async Task Dispose_in_middle_of_raw_binary_export()
98      {
99          using var conn = await OpenConnectionAsync();
100          var table = await GetTempTableName(conn);
101          await conn.ExecuteNonQueryAsync($@&quot;
102  CREATE TABLE {table} (field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER);
103  INSERT INTO {table} (field_text, field_int4) VALUES (&#x27;HELLO&#x27;, 8)&quot;);
104          var data = new byte[3];
105          using (var inStream = conn.BeginRawBinaryCopy($&quot;COPY {table} (field_text, field_int4) TO STDIN BINARY&quot;))
106          {
107              var len = inStream.Read(data, 0, data.Length);
108              Assert.That(len, Is.EqualTo(data.Length));
109          }
110          Assert.That(await conn.ExecuteScalarAsync(&quot;SELECT 1&quot;), Is.EqualTo(1));
111      }
112      [Test, Description(&quot;Disposes a raw binary stream in the middle of an import&quot;)]
113      public async Task Dispose_in_middle_of_raw_binary_import()
114      {
115          using var conn = await OpenConnectionAsync();
116          var table = await GetTempTableName(conn);
117          await conn.ExecuteNonQueryAsync($@&quot;CREATE TABLE {table} (field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER)&quot;);
118          var inStream = conn.BeginRawBinaryCopy($&quot;COPY {table} (field_text, field_int4) FROM STDIN BINARY&quot;);
119          inStream.Write(NpgsqlRawCopyStream.BinarySignature, 0, NpgsqlRawCopyStream.BinarySignature.Length);
120          Assert.That(() =&gt; inStream.Dispose(), Throws.Exception
121              .TypeOf&lt;PostgresException&gt;()
122              .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.BadCopyFileFormat)
123          );
124          Assert.That(await conn.ExecuteScalarAsync(&quot;SELECT 1&quot;), Is.EqualTo(1));
125      }
126      [Test, Description(&quot;Cancels a binary write&quot;)]
127      public async Task Cancel_raw_binary_import()
128      {
129          using var conn = await OpenConnectionAsync();
130          var table = await GetTempTableName(conn);
131          await conn.ExecuteNonQueryAsync($@&quot;CREATE TABLE {table} (field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER)&quot;);
132          var garbage = new byte[] {1, 2, 3, 4};
133          using (var s = conn.BeginRawBinaryCopy($&quot;COPY {table} (field_text, field_int4) FROM STDIN BINARY&quot;))
134          {
135              s.Write(garbage, 0, garbage.Length);
136              s.Cancel();
137          }
138          Assert.That(await conn.ExecuteScalarAsync($&quot;SELECT COUNT(*) FROM {table}&quot;), Is.EqualTo(0));
139      }
140      [Test]
141      public async Task Import_large_value_raw()
142      {
143          using var conn = await OpenConnectionAsync();
144          var table = await CreateTempTable(conn, &quot;blob BYTEA&quot;);
145          var data = new byte[conn.Settings.WriteBufferSize + 10];
146          var dump = new byte[conn.Settings.WriteBufferSize + 200];
147          var len = 0;
148          using (var cmd = new NpgsqlCommand($&quot;INSERT INTO {table} (blob) VALUES (@p)&quot;, conn))
149          {
150              cmd.Parameters.AddWithValue(&quot;p&quot;, data);
151              await cmd.ExecuteNonQueryAsync();
152          }
153          using (var outStream = conn.BeginRawBinaryCopy($&quot;COPY {table} (blob) TO STDIN BINARY&quot;))
154          {
155              while (true)
156              {
157                  var read = outStream.Read(dump, len, dump.Length - len);
158                  if (read == 0)
159                      break;
160                  len += read;
161              }
162              Assert.That(len &lt; dump.Length);
163          }
164          await conn.ExecuteNonQueryAsync($&quot;TRUNCATE {table}&quot;);
165          using (var inStream = conn.BeginRawBinaryCopy($&quot;COPY {table} (blob) FROM STDIN BINARY&quot;))
166          {
167              inStream.Write(dump, 0, len);
168          }
169      }
170      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2330&quot;)]
171      public async Task Wrong_table_definition_raw_binary_copy()
172      {
173          using var conn = await OpenConnectionAsync();
174          Assert.Throws&lt;PostgresException&gt;(() =&gt; conn.BeginRawBinaryCopy(&quot;COPY table_is_not_exist (blob) TO STDOUT BINARY&quot;));
175          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Open));
176          Assert.That(await conn.ExecuteScalarAsync(&quot;SELECT 1&quot;), Is.EqualTo(1));
177          Assert.Throws&lt;PostgresException&gt;(() =&gt; conn.BeginRawBinaryCopy(&quot;COPY table_is_not_exist (blob) FROM STDIN BINARY&quot;));
178          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Open));
179          Assert.That(await conn.ExecuteScalarAsync(&quot;SELECT 1&quot;), Is.EqualTo(1));
180      }
181      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2330&quot;)]
182      public async Task Wrong_format_raw_binary_copy()
183      {
184          if (IsMultiplexing)
185              Assert.Ignore(&quot;Multiplexing: fails&quot;);
186          using (var conn = await OpenConnectionAsync())
187          {
188              var table = await CreateTempTable(conn, &quot;blob BYTEA&quot;);
189              Assert.Throws&lt;ArgumentException&gt;(() =&gt; conn.BeginRawBinaryCopy($&quot;COPY {table} (blob) TO STDOUT&quot;));
190              Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Broken));
191          }
192          using (var conn = await OpenConnectionAsync())
193          {
194              var table = await CreateTempTable(conn, &quot;blob BYTEA&quot;);
195              Assert.Throws&lt;ArgumentException&gt;(() =&gt; conn.BeginRawBinaryCopy($&quot;COPY {table} (blob) FROM STDIN&quot;));
196              Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Broken));
197          }
198      }
199      #endregion
200      #region Binary
201      [Test, Description(&quot;Roundtrips some data&quot;)]
202      public async Task Binary_roundtrip([Values(false, true)] bool async)
203      {
204          using var conn = await OpenConnectionAsync();
205          var table = await CreateTempTable(conn, &quot;field_text TEXT, field_int2 SMALLINT&quot;);
206          var longString = new StringBuilder(conn.Settings.WriteBufferSize + 50).Append(&#x27;a&#x27;).ToString();
207          using (var writer = async
208                     ? await conn.BeginBinaryImportAsync($&quot;COPY {table} (field_text, field_int2) FROM STDIN BINARY&quot;)
209                     : conn.BeginBinaryImport($&quot;COPY {table} (field_text, field_int2) FROM STDIN BINARY&quot;))
210          {
211              StateAssertions(conn);
212              writer.StartRow();
213              writer.Write(&quot;Hello&quot;);
214              writer.Write((short)8, NpgsqlDbType.Smallint);
215              writer.WriteRow(&quot;Something&quot;, (short)9);
216              writer.StartRow();
217              writer.Write(longString, &quot;text&quot;);
218              writer.WriteNull();
219              var rowsWritten = writer.Complete();
220              Assert.That(rowsWritten, Is.EqualTo(3));
221          }
222          Assert.That(await conn.ExecuteScalarAsync(&quot;SELECT 1&quot;), Is.EqualTo(1));
223          using (var reader = async
224                     ? await conn.BeginBinaryExportAsync($&quot;COPY {table} (field_text, field_int2) TO STDIN BINARY&quot;)
225                     : conn.BeginBinaryExport($&quot;COPY {table} (field_text, field_int2) TO STDIN BINARY&quot;))
226          {
227              StateAssertions(conn);
228              Assert.That(reader.StartRow(), Is.EqualTo(2));
229              Assert.That(reader.Read&lt;string&gt;(), Is.EqualTo(&quot;Hello&quot;));
230              Assert.That(reader.Read&lt;int&gt;(NpgsqlDbType.Smallint), Is.EqualTo(8));
231              Assert.That(reader.StartRow(), Is.EqualTo(2));
232              Assert.That(reader.IsNull, Is.False);
233              Assert.That(reader.Read&lt;string&gt;(), Is.EqualTo(&quot;Something&quot;));
234              reader.Skip();
235              Assert.That(reader.StartRow(), Is.EqualTo(2));
236              Assert.That(reader.Read&lt;string&gt;(), Is.EqualTo(longString));
237              Assert.That(reader.IsNull, Is.True);
238              reader.Skip();
239              Assert.That(reader.StartRow(), Is.EqualTo(-1));
240          }
241          Assert.That(await conn.ExecuteScalarAsync(&quot;SELECT 1&quot;), Is.EqualTo(1));
242      }
243      [Test]
244      public async Task Cancel_binary_import()
245      {
246          using var conn = await OpenConnectionAsync();
247          var table = await CreateTempTable(conn, &quot;field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER&quot;);
248          using (var writer = conn.BeginBinaryImport($&quot;COPY {table} (field_text, field_int4) FROM STDIN BINARY&quot;))
249          {
250              writer.StartRow();
251              writer.Write(&quot;Hello&quot;);
252              writer.Write(8);
253          }
254          Assert.That(await conn.ExecuteScalarAsync($&quot;SELECT COUNT(*) FROM {table}&quot;), Is.EqualTo(0));
255      }
256      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/657&quot;)]
257      public async Task Import_bytea()
258      {
259          using var conn = await OpenConnectionAsync();
260          var table = await CreateTempTable(conn, &quot;field BYTEA&quot;);
261          var data = new byte[] {1, 5, 8};
262          using (var writer = conn.BeginBinaryImport($&quot;COPY {table} (field) FROM STDIN BINARY&quot;))
263          {
264              writer.StartRow();
265              writer.Write(data, NpgsqlDbType.Bytea);
266              var rowsWritten = writer.Complete();
267              Assert.That(rowsWritten, Is.EqualTo(1));
268          }
269          Assert.That(await conn.ExecuteScalarAsync($&quot;SELECT field FROM {table}&quot;), Is.EqualTo(data));
270      }
271      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/4693&quot;)]
272      public async Task Import_numeric()
273      {
274          await using var conn = await OpenConnectionAsync();
275          var table = await CreateTempTable(conn, &quot;field NUMERIC(1000)&quot;);
276          await using (var writer = await conn.BeginBinaryImportAsync($&quot;COPY {table} (field) FROM STDIN BINARY&quot;))
277          {
278              await writer.StartRowAsync();
279              await writer.WriteAsync(new BigInteger(1234), NpgsqlDbType.Numeric);
280              await writer.StartRowAsync();
281              await writer.WriteAsync(new BigInteger(5678), NpgsqlDbType.Numeric);
282              var rowsWritten = await writer.CompleteAsync();
283              Assert.That(rowsWritten, Is.EqualTo(2));
284          }
285          await using var cmd = conn.CreateCommand();
286          cmd.CommandText = $&quot;SELECT field FROM {table}&quot;;
287          await using var reader = await cmd.ExecuteReaderAsync();
288          Assert.IsTrue(await reader.ReadAsync());
289          Assert.That(reader.GetValue(0), Is.EqualTo(1234m));
290          Assert.IsTrue(await reader.ReadAsync());
291          Assert.That(reader.GetValue(0), Is.EqualTo(5678m));
292      }
293      [Test]
294      public async Task Import_string_array()
295      {
296          using var conn = await OpenConnectionAsync();
297          var table = await CreateTempTable(conn, &quot;field TEXT[]&quot;);
298          var data = new[] {&quot;foo&quot;, &quot;a&quot;, &quot;bar&quot;};
299          using (var writer = conn.BeginBinaryImport($&quot;COPY {table} (field) FROM STDIN BINARY&quot;))
300          {
301              writer.StartRow();
302              writer.Write(data, NpgsqlDbType.Array | NpgsqlDbType.Text);
303              var rowsWritten = writer.Complete();
304              Assert.That(rowsWritten, Is.EqualTo(1));
305          }
306          Assert.That(await conn.ExecuteScalarAsync($&quot;SELECT field FROM {table}&quot;), Is.EqualTo(data));
307      }
308      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/816&quot;)]
309      public async Task Import_string_with_buffer_length()
310      {
311          using var conn = await OpenConnectionAsync();
312          var table = await CreateTempTable(conn, &quot;field TEXT&quot;);
313          var data = new string(&#x27;a&#x27;, conn.Settings.WriteBufferSize);
314          using (var writer = conn.BeginBinaryImport($&quot;COPY {table} (field) FROM STDIN BINARY&quot;))
315          {
316              writer.StartRow();
317              writer.Write(data, NpgsqlDbType.Text);
318              var rowsWritten = writer.Complete();
319              Assert.That(rowsWritten, Is.EqualTo(1));
320          }
321          Assert.That(await conn.ExecuteScalarAsync($&quot;SELECT field FROM {table}&quot;), Is.EqualTo(data));
322      }
323      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/662&quot;)]
324      public async Task Import_direct_buffer()
325      {
326          using var conn = await OpenConnectionAsync();
327          var table = await CreateTempTable(conn, &quot;blob BYTEA&quot;);
328          using var writer = conn.BeginBinaryImport($&quot;COPY {table} (blob) FROM STDIN BINARY&quot;);
329          var data = new byte[conn.Settings.WriteBufferSize + 10];
330          writer.StartRow();
331          writer.Write(data);
332          writer.StartRow();
333          writer.Write(data);
334      }
335      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2330&quot;)]
336      public async Task Wrong_table_definition_binary_import()
337      {
338          using var conn = await OpenConnectionAsync();
339          Assert.Throws&lt;PostgresException&gt;(() =&gt; conn.BeginBinaryImport(&quot;COPY table_is_not_exist (blob) FROM STDIN BINARY&quot;));
340          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Open));
341          Assert.That(await conn.ExecuteScalarAsync(&quot;SELECT 1&quot;), Is.EqualTo(1));
342      }
343      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2330&quot;)]
344      public async Task Wrong_format_binary_import()
345      {
346          if (IsMultiplexing)
347              Assert.Ignore(&quot;Multiplexing: fails&quot;);
348          using var conn = await OpenConnectionAsync();
349          var table = await CreateTempTable(conn, &quot;blob BYTEA&quot;);
350          Assert.Throws&lt;ArgumentException&gt;(() =&gt; conn.BeginBinaryImport($&quot;COPY {table} (blob) FROM STDIN&quot;));
351          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Broken));
352      }
353      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2330&quot;)]
354      public async Task Wrong_table_definition_binary_export()
355      {
356          using var conn = await OpenConnectionAsync();
357          Assert.Throws&lt;PostgresException&gt;(() =&gt; conn.BeginBinaryExport(&quot;COPY table_is_not_exist (blob) TO STDOUT BINARY&quot;));
358          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Open));
359          Assert.That(await conn.ExecuteScalarAsync(&quot;SELECT 1&quot;), Is.EqualTo(1));
360      }
361      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2330&quot;)]
362      public async Task Wrong_format_binary_export()
363      {
364          if (IsMultiplexing)
365              Assert.Ignore(&quot;Multiplexing: fails&quot;);
366          using var conn = await OpenConnectionAsync();
367          var table = await CreateTempTable(conn, &quot;blob BYTEA&quot;);
368          Assert.Throws&lt;ArgumentException&gt;(() =&gt; conn.BeginBinaryExport($&quot;COPY {table} (blob) TO STDOUT&quot;));
369          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Broken));
370      }
371      [Test, NonParallelizable, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/661&quot;)]
372      [Ignore(&quot;Unreliable&quot;)]
373      public async Task Unexpected_exception_binary_import()
374      {
375          if (IsMultiplexing)
376              return;
377          await using var dataSource = CreateDataSource();
378          await using var conn = await dataSource.OpenConnectionAsync();
379          var table = await CreateTempTable(conn, &quot;blob BYTEA&quot;);
<span onclick='openModal()' class='match'>380          var data = new byte[conn.Settings.WriteBufferSize + 10];
381          var writer = conn.BeginBinaryImport($&quot;COPY {table} (blob) FROM STDIN BINARY&quot;);
</span>382          using (var conn2 = await OpenConnectionAsync())
383              conn2.ExecuteNonQuery($&quot;SELECT pg_terminate_backend({conn.ProcessID})&quot;);
384          Thread.Sleep(50);
385          Assert.That(() =&gt;
386          {
387              writer.StartRow();
388              writer.Write(data);
389              writer.Dispose();
390          }, Throws.Exception.TypeOf&lt;IOException&gt;());
391          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Broken));
392      }
393      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/657&quot;)]
394      [Explicit]
395      public async Task Import_bytea_massive()
396      {
397          using var conn = await OpenConnectionAsync();
398          var table = await CreateTempTable(conn, &quot;field BYTEA&quot;);
399          const int iterations = 10000;
400          var data = new byte[1024*1024];
401          using (var writer = conn.BeginBinaryImport($&quot;COPY {table} (field) FROM STDIN BINARY&quot;))
402          {
403              for (var i = 0; i &lt; iterations; i++)
404              {
405                  if (i%100 == 0)
406                      Console.WriteLine(&quot;Iteration &quot; + i);
407                  writer.StartRow();
408                  writer.Write(data, NpgsqlDbType.Bytea);
409              }
410          }
411          Assert.That(await conn.ExecuteScalarAsync($&quot;SELECT COUNT(*) FROM {table}&quot;), Is.EqualTo(iterations));
412      }
413      [Test]
414      public async Task Export_long_string()
415      {
416          const int iterations = 100;
417          using var conn = await OpenConnectionAsync();
418          var len = conn.Settings.WriteBufferSize;
419          var table = await CreateTempTable(conn, &quot;foo1 TEXT, foo2 TEXT, foo3 TEXT, foo4 TEXT, foo5 TEXT&quot;);
420          using (var cmd = new NpgsqlCommand($&quot;INSERT INTO {table} VALUES (@p, @p, @p, @p, @p)&quot;, conn))
421          {
422              cmd.Parameters.AddWithValue(&quot;p&quot;, new string(&#x27;x&#x27;, len));
423              for (var i = 0; i &lt; iterations; i++)
424                  await cmd.ExecuteNonQueryAsync();
425          }
426          using (var reader = conn.BeginBinaryExport($&quot;COPY {table} (foo1, foo2, foo3, foo4, foo5) TO STDIN BINARY&quot;))
427          {
428              for (var row = 0; row &lt; iterations; row++)
429              {
430                  Assert.That(reader.StartRow(), Is.EqualTo(5));
431                  for (var col = 0; col &lt; 5; col++)
432                      Assert.That(reader.Read&lt;string&gt;().Length, Is.EqualTo(len));
433              }
434          }
435      }
436      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/1134&quot;)]
437      public async Task Read_bit_string()
438      {
439          using var conn = await OpenConnectionAsync();
440          var table = await GetTempTableName(conn);
441          await conn.ExecuteNonQueryAsync($@&quot;
442  CREATE TABLE {table} (bits BIT(3), bitarray BIT(3)[]);
443  INSERT INTO {table} (bits, bitarray) VALUES (B&#x27;101&#x27;, ARRAY[B&#x27;101&#x27;, B&#x27;111&#x27;])&quot;);
444          using var reader = conn.BeginBinaryExport($&quot;COPY {table} (bits, bitarray) TO STDIN BINARY&quot;);
445          reader.StartRow();
446          Assert.That(reader.Read&lt;BitArray&gt;(), Is.EqualTo(new BitArray(new[] { true, false, true })));
447          Assert.That(reader.Read&lt;BitArray[]&gt;(), Is.EqualTo(new[]
448          {
449              new BitArray(new[] { true, false, true }),
450              new BitArray(new[] { true, true, true })
451          }));
452      }
453      [Test]
454      public async Task Array()
455      {
456          var expected = new[] { 8 };
457          using var conn = await OpenConnectionAsync();
458          var table = await CreateTempTable(conn, &quot;arr INTEGER[]&quot;);
459          using (var writer = conn.BeginBinaryImport($&quot;COPY {table} (arr) FROM STDIN BINARY&quot;))
460          {
461              writer.StartRow();
462              writer.Write(expected);
463              var rowsWritten = writer.Complete();
464              Assert.That(rowsWritten, Is.EqualTo(1));
465          }
466          using (var reader = conn.BeginBinaryExport($&quot;COPY {table} (arr) TO STDIN BINARY&quot;))
467          {
468              reader.StartRow();
469              Assert.That(reader.Read&lt;int[]&gt;(), Is.EqualTo(expected));
470          }
471      }
472      [Test]
473      public async Task Enum()
474      {
475          await using var adminConnection = await OpenConnectionAsync();
476          var type = await GetTempTypeName(adminConnection);
477          await adminConnection.ExecuteNonQueryAsync($&quot;CREATE TYPE {type} AS ENUM (&#x27;sad&#x27;, &#x27;ok&#x27;, &#x27;happy&#x27;)&quot;);
478          var dataSourceBuilder = CreateDataSourceBuilder();
479          dataSourceBuilder.MapEnum&lt;Mood&gt;(type);
480          await using var dataSource = dataSourceBuilder.Build();
481          await using var connection = await dataSource.OpenConnectionAsync();
482          var table = await CreateTempTable(connection, $&quot;mymood {type}, mymoodarr {type}[]&quot;);
483          await using (var writer = await connection.BeginBinaryImportAsync($&quot;COPY {table} (mymood, mymoodarr) FROM STDIN BINARY&quot;))
484          {
485              await writer.StartRowAsync();
486              await writer.WriteAsync(Mood.Happy);
487              await writer.WriteAsync(new[] { Mood.Happy });
488              var rowsWritten = await writer.CompleteAsync();
489              Assert.That(rowsWritten, Is.EqualTo(1));
490          }
491          await using (var reader = await connection.BeginBinaryExportAsync($&quot;COPY {table} (mymood, mymoodarr) TO STDIN BINARY&quot;))
492          {
493              await reader.StartRowAsync();
494              Assert.That(reader.Read&lt;Mood&gt;(), Is.EqualTo(Mood.Happy));
495              Assert.That(reader.Read&lt;Mood[]&gt;(), Is.EqualTo(new[] { Mood.Happy }));
496          }
497      }
498      enum Mood { Sad, Ok, Happy };
499      [Test]
500      public async Task Read_null_as_nullable()
501      {
502          using var connection = await OpenConnectionAsync();
503          using var exporter = connection.BeginBinaryExport(&quot;COPY (SELECT NULL::int) TO STDOUT BINARY&quot;);
504          exporter.StartRow();
505          Assert.That(exporter.Read&lt;int?&gt;(), Is.Null);
506      }
507      [Test]
508      public async Task Read_null_as_non_nullable_throws()
509      {
510          using var connection = await OpenConnectionAsync();
511          using var exporter = connection.BeginBinaryExport(&quot;COPY (SELECT NULL::int) TO STDOUT BINARY&quot;);
512          exporter.StartRow();
513          Assert.Throws&lt;InvalidCastException&gt;(() =&gt; exporter.Read&lt;int&gt;());
514      }
515      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/1440&quot;)]
516      public async Task Error_during_import()
517      {
518          using var conn = await OpenConnectionAsync();
519          var table = await CreateTempTable(conn, &quot;foo INT UNIQUE&quot;);
520          var writer = conn.BeginBinaryImport($&quot;COPY {table} (foo) FROM STDIN BINARY&quot;);
521          writer.StartRow();
522          writer.Write(8);
523          writer.StartRow();
524          writer.Write(8);
525          Assert.That(() =&gt; writer.Complete(), Throws.Exception
526              .TypeOf&lt;PostgresException&gt;()
527              .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.UniqueViolation));
528          Assert.That(await conn.ExecuteScalarAsync(&quot;SELECT 1&quot;), Is.EqualTo(1));
529      }
530      [Test]
531      public async Task Import_cannot_write_after_commit()
532      {
533          using var conn = await OpenConnectionAsync();
534          var table = await CreateTempTable(conn, &quot;foo INT&quot;);
535          try
536          {
537              using var writer = conn.BeginBinaryImport($&quot;COPY {table} (foo) FROM STDIN BINARY&quot;);
538              writer.StartRow();
539              writer.Write(8);
540              var rowsWritten = writer.Complete();
541              Assert.That(rowsWritten, Is.EqualTo(1));
542              writer.StartRow();
543              Assert.Fail(&quot;StartRow should have thrown&quot;);
544          }
545          catch (InvalidOperationException)
546          {
547              Assert.That(await conn.ExecuteScalarAsync($&quot;SELECT COUNT(*) FROM {table}&quot;), Is.EqualTo(1));
548          }
549      }
550      [Test]
551      public async Task Import_commit_in_middle_of_row()
552      {
553          using var conn = await OpenConnectionAsync();
554          var table = await CreateTempTable(conn, &quot;foo INT, bar TEXT&quot;);
555          try
556          {
557              using var writer = conn.BeginBinaryImport($&quot;COPY {table} (foo, bar) FROM STDIN BINARY&quot;);
558              writer.StartRow();
559              writer.Write(8);
560              writer.Write(&quot;hello&quot;);
561              writer.StartRow();
562              writer.Write(9);
563              writer.Complete();
564              Assert.Fail(&quot;Commit should have thrown&quot;);
565          }
566          catch (InvalidOperationException)
567          {
568              Assert.That(await conn.ExecuteScalarAsync($&quot;SELECT COUNT(*) FROM {table}&quot;), Is.EqualTo(0));
569          }
570      }
571      [Test]
572      public async Task Import_exception_does_not_commit()
573      {
574          using var conn = await OpenConnectionAsync();
575          var table = await CreateTempTable(conn, &quot;foo INT&quot;);
576          try
577          {
578              using var writer = conn.BeginBinaryImport($&quot;COPY {table} (foo) FROM STDIN BINARY&quot;);
579              writer.StartRow();
580              writer.Write(8);
581              throw new Exception(&quot;FOO&quot;);
582          }
583          catch (Exception e) when (e.Message == &quot;FOO&quot;)
584          {
585              Assert.That(await conn.ExecuteScalarAsync($&quot;SELECT COUNT(*) FROM {table}&quot;), Is.Zero);
586          }
587      }
588      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2347&quot;)]
589      public async Task Write_column_out_of_bounds_throws()
590      {
591          using var conn = await OpenConnectionAsync();
592          var table = await CreateTempTable(conn, &quot;field_text TEXT, field_int2 INTEGER&quot;);
593          using var writer = conn.BeginBinaryImport($&quot;COPY {table} (field_text, field_int2) FROM STDIN BINARY&quot;);
594          StateAssertions(conn);
595          writer.StartRow();
596          writer.Write(&quot;Hello&quot;);
597          writer.Write(8, NpgsqlDbType.Smallint);
598          Assert.Throws&lt;InvalidOperationException&gt;(() =&gt; writer.Write(&quot;I should not be here&quot;));
599          writer.StartRow();
600          writer.Write(&quot;Hello&quot;);
601          writer.Write(8, NpgsqlDbType.Smallint);
602          Assert.Throws&lt;InvalidOperationException&gt;(() =&gt; writer.Write(&quot;I should not be here&quot;, NpgsqlDbType.Text));
603          writer.StartRow();
604          writer.Write(&quot;Hello&quot;);
605          writer.Write(8, NpgsqlDbType.Smallint);
606          Assert.Throws&lt;InvalidOperationException&gt;(() =&gt; writer.Write(&quot;I should not be here&quot;, &quot;text&quot;));
607          Assert.Throws&lt;InvalidOperationException&gt;(() =&gt; writer.WriteRow(&quot;Hello&quot;, 8, &quot;I should not be here&quot;));
608      }
609      [Test]
610      public async Task Cancel_raw_binary_export_when_not_consumed_and_then_Dispose()
611      {
612          await using var conn = await OpenConnectionAsync();
613          var stream = conn.BeginRawBinaryCopy(&quot;COPY (select md5(random()::text) as id from generate_series(1, 100000)) TO STDOUT BINARY&quot;);
614          var buffer = new byte[32];
615          await stream.ReadAsync(buffer, 0, buffer.Length);
616          stream.Cancel();
617          Assert.DoesNotThrowAsync(async () =&gt; await stream.DisposeAsync());
618          Assert.That(async () =&gt; await conn.ExecuteScalarAsync(&quot;SELECT 1&quot;), Is.EqualTo(1), &quot;The connection is still OK&quot;);
619      }
620      [Test]
621      public async Task Cancel_binary_export_when_not_consumed_and_then_Dispose()
622      {
623          await using var conn = await OpenConnectionAsync();
624          var exporter = conn.BeginBinaryExport(&quot;COPY (select md5(random()::text) as id from generate_series(1, 100000)) TO STDOUT BINARY&quot;);
625          await exporter.StartRowAsync();
626          await exporter.ReadAsync&lt;string&gt;();
627          exporter.Cancel();
628          Assert.DoesNotThrowAsync(async () =&gt; await exporter.DisposeAsync());
629          Assert.That(async () =&gt; await conn.ExecuteScalarAsync(&quot;SELECT 1&quot;), Is.EqualTo(1), &quot;The connection is still OK&quot;);
630      }
631      [Test]
632      [IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/4417&quot;)]
633      public async Task Binary_copy_throws_for_nullable()
634      {
635          await using var conn = await OpenConnectionAsync();
636          var tableName = await CreateTempTable(conn, &quot;house_number integer&quot;);
637          await using var writer = await conn.BeginBinaryImportAsync($&quot;COPY {tableName}(house_number) FROM STDIN BINARY&quot;);
638          int? value = 1;
639          await writer.StartRowAsync();
640          Assert.ThrowsAsync&lt;InvalidCastException&gt;(async () =&gt; await writer.WriteAsync(value, NpgsqlDbType.Integer));
641      }
642      [Test]
643      [IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/5110&quot;)]
644      public async Task Binary_copy_read_char_column()
645      {
646          await using var conn = await OpenConnectionAsync();
647          var tableName = await CreateTempTable(conn, &quot;id serial, value char&quot;);
648          await using var cmd = conn.CreateCommand();
649          cmd.CommandText = $&quot;INSERT INTO {tableName}(value) VALUES (&#x27;d&#x27;), (&#x27;s&#x27;)&quot;;
650          await cmd.ExecuteNonQueryAsync();
651          await using var export = await conn.BeginBinaryExportAsync($&quot;COPY {tableName}(id, value) TO STDOUT (FORMAT BINARY)&quot;);
652          while (await export.StartRowAsync() != -1)
653          {
654              var id = export.Read&lt;int&gt;();
655              var value = export.Read&lt;char&gt;();
656          }
657      }
658      #endregion
659      #region Text
660      [Test]
661      public async Task Text_import([Values(false, true)] bool async)
662      {
663          using var conn = await OpenConnectionAsync();
664          var table = await CreateTempTable(conn, &quot;field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER&quot;);
665          const string line = &quot;HELLO\t1\n&quot;;
666          var writer = async
667              ? await conn.BeginTextImportAsync($&quot;COPY {table} (field_text, field_int4) FROM STDIN&quot;)
668              : conn.BeginTextImport($&quot;COPY {table} (field_text, field_int4) FROM STDIN&quot;);
669          StateAssertions(conn);
670          writer.Write(line);
671          writer.Dispose();
672          Assert.That(await conn.ExecuteScalarAsync($&quot;SELECT COUNT(*) FROM {table} WHERE field_int4=1&quot;), Is.EqualTo(1));
673          Assert.That(() =&gt; writer.Write(line), Throws.Exception.TypeOf&lt;ObjectDisposedException&gt;());
674          await conn.ExecuteNonQueryAsync($&quot;TRUNCATE {table}&quot;);
675          var iterations = NpgsqlWriteBuffer.MinimumSize/line.Length + 100;
676          writer = async
677              ? await conn.BeginTextImportAsync($&quot;COPY {table} (field_text, field_int4) FROM STDIN&quot;)
678              : conn.BeginTextImport($&quot;COPY {table} (field_text, field_int4) FROM STDIN&quot;);
679          for (var i = 0; i &lt; iterations; i++)
680              writer.Write(line);
681          writer.Dispose();
682          Assert.That(await conn.ExecuteScalarAsync($&quot;SELECT COUNT(*) FROM {table} WHERE field_int4=1&quot;), Is.EqualTo(iterations));
683      }
684      [Test]
685      public async Task Cancel_text_import()
686      {
687          using var conn = await OpenConnectionAsync();
688          var table = await CreateTempTable(conn, &quot;field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER&quot;);
689          var writer = (NpgsqlCopyTextWriter)conn.BeginTextImport($&quot;COPY {table} (field_text, field_int4) FROM STDIN&quot;);
690          writer.Write(&quot;HELLO\t1\n&quot;);
691          writer.Cancel();
692          Assert.That(await conn.ExecuteScalarAsync($&quot;SELECT COUNT(*) FROM {table}&quot;), Is.EqualTo(0));
693      }
694      [Test]
695      public async Task Text_import_empty()
696      {
697          using var conn = await OpenConnectionAsync();
698          var table = await CreateTempTable(conn, &quot;field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER&quot;);
699          using (conn.BeginTextImport($&quot;COPY {table} (field_text, field_int4) FROM STDIN&quot;))
700          {
701          }
702          Assert.That(await conn.ExecuteScalarAsync($&quot;SELECT COUNT(*) FROM {table}&quot;), Is.EqualTo(0));
703      }
704      [Test]
705      public async Task Text_export([Values(false, true)] bool async)
706      {
707          using var conn = await OpenConnectionAsync();
708          var table = await GetTempTableName(conn);
709          await conn.ExecuteNonQueryAsync($@&quot;
710  CREATE  TABLE {table} (field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER);
711  INSERT INTO {table} (field_text, field_int4) VALUES (&#x27;HELLO&#x27;, 1)&quot;);
712          var chars = new char[30];
713          var reader = async
714              ? await conn.BeginTextExportAsync($&quot;COPY {table} (field_text, field_int4) TO STDIN&quot;)
715              : conn.BeginTextExport($&quot;COPY {table} (field_text, field_int4) TO STDIN&quot;);
716          StateAssertions(conn);
717          Assert.That(reader.Read(chars, 0, chars.Length), Is.EqualTo(8));
718          Assert.That(new string(chars, 0, 8), Is.EqualTo(&quot;HELLO\t1\n&quot;));
719          Assert.That(reader.Read(chars, 0, chars.Length), Is.EqualTo(0));
720          Assert.That(reader.Read(chars, 0, chars.Length), Is.EqualTo(0));
721          reader.Dispose();
722          Assert.That(() =&gt; reader.Read(chars, 0, chars.Length), Throws.Exception.TypeOf&lt;ObjectDisposedException&gt;());
723          await conn.ExecuteNonQueryAsync($&quot;TRUNCATE {table}&quot;);
724      }
725      [Test]
726      public async Task Dispose_in_middle_of_text_export()
727      {
728          using var conn = await OpenConnectionAsync();
729          var table = await GetTempTableName(conn);
730          await conn.ExecuteNonQueryAsync($@&quot;
731  CREATE TABLE {table} (field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER);
732  INSERT INTO {table} (field_text, field_int4) VALUES (&#x27;HELLO&#x27;, 1)&quot;);
733          var reader = conn.BeginTextExport($&quot;COPY {table} (field_text, field_int4) TO STDIN&quot;);
734          reader.Dispose();
735          Assert.That(await conn.ExecuteScalarAsync(&quot;SELECT 1&quot;), Is.EqualTo(1));
736      }
737      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2330&quot;)]
738      public async Task Wrong_table_definition_text_import()
739      {
740          if (IsMultiplexing)
741              Assert.Ignore(&quot;Multiplexing: fails&quot;);
742          using var conn = await OpenConnectionAsync();
743          Assert.Throws&lt;PostgresException&gt;(() =&gt; conn.BeginTextImport(&quot;COPY table_is_not_exist (blob) FROM STDIN&quot;));
744          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Open));
745          Assert.That(await conn.ExecuteScalarAsync(&quot;SELECT 1&quot;), Is.EqualTo(1));
746      }
747      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2330&quot;)]
748      public async Task Wrong_format_text_import()
749      {
750          if (IsMultiplexing)
751              Assert.Ignore(&quot;Multiplexing: fails&quot;);
752          using var conn = await OpenConnectionAsync();
753          var table = await CreateTempTable(conn, &quot;blob BYTEA&quot;);
754          Assert.Throws&lt;Exception&gt;(() =&gt; conn.BeginTextImport($&quot;COPY {table} (blob) FROM STDIN BINARY&quot;));
755          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Broken));
756      }
757      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2330&quot;)]
758      public async Task Wrong_table_definition_text_export()
759      {
760          if (IsMultiplexing)
761              Assert.Ignore(&quot;Multiplexing: fails&quot;);
762          using var conn = await OpenConnectionAsync();
763          Assert.Throws&lt;PostgresException&gt;(() =&gt; conn.BeginTextExport(&quot;COPY table_is_not_exist (blob) TO STDOUT&quot;));
764          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Open));
765          Assert.That(await conn.ExecuteScalarAsync(&quot;SELECT 1&quot;), Is.EqualTo(1));
766      }
767      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2330&quot;)]
768      public async Task Wrong_format_text_export()
769      {
770          if (IsMultiplexing)
771              Assert.Ignore(&quot;Multiplexing: fails&quot;);
772          using var conn = await OpenConnectionAsync();
773          var table = await CreateTempTable(conn, &quot;blob BYTEA&quot;);
774          Assert.Throws&lt;Exception&gt;(() =&gt; conn.BeginTextExport($&quot;COPY {table} (blob) TO STDOUT BINARY&quot;));
775          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Broken));
776      }
777      [Test]
778      public async Task Cancel_text_export_when_not_consumed_and_then_Dispose()
779      {
780          await using var conn = await OpenConnectionAsync();
781          var reader = (NpgsqlCopyTextReader) conn.BeginTextExport(&quot;COPY (select md5(random()::text) as id from generate_series(1, 100000)) TO STDOUT&quot;);
782          var buffer = new char[32];
783          await reader.ReadAsync(buffer, 0, buffer.Length);
784          reader.Cancel();
785          Assert.DoesNotThrow(reader.Dispose);
786          Assert.That(async () =&gt; await conn.ExecuteScalarAsync(&quot;SELECT 1&quot;), Is.EqualTo(1), &quot;The connection is still OK&quot;);
787      }
788      #endregion
789      #region Other
790      [Test, Description(&quot;Starts a transaction before a COPY, testing that prepended messages are handled well&quot;)]
791      public async Task Prepended_messages()
792      {
793          using var conn = await OpenConnectionAsync();
794          conn.BeginTransaction();
795          await Text_import(async: false);
796      }
797      [Test]
798      public async Task Undefined_table_throws()
799      {
800          using var conn = await OpenConnectionAsync();
801          Assert.That(() =&gt; conn.BeginBinaryImport(&quot;COPY undefined_table (field_text, field_int2) FROM STDIN BINARY&quot;),
802              Throws.Exception
803                  .TypeOf&lt;PostgresException&gt;()
804                  .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.UndefinedTable)
805          );
806      }
807      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/621&quot;)]
808      public async Task Close_during_copy_throws()
809      {
810          using (var conn = await OpenConnectionAsync()) {
811              var table = await CreateTempTable(conn, &quot;field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER&quot;);
812              conn.BeginBinaryImport($&quot;COPY {table} (field_text, field_int4) FROM STDIN BINARY&quot;);
813          }
814          using (var conn = await OpenConnectionAsync()) {
815              var table = await CreateTempTable(conn, &quot;field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER&quot;);
816              conn.BeginBinaryExport($&quot;COPY {table} (field_text, field_int2) TO STDIN BINARY&quot;);
817          }
818          using (var conn = await OpenConnectionAsync()) {
819              var table = await CreateTempTable(conn, &quot;field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER&quot;);
820              conn.BeginRawBinaryCopy($&quot;COPY {table} (field_text, field_int4) FROM STDIN BINARY&quot;);
821          }
822          using (var conn = await OpenConnectionAsync()) {
823              var table = await CreateTempTable(conn, &quot;field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER&quot;);
824              conn.BeginRawBinaryCopy($&quot;COPY {table} (field_text, field_int4) TO STDIN BINARY&quot;);
825          }
826          using (var conn = await OpenConnectionAsync()) {
827              var table = await CreateTempTable(conn, &quot;field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER&quot;);
828              conn.BeginTextImport($&quot;COPY {table} (field_text, field_int4) FROM STDIN&quot;);
829          }
830          using (var conn = await OpenConnectionAsync()) {
831              var table = await CreateTempTable(conn, &quot;field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER&quot;);
832              conn.BeginTextExport($&quot;COPY {table} (field_text, field_int4) TO STDIN&quot;);
833          }
834      }
835      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/994&quot;)]
836      public async Task Non_ascii_column_name()
837      {
838          using var conn = await OpenConnectionAsync();
839          var table = await CreateTempTable(conn, &quot;non_ascii_ TEXT&quot;);
840          using (conn.BeginBinaryImport($&quot;COPY {table} (non_ascii_) FROM STDIN BINARY&quot;)) { }
841      }
842      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;stackoverflow.com/questions/37431054/08p01-insufficient-data-left-in-message-for-nullable-datetime/37431464&quot;)]
843      public async Task Write_null_values()
844      {
845          using var conn = await OpenConnectionAsync();
846          var table = await CreateTempTable(conn, &quot;foo1 INT, foo2 UUID, foo3 INT, foo4 UUID&quot;);
847          using (var writer = conn.BeginBinaryImport($&quot;COPY {table} (foo1, foo2, foo3, foo4) FROM STDIN BINARY&quot;))
848          {
849              writer.StartRow();
850              writer.Write(DBNull.Value, NpgsqlDbType.Integer);
851              writer.Write((string?)null, NpgsqlDbType.Uuid);
852              writer.Write(DBNull.Value);
853              writer.Write((string?)null);
854              var rowsWritten = writer.Complete();
855              Assert.That(rowsWritten, Is.EqualTo(1));
856          }
857          using (var cmd = new NpgsqlCommand($&quot;SELECT foo1,foo2,foo3,foo4 FROM {table}&quot;, conn))
858          using (var reader = await cmd.ExecuteReaderAsync())
859          {
860              Assert.That(reader.Read(), Is.True);
861              for (var i = 0; i &lt; reader.FieldCount; i++)
862                  Assert.That(reader.IsDBNull(i), Is.True);
863          }
864      }
865      [Test]
866      public async Task Write_different_types()
867      {
868          using var conn = await OpenConnectionAsync();
869          var table = await CreateTempTable(conn, &quot;foo INT, bar INT[]&quot;);
870          using (var writer = conn.BeginBinaryImport($&quot;COPY {table} (foo, bar) FROM STDIN BINARY&quot;))
871          {
872              writer.StartRow();
873              writer.Write(3.0, NpgsqlDbType.Integer);
874              writer.Write((object)new[] { 1, 2, 3 });
875              writer.StartRow();
876              writer.Write(3, NpgsqlDbType.Integer);
877              writer.Write((object)new List&lt;int&gt; { 4, 5, 6 });
878              var rowsWritten = writer.Complete();
879              Assert.That(rowsWritten, Is.EqualTo(2));
880          }
881          Assert.That(await conn.ExecuteScalarAsync($&quot;SELECT COUNT(*) FROM {table}&quot;), Is.EqualTo(2));
882      }
883      [Test, Description(&quot;Tests nested binding scopes in multiplexing&quot;)]
884      public async Task Within_transaction()
885      {
886          using var conn = await OpenConnectionAsync();
887          var table = await CreateTempTable(conn, &quot;foo INT&quot;);
888          using (var tx = conn.BeginTransaction())
889          using (var writer = conn.BeginBinaryImport($&quot;COPY {table} (foo) FROM STDIN BINARY&quot;))
890          {
891              writer.StartRow();
892              writer.Write(1);
893              writer.Dispose();
894              await tx.CommitAsync();
895          }
896          using (var tx = conn.BeginTransaction())
897          using (var writer = conn.BeginBinaryImport($&quot;COPY {table} (foo) FROM STDIN BINARY&quot;))
898          {
899              writer.StartRow();
900              writer.Write(2);
901              writer.Complete();
902          }
903          using (var tx = conn.BeginTransaction())
904          {
905              using (var writer = conn.BeginBinaryImport($&quot;COPY {table} (foo) FROM STDIN BINARY&quot;))
906              {
907                  writer.StartRow();
908                  writer.Write(3);
909                  writer.Complete();
910              }
911              await tx.CommitAsync();
912          }
913          Assert.That(async () =&gt; await conn.ExecuteScalarAsync($&quot;SELECT COUNT(*) FROM {table}&quot;), Is.EqualTo(1));
914          Assert.That(async () =&gt; await conn.ExecuteScalarAsync($&quot;SELECT foo FROM {table}&quot;), Is.EqualTo(3));
915      }
916      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/4199&quot;)]
917      public async Task Copy_from_is_not_supported_in_regular_command_execution()
918      {
919          await using var dataSource = CreateDataSource();
920          await using var conn = await dataSource.OpenConnectionAsync();
921          var table = await CreateTempTable(conn, &quot;foo INT&quot;);
922          Assert.That(() =&gt; conn.ExecuteNonQuery($@&quot;COPY {table} (foo) FROM stdin&quot;), Throws.Exception.TypeOf&lt;NotSupportedException&gt;());
923      }
924      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/4974&quot;)]
925      public async Task Copy_to_is_not_supported_in_regular_command_execution()
926      {
927          await using var dataSource = CreateDataSource();
928          await using var conn = await dataSource.OpenConnectionAsync();
929          var table = await CreateTempTable(conn, &quot;foo INT&quot;);
930          Assert.That(() =&gt; conn.ExecuteNonQuery($@&quot;COPY {table} (foo) TO stdin&quot;), Throws.Exception.TypeOf&lt;NotSupportedException&gt;());
931      }
932      #endregion
933      #region Utils
934      void StateAssertions(NpgsqlConnection conn)
935      {
936          Assert.That(conn.Connector!.State, Is.EqualTo(ConnectorState.Copy));
937          Assert.That(conn.State, Is.EqualTo(ConnectionState.Open));
938          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Open | ConnectionState.Fetching));
939          Assert.That(async () =&gt; await conn.ExecuteScalarAsync(&quot;SELECT 1&quot;), Throws.Exception.TypeOf&lt;NpgsqlOperationInProgressException&gt;());
940      }
941      #endregion
942      public CopyTests(MultiplexingMode multiplexingMode) : base(multiplexingMode) {}
943  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-ByteaTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-CopyTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>20          var array = new byte[conn.Settings.WriteBufferSize + 100];
21          var sqlLiteral = &quot;\\x&quot; + new string(&#x27;1&#x27;, (conn.Settings.WriteBufferSize + 100) * 2);
</pre></code></div>
                <div class="column column_space"><pre><code>380          var data = new byte[conn.Settings.WriteBufferSize + 10];
381          var writer = conn.BeginBinaryImport($&quot;COPY {table} (blob) FROM STDIN BINARY&quot;);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    