
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 13, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-CommandTests.cs</h3>
            <pre><code>1  using Npgsql.BackendMessages;
2  using Npgsql.Internal;
3  using Npgsql.Tests.Support;
4  using Npgsql.TypeMapping;
5  using NpgsqlTypes;
6  using NUnit.Framework;
7  using System;
8  using System.Buffers.Binary;
9  using System.Data;
10  using System.Linq;
11  using System.Text;
12  using System.Threading;
13  using System.Threading.Tasks;
14  using static Npgsql.Tests.TestUtil;
<span onclick='openModal()' class='match'>15  namespace Npgsql.Tests;
16  public class CommandTests : MultiplexingTestBase
17  {
18      #region Legacy batching
19      [Test]
</span>20      [TestCase(new[] { true }, TestName = "SingleQuery")]
21      [TestCase(new[] { false }, TestName = "SingleNonQuery")]
22      [TestCase(new[] { true, true }, TestName = "TwoQueries")]
23      [TestCase(new[] { false, false }, TestName = "TwoNonQueries")]
24      [TestCase(new[] { false, true }, TestName = "NonQueryQuery")]
25      [TestCase(new[] { true, false }, TestName = "QueryNonQuery")]
26      public async Task Multiple_statements(bool[] queries)
27      {
28          await using var conn = await OpenConnectionAsync();
29          var table = await CreateTempTable(conn, "name TEXT");
30          var sb = new StringBuilder();
31          foreach (var query in queries)
32              sb.Append(query ? "SELECT 1;" : $"UPDATE {table} SET name='yo' WHERE 1=0;");
33          var sql = sb.ToString();
34          foreach (var prepare in new[] { false, true })
35          {
36              await using var cmd = conn.CreateCommand();
37              cmd.CommandText = sql;
38              if (prepare && !IsMultiplexing)
39                  await cmd.PrepareAsync();
40              await using var reader = await cmd.ExecuteReaderAsync();
41              var numResultSets = queries.Count(q => q);
42              for (var i = 0; i < numResultSets; i++)
43              {
44                  Assert.That(await reader.ReadAsync(), Is.True);
45                  Assert.That(reader[0], Is.EqualTo(1));
46                  Assert.That(await reader.NextResultAsync(), Is.EqualTo(i != numResultSets - 1));
47              }
48          }
49      }
50      [Test]
51      public async Task Multiple_statements_with_parameters([Values(PrepareOrNot.NotPrepared, PrepareOrNot.Prepared)] PrepareOrNot prepare)
52      {
53          if (prepare == PrepareOrNot.Prepared && IsMultiplexing)
54              return;
55          await using var conn = await OpenConnectionAsync();
56          await using var cmd = conn.CreateCommand();
57          cmd.CommandText = "SELECT @p1; SELECT @p2";
58          var p1 = new NpgsqlParameter("p1", NpgsqlDbType.Integer);
59          var p2 = new NpgsqlParameter("p2", NpgsqlDbType.Text);
60          cmd.Parameters.Add(p1);
61          cmd.Parameters.Add(p2);
62          if (prepare == PrepareOrNot.Prepared)
63              cmd.Prepare();
64          p1.Value = 8;
65          p2.Value = "foo";
66          await using var reader = await cmd.ExecuteReaderAsync();
67          Assert.That(await reader.ReadAsync(), Is.True);
68          Assert.That(reader.GetInt32(0), Is.EqualTo(8));
69          Assert.That(await reader.NextResultAsync(), Is.True);
70          Assert.That(await reader.ReadAsync(), Is.True);
71          Assert.That(reader.GetString(0), Is.EqualTo("foo"));
72          Assert.That(await reader.NextResultAsync(), Is.False);
73      }
74      [Test]
75      public async Task SingleRow_legacy_batching([Values(PrepareOrNot.NotPrepared, PrepareOrNot.Prepared)] PrepareOrNot prepare)
76      {
77          if (prepare == PrepareOrNot.Prepared && IsMultiplexing)
78              return;
79          using var conn = await OpenConnectionAsync();
80          using var cmd = new NpgsqlCommand("SELECT 1; SELECT 2", conn);
81          if (prepare == PrepareOrNot.Prepared)
82              cmd.Prepare();
83          using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SingleRow);
84          Assert.That(reader.Read(), Is.True);
85          Assert.That(reader.GetInt32(0), Is.EqualTo(1));
86          Assert.That(reader.Read(), Is.False);
87          Assert.That(reader.NextResult(), Is.False);
88      }
89      [Test, Description("Makes sure a later command can depend on an earlier one")]
90      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/641")]
91      public async Task Multiple_statements_with_dependencies()
92      {
93          using var conn = await OpenConnectionAsync();
94          var table = await CreateTempTable(conn, "a INT");
95          await conn.ExecuteNonQueryAsync($"ALTER TABLE {table} ADD COLUMN b INT; INSERT INTO {table} (b) VALUES (8)");
96          Assert.That(await conn.ExecuteScalarAsync($"SELECT b FROM {table}"), Is.EqualTo(8));
97      }
98      [Test, Description("Forces async write mode when the first statement in a multi-statement command is big")]
99      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/641")]
100      public async Task Multiple_statements_large_first_command()
101      {
102          using var conn = await OpenConnectionAsync();
103          using var cmd = new NpgsqlCommand($"SELECT repeat('X', {conn.Settings.WriteBufferSize}); SELECT @p", conn);
104          var expected1 = new string('X', conn.Settings.WriteBufferSize);
105          var expected2 = new string('Y', conn.Settings.WriteBufferSize);
106          cmd.Parameters.AddWithValue("p", expected2);
107          using var reader = await cmd.ExecuteReaderAsync();
108          reader.Read();
109          Assert.That(reader.GetString(0), Is.EqualTo(expected1));
110          reader.NextResult();
111          reader.Read();
112          Assert.That(reader.GetString(0), Is.EqualTo(expected2));
113      }
114      [Test]
115      [NonParallelizable] 
116      public async Task Legacy_batching_is_not_supported_when_EnableSqlParsing_is_disabled()
117      {
118          using var _ = DisableSqlRewriting();
119          using var conn = await OpenConnectionAsync();
120          using var cmd = new NpgsqlCommand("SELECT 1; SELECT 2", conn);
121          Assert.That(async () => await cmd.ExecuteReaderAsync(), Throws.Exception.TypeOf<PostgresException>()
122              .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.SyntaxError));
123      }
124      #endregion
125      #region Timeout
126      [Test, Description("Checks that CommandTimeout gets enforced as a socket timeout")]
127      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/327")]
128      public async Task Timeout()
129      {
130          if (IsMultiplexing)
131              return; 
132          await using var dataSource = CreateDataSource(csb => csb.CommandTimeout = 1);
133          await using var conn = await dataSource.OpenConnectionAsync();
134          await using var cmd = CreateSleepCommand(conn, 10);
135          Assert.That(() => cmd.ExecuteNonQuery(), Throws.Exception
136              .TypeOf<NpgsqlException>()
137              .With.InnerException.TypeOf<TimeoutException>()
138          );
139          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Open));
140      }
141      [Test, Description("Times out an async operation, testing that cancellation occurs successfully")]
142      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/607")]
143      public async Task Timeout_async_soft()
144      {
145          if (IsMultiplexing)
146              return; 
147          await using var dataSource = CreateDataSource(csb => csb.CommandTimeout = 1);
148          await using var conn = await dataSource.OpenConnectionAsync();
149          await using var cmd = CreateSleepCommand(conn, 10);
150          Assert.That(async () => await cmd.ExecuteNonQueryAsync(),
151              Throws.Exception
152                  .TypeOf<NpgsqlException>()
153                  .With.InnerException.TypeOf<TimeoutException>());
154          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Open));
155      }
156      [Test, Description("Times out an async operation, with unsuccessful cancellation (socket break)")]
157      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/607")]
158      public async Task Timeout_async_hard()
159      {
160          if (IsMultiplexing)
161              return; 
162          var builder = new NpgsqlConnectionStringBuilder(ConnectionString) { CommandTimeout = 1 };
163          await using var postmasterMock = PgPostmasterMock.Start(builder.ConnectionString);
164          await using var dataSource = CreateDataSource(postmasterMock.ConnectionString);
165          await using var conn = await dataSource.OpenConnectionAsync();
166          await postmasterMock.WaitForServerConnection();
167          var processId = conn.ProcessID;
168          Assert.That(async () => await conn.ExecuteScalarAsync("SELECT 1"),
169              Throws.Exception
170                  .TypeOf<NpgsqlException>()
171                  .With.InnerException.TypeOf<TimeoutException>());
172          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Broken));
173          Assert.That((await postmasterMock.WaitForCancellationRequest()).ProcessId,
174              Is.EqualTo(processId));
175      }
176      [Test]
177      public async Task Timeout_from_connection_string()
178      {
179          Assert.That(NpgsqlConnector.MinimumInternalCommandTimeout, Is.Not.EqualTo(NpgsqlCommand.DefaultTimeout));
180          var timeout = NpgsqlConnector.MinimumInternalCommandTimeout;
181          await using var dataSource = CreateDataSource(csb => csb.CommandTimeout = timeout);
182          await using var conn = await dataSource.OpenConnectionAsync();
183          await using var command = new NpgsqlCommand("SELECT 1", conn);
184          Assert.That(command.CommandTimeout, Is.EqualTo(timeout));
185          command.CommandTimeout = 10;
186          await command.ExecuteScalarAsync();
187          Assert.That(command.CommandTimeout, Is.EqualTo(10));
188      }
189      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/395")]
190      public async Task Timeout_switch_connection()
191      {
192          var csb = new NpgsqlConnectionStringBuilder(ConnectionString);
193          if (csb.CommandTimeout >= 100 && csb.CommandTimeout < 105)
194              IgnoreExceptOnBuildServer("Bad default command timeout");
195          await using var dataSource1 = CreateDataSource(ConnectionString + ";CommandTimeout=100");
196          await using var c1 = dataSource1.CreateConnection();
197          await using var cmd = c1.CreateCommand();
198          Assert.That(cmd.CommandTimeout, Is.EqualTo(100));
199          await using var dataSource2 = CreateDataSource(ConnectionString + ";CommandTimeout=101");
200          await using (var c2 = dataSource2.CreateConnection())
201          {
202              cmd.Connection = c2;
203              Assert.That(cmd.CommandTimeout, Is.EqualTo(101));
204          }
205          cmd.CommandTimeout = 102;
206          await using (var c2 = dataSource2.CreateConnection())
207          {
208              cmd.Connection = c2;
209              Assert.That(cmd.CommandTimeout, Is.EqualTo(102));
210          }
211      }
212      [Test]
213      public async Task Prepare_timeout_hard([Values] SyncOrAsync async)
214      {
215          if (IsMultiplexing)
216              return; 
217          var builder = new NpgsqlConnectionStringBuilder(ConnectionString) { CommandTimeout = 1 };
218          await using var postmasterMock = PgPostmasterMock.Start(builder.ConnectionString);
219          await using var dataSource = CreateDataSource(postmasterMock.ConnectionString);
220          await using var conn = await dataSource.OpenConnectionAsync();
221          await postmasterMock.WaitForServerConnection();
222          var processId = conn.ProcessID;
223          var cmd = new NpgsqlCommand("SELECT 1", conn);
224          Assert.That(async () =>
225              {
226                  if (async == SyncOrAsync.Sync)
227                      cmd.Prepare();
228                  else
229                      await cmd.PrepareAsync();
230              },
231              Throws.Exception
232                  .TypeOf<NpgsqlException>()
233                  .With.InnerException.TypeOf<TimeoutException>());
234          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Broken));
235          Assert.That((await postmasterMock.WaitForCancellationRequest()).ProcessId,
236              Is.EqualTo(processId));
237      }
238      #endregion
239      #region Cancel
240      [Test, Description("Basic cancellation scenario")]
241      [Ignore("Flaky, see https:&bsol;&bsol;github.com/npgsql/npgsql/issues/5070")]
242      public async Task Cancel()
243      {
244          if (IsMultiplexing)
245              return;
246          await using var conn = await OpenConnectionAsync();
247          await using var cmd = CreateSleepCommand(conn, 5);
248          var queryTask = Task.Run(() => cmd.ExecuteNonQuery());
249          cmd.WaitUntilCommandIsInProgress();
250          cmd.Cancel();
251          Assert.That(async () => await queryTask, Throws
252              .TypeOf<OperationCanceledException>()
253              .With.InnerException.TypeOf<PostgresException>()
254              .With.InnerException.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.QueryCanceled)
255          );
256      }
257      [Test]
258      public async Task Cancel_async_immediately()
259      {
260          if (IsMultiplexing)
261              return; 
262          await using var conn = await OpenConnectionAsync();
263          await using var cmd = conn.CreateCommand();
264          cmd.CommandText = "SELECT 1";
265          var t = cmd.ExecuteScalarAsync(new(canceled: true));
266          Assert.That(t.IsCompleted, Is.True); 
267          Assert.That(t.Status, Is.EqualTo(TaskStatus.Canceled));
268          Assert.ThrowsAsync<OperationCanceledException>(async () => await t);
269          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Open));
270          Assert.That(await conn.ExecuteScalarAsync("SELECT 1"), Is.EqualTo(1));
271      }
272      [Test, Description("Cancels an async query with the cancellation token, with successful PG cancellation")]
273      [Explicit("Flaky due to #5033")]
274      public async Task Cancel_async_soft()
275      {
276          if (IsMultiplexing)
277              return; 
278          await using var conn = await OpenConnectionAsync();
279          await using var cmd = CreateSleepCommand(conn);
280          using var cancellationSource = new CancellationTokenSource();
281          var t = cmd.ExecuteNonQueryAsync(cancellationSource.Token);
282          cancellationSource.Cancel();
283          var exception = Assert.ThrowsAsync<OperationCanceledException>(async () => await t)!;
284          Assert.That(exception.InnerException,
285              Is.TypeOf<PostgresException>().With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.QueryCanceled));
286          Assert.That(exception.CancellationToken, Is.EqualTo(cancellationSource.Token));
287          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Open));
288          Assert.That(await conn.ExecuteScalarAsync("SELECT 1"), Is.EqualTo(1));
289      }
290      [Test, Description("Cancels an async query with the cancellation token, with unsuccessful PG cancellation (socket break)")]
291      public async Task Cancel_async_hard()
292      {
293          if (IsMultiplexing)
294              return; 
295          await using var postmasterMock = PgPostmasterMock.Start(ConnectionString);
296          await using var dataSource = CreateDataSource(postmasterMock.ConnectionString);
297          await using var conn = await dataSource.OpenConnectionAsync();
298          await postmasterMock.WaitForServerConnection();
299          var processId = conn.ProcessID;
300          using var cancellationSource = new CancellationTokenSource();
301          using var cmd = new NpgsqlCommand("SELECT 1", conn);
302          var t = cmd.ExecuteScalarAsync(cancellationSource.Token);
303          cancellationSource.Cancel();
304          var exception = Assert.ThrowsAsync<OperationCanceledException>(async () => await t)!;
305          Assert.That(exception.InnerException, Is.TypeOf<TimeoutException>());
306          Assert.That(exception.CancellationToken, Is.EqualTo(cancellationSource.Token));
307          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Broken));
308          Assert.That((await postmasterMock.WaitForCancellationRequest()).ProcessId,
309              Is.EqualTo(processId));
310      }
311      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3466")]
312      [Ignore("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4668")]
313      public async Task Bug3466([Values(false, true)] bool isBroken)
314      {
315          if (IsMultiplexing)
316              return; 
317          var csb = new NpgsqlConnectionStringBuilder(ConnectionString)
318          {
319              Pooling = false
320          };
321          await using var postmasterMock = PgPostmasterMock.Start(csb.ToString(), completeCancellationImmediately: false);
322          await using var dataSource = CreateDataSource(postmasterMock.ConnectionString);
323          await using var conn = await dataSource.OpenConnectionAsync();
324          var serverMock = await postmasterMock.WaitForServerConnection();
325          var processId = conn.ProcessID;
326          using var cancellationSource = new CancellationTokenSource();
327          await using var cmd = new NpgsqlCommand("SELECT 1", conn)
328          {
329              CommandTimeout = 4
330          };
331          var t = Task.Run(() => cmd.ExecuteScalar());
332          cmd.WaitUntilCommandIsInProgress();
333          var cancelTask = Task.Run(() => cmd.Cancel());
334          var cancellationRequest = await postmasterMock.WaitForCancellationRequest();
335          if (isBroken)
336          {
337              Assert.ThrowsAsync<OperationCanceledException>(async () => await t);
338              Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Broken));
339          }
340          else
341          {
342              await serverMock
343                  .WriteParseComplete()
344                  .WriteBindComplete()
345                  .WriteRowDescription(new FieldDescription(PostgresTypeOIDs.Int4))
346                  .WriteDataRow(BitConverter.GetBytes(BinaryPrimitives.ReverseEndianness(1)))
347                  .WriteCommandComplete()
348                  .WriteReadyForQuery()
349                  .FlushAsync();
350              Assert.DoesNotThrowAsync(async () => await t);
351              Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Open));
352              await conn.CloseAsync();
353          }
354          cancellationRequest.Complete();
355          Assert.DoesNotThrowAsync(async () => await cancelTask);
356      }
357      [Test, Description("Check that cancel only affects the command on which its was invoked")]
358      [Explicit("Timing-sensitive")]
359      public async Task Cancel_cross_command()
360      {
361          await using var conn = await OpenConnectionAsync();
362          await using var cmd1 = CreateSleepCommand(conn, 2);
363          await using var cmd2 = new NpgsqlCommand("SELECT 1", conn);
364          var cancelTask = Task.Factory.StartNew(() =>
365          {
366              Thread.Sleep(300);
367              cmd2.Cancel();
368          });
369          Assert.That(() => cmd1.ExecuteNonQueryAsync(), Throws.Nothing);
370          cancelTask.Wait();
371      }
372      #endregion
373      #region Cursors
374      [Test]
375      public async Task Cursor_statement()
376      {
377          using var conn = await OpenConnectionAsync();
378          var table = await CreateTempTable(conn, "name TEXT");
379          using var t = conn.BeginTransaction();
380          for (var x = 0; x < 5; x++)
381              await conn.ExecuteNonQueryAsync($"INSERT INTO {table} (name) VALUES ('X')");
382          var i = 0;
383          var command = new NpgsqlCommand($"DECLARE TE CURSOR FOR SELECT * FROM {table}", conn);
384          command.ExecuteNonQuery();
385          command.CommandText = "FETCH FORWARD 3 IN TE";
386          var dr = command.ExecuteReader();
387          while (dr.Read())
388              i++;
389          Assert.AreEqual(3, i);
390          dr.Close();
391          i = 0;
392          command.CommandText = "FETCH BACKWARD 1 IN TE";
393          var dr2 = command.ExecuteReader();
394          while (dr2.Read())
395              i++;
396          Assert.AreEqual(1, i);
397          dr2.Close();
398          command.CommandText = "close te;";
399          command.ExecuteNonQuery();
400      }
401      [Test]
402      public async Task Cursor_move_RecordsAffected()
403      {
404          using var connection = await OpenConnectionAsync();
405          using var transaction = connection.BeginTransaction();
406          var command = new NpgsqlCommand("DECLARE curs CURSOR FOR SELECT * FROM (VALUES (1), (2), (3)) as t", connection);
407          command.ExecuteNonQuery();
408          command.CommandText = "MOVE FORWARD ALL IN curs";
409          var count = command.ExecuteNonQuery();
410          Assert.AreEqual(3, count);
411      }
412      #endregion
413      #region CommandBehavior.CloseConnection
414      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/693")]
415      public async Task CloseConnection()
416      {
417          using var conn = await OpenConnectionAsync();
418          using (var cmd = new NpgsqlCommand("SELECT 1", conn))
419          using (var reader = await cmd.ExecuteReaderAsync(CommandBehavior.CloseConnection))
420              while (reader.Read()) {}
421          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
422      }
423      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1194")]
424      public async Task CloseConnection_with_open_reader_with_CloseConnection()
425      {
426          using var conn = await OpenConnectionAsync();
427          var cmd = new NpgsqlCommand("SELECT 1", conn);
428          var reader = await cmd.ExecuteReaderAsync(CommandBehavior.CloseConnection);
429          var wasClosed = false;
430          reader.ReaderClosed += (sender, args) => { wasClosed = true; };
431          conn.Close();
432          Assert.That(wasClosed, Is.True);
433      }
434      [Test]
435      public async Task CloseConnection_with_exception()
436      {
437          using var conn = await OpenConnectionAsync();
438          using (var cmd = new NpgsqlCommand("SE", conn))
439              Assert.That(() => cmd.ExecuteReaderAsync(CommandBehavior.CloseConnection), Throws.Exception.TypeOf<PostgresException>());
440          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
441      }
442      #endregion
443      [Test]
444      public async Task SingleRow([Values(PrepareOrNot.NotPrepared, PrepareOrNot.Prepared)] PrepareOrNot prepare)
445      {
446          if (prepare == PrepareOrNot.Prepared && IsMultiplexing)
447              return;
448          await using var conn = await OpenConnectionAsync();
449          await using var cmd = new NpgsqlCommand("SELECT 1, 2 UNION SELECT 3, 4", conn);
450          if (prepare == PrepareOrNot.Prepared)
451              cmd.Prepare();
452          await using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SingleRow);
453          Assert.That(() => reader.GetInt32(0), Throws.Exception.TypeOf<InvalidOperationException>());
454          Assert.That(reader.Read(), Is.True);
455          Assert.That(reader.GetInt32(0), Is.EqualTo(1));
456          Assert.That(reader.Read(), Is.False);
457      }
458      #region Parameters
459      [Test]
460      public async Task Positional_parameter()
461      {
462          await using var conn = await OpenConnectionAsync();
463          await using var cmd = new NpgsqlCommand("SELECT $1", conn);
464          cmd.Parameters.Add(new NpgsqlParameter { NpgsqlDbType = NpgsqlDbType.Integer, Value = 8 });
465          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(8));
466      }
467      [Test]
468      public async Task Positional_parameters_are_not_supported_with_legacy_batching()
469      {
470          await using var conn = await OpenConnectionAsync();
471          await using var cmd = new NpgsqlCommand("SELECT $1; SELECT $1", conn);
472          cmd.Parameters.Add(new NpgsqlParameter { NpgsqlDbType = NpgsqlDbType.Integer, Value = 8 });
473          Assert.That(async () => await cmd.ExecuteScalarAsync(), Throws.Exception.TypeOf<PostgresException>()
474              .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.SyntaxError));
475      }
476      [Test]
477      [NonParallelizable] 
478      public async Task Positional_parameters_are_supported_when_EnableSqlParsing_is_disabled()
479      {
480          using var _ = DisableSqlRewriting();
481          using var conn = await OpenConnectionAsync();
482          using var cmd = new NpgsqlCommand("SELECT $1", conn);
483          cmd.Parameters.Add(new NpgsqlParameter { NpgsqlDbType = NpgsqlDbType.Integer, Value = 8 });
484          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(8));
485      }
486      [Test]
487      [NonParallelizable] 
488      public async Task Named_parameters_are_not_supported_when_EnableSqlParsing_is_disabled()
489      {
490          using var _ = DisableSqlRewriting();
491          using var conn = await OpenConnectionAsync();
492          using var cmd = new NpgsqlCommand("SELECT @p", conn);
493          cmd.Parameters.Add(new NpgsqlParameter("p", 8));
494          Assert.That(async () => await cmd.ExecuteScalarAsync(), Throws.Exception.TypeOf<NotSupportedException>());
495      }
496      [Test, Description("Makes sure writing an unset parameter isn't allowed")]
497      public async Task Parameter_without_Value()
498      {
499          using var conn = await OpenConnectionAsync();
500          using var cmd = new NpgsqlCommand("SELECT @p", conn);
501          cmd.Parameters.Add(new NpgsqlParameter("@p", NpgsqlDbType.Integer));
502          Assert.That(() => cmd.ExecuteScalarAsync(), Throws.Exception.TypeOf<InvalidCastException>());
503      }
504      [Test]
505      public async Task Unreferenced_named_parameter_works()
506      {
507          await using var conn = await OpenConnectionAsync();
508          await using var cmd = new NpgsqlCommand("SELECT 1", conn);
509          cmd.Parameters.AddWithValue("not_used", 8);
510          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(1));
511      }
512      [Test]
513      public async Task Unreferenced_positional_parameter_works()
514      {
515          await using var conn = await OpenConnectionAsync();
516          await using var cmd = new NpgsqlCommand("SELECT 1", conn);
517          cmd.Parameters.Add(new NpgsqlParameter { Value = 8 });
518          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(1));
519      }
520      [Test]
521      public async Task Mixing_positional_and_named_parameters_is_not_supported()
522      {
523          await using var conn = await OpenConnectionAsync();
524          await using var cmd = new NpgsqlCommand("SELECT $1, @p", conn);
525          cmd.Parameters.Add(new NpgsqlParameter { Value = 8 });
526          cmd.Parameters.Add(new NpgsqlParameter { ParameterName = "p", Value = 9 });
527          Assert.That(() => cmd.ExecuteNonQueryAsync(), Throws.Exception.TypeOf<NotSupportedException>());
528      }
529      [Test]
530      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4171")]
531      public async Task Cached_command_clears_parameters_placeholder_type()
532      {
533          await using var conn = await OpenConnectionAsync();
534          await using (var cmd1 = conn.CreateCommand())
535          {
536              cmd1.CommandText = "SELECT @p1";
537              cmd1.Parameters.AddWithValue("@p1", 8);
538              await using var reader1 = await cmd1.ExecuteReaderAsync();
539              reader1.Read();
540              Assert.That(reader1[0], Is.EqualTo(8));
541          }
542          await using (var cmd2 = conn.CreateCommand())
543          {
544              cmd2.CommandText = "SELECT $1";
545              cmd2.Parameters.AddWithValue(8);
546              await using var reader2 = await cmd2.ExecuteReaderAsync();
547              reader2.Read();
548              Assert.That(reader2[0], Is.EqualTo(8));
549          }
550      }
551      [Test]
552      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4171")]
553      public async Task Reuse_command_with_different_parameter_placeholder_types()
554      {
555          await using var conn = await OpenConnectionAsync();
556          await using var cmd = conn.CreateCommand();
557          cmd.CommandText = "SELECT @p1";
558          cmd.Parameters.AddWithValue("@p1", 8);
559          _ = await cmd.ExecuteScalarAsync();
560          cmd.CommandText = "SELECT $1";
561          cmd.Parameters[0].ParameterName = null;
562          _ = await cmd.ExecuteScalarAsync();
563      }
564      [Test]
565      public async Task Positional_output_parameters_are_not_supported()
566      {
567          await using var conn = await OpenConnectionAsync();
568          await using var cmd = new NpgsqlCommand("SELECT $1", conn);
569          cmd.Parameters.Add(new NpgsqlParameter { Value = 8, Direction = ParameterDirection.InputOutput });
570          Assert.That(() => cmd.ExecuteNonQueryAsync(), Throws.Exception.TypeOf<NotSupportedException>());
571      }
572      [Test]
573      public void Parameters_get_name()
574      {
575          var command = new NpgsqlCommand();
576          command.Parameters.Add(new NpgsqlParameter(":Parameter1", DbType.Boolean));
577          command.Parameters.Add(new NpgsqlParameter(":Parameter2", DbType.Int32));
578          command.Parameters.Add(new NpgsqlParameter(":Parameter3", DbType.DateTime));
579          command.Parameters.Add(new NpgsqlParameter("Parameter4", DbType.DateTime));
580          var idbPrmtr = command.Parameters["Parameter1"];
581          Assert.IsNotNull(idbPrmtr);
582          command.Parameters[0].Value = 1;
583          Assert.AreEqual(":Parameter1", command.Parameters["Parameter1"].ParameterName);
584          Assert.AreEqual(":Parameter2", command.Parameters["Parameter2"].ParameterName);
585          Assert.AreEqual(":Parameter3", command.Parameters["Parameter3"].ParameterName);
586          Assert.AreEqual("Parameter4", command.Parameters["Parameter4"].ParameterName); 
587          Assert.AreEqual(":Parameter1", command.Parameters[0].ParameterName);
588          Assert.AreEqual(":Parameter2", command.Parameters[1].ParameterName);
589          Assert.AreEqual(":Parameter3", command.Parameters[2].ParameterName);
590          Assert.AreEqual("Parameter4", command.Parameters[3].ParameterName);
591      }
592      [Test]
593      public async Task Same_param_multiple_times()
594      {
595          using var conn = await OpenConnectionAsync();
596          using var cmd = new NpgsqlCommand("SELECT @p1, @p1", conn);
597          cmd.Parameters.AddWithValue("@p1", 8);
598          using var reader = await cmd.ExecuteReaderAsync();
599          reader.Read();
600          Assert.That(reader[0], Is.EqualTo(8));
601          Assert.That(reader[1], Is.EqualTo(8));
602      }
603      [Test]
604      public async Task Generic_parameter()
605      {
606          using var conn = await OpenConnectionAsync();
607          using var cmd = new NpgsqlCommand("SELECT @p1, @p2, @p3, @p4", conn);
608          cmd.Parameters.Add(new NpgsqlParameter<int>("p1", 8));
609          cmd.Parameters.Add(new NpgsqlParameter<short>("p2", 8) { NpgsqlDbType = NpgsqlDbType.Integer });
610          cmd.Parameters.Add(new NpgsqlParameter<string>("p3", "hello"));
611          cmd.Parameters.Add(new NpgsqlParameter<char[]>("p4", new[] { 'f', 'o', 'o' }));
612          using var reader = await cmd.ExecuteReaderAsync();
613          reader.Read();
614          Assert.That(reader.GetInt32(0), Is.EqualTo(8));
615          Assert.That(reader.GetInt32(1), Is.EqualTo(8));
616          Assert.That(reader.GetString(2), Is.EqualTo("hello"));
617          Assert.That(reader.GetString(3), Is.EqualTo("foo"));
618      }
619      #endregion Parameters
620      [Test]
621      public async Task CommandText_not_set()
622      {
623          await using var conn = await OpenConnectionAsync();
624          await using (var cmd = new NpgsqlCommand())
625          {
626              cmd.Connection = conn;
627              Assert.That(cmd.ExecuteNonQueryAsync, Throws.Exception.TypeOf<InvalidOperationException>());
628              cmd.CommandText = null;
629              Assert.That(cmd.ExecuteNonQueryAsync, Throws.Exception.TypeOf<InvalidOperationException>());
630              cmd.CommandText = "";
631          }
632          await using (var cmd = conn.CreateCommand())
633              Assert.That(cmd.ExecuteNonQueryAsync, Throws.Exception.TypeOf<InvalidOperationException>());
634      }
635      [Test]
636      public async Task ExecuteScalar()
637      {
638          await using var conn = await OpenConnectionAsync();
639          var table = await CreateTempTable(conn, "name TEXT");
640          await using var command = new NpgsqlCommand($"SELECT name FROM {table}", conn);
641          Assert.That(command.ExecuteScalarAsync, Is.Null);
642          await conn.ExecuteNonQueryAsync($"INSERT INTO {table} (name) VALUES (NULL)");
643          Assert.That(command.ExecuteScalarAsync, Is.EqualTo(DBNull.Value));
644          await conn.ExecuteNonQueryAsync($"TRUNCATE {table}");
645          for (var i = 0; i < 2; i++)
646              await conn.ExecuteNonQueryAsync($"INSERT INTO {table} (name) VALUES ('X')");
647          Assert.That(command.ExecuteScalarAsync, Is.EqualTo("X"));
648      }
649      [Test]
650      public async Task ExecuteNonQuery()
651      {
652          await using var conn = await OpenConnectionAsync();
653          await using var cmd = new NpgsqlCommand { Connection = conn };
654          var table = await CreateTempTable(conn, "name TEXT");
655          cmd.CommandText = $"INSERT INTO {table} (name) VALUES ('John')";
656          Assert.That(cmd.ExecuteNonQueryAsync, Is.EqualTo(1));
657          cmd.CommandText = $"INSERT INTO {table} (name) VALUES ('John'); INSERT INTO {table} (name) VALUES ('John')";
658          Assert.That(cmd.ExecuteNonQueryAsync, Is.EqualTo(2));
659          cmd.CommandText = $"INSERT INTO {table} (name) VALUES ('{new string('x', conn.Settings.WriteBufferSize)}')";
660          Assert.That(cmd.ExecuteNonQueryAsync, Is.EqualTo(1));
661      }
662      [Test, Description("Makes sure a command is unusable after it is disposed")]
663      public async Task Dispose()
664      {
665          await using var conn = await OpenConnectionAsync();
666          var cmd = new NpgsqlCommand("SELECT 1", conn);
667          cmd.Dispose();
668          Assert.That(() => cmd.ExecuteScalarAsync(), Throws.Exception.TypeOf<ObjectDisposedException>());
669          Assert.That(() => cmd.ExecuteNonQueryAsync(), Throws.Exception.TypeOf<ObjectDisposedException>());
670          Assert.That(() => cmd.ExecuteReaderAsync(), Throws.Exception.TypeOf<ObjectDisposedException>());
671          Assert.That(() => cmd.PrepareAsync(), Throws.Exception.TypeOf<ObjectDisposedException>());
672      }
673      [Test, Description("Disposing a command with an open reader does not close the reader. This is the SqlClient behavior.")]
674      public async Task Command_Dispose_does_not_close_reader()
675      {
676          await using var conn = await OpenConnectionAsync();
677          var cmd = new NpgsqlCommand("SELECT 1, 2", conn);
678          await cmd.ExecuteReaderAsync();
679          cmd.Dispose();
680          cmd = new NpgsqlCommand("SELECT 3", conn);
681          Assert.That(() => cmd.ExecuteScalarAsync(), Throws.Exception.TypeOf<NpgsqlOperationInProgressException>());
682      }
683      [Test]
684      public async Task Non_standards_conforming_strings()
685      {
686          await using var dataSource = CreateDataSource();
687          await using var conn = await dataSource.OpenConnectionAsync();
688          if (IsMultiplexing)
689          {
690              Assert.That(async () => await conn.ExecuteNonQueryAsync("set standard_conforming_strings=off"),
691                  Throws.Exception.TypeOf<NotSupportedException>());
692          }
693          else
694          {
695              await conn.ExecuteNonQueryAsync("set standard_conforming_strings=off");
696              Assert.That(await conn.ExecuteScalarAsync("SELECT 1"), Is.EqualTo(1));
697              await conn.ExecuteNonQueryAsync("set standard_conforming_strings=on");
698          }
699      }
700      [Test]
701      public async Task Parameter_and_operator_unclear()
702      {
703          await using var conn = await OpenConnectionAsync();
704          await using var command = new NpgsqlCommand("select :arr[2]", conn);
705          command.Parameters.AddWithValue(":arr", new int[] {5, 4, 3, 2, 1});
706          await using var rdr = await command.ExecuteReaderAsync();
707          rdr.Read();
708          Assert.AreEqual(rdr.GetInt32(0), 4);
709      }
710      [Test]
711      [TestCase(CommandBehavior.Default)]
712      [TestCase(CommandBehavior.SequentialAccess)]
713      public async Task Statement_mapped_output_parameters(CommandBehavior behavior)
714      {
715          await using var conn = await OpenConnectionAsync();
716          var command = new NpgsqlCommand("select 3, 4 as param1, 5 as param2, 6;", conn);
717          var p = new NpgsqlParameter("param2", NpgsqlDbType.Integer);
718          p.Direction = ParameterDirection.Output;
719          p.Value = -1;
720          command.Parameters.Add(p);
721          p = new NpgsqlParameter("param1", NpgsqlDbType.Integer);
722          p.Direction = ParameterDirection.Output;
723          p.Value = -1;
724          command.Parameters.Add(p);
725          p = new NpgsqlParameter("p", NpgsqlDbType.Integer);
726          p.Direction = ParameterDirection.Output;
727          p.Value = -1;
728          command.Parameters.Add(p);
729          await using var reader = await command.ExecuteReaderAsync(behavior);
730          Assert.AreEqual(4, command.Parameters["param1"].Value);
731          Assert.AreEqual(5, command.Parameters["param2"].Value);
732          reader.Read();
733          Assert.AreEqual(3, reader.GetInt32(0));
734          Assert.AreEqual(4, reader.GetInt32(1));
735          Assert.AreEqual(5, reader.GetInt32(2));
736          Assert.AreEqual(6, reader.GetInt32(3));
737      }
738      [Test]
739      public async Task Bug1006158_output_parameters()
740      {
741          await using var conn = await OpenConnectionAsync();
742          MinimumPgVersion(conn, "14.0", "Stored procedure OUT parameters are only support starting with version 14");
743          var sproc = await GetTempProcedureName(conn);
744          var createFunction = $@"
745  CREATE PROCEDURE {sproc}(OUT a integer, OUT b boolean) AS $$
746  BEGIN
747      a := 3;
748      b := true;
749  END
750  $$ LANGUAGE plpgsql;";
751          var command = new NpgsqlCommand(createFunction, conn);
752          await command.ExecuteNonQueryAsync();
753          command = new NpgsqlCommand(sproc, conn);
754          command.CommandType = CommandType.StoredProcedure;
755          command.Parameters.Add(new NpgsqlParameter("a", DbType.Int32));
756          command.Parameters[0].Direction = ParameterDirection.Output;
757          command.Parameters.Add(new NpgsqlParameter("b", DbType.Boolean));
758          command.Parameters[1].Direction = ParameterDirection.Output;
759          _ = await command.ExecuteScalarAsync();
760          Assert.AreEqual(3, command.Parameters[0].Value);
761          Assert.AreEqual(true, command.Parameters[1].Value);
762      }
763      [Test]
764      public async Task Bug1010788_UpdateRowSource()
765      {
766          if (IsMultiplexing)
767              return;
768          using var conn = await OpenConnectionAsync();
769          var table = await CreateTempTable(conn, "id SERIAL PRIMARY KEY, name TEXT");
770          var command = new NpgsqlCommand($"SELECT * FROM {table}", conn);
771          Assert.AreEqual(UpdateRowSource.Both, command.UpdatedRowSource);
772          var cmdBuilder = new NpgsqlCommandBuilder();
773          var da = new NpgsqlDataAdapter(command);
774          cmdBuilder.DataAdapter = da;
775          Assert.IsNotNull(da.SelectCommand);
776          Assert.IsNotNull(cmdBuilder.DataAdapter);
777          var updateCommand = cmdBuilder.GetUpdateCommand();
778          Assert.AreEqual(UpdateRowSource.None, updateCommand.UpdatedRowSource);
779      }
780      [Test]
781      public async Task TableDirect()
782      {
783          using var conn = await OpenConnectionAsync();
784          var table = await CreateTempTable(conn, "name TEXT");
785          await conn.ExecuteNonQueryAsync($"INSERT INTO {table} (name) VALUES ('foo')");
786          using var cmd = new NpgsqlCommand(table, conn) { CommandType = CommandType.TableDirect };
787          using var rdr = await cmd.ExecuteReaderAsync();
788          Assert.That(rdr.Read(), Is.True);
789          Assert.That(rdr["name"], Is.EqualTo("foo"));
790      }
791      [Test]
792      [TestCase(CommandBehavior.Default)]
793      [TestCase(CommandBehavior.SequentialAccess)]
794      public async Task Input_and_output_parameters(CommandBehavior behavior)
795      {
796          using var conn = await OpenConnectionAsync();
797          using var cmd = new NpgsqlCommand("SELECT @c-1 AS c, @a+2 AS b", conn);
798          cmd.Parameters.Add(new NpgsqlParameter("a", 3));
799          var b = new NpgsqlParameter { ParameterName = "b", Direction = ParameterDirection.Output };
800          cmd.Parameters.Add(b);
801          var c = new NpgsqlParameter { ParameterName = "c", Direction = ParameterDirection.InputOutput, Value = 4 };
802          cmd.Parameters.Add(c);
803          using (await cmd.ExecuteReaderAsync(behavior))
804          {
805              Assert.AreEqual(5, b.Value);
806              Assert.AreEqual(3, c.Value);
807          }
808      }
809      [Test]
810      public async Task Send_NpgsqlDbType_Unknown([Values(PrepareOrNot.NotPrepared, PrepareOrNot.Prepared)] PrepareOrNot prepare)
811      {
812          if (prepare == PrepareOrNot.Prepared && IsMultiplexing)
813              return;
814          using var conn = await OpenConnectionAsync();
815          using var cmd = new NpgsqlCommand("SELECT @p::TIMESTAMP", conn);
816          cmd.CommandText = "SELECT @p::TIMESTAMP";
817          cmd.Parameters.Add(new NpgsqlParameter("p", NpgsqlDbType.Unknown) { Value = "2008-1-1" });
818          if (prepare == PrepareOrNot.Prepared)
819              cmd.Prepare();
820          using var reader = await cmd.ExecuteReaderAsync();
821          reader.Read();
822          Assert.That(reader.GetValue(0), Is.EqualTo(new DateTime(2008, 1, 1)));
823      }
824      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/503")]
825      public async Task Invalid_UTF8()
826      {
827          const string badString = "SELECT 'abc\uD801\uD802d'";
828          await using var dataSource = CreateDataSource();
829          using var conn = await dataSource.OpenConnectionAsync();
830          Assert.That(() => conn.ExecuteScalarAsync(badString), Throws.Exception.TypeOf<EncoderFallbackException>());
831      }
832      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/395")]
833      public async Task Use_across_connection_change([Values(PrepareOrNot.Prepared, PrepareOrNot.NotPrepared)] PrepareOrNot prepare)
834      {
835          if (prepare == PrepareOrNot.Prepared && IsMultiplexing)
836              return;
837          using var conn1 = await OpenConnectionAsync();
838          using var conn2 = await OpenConnectionAsync();
839          using var cmd = new NpgsqlCommand("SELECT 1", conn1);
840          if (prepare == PrepareOrNot.Prepared)
841              cmd.Prepare();
842          cmd.Connection = conn2;
843          Assert.That(cmd.IsPrepared, Is.False);
844          if (prepare == PrepareOrNot.Prepared)
845              cmd.Prepare();
846          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(1));
847      }
848      [Test, Description("CreateCommand before connection open")]
849      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/565")]
850      public async Task Create_command_before_connection_open()
851      {
852          using var conn = new NpgsqlConnection(ConnectionString);
853          var cmd = new NpgsqlCommand("SELECT 1", conn);
854          conn.Open();
855          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(1));
856      }
857      [Test]
858      public void Connection_not_set_throws()
859      {
860          var cmd = new NpgsqlCommand("SELECT 1");
861          Assert.That(() => cmd.ExecuteScalarAsync(), Throws.Exception.TypeOf<InvalidOperationException>());
862      }
863      [Test]
864      public void Connection_not_open_throws()
865      {
866          using var conn = CreateConnection();
867          var cmd = new NpgsqlCommand("SELECT 1", conn);
868          Assert.That(() => cmd.ExecuteScalarAsync(), Throws.Exception.TypeOf<InvalidOperationException>());
869      }
870      [Test]
871      public async Task ExecuteNonQuery_Throws_PostgresException([Values] bool async)
872      {
873          if (!async && IsMultiplexing)
874              return;
875          await using var conn = await OpenConnectionAsync();
876          var table1 = await CreateTempTable(conn, "id integer PRIMARY key, t varchar(40)");
877          var table2 = await CreateTempTable(conn, $"id SERIAL primary key, {table1}_id integer references {table1}(id) INITIALLY DEFERRED");
878          var sql = $"insert into {table2} ({table1}_id) values (1) returning id";
879          var ex = async
880              ? Assert.ThrowsAsync<PostgresException>(async () => await conn.ExecuteNonQueryAsync(sql))
881              : Assert.Throws<PostgresException>(() => conn.ExecuteNonQuery(sql));
882          Assert.That(ex!.SqlState, Is.EqualTo(PostgresErrorCodes.ForeignKeyViolation));
883      }
884      [Test]
885      public async Task ExecuteScalar_Throws_PostgresException([Values] bool async)
886      {
887          if (!async && IsMultiplexing)
888              return;
889          await using var conn = await OpenConnectionAsync();
890          var table1 = await CreateTempTable(conn, "id integer PRIMARY key, t varchar(40)");
891          var table2 = await CreateTempTable(conn, $"id SERIAL primary key, {table1}_id integer references {table1}(id) INITIALLY DEFERRED");
892          var sql = $"insert into {table2} ({table1}_id) values (1) returning id";
893          var ex = async
894              ? Assert.ThrowsAsync<PostgresException>(async () => await conn.ExecuteScalarAsync(sql))
895              : Assert.Throws<PostgresException>(() => conn.ExecuteScalar(sql));
896          Assert.That(ex!.SqlState, Is.EqualTo(PostgresErrorCodes.ForeignKeyViolation));
897      }
898      [Test]
899      public async Task ExecuteReader_Throws_PostgresException([Values] bool async)
900      {
901          if (!async && IsMultiplexing)
902              return;
903          await using var conn = await OpenConnectionAsync();
904          var table1 = await CreateTempTable(conn, "id integer PRIMARY key, t varchar(40)");
905          var table2 = await CreateTempTable(conn, $"id SERIAL primary key, {table1}_id integer references {table1}(id) INITIALLY DEFERRED");
906          await using var cmd = conn.CreateCommand();
907          cmd.CommandText = $"insert into {table2} ({table1}_id) values (1) returning id";
908          await using var reader = async
909              ? await cmd.ExecuteReaderAsync()
910              : cmd.ExecuteReader();
911          Assert.IsTrue(async ? await reader.ReadAsync() : reader.Read());
912          var value = reader.GetInt32(0);
913          Assert.That(value, Is.EqualTo(1));
914          Assert.IsFalse(async ? await reader.ReadAsync() : reader.Read());
915          var ex = async
916              ? Assert.ThrowsAsync<PostgresException>(async () => await reader.NextResultAsync())
917              : Assert.Throws<PostgresException>(() => reader.NextResult());
918          Assert.That(ex!.SqlState, Is.EqualTo(PostgresErrorCodes.ForeignKeyViolation));
919      }
920      [Test]
921      public void Command_is_recycled()
922      {
923          using var conn = OpenConnection();
924          var cmd1 = conn.CreateCommand();
925          cmd1.CommandText = "SELECT @p1";
926          var tx = conn.BeginTransaction();
927          cmd1.Transaction = tx;
928          cmd1.Parameters.AddWithValue("p1", 8);
929          _ = cmd1.ExecuteScalar();
930          cmd1.Dispose();
931          var cmd2 = conn.CreateCommand();
932          Assert.That(cmd2, Is.SameAs(cmd1));
933          Assert.That(cmd2.CommandText, Is.Empty);
934          Assert.That(cmd2.CommandType, Is.EqualTo(CommandType.Text));
935          Assert.That(cmd2.Transaction, Is.Null);
936          Assert.That(cmd2.Parameters, Is.Empty);
937      }
938      [Test]
939      public void Command_recycled_resets_CommandType()
940      {
941          using var conn = CreateConnection();
942          var cmd1 = conn.CreateCommand();
943          cmd1.CommandType = CommandType.StoredProcedure;
944          cmd1.Dispose();
945          var cmd2 = conn.CreateCommand();
946          Assert.That(cmd2.CommandType, Is.EqualTo(CommandType.Text));
947      }
948      [Test]
949      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/831")]
950      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2795")]
951      public async Task Many_parameters([Values(PrepareOrNot.NotPrepared, PrepareOrNot.Prepared)] PrepareOrNot prepare)
952      {
953          if (prepare == PrepareOrNot.Prepared && IsMultiplexing)
954              return;
955          using var conn = await OpenConnectionAsync();
956          var table = await CreateTempTable(conn, "some_column INT");
957          using var cmd = new NpgsqlCommand { Connection = conn };
958          var sb = new StringBuilder($"INSERT INTO {table} (some_column) VALUES ");
959          for (var i = 0; i < ushort.MaxValue; i++)
960          {
961              var paramName = "p" + i;
962              cmd.Parameters.Add(new NpgsqlParameter(paramName, 8));
963              if (i > 0)
964                  sb.Append(", ");
965              sb.Append($"(@{paramName})");
966          }
967          cmd.CommandText = sb.ToString();
968          if (prepare == PrepareOrNot.Prepared)
969              cmd.Prepare();
970          await cmd.ExecuteNonQueryAsync();
971      }
972      [Test, Description("Bypasses PostgreSQL's uint16 limitation on the number of parameters")]
973      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/831")]
974      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/858")]
975      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2703")]
976      public async Task Too_many_parameters_throws([Values(PrepareOrNot.NotPrepared, PrepareOrNot.Prepared)] PrepareOrNot prepare)
977      {
978          if (prepare == PrepareOrNot.Prepared && IsMultiplexing)
979              return;
980          using var conn = await OpenConnectionAsync();
981          using var cmd = new NpgsqlCommand { Connection = conn };
982          var sb = new StringBuilder("SOME RANDOM SQL ");
983          for (var i = 0; i < ushort.MaxValue + 1; i++)
984          {
985              var paramName = "p" + i;
986              cmd.Parameters.Add(new NpgsqlParameter(paramName, 8));
987              if (i > 0)
988                  sb.Append(", ");
989              sb.Append('@');
990              sb.Append(paramName);
991          }
992          cmd.CommandText = sb.ToString();
993          if (prepare == PrepareOrNot.Prepared)
994          {
995              Assert.That(() => cmd.Prepare(), Throws.Exception
996                  .InstanceOf<NpgsqlException>()
997                  .With.Message.EqualTo("A statement cannot have more than 65535 parameters"));
998          }
999          else
1000          {
1001              Assert.That(() => cmd.ExecuteNonQueryAsync(), Throws.Exception
1002                  .InstanceOf<NpgsqlException>()
1003                  .With.Message.EqualTo("A statement cannot have more than 65535 parameters"));
1004          }
1005      }
1006      [Test, Description("An individual statement cannot have more than 65535 parameters, but a command can (across multiple statements).")]
1007      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1199")]
1008      public async Task Many_parameters_across_statements()
1009      {
1010          using var conn = await OpenConnectionAsync();
1011          using var cmd = new NpgsqlCommand { Connection = conn };
1012          var paramIndex = 0;
1013          var sb = new StringBuilder();
1014          for (var statementIndex = 0; statementIndex < 1000; statementIndex++)
1015          {
1016              if (statementIndex > 0)
1017                  sb.Append("; ");
1018              sb.Append("SELECT ");
1019              var startIndex = paramIndex;
1020              var endIndex = paramIndex + 70;
1021              for (; paramIndex < endIndex; paramIndex++)
1022              {
1023                  var paramName = "p" + paramIndex;
1024                  cmd.Parameters.Add(new NpgsqlParameter(paramName, 8));
1025                  if (paramIndex > startIndex)
1026                      sb.Append(", ");
1027                  sb.Append('@');
1028                  sb.Append(paramName);
1029              }
1030          }
1031          cmd.CommandText = sb.ToString();
1032          await cmd.ExecuteNonQueryAsync();
1033      }
1034      [Test, Description("Makes sure that Npgsql doesn't attempt to send all data before the user can start reading. That would cause a deadlock.")]
1035      public async Task Batched_big_statements_do_not_deadlock()
1036      {
1037          var data = new string('x', 1024);
1038          using var conn = await OpenConnectionAsync();
1039          var sb = new StringBuilder();
1040          for (var i = 0; i < 500; i++)
1041              sb.Append("SELECT @p;");
1042          using var cmd = new NpgsqlCommand(sb.ToString(), conn);
1043          cmd.Parameters.AddWithValue("p", NpgsqlDbType.Text, data);
1044          using var reader = await cmd.ExecuteReaderAsync();
1045          for (var i = 0; i < 500; i++)
1046          {
1047              reader.Read();
1048              Assert.That(reader.GetString(0), Is.EqualTo(data));
1049              reader.NextResult();
1050          }
1051      }
1052      [Test]
1053      public void Batched_small_then_big_statements_do_not_deadlock_in_sync_io()
1054      {
1055          if (IsMultiplexing)
1056              return; 
1057          using var conn = OpenConnection();
1058          var data = new string('x', 5_000_000);
1059          using var cmd = new NpgsqlCommand("SELECT generate_series(1, 500000); SELECT @p", conn);
1060          cmd.Parameters.AddWithValue("p", NpgsqlDbType.Text, data);
1061          cmd.ExecuteNonQuery();
1062      }
1063      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1429")]
1064      public async Task Same_command_different_param_values()
1065      {
1066          using var conn = await OpenConnectionAsync();
1067          using var cmd = new NpgsqlCommand("SELECT @p", conn);
1068          cmd.Parameters.AddWithValue("p", 8);
1069          await cmd.ExecuteNonQueryAsync();
1070          cmd.Parameters[0].Value = 9;
1071          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(9));
1072      }
1073      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1429")]
1074      public async Task Same_command_different_param_instances()
1075      {
1076          using var conn = await OpenConnectionAsync();
1077          using var cmd = new NpgsqlCommand("SELECT @p", conn);
1078          cmd.Parameters.AddWithValue("p", 8);
1079          await cmd.ExecuteNonQueryAsync();
1080          cmd.Parameters.RemoveAt(0);
1081          cmd.Parameters.AddWithValue("p", 9);
1082          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(9));
1083      }
1084      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3509"), Ignore("Flaky")]
1085      public async Task Bug3509()
1086      {
1087          if (IsMultiplexing)
1088              return;
1089          var csb = new NpgsqlConnectionStringBuilder(ConnectionString)
1090          {
1091              KeepAlive = 1,
1092          };
1093          await using var postmasterMock = PgPostmasterMock.Start(csb.ToString());
1094          await using var dataSource = CreateDataSource(postmasterMock.ConnectionString);
1095          await using var conn = await dataSource.OpenConnectionAsync();
1096          var serverMock = await postmasterMock.WaitForServerConnection();
1097          await serverMock.WaitForData();
1098          var queryTask = Task.Run(async () => await conn.ExecuteNonQueryAsync("SELECT 1"));
1099          await Task.Delay(300);
1100          await serverMock
1101              .WriteErrorResponse("42")
1102              .WriteReadyForQuery()
1103              .FlushAsync();
1104          await serverMock
1105              .WriteScalarResponseAndFlush(1);
1106          var ex = Assert.ThrowsAsync<NpgsqlException>(async () => await queryTask)!;
1107          Assert.That(ex.InnerException, Is.TypeOf<NpgsqlException>()
1108              .With.InnerException.TypeOf<PostgresException>());
1109      }
1110      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4134")]
1111      public async Task Cached_command_double_dispose()
1112      {
1113          await using var conn = await OpenConnectionAsync();
1114          var cmd1 = conn.CreateCommand();
1115          cmd1.Dispose();
1116          cmd1.Dispose();
1117          var cmd2 = conn.CreateCommand();
1118          Assert.That(cmd2, Is.SameAs(cmd1));
1119          cmd2.CommandText = "SELECT 1";
1120          Assert.That(await cmd2.ExecuteScalarAsync(), Is.EqualTo(1));
1121      }
1122      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4330")]
1123      public async Task Prepare_with_positional_placeholders_after_named()
1124      {
1125          if (IsMultiplexing)
1126              return; 
1127          await using var conn = await OpenConnectionAsync();
1128          await using var command = new NpgsqlCommand("SELECT @p", conn);
1129          command.Parameters.AddWithValue("p", 10);
1130          await command.ExecuteNonQueryAsync();
1131          command.Parameters.Clear();
1132          command.CommandText = "SELECT $1";
1133          command.Parameters.Add(new() { NpgsqlDbType = NpgsqlDbType.Integer });
1134          Assert.DoesNotThrowAsync(() => command.PrepareAsync());
1135      }
1136      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4621")]
1137      [Description("Most of 08* errors are coming whenever there was an error while connecting to a remote server from a cluster, so the connection to the cluster is still OK")]
1138      public async Task Postgres_connection_errors_not_break_connection()
1139      {
1140          if (IsMultiplexing)
1141              return;
1142          await using var postmasterMock = PgPostmasterMock.Start(ConnectionString);
1143          await using var dataSource = CreateDataSource(postmasterMock.ConnectionString);
1144          await using var conn = await dataSource.OpenConnectionAsync();
1145          await using var cmd = conn.CreateCommand();
1146          cmd.CommandText = "SELECT 1";
1147          var queryTask = cmd.ExecuteNonQueryAsync();
1148          var server = await postmasterMock.WaitForServerConnection();
1149          await server
1150              .WriteErrorResponse(PostgresErrorCodes.SqlClientUnableToEstablishSqlConnection)
1151              .WriteReadyForQuery()
1152              .FlushAsync();
1153          var ex = Assert.ThrowsAsync<PostgresException>(async () => await queryTask)!;
1154          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.SqlClientUnableToEstablishSqlConnection));
1155          Assert.That(conn.FullState, Is.EqualTo(ConnectionState.Open));
1156      }
1157      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4804")]
1158      [Description("Concurrent write and read failure can lead to deadlocks while cleaning up the connector.")]
1159      public async Task Concurrent_read_write_failure_deadlock()
1160      {
1161          if (IsMultiplexing)
1162              return;
1163          await using var postmasterMock = PgPostmasterMock.Start(ConnectionString);
1164          await using var dataSource = CreateDataSource(postmasterMock.ConnectionString);
1165          await using var conn = await dataSource.OpenConnectionAsync();
1166          await using var cmd = conn.CreateCommand();
1167          cmd.CommandText = new string('a', 8_000_000);
1168          var queryTask = cmd.ExecuteNonQueryAsync();
1169          var server = await postmasterMock.WaitForServerConnection();
1170          server.Close();
1171          Assert.ThrowsAsync<NpgsqlException>(async () => await queryTask);
1172      }
1173      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4906")]
1174      [Description("Make sure we don't cancel a prepended query (and do not deadlock in case of a failure)")]
1175      [Explicit("Flaky due to #5033")]
1176      public async Task Not_cancel_prepended_query([Values] bool failPrependedQuery)
1177      {
1178          if (IsMultiplexing)
1179              return;
1180          await using var postmasterMock = PgPostmasterMock.Start(ConnectionString);
1181          var csb = new NpgsqlConnectionStringBuilder(postmasterMock.ConnectionString)
1182          {
1183              NoResetOnClose = false
1184          };
1185          await using var dataSource = CreateDataSource(csb.ConnectionString);
1186          await using var conn = await dataSource.OpenConnectionAsync();
1187          await conn.CloseAsync();
1188          await conn.OpenAsync();
1189          using var cts = new CancellationTokenSource();
1190          var queryTask = conn.ExecuteNonQueryAsync("SELECT 1", cancellationToken: cts.Token);
1191          var server = await postmasterMock.WaitForServerConnection();
1192          await server.ExpectSimpleQuery("DISCARD ALL");
1193          await server.ExpectExtendedQuery();
1194          var cancelTask = Task.Run(cts.Cancel);
1195          var cancellationRequestTask = postmasterMock.WaitForCancellationRequest().AsTask();
1196          await Task.Delay(1000);
1197          Assert.IsFalse(cancelTask.IsCompleted);
1198          Assert.IsFalse(cancellationRequestTask.IsCompleted);
1199          if (failPrependedQuery)
1200          {
1201              await server
1202                  .WriteErrorResponse(PostgresErrorCodes.SyntaxError)
1203                  .WriteReadyForQuery()
1204                  .FlushAsync();
1205              await cancelTask;
1206              await cancellationRequestTask;
1207              Assert.ThrowsAsync<PostgresException>(async () => await queryTask);
1208              Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
1209              return;
1210          }
1211          await server
1212              .WriteCommandComplete()
1213              .WriteReadyForQuery()
1214              .FlushAsync();
1215          await cancelTask;
1216          await cancellationRequestTask;
1217          await server
1218              .WriteErrorResponse(PostgresErrorCodes.QueryCanceled)
1219              .WriteReadyForQuery()
1220              .FlushAsync();
1221          Assert.ThrowsAsync<OperationCanceledException>(async () => await queryTask);
1222          queryTask = conn.ExecuteNonQueryAsync("SELECT 1");
1223          await server.ExpectExtendedQuery();
1224          await server
1225              .WriteParseComplete()
1226              .WriteBindComplete()
1227              .WriteNoData()
1228              .WriteCommandComplete()
1229              .WriteReadyForQuery()
1230              .FlushAsync();
1231          await queryTask;
1232      }
1233      #region Logging
1234      [Test]
1235      public async Task Log_ExecuteScalar_single_statement_without_parameters()
1236      {
1237          await using var dataSource = CreateLoggingDataSource(out var listLoggerProvider);
1238          await using var conn = await dataSource.OpenConnectionAsync();
1239          await using var cmd = new NpgsqlCommand("SELECT 1", conn);
1240          using (listLoggerProvider.Record())
1241          {
1242              await cmd.ExecuteScalarAsync();
1243          }
1244          var executingCommandEvent = listLoggerProvider.Log.Single(l => l.Id == NpgsqlEventId.CommandExecutionCompleted);
1245          Assert.That(executingCommandEvent.Message, Does.Contain("Command execution completed").And.Contains("SELECT 1"));
1246          AssertLoggingStateContains(executingCommandEvent, "CommandText", "SELECT 1");
1247          AssertLoggingStateDoesNotContain(executingCommandEvent, "Parameters");
1248          if (!IsMultiplexing)
1249              AssertLoggingStateContains(executingCommandEvent, "ConnectorId", conn.ProcessID);
1250      }
1251      [Test]
1252      public async Task Log_ExecuteScalar_single_statement_with_positional_parameters()
1253      {
1254          await using var dataSource = CreateLoggingDataSource(out var listLoggerProvider);
1255          await using var conn = await dataSource.OpenConnectionAsync();
1256          await using var cmd = new NpgsqlCommand("SELECT $1, $2", conn);
1257          cmd.Parameters.Add(new() { Value = 8 });
1258          cmd.Parameters.Add(new() { NpgsqlDbType = NpgsqlDbType.Integer, Value = DBNull.Value });
1259          using (listLoggerProvider.Record())
1260          {
1261              await cmd.ExecuteScalarAsync();
1262          }
1263          var executingCommandEvent = listLoggerProvider.Log.Single(l => l.Id == NpgsqlEventId.CommandExecutionCompleted);
1264          Assert.That(executingCommandEvent.Message, Does.Contain("Command execution completed")
1265              .And.Contains("SELECT $1, $2")
1266              .And.Contains("Parameters: [8, NULL]"));
1267          AssertLoggingStateContains(executingCommandEvent, "CommandText", "SELECT $1, $2");
1268          AssertLoggingStateContains(executingCommandEvent, "Parameters", new object[] { 8, "NULL" });
1269          if (!IsMultiplexing)
1270              AssertLoggingStateContains(executingCommandEvent, "ConnectorId", conn.ProcessID);
1271      }
1272      [Test]
1273      public async Task Log_ExecuteScalar_single_statement_with_named_parameters()
1274      {
1275          await using var dataSource = CreateLoggingDataSource(out var listLoggerProvider);
1276          await using var conn = await dataSource.OpenConnectionAsync();
1277          await using var cmd = new NpgsqlCommand("SELECT @p1, @p2", conn);
1278          cmd.Parameters.Add(new() { ParameterName = "p1", Value = 8 });
1279          cmd.Parameters.Add(new() { ParameterName = "p2", NpgsqlDbType = NpgsqlDbType.Integer, Value = DBNull.Value });
1280          using (listLoggerProvider.Record())
1281          {
1282              await cmd.ExecuteScalarAsync();
1283          }
1284          var executingCommandEvent = listLoggerProvider.Log.Single(l => l.Id == NpgsqlEventId.CommandExecutionCompleted);
1285          Assert.That(executingCommandEvent.Message, Does.Contain("Command execution completed")
1286              .And.Contains("SELECT $1, $2")
1287              .And.Contains("Parameters: [8, NULL]"));
1288          AssertLoggingStateContains(executingCommandEvent, "CommandText", "SELECT $1, $2");
1289          AssertLoggingStateContains(executingCommandEvent, "Parameters", new object[] { 8, "NULL" });
1290          if (!IsMultiplexing)
1291              AssertLoggingStateContains(executingCommandEvent, "ConnectorId", conn.ProcessID);
1292      }
1293      [Test]
1294      public async Task Log_ExecuteScalar_single_statement_with_parameter_logging_off()
1295      {
1296          await using var dataSource = CreateLoggingDataSource(out var listLoggerProvider, sensitiveDataLoggingEnabled: false);
1297          await using var conn = await dataSource.OpenConnectionAsync();
1298          await using var cmd = new NpgsqlCommand("SELECT $1, $2", conn);
1299          cmd.Parameters.Add(new() { Value = 8 });
1300          cmd.Parameters.Add(new() { Value = 9 });
1301          using (listLoggerProvider.Record())
1302          {
1303              await cmd.ExecuteScalarAsync();
1304          }
1305          var executingCommandEvent = listLoggerProvider.Log.Single(l => l.Id == NpgsqlEventId.CommandExecutionCompleted);
1306          Assert.That(executingCommandEvent.Message, Does.Contain("Command execution completed").And.Contains($"SELECT $1, $2"));
1307          AssertLoggingStateContains(executingCommandEvent, "CommandText", "SELECT $1, $2");
1308          AssertLoggingStateDoesNotContain(executingCommandEvent, "Parameters");
1309      }
1310      #endregion Logging
1311      public CommandTests(MultiplexingMode multiplexingMode) : base(multiplexingMode) {}
1312  }
</code></pre>
        </div>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-BugTests.cs</h3>
            <pre><code>1  using Npgsql.BackendMessages;
2  using Npgsql.Tests.Support;
3  using Npgsql.TypeMapping;
4  using NpgsqlTypes;
5  using NUnit.Framework;
6  using System;
7  using System.Data;
8  using System.Text;
9  using System.Threading;
10  using System.Threading.Tasks;
11  using System.Transactions;
12  using static Npgsql.Tests.TestUtil;
<span onclick='openModal()' class='match'>13  namespace Npgsql.Tests;
14  public class BugTests : TestBase
15  {
16      #region Sequential reader bugs
17      [Test, Description("In sequential access, performing a null check on a non-first field would check the first field")]
</span>18      public void SequentialNullCheckOnNonFirstField()
19      {
20          using var conn = OpenConnection();
21          using var cmd = new NpgsqlCommand("SELECT 'X', NULL", conn);
22          using var dr = cmd.ExecuteReader(CommandBehavior.SequentialAccess);
23          dr.Read();
24          Assert.That(dr.IsDBNull(1), Is.True);
25      }
26      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1034")]
27      public void SequentialSkipOverFirstRow()
28      {
29          using var conn = OpenConnection();
30          using var cmd = new NpgsqlCommand("SELECT 1; SELECT 2", conn);
31          using var reader = cmd.ExecuteReader(CommandBehavior.SequentialAccess);
32          Assert.That(reader.NextResult(), Is.True);
33          Assert.That(reader.Read(), Is.True);
34          Assert.That(reader.GetInt32(0), Is.EqualTo(2));
35      }
36      [Test]
37      public void SequentialConsumeWithNull()
38      {
39          using var conn = OpenConnection();
40          using var command = new NpgsqlCommand("SELECT 1, NULL", conn);
41          using var reader = command.ExecuteReader(CommandBehavior.SequentialAccess);
42          reader.Read();
43      }
44      #endregion
45      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1210")]
46      public void Many_parameters_with_mixed_FormatCode()
47      {
48          using var conn = OpenConnection();
49          using var cmd = new NpgsqlCommand();
50          cmd.Connection = conn;
51          var sb = new StringBuilder("SELECT @text_param");
52          cmd.Parameters.AddWithValue("@text_param", "some_text");
53          for (var i = 0; i < conn.Settings.WriteBufferSize; i++)
54          {
55              var paramName = $"@binary_param{i}";
56              sb.Append(',');
57              sb.Append(paramName);
58              cmd.Parameters.AddWithValue(paramName, 8);
59          }
60          cmd.CommandText = sb.ToString();
61          var ex = Assert.Throws<PostgresException>(() => cmd.ExecuteNonQuery())!;
62          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.ProgramLimitExceeded)
63              .Or.EqualTo(PostgresErrorCodes.TooManyColumns)); 
64      }
65      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1238")]
66      public void Record_with_non_int_field()
67      {
68          using var conn = OpenConnection();
69          using var cmd = new NpgsqlCommand("SELECT ('one'::TEXT, 2)", conn);
70          using var reader = cmd.ExecuteReader();
71          reader.Read();
72          var record = reader.GetFieldValue<object[]>(0);
73          Assert.That(record[0], Is.EqualTo("one"));
74          Assert.That(record[1], Is.EqualTo(2));
75      }
76      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1450")]
77      public void Bug1450()
78      {
79          using var conn = OpenConnection();
80          using var cmd = new NpgsqlCommand();
81          cmd.Connection = conn;
82          cmd.CommandText = "CREATE TEMP TABLE a (a1 int); CREATE TEMP TABLE b (b1 int);";
83          cmd.ExecuteNonQuery();
84          cmd.CommandText = "CREATE TEMP TABLE c (c1 int);";
85          cmd.ExecuteNonQuery();
86      }
87      [Test]
88      public async Task Bug1645()
89      {
90          await using var conn = await OpenConnectionAsync();
91          var tableName = await CreateTempTable(conn, "field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER");
92          Assert.That(() =>
93              {
94                  using var writer = conn.BeginBinaryImport($"COPY {tableName} (field_text, field_int4) FROM STDIN BINARY");
95                  writer.StartRow();
96                  writer.Write("foo");
97                  writer.Write(8);
98                  writer.StartRow();
99                  throw new InvalidOperationException("Catch me outside the using statement if you can!");
100              }, Throws.Exception
101                  .TypeOf<InvalidOperationException>()
102                  .With.Property(nameof(InvalidOperationException.Message)).EqualTo("Catch me outside the using statement if you can!")
103          );
104          Assert.That(await conn.ExecuteScalarAsync($"SELECT COUNT(*) FROM {tableName}"), Is.Zero);
105      }
106      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3600")]
107      public async Task Bug3600()
108      {
109          var csb = new NpgsqlConnectionStringBuilder(ConnectionString)
110          {
111              CommandTimeout = 1,
112          };
113          await using var postmasterMock = PgPostmasterMock.Start(csb.ConnectionString);
114          await using var dataSource = CreateDataSource(postmasterMock.ConnectionString);
115          await using var conn = await dataSource.OpenConnectionAsync();
116          var serverMock = await postmasterMock.WaitForServerConnection();
117          await serverMock
118              .WriteCopyInResponse()
119              .FlushAsync();
120          var ex = Assert.ThrowsAsync<NpgsqlException>(async () =>
121          {
122              await using var importer = await conn.BeginTextImportAsync($"COPY SomeTable (field_text, field_int4) FROM STDIN");
123          });
124          Assert.That(ex!.InnerException, Is.TypeOf<TimeoutException>());
125      }
126      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1497")]
127      public async Task Bug1497()
128      {
129          await using var conn = await OpenConnectionAsync();
130          var tableName = await CreateTempTable(conn, "id INT4");
131          conn.ExecuteNonQuery($"INSERT INTO {tableName} (id) VALUES (NULL)");
132          await using var cmd = new NpgsqlCommand($"SELECT * FROM {tableName}", conn);
133          await using var reader = await cmd.ExecuteReaderAsync();
134          var dt = new DataTable();
135          dt.Load(reader);
136      }
137      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1558")]
138      public void Bug1558()
139      {
140          using var dataSource = CreateDataSource(csb =>
141          {
142              csb.Pooling = false;
143              csb.Enlist = true;
144          });
145          using var tx = new TransactionScope();
146          using var conn = dataSource.OpenConnection();
147      }
148      [Test]
149      public void Bug1695()
150      {
151          using var dataSource = CreateDataSource(csb =>
152          {
153              csb.Pooling = false;
154              csb.MaxAutoPrepare = 10;
155              csb.AutoPrepareMinUsages = 1;
156          });
157          using var conn = dataSource.OpenConnection();
158          using (var cmd = new NpgsqlCommand("SELECT 1; SELECT 2", conn))
159          using (var reader = cmd.ExecuteReader())
160          {
161              reader.Read();
162          }
163          Assert.That(conn.ExecuteScalar("SELECT 2"), Is.EqualTo(2));
164      }
165      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1700")]
166      public void Bug1700()
167      {
168          Assert.That(() =>
169          {
170              using var conn = OpenConnection();
171              using var tx = conn.BeginTransaction();
172              using var cmd = conn.CreateCommand();
173              cmd.CommandText = "SELECT 1";
174              var reader = cmd.ExecuteReader();
175              while (reader.Read())
176              {
177                  throw new InvalidOperationException("Some problem parsing the returned data");
178              }
179              tx.Commit();
180          }, Throws.InvalidOperationException.With.Message.EqualTo("Some problem parsing the returned data"));
181      }
182      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1964")]
183      public void Bug1964()
184      {
185          using var conn = OpenConnection();
186          using var cmd = new NpgsqlCommand("INVALID SQL", conn);
187          cmd.Parameters.Add(new NpgsqlParameter { ParameterName = "p", Direction = ParameterDirection.Output });
188          Assert.That(() => cmd.ExecuteNonQuery(), Throws.Exception.TypeOf<PostgresException>()
189              .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.SyntaxError));
190      }
191      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1986")]
192      public void Bug1986()
193      {
194          using var conn = OpenConnection();
195          using var cmd = new NpgsqlCommand("SELECT 'hello', 'goodbye'", conn);
196          using var reader = cmd.ExecuteReader();
197          reader.Read();
198          using (var textReader1 = reader.GetTextReader(0))
199          {
200          }
201          using (var textReader2 = reader.GetTextReader(1))
202          {
203          }
204      }
205      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1987")]
206      public async Task Bug1987()
207      {
208          await using var adminConnection = await OpenConnectionAsync();
209          var type = await GetTempTypeName(adminConnection);
210          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} AS ENUM ('sad', 'ok', 'happy')");
211          var dataSourceBuilder = CreateDataSourceBuilder();
212          dataSourceBuilder.MapEnum<Mood>(type);
213          await using var dataSource = dataSourceBuilder.Build();
214          await using var connection = await dataSource.OpenConnectionAsync();
215          for (var i = 0; i < 2; i++)
216          {
217              await using var cmd = new NpgsqlCommand("SELECT @p", connection);
218              cmd.Parameters.AddWithValue("p", Mood.Happy);
219              Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(Mood.Happy));
220          }
221      }
222      enum Mood { Sad, Ok, Happy };
223      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2003")]
224      public void Bug2003()
225      {
226          using var conn = OpenConnection();
227          var longFieldName = new string('x', conn.Settings.ReadBufferSize);
228          using var cmd = new NpgsqlCommand($"SELECT 8 AS {longFieldName}", conn);
229          using var reader = cmd.ExecuteReader(CommandBehavior.SequentialAccess);
230          reader.Read();
231          Assert.That(reader.GetInt32(0), Is.EqualTo(8));
232      }
233      [Test]
234      public async Task Bug2046()
235      {
236          var expected = 64.27245f;
237          using var conn = OpenConnection();
238          using var cmd = new NpgsqlCommand("SELECT @p = 64.27245::real, 64.27245::real, @p", conn);
239          cmd.Parameters.AddWithValue("p", expected);
240          using var rdr = await cmd.ExecuteReaderAsync();
241          rdr.Read();
242          Assert.That(rdr.GetFieldValue<bool>(0));
243          Assert.That(rdr.GetFieldValue<float>(1), Is.EqualTo(expected));
244          Assert.That(rdr.GetFieldValue<float>(2), Is.EqualTo(expected));
245      }
246      [Test]
247      public void Bug1761()
248      {
249          using var dataSource = CreateDataSource(csb =>
250          {
251              csb.Enlist = true;
252              csb.Pooling = true;
253              csb.MinPoolSize = 1;
254              csb.MaxPoolSize = 1;
255          });
256          for (var i = 0; i < 2; i++)
257          {
258              try
259              {
260                  using var scope = new TransactionScope(TransactionScopeOption.Required, TimeSpan.FromMilliseconds(100));
261                  Thread.Sleep(1000);
262                  using (var connection = dataSource.OpenConnection())
263                  using (var cmd = new NpgsqlCommand("SELECT 1", connection))
264                  {
265                      cmd.CommandText = "select 1;";
266                      cmd.ExecuteNonQuery();
267                  }
268                  scope.Complete();
269              }
270              catch (TransactionException)
271              {
272              }
273          }
274      }
275      [Test]
276      public void Bug2274()
277      {
278          using var conn = OpenConnection();
279          using var cmd = new NpgsqlCommand("SELECT 1", conn);
280          cmd.Parameters.Add(new NpgsqlParameter
281          {
282              ParameterName = "p",
283              Direction = ParameterDirection.Output
284          });
285          using var reader = cmd.ExecuteReader(CommandBehavior.SingleRow);
286          Assert.That(() => reader.GetInt32(0), Throws.Exception.TypeOf<InvalidOperationException>());
287          Assert.That(reader.Read(), Is.True);
288          Assert.That(reader.GetInt32(0), Is.EqualTo(1));
289          Assert.That(reader.Read(), Is.False);
290      }
291      [Test]
292      public async Task Bug2278()
293      {
294          await using var adminConnection = await OpenConnectionAsync();
295          var enumType = await GetTempTypeName(adminConnection);
296          var domainType = await GetTempTypeName(adminConnection);
297          var compositeType = await GetTempTypeName(adminConnection);
298          await adminConnection.ExecuteNonQueryAsync($@"
299  CREATE TYPE {enumType} AS ENUM ('left', 'right');
300  CREATE DOMAIN {domainType} AS {enumType} NOT NULL;
301  CREATE TYPE {compositeType} AS (value {domainType})");
302          var table = await CreateTempTable(adminConnection, $"value {compositeType}");
303          var dataSourceBuilder = CreateDataSourceBuilder();
304          dataSourceBuilder.MapComposite<Bug2278CompositeType>(compositeType);
305          dataSourceBuilder.MapEnum<Bug2278EnumType>(enumType);
306          await using var dataSource = dataSourceBuilder.Build();
307          await using var connection = await dataSource.OpenConnectionAsync();
308          await connection.ExecuteScalarAsync($"SELECT * FROM {table} AS d");
309      }
310      class Bug2278CompositeType
311      {
312          public Bug2278EnumType Value { get; set; }
313      }
314      enum Bug2278EnumType
315      {
316          Left,
317          Right
318      }
319      [Test]
320      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2178")]
321      public async Task Bug2178()
322      {
323          await using var dataSource = CreateDataSource(csb =>
324          {
325              csb.AutoPrepareMinUsages = 2;
326              csb.MaxAutoPrepare = 2;
327          });
328          await using var conn = await dataSource.OpenConnectionAsync();
329          await using var cmd = new NpgsqlCommand();
330          cmd.Connection = conn;
331          cmd.CommandText = "SELECT 1";
332          await cmd.ExecuteScalarAsync();
333          await cmd.ExecuteScalarAsync();
334          Assert.That(cmd.IsPrepared);
335          cmd.CommandText = "SELECT * FROM public.dummy_table_name";
336          for (var i = 0; i < 3; ++i)
337          {
338              Assert.ThrowsAsync<PostgresException>(async () => await cmd.ExecuteScalarAsync());
339          }
340          cmd.CommandText = "SELECT 1";
341          await cmd.ExecuteScalarAsync();
342          Assert.That(cmd.IsPrepared);
343      }
344      [Test]
345      public async Task Bug2296()
346      {
347          await using var conn = await OpenConnectionAsync();
348          await conn.ExecuteNonQueryAsync("DROP TYPE IF EXISTS \"boolean\" CASCADE");
349          await conn.ExecuteNonQueryAsync("CREATE DOMAIN pg_temp.\"boolean\" AS bool");
350          conn.ReloadTypes();
351          var tableName = await CreateTempTable(conn, $"mybool \"boolean\"");
352          await conn.ExecuteNonQueryAsync($"INSERT INTO {tableName} (mybool) VALUES (TRUE)");
353          await conn.ExecuteScalarAsync($"SELECT mybool FROM {tableName}");
354      }
355      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2660")]
356      public void Standard_conforming_strings()
357      {
358          using var conn = OpenConnection();
359          var sql = @"
360  SELECT table_name
361  FROM information_schema.views
362  WHERE table_name LIKE @p0 escape '\' AND (is_updatable = 'NO') = @p1";
363          using var cmd = new NpgsqlCommand(sql, conn);
364          cmd.Parameters.AddWithValue("@p0", "%trig%");
365          cmd.Parameters.AddWithValue("@p1", true);
366          using var reader = cmd.ExecuteReader();
367          reader.Read();
368      }
369      #region Bug1285
370      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1285")]
371      public void Bug1285()
372      {
373          using var conn = OpenConnection();
374          using var cmd = new NpgsqlCommand { Connection = conn };
375          cmd.CommandText = Bug1285CreateStatement;
376          cmd.ExecuteNonQuery();
377          cmd.CommandText = Bug1285SelectStatement;
378          cmd.Parameters.Add(new NpgsqlParameter("@1", Guid.NewGuid()));
379          cmd.ExecuteNonQuery();
380      }
381      const string Bug1285SelectStatement =
382          "select " +
383          " \"Afbeelding\"" +
384          ", \"Afbeelding#Id\"" +
385          ", \"Omschrijving\"" +
386          ", \"Website\"" +
387          ", \"EMailadres\"" +
388          ", \"SocialMediaVastleggen\"" +
389          ", \"Facebook\"" +
390          ", \"Linkedin\"" +
391          ", \"Twitter\"" +
392          ", \"Youtube\"" +
393          ", \"Branche\"" +
394          ", \"Branche#Id\"" +
395          ", \"Branche#ComponentId\"" +
396          ", \"Telefoonnummer\"" +
397          ", \"Overheidsidentificatienummer\"" +
398          ", \"Adres\"" +
399          ", \"Adres#Id\"" +
400          ", \"Adres#ComponentId\"" +
401          ", \"2gIKz62kaTdGxw82_OrzTc4ANSM_\"" +
402          ", \"OnderdeelVanOrganisatie\"" +
403          ", \"OnderdeelVanOrganisatie#Id\"" +
404          ", \"OnderdeelVanOrganisatie#ComponentId\"" +
405          ", \"Profit\"" +
406          ", \"Profit#Id\"" +
407          ", \"Profit#ComponentId\"" +
408          ", \"Taal\"" +
409          ", \"Taal#Id\"" +
410          ", \"Taal#ComponentId\"" +
411          ", \"KlantSinds\"" +
412          ", \"BarcodeKlant\"" +
413          ", \"BarcodeKlant#BarcodeType\"" +
414          ", \"BarcodeKlant#Value\"" +
415          ", \"Postadres\"" +
416          ", \"Postadres#Id\"" +
417          ", \"Postadres#ComponentId\"" +
418          ", \"LeverancierSinds\"" +
419          ", \"BarcodeLeverancier\"" +
420          ", \"BarcodeLeverancier#BarcodeType\"" +
421          ", \"BarcodeLeverancier#Value\"" +
422          ", \"Zoeknaam\"" +
423          ", \"TitelEnAanhef\"" +
424          ", \"TitelEnAanhef#Id\"" +
425          ", \"TitelEnAanhef#ComponentId\"" +
426          ", \"Rechtsvorm\"" +
427          ", \"Rechtsvorm#Id\"" +
428          ", \"Rechtsvorm#ComponentId\"" +
429          ", \"LandVanVestiging\"" +
430          ", \"LandVanVestiging#Id\"" +
431          ", \"LandVanVestiging#ComponentId\"" +
432          ", \"AantalMedewerkers\"" +
433          ", \"NaamStatutair\"" +
434          ", \"VestigingStatutair\"" +
435          ", \"Correspondentie\"" +
436          ", \"Medium\"" +
437          ", \"FiscaalNummer\"" +
438          ", \"AangebrachtDoor\"" +
439          ", \"AangebrachtDoor#Id\"" +
440          ", \"AangebrachtDoor#ComponentId\"" +
441          ", \"Status\"" +
442          ", \"NummerKamerVanKoophandel\"" +
443          ", \"zII9SOHbwUPS_jKSlcRrQzuEr6A_\"" +
444          ", \"Code\"" +
445          ", \"OrganisatorischeEenheid\"" +
446          ", \"OrganisatorischeEenheid#Id\"" +
447          ", \"OrganisatorischeEenheid#ComponentId\"" +
448          ", \"PJlr3asVdeHVoqmAyHIF2fF1gVM_\"" +
449          ", \"IsUwv\"" +
450          ", \"Uwv\"" +
451          ", \"Uwv#Id\"" +
452          ", \"Uwv#ComponentId\"" +
453          ", \"IsVerzekeraarVoorWerkgever\"" +
454          ", \"VerzekeraarVoorWerkgever\"" +
455          ", \"VerzekeraarVoorWerkgever#Id\"" +
456          ", \"VerzekeraarVoorWerkgever#ComponentId\"" +
457          ", \"IsAbonnementsadministratie\"" +
458          ", \"Abonnementsadministratie\"" +
459          ", \"Abonnementsadministratie#Id\"" +
460          ", \"Abonnementsadministratie#ComponentId\"" +
461          ", \"IsPensioenfonds\"" +
462          ", \"Pensioenfonds\"" +
463          ", \"Pensioenfonds#Id\"" +
464          ", \"Pensioenfonds#ComponentId\"" +
465          ", \"IsProfit\"" +
466          ", \"Profit1\"" +
467          ", \"Profit1#Id\"" +
468          ", \"Profit1#ComponentId\"" +
469          ", \"Verantwoordelijke\"" +
470          ", \"Verantwoordelijke#Id\"" +
471          ", \"Verantwoordelijke#ComponentId\"" +
472          ", \"IsKlant\"" +
473          ", \"Klant\"" +
474          ", \"Klant#Id\"" +
475          ", \"Klant#ComponentId\"" +
476          ", \"IsFactureringsadministratie\"" +
477          ", \"Factureringsadministratie\"" +
478          ", \"Factureringsadministratie#Id\"" +
479          ", \"Factureringsadministratie#ComponentId\"" +
480          ", \"IsLeninggever\"" +
481          ", \"Leninggever\"" +
482          ", \"Leninggever#Id\"" +
483          ", \"Leninggever#ComponentId\"" +
484          ", \"IsProjectadministratie\"" +
485          ", \"Projectadministratie\"" +
486          ", \"Projectadministratie#Id\"" +
487          ", \"Projectadministratie#ComponentId\"" +
488          ", \"IsVervangingsfonds\"" +
489          ", \"Vervangingsfonds\"" +
490          ", \"Vervangingsfonds#Id\"" +
491          ", \"Vervangingsfonds#ComponentId\"" +
492          ", \"IsPensioen\"" +
493          ", \"Pensioen\"" +
494          ", \"Pensioen#Id\"" +
495          ", \"Pensioen#ComponentId\"" +
496          ", \"IsVasteActivaAdministratie\"" +
497          ", \"VasteActivaAdministratie\"" +
498          ", \"VasteActivaAdministratie#Id\"" +
499          ", \"VasteActivaAdministratie#ComponentId\"" +
500          ", \"IsBelastingdienst\"" +
501          ", \"Belastingdienst\"" +
502          ", \"Belastingdienst#Id\"" +
503          ", \"Belastingdienst#ComponentId\"" +
504          ", \"IsCursusadministratie\"" +
505          ", \"Cursusadministratie\"" +
506          ", \"Cursusadministratie#Id\"" +
507          ", \"Cursusadministratie#ComponentId\"" +
508          ", \"IsUitvoerderVervangingsfonds\"" +
509          ", \"UitvoerderVervangingsfonds\"" +
510          ", \"UitvoerderVervangingsfonds#Id\"" +
511          ", \"UitvoerderVervangingsfonds#ComponentId\"" +
512          ", \"IsAssemblageadministratie\"" +
513          ", \"Assemblageadministratie\"" +
514          ", \"Assemblageadministratie#Id\"" +
515          ", \"Assemblageadministratie#ComponentId\"" +
516          ", \"IsLeasemaatschappij\"" +
517          ", \"Leasemaatschappij\"" +
518          ", \"Leasemaatschappij#Id\"" +
519          ", \"Leasemaatschappij#ComponentId\"" +
520          ", \"IsBeslaglegger\"" +
521          ", \"Beslaglegger\"" +
522          ", \"Beslaglegger#Id\"" +
523          ", \"Beslaglegger#ComponentId\"" +
524          ", \"IsVerzekeraarVoorMedewerker\"" +
525          ", \"VerzekeraarVoorMedewerker\"" +
526          ", \"VerzekeraarVoorMedewerker#Id\"" +
527          ", \"VerzekeraarVoorMedewerker#ComponentId\"" +
528          ", \"IsWoningverhuur\"" +
529          ", \"Woningverhuur\"" +
530          ", \"Woningverhuur#Id\"" +
531          ", \"Woningverhuur#ComponentId\"" +
532          ", \"9cSTu7fkjOZm08FFQUHvclQHSWY_\"" +
533          ", \"Goederenstroomadministratie\"" +
534          ", \"Goederenstroomadministratie#Id\"" +
535          ", \"Goederenstroomadministratie#ComponentId\"" +
536          ", \"IsConcurrent\"" +
537          ", \"Concurrent\"" +
538          ", \"Concurrent#Id\"" +
539          ", \"Concurrent#ComponentId\"" +
540          ", \"IsArbodienst\"" +
541          ", \"Arbodienst\"" +
542          ", \"Arbodienst#Id\"" +
543          ", \"Arbodienst#ComponentId\"" +
544          ", \"IsUitvoerderSociaalFonds\"" +
545          ", \"UitvoerderSociaalFonds\"" +
546          ", \"UitvoerderSociaalFonds#Id\"" +
547          ", \"UitvoerderSociaalFonds#ComponentId\"" +
548          ", \"IsPensioenuitvoerder\"" +
549          ", \"Pensioenuitvoerder\"" +
550          ", \"Pensioenuitvoerder#Id\"" +
551          ", \"Pensioenuitvoerder#ComponentId\"" +
552          ", \"IsProspect\"" +
553          ", \"Prospect\"" +
554          ", \"Prospect#Id\"" +
555          ", \"Prospect#ComponentId\"" +
556          ", \"IsProspectadministratie\"" +
557          ", \"Prospectadministratie\"" +
558          ", \"Prospectadministratie#Id\"" +
559          ", \"Prospectadministratie#ComponentId\"" +
560          ", \"IsArtikelbeheeradministratie\"" +
561          ", \"Artikelbeheeradministratie\"" +
562          ", \"Artikelbeheeradministratie#Id\"" +
563          ", \"Artikelbeheeradministratie#ComponentId\"" +
564          ", \"v1J4Rq2eNZy9GBvGhuCBKqga0Rg_\"" +
565          ", \"g4i3gYZGL0yu0T6UwmiZTaUDI8Y_\"" +
566          ", \"g4i3gYZGL0yu0T6UwmiZTaUDI8Y_#Id\"" +
567          ", \"g4i3gYZGL0yu0T6UwmiZTaUDI8Y_#ComponentId\"" +
568          ", \"IsSociaalFonds\"" +
569          ", \"SociaalFonds\"" +
570          ", \"SociaalFonds#Id\"" +
571          ", \"SociaalFonds#ComponentId\"" +
572          ", \"IsWagenparkadministratie\"" +
573          ", \"Wagenparkadministratie\"" +
574          ", \"Wagenparkadministratie#Id\"" +
575          ", \"Wagenparkadministratie#ComponentId\"" +
576          ", \"IsLeverancier\"" +
577          ", \"Leverancier\"" +
578          ", \"Leverancier#Id\"" +
579          ", \"Leverancier#ComponentId\"" +
580          ", \"IsWagenparkAfnemer\"" +
581          ", \"WagenparkAfnemer\"" +
582          ", \"WagenparkAfnemer#Id\"" +
583          ", \"WagenparkAfnemer#ComponentId\"" +
584          ", \"IsEvenementadministratie\"" +
585          ", \"Evenementadministratie\"" +
586          ", \"Evenementadministratie#Id\"" +
587          ", \"Evenementadministratie#ComponentId\"" +
588          ", \"IsCrediteur\"" +
589          ", \"Crediteur\"" +
590          ", \"Crediteur#Id\"" +
591          ", \"Crediteur#ComponentId\"" +
592          ", \"IsFinancieleAdministratie\"" +
593          ", \"FinancieleAdministratie\"" +
594          ", \"FinancieleAdministratie#Id\"" +
595          ", \"FinancieleAdministratie#ComponentId\"" +
596          ", \"IsSociaalSecretariaat\"" +
597          ", \"SociaalSecretariaat\"" +
598          ", \"SociaalSecretariaat#Id\"" +
599          ", \"SociaalSecretariaat#ComponentId\"" +
600          ", \"IsBank\"" +
601          ", \"Bank\"" +
602          ", \"Bank#Id\"" +
603          ", \"Bank#ComponentId\"" +
604          ", \"IsWerkgever\"" +
605          ", \"Werkgever\"" +
606          ", \"Werkgever#Id\"" +
607          ", \"Werkgever#ComponentId\"" +
608          ", \"IsVerkoopadministratie\"" +
609          ", \"Verkoopadministratie\"" +
610          ", \"Verkoopadministratie#Id\"" +
611          ", \"Verkoopadministratie#ComponentId\"" +
612          ", \"IsInkoopadministratie\"" +
613          ", \"Inkoopadministratie\"" +
614          ", \"Inkoopadministratie#Id\"" +
615          ", \"Inkoopadministratie#ComponentId\"" +
616          ", \"IsSubsidient\"" +
617          ", \"Subsidient\"" +
618          ", \"Subsidient#Id\"" +
619          ", \"Subsidient#ComponentId\"" +
620          ", \"IsEnqueteadministratie\"" +
621          ", \"Enqueteadministratie\"" +
622          ", \"Enqueteadministratie#Id\"" +
623          ", \"Enqueteadministratie#ComponentId\"" +
624          ", \"XWiQaVjEbD041r7QN0kj2aKeCys_\"" +
625          ", \"X_TVE5FRBaQ97JJQbT7LmX4HBVY_\"" +
626          ", \"BrancheDescription\"" +
627          ", \"AdresDescription\"" +
628          ", \"PicMWY7oCqeiZMTdDqwFqi1U508_\"" +
629          ", \"ProfitDescription\"" +
630          ", \"TaalDescription\"" +
631          ", \"PostadresDescription\"" +
632          ", \"TitelEnAanhefDescription\"" +
633          ", \"RechtsvormDescription\"" +
634          ", \"LandVanVestigingDescription\"" +
635          ", \"AangebrachtDoorDescription\"" +
636          ", \"KFEDo6ZYK_ffNCeHuujBCshlPVs_\"" +
637          ", \"VerantwoordelijkeDescription\"" +
638          ", \"FunctionalState\"" +
639          ", \"KlantFinancieleAdministratie\"" +
640          ", \"KlantFinancieleAdministratie#Id\"" +
641          ", \"KlantFinancieleAdministratie#ComponentId\"" +
642          ", \"KlantVerkoopadministratie\"" +
643          ", \"KlantVerkoopadministratie#Id\"" +
644          ", \"KlantVerkoopadministratie#ComponentId\"" +
645          ", \"NQwaM_lfzxIm_JPrPhwruL0YOXY_\"" +
646          ", \"NQwaM_lfzxIm_JPrPhwruL0YOXY_#Id\"" +
647          ", \"NQwaM_lfzxIm_JPrPhwruL0YOXY_#ComponentId\"" +
648          ", \"uSf1yseW4YQ1K6EoHNlzCxPofm0_\"" +
649          ", \"uSf1yseW4YQ1K6EoHNlzCxPofm0_#Id\"" +
650          ", \"uSf1yseW4YQ1K6EoHNlzCxPofm0_#ComponentId\"" +
651          ", \"KlantEvenementadministratie\"" +
652          ", \"KlantEvenementadministratie#Id\"" +
653          ", \"KlantEvenementadministratie#ComponentId\"" +
654          ", \"KlantCursusadministratie\"" +
655          ", \"KlantCursusadministratie#Id\"" +
656          ", \"KlantCursusadministratie#ComponentId\"" +
657          ", \"KlantProspectadministratie\"" +
658          ", \"KlantProspectadministratie#Id\"" +
659          ", \"KlantProspectadministratie#ComponentId\"" +
660          ", \"KlantInkoopadministratie\"" +
661          ", \"KlantInkoopadministratie#Id\"" +
662          ", \"KlantInkoopadministratie#ComponentId\"" +
663          ", \"KlantProjectadministratie\"" +
664          ", \"KlantProjectadministratie#Id\"" +
665          ", \"KlantProjectadministratie#ComponentId\"" +
666          ", \"P0gBTGcrSbl2kK8BM4_24fIeMvk_\"" +
667          ", \"P0gBTGcrSbl2kK8BM4_24fIeMvk_#Id\"" +
668          ", \"P0gBTGcrSbl2kK8BM4_24fIeMvk_#ComponentId\"" +
669          ", \"KlantMain\"" +
670          ", \"KlantMain#Id\"" +
671          ", \"KlantMain#ComponentId\"" +
672          ", \"8awXARDcCdVtrvN6IRlwAk5UcrI_\"" +
673          ", \"8awXARDcCdVtrvN6IRlwAk5UcrI_#Id\"" +
674          ", \"8awXARDcCdVtrvN6IRlwAk5UcrI_#ComponentId\"" +
675          ", \"MjgFAhRfH64O3M9Ts_5b0ENQDBE_\"" +
676          ", \"MjgFAhRfH64O3M9Ts_5b0ENQDBE_#Id\"" +
677          ", \"MjgFAhRfH64O3M9Ts_5b0ENQDBE_#ComponentId\"" +
678          ", \"LeverancierMain\"" +
679          ", \"LeverancierMain#Id\"" +
680          ", \"LeverancierMain#ComponentId\"" +
681          ", \"2CaNQvGgtPNHP2XCsoKBQEpwmYA_\"" +
682          ", \"2CaNQvGgtPNHP2XCsoKBQEpwmYA_#Id\"" +
683          ", \"2CaNQvGgtPNHP2XCsoKBQEpwmYA_#ComponentId\"" +
684          ", \"kleo39GG1utTUtP0F15mWkXZBFQ_\"" +
685          ", \"kleo39GG1utTUtP0F15mWkXZBFQ_#Id\"" +
686          ", \"kleo39GG1utTUtP0F15mWkXZBFQ_#ComponentId\"" +
687          ", \"d9jEYARbghWBrZU6jKbtZPyZUAk_\"" +
688          ", \"d9jEYARbghWBrZU6jKbtZPyZUAk_#Id\"" +
689          ", \"d9jEYARbghWBrZU6jKbtZPyZUAk_#ComponentId\"" +
690          ", \"CrediteurMain\"" +
691          ", \"CrediteurMain#Id\"" +
692          ", \"CrediteurMain#ComponentId\"" +
693          ", \"TTStart\"" +
694          ", \"TTEnd\"" +
695          ", \"InstanceId\"" +
696          ", \"StartDate\"" +
697          ", \"EndDate\"" +
698          ", \"UserId\"" +
699          ", \"Id\"" +
700          " from \"OrganisatieQmo_Organisatie_QueryModelObjects_Imp\" WHERE (\"InstanceId\" = @1) AND ((\"StartDate\" IS NULL) AND (\"TTEnd\" IS NULL)) ORDER BY \"Id\" ASC NULLS FIRST OFFSET 0 ROWS FETCH NEXT 2 ROWS ONLY;";
701      const string Bug1285CreateStatement = @"
702  CREATE TEMP TABLE ""OrganisatieQmo_Organisatie_QueryModelObjects_Imp""
703  (
704    ""Id"" uuid NOT NULL,
705    ""InstanceId"" uuid,
706    ""UserId"" text,
707    ""StartDate"" timestamp(3) without time zone,
708    ""EndDate"" timestamp(3) without time zone,
709    ""TTStart"" timestamp(3) without time zone,
710    ""TTEnd"" timestamp(3) without time zone,
711    ""Afbeelding#Id"" uuid,
712    ""Afbeelding"" boolean,
713    ""Omschrijving"" character varying(250),
714    ""Website"" text,
715    ""EMailadres"" character varying(255),
716    ""SocialMediaVastleggen"" boolean,
717    ""Facebook"" text,
718    ""Linkedin"" text,
719    ""Twitter"" text,
720    ""Youtube"" text,
721    ""Branche#Id"" uuid,
722    ""Branche#ComponentId"" uuid,
723    ""Branche"" boolean,
724    ""Telefoonnummer"" character varying(18),
725    ""Overheidsidentificatienummer"" character varying(40),
726    ""Adres#Id"" uuid,
727    ""Adres#ComponentId"" uuid,
728    ""Adres"" boolean,
729    ""2gIKz62kaTdGxw82_OrzTc4ANSM_"" boolean,
730    ""OnderdeelVanOrganisatie#Id"" uuid,
731    ""OnderdeelVanOrganisatie#ComponentId"" uuid,
732    ""OnderdeelVanOrganisatie"" boolean,
733    ""Profit#Id"" uuid,
734    ""Profit#ComponentId"" uuid,
735    ""Profit"" boolean,
736    ""Taal#Id"" uuid,
737    ""Taal#ComponentId"" uuid,
738    ""Taal"" boolean,
739    ""KlantSinds"" timestamp(3) without time zone,
740    ""BarcodeKlant#BarcodeType"" uuid,
741    ""BarcodeKlant#Value"" text,
742    ""BarcodeKlant"" boolean,
743    ""Postadres#Id"" uuid,
744    ""Postadres#ComponentId"" uuid,
745    ""Postadres"" boolean,
746    ""LeverancierSinds"" timestamp(3) without time zone,
747    ""BarcodeLeverancier#BarcodeType"" uuid,
748    ""BarcodeLeverancier#Value"" text,
749    ""BarcodeLeverancier"" boolean,
750    ""Zoeknaam"" character varying(255),
751    ""TitelEnAanhef#Id"" uuid,
752    ""TitelEnAanhef#ComponentId"" uuid,
753    ""TitelEnAanhef"" boolean,
754    ""Rechtsvorm#Id"" uuid,
755    ""Rechtsvorm#ComponentId"" uuid,
756    ""Rechtsvorm"" boolean,
757    ""LandVanVestiging#Id"" uuid,
758    ""LandVanVestiging#ComponentId"" uuid,
759    ""LandVanVestiging"" boolean,
760    ""AantalMedewerkers"" character varying(50),
761    ""NaamStatutair"" character varying(255),
762    ""VestigingStatutair"" character varying(255),
763    ""Correspondentie"" boolean,
764    ""Medium"" character varying(255),
765    ""FiscaalNummer"" character varying(9),
766    ""AangebrachtDoor#Id"" uuid,
767    ""AangebrachtDoor#ComponentId"" uuid,
768    ""AangebrachtDoor"" boolean,
769    ""Status"" character varying(255),
770    ""NummerKamerVanKoophandel"" character varying(30),
771    ""zII9SOHbwUPS_jKSlcRrQzuEr6A_"" timestamp(3) without time zone,
772    ""Code"" character varying(255),
773    ""OrganisatorischeEenheid#Id"" uuid,
774    ""OrganisatorischeEenheid#ComponentId"" uuid,
775    ""OrganisatorischeEenheid"" boolean,
776    ""PJlr3asVdeHVoqmAyHIF2fF1gVM_"" uuid,
777    ""IsUwv"" boolean,
778    ""Uwv#Id"" uuid,
779    ""Uwv#ComponentId"" uuid,
780    ""Uwv"" boolean,
781    ""IsVerzekeraarVoorWerkgever"" boolean,
782    ""VerzekeraarVoorWerkgever#Id"" uuid,
783    ""VerzekeraarVoorWerkgever#ComponentId"" uuid,
784    ""VerzekeraarVoorWerkgever"" boolean,
785    ""IsAbonnementsadministratie"" boolean,
786    ""Abonnementsadministratie#Id"" uuid,
787    ""Abonnementsadministratie#ComponentId"" uuid,
788    ""Abonnementsadministratie"" boolean,
789    ""IsPensioenfonds"" boolean,
790    ""Pensioenfonds#Id"" uuid,
791    ""Pensioenfonds#ComponentId"" uuid,
792    ""Pensioenfonds"" boolean,
793    ""IsProfit"" boolean,
794    ""Profit1#Id"" uuid,
795    ""Profit1#ComponentId"" uuid,
796    ""Profit1"" boolean,
797    ""Verantwoordelijke#Id"" uuid,
798    ""Verantwoordelijke#ComponentId"" uuid,
799    ""Verantwoordelijke"" boolean,
800    ""IsKlant"" boolean,
801    ""Klant#Id"" uuid,
802    ""Klant#ComponentId"" uuid,
803    ""Klant"" boolean,
804    ""IsFactureringsadministratie"" boolean,
805    ""Factureringsadministratie#Id"" uuid,
806    ""Factureringsadministratie#ComponentId"" uuid,
807    ""Factureringsadministratie"" boolean,
808    ""IsLeninggever"" boolean,
809    ""Leninggever#Id"" uuid,
810    ""Leninggever#ComponentId"" uuid,
811    ""Leninggever"" boolean,
812    ""IsProjectadministratie"" boolean,
813    ""Projectadministratie#Id"" uuid,
814    ""Projectadministratie#ComponentId"" uuid,
815    ""Projectadministratie"" boolean,
816    ""IsVervangingsfonds"" boolean,
817    ""Vervangingsfonds#Id"" uuid,
818    ""Vervangingsfonds#ComponentId"" uuid,
819    ""Vervangingsfonds"" boolean,
820    ""IsPensioen"" boolean,
821    ""Pensioen#Id"" uuid,
822    ""Pensioen#ComponentId"" uuid,
823    ""Pensioen"" boolean,
824    ""IsVasteActivaAdministratie"" boolean,
825    ""VasteActivaAdministratie#Id"" uuid,
826    ""VasteActivaAdministratie#ComponentId"" uuid,
827    ""VasteActivaAdministratie"" boolean,
828    ""IsBelastingdienst"" boolean,
829    ""Belastingdienst#Id"" uuid,
830    ""Belastingdienst#ComponentId"" uuid,
831    ""Belastingdienst"" boolean,
832    ""IsCursusadministratie"" boolean,
833    ""Cursusadministratie#Id"" uuid,
834    ""Cursusadministratie#ComponentId"" uuid,
835    ""Cursusadministratie"" boolean,
836    ""IsUitvoerderVervangingsfonds"" boolean,
837    ""UitvoerderVervangingsfonds#Id"" uuid,
838    ""UitvoerderVervangingsfonds#ComponentId"" uuid,
839    ""UitvoerderVervangingsfonds"" boolean,
840    ""IsAssemblageadministratie"" boolean,
841    ""Assemblageadministratie#Id"" uuid,
842    ""Assemblageadministratie#ComponentId"" uuid,
843    ""Assemblageadministratie"" boolean,
844    ""IsLeasemaatschappij"" boolean,
845    ""Leasemaatschappij#Id"" uuid,
846    ""Leasemaatschappij#ComponentId"" uuid,
847    ""Leasemaatschappij"" boolean,
848    ""IsBeslaglegger"" boolean,
849    ""Beslaglegger#Id"" uuid,
850    ""Beslaglegger#ComponentId"" uuid,
851    ""Beslaglegger"" boolean,
852    ""IsVerzekeraarVoorMedewerker"" boolean,
853    ""VerzekeraarVoorMedewerker#Id"" uuid,
854    ""VerzekeraarVoorMedewerker#ComponentId"" uuid,
855    ""VerzekeraarVoorMedewerker"" boolean,
856    ""IsWoningverhuur"" boolean,
857    ""Woningverhuur#Id"" uuid,
858    ""Woningverhuur#ComponentId"" uuid,
859    ""Woningverhuur"" boolean,
860    ""9cSTu7fkjOZm08FFQUHvclQHSWY_"" boolean,
861    ""Goederenstroomadministratie#Id"" uuid,
862    ""Goederenstroomadministratie#ComponentId"" uuid,
863    ""Goederenstroomadministratie"" boolean,
864    ""IsConcurrent"" boolean,
865    ""Concurrent#Id"" uuid,
866    ""Concurrent#ComponentId"" uuid,
867    ""Concurrent"" boolean,
868    ""IsArbodienst"" boolean,
869    ""Arbodienst#Id"" uuid,
870    ""Arbodienst#ComponentId"" uuid,
871    ""Arbodienst"" boolean,
872    ""IsUitvoerderSociaalFonds"" boolean,
873    ""UitvoerderSociaalFonds#Id"" uuid,
874    ""UitvoerderSociaalFonds#ComponentId"" uuid,
875    ""UitvoerderSociaalFonds"" boolean,
876    ""IsPensioenuitvoerder"" boolean,
877    ""Pensioenuitvoerder#Id"" uuid,
878    ""Pensioenuitvoerder#ComponentId"" uuid,
879    ""Pensioenuitvoerder"" boolean,
880    ""IsProspect"" boolean,
881    ""Prospect#Id"" uuid,
882    ""Prospect#ComponentId"" uuid,
883    ""Prospect"" boolean,
884    ""IsProspectadministratie"" boolean,
885    ""Prospectadministratie#Id"" uuid,
886    ""Prospectadministratie#ComponentId"" uuid,
887    ""Prospectadministratie"" boolean,
888    ""IsArtikelbeheeradministratie"" boolean,
889    ""Artikelbeheeradministratie#Id"" uuid,
890    ""Artikelbeheeradministratie#ComponentId"" uuid,
891    ""Artikelbeheeradministratie"" boolean,
892    ""v1J4Rq2eNZy9GBvGhuCBKqga0Rg_"" boolean,
893    ""g4i3gYZGL0yu0T6UwmiZTaUDI8Y_#Id"" uuid,
894    ""g4i3gYZGL0yu0T6UwmiZTaUDI8Y_#ComponentId"" uuid,
895    ""g4i3gYZGL0yu0T6UwmiZTaUDI8Y_"" boolean,
896    ""IsSociaalFonds"" boolean,
897    ""SociaalFonds#Id"" uuid,
898    ""SociaalFonds#ComponentId"" uuid,
899    ""SociaalFonds"" boolean,
900    ""IsWagenparkadministratie"" boolean,
901    ""Wagenparkadministratie#Id"" uuid,
902    ""Wagenparkadministratie#ComponentId"" uuid,
903    ""Wagenparkadministratie"" boolean,
904    ""IsLeverancier"" boolean,
905    ""Leverancier#Id"" uuid,
906    ""Leverancier#ComponentId"" uuid,
907    ""Leverancier"" boolean,
908    ""IsWagenparkAfnemer"" boolean,
909    ""WagenparkAfnemer#Id"" uuid,
910    ""WagenparkAfnemer#ComponentId"" uuid,
911    ""WagenparkAfnemer"" boolean,
912    ""IsEvenementadministratie"" boolean,
913    ""Evenementadministratie#Id"" uuid,
914    ""Evenementadministratie#ComponentId"" uuid,
915    ""Evenementadministratie"" boolean,
916    ""IsCrediteur"" boolean,
917    ""Crediteur#Id"" uuid,
918    ""Crediteur#ComponentId"" uuid,
919    ""Crediteur"" boolean,
920    ""IsFinancieleAdministratie"" boolean,
921    ""FinancieleAdministratie#Id"" uuid,
922    ""FinancieleAdministratie#ComponentId"" uuid,
923    ""FinancieleAdministratie"" boolean,
924    ""IsSociaalSecretariaat"" boolean,
925    ""SociaalSecretariaat#Id"" uuid,
926    ""SociaalSecretariaat#ComponentId"" uuid,
927    ""SociaalSecretariaat"" boolean,
928    ""IsBank"" boolean,
929    ""Bank#Id"" uuid,
930    ""Bank#ComponentId"" uuid,
931    ""Bank"" boolean,
932    ""IsWerkgever"" boolean,
933    ""Werkgever#Id"" uuid,
934    ""Werkgever#ComponentId"" uuid,
935    ""Werkgever"" boolean,
936    ""IsVerkoopadministratie"" boolean,
937    ""Verkoopadministratie#Id"" uuid,
938    ""Verkoopadministratie#ComponentId"" uuid,
939    ""Verkoopadministratie"" boolean,
940    ""IsInkoopadministratie"" boolean,
941    ""Inkoopadministratie#Id"" uuid,
942    ""Inkoopadministratie#ComponentId"" uuid,
943    ""Inkoopadministratie"" boolean,
944    ""IsSubsidient"" boolean,
945    ""Subsidient#Id"" uuid,
946    ""Subsidient#ComponentId"" uuid,
947    ""Subsidient"" boolean,
948    ""IsEnqueteadministratie"" boolean,
949    ""Enqueteadministratie#Id"" uuid,
950    ""Enqueteadministratie#ComponentId"" uuid,
951    ""Enqueteadministratie"" boolean,
952    ""XWiQaVjEbD041r7QN0kj2aKeCys_"" boolean,
953    ""X_TVE5FRBaQ97JJQbT7LmX4HBVY_"" boolean,
954    ""BrancheDescription"" character varying(250),
955    ""AdresDescription"" character varying(250),
956    ""PicMWY7oCqeiZMTdDqwFqi1U508_"" character varying(250),
957    ""ProfitDescription"" character varying(100),
958    ""TaalDescription"" character varying(250),
959    ""PostadresDescription"" character varying(250),
960    ""TitelEnAanhefDescription"" character varying(250),
961    ""RechtsvormDescription"" character varying(250),
962    ""LandVanVestigingDescription"" character varying(250),
963    ""AangebrachtDoorDescription"" character varying(250),
964    ""KFEDo6ZYK_ffNCeHuujBCshlPVs_"" character varying(250),
965    ""VerantwoordelijkeDescription"" character varying(250),
966    ""FunctionalState"" integer,
967    ""KlantFinancieleAdministratie#Id"" uuid,
968    ""KlantFinancieleAdministratie#ComponentId"" uuid,
969    ""KlantFinancieleAdministratie"" boolean,
970    ""KlantVerkoopadministratie#Id"" uuid,
971    ""KlantVerkoopadministratie#ComponentId"" uuid,
972    ""KlantVerkoopadministratie"" boolean,
973    ""NQwaM_lfzxIm_JPrPhwruL0YOXY_#Id"" uuid,
974    ""NQwaM_lfzxIm_JPrPhwruL0YOXY_#ComponentId"" uuid,
975    ""NQwaM_lfzxIm_JPrPhwruL0YOXY_"" boolean,
976    ""uSf1yseW4YQ1K6EoHNlzCxPofm0_#Id"" uuid,
977    ""uSf1yseW4YQ1K6EoHNlzCxPofm0_#ComponentId"" uuid,
978    ""uSf1yseW4YQ1K6EoHNlzCxPofm0_"" boolean,
979    ""KlantEvenementadministratie#Id"" uuid,
980    ""KlantEvenementadministratie#ComponentId"" uuid,
981    ""KlantEvenementadministratie"" boolean,
982    ""KlantCursusadministratie#Id"" uuid,
983    ""KlantCursusadministratie#ComponentId"" uuid,
984    ""KlantCursusadministratie"" boolean,
985    ""KlantProspectadministratie#Id"" uuid,
986    ""KlantProspectadministratie#ComponentId"" uuid,
987    ""KlantProspectadministratie"" boolean,
988    ""KlantInkoopadministratie#Id"" uuid,
989    ""KlantInkoopadministratie#ComponentId"" uuid,
990    ""KlantInkoopadministratie"" boolean,
991    ""KlantProjectadministratie#Id"" uuid,
992    ""KlantProjectadministratie#ComponentId"" uuid,
993    ""KlantProjectadministratie"" boolean,
994    ""P0gBTGcrSbl2kK8BM4_24fIeMvk_#Id"" uuid,
995    ""P0gBTGcrSbl2kK8BM4_24fIeMvk_#ComponentId"" uuid,
996    ""P0gBTGcrSbl2kK8BM4_24fIeMvk_"" boolean,
997    ""KlantMain#Id"" uuid,
998    ""KlantMain#ComponentId"" uuid,
999    ""KlantMain"" boolean,
1000    ""8awXARDcCdVtrvN6IRlwAk5UcrI_#Id"" uuid,
1001    ""8awXARDcCdVtrvN6IRlwAk5UcrI_#ComponentId"" uuid,
1002    ""8awXARDcCdVtrvN6IRlwAk5UcrI_"" boolean,
1003    ""MjgFAhRfH64O3M9Ts_5b0ENQDBE_#Id"" uuid,
1004    ""MjgFAhRfH64O3M9Ts_5b0ENQDBE_#ComponentId"" uuid,
1005    ""MjgFAhRfH64O3M9Ts_5b0ENQDBE_"" boolean,
1006    ""LeverancierMain#Id"" uuid,
1007    ""LeverancierMain#ComponentId"" uuid,
1008    ""LeverancierMain"" boolean,
1009    ""2CaNQvGgtPNHP2XCsoKBQEpwmYA_#Id"" uuid,
1010    ""2CaNQvGgtPNHP2XCsoKBQEpwmYA_#ComponentId"" uuid,
1011    ""2CaNQvGgtPNHP2XCsoKBQEpwmYA_"" boolean,
1012    ""kleo39GG1utTUtP0F15mWkXZBFQ_#Id"" uuid,
1013    ""kleo39GG1utTUtP0F15mWkXZBFQ_#ComponentId"" uuid,
1014    ""kleo39GG1utTUtP0F15mWkXZBFQ_"" boolean,
1015    ""d9jEYARbghWBrZU6jKbtZPyZUAk_#Id"" uuid,
1016    ""d9jEYARbghWBrZU6jKbtZPyZUAk_#ComponentId"" uuid,
1017    ""d9jEYARbghWBrZU6jKbtZPyZUAk_"" boolean,
1018    ""CrediteurMain#Id"" uuid,
1019    ""CrediteurMain#ComponentId"" uuid,
1020    ""CrediteurMain"" boolean,
1021    CONSTRAINT ""pk_OrganisatieQmo_Organisatie_QueryModelObjects_Imp"" PRIMARY KEY (""Id"")
1022  )";
1023      #endregion Bug1285
1024      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2849")]
1025      public async Task Chunked_string_write_buffer_encoding_space()
1026      {
1027          await using var dataSource = CreateDataSource(csb => csb.WriteBufferSize = 8192);
1028          await using var conn = await dataSource.OpenConnectionAsync();
1029          var tableName = await CreateTempTable(conn, "col1 text, col2 text");
1030          await using var binaryImporter = await conn.BeginBinaryImportAsync($"COPY {tableName} FROM STDIN (FORMAT BINARY);");
1031          await binaryImporter.StartRowAsync();
1032          var almostBufferFillingString = new string('a', 8152);
1033          await binaryImporter.WriteAsync(almostBufferFillingString, NpgsqlDbType.Text);
1034          var unicodeCharacterThatEncodesToThreeBytesInUtf8 = '\uD55C';
1035          var longStringStartingWithAforementionedUnicodeCharacter = unicodeCharacterThatEncodesToThreeBytesInUtf8 + new string('a', 10000);
1036          await binaryImporter.WriteAsync(longStringStartingWithAforementionedUnicodeCharacter, NpgsqlDbType.Text);
1037          await binaryImporter.CompleteAsync();
1038      }
1039      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2849")]
1040      public async Task Chunked_char_array_write_buffer_encoding_space()
1041      {
1042          await using var dataSource = CreateDataSource(csb => csb.WriteBufferSize = 8192);
1043          await using var conn = await dataSource.OpenConnectionAsync();
1044          var tableName = await CreateTempTable(conn, "col1 text, col2 text");
1045          await using var binaryImporter = await conn.BeginBinaryImportAsync($"COPY {tableName} FROM STDIN (FORMAT BINARY);");
1046          await binaryImporter.StartRowAsync();
1047          var almostBufferFillingString = new string('a', 8152);
1048          await binaryImporter.WriteAsync(almostBufferFillingString, NpgsqlDbType.Text);
1049          var unicodeCharacterThatEncodesToThreeBytesInUtf8 = '\uD55C';
1050          var longStringStartingWithAforementionedUnicodeCharacter = unicodeCharacterThatEncodesToThreeBytesInUtf8 + new string('a', 10000);
1051          await binaryImporter.WriteAsync(longStringStartingWithAforementionedUnicodeCharacter.ToCharArray(), NpgsqlDbType.Text);
1052          await binaryImporter.CompleteAsync();
1053      }
1054      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2371")]
1055      public async Task NRE_in_BeginTextExport()
1056      {
1057          await using var conn = await OpenConnectionAsync();
1058          var funcName = await GetTempFunctionName(conn);
1059          await using var transaction = await conn.BeginTransactionAsync();
1060          await conn.ExecuteNonQueryAsync($"CREATE OR REPLACE FUNCTION {funcName}() RETURNS TABLE (i INT) AS $$ BEGIN RETURN QUERY SELECT s.a FROM pg_stat_activity p; end; $$ LANGUAGE plpgsql;");
1061          using var reader = await conn.BeginTextExportAsync($"copy (select * FROM {funcName}())  TO STDOUT WITH (format csv)");
1062          Assert.That(() => reader.ReadLine(), Throws.Exception
1063              .TypeOf<PostgresException>()
1064              .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.UndefinedTable)
1065          );
1066      }
1067      public enum TestEnum
1068      {
1069          One,
1070          Two
1071      }
1072      class SomeComposite
1073      {
1074          public TestEnum Test { get; set; }
1075          public int X { get; set; }
1076          public string SomeText { get; set; } = "";
1077      }
1078      [Test]
1079      public async Task CompositePostgresType()
1080      {
1081          await using var adminConnection = await OpenConnectionAsync();
1082          var type = await GetTempTypeName(adminConnection);
1083          var func = await GetTempFunctionName(adminConnection);
1084          await adminConnection.ExecuteNonQueryAsync($"CREATE TYPE {type} as (x int, some_text text, test int)");
1085          var dataSourceBuilder = CreateDataSourceBuilder();
1086          dataSourceBuilder.MapComposite<SomeComposite>(type);
1087          await using var dataSource = dataSourceBuilder.Build();
1088          await using var connection = await dataSource.OpenConnectionAsync();
1089          await connection.ExecuteNonQueryAsync(@$"
1090  CREATE OR REPLACE FUNCTION {func}(id int, out comp1 {type}, OUT comp2 {type}[])
1091  LANGUAGE plpgsql AS
1092  $$
1093  BEGIN
1094      comp1 = ROW(9, 'bar', 1)::{type};
1095      comp2 = ARRAY[ROW(9, 'bar', 1)::{type}];
1096  END;
1097  $$;");
1098          Assert.ThrowsAsync<InvalidCastException>(async () => await connection.ExecuteScalarAsync($"SELECT {func}(0)"));
1099      }
1100      [Test]
1101      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3117")]
1102      public void Bug3117()
1103      {
1104          const string OkCommand = "SELECT 1";
1105          const string ErrorCommand = "SELECT * FROM public.imnotexist";
1106          using var dataSource = CreateDataSource();
1107          using (var conn = dataSource.OpenConnection())
1108          {
1109              var okCommand = new NpgsqlCommand(OkCommand, conn);
1110              okCommand.Prepare();
1111              using (okCommand.ExecuteReader()) { }
1112              var errorCommand = new NpgsqlCommand(ErrorCommand, conn);
1113              Assert.That(() => errorCommand.Prepare(), Throws.Exception
1114                  .TypeOf<PostgresException>()
1115                  .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.UndefinedTable));
1116          }
1117          using (var conn = dataSource.OpenConnection())
1118          {
1119              var okCommand = new NpgsqlCommand(OkCommand, conn);
1120              okCommand.Prepare();
1121              using (okCommand.ExecuteReader()) { }
1122          }
1123      }
1124      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3209")]
1125      public async Task Bug3209()
1126      {
1127          await using var conn = CreateConnection();
1128          await conn.CloseAsync();
1129          await conn.OpenAsync();
1130          await conn.CloseAsync();
1131          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
1132      }
1133      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3373")]
1134      public async Task Bug3373()
1135      {
1136          await using var conn = await OpenConnectionAsync();
1137          using var cmd = conn.CreateCommand();
1138          cmd.CommandText = "SELECT repeat('1', 10000); SELECT * from pg_sleep(3)";
1139          cmd.CommandTimeout = 0;
1140          await using var reader = await cmd.ExecuteReaderAsync();
1141          Assert.DoesNotThrowAsync(async () => await reader.NextResultAsync());
1142      }
1143      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3649")]
1144      public async Task Bug3649()
1145      {
1146          await using var conn = await OpenConnectionAsync();
1147          var table = await CreateTempTable(conn, "value integer");
1148          using (var importer = await conn.BeginBinaryImportAsync($"COPY {table} (value) FROM STDIN (FORMAT binary)"))
1149          {
1150              await importer.StartRowAsync();
1151              await importer.WriteAsync(DBNull.Value, NpgsqlDbType.Integer);
1152              await importer.StartRowAsync();
1153              await importer.WriteAsync(1, NpgsqlDbType.Integer);
1154              await importer.StartRowAsync();
1155              await importer.WriteAsync(2, NpgsqlDbType.Integer);
1156              await importer.CompleteAsync();
1157          }
1158          using (var exporter = await conn.BeginBinaryExportAsync($"COPY {table} (value) TO STDIN (FORMAT binary)"))
1159          {
1160              await exporter.StartRowAsync();
1161              Assert.IsTrue(exporter.IsNull);
1162              await exporter.SkipAsync();
1163              await exporter.StartRowAsync();
1164              Assert.AreEqual(1, await exporter.ReadAsync<int?>());
1165              await exporter.StartRowAsync();
1166              Assert.AreEqual(2, await exporter.ReadAsync<int?>());
1167          }
1168      }
1169      [Test]
1170      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3839")]
1171      public async Task SingleThreadedSynchronizationContext_deadlock()
1172      {
1173          var syncContext = new SingleThreadSynchronizationContext(nameof(SingleThreadedSynchronizationContext_deadlock));
1174          using (var _ = syncContext.Enter())
1175          {
1176              await Task.Yield();
1177              using var connection = OpenConnection();
1178              var data = new string('x', 5_000_000);
1179              using var cmd = new NpgsqlCommand("SELECT generate_series(1, 500000); SELECT @p", connection);
1180              cmd.Parameters.AddWithValue("p", NpgsqlDbType.Text, data);
1181              cmd.ExecuteNonQuery();
1182          }
1183          await Task.Yield();
1184      }
1185      [Test]
1186      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3924")]
1187      public async Task Bug3924()
1188      {
1189          var csb = new NpgsqlConnectionStringBuilder(ConnectionString)
1190          {
1191              CommandTimeout = 10,
1192              KeepAlive = 5,
1193          };
1194          await using var postmaster = PgPostmasterMock.Start(csb.ConnectionString);
1195          await using var dataSource = CreateDataSource(postmaster.ConnectionString);
1196          await using var conn = await dataSource.OpenConnectionAsync();
1197          var serverMock = await postmaster.WaitForServerConnection();
1198          using (var cmd = conn.CreateCommand())
1199          {
1200              cmd.CommandTimeout = 1;
1201              cmd.CommandText = "SELECT 1";
1202              var queryTask = cmd.ExecuteNonQueryAsync();
1203              await serverMock.ExpectExtendedQuery();
1204              _ = serverMock.WriteScalarResponseAndFlush(1);
1205              await queryTask;
1206          }
1207          await serverMock.ExpectMessage(FrontendMessageCode.Sync);
1208          await Task.Delay(1000);
1209          _ = serverMock.WriteReadyForQuery().FlushAsync();
1210          using (var cmd = conn.CreateCommand())
1211          {
1212              cmd.CommandTimeout = 1;
1213              cmd.CommandText = "SELECT 1";
1214              var queryTask = cmd.ExecuteNonQueryAsync();
1215              await serverMock.ExpectExtendedQuery();
1216              _ = serverMock.WriteScalarResponseAndFlush(1);
1217              Assert.DoesNotThrowAsync(async () => await queryTask);
1218          }
1219      }
1220      [Test]
1221      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4099")]
1222      public async Task Bug4099()
1223      {
1224          var csb = new NpgsqlConnectionStringBuilder(ConnectionString)
1225          {
1226              Multiplexing = true,
1227              MaxPoolSize = 1
1228          };
1229          await using var postmaster = PgPostmasterMock.Start(csb.ConnectionString);
1230          await using var dataSource = CreateDataSource(postmaster.ConnectionString);
1231          await using var firstConn = await dataSource.OpenConnectionAsync();
1232          await using var secondConn = await dataSource.OpenConnectionAsync();
1233          var firstQuery = firstConn.ExecuteScalarAsync("SELECT data");
1234          var server = await postmaster.WaitForServerConnection();
1235          await server.ExpectExtendedQuery();
1236          var secondQuery = secondConn.ExecuteScalarAsync("SELECT other_data");
1237          await server.ExpectExtendedQuery();
1238          var data = new byte[10000];
1239          await server
1240              .WriteParseComplete()
1241              .WriteBindComplete()
1242              .WriteRowDescription(new FieldDescription(PostgresTypeOIDs.Bytea))
1243              .WriteDataRowWithFlush(data);
1244          var otherData = new byte[10];
1245          await server
1246              .WriteCommandComplete()
1247              .WriteReadyForQuery()
1248              .WriteParseComplete()
1249              .WriteBindComplete()
1250              .WriteRowDescription(new FieldDescription(PostgresTypeOIDs.Bytea))
1251              .WriteDataRow(otherData)
1252              .WriteCommandComplete()
1253              .WriteReadyForQuery()
1254              .FlushAsync();
1255          Assert.That(data, Is.EquivalentTo((byte[])(await firstQuery)!));
1256          Assert.That(otherData, Is.EquivalentTo((byte[])(await secondQuery)!));
1257      }
1258      [Test]
1259      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4123")]
1260      public async Task Bug4123()
1261      {
1262          await using var conn = await OpenConnectionAsync();
1263          await using var cmd = new NpgsqlCommand("SELECT 1", conn);
1264          await using var rdr = await cmd.ExecuteReaderAsync();
1265          await rdr.ReadAsync();
1266          await using var stream = await rdr.GetStreamAsync(0);
1267          Assert.DoesNotThrowAsync(stream.FlushAsync);
1268          Assert.DoesNotThrow(stream.Flush);
1269      }
1270  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-CommandTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-BugTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>15  namespace Npgsql.Tests;
16  public class CommandTests : MultiplexingTestBase
17  {
18      #region Legacy batching
19      [Test]
</pre></code></div>
                <div class="column column_space"><pre><code>13  namespace Npgsql.Tests;
14  public class BugTests : TestBase
15  {
16      #region Sequential reader bugs
17      [Test, Description("In sequential access, performing a null check on a non-first field would check the first field")]
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    