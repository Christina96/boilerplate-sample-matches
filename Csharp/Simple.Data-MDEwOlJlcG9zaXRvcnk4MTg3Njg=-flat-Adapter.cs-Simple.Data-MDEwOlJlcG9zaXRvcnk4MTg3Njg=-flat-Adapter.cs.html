
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 14, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>Simple.Data-MDEwOlJlcG9zaXRvcnk4MTg3Njg=-flat-Adapter.cs</h3>
            <pre><code>1  namespace Simple.Data
2  {
3      using System;
4      using System.Collections.Generic;
5      using System.Dynamic;
6      using System.Linq;
7      using Extensions;
8      public abstract class Adapter
9      {
10          private readonly ExpandoObject _settings = new ExpandoObject();
11          protected dynamic Settings
12          {
13              get { return _settings; }
14          }
15          public void Setup(object settings)
16          {
17              Setup(settings.ObjectToDictionary());
18          }
19          public void Setup(IEnumerable<KeyValuePair<string, object>> settings)
20          {
21              var settingsAsDictionary = (IDictionary<string, object>) _settings;
22              foreach (var keyValuePair in settings)
23              {
24                  settingsAsDictionary.Add(keyValuePair);
25              }
26              OnSetup();
27          }
28          public OptionsBase Options { get; set; }
29          protected virtual void OnSetup()
30          {
31          }
32          public abstract IDictionary<string, object> GetKey(string tableName, IDictionary<string, object> record);
33          public abstract IList<string> GetKeyNames(string tableName); 
34          public abstract IDictionary<string, object> Get(string tableName, params object[] keyValues); 
35          public abstract IEnumerable<IDictionary<string, object>> Find(string tableName, SimpleExpression criteria);
36          public abstract IEnumerable<IDictionary<string, object>> RunQuery(SimpleQuery query,
37                                                                            out IEnumerable<SimpleQueryClauseBase>
38                                                                                unhandledClauses);
39          public abstract IDictionary<string, object> Insert(string tableName, IDictionary<string, object> data, bool resultRequired);
40          public abstract int Update(string tableName, IDictionary<string, object> data, SimpleExpression criteria);
41          public abstract int Delete(string tableName, SimpleExpression criteria);
42          public abstract bool IsExpressionFunction(string functionName, params object[] args);
43          public virtual IDictionary<string, object> FindOne(string tableName, SimpleExpression criteria)
44          {
45              return Find(tableName, criteria).FirstOrDefault();
46          }
47          public virtual IEnumerable<IDictionary<string, object>> InsertMany(string tableName,
48                                                                             IEnumerable<IDictionary<string, object>> dataList,
49                                                                             Func<IDictionary<string, object>, Exception, bool> onError,
50              bool resultRequired)
51          {
52              if (resultRequired)
53              {
54                  return InsertManyAndReturn(tableName, dataList, onError);
55              }
56              InsertManyWithoutReturn(tableName, dataList, onError);
57              return null;
58          }
59          private IEnumerable<IDictionary<string, object>> InsertManyAndReturn(string tableName, IEnumerable<IDictionary<string, object>> dataList, Func<IDictionary<string, object>, Exception, bool> onError)
60          {
61              foreach (var row in dataList)
62              {
63                  IDictionary<string, object> inserted;
64                  try
65                  {
66                      inserted = Insert(tableName, row, true);
67                  }
68                  catch (Exception ex)
69                  {
70                      if (onError != null)
71                      {
72                          if (onError(row, ex))
73                          {
74                              continue;
75                          }
76                          break;
77                      }
78                      throw;
79                  }
80                  yield return inserted;
81              }
82          }
83          private void InsertManyWithoutReturn(string tableName, IEnumerable<IDictionary<string, object>> dataList, Func<IDictionary<string, object>, Exception, bool> onError)
84          {
85              foreach (var row in dataList)
86              {
87                  try
88                  {
89                      Insert(tableName, row, false);
90                  }
91                  catch (Exception ex)
92                  {
93                      if (onError != null)
94                      {
95                          if (onError(row, ex))
96                          {
97                              continue;
98                          }
99                          break;
100                      }
101                      throw;
102                  }
103              }
104          }
105          public virtual int UpdateMany(string tableName, IEnumerable<IDictionary<string, object>> data)
106          {
107              int updateCount = 0;
108              foreach (var row in data)
109              {
110                  var key = GetKey(tableName, row);
111                  var criteria = ExpressionHelper.CriteriaDictionaryToExpression(tableName, key);
112                  updateCount += Update(tableName, row, criteria);
113              }
114              return updateCount;
115          }
116          public virtual IObservable<IDictionary<string, object>> RunQueryAsObservable(SimpleQuery query,
117                                                                                       out
118                                                                                           IEnumerable
119                                                                                           <SimpleQueryClauseBase>
120                                                                                           unhandledClauses)
121          {
122              return RunQuery(query, out unhandledClauses).ToObservable();
123          }
124          public virtual IEnumerable<IEnumerable<IDictionary<string, object>>> RunQueries(SimpleQuery[] queries,
125                                                                                           List
126                                                                                               <
127                                                                                               IEnumerable
128                                                                                               <SimpleQueryClauseBase>>
129                                                                                               unhandledClauses)
130          {
131              foreach (var query in queries)
132              {
133                  IEnumerable<SimpleQueryClauseBase> unhandledClausesForThisQuery;
134                  var result = RunQuery(query, out unhandledClausesForThisQuery);
135                  unhandledClauses.Add(unhandledClausesForThisQuery);
136                  yield return result;
137              }
138          }
139          public virtual int UpdateMany(string tableName, IEnumerable<IDictionary<string, object>> dataList,
140                                        IEnumerable<string> criteriaFieldNames)
141          {
142              int updatedCount = 0;
143              var criteriaFieldNameList = criteriaFieldNames.ToList();
144              foreach (var data in dataList)
145              {
146                  updatedCount += Update(tableName, data, GetCriteria(tableName, criteriaFieldNameList, data));
147              }
148              return updatedCount;
149          }
150          public virtual Func<object[], IDictionary<string, object>> CreateFindOneDelegate(string tableName,
151                                                                                           SimpleExpression criteria)
152          {
153              throw new NotImplementedException();
154          }
155          public virtual Func<object[], IEnumerable<IDictionary<string, object>>> CreateFindDelegate(string tableName,
156                                                                                                     SimpleExpression
157                                                                                                         criteria)
158          {
159              throw new NotImplementedException();
160          }
161          protected static SimpleExpression GetCriteria(string tableName, IEnumerable<string> criteriaFieldNames,
162                                                        IDictionary<string, object> record)
163          {
164              var criteria = new Dictionary<string, object>();
165              foreach (var criteriaFieldName in criteriaFieldNames)
166              {
167                  var name = criteriaFieldName;
168                  var keyValuePair = record.SingleOrDefault(kvp => kvp.Key.Homogenize().Equals(name.Homogenize()));
169                  if (string.IsNullOrWhiteSpace(keyValuePair.Key))
170                  {
171                      throw new InvalidOperationException("Key field value not set.");
172                  }
173                  criteria.Add(criteriaFieldName, keyValuePair.Value);
174                  record.Remove(keyValuePair);
175              }
176              return ExpressionHelper.CriteriaDictionaryToExpression(tableName, criteria);
177          }
178          public void Reset()
179          {
180              OnReset();
181          }
182          protected virtual void OnReset()
183          {
184          }
185          private OptimizingDelegateFactory _optimizingDelegateFactory;
186          public OptimizingDelegateFactory OptimizingDelegateFactory
187          {
188              get { return _optimizingDelegateFactory ?? (_optimizingDelegateFactory = CreateOptimizingDelegateFactory()); }
189          }
190          private OptimizingDelegateFactory CreateOptimizingDelegateFactory()
191          {
192              return MefHelper.GetAdjacentComponent<OptimizingDelegateFactory>(GetType()) ?? new DefaultOptimizingDelegateFactory();
193          }
194          public virtual IDictionary<string, object> Upsert(string tableName, IDictionary<string, object> dict, SimpleExpression criteriaExpression, bool isResultRequired)
195          {
196              if (Find(tableName, criteriaExpression).Any())
197              {
198                  var key = GetKey(tableName, dict);
199                  dict = dict.Where(kvp => key.All(keyKvp => keyKvp.Key.Homogenize() != kvp.Key.Homogenize())).ToDictionary();
200                  Update(tableName, dict, criteriaExpression);
201                  return isResultRequired ? Find(tableName, criteriaExpression).FirstOrDefault() : null;
202              }
203              return Insert(tableName, dict, isResultRequired);
204          }
205          public virtual IEnumerable<IDictionary<string, object>> UpsertMany(string tableName, IList<IDictionary<string, object>> list, IEnumerable<string> keyFieldNames, bool isResultRequired, Func<IDictionary<string,object>,Exception,bool> errorCallback)
206          {
207              if (isResultRequired)
208                  return UpsertManyWithResults(tableName, list, keyFieldNames, errorCallback);
209              UpsertManyWithoutResults(tableName, list, keyFieldNames, errorCallback);
210              return null;
211          }
212          private IEnumerable<IDictionary<string, object>> UpsertManyWithResults(string tableName, IEnumerable<IDictionary<string, object>> list, IEnumerable<string> keyFieldNames,
213                                                    Func<IDictionary<string, object>, Exception, bool> errorCallback)
214          {
215              var criteriaFields = keyFieldNames.ToArray();
216              foreach (var row in list)
217              {
218                  IDictionary<string, object> result;
219                  try
220                  {
221                      var criteria = GetCriteria(tableName, criteriaFields, row);
222                      result = Upsert(tableName, row, criteria, true);
223                  }
224                  catch (Exception ex)
225                  {
226                      if (errorCallback(row, ex)) continue;
227                      throw;
228                  }
229                  yield return result;
230              }
231          }
232          private void UpsertManyWithoutResults(string tableName, IEnumerable<IDictionary<string, object>> list, IEnumerable<string> keyFieldNames,
233                                                    Func<IDictionary<string, object>, Exception, bool> errorCallback)
234          {
235              var criteriaFields = keyFieldNames.ToArray();
236              foreach (var row in list)
237              {
238                  try
239                  {
240                      var criteria = GetCriteria(tableName, criteriaFields, row);
241                      Upsert(tableName, row, criteria, false);
242                  }
243                  catch (Exception ex)
244                  {
<span onclick='openModal()' class='match'>245                      if (errorCallback(row, ex)) continue;
246                      throw;
247                  }
248              }
</span>249          }
250          public virtual IDictionary<string, object> Upsert(string tableName, IDictionary<string, object> dict, SimpleExpression criteriaExpression, bool isResultRequired, IAdapterTransaction transaction)
251          {
252              var transactionAdapter = this as IAdapterWithTransactions;
253              if (transactionAdapter == null) throw new NotSupportedException("Transactions are not supported with current adapter.");
254              if (transactionAdapter.Find(tableName, criteriaExpression, transaction).Any())
255              {
256                  transactionAdapter.Update(tableName, dict, criteriaExpression, transaction);
257                  return isResultRequired ? transactionAdapter.Find(tableName, criteriaExpression, transaction).FirstOrDefault() : null;
258              }
259              return transactionAdapter.Insert(tableName, dict, transaction, isResultRequired);
260          }
261          public virtual IEnumerable<IDictionary<string, object>> UpsertMany(string tableName, IList<IDictionary<string, object>> list, IEnumerable<string> keyFieldNames, IAdapterTransaction transaction, bool isResultRequired, Func<IDictionary<string,object>,Exception,bool> errorCallback)
262          {
263              var transactionAdapter = this as IAdapterWithTransactions;
264              if (transactionAdapter == null) throw new NotSupportedException("Transactions are not supported with current adapter.");
265              var criteriaFields = keyFieldNames.ToArray();
266              if (isResultRequired)
267              {
268                  return UpsertManyWithResults(tableName, list, transaction, transactionAdapter, criteriaFields, errorCallback);
269              }
270              UpsertManyWithoutResults(tableName, list, transaction, transactionAdapter, criteriaFields, errorCallback);
271              return null;
272          }
273          private static IEnumerable<IDictionary<string, object>> UpsertManyWithResults(string tableName, IEnumerable<IDictionary<string, object>> list, IAdapterTransaction transaction, IAdapterWithTransactions transactionAdapter, string[] criteriaFields, Func<IDictionary<string, object>, Exception, bool> errorCallback)
274          {
275              foreach (var row in list)
276              {
277                  IDictionary<string, object> result;
278                  try
279                  {
280                      var criteria = GetCriteria(tableName, criteriaFields, row);
281                      result = transactionAdapter.Upsert(tableName, row, criteria, true, transaction);
282                  }
283                  catch (Exception ex)
284                  {
285                      if (errorCallback(row, ex))
286                      {
287                          continue;
288                      }
289                      throw;
290                  }
291                  yield return result;
292              }
293          }
294          private static void UpsertManyWithoutResults(string tableName, IEnumerable<IDictionary<string, object>> list, IAdapterTransaction transaction, IAdapterWithTransactions transactionAdapter, string[] criteriaFields, Func<IDictionary<string, object>, Exception, bool> errorCallback)
295          {
296              foreach (var row in list)
297              {
298                  var criteria = GetCriteria(tableName, criteriaFields, row);
299                  try
300                  {
301                      transactionAdapter.Upsert(tableName, row, criteria, true, transaction);
302                  }
303                  catch (Exception ex)
304                  {
305                      if (errorCallback(row, ex))
306                      {
307                          continue;
308                      }
309                      throw;
310                  }
311              }
312          }
313          public virtual IEnumerable<IDictionary<string, object>> UpsertMany(string tableName, IList<IDictionary<string, object>> list, bool isResultRequired, Func<IDictionary<string,object>,Exception,bool> errorCallback)
314          {
315              if (isResultRequired)
316              {
317                  return UpsertManyWithResults(tableName, list, errorCallback);
318              }
319              UpsertManyWithoutResults(tableName, list, errorCallback);
320              return null;
321          }
322          private IEnumerable<IDictionary<string, object>> UpsertManyWithResults(string tableName, IEnumerable<IDictionary<string, object>> list, Func<IDictionary<string, object>, Exception, bool> errorCallback)
323          {
324              foreach (var row in list)
325              {
326                  IDictionary<string, object> result;
327                  try
328                  {
329                      var key = GetKey(tableName, row);
330                      var criteria = ExpressionHelper.CriteriaDictionaryToExpression(tableName, key);
331                      if (Find(tableName, criteria).Any())
332                      {
333                          var record = row.Except(key).ToDictionary();
334                          Update(tableName, record, criteria);
335                          result = FindOne(tableName, criteria);
336                      }
337                      else
338                      {
339                          result = Insert(tableName, row, true);
340                      }
341                  }
342                  catch (Exception ex)
343                  {
344                      if (errorCallback(row, ex))
345                      {
346                          continue;
347                      }
348                      throw;
349                  }
350                  yield return result;
351              }
352          }
353          private void UpsertManyWithoutResults(string tableName, IEnumerable<IDictionary<string, object>> list, Func<IDictionary<string, object>, Exception, bool> errorCallback)
354          {
355              foreach (var row in list)
356              {
357                  try
358                  {
359                      var key = GetKey(tableName, row);
360                      var criteria = ExpressionHelper.CriteriaDictionaryToExpression(tableName, key);
361                      if (Find(tableName, criteria).Any())
362                      {
363                          var record = row.Except(key).ToDictionary();
364                          Update(tableName, record, criteria);
365                      }
366                      else
367                      {
368                          Insert(tableName, row, false);
369                      }
370                  }
371                  catch (Exception ex)
372                  {
373                      if (!errorCallback(row, ex)) throw;
374                  }
375              }
376          }
377          public virtual IEnumerable<IDictionary<string, object>> UpsertMany(string tableName, IList<IDictionary<string, object>> list, IAdapterTransaction transaction, bool isResultRequired, Func<IDictionary<string,object>,Exception,bool> errorCallback)
378          {
379              var transactionAdapter = this as IAdapterWithTransactions;
380              if (transactionAdapter == null) throw new NotSupportedException("Transactions are not supported with current adapter.");
381              foreach (var row in list)
382              {
383                  IDictionary<string, object> result;
384                  try
385                  {
386                      var key = GetKey(tableName, row);
387                      var criteria = ExpressionHelper.CriteriaDictionaryToExpression(tableName, key);
388                      if (transactionAdapter.Find(tableName, criteria, transaction).Any())
389                      {
390                          var record = row.Except(key).ToDictionary();
391                          transactionAdapter.Update(tableName, record, criteria, transaction);
392                          result = isResultRequired ? transactionAdapter.Find(tableName, criteria, transaction).FirstOrDefault() : null;
393                      }
394                      else
395                      {
396                          result = transactionAdapter.Insert(tableName, row, transaction, isResultRequired);
397                      }
398                  }
399                  catch (Exception ex)
400                  {
401                      if (errorCallback(row, ex)) continue;
402                      throw;
403                  }
404                  yield return result;
405              }
406          }
407      }
408  }
</code></pre>
        </div>
        <div class="column">
            <h3>Simple.Data-MDEwOlJlcG9zaXRvcnk4MTg3Njg=-flat-Adapter.cs</h3>
            <pre><code>1  namespace Simple.Data
2  {
3      using System;
4      using System.Collections.Generic;
5      using System.Dynamic;
6      using System.Linq;
7      using Extensions;
8      public abstract class Adapter
9      {
10          private readonly ExpandoObject _settings = new ExpandoObject();
11          protected dynamic Settings
12          {
13              get { return _settings; }
14          }
15          public void Setup(object settings)
16          {
17              Setup(settings.ObjectToDictionary());
18          }
19          public void Setup(IEnumerable<KeyValuePair<string, object>> settings)
20          {
21              var settingsAsDictionary = (IDictionary<string, object>) _settings;
22              foreach (var keyValuePair in settings)
23              {
24                  settingsAsDictionary.Add(keyValuePair);
25              }
26              OnSetup();
27          }
28          public OptionsBase Options { get; set; }
29          protected virtual void OnSetup()
30          {
31          }
32          public abstract IDictionary<string, object> GetKey(string tableName, IDictionary<string, object> record);
33          public abstract IList<string> GetKeyNames(string tableName); 
34          public abstract IDictionary<string, object> Get(string tableName, params object[] keyValues); 
35          public abstract IEnumerable<IDictionary<string, object>> Find(string tableName, SimpleExpression criteria);
36          public abstract IEnumerable<IDictionary<string, object>> RunQuery(SimpleQuery query,
37                                                                            out IEnumerable<SimpleQueryClauseBase>
38                                                                                unhandledClauses);
39          public abstract IDictionary<string, object> Insert(string tableName, IDictionary<string, object> data, bool resultRequired);
40          public abstract int Update(string tableName, IDictionary<string, object> data, SimpleExpression criteria);
41          public abstract int Delete(string tableName, SimpleExpression criteria);
42          public abstract bool IsExpressionFunction(string functionName, params object[] args);
43          public virtual IDictionary<string, object> FindOne(string tableName, SimpleExpression criteria)
44          {
45              return Find(tableName, criteria).FirstOrDefault();
46          }
47          public virtual IEnumerable<IDictionary<string, object>> InsertMany(string tableName,
48                                                                             IEnumerable<IDictionary<string, object>> dataList,
49                                                                             Func<IDictionary<string, object>, Exception, bool> onError,
50              bool resultRequired)
51          {
52              if (resultRequired)
53              {
54                  return InsertManyAndReturn(tableName, dataList, onError);
55              }
56              InsertManyWithoutReturn(tableName, dataList, onError);
57              return null;
58          }
59          private IEnumerable<IDictionary<string, object>> InsertManyAndReturn(string tableName, IEnumerable<IDictionary<string, object>> dataList, Func<IDictionary<string, object>, Exception, bool> onError)
60          {
61              foreach (var row in dataList)
62              {
63                  IDictionary<string, object> inserted;
64                  try
65                  {
66                      inserted = Insert(tableName, row, true);
67                  }
68                  catch (Exception ex)
69                  {
70                      if (onError != null)
71                      {
72                          if (onError(row, ex))
73                          {
74                              continue;
75                          }
76                          break;
77                      }
78                      throw;
79                  }
80                  yield return inserted;
81              }
82          }
83          private void InsertManyWithoutReturn(string tableName, IEnumerable<IDictionary<string, object>> dataList, Func<IDictionary<string, object>, Exception, bool> onError)
84          {
85              foreach (var row in dataList)
86              {
87                  try
88                  {
89                      Insert(tableName, row, false);
90                  }
91                  catch (Exception ex)
92                  {
93                      if (onError != null)
94                      {
95                          if (onError(row, ex))
96                          {
97                              continue;
98                          }
99                          break;
100                      }
101                      throw;
102                  }
103              }
104          }
105          public virtual int UpdateMany(string tableName, IEnumerable<IDictionary<string, object>> data)
106          {
107              int updateCount = 0;
108              foreach (var row in data)
109              {
110                  var key = GetKey(tableName, row);
111                  var criteria = ExpressionHelper.CriteriaDictionaryToExpression(tableName, key);
112                  updateCount += Update(tableName, row, criteria);
113              }
114              return updateCount;
115          }
116          public virtual IObservable<IDictionary<string, object>> RunQueryAsObservable(SimpleQuery query,
117                                                                                       out
118                                                                                           IEnumerable
119                                                                                           <SimpleQueryClauseBase>
120                                                                                           unhandledClauses)
121          {
122              return RunQuery(query, out unhandledClauses).ToObservable();
123          }
124          public virtual IEnumerable<IEnumerable<IDictionary<string, object>>> RunQueries(SimpleQuery[] queries,
125                                                                                           List
126                                                                                               <
127                                                                                               IEnumerable
128                                                                                               <SimpleQueryClauseBase>>
129                                                                                               unhandledClauses)
130          {
131              foreach (var query in queries)
132              {
133                  IEnumerable<SimpleQueryClauseBase> unhandledClausesForThisQuery;
134                  var result = RunQuery(query, out unhandledClausesForThisQuery);
135                  unhandledClauses.Add(unhandledClausesForThisQuery);
136                  yield return result;
137              }
138          }
139          public virtual int UpdateMany(string tableName, IEnumerable<IDictionary<string, object>> dataList,
140                                        IEnumerable<string> criteriaFieldNames)
141          {
142              int updatedCount = 0;
143              var criteriaFieldNameList = criteriaFieldNames.ToList();
144              foreach (var data in dataList)
145              {
146                  updatedCount += Update(tableName, data, GetCriteria(tableName, criteriaFieldNameList, data));
147              }
148              return updatedCount;
149          }
150          public virtual Func<object[], IDictionary<string, object>> CreateFindOneDelegate(string tableName,
151                                                                                           SimpleExpression criteria)
152          {
153              throw new NotImplementedException();
154          }
155          public virtual Func<object[], IEnumerable<IDictionary<string, object>>> CreateFindDelegate(string tableName,
156                                                                                                     SimpleExpression
157                                                                                                         criteria)
158          {
159              throw new NotImplementedException();
160          }
161          protected static SimpleExpression GetCriteria(string tableName, IEnumerable<string> criteriaFieldNames,
162                                                        IDictionary<string, object> record)
163          {
164              var criteria = new Dictionary<string, object>();
165              foreach (var criteriaFieldName in criteriaFieldNames)
166              {
167                  var name = criteriaFieldName;
168                  var keyValuePair = record.SingleOrDefault(kvp => kvp.Key.Homogenize().Equals(name.Homogenize()));
169                  if (string.IsNullOrWhiteSpace(keyValuePair.Key))
170                  {
171                      throw new InvalidOperationException("Key field value not set.");
172                  }
173                  criteria.Add(criteriaFieldName, keyValuePair.Value);
174                  record.Remove(keyValuePair);
175              }
176              return ExpressionHelper.CriteriaDictionaryToExpression(tableName, criteria);
177          }
178          public void Reset()
179          {
180              OnReset();
181          }
182          protected virtual void OnReset()
183          {
184          }
185          private OptimizingDelegateFactory _optimizingDelegateFactory;
186          public OptimizingDelegateFactory OptimizingDelegateFactory
187          {
188              get { return _optimizingDelegateFactory ?? (_optimizingDelegateFactory = CreateOptimizingDelegateFactory()); }
189          }
190          private OptimizingDelegateFactory CreateOptimizingDelegateFactory()
191          {
192              return MefHelper.GetAdjacentComponent<OptimizingDelegateFactory>(GetType()) ?? new DefaultOptimizingDelegateFactory();
193          }
194          public virtual IDictionary<string, object> Upsert(string tableName, IDictionary<string, object> dict, SimpleExpression criteriaExpression, bool isResultRequired)
195          {
196              if (Find(tableName, criteriaExpression).Any())
197              {
198                  var key = GetKey(tableName, dict);
199                  dict = dict.Where(kvp => key.All(keyKvp => keyKvp.Key.Homogenize() != kvp.Key.Homogenize())).ToDictionary();
200                  Update(tableName, dict, criteriaExpression);
201                  return isResultRequired ? Find(tableName, criteriaExpression).FirstOrDefault() : null;
202              }
203              return Insert(tableName, dict, isResultRequired);
204          }
205          public virtual IEnumerable<IDictionary<string, object>> UpsertMany(string tableName, IList<IDictionary<string, object>> list, IEnumerable<string> keyFieldNames, bool isResultRequired, Func<IDictionary<string,object>,Exception,bool> errorCallback)
206          {
207              if (isResultRequired)
208                  return UpsertManyWithResults(tableName, list, keyFieldNames, errorCallback);
209              UpsertManyWithoutResults(tableName, list, keyFieldNames, errorCallback);
210              return null;
211          }
212          private IEnumerable<IDictionary<string, object>> UpsertManyWithResults(string tableName, IEnumerable<IDictionary<string, object>> list, IEnumerable<string> keyFieldNames,
213                                                    Func<IDictionary<string, object>, Exception, bool> errorCallback)
214          {
215              var criteriaFields = keyFieldNames.ToArray();
216              foreach (var row in list)
217              {
218                  IDictionary<string, object> result;
219                  try
220                  {
221                      var criteria = GetCriteria(tableName, criteriaFields, row);
222                      result = Upsert(tableName, row, criteria, true);
223                  }
224                  catch (Exception ex)
225                  {
<span onclick='openModal()' class='match'>226                      if (errorCallback(row, ex)) continue;
227                      throw;
228                  }
229                  yield return result;
</span>230              }
231          }
232          private void UpsertManyWithoutResults(string tableName, IEnumerable<IDictionary<string, object>> list, IEnumerable<string> keyFieldNames,
233                                                    Func<IDictionary<string, object>, Exception, bool> errorCallback)
234          {
235              var criteriaFields = keyFieldNames.ToArray();
236              foreach (var row in list)
237              {
238                  try
239                  {
240                      var criteria = GetCriteria(tableName, criteriaFields, row);
241                      Upsert(tableName, row, criteria, false);
242                  }
243                  catch (Exception ex)
244                  {
245                      if (errorCallback(row, ex)) continue;
246                      throw;
247                  }
248              }
249          }
250          public virtual IDictionary<string, object> Upsert(string tableName, IDictionary<string, object> dict, SimpleExpression criteriaExpression, bool isResultRequired, IAdapterTransaction transaction)
251          {
252              var transactionAdapter = this as IAdapterWithTransactions;
253              if (transactionAdapter == null) throw new NotSupportedException("Transactions are not supported with current adapter.");
254              if (transactionAdapter.Find(tableName, criteriaExpression, transaction).Any())
255              {
256                  transactionAdapter.Update(tableName, dict, criteriaExpression, transaction);
257                  return isResultRequired ? transactionAdapter.Find(tableName, criteriaExpression, transaction).FirstOrDefault() : null;
258              }
259              return transactionAdapter.Insert(tableName, dict, transaction, isResultRequired);
260          }
261          public virtual IEnumerable<IDictionary<string, object>> UpsertMany(string tableName, IList<IDictionary<string, object>> list, IEnumerable<string> keyFieldNames, IAdapterTransaction transaction, bool isResultRequired, Func<IDictionary<string,object>,Exception,bool> errorCallback)
262          {
263              var transactionAdapter = this as IAdapterWithTransactions;
264              if (transactionAdapter == null) throw new NotSupportedException("Transactions are not supported with current adapter.");
265              var criteriaFields = keyFieldNames.ToArray();
266              if (isResultRequired)
267              {
268                  return UpsertManyWithResults(tableName, list, transaction, transactionAdapter, criteriaFields, errorCallback);
269              }
270              UpsertManyWithoutResults(tableName, list, transaction, transactionAdapter, criteriaFields, errorCallback);
271              return null;
272          }
273          private static IEnumerable<IDictionary<string, object>> UpsertManyWithResults(string tableName, IEnumerable<IDictionary<string, object>> list, IAdapterTransaction transaction, IAdapterWithTransactions transactionAdapter, string[] criteriaFields, Func<IDictionary<string, object>, Exception, bool> errorCallback)
274          {
275              foreach (var row in list)
276              {
277                  IDictionary<string, object> result;
278                  try
279                  {
280                      var criteria = GetCriteria(tableName, criteriaFields, row);
281                      result = transactionAdapter.Upsert(tableName, row, criteria, true, transaction);
282                  }
283                  catch (Exception ex)
284                  {
285                      if (errorCallback(row, ex))
286                      {
287                          continue;
288                      }
289                      throw;
290                  }
291                  yield return result;
292              }
293          }
294          private static void UpsertManyWithoutResults(string tableName, IEnumerable<IDictionary<string, object>> list, IAdapterTransaction transaction, IAdapterWithTransactions transactionAdapter, string[] criteriaFields, Func<IDictionary<string, object>, Exception, bool> errorCallback)
295          {
296              foreach (var row in list)
297              {
298                  var criteria = GetCriteria(tableName, criteriaFields, row);
299                  try
300                  {
301                      transactionAdapter.Upsert(tableName, row, criteria, true, transaction);
302                  }
303                  catch (Exception ex)
304                  {
305                      if (errorCallback(row, ex))
306                      {
307                          continue;
308                      }
309                      throw;
310                  }
311              }
312          }
313          public virtual IEnumerable<IDictionary<string, object>> UpsertMany(string tableName, IList<IDictionary<string, object>> list, bool isResultRequired, Func<IDictionary<string,object>,Exception,bool> errorCallback)
314          {
315              if (isResultRequired)
316              {
317                  return UpsertManyWithResults(tableName, list, errorCallback);
318              }
319              UpsertManyWithoutResults(tableName, list, errorCallback);
320              return null;
321          }
322          private IEnumerable<IDictionary<string, object>> UpsertManyWithResults(string tableName, IEnumerable<IDictionary<string, object>> list, Func<IDictionary<string, object>, Exception, bool> errorCallback)
323          {
324              foreach (var row in list)
325              {
326                  IDictionary<string, object> result;
327                  try
328                  {
329                      var key = GetKey(tableName, row);
330                      var criteria = ExpressionHelper.CriteriaDictionaryToExpression(tableName, key);
331                      if (Find(tableName, criteria).Any())
332                      {
333                          var record = row.Except(key).ToDictionary();
334                          Update(tableName, record, criteria);
335                          result = FindOne(tableName, criteria);
336                      }
337                      else
338                      {
339                          result = Insert(tableName, row, true);
340                      }
341                  }
342                  catch (Exception ex)
343                  {
344                      if (errorCallback(row, ex))
345                      {
346                          continue;
347                      }
348                      throw;
349                  }
350                  yield return result;
351              }
352          }
353          private void UpsertManyWithoutResults(string tableName, IEnumerable<IDictionary<string, object>> list, Func<IDictionary<string, object>, Exception, bool> errorCallback)
354          {
355              foreach (var row in list)
356              {
357                  try
358                  {
359                      var key = GetKey(tableName, row);
360                      var criteria = ExpressionHelper.CriteriaDictionaryToExpression(tableName, key);
361                      if (Find(tableName, criteria).Any())
362                      {
363                          var record = row.Except(key).ToDictionary();
364                          Update(tableName, record, criteria);
365                      }
366                      else
367                      {
368                          Insert(tableName, row, false);
369                      }
370                  }
371                  catch (Exception ex)
372                  {
373                      if (!errorCallback(row, ex)) throw;
374                  }
375              }
376          }
377          public virtual IEnumerable<IDictionary<string, object>> UpsertMany(string tableName, IList<IDictionary<string, object>> list, IAdapterTransaction transaction, bool isResultRequired, Func<IDictionary<string,object>,Exception,bool> errorCallback)
378          {
379              var transactionAdapter = this as IAdapterWithTransactions;
380              if (transactionAdapter == null) throw new NotSupportedException("Transactions are not supported with current adapter.");
381              foreach (var row in list)
382              {
383                  IDictionary<string, object> result;
384                  try
385                  {
386                      var key = GetKey(tableName, row);
387                      var criteria = ExpressionHelper.CriteriaDictionaryToExpression(tableName, key);
388                      if (transactionAdapter.Find(tableName, criteria, transaction).Any())
389                      {
390                          var record = row.Except(key).ToDictionary();
391                          transactionAdapter.Update(tableName, record, criteria, transaction);
392                          result = isResultRequired ? transactionAdapter.Find(tableName, criteria, transaction).FirstOrDefault() : null;
393                      }
394                      else
395                      {
396                          result = transactionAdapter.Insert(tableName, row, transaction, isResultRequired);
397                      }
398                  }
399                  catch (Exception ex)
400                  {
401                      if (errorCallback(row, ex)) continue;
402                      throw;
403                  }
404                  yield return result;
405              }
406          }
407      }
408  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Simple.Data-MDEwOlJlcG9zaXRvcnk4MTg3Njg=-flat-Adapter.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Simple.Data-MDEwOlJlcG9zaXRvcnk4MTg3Njg=-flat-Adapter.cs</div>
                </div>
                <div class="column column_space"><pre><code>245                      if (errorCallback(row, ex)) continue;
246                      throw;
247                  }
248              }
</pre></code></div>
                <div class="column column_space"><pre><code>226                      if (errorCallback(row, ex)) continue;
227                      throw;
228                  }
229                  yield return result;
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    