
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 3.1847133757961785%, Tokens: 10</h2>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-GitCheck.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.IO;
4  using System.Linq;
5  using System.Threading;
6  using System.Threading.Tasks;
7  using GitHub.Runner.Common;
8  using GitHub.Runner.Sdk;
9  namespace GitHub.Runner.Listener.Check
10  {
11      public sealed class GitCheck : RunnerService, ICheckExtension
12      {
13          private string _logFile = null;
14          private string _gitPath = null;
15          public int Order => 3;
16          public string CheckName => "Git Certificate/Proxy Validation";
17          public string CheckDescription => "Check if the Git CLI can access GitHub.com or GitHub Enterprise Server.";
18          public string CheckLog => _logFile;
19          public string HelpLink => "https:&bsol;&bsol;github.com/actions/runner/blob/main/docs/checks/git.md";
20          public Type ExtensionType => typeof(ICheckExtension);
21          public override void Initialize(IHostContext hostContext)
22          {
23              base.Initialize(hostContext);
24              _logFile = Path.Combine(HostContext.GetDirectory(WellKnownDirectory.Diag), StringUtil.Format("{0}_{1:yyyyMMdd-HHmmss}-utc.log", nameof(GitCheck), DateTime.UtcNow));
25              _gitPath = WhichUtil.Which("git");
26          }
27          public async Task<bool> RunCheck(string url, string pat)
28          {
29              await File.AppendAllLinesAsync(_logFile, HostContext.WarnLog());
30              await File.AppendAllLinesAsync(_logFile, HostContext.CheckProxy());
31              if (string.IsNullOrEmpty(_gitPath))
32              {
33                  await File.AppendAllLinesAsync(_logFile, new[] { $"{DateTime.UtcNow.ToString("O")} Can't verify git with GitHub.com or GitHub Enterprise Server since git is not installed." });
34                  return false;
35              }
36              var checkGit = await CheckGit(url, pat);
37              var result = checkGit.Pass;
38              await File.AppendAllLinesAsync(_logFile, checkGit.Logs);
39              if (checkGit.SslError)
40              {
41                  await File.AppendAllLinesAsync(_logFile, new[] { $"{DateTime.UtcNow.ToString("O")} Try fix SSL error by providing extra CA certificate." });
42                  var downloadCert = await HostContext.DownloadExtraCA(url, pat);
43                  await File.AppendAllLinesAsync(_logFile, downloadCert.Logs);
44                  if (downloadCert.Pass)
45                  {
46                      var recheckGit = await CheckGit(url, pat, extraCA: true);
47                      await File.AppendAllLinesAsync(_logFile, recheckGit.Logs);
48                      if (recheckGit.Pass)
49                      {
50                          await File.AppendAllLinesAsync(_logFile, new[] { $"{DateTime.UtcNow.ToString("O")} Fixed SSL error by providing extra CA certs." });
51                      }
52                  }
53              }
54              return result;
55          }
56          private async Task<CheckResult> CheckGit(string url, string pat, bool extraCA = false)
57          {
58              var result = new CheckResult();
59              try
60              {
<span onclick='openModal()' class='match'>61                  result.Logs.Add($"{DateTime.UtcNow.ToString("O")} ***************************************************************************************************************");
62                  result.Logs.Add($"{DateTime.UtcNow.ToString("O")} ****                                                                                                       ****");
63                  result.Logs.Add($"{DateTime.UtcNow.ToString("O")} ****     Validate server cert and proxy configuration with Git ");
64                  result.Logs.Add($"{DateTime.UtcNow.ToString("O")} ****                                                                                                       ****");
65                  result.Logs.Add($"{DateTime.UtcNow.ToString("O")} ***************************************************************************************************************");
</span>66                  var repoUrlBuilder = new UriBuilder(url);
67                  repoUrlBuilder.Path = "actions/checkout";
68                  repoUrlBuilder.UserName = "gh";
69                  repoUrlBuilder.Password = pat;
70                  var gitProxy = "";
71                  var proxy = HostContext.WebProxy.GetProxy(repoUrlBuilder.Uri);
72                  if (proxy != null)
73                  {
74                      result.Logs.Add($"{DateTime.UtcNow.ToString("O")} Runner is behind http proxy '{proxy.AbsoluteUri}'");
75                      if (HostContext.WebProxy.HttpProxyUsername != null ||
76                          HostContext.WebProxy.HttpsProxyUsername != null)
77                      {
78                          var proxyUrlWithCred = UrlUtil.GetCredentialEmbeddedUrl(
79                              proxy,
80                              HostContext.WebProxy.HttpProxyUsername ?? HostContext.WebProxy.HttpsProxyUsername,
81                              HostContext.WebProxy.HttpProxyPassword ?? HostContext.WebProxy.HttpsProxyPassword);
82                          gitProxy = $"-c http.proxy={proxyUrlWithCred}";
83                      }
84                      else
85                      {
86                          gitProxy = $"-c http.proxy={proxy.AbsoluteUri}";
87                      }
88                  }
89                  using (var processInvoker = HostContext.CreateService<IProcessInvoker>())
90                  {
91                      processInvoker.OutputDataReceived += new EventHandler<ProcessDataReceivedEventArgs>((sender, args) =>
92                      {
93                          if (!string.IsNullOrEmpty(args.Data))
94                          {
95                              result.Logs.Add($"{DateTime.UtcNow.ToString("O")} {args.Data}");
96                          }
97                      });
98                      processInvoker.ErrorDataReceived += new EventHandler<ProcessDataReceivedEventArgs>((sender, args) =>
99                      {
100                          if (!string.IsNullOrEmpty(args.Data))
101                          {
102                              result.Logs.Add($"{DateTime.UtcNow.ToString("O")} {args.Data}");
103                          }
104                      });
105                      var gitArgs = $"{gitProxy} ls-remote --exit-code {repoUrlBuilder.Uri.AbsoluteUri} HEAD";
106                      result.Logs.Add($"{DateTime.UtcNow.ToString("O")} Run 'git {gitArgs}' ");
107                      var env = new Dictionary<string, string>
108                      {
109                          { "GIT_TRACE", "1" },
110                          { "GIT_CURL_VERBOSE", "1" }
111                      };
112                      if (extraCA)
113                      {
114                          env["GIT_SSL_CAINFO"] = Path.Combine(HostContext.GetDirectory(WellKnownDirectory.Root), "download_ca_cert.pem");
115                      }
116                      await processInvoker.ExecuteAsync(
117                          HostContext.GetDirectory(WellKnownDirectory.Root),
118                          _gitPath,
119                          gitArgs,
120                          env,
121                          true,
122                          CancellationToken.None);
123                  }
124                  result.Pass = true;
125              }
126              catch (Exception ex)
127              {
128                  result.Pass = false;
129                  result.Logs.Add($"{DateTime.UtcNow.ToString("O")} ***************************************************************************************************************");
130                  result.Logs.Add($"{DateTime.UtcNow.ToString("O")} ****                                                                                                       ****");
131                  result.Logs.Add($"{DateTime.UtcNow.ToString("O")} ****     git ls-remote failed with error: {ex}");
132                  if (result.Logs.Any(x => x.Contains("SSL Certificate problem", StringComparison.OrdinalIgnoreCase)))
133                  {
134                      result.Logs.Add($"{DateTime.UtcNow.ToString("O")} ****     git ls-remote failed due to SSL cert issue.");
135                      result.SslError = true;
136                  }
137                  result.Logs.Add($"{DateTime.UtcNow.ToString("O")} ****                                                                                                       ****");
138                  result.Logs.Add($"{DateTime.UtcNow.ToString("O")} ***************************************************************************************************************");
139              }
140              return result;
141          }
142      }
143  }
</code></pre>
        </div>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-OpenIdConnectConfigurationTests.cs</h3>
            <pre><code>1  using System;
2  using System.Net;
3  using System.Security.Claims;
4  using System.Threading.Tasks;
5  using Microsoft.AspNetCore.Authentication.OpenIdConnect;
6  using Microsoft.AspNetCore.Authentication.Tests;
7  using Microsoft.AspNetCore.Builder;
8  using Microsoft.AspNetCore.Hosting;
9  using Microsoft.AspNetCore.Http;
10  using Microsoft.AspNetCore.TestHost;
11  using Microsoft.Extensions.DependencyInjection;
12  using Xunit;
13  namespace Microsoft.AspNetCore.Authentication.Test.OpenIdConnect
14  {
15      public class OpenIdConnectConfigurationTests
16      {
17          private void ConfigureDefaults(OpenIdConnectOptions o)
18          {
19              o.Authority = TestServerBuilder.DefaultAuthority;
20              o.ClientId = "Test Id";
21              o.ClientSecret = "Test Secret";
22              o.SignInScheme = "auth1";
23          }
24          [Fact]
25          public async Task CanForwardDefault()
26          {
27              var services = new ServiceCollection().AddLogging();
28              services.AddAuthentication(o =>
29              {
30                  o.DefaultScheme = OpenIdConnectDefaults.AuthenticationScheme;
31                  o.AddScheme<TestHandler>("auth1", "auth1");
32              })
33              .AddOpenIdConnect(o =>
34              {
35                  ConfigureDefaults(o);
36                  o.ForwardDefault = "auth1";
37              });
38              var forwardDefault = new TestHandler();
39              services.AddSingleton(forwardDefault);
40              var sp = services.BuildServiceProvider();
41              var context = new DefaultHttpContext();
42              context.RequestServices = sp;
<span onclick='openModal()' class='match'>43              Assert.Equal(0, forwardDefault.AuthenticateCount);
44              Assert.Equal(0, forwardDefault.ForbidCount);
45              Assert.Equal(0, forwardDefault.ChallengeCount);
46              Assert.Equal(0, forwardDefault.SignInCount);
47              Assert.Equal(0, forwardDefault.SignOutCount);
48              await context.AuthenticateAsync();
49              Assert.Equal(1, forwardDefault.AuthenticateCount);
50              await context.ForbidAsync();
51              Assert.Equal(1, forwardDefault.ForbidCount);
52              await context.ChallengeAsync();
</span>53              Assert.Equal(1, forwardDefault.ChallengeCount);
54              await context.SignOutAsync();
55              Assert.Equal(1, forwardDefault.SignOutCount);
56              await Assert.ThrowsAsync<InvalidOperationException>(() => context.SignInAsync(new ClaimsPrincipal()));
57          }
58          [Fact]
59          public async Task ForwardSignInThrows()
60          {
61              var services = new ServiceCollection().AddLogging();
62              services.AddAuthentication(o =>
63              {
64                  o.DefaultScheme = OpenIdConnectDefaults.AuthenticationScheme;
65                  o.AddScheme<TestHandler2>("auth1", "auth1");
66                  o.AddScheme<TestHandler>("specific", "specific");
67              })
68              .AddOpenIdConnect(o =>
69              {
70                  ConfigureDefaults(o);
71                  o.ForwardDefault = "auth1";
72                  o.ForwardSignOut = "specific";
73              });
74              var specific = new TestHandler();
75              services.AddSingleton(specific);
76              var forwardDefault = new TestHandler2();
77              services.AddSingleton(forwardDefault);
78              var sp = services.BuildServiceProvider();
79              var context = new DefaultHttpContext();
80              context.RequestServices = sp;
81              await Assert.ThrowsAsync<InvalidOperationException>(() => context.SignInAsync(new ClaimsPrincipal()));
82          }
83          [Fact]
84          public async Task ForwardSignOutWinsOverDefault()
85          {
86              var services = new ServiceCollection().AddLogging();
87              services.AddAuthentication(o =>
88              {
89                  o.DefaultScheme = OpenIdConnectDefaults.AuthenticationScheme;
90                  o.AddScheme<TestHandler2>("auth1", "auth1");
91                  o.AddScheme<TestHandler>("specific", "specific");
92              })
93              .AddOpenIdConnect(o =>
94              {
95                  ConfigureDefaults(o);
96                  o.ForwardDefault = "auth1";
97                  o.ForwardSignOut = "specific";
98              });
99              var specific = new TestHandler();
100              services.AddSingleton(specific);
101              var forwardDefault = new TestHandler2();
102              services.AddSingleton(forwardDefault);
103              var sp = services.BuildServiceProvider();
104              var context = new DefaultHttpContext();
105              context.RequestServices = sp;
106              await context.SignOutAsync();
107              Assert.Equal(1, specific.SignOutCount);
108              Assert.Equal(0, specific.AuthenticateCount);
109              Assert.Equal(0, specific.ForbidCount);
110              Assert.Equal(0, specific.ChallengeCount);
111              Assert.Equal(0, specific.SignInCount);
112              Assert.Equal(0, forwardDefault.AuthenticateCount);
113              Assert.Equal(0, forwardDefault.ForbidCount);
114              Assert.Equal(0, forwardDefault.ChallengeCount);
115              Assert.Equal(0, forwardDefault.SignInCount);
116              Assert.Equal(0, forwardDefault.SignOutCount);
117          }
118          [Fact]
119          public async Task ForwardForbidWinsOverDefault()
120          {
121              var services = new ServiceCollection().AddLogging();
122              services.AddAuthentication(o =>
123              {
124                  o.DefaultScheme = OpenIdConnectDefaults.AuthenticationScheme;
125                  o.AddScheme<TestHandler2>("auth1", "auth1");
126                  o.AddScheme<TestHandler>("specific", "specific");
127              })
128              .AddOpenIdConnect(o =>
129              {
130                  ConfigureDefaults(o);
131                  o.ForwardDefault = "auth1";
132                  o.ForwardForbid = "specific";
133              });
134              var specific = new TestHandler();
135              services.AddSingleton(specific);
136              var forwardDefault = new TestHandler2();
137              services.AddSingleton(forwardDefault);
138              var sp = services.BuildServiceProvider();
139              var context = new DefaultHttpContext();
140              context.RequestServices = sp;
141              await context.ForbidAsync();
142              Assert.Equal(0, specific.SignOutCount);
143              Assert.Equal(0, specific.AuthenticateCount);
144              Assert.Equal(1, specific.ForbidCount);
145              Assert.Equal(0, specific.ChallengeCount);
146              Assert.Equal(0, specific.SignInCount);
147              Assert.Equal(0, forwardDefault.AuthenticateCount);
148              Assert.Equal(0, forwardDefault.ForbidCount);
149              Assert.Equal(0, forwardDefault.ChallengeCount);
150              Assert.Equal(0, forwardDefault.SignInCount);
151              Assert.Equal(0, forwardDefault.SignOutCount);
152          }
153          [Fact]
154          public async Task ForwardAuthenticateWinsOverDefault()
155          {
156              var services = new ServiceCollection().AddLogging();
157              services.AddAuthentication(o =>
158              {
159                  o.DefaultScheme = OpenIdConnectDefaults.AuthenticationScheme;
160                  o.AddScheme<TestHandler2>("auth1", "auth1");
161                  o.AddScheme<TestHandler>("specific", "specific");
162              })
163              .AddOpenIdConnect(o =>
164              {
165                  ConfigureDefaults(o);
166                  o.ForwardDefault = "auth1";
167                  o.ForwardAuthenticate = "specific";
168              });
169              var specific = new TestHandler();
170              services.AddSingleton(specific);
171              var forwardDefault = new TestHandler2();
172              services.AddSingleton(forwardDefault);
173              var sp = services.BuildServiceProvider();
174              var context = new DefaultHttpContext();
175              context.RequestServices = sp;
176              await context.AuthenticateAsync();
177              Assert.Equal(0, specific.SignOutCount);
178              Assert.Equal(1, specific.AuthenticateCount);
179              Assert.Equal(0, specific.ForbidCount);
180              Assert.Equal(0, specific.ChallengeCount);
181              Assert.Equal(0, specific.SignInCount);
182              Assert.Equal(0, forwardDefault.AuthenticateCount);
183              Assert.Equal(0, forwardDefault.ForbidCount);
184              Assert.Equal(0, forwardDefault.ChallengeCount);
185              Assert.Equal(0, forwardDefault.SignInCount);
186              Assert.Equal(0, forwardDefault.SignOutCount);
187          }
188          [Fact]
189          public async Task ForwardChallengeWinsOverDefault()
190          {
191              var services = new ServiceCollection().AddLogging();
192              services.AddAuthentication(o =>
193              {
194                  o.DefaultScheme = OpenIdConnectDefaults.AuthenticationScheme;
195                  o.AddScheme<TestHandler>("specific", "specific");
196                  o.AddScheme<TestHandler2>("auth1", "auth1");
197              })
198              .AddOpenIdConnect(o =>
199              {
200                  ConfigureDefaults(o);
201                  o.ForwardDefault = "auth1";
202                  o.ForwardChallenge = "specific";
203              });
204              var specific = new TestHandler();
205              services.AddSingleton(specific);
206              var forwardDefault = new TestHandler2();
207              services.AddSingleton(forwardDefault);
208              var sp = services.BuildServiceProvider();
209              var context = new DefaultHttpContext();
210              context.RequestServices = sp;
211              await context.ChallengeAsync();
212              Assert.Equal(0, specific.SignOutCount);
213              Assert.Equal(0, specific.AuthenticateCount);
214              Assert.Equal(0, specific.ForbidCount);
215              Assert.Equal(1, specific.ChallengeCount);
216              Assert.Equal(0, specific.SignInCount);
217              Assert.Equal(0, forwardDefault.AuthenticateCount);
218              Assert.Equal(0, forwardDefault.ForbidCount);
219              Assert.Equal(0, forwardDefault.ChallengeCount);
220              Assert.Equal(0, forwardDefault.SignInCount);
221              Assert.Equal(0, forwardDefault.SignOutCount);
222          }
223          [Fact]
224          public async Task ForwardSelectorWinsOverDefault()
225          {
226              var services = new ServiceCollection().AddLogging();
227              services.AddAuthentication(o =>
228              {
229                  o.DefaultScheme = OpenIdConnectDefaults.AuthenticationScheme;
230                  o.AddScheme<TestHandler2>("auth1", "auth1");
231                  o.AddScheme<TestHandler3>("selector", "selector");
232                  o.AddScheme<TestHandler>("specific", "specific");
233              })
234              .AddOpenIdConnect(o =>
235              {
236                  ConfigureDefaults(o);
237                  o.ForwardDefault = "auth1";
238                  o.ForwardDefaultSelector = _ => "selector";
239              });
240              var specific = new TestHandler();
241              services.AddSingleton(specific);
242              var forwardDefault = new TestHandler2();
243              services.AddSingleton(forwardDefault);
244              var selector = new TestHandler3();
245              services.AddSingleton(selector);
246              var sp = services.BuildServiceProvider();
247              var context = new DefaultHttpContext();
248              context.RequestServices = sp;
249              await context.AuthenticateAsync();
250              Assert.Equal(1, selector.AuthenticateCount);
251              await context.ForbidAsync();
252              Assert.Equal(1, selector.ForbidCount);
253              await context.ChallengeAsync();
254              Assert.Equal(1, selector.ChallengeCount);
255              await context.SignOutAsync();
256              Assert.Equal(1, selector.SignOutCount);
257              await Assert.ThrowsAsync<InvalidOperationException>(() => context.SignInAsync(new ClaimsPrincipal()));
258              Assert.Equal(0, forwardDefault.AuthenticateCount);
259              Assert.Equal(0, forwardDefault.ForbidCount);
260              Assert.Equal(0, forwardDefault.ChallengeCount);
261              Assert.Equal(0, forwardDefault.SignInCount);
262              Assert.Equal(0, forwardDefault.SignOutCount);
263              Assert.Equal(0, specific.AuthenticateCount);
264              Assert.Equal(0, specific.ForbidCount);
265              Assert.Equal(0, specific.ChallengeCount);
266              Assert.Equal(0, specific.SignInCount);
267              Assert.Equal(0, specific.SignOutCount);
268          }
269          [Fact]
270          public async Task NullForwardSelectorUsesDefault()
271          {
272              var services = new ServiceCollection().AddLogging();
273              services.AddAuthentication(o =>
274              {
275                  o.DefaultScheme = OpenIdConnectDefaults.AuthenticationScheme;
276                  o.AddScheme<TestHandler2>("auth1", "auth1");
277                  o.AddScheme<TestHandler3>("selector", "selector");
278                  o.AddScheme<TestHandler>("specific", "specific");
279              })
280              .AddOpenIdConnect(o =>
281              {
282                  ConfigureDefaults(o);
283                  o.ForwardDefault = "auth1";
284                  o.ForwardDefaultSelector = _ => null;
285              });
286              var specific = new TestHandler();
287              services.AddSingleton(specific);
288              var forwardDefault = new TestHandler2();
289              services.AddSingleton(forwardDefault);
290              var selector = new TestHandler3();
291              services.AddSingleton(selector);
292              var sp = services.BuildServiceProvider();
293              var context = new DefaultHttpContext();
294              context.RequestServices = sp;
295              await context.AuthenticateAsync();
296              Assert.Equal(1, forwardDefault.AuthenticateCount);
297              await context.ForbidAsync();
298              Assert.Equal(1, forwardDefault.ForbidCount);
299              await context.ChallengeAsync();
300              Assert.Equal(1, forwardDefault.ChallengeCount);
301              await context.SignOutAsync();
302              Assert.Equal(1, forwardDefault.SignOutCount);
303              await Assert.ThrowsAsync<InvalidOperationException>(() => context.SignInAsync(new ClaimsPrincipal()));
304              Assert.Equal(0, selector.AuthenticateCount);
305              Assert.Equal(0, selector.ForbidCount);
306              Assert.Equal(0, selector.ChallengeCount);
307              Assert.Equal(0, selector.SignInCount);
308              Assert.Equal(0, selector.SignOutCount);
309              Assert.Equal(0, specific.AuthenticateCount);
310              Assert.Equal(0, specific.ForbidCount);
311              Assert.Equal(0, specific.ChallengeCount);
312              Assert.Equal(0, specific.SignInCount);
313              Assert.Equal(0, specific.SignOutCount);
314          }
315          [Fact]
316          public async Task SpecificForwardWinsOverSelectorAndDefault()
317          {
318              var services = new ServiceCollection().AddLogging();
319              services.AddAuthentication(o =>
320              {
321                  o.DefaultScheme = OpenIdConnectDefaults.AuthenticationScheme;
322                  o.AddScheme<TestHandler2>("auth1", "auth1");
323                  o.AddScheme<TestHandler3>("selector", "selector");
324                  o.AddScheme<TestHandler>("specific", "specific");
325              })
326              .AddOpenIdConnect(o =>
327              {
328                  ConfigureDefaults(o);
329                  o.ForwardDefault = "auth1";
330                  o.ForwardDefaultSelector = _ => "selector";
331                  o.ForwardAuthenticate = "specific";
332                  o.ForwardChallenge = "specific";
333                  o.ForwardSignIn = "specific";
334                  o.ForwardSignOut = "specific";
335                  o.ForwardForbid = "specific";
336              });
337              var specific = new TestHandler();
338              services.AddSingleton(specific);
339              var forwardDefault = new TestHandler2();
340              services.AddSingleton(forwardDefault);
341              var selector = new TestHandler3();
342              services.AddSingleton(selector);
343              var sp = services.BuildServiceProvider();
344              var context = new DefaultHttpContext();
345              context.RequestServices = sp;
346              await context.AuthenticateAsync();
347              Assert.Equal(1, specific.AuthenticateCount);
348              await context.ForbidAsync();
349              Assert.Equal(1, specific.ForbidCount);
350              await context.ChallengeAsync();
351              Assert.Equal(1, specific.ChallengeCount);
352              await context.SignOutAsync();
353              Assert.Equal(1, specific.SignOutCount);
354              await Assert.ThrowsAsync<InvalidOperationException>(() => context.SignInAsync(new ClaimsPrincipal()));
355              Assert.Equal(0, forwardDefault.AuthenticateCount);
356              Assert.Equal(0, forwardDefault.ForbidCount);
357              Assert.Equal(0, forwardDefault.ChallengeCount);
358              Assert.Equal(0, forwardDefault.SignInCount);
359              Assert.Equal(0, forwardDefault.SignOutCount);
360              Assert.Equal(0, selector.AuthenticateCount);
361              Assert.Equal(0, selector.ForbidCount);
362              Assert.Equal(0, selector.ChallengeCount);
363              Assert.Equal(0, selector.SignInCount);
364              Assert.Equal(0, selector.SignOutCount);
365          }
366          [Fact]
367          public async Task MetadataAddressIsGeneratedFromAuthorityWhenMissing()
368          {
369              var builder = new WebHostBuilder()
370                  .ConfigureServices(services =>
371                  {
372                      services.AddAuthentication()
373                          .AddCookie()
374                          .AddOpenIdConnect(o =>
375                      {
376                          o.Authority = TestServerBuilder.DefaultAuthority;
377                          o.ClientId = Guid.NewGuid().ToString();
378                          o.SignInScheme = Guid.NewGuid().ToString();
379                      });
380                  })
381                  .Configure(app =>
382                  {
383                      app.UseAuthentication();
384                      app.Run(async context =>
385                      {
386                          var resolver = context.RequestServices.GetRequiredService<IAuthenticationHandlerProvider>();
387                          var handler = await resolver.GetHandlerAsync(context, OpenIdConnectDefaults.AuthenticationScheme) as OpenIdConnectHandler;
388                          Assert.Equal($"{TestServerBuilder.DefaultAuthority}/.well-known/openid-configuration", handler.Options.MetadataAddress);
389                      });
390                  });
391              var server = new TestServer(builder);
392              var transaction = await server.SendAsync(@"https:&bsol;&bsol;example.com");
393              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
394          }
395          [Fact]
396          public Task ThrowsWhenSignInSchemeIsSetToSelf()
397          {
398              return TestConfigurationException<InvalidOperationException>(
399                  o =>
400                  {
401                      o.SignInScheme = OpenIdConnectDefaults.AuthenticationScheme;
402                      o.Authority = TestServerBuilder.DefaultAuthority;
403                      o.ClientId = "Test Id";
404                      o.ClientSecret = "Test Secret";
405                  },
406                  ex => Assert.Contains("cannot be set to itself", ex.Message));
407          }
408          [Fact]
409          public Task ThrowsWhenClientIdIsMissing()
410          {
411              return TestConfigurationException<ArgumentException>(
412                  o =>
413                  {
414                      o.SignInScheme = "TestScheme";
415                      o.Authority = TestServerBuilder.DefaultAuthority;
416                  },
417                  ex => Assert.Equal("ClientId", ex.ParamName));
418          }
419          [Fact]
420          public Task ThrowsWhenAuthorityIsMissing()
421          {
422              return TestConfigurationException<InvalidOperationException>(
423                  o =>
424                  {
425                      o.SignInScheme = "TestScheme";
426                      o.ClientId = "Test Id";
427                      o.CallbackPath = "/";
428                  },
429                  ex => Assert.Equal("Provide Authority, MetadataAddress, Configuration, or ConfigurationManager to OpenIdConnectOptions", ex.Message)
430              );
431          }
432          [Fact]
433          public Task ThrowsWhenAuthorityIsNotHttps()
434          {
435              return TestConfigurationException<InvalidOperationException>(
436                  o =>
437                  {
438                      o.SignInScheme = "TestScheme";
439                      o.ClientId = "Test Id";
440                      o.MetadataAddress = "http:&bsol;&bsol;example.com";
441                      o.CallbackPath = "/";
442                  },
443                  ex => Assert.Equal("The MetadataAddress or Authority must use HTTPS unless disabled for development by setting RequireHttpsMetadata=false.", ex.Message)
444              );
445          }
446          [Fact]
447          public Task ThrowsWhenMetadataAddressIsNotHttps()
448          {
449              return TestConfigurationException<InvalidOperationException>(
450                  o =>
451                  {
452                      o.SignInScheme = "TestScheme";
453                      o.ClientId = "Test Id";
454                      o.MetadataAddress = "http:&bsol;&bsol;example.com";
455                      o.CallbackPath = "/";
456                  },
457                  ex => Assert.Equal("The MetadataAddress or Authority must use HTTPS unless disabled for development by setting RequireHttpsMetadata=false.", ex.Message)
458              );
459          }
460          [Fact]
461          public Task ThrowsWhenMaxAgeIsNegative()
462          {
463              return TestConfigurationException<ArgumentOutOfRangeException>(
464                  o =>
465                  {
466                      o.SignInScheme = "TestScheme";
467                      o.ClientId = "Test Id";
468                      o.Authority = TestServerBuilder.DefaultAuthority;
469                      o.MaxAge = TimeSpan.FromSeconds(-1);
470                  },
471                  ex => Assert.StartsWith("The value must not be a negative TimeSpan.", ex.Message)
472              );
473          }
474          private TestServer BuildTestServer(Action<OpenIdConnectOptions> options)
475          {
476              var builder = new WebHostBuilder()
477                  .ConfigureServices(services =>
478                  {
479                      services.AddAuthentication()
480                          .AddCookie()
481                          .AddOpenIdConnect(options);
482                  })
483                  .Configure(app => app.UseAuthentication());
484              return new TestServer(builder);
485          }
486          private async Task TestConfigurationException<T>(
487              Action<OpenIdConnectOptions> options,
488              Action<T> verifyException)
489              where T : Exception
490          {
491              var exception = await Assert.ThrowsAsync<T>(() => BuildTestServer(options).SendAsync(@"https:&bsol;&bsol;example.com"));
492              verifyException(exception);
493          }
494      }
495  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-GitCheck.cs</div>
                <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-OpenIdConnectConfigurationTests.cs</div>
                <div class="column column_space"><pre><code>61                  result.Logs.Add($"{DateTime.UtcNow.ToString("O")} ***************************************************************************************************************");
62                  result.Logs.Add($"{DateTime.UtcNow.ToString("O")} ****                                                                                                       ****");
63                  result.Logs.Add($"{DateTime.UtcNow.ToString("O")} ****     Validate server cert and proxy configuration with Git ");
64                  result.Logs.Add($"{DateTime.UtcNow.ToString("O")} ****                                                                                                       ****");
65                  result.Logs.Add($"{DateTime.UtcNow.ToString("O")} ***************************************************************************************************************");
</pre></code></div>
                <div class="column column_space"><pre><code>43              Assert.Equal(0, forwardDefault.AuthenticateCount);
44              Assert.Equal(0, forwardDefault.ForbidCount);
45              Assert.Equal(0, forwardDefault.ChallengeCount);
46              Assert.Equal(0, forwardDefault.SignInCount);
47              Assert.Equal(0, forwardDefault.SignOutCount);
48              await context.AuthenticateAsync();
49              Assert.Equal(1, forwardDefault.AuthenticateCount);
50              await context.ForbidAsync();
51              Assert.Equal(1, forwardDefault.ForbidCount);
52              await context.ChallengeAsync();
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    