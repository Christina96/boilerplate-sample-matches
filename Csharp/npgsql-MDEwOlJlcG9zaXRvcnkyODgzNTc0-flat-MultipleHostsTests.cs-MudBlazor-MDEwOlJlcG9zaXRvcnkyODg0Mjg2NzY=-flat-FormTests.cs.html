
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 22.505307855626327%, Tokens: 16, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-MultipleHostsTests.cs</h3>
            <pre><code>1  using Npgsql.Internal;
2  using Npgsql.Tests.Support;
3  using NUnit.Framework;
4  using System;
5  using System.Collections.Generic;
6  using System.Data;
7  using System.IO;
8  using System.Linq;
9  using System.Net;
10  using System.Net.Sockets;
11  using System.Runtime.InteropServices;
12  using System.Threading;
13  using System.Threading.Tasks;
14  using System.Transactions;
15  using Npgsql.Properties;
16  using static Npgsql.Tests.Support.MockState;
17  using static Npgsql.Tests.TestUtil;
18  using IsolationLevel = System.Transactions.IsolationLevel;
19  using TransactionStatus = Npgsql.Internal.TransactionStatus;
20  namespace Npgsql.Tests;
21  public class MultipleHostsTests : TestBase
22  {
23      static readonly object[] MyCases =
24      {
25          new object[] { TargetSessionAttributes.Standby,        new[] { Primary,         Standby         }, 1 },
26          new object[] { TargetSessionAttributes.Standby,        new[] { PrimaryReadOnly, Standby         }, 1 },
27          new object[] { TargetSessionAttributes.PreferStandby,  new[] { Primary,         Standby         }, 1 },
28          new object[] { TargetSessionAttributes.PreferStandby,  new[] { PrimaryReadOnly, Standby         }, 1 },
29          new object[] { TargetSessionAttributes.PreferStandby,  new[] { Primary,         Primary         }, 0 },
30          new object[] { TargetSessionAttributes.Primary,        new[] { Standby,         Primary         }, 1 },
31          new object[] { TargetSessionAttributes.Primary,        new[] { Standby,         PrimaryReadOnly }, 1 },
32          new object[] { TargetSessionAttributes.PreferPrimary,  new[] { Standby,         Primary         }, 1 },
33          new object[] { TargetSessionAttributes.PreferPrimary,  new[] { Standby,         PrimaryReadOnly }, 1 },
34          new object[] { TargetSessionAttributes.PreferPrimary,  new[] { Standby,         Standby         }, 0 },
35          new object[] { TargetSessionAttributes.Any,            new[] { Standby,         Primary         }, 0 },
36          new object[] { TargetSessionAttributes.Any,            new[] { Primary,         Standby         }, 0 },
37          new object[] { TargetSessionAttributes.Any,            new[] { PrimaryReadOnly, Standby         }, 0 },
38          new object[] { TargetSessionAttributes.ReadWrite,      new[] { Standby,         Primary         }, 1 },
39          new object[] { TargetSessionAttributes.ReadWrite,      new[] { PrimaryReadOnly, Primary         }, 1 },
40          new object[] { TargetSessionAttributes.ReadOnly,       new[] { Primary,         Standby         }, 1 },
41          new object[] { TargetSessionAttributes.ReadOnly,       new[] { PrimaryReadOnly, Standby         }, 0 }
42      };
43      [Test]
44      [TestCaseSource(nameof(MyCases))]
45      public async Task Connect_to_correct_host_pooled(TargetSessionAttributes targetSessionAttributes, MockState[] servers, int expectedServer)
46      {
47          var postmasters = servers.Select(s => PgPostmasterMock.Start(state: s)).ToArray();
48          await using var __ = new DisposableWrapper(postmasters);
49          var connectionStringBuilder = new NpgsqlConnectionStringBuilder
50          {
51              Host = MultipleHosts(postmasters),
52              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
53              Pooling = true
54          };
55          await using var dataSource = new NpgsqlDataSourceBuilder(connectionStringBuilder.ConnectionString)
56              .BuildMultiHost();
57          await using var conn = await dataSource.OpenConnectionAsync(targetSessionAttributes);
58          Assert.That(conn.Port, Is.EqualTo(postmasters[expectedServer].Port));
59          for (var i = 0; i <= expectedServer; i++)
60              _ = await postmasters[i].WaitForServerConnection();
61      }
62      [Test]
63      [TestCaseSource(nameof(MyCases))]
64      public async Task Connect_to_correct_host_unpooled(TargetSessionAttributes targetSessionAttributes, MockState[] servers, int expectedServer)
65      {
66          var postmasters = servers.Select(s => PgPostmasterMock.Start(state: s)).ToArray();
67          await using var __ = new DisposableWrapper(postmasters);
68          var connectionStringBuilder = new NpgsqlConnectionStringBuilder
69          {
70              Host = MultipleHosts(postmasters),
71              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
72              Pooling = false
73          };
74          await using var dataSource = new NpgsqlDataSourceBuilder(connectionStringBuilder.ConnectionString)
75              .BuildMultiHost();
76          await using var conn = await dataSource.OpenConnectionAsync(targetSessionAttributes);
77          Assert.That(conn.Port, Is.EqualTo(postmasters[expectedServer].Port));
78          for (var i = 0; i <= expectedServer; i++)
79              _ = await postmasters[i].WaitForServerConnection();
80      }
81      [Test]
82      [TestCaseSource(nameof(MyCases))]
83      public async Task Connect_to_correct_host_with_available_idle(
84          TargetSessionAttributes targetSessionAttributes, MockState[] servers, int expectedServer)
85      {
86          var postmasters = servers.Select(s => PgPostmasterMock.Start(state: s)).ToArray();
87          await using var __ = new DisposableWrapper(postmasters);
88          var connectionStringBuilder = new NpgsqlConnectionStringBuilder
89          {
90              Host = MultipleHosts(postmasters),
91              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
92          };
93          await using var dataSource = new NpgsqlDataSourceBuilder(connectionStringBuilder.ConnectionString)
94              .BuildMultiHost();
95          var idleConnTargetSessionAttributes = servers[0] switch
96          {
97              Primary => TargetSessionAttributes.ReadWrite,
98              PrimaryReadOnly => TargetSessionAttributes.ReadOnly,
99              Standby => TargetSessionAttributes.Standby,
100              _ => throw new ArgumentOutOfRangeException()
101          };
102          await using (_ = await dataSource.OpenConnectionAsync(idleConnTargetSessionAttributes))
103          {
104          }
105          await using var conn = await dataSource.OpenConnectionAsync(targetSessionAttributes);
106          Assert.That(conn.Port, Is.EqualTo(postmasters[expectedServer].Port));
107          for (var i = 0; i <= expectedServer; i++)
108              _ = await postmasters[i].WaitForServerConnection();
109      }
110      [Test]
111      [TestCase(TargetSessionAttributes.Standby,   new[] { Primary,         Primary })]
112      [TestCase(TargetSessionAttributes.Primary,   new[] { Standby,         Standby })]
113      [TestCase(TargetSessionAttributes.ReadWrite, new[] { PrimaryReadOnly, Standby })]
114      [TestCase(TargetSessionAttributes.ReadOnly,  new[] { Primary,         Primary })]
115      public async Task Valid_host_not_found(TargetSessionAttributes targetSessionAttributes, MockState[] servers)
116      {
117          var postmasters = servers.Select(s => PgPostmasterMock.Start(state: s)).ToArray();
118          await using var __ = new DisposableWrapper(postmasters);
119          var connectionStringBuilder = new NpgsqlConnectionStringBuilder
120          {
121              Host = MultipleHosts(postmasters),
122              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
123          };
124          await using var dataSource = new NpgsqlDataSourceBuilder(connectionStringBuilder.ConnectionString)
125              .BuildMultiHost();
126          var exception = Assert.ThrowsAsync<NpgsqlException>(async () => await dataSource.OpenConnectionAsync(targetSessionAttributes))!;
127          Assert.That(exception.Message, Is.EqualTo("No suitable host was found."));
128          Assert.That(exception.InnerException, Is.Null);
129          for (var i = 0; i < servers.Length; i++)
130              _ = await postmasters[i].WaitForServerConnection();
131      }
132      [Test, Platform(Exclude = "MacOsX", Reason = "#3786")]
133      public void All_hosts_are_down()
134      {
135          if (RuntimeInformation.FrameworkDescription.StartsWith(".NET Core 3.1"))
136              return;
137          var endpoint = new IPEndPoint(IPAddress.Loopback, 0);
138          using var socket1 = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
139          socket1.Bind(endpoint);
140          var localEndPoint1 = (IPEndPoint)socket1.LocalEndPoint!;
141          using var socket2 = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
142          socket2.Bind(endpoint);
143          var localEndPoint2 = (IPEndPoint)socket2.LocalEndPoint!;
144          var connectionString = new NpgsqlConnectionStringBuilder
145          {
146              Host = $"{localEndPoint1.Address}:{localEndPoint1.Port},{localEndPoint2.Address}:{localEndPoint2.Port}"
147          }.ConnectionString;
148          using var dataSource = new NpgsqlDataSourceBuilder(connectionString).BuildMultiHost();
149          var exception = Assert.ThrowsAsync<NpgsqlException>(async () => await dataSource.OpenConnectionAsync(TargetSessionAttributes.Any))!;
150          var aggregateException = (AggregateException)exception.InnerException!;
151          Assert.That(aggregateException.InnerExceptions, Has.Count.EqualTo(2));
152          for (var i = 0; i < aggregateException.InnerExceptions.Count; i++)
153          {
154              Assert.That(aggregateException.InnerExceptions[i], Is.TypeOf<NpgsqlException>()
155                  .With.InnerException.TypeOf<SocketException>()
156                  .With.InnerException.Property(nameof(SocketException.SocketErrorCode)).EqualTo(SocketError.ConnectionRefused));
157          }
158      }
159      [Test]
160      public async Task All_hosts_are_unavailable(
161          [Values] bool pooling,
162          [Values(PostgresErrorCodes.InvalidCatalogName, PostgresErrorCodes.CannotConnectNow)] string errorCode)
163      {
164          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary, startupErrorCode: errorCode);
165          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby, startupErrorCode: errorCode);
166          var builder = new NpgsqlConnectionStringBuilder
167          {
168              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
169              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
170              Pooling = pooling,
171          };
172          await using var dataSource = new NpgsqlDataSourceBuilder(builder.ConnectionString).BuildMultiHost();
173          var ex = Assert.ThrowsAsync<PostgresException>(async () => await dataSource.OpenConnectionAsync(TargetSessionAttributes.Any))!;
174          Assert.That(ex.SqlState, Is.EqualTo(errorCode));
175      }
176      [Test]
177      [Platform(Exclude = "MacOsX", Reason = "Flaky in CI on Mac")]
178      public async Task First_host_is_down()
179      {
180          using var socket = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
181          var endpoint = new IPEndPoint(IPAddress.Loopback, 0);
182          socket.Bind(endpoint);
183          var localEndPoint = (IPEndPoint)socket.LocalEndPoint!;
184          await using var postmaster = PgPostmasterMock.Start(state: Primary);
185          var connectionString = new NpgsqlConnectionStringBuilder
186          {
187              Host = $"{localEndPoint.Address}:{localEndPoint.Port},{postmaster.Host}:{postmaster.Port}",
188              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading
189          }.ConnectionString;
190          await using var dataSource = new NpgsqlDataSourceBuilder(connectionString).BuildMultiHost();
191          await using var conn = await dataSource.OpenConnectionAsync(TargetSessionAttributes.Any);
192          Assert.That(conn.Port, Is.EqualTo(postmaster.Port));
193      }
194      [Test]
195      [TestCase("any")]
196      [TestCase("primary")]
197      [TestCase("standby")]
198      [TestCase("prefer-primary")]
199      [TestCase("prefer-standby")]
200      [TestCase("read-write")]
201      [TestCase("read-only")]
202      public async Task TargetSessionAttributes_with_single_host(string targetSessionAttributes)
203      {
204          var connectionString = new NpgsqlConnectionStringBuilder(ConnectionString)
205          {
206              TargetSessionAttributes = targetSessionAttributes
207          }.ConnectionString;
208          if (targetSessionAttributes == "any")
209          {
210              await using var postmasterMock = PgPostmasterMock.Start(ConnectionString);
211              using var pool = CreateTempPool(postmasterMock.ConnectionString, out connectionString);
212              await using var conn = new NpgsqlConnection(connectionString);
213              await conn.OpenAsync();
214              _ = await postmasterMock.WaitForServerConnection();
215          }
216          else
217          {
218              Assert.That(() => new NpgsqlConnection(connectionString), Throws.Exception.TypeOf<NotSupportedException>());
219          }
220      }
221      [Test]
222      public void TargetSessionAttributes_default_is_null()
223          => Assert.That(new NpgsqlConnectionStringBuilder().TargetSessionAttributes, Is.Null);
224      [Test]
225      [NonParallelizable] 
226      public async Task TargetSessionAttributes_uses_environment_variable()
227      {
228          using var envVarResetter = SetEnvironmentVariable("PGTARGETSESSIONATTRS", "prefer-standby");
229          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary);
230          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby);
231          var builder = new NpgsqlConnectionStringBuilder
232          {
233              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
234              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading
235          };
236          Assert.That(builder.TargetSessionAttributes, Is.Null);
237          await using var dataSource = new NpgsqlDataSourceBuilder(builder.ConnectionString)
238              .BuildMultiHost();
239          await using var conn = await dataSource.OpenConnectionAsync();
240          Assert.That(conn.Port, Is.EqualTo(standbyPostmaster.Port));
241      }
242      [Test]
243      public void TargetSessionAttributes_invalid_throws()
244          => Assert.Throws<ArgumentException>(() =>
245              new NpgsqlConnectionStringBuilder
246              {
247                  TargetSessionAttributes = nameof(TargetSessionAttributes_invalid_throws)
248              });
249      [Test]
250      public void HostRecheckSeconds_default_value()
251      {
252          var builder = new NpgsqlConnectionStringBuilder();
253          Assert.That(builder.HostRecheckSeconds, Is.EqualTo(10));
254          Assert.That(builder.HostRecheckSecondsTranslated, Is.EqualTo(TimeSpan.FromSeconds(10)));
255      }
256      [Test]
257      public void HostRecheckSeconds_zero_value()
258      {
259          var builder = new NpgsqlConnectionStringBuilder
260          {
261              HostRecheckSeconds = 0,
262          };
263          Assert.That(builder.HostRecheckSeconds, Is.EqualTo(0));
264          Assert.That(builder.HostRecheckSecondsTranslated, Is.EqualTo(TimeSpan.FromSeconds(-1)));
265      }
266      [Test]
267      public void HostRecheckSeconds_invalid_throws()
268          => Assert.Throws<ArgumentException>(() =>
269              new NpgsqlConnectionStringBuilder
270              {
271                  HostRecheckSeconds = -1
272              });
273      [Test]
274      public async Task Connect_with_load_balancing()
275      {
276          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary);
277          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby);
278          var defaultCsb = new NpgsqlConnectionStringBuilder
279          {
280              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
281              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
282              MaxPoolSize = 1,
283              LoadBalanceHosts = true,
284          };
285          await using var dataSource = new NpgsqlDataSourceBuilder(defaultCsb.ConnectionString)
286              .BuildMultiHost();
287          NpgsqlConnector firstConnector;
288          NpgsqlConnector secondConnector;
289          await using (var firstConnection = await dataSource.OpenConnectionAsync())
290          {
291              firstConnector = firstConnection.Connector!;
292          }
293          await using (var secondConnection = await dataSource.OpenConnectionAsync())
294          {
295              secondConnector = secondConnection.Connector!;
296          }
297          Assert.AreNotSame(firstConnector, secondConnector);
298          await using (var firstBalancedConnection = await dataSource.OpenConnectionAsync())
299          {
300              Assert.AreSame(firstConnector, firstBalancedConnection.Connector);
301          }
302          await using (var secondBalancedConnection = await dataSource.OpenConnectionAsync())
303          {
304              Assert.AreSame(secondConnector, secondBalancedConnection.Connector);
305          }
306          await using (var thirdBalancedConnection = await dataSource.OpenConnectionAsync())
307          {
308              Assert.AreSame(firstConnector, thirdBalancedConnection.Connector);
309          }
310      }
311      [Test]
312      public async Task Connect_without_load_balancing()
313      {
314          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary);
315          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby);
316          var defaultCsb = new NpgsqlConnectionStringBuilder
317          {
318              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
319              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
320              MaxPoolSize = 1,
321              LoadBalanceHosts = false,
322          };
323          await using var dataSource = new NpgsqlDataSourceBuilder(defaultCsb.ConnectionString)
324              .BuildMultiHost();
325          NpgsqlConnector firstConnector;
326          NpgsqlConnector secondConnector;
327          await using (var firstConnection = await dataSource.OpenConnectionAsync())
328          {
329              firstConnector = firstConnection.Connector!;
330          }
331          await using (var secondConnection = await dataSource.OpenConnectionAsync())
332          {
333              Assert.AreSame(firstConnector, secondConnection.Connector);
334          }
335          await using (var firstConnection = await dataSource.OpenConnectionAsync())
336          await using (var secondConnection = await dataSource.OpenConnectionAsync())
337          {
338              secondConnector = secondConnection.Connector!;
339          }
340          Assert.AreNotSame(firstConnector, secondConnector);
341          await using (var firstUnbalancedConnection = await dataSource.OpenConnectionAsync())
342          {
343              Assert.AreSame(firstConnector, firstUnbalancedConnection.Connector);
344          }
345          await using (var secondUnbalancedConnection = await dataSource.OpenConnectionAsync())
346          {
347              Assert.AreSame(firstConnector, secondUnbalancedConnection.Connector);
348          }
349      }
350      [Test]
351      public async Task Connect_state_changing_hosts([Values] bool alwaysCheckHostState)
352      {
353          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary);
354          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby);
355          var defaultCsb = new NpgsqlConnectionStringBuilder
356          {
357              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
358              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
359              MaxPoolSize = 1,
360              HostRecheckSeconds = alwaysCheckHostState ? 0 : int.MaxValue,
361              NoResetOnClose = true,
362          };
363          await using var dataSource = new NpgsqlDataSourceBuilder(defaultCsb.ConnectionString)
364              .BuildMultiHost();
365          NpgsqlConnector firstConnector;
366          NpgsqlConnector secondConnector;
367          var firstServerTask = Task.Run(async () =>
368          {
369              var server = await primaryPostmaster.WaitForServerConnection();
370              if (!alwaysCheckHostState)
371                  return;
372              await server.SendMockState(Primary);
373              await server.SendMockState(Standby);
374          });
375          var secondServerTask = Task.Run(async () =>
376          {
377              var server = await standbyPostmaster.WaitForServerConnection();
378              if (!alwaysCheckHostState)
379                  return;
380              await server.SendMockState(Standby);
381              await server.SendMockState(Standby);
382              await server.SendMockState(Primary);
383          });
384          await using (var firstConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.PreferPrimary))
385          await using (var secondConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.PreferPrimary))
386          {
387              firstConnector = firstConnection.Connector!;
388              secondConnector = secondConnection.Connector!;
389          }
390          await using var thirdConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.PreferPrimary);
391          Assert.AreSame(alwaysCheckHostState ? secondConnector : firstConnector, thirdConnection.Connector);
392          await firstServerTask;
393          await secondServerTask;
394      }
395      [Test]
396      public void Database_state_cache_basic()
397      {
398          using var dataSource = CreateDataSource();
399          var timeStamp = DateTime.UtcNow;
400          dataSource.UpdateDatabaseState(DatabaseState.PrimaryReadWrite, timeStamp, TimeSpan.Zero);
401          Assert.AreEqual(DatabaseState.PrimaryReadWrite, dataSource.GetDatabaseState());
402          dataSource.UpdateDatabaseState(DatabaseState.Standby, timeStamp, TimeSpan.Zero);
403          Assert.AreEqual(DatabaseState.PrimaryReadWrite, dataSource.GetDatabaseState());
404          timeStamp = timeStamp.AddSeconds(1);
405          dataSource.UpdateDatabaseState(DatabaseState.PrimaryReadOnly, timeStamp, TimeSpan.Zero);
406          Assert.AreEqual(DatabaseState.PrimaryReadOnly, dataSource.GetDatabaseState());
407          timeStamp = timeStamp.AddSeconds(1);
408          dataSource.UpdateDatabaseState(DatabaseState.PrimaryReadWrite, timeStamp, TimeSpan.FromSeconds(-1));
409          Assert.AreEqual(DatabaseState.Unknown, dataSource.GetDatabaseState(ignoreExpiration: false));
410          Assert.AreEqual(DatabaseState.PrimaryReadWrite, dataSource.GetDatabaseState(ignoreExpiration: true));
411      }
412      [Test]
413      public async Task Offline_state_on_connection_failure()
414      {
415          await using var server = PgPostmasterMock.Start(ConnectionString, startupErrorCode: PostgresErrorCodes.ConnectionFailure);
416          await using var dataSource = server.CreateDataSource();
417          await using var conn = dataSource.CreateConnection();
418          var ex = Assert.ThrowsAsync<PostgresException>(conn.OpenAsync)!;
419          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.ConnectionFailure));
420          var state = conn.NpgsqlDataSource.GetDatabaseState();
421          Assert.That(state, Is.EqualTo(DatabaseState.Offline));
422      }
423      [Test]
424      public async Task Unknown_state_on_connection_authentication_failure()
425      {
426          await using var server = PgPostmasterMock.Start(ConnectionString, startupErrorCode: PostgresErrorCodes.InvalidAuthorizationSpecification);
427          await using var dataSource = server.CreateDataSource();
428          await using var conn = dataSource.CreateConnection();
429          var ex = Assert.ThrowsAsync<PostgresException>(conn.OpenAsync)!;
<span onclick='openModal()' class='match'>430          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.InvalidAuthorizationSpecification));
431          var state = conn.NpgsqlDataSource.GetDatabaseState();
432          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
433      }
434      [Test]
435      public async Task Offline_state_on_query_execution_pg_critical_failure()
436      {
437          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
438          await using var dataSource = postmaster.CreateDataSource();
439          await using var conn = await dataSource.OpenConnectionAsync();
440          await using var anotherConn = await dataSource.OpenConnectionAsync();
441          await anotherConn.CloseAsync();
</span>442          var state = conn.NpgsqlDataSource.GetDatabaseState();
443          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
444          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
445          var server = await postmaster.WaitForServerConnection();
446          await server.WriteErrorResponse(PostgresErrorCodes.CrashShutdown).FlushAsync();
447          var ex = Assert.ThrowsAsync<PostgresException>(() => conn.ExecuteNonQueryAsync("SELECT 1"))!;
448          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.CrashShutdown));
449          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
450          state = conn.NpgsqlDataSource.GetDatabaseState();
451          Assert.That(state, Is.EqualTo(DatabaseState.Offline));
452          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(0));
453      }
454      [Test, NonParallelizable]
455      public async Task Offline_state_on_query_execution_pg_non_critical_failure()
456      {
457          await using var dataSource = CreateDataSource();
458          await using var conn = await dataSource.OpenConnectionAsync();
459          var expectedState = conn.PostgreSqlVersion.Major > 13 ? DatabaseState.PrimaryReadWrite : DatabaseState.Unknown;
460          var state = dataSource.GetDatabaseState();
461          Assert.That(state, Is.EqualTo(expectedState));
462          Assert.That(dataSource.Statistics.Total, Is.EqualTo(1));
463          var ex = Assert.ThrowsAsync<PostgresException>(() => conn.ExecuteNonQueryAsync("SELECT abc"))!;
464          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.UndefinedColumn));
465          Assert.That(conn.State, Is.EqualTo(ConnectionState.Open));
466          state = dataSource.GetDatabaseState();
467          Assert.That(state, Is.EqualTo(expectedState));
468          Assert.That(dataSource.Statistics.Total, Is.EqualTo(1));
469      }
470      [Test]
471      public async Task Offline_state_on_query_execution_IOException()
472      {
473          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
474          await using var dataSource = postmaster.CreateDataSource();
475          await using var conn = await dataSource.OpenConnectionAsync();
476          await using var anotherConn = await dataSource.OpenConnectionAsync();
477          await anotherConn.CloseAsync();
478          var state = conn.NpgsqlDataSource.GetDatabaseState();
479          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
480          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
481          var server = await postmaster.WaitForServerConnection();
482          server.Close();
483          var ex = Assert.ThrowsAsync<NpgsqlException>(() => conn.ExecuteNonQueryAsync("SELECT 1"))!;
484          Assert.That(ex.InnerException, Is.InstanceOf<IOException>());
485          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
486          state = conn.NpgsqlDataSource.GetDatabaseState();
487          Assert.That(state, Is.EqualTo(DatabaseState.Offline));
488          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(0));
489      }
490      [Test]
491      public async Task Offline_state_on_query_execution_TimeoutException()
492      {
493          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
494          var dataSourceBuilder = postmaster.GetDataSourceBuilder();
495          dataSourceBuilder.ConnectionStringBuilder.CommandTimeout = 1;
496          dataSourceBuilder.ConnectionStringBuilder.CancellationTimeout = 1;
497          await using var dataSource = dataSourceBuilder.Build();
498          await using var conn = await dataSource.OpenConnectionAsync();
499          await using var anotherConn = await dataSource.OpenConnectionAsync();
500          await anotherConn.CloseAsync();
501          var state = conn.NpgsqlDataSource.GetDatabaseState();
502          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
503          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
504          var ex = Assert.ThrowsAsync<NpgsqlException>(() => conn.ExecuteNonQueryAsync("SELECT 1"))!;
505          Assert.That(ex.InnerException, Is.TypeOf<TimeoutException>());
506          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
507          state = conn.NpgsqlDataSource.GetDatabaseState();
508          Assert.That(state, Is.EqualTo(DatabaseState.Offline));
509          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(0));
510      }
511      [Test]
512      public async Task Unknown_state_on_query_execution_TimeoutException_with_disabled_cancellation()
513      {
514          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
515          var dataSourceBuilder = postmaster.GetDataSourceBuilder();
516          dataSourceBuilder.ConnectionStringBuilder.CommandTimeout = 1;
517          dataSourceBuilder.ConnectionStringBuilder.CancellationTimeout = -1;
518          await using var dataSource = dataSourceBuilder.Build();
519          await using var conn = await dataSource.OpenConnectionAsync();
520          await using var anotherConn = await dataSource.OpenConnectionAsync();
521          await anotherConn.CloseAsync();
522          var state = conn.NpgsqlDataSource.GetDatabaseState();
523          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
524          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
525          var ex = Assert.ThrowsAsync<NpgsqlException>(() => conn.ExecuteNonQueryAsync("SELECT 1"))!;
526          Assert.That(ex.InnerException, Is.TypeOf<TimeoutException>());
527          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
528          state = conn.NpgsqlDataSource.GetDatabaseState();
529          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
530          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
531      }
532      [Test]
533      public async Task Unknown_state_on_query_execution_cancellation_with_disabled_cancellation_timeout()
534      {
535          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
536          var dataSourceBuilder = postmaster.GetDataSourceBuilder();
537          dataSourceBuilder.ConnectionStringBuilder.CommandTimeout = 30;
538          dataSourceBuilder.ConnectionStringBuilder.CancellationTimeout = -1;
539          await using var dataSource = dataSourceBuilder.Build();
540          await using var conn = await dataSource.OpenConnectionAsync();
541          await using var anotherConn = await dataSource.OpenConnectionAsync();
542          await anotherConn.CloseAsync();
543          var state = conn.NpgsqlDataSource.GetDatabaseState();
544          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
545          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
546          using var cts = new CancellationTokenSource();
547          var query = conn.ExecuteNonQueryAsync("SELECT 1", cancellationToken: cts.Token);
548          cts.Cancel();
549          var ex = Assert.ThrowsAsync<OperationCanceledException>(async () => await query)!;
550          Assert.That(ex.InnerException, Is.TypeOf<TimeoutException>());
551          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
552          state = conn.NpgsqlDataSource.GetDatabaseState();
553          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
554          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
555      }
556      [Test]
557      public async Task Unknown_state_on_query_execution_TimeoutException_with_cancellation_failure()
558      {
559          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
560          var dataSourceBuilder = postmaster.GetDataSourceBuilder();
561          dataSourceBuilder.ConnectionStringBuilder.CommandTimeout = 1;
562          dataSourceBuilder.ConnectionStringBuilder.CancellationTimeout = 0;
563          await using var dataSource = dataSourceBuilder.Build();
564          await using var conn = await dataSource.OpenConnectionAsync();
565          var state = conn.NpgsqlDataSource.GetDatabaseState();
566          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
567          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
568          var server = await postmaster.WaitForServerConnection();
569          var query = conn.ExecuteNonQueryAsync("SELECT 1");
570          await postmaster.WaitForCancellationRequest();
571          await server.WriteCancellationResponse().WriteReadyForQuery().FlushAsync();
572          var ex = Assert.ThrowsAsync<NpgsqlException>(async () => await query)!;
573          Assert.That(ex.InnerException, Is.TypeOf<TimeoutException>());
574          Assert.That(conn.State, Is.EqualTo(ConnectionState.Open));
575          state = conn.NpgsqlDataSource.GetDatabaseState();
576          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
577          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
578      }
579      [Test]
580      public async Task Clear_pool_one_host_only_on_admin_shutdown()
581      {
582          await using var primaryPostmaster = PgPostmasterMock.Start(ConnectionString, state: Primary);
583          await using var standbyPostmaster = PgPostmasterMock.Start(ConnectionString, state: Standby);
584          var dataSourceBuilder = new NpgsqlDataSourceBuilder
585          {
586              ConnectionStringBuilder =
587              {
588                  Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
589                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
590                  MaxPoolSize = 2
591              }
592          };
593          await using var multiHostDataSource = dataSourceBuilder.BuildMultiHost();
594          await using var preferPrimaryDataSource = multiHostDataSource.WithTargetSession(TargetSessionAttributes.PreferPrimary);
595          await using var primaryConn = await preferPrimaryDataSource.OpenConnectionAsync();
596          await using var anotherPrimaryConn = await preferPrimaryDataSource.OpenConnectionAsync();
597          await using var standbyConn = await preferPrimaryDataSource.OpenConnectionAsync();
598          var primaryDataSource = primaryConn.Connector!.DataSource;
599          var standbyDataSource = standbyConn.Connector!.DataSource;
600          await anotherPrimaryConn.CloseAsync();
601          await standbyConn.CloseAsync();
602          Assert.That(primaryDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.PrimaryReadWrite));
603          Assert.That(standbyDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Standby));
604          Assert.That(primaryConn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(3));
605          var server = await primaryPostmaster.WaitForServerConnection();
606          await server.WriteErrorResponse(PostgresErrorCodes.AdminShutdown).FlushAsync();
607          var ex = Assert.ThrowsAsync<PostgresException>(() => primaryConn.ExecuteNonQueryAsync("SELECT 1"))!;
608          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.AdminShutdown));
609          Assert.That(primaryConn.State, Is.EqualTo(ConnectionState.Closed));
610          Assert.That(primaryDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Offline));
611          Assert.That(standbyDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Standby));
612          Assert.That(primaryConn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
613          multiHostDataSource.ClearDatabaseStates();
614          Assert.That(primaryDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Unknown));
615          Assert.That(standbyDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Unknown));
616      }
617      [Test]
618      [TestCase("any", true)]
619      [TestCase("primary", true)]
620      [TestCase("standby", false)]
621      [TestCase("prefer-primary", true)]
622      [TestCase("prefer-standby", false)]
623      [TestCase("read-write", true)]
624      [TestCase("read-only", false)]
625      public async Task Transaction_enlist_reuses_connection(string targetSessionAttributes, bool primary)
626      {
627          await using var primaryPostmaster = PgPostmasterMock.Start(ConnectionString, state: Primary);
628          await using var standbyPostmaster = PgPostmasterMock.Start(ConnectionString, state: Standby);
629          var csb = new NpgsqlConnectionStringBuilder
630          {
631              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
632              TargetSessionAttributes = targetSessionAttributes,
633              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
634              MaxPoolSize = 10,
635          };
636          using var _ = CreateTempPool(csb, out var connString);
637          using var scope = new TransactionScope(TransactionScopeOption.Required,
638              new TransactionOptions { IsolationLevel = IsolationLevel.ReadCommitted }, TransactionScopeAsyncFlowOption.Enabled);
639          var query1Task = Query(connString);
640          var server = primary
641              ? await primaryPostmaster.WaitForServerConnection()
642              : await standbyPostmaster.WaitForServerConnection();
643          await server
644              .WriteCommandComplete()
645              .WriteReadyForQuery(TransactionStatus.InTransactionBlock)
646              .WriteParseComplete()
647              .WriteBindComplete()
648              .WriteNoData()
649              .WriteCommandComplete()
650              .WriteReadyForQuery(TransactionStatus.InTransactionBlock)
651              .FlushAsync();
652          await query1Task;
653          var query2Task = Query(connString);
654          await server
655              .WriteParseComplete()
656              .WriteBindComplete()
657              .WriteNoData()
658              .WriteCommandComplete()
659              .WriteReadyForQuery(TransactionStatus.InTransactionBlock)
660              .FlushAsync();
661          await query2Task;
662          await server
663              .WriteCommandComplete()
664              .WriteReadyForQuery()
665              .FlushAsync();
666          scope.Complete();
667          async Task Query(string connectionString)
668          {
669              await using var conn = new NpgsqlConnection(connectionString);
670              await conn.OpenAsync();
671              await using var cmd = conn.CreateCommand();
672              cmd.CommandText = "SELECT 1";
673              await cmd.ExecuteNonQueryAsync();
674          }
675      }
676      [Test]
677      public async Task Primary_host_failover_can_connect()
678      {
679          await using var firstPostmaster = PgPostmasterMock.Start(ConnectionString, state: Primary);
680          await using var secondPostmaster = PgPostmasterMock.Start(ConnectionString, state: Standby);
681          var dataSourceBuilder = new NpgsqlDataSourceBuilder
682          {
683              ConnectionStringBuilder =
684              {
685                  Host = MultipleHosts(firstPostmaster, secondPostmaster),
686                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
687                  HostRecheckSeconds = 5
688              }
689          };
690          await using var multiHostDataSource = dataSourceBuilder.BuildMultiHost();
691          var (firstDataSource, secondDataSource) = (multiHostDataSource.Pools[0], multiHostDataSource.Pools[1]);
692          await using var primaryDataSource = multiHostDataSource.WithTargetSession(TargetSessionAttributes.Primary);
693          await using var conn = await primaryDataSource.OpenConnectionAsync();
694          Assert.That(conn.Port, Is.EqualTo(firstPostmaster.Port));
695          var firstServer = await firstPostmaster.WaitForServerConnection();
696          await firstServer
697              .WriteErrorResponse(PostgresErrorCodes.AdminShutdown)
698              .FlushAsync();
699          var failoverEx = Assert.ThrowsAsync<PostgresException>(async () => await conn.ExecuteNonQueryAsync("SELECT 1"))!;
700          Assert.That(failoverEx.SqlState, Is.EqualTo(PostgresErrorCodes.AdminShutdown));
701          var noHostFoundEx = Assert.ThrowsAsync<NpgsqlException>(async () => await conn.OpenAsync())!;
702          Assert.That(noHostFoundEx.Message, Is.EqualTo("No suitable host was found."));
703          Assert.That(firstDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Offline));
704          Assert.That(secondDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Standby));
705          firstPostmaster.State = Standby;
706          secondPostmaster.State = Primary;
707          var secondServer = await secondPostmaster.WaitForServerConnection();
708          await secondServer.SendMockState(Primary);
709          await Task.Delay(TimeSpan.FromSeconds(10));
710          Assert.That(firstDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Unknown));
711          Assert.That(secondDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Unknown));
712          await conn.OpenAsync();
713          Assert.That(conn.Port, Is.EqualTo(secondPostmaster.Port));
714          Assert.That(firstDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Standby));
715          Assert.That(secondDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.PrimaryReadWrite));
716      }
717      [Test, NonParallelizable]
718      public void IntegrationTest([Values] bool loadBalancing, [Values] bool alwaysCheckHostState)
719      {
720          PoolManager.Reset();
721          var dataSourceBuilder = new NpgsqlDataSourceBuilder(ConnectionString)
722          {
723              ConnectionStringBuilder =
724              {
725                  Host = "localhost,127.0.0.1",
726                  Pooling = true,
727                  MaxPoolSize = 2,
728                  LoadBalanceHosts = loadBalancing,
729                  HostRecheckSeconds = alwaysCheckHostState ? 0 : 10,
730              }
731          };
732          using var dataSource = dataSourceBuilder.BuildMultiHost();
733          var queriesDone = 0;
734          var clientsTask = Task.WhenAll(
735              Client(dataSource, TargetSessionAttributes.Any),
736              Client(dataSource, TargetSessionAttributes.Primary),
737              Client(dataSource, TargetSessionAttributes.PreferPrimary),
738              Client(dataSource, TargetSessionAttributes.PreferStandby),
739              Client(dataSource, TargetSessionAttributes.ReadWrite));
740          var onlyStandbyClient = Client(dataSource, TargetSessionAttributes.Standby);
741          var readOnlyClient = Client(dataSource, TargetSessionAttributes.ReadOnly);
742          Assert.DoesNotThrowAsync(() => clientsTask);
743          Assert.ThrowsAsync<NpgsqlException>(() => onlyStandbyClient);
744          Assert.ThrowsAsync<NpgsqlException>(() => readOnlyClient);
745          Assert.AreEqual(125, queriesDone);
746          Task Client(NpgsqlMultiHostDataSource multiHostDataSource, TargetSessionAttributes targetSessionAttributes)
747          {
748              var dataSource = multiHostDataSource.WithTargetSession(targetSessionAttributes);
749              var tasks = new List<Task>(5);
750              for (var i = 0; i < 5; i++)
751              {
752                  tasks.Add(Task.Run(() => Query(dataSource)));
753              }
754              return Task.WhenAll(tasks);
755          }
756          async Task Query(NpgsqlDataSource dataSource)
757          {
758              await using var conn = dataSource.CreateConnection();
759              for (var i = 0; i < 5; i++)
760              {
761                  await conn.OpenAsync();
762                  await conn.ExecuteNonQueryAsync("SELECT 1");
763                  await conn.CloseAsync();
764                  Interlocked.Increment(ref queriesDone);
765              }
766          }
767      }
768      [Test]
769      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/5055")]
770      [NonParallelizable] 
771      public async Task Multiple_hosts_with_disabled_sql_rewriting()
772      {
773          using var _ = DisableSqlRewriting();
774          var dataSourceBuilder = new NpgsqlDataSourceBuilder(ConnectionString)
775          {
776              ConnectionStringBuilder =
777              {
778                  Host = "localhost,127.0.0.1",
779                  Pooling = true,
780                  HostRecheckSeconds = 0
781              }
782          };
783          await using var dataSource = dataSourceBuilder.BuildMultiHost();
784          await using var conn = await dataSource.OpenConnectionAsync();
785      }
786      [Test]
787      public async Task DataSource_with_wrappers()
788      {
789          await using var primaryPostmasterMock = PgPostmasterMock.Start(state: Primary);
790          await using var standbyPostmasterMock = PgPostmasterMock.Start(state: Standby);
791          var builder = new NpgsqlDataSourceBuilder
792          {
793              ConnectionStringBuilder =
794              {
795                  Host = MultipleHosts(primaryPostmasterMock, standbyPostmasterMock),
796                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
797              }
798          };
799          await using var dataSource = builder.BuildMultiHost();
800          await using var primaryDataSource = dataSource.WithTargetSession(TargetSessionAttributes.Primary);
801          await using var standbyDataSource = dataSource.WithTargetSession(TargetSessionAttributes.Standby);
802          await using var primaryConnection = await primaryDataSource.OpenConnectionAsync();
803          Assert.That(primaryConnection.Port, Is.EqualTo(primaryPostmasterMock.Port));
804          await using var standbyConnection = await standbyDataSource.OpenConnectionAsync();
805          Assert.That(standbyConnection.Port, Is.EqualTo(standbyPostmasterMock.Port));
806      }
807      [Test]
808      public async Task DataSource_without_wrappers()
809      {
810          await using var primaryPostmasterMock = PgPostmasterMock.Start(state: Primary);
811          await using var standbyPostmasterMock = PgPostmasterMock.Start(state: Standby);
812          var builder = new NpgsqlDataSourceBuilder
813          {
814              ConnectionStringBuilder =
815              {
816                  Host = MultipleHosts(primaryPostmasterMock, standbyPostmasterMock),
817                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
818              }
819          };
820          await using var dataSource = builder.BuildMultiHost();
821          await using var primaryConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.Primary);
822          Assert.That(primaryConnection.Port, Is.EqualTo(primaryPostmasterMock.Port));
823          await using var standbyConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.Standby);
824          Assert.That(standbyConnection.Port, Is.EqualTo(standbyPostmasterMock.Port));
825      }
826      [Test]
827      public void DataSource_with_TargetSessionAttributes_is_not_supported()
828      {
829          var builder = new NpgsqlDataSourceBuilder("Host=foo,bar;Target Session Attributes=primary");
830          Assert.That(() => builder.BuildMultiHost(), Throws.Exception.TypeOf<InvalidOperationException>()
831              .With.Message.EqualTo(NpgsqlStrings.CannotSpecifyTargetSessionAttributes));
832      }
833      [Test]
834      public async Task BuildMultiHost_with_single_host_is_supported()
835      {
836          var builder = new NpgsqlDataSourceBuilder(ConnectionString);
837          await using var dataSource = builder.BuildMultiHost();
838          await using var connection = await dataSource.OpenConnectionAsync();
839          Assert.That(await connection.ExecuteScalarAsync("SELECT 1"), Is.EqualTo(1));
840      }
841      [Test]
842      public async Task Build_with_multiple_hosts_is_supported()
843      {
844          await using var primaryPostmasterMock = PgPostmasterMock.Start(state: Primary);
845          await using var standbyPostmasterMock = PgPostmasterMock.Start(state: Standby);
846          var builder = new NpgsqlDataSourceBuilder
847          {
848              ConnectionStringBuilder =
849              {
850                  Host = MultipleHosts(primaryPostmasterMock, standbyPostmasterMock),
851                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
852              }
853          };
854          await using var dataSource = builder.Build();
855          await using var connection = await dataSource.OpenConnectionAsync();
856      }
857      static string MultipleHosts(params PgPostmasterMock[] postmasters)
858          => string.Join(",", postmasters.Select(p => $"{p.Host}:{p.Port}"));
859      class DisposableWrapper : IAsyncDisposable
860      {
861          readonly IEnumerable<IAsyncDisposable> _disposables;
862          public DisposableWrapper(IEnumerable<IAsyncDisposable> disposables) => _disposables = disposables;
863          public async ValueTask DisposeAsync()
864          {
865              foreach (var disposable in _disposables)
866                  await disposable.DisposeAsync();
867          }
868      }
869  }
</code></pre>
        </div>
        <div class="column">
            <h3>MudBlazor-MDEwOlJlcG9zaXRvcnkyODg0Mjg2NzY=-flat-FormTests.cs</h3>
            <pre><code>1  #pragma warning disable CS1998 
2  using System;
3  using System.Collections.Generic;
4  using System.Globalization;
5  using System.Linq;
6  using System.Linq.Expressions;
7  using System.Threading.Tasks;
8  using Bunit;
9  using FluentAssertions;
10  using Microsoft.AspNetCore.Components;
11  using Microsoft.AspNetCore.Components.Forms;
12  using MudBlazor.Docs.Examples;
13  using MudBlazor.UnitTests.TestComponents;
14  using MudBlazor.UnitTests.TestComponents.Form;
15  using MudBlazor.Utilities;
16  using NUnit.Framework;
17  namespace MudBlazor.UnitTests.Components
18  {
19      [TestFixture]
20      public class FormTests : BunitTest
21      {
22          [Test]
23          public async Task FormIsValidTest()
24          {
25              var comp = Context.RenderComponent<FormIsValidTest>();
26              var form = comp.FindComponent<MudForm>().Instance;
27              var textFieldcomp = comp.FindComponent<MudTextField<string>>();
28              var textField = textFieldcomp.Instance;
29              form.IsValid.Should().Be(false);
30              textField.Error.Should().BeFalse();
31              textField.ErrorText.Should().BeNullOrEmpty();
32              textFieldcomp.Find("input").Change("Marilyn Manson");
33              form.IsValid.Should().Be(true);
34              form.Errors.Length.Should().Be(0);
35              textField.Error.Should().BeFalse();
36              textField.ErrorText.Should().BeNullOrEmpty();
37              textFieldcomp.Find("input").Change(null);
38              form.IsValid.Should().Be(false);
39              form.Errors.Length.Should().Be(1);
40              form.Errors[0].Should().Be("Enter a rock star");
41              textField.Error.Should().BeTrue();
42              textField.ErrorText.Should().Be("Enter a rock star");
43              textFieldcomp.Find("input").Change("");
44              form.IsValid.Should().Be(false);
45              form.Errors.Length.Should().Be(1);
46              form.Errors[0].Should().Be("Enter a rock star");
47              textField.Error.Should().BeTrue();
48              textField.ErrorText.Should().Be("Enter a rock star");
49              textFieldcomp.Find("input").Change("Kurt Cobain");
50              form.IsValid.Should().Be(true);
51              form.Errors.Length.Should().Be(0);
52              textField.Error.Should().BeFalse();
53              textField.ErrorText.Should().BeNullOrEmpty();
54          }
55          [Test]
56          public async Task FormIsValidTest2()
57          {
58              var comp = Context.RenderComponent<FormIsValidTest2>();
59              var form = comp.FindComponent<MudForm>().Instance;
60              var textFieldcomp = comp.FindComponent<MudTextField<string>>();
61              form.IsValid.Should().Be(true);
62              textFieldcomp.Find("input").Change("This value doesn't matter");
63              form.IsValid.Should().Be(true);
64          }
65          [Test]
66          public async Task FormIsValidTest3()
67          {
68              var comp = Context.RenderComponent<FormIsValidTest3>();
69              var form = comp.FindComponent<MudForm>().Instance;
70              var textFields = comp.FindComponents<MudTextField<string>>();
71              form.IsValid.Should().Be(false);
72              form.IsTouched.Should().Be(false);
73              comp.FindComponents<MudSwitch<bool>>()[0].Instance.Checked.Should().Be(false);
74              comp.FindComponents<MudSwitch<bool>>()[1].Instance.Checked.Should().Be(false);
75              textFields[1].Find("input").Change("Fill in the required field to make this form valid");
76              form.IsValid.Should().Be(true);
77              comp.FindComponents<MudSwitch<bool>>()[0].Instance.Checked.Should().Be(true);
78              comp.FindComponents<MudSwitch<bool>>()[1].Instance.Checked.Should().Be(true);
79          }
80          [Test]
81          public async Task FormIsValidTest4()
82          {
83              var comp = Context.RenderComponent<FormIsValidTest4>();
84              var form = comp.FindComponent<MudForm>().Instance;
85              comp.WaitForAssertion(() => form.IsValid.Should().Be(true));
86              comp.WaitForAssertion(() => comp.FindComponent<MudSwitch<bool>>().Instance.Checked.Should().Be(true));
87          }
88          [Test]
89          public async Task FormIsTouchedTest()
90          {
91              var comp = Context.RenderComponent<FormIsTouchedTest>();
92              var form = comp.FindComponent<MudForm>().Instance;
93              var textFieldcomp = comp.FindComponent<MudTextField<string>>();
94              var textField = textFieldcomp.Instance;
95              var dateComp = comp.FindComponent<MudDatePicker>();
96              var dateField = dateComp.Instance;
97              form.IsTouched.Should().Be(false);
98              dateComp.Find("input").Change("2001-01-31");
99              form.IsTouched.Should().Be(true);
100              await comp.InvokeAsync(() => form.ResetAsync());
101              form.IsTouched.Should().Be(false);
102              textFieldcomp.Find("input").Change("value is changed");
103              form.IsTouched.Should().Be(true);
104              await comp.InvokeAsync(() => form.ResetValidation());
105              form.IsTouched.Should().Be(true);
106          }
107          [Test]
108          public async Task FormIsTouchedAndNestedFormIsNotTouchedWhenParentFormFieldIsTouchedTest()
109          {
110              var comp = Context.RenderComponent<FormIsTouchedNestedTest>();
111              var formsComp = comp.FindComponents<MudForm>();
112              var textCompFields = comp.FindComponents<MudTextField<string>>();
113              var dateCompFields = comp.FindComponents<MudDatePicker>();
114              var form = formsComp[0].Instance;
115              var textField = textCompFields[0].Instance;
116              var dateField = dateCompFields[0].Instance;
117              var nestedForm = formsComp[1].Instance;
118              var nestedFormTextField = textCompFields[1].Instance;
119              var nestedFormDateField = dateCompFields[1].Instance;
120              form.IsTouched.Should().Be(false);
121              nestedForm.IsTouched.Should().Be(false);
122              textCompFields[0].Find("input").Change("2001-01-31");
123              form.IsTouched.Should().Be(true);
124              nestedForm.IsTouched.Should().Be(false);
125              await comp.InvokeAsync(() => form.ResetAsync());
126              form.IsTouched.Should().Be(false);
127              nestedForm.IsTouched.Should().Be(false);
128              textCompFields[0].Find("input").Change("value is changed");
129              form.IsTouched.Should().Be(true);
130              nestedForm.IsTouched.Should().Be(false);
131              await comp.InvokeAsync(() => form.ResetValidation());
132              form.IsTouched.Should().Be(true);
133              nestedForm.IsTouched.Should().Be(false);
134          }
135          [Test]
136          public async Task FormIsUnTouchedWhenNestedFormTouchedTest()
137          {
138              var comp = Context.RenderComponent<FormIsTouchedNestedTest>();
139              var formsComp = comp.FindComponents<MudForm>();
140              var textCompFields = comp.FindComponents<MudTextField<string>>();
141              var dateCompFields = comp.FindComponents<MudDatePicker>();
142              var form = formsComp[0].Instance;
143              var textField = textCompFields[0].Instance;
144              var dateField = dateCompFields[0].Instance;
145              var nestedForm = formsComp[1].Instance;
146              var nestedFormTextField = textCompFields[1].Instance;
147              var nestedFormDateField = dateCompFields[1].Instance;
148              form.IsTouched.Should().Be(false);
149              nestedForm.IsTouched.Should().Be(false);
150              textCompFields[1].Find("input").Change("2001-01-31");
151              form.IsTouched.Should().Be(true);
152              nestedForm.IsTouched.Should().Be(true);
153              await comp.InvokeAsync(() => form.ResetAsync());
154              form.IsTouched.Should().Be(false);
155              nestedForm.IsTouched.Should().Be(false);
156              textCompFields[3].Find("input").Change("value is changed");
157              form.IsTouched.Should().Be(false);
158              nestedForm.IsTouched.Should().Be(true);
159              await comp.InvokeAsync(() => nestedFormDateField.ResetValidation());
160              form.IsTouched.Should().Be(false);
161              nestedForm.IsTouched.Should().Be(true);
162          }
163          [Test]
164          public async Task FormValidationTest1()
165          {
166              var validationFunc = new Func<string, bool>(x => x?.StartsWith("Marilyn") == true);
167              var comp = Context.RenderComponent<FormValidationTest>(ComponentParameter.CreateParameter("validation", validationFunc));
168              var form = comp.FindComponent<MudForm>().Instance;
169              var textFieldcomp = comp.FindComponent<MudTextField<string>>();
170              var textField = textFieldcomp.Instance;
171              form.IsValid.Should().Be(false);
172              textField.Error.Should().BeFalse();
173              textField.ErrorText.Should().BeNullOrEmpty();
174              textFieldcomp.Find("input").Change("Marilyn Manson");
175              form.IsValid.Should().Be(true);
176              form.Errors.Length.Should().Be(0);
177              textField.Error.Should().BeFalse();
178              textField.ErrorText.Should().BeNullOrEmpty();
179              textFieldcomp.Find("input").Change("Kurt Cobain");
180              form.IsValid.Should().Be(false);
181              form.Errors.Length.Should().Be(1);
182              textField.Error.Should().BeTrue();
183              textField.ErrorText.Should().Be("Invalid");
184              textFieldcomp.Find("input").Change("Marilyn Monroe");
185              form.IsValid.Should().Be(true);
186              form.Errors.Length.Should().Be(0);
187              textField.Error.Should().BeFalse();
188              textField.ErrorText.Should().BeNullOrEmpty();
189          }
190          [Test]
191          public async Task FormValidationTest2()
192          {
193              var validationFunc = new Func<string, string>(s =>
194              {
195                  if (!(s.StartsWith("Marilyn") || s.EndsWith("Manson")))
196                      return "Not a star!";
197                  return null;
198              });
199              var comp = Context.RenderComponent<FormValidationTest>(ComponentParameter.CreateParameter("validation", validationFunc));
200              var form = comp.FindComponent<MudForm>().Instance;
201              var textFieldcomp = comp.FindComponent<MudTextField<string>>();
202              form.IsValid.Should().Be(false);
203              textFieldcomp.Find("input").Change("Marilyn Manson");
204              form.IsValid.Should().Be(true);
205              textFieldcomp.Find("input").Change("Charles Manson");
206              form.IsValid.Should().Be(true);
207              textFieldcomp.Find("input").Change("Marilyn Monroe");
208              form.IsValid.Should().Be(true);
209              textFieldcomp.Find("input").Change("Manson Marilyn");
210              form.IsValid.Should().Be(false);
211          }
212          [Test]
213          public async Task FormValidationTest3()
214          {
215              var comp = Context.RenderComponent<FormValidationTest>();
216              var form = comp.FindComponent<MudForm>().Instance;
217              var textFieldcomp = comp.FindComponent<MudTextField<string>>();
218              var textField = textFieldcomp.Instance;
219              form.IsValid.Should().Be(false);
220              textFieldcomp.Find("input").Change("Some value");
221              form.IsValid.Should().Be(true);
222              await comp.InvokeAsync(() => form.ResetAsync());
223              textField.Value.Should().Be(null);
224              textField.Text.Should().Be(null);
225              form.IsValid.Should().Be(false); 
226          }
227          [Test]
228          public async Task FormAsyncValidationTest()
229          {
230              const int ValidDelay = 100;
231              const int InvalidDelay = 200;
232              var validationFunc = new Func<string, Task<string>>(async s =>
233              {
234                  if (s == null)
235                      return null;
236                  var valid = (s == "abc");
237                  await Task.Delay(valid ? ValidDelay : InvalidDelay);
238                  return valid ? null : "invalid";
239              });
240              var comp = Context.RenderComponent<FormValidationTest>(ComponentParameter.CreateParameter("validation", validationFunc));
241              var textFieldComp = comp.FindComponent<MudTextField<string>>();
242              var textField = textFieldComp.Instance;
243              textField.ValidationErrors.Should().BeEmpty();
244              textFieldComp.Find("input").Change("def");
245              comp.WaitForAssertion(() => textField.ValidationErrors.Should().ContainSingle("invalid"), TimeSpan.FromSeconds(5));
246              textFieldComp.Find("input").Change("abc");
247              comp.WaitForAssertion(() => textField.ValidationErrors.Should().BeEmpty(), TimeSpan.FromSeconds(5));
248              textFieldComp.Find("input").Change("def");
249              textFieldComp.Find("input").Change("abc");
250              comp.WaitForAssertion(() => textField.ValidationErrors.Should().BeEmpty(), TimeSpan.FromSeconds(5));
251          }
252          [Test]
253          public async Task EditFormOnFieldChangedTest()
254          {
255              var comp = Context.RenderComponent<EditFormOnFieldChangedTest>();
256              var textFields = comp.FindAll("input");
257              textFields.Count.Should().Be(3);
258              var chips = comp.FindAll("span.mud-chip-content");
259              chips.Count.Should().Be(3);
260              foreach (var chip in chips)
261                  chip.TextContent.Trim().Should().EndWith("not changed");
262              comp.FindAll("input")[0].Change(new ChangeEventArgs() { Value = "asdf" });
263              comp.FindAll("input")[0].Blur();
264              comp.FindComponents<MudTextField<string>>()[0].Instance.Text.Should().Be("asdf");
265              comp.FindAll("span.mud-chip-content")[0].TextContent.Trim().Should().Be("Field1 changed");
266              comp.FindAll("span.mud-chip-content")[1].TextContent.Trim().Should().EndWith("not changed");
267              comp.FindAll("span.mud-chip-content")[2].TextContent.Trim().Should().EndWith("not changed");
268              comp.FindAll("input")[1].Change(new ChangeEventArgs() { Value = "yxcv" });
269              comp.FindAll("input")[1].Blur();
270              comp.FindComponents<MudTextField<string>>()[1].Instance.Text.Should().Be("yxcv");
271              comp.FindAll("span.mud-chip-content")[0].TextContent.Trim().Should().Be("Field1 changed");
272              comp.FindAll("span.mud-chip-content")[1].TextContent.Trim().Should().EndWith("not changed", "Because it has no For, so the change can not be forwarded to the edit context for lack of a FieldIdentifier");
273              comp.FindAll("span.mud-chip-content")[2].TextContent.Trim().Should().EndWith("not changed");
274              comp.FindAll("input")[2].Change(new ChangeEventArgs() { Value = "qwer" });
275              comp.FindAll("input")[2].Blur();
276              comp.FindComponents<MudTextField<string>>()[2].Instance.Text.Should().Be("qwer");
277              comp.FindAll("span.mud-chip-content")[0].TextContent.Trim().Should().Be("Field1 changed");
278              comp.FindAll("span.mud-chip-content")[1].TextContent.Trim().Should().EndWith("not changed");
279              comp.FindAll("span.mud-chip-content")[2].TextContent.Trim().Should().EndWith("Field3 changed");
280          }
281          [Test]
282          public async Task FormWithCheckboxTest()
283          {
284              var comp = Context.RenderComponent<FormWithCheckboxTest>();
285              var textFields = comp.FindAll("input");
286              textFields.Count.Should().Be(4); 
287              comp.FindAll("input")[0].Change("Garfield");
288              comp.FindAll("input")[0].Blur();
289              comp.FindAll("input")[1].Change("Jon");
290              comp.FindAll("input")[1].Blur();
291              comp.FindAll("input")[2].Change("17"); 
292              comp.FindAll("input")[2].Blur();
293              foreach (var tf in comp.FindComponents<MudTextField<string>>())
294                  tf.Instance.Text.Should().NotBeNullOrEmpty();
295              comp.FindComponent<MudTextField<int>>().Instance.Value.Should().Be(17);
296              comp.FindComponent<MudCheckBox<bool>>().Instance.Checked.Should().Be(true);
297              comp.FindAll("input")[3].Change(false); 
298              comp.FindComponent<MudCheckBox<bool>>().Instance.Checked.Should().Be(false);
299              foreach (var tf in comp.FindComponents<MudTextField<string>>())
300                  tf.Instance.Text.Should().NotBeNullOrEmpty();
301              comp.FindComponent<MudTextField<int>>().Instance.Value.Should().Be(17);
302          }
303          [Test]
304          public async Task FormWithCheckboxTest2()
305          {
306              var comp = Context.RenderComponent<FormWithCheckboxTest>();
307              var form = comp.FindComponent<MudForm>().Instance;
308              form.IsValid.Should().BeTrue(because: "none of the fields are required");
309          }
310          [Test]
311          public async Task Form_Should_BecomeValidIfUntouchedFieldsAreNotRequired()
312          {
313              var comp = Context.RenderComponent<FormValidationTest2>();
314              var form = comp.FindComponent<MudForm>().Instance;
315              form.IsValid.Should().BeFalse(because: "textfield is required");
316              var textfield = comp.FindComponent<MudTextField<string>>();
317              textfield.Find("input").Change("Moby Dick");
318              form.IsValid.Should().BeTrue(because: "select is not required");
319          }
320          [Test]
321          public async Task Form_Should_BecomeInValidWhenAConversionErrorOccurs()
322          {
323              var comp = Context.RenderComponent<FormConversionErrorTest>();
324              var form = comp.FindComponent<MudForm>().Instance;
325              form.IsValid.Should().BeTrue();
326              var textfield = comp.FindComponent<MudTextField<int>>();
327              textfield.Find("input").Input("Not and int");
328              form.IsValid.Should().BeFalse(because: "conversion error is forwarded to form");
329              textfield.Find("input").Input("17");
330              form.IsValid.Should().BeTrue(because: "conversion error is gone");
331          }
332          [Test]
333          public async Task MudFormExampleTest()
334          {
335              var comp = Context.RenderComponent<MudFormExample>();
336              var form = comp.FindComponent<MudForm>().Instance;
337              comp.FindComponent<MudForm>().SetParam(x => x.ValidationDelay, 0);
338              comp.WaitForAssertion(() => form.IsValid.Should().BeFalse(because: "it contains required fields that are not filled out"));
339              var buttons = comp.FindComponents<MudButton>();
340              var validateButton = buttons[1];
341              validateButton.Find("button").Click();
342              var textfields = comp.FindComponents<MudTextField<string>>();
343              comp.WaitForAssertion(() => textfields[0].Instance.HasErrors.Should().BeTrue());
344              textfields[0].Instance.ErrorText.Should().Be("User name is required!");
345              comp.WaitForAssertion(() => textfields[1].Instance.HasErrors.Should().BeTrue());
346              textfields[1].Instance.ErrorText.Should().Be("Email is required!");
347              comp.WaitForAssertion(() => textfields[2].Instance.HasErrors.Should().BeTrue());
348              textfields[2].Instance.ErrorText.Should().Be("Password is required!");
349              var checkbox = comp.FindComponent<MudCheckBox<bool>>();
350              comp.WaitForAssertion(() => checkbox.Instance.HasErrors.Should().BeTrue());
351              checkbox.Instance.ErrorText.Should().Be("You must agree");
352              var resetValidationButton = buttons[3];
353              resetValidationButton.Find("button").Click();
354              comp.WaitForState(() => form.Errors.Length == 0);
355              comp.WaitForAssertion(() => textfields[0].Instance.HasErrors.Should().BeFalse());
356              textfields[0].Instance.ErrorText.Should().BeNullOrEmpty();
357              comp.WaitForAssertion(() => textfields[1].Instance.HasErrors.Should().BeFalse());
358              textfields[1].Instance.ErrorText.Should().BeNullOrEmpty();
359              comp.WaitForAssertion(() => textfields[2].Instance.HasErrors.Should().BeFalse());
360              textfields[2].Instance.ErrorText.Should().BeNullOrEmpty();
361              comp.WaitForAssertion(() => checkbox.Instance.HasErrors.Should().BeFalse());
362              checkbox.Instance.ErrorText.Should().BeNullOrEmpty();
363              textfields[0].Find("input").Change("Rick Sanchez");
364              textfields[1].Find("input").Change("rick.sanchez@citadel-of-ricks.com");
365              textfields[2].Find("input").Change("Wabalabadubdub1234!");
366              textfields[3].Find("input").Change("Wabalabadubdub1234!");
367              checkbox.Find("input").Change(true);
368              comp.WaitForAssertion(() => form.IsValid.Should().BeTrue());
369              comp.WaitForState(() => form.Errors.Length == 0);
370              var resetButton = buttons[2];
371              resetButton.Find("button").Click();
372              comp.WaitForState(() => form.Errors.Length == 0);
373              comp.WaitForAssertion(() => textfields[0].Instance.HasErrors.Should().BeFalse());
374              textfields[0].Instance.ErrorText.Should().BeNullOrEmpty();
375              textfields[0].Instance.Text.Should().BeNullOrEmpty();
376              comp.WaitForAssertion(() => textfields[1].Instance.HasErrors.Should().BeFalse());
377              textfields[1].Instance.ErrorText.Should().BeNullOrEmpty();
378              textfields[1].Instance.Text.Should().BeNullOrEmpty();
379              comp.WaitForAssertion(() => textfields[2].Instance.HasErrors.Should().BeFalse());
380              textfields[2].Instance.ErrorText.Should().BeNullOrEmpty();
381              textfields[2].Instance.Text.Should().BeNullOrEmpty();
382              comp.WaitForAssertion(() => checkbox.Instance.HasErrors.Should().BeFalse());
383              checkbox.Instance.ErrorText.Should().BeNullOrEmpty();
384              comp.WaitForAssertion(() => checkbox.Instance.Checked.Should().BeFalse());
385          }
386          [Test]
387          public async Task FormWithRadioGroupIsValidTest()
388          {
389              var comp = Context.RenderComponent<FormWithRadioGroupTest>();
390              var form = comp.FindComponent<MudForm>().Instance;
391              var radioGroupcomp = comp.FindComponent<MudRadioGroup<string>>();
392              var radioGroup = radioGroupcomp.Instance;
393              form.IsValid.Should().Be(false);
394              radioGroup.Error.Should().BeFalse();
395              radioGroup.ErrorText.Should().BeNullOrEmpty();
396              radioGroupcomp.Find("input").Click();
397              form.IsValid.Should().Be(true);
398              form.Errors.Length.Should().Be(0);
399              radioGroup.Error.Should().BeFalse();
400              radioGroup.ErrorText.Should().BeNullOrEmpty();
401              comp.SetParam("Selected", null);
402              form.IsValid.Should().Be(false);
403              form.Errors.Length.Should().Be(1);
404              form.Errors[0].Should().Be("Required");
405              radioGroup.Error.Should().BeTrue();
406              radioGroup.ErrorText.Should().Be("Required");
407          }
408          [Test]
409          public async Task Form_Should_Validate_ColorPicker_When_ColorSelectedViaInputs()
410          {
411              var comp = Context.RenderComponent<FormWithColorPickerTest>();
412              var form = comp.FindComponent<MudForm>().Instance;
413              var colorPickerComp = comp.FindComponent<MudColorPicker>();
414              var colorPicker = comp.FindComponent<MudColorPicker>().Instance;
415              var forbiddenColor = colorPicker.Value;
416              colorPickerComp.SetParam(x => x.Validation, new Func<MudColor?, string>(color => color != null && color.Value == forbiddenColor.Value ? $"{forbiddenColor.Value} is not allowed" : null));
417              form.IsTouched.Should().BeFalse();
418              form.IsValid.Should().BeFalse();
419              colorPicker.Error.Should().BeFalse();
420              colorPicker.ErrorText.Should().BeNullOrEmpty();
421              await comp.InvokeAsync(() => colorPickerComp.FindAll("input")[0].Change("#111111"));
422              form.IsTouched.Should().BeTrue();
423              form.IsValid.Should().BeTrue();
424              form.Errors.Length.Should().Be(0);
425              colorPicker.Error.Should().BeFalse();
426              colorPicker.ErrorText.Should().BeNullOrEmpty();
427              comp.SetParam(x => x.ColorValue, forbiddenColor);
428              form.IsValid.Should().Be(false);
429              form.Errors.Length.Should().Be(1);
430              form.Errors[0].Should().Be($"{forbiddenColor.Value} is not allowed");
431              colorPicker.Error.Should().BeTrue();
432              colorPicker.ErrorText.Should().Be($"{forbiddenColor.Value} is not allowed");
433          }
434          [Test]
435          public async Task Form_Should_ValidateColorPickerTest_When_ColorSelectedViaPicker()
436          {
437              var comp = Context.RenderComponent<FormWithColorPickerTest>();
438              var form = comp.FindComponent<MudForm>().Instance;
439              var colorPickerComp = comp.FindComponent<MudColorPicker>();
440              var colorPicker = comp.FindComponent<MudColorPicker>().Instance;
441              var forbiddenColor = colorPicker.Palette.First();
442              colorPickerComp.SetParam(x => x.Validation, new Func<MudColor?, string>(color => color != null && color.Value == forbiddenColor.Value ? $"{forbiddenColor.Value} is not allowed" : null));
443              form.IsTouched.Should().BeFalse();
444              form.IsValid.Should().BeFalse();
445              await comp.InvokeAsync(() => comp.Find("input").Click());
446              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(1));
447              await comp.InvokeAsync(() => comp.Find("div.mud-picker-color-dot-current").Click());
448              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-color-collection").Count.Should().Be(1));
449              await comp.InvokeAsync(() => comp.FindAll("div.mud-picker-color-collection>div.mud-picker-color-dot").Skip(1).First().Click());
450              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-color-collection").Count.Should().Be(0));
451              form.IsTouched.Should().BeTrue();
452              form.IsValid.Should().BeTrue();
453              form.Errors.Length.Should().Be(0);
454              colorPicker.Error.Should().BeFalse();
455              colorPicker.ErrorText.Should().BeNullOrEmpty();
456              await comp.InvokeAsync(() => comp.Find("div.mud-picker-color-dot-current").Click());
457              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-color-collection").Count.Should().Be(1));
458              await comp.InvokeAsync(() => comp.FindAll("div.mud-picker-color-collection>div.mud-picker-color-dot").First().Click());
459              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-color-collection").Count.Should().Be(0));
460              form.IsTouched.Should().BeTrue();
461              form.IsValid.Should().BeFalse();
462              form.Errors.Length.Should().Be(1);
463              form.Errors[0].Should().Be($"{forbiddenColor.Value} is not allowed");
464              colorPicker.Error.Should().BeTrue();
465              colorPicker.ErrorText.Should().Be($"{forbiddenColor.Value} is not allowed");
466          }
467          [Test]
468          public async Task FormWithDatePickerTest()
469          {
470              var comp = Context.RenderComponent<FormWithDatePickerTest>();
471              var form = comp.FindComponent<MudForm>().Instance;
472              var dateComp = comp.FindComponent<MudDatePicker>();
473              var datepicker = comp.FindComponent<MudDatePicker>().Instance;
474              form.IsValid.Should().Be(false);
475              datepicker.Error.Should().BeFalse();
476              datepicker.ErrorText.Should().BeNullOrEmpty();
477              dateComp.Find("input").Change(new DateTime(2001, 01, 31).ToShortDateString());
478              form.IsValid.Should().Be(true);
479              form.Errors.Length.Should().Be(0);
480              datepicker.Error.Should().BeFalse();
481              datepicker.ErrorText.Should().BeNullOrEmpty();
482              comp.SetParam(x => x.Date, null);
483              form.IsValid.Should().Be(false);
484              form.Errors.Length.Should().Be(1);
485              form.Errors[0].Should().Be("Required");
486              datepicker.Error.Should().BeTrue();
487              datepicker.ErrorText.Should().Be("Required");
488          }
489          [Test]
490          public async Task Form_Should_ValidateDatePickerTest()
491          {
492              var comp = Context.RenderComponent<FormWithDatePickerTest>();
493              var form = comp.FindComponent<MudForm>().Instance;
494              var dateComp = comp.FindComponent<MudDatePicker>();
495              var datepicker = comp.FindComponent<MudDatePicker>().Instance;
496              dateComp.SetParam(x => x.Validation, new Func<DateTime?, string>(date => date != null && date.Value.Year >= 2000 ? null : "Year must be >= 2000"));
497              dateComp.Find("input").Change(new DateTime(2001, 01, 31).ToShortDateString());
498              form.IsValid.Should().Be(true);
499              form.Errors.Length.Should().Be(0);
500              datepicker.Error.Should().BeFalse();
501              datepicker.ErrorText.Should().BeNullOrEmpty();
502              comp.SetParam(x => x.Date, (DateTime?)new DateTime(1999, 1, 1));
503              form.IsValid.Should().Be(false);
504              form.Errors.Length.Should().Be(1);
505              form.Errors[0].Should().Be("Year must be >= 2000");
506              datepicker.Error.Should().BeTrue();
507              datepicker.ErrorText.Should().Be("Year must be >= 2000");
508          }
509          [Test]
510          public async Task Form_Should_Validate_DateRangePicker_When_DateRangeSelectedViaInputs()
511          {
512              var comp = Context.RenderComponent<FormWithDateRangePickerTest>();
513              var form = comp.FindComponent<MudForm>().Instance;
514              var dateRangeComp = comp.FindComponent<MudDateRangePicker>();
515              var dateRangePicker = comp.FindComponent<MudDateRangePicker>().Instance;
516              var firstDateTime = new DateTime(2023, 01, 20);
517              var secondDateTime = new DateTime(2023, 02, 20);
518              form.IsValid.Should().Be(false);
519              dateRangePicker.Error.Should().BeFalse();
520              dateRangePicker.ErrorText.Should().BeNullOrEmpty();
521              await comp.InvokeAsync(() => dateRangeComp.FindAll("input")[0].Change(firstDateTime.ToString(CultureInfo.CurrentCulture.DateTimeFormat.ShortDatePattern)));
522              await comp.InvokeAsync(() => dateRangeComp.FindAll("input")[1].Change(secondDateTime.ToString(CultureInfo.CurrentCulture.DateTimeFormat.ShortDatePattern)));
523              form.IsValid.Should().Be(true);
524              form.Errors.Length.Should().Be(0);
525              dateRangePicker.Error.Should().BeFalse();
526              dateRangePicker.ErrorText.Should().BeNullOrEmpty();
527              comp.SetParam(x => x.DateRange, null);
528              form.IsValid.Should().Be(false);
529              form.Errors.Length.Should().Be(1);
530              form.Errors[0].Should().Be("Required");
531              dateRangePicker.Error.Should().BeTrue();
532              dateRangePicker.ErrorText.Should().Be("Required");
533          }
534          [Test]
535          public async Task Form_Should_Validate_DateRangePicker_When_DateRangeSelectedViaPicker()
536          {
537              var comp = Context.RenderComponent<FormWithDateRangePickerTest>();
538              var form = comp.FindComponent<MudForm>().Instance;
539              var dateRangePicker = comp.FindComponent<MudDateRangePicker>().Instance;
540              form.IsValid.Should().Be(false);
541              dateRangePicker.Error.Should().BeFalse();
542              dateRangePicker.ErrorText.Should().BeNullOrEmpty();
543              comp.Find("input").Click();
544              await comp.InvokeAsync(() => comp.FindAll("button.mud-picker-calendar-day").First(x => x.TrimmedText().Equals("10")).Click());
545              await comp.InvokeAsync(() => comp.FindAll("button.mud-picker-calendar-day").First(x => x.TrimmedText().Equals("11")).Click());
546              comp.WaitForAssertion(() => comp.FindAll("div.mud-popover-open").Count.Should().Be(0));
547              comp.WaitForAssertion(() => comp.FindAll("div.mud-popover").Count.Should().Be(1));
548              form.IsTouched.Should().Be(true);
549              form.IsValid.Should().Be(true);
550              form.Errors.Length.Should().Be(0);
551              dateRangePicker.Error.Should().BeFalse();
552              dateRangePicker.ErrorText.Should().BeNullOrEmpty();
553              comp.SetParam(x => x.DateRange, null);
554              form.IsValid.Should().Be(false);
555              form.Errors.Length.Should().Be(1);
556              form.Errors[0].Should().Be("Required");
557              dateRangePicker.Error.Should().BeTrue();
558              dateRangePicker.ErrorText.Should().Be("Required");
559          }
560          [Test]
561          public async Task FormWithTimePickerTest()
562          {
563              var comp = Context.RenderComponent<FormWithTimePickerTest>();
564              var form = comp.FindComponent<MudForm>().Instance;
565              var timePickerComp = comp.FindComponent<MudTimePicker>();
566              var timePicker = comp.FindComponent<MudTimePicker>().Instance;
567              form.IsValid.Should().Be(false);
568              timePicker.Error.Should().BeFalse();
569              timePicker.ErrorText.Should().BeNullOrEmpty();
570              timePickerComp.Find("input").Change("09:30");
571              form.IsValid.Should().Be(true);
572              form.Errors.Length.Should().Be(0);
573              timePicker.Error.Should().BeFalse();
574              timePicker.ErrorText.Should().BeNullOrEmpty();
575              comp.SetParam(x => x.Time, null);
576              form.IsValid.Should().Be(false);
577              form.Errors.Length.Should().Be(1);
578              form.Errors[0].Should().Be("Required");
579              timePicker.Error.Should().BeTrue();
580              timePicker.ErrorText.Should().Be("Required");
581          }
582          [Test]
583          public async Task Form_Should_ValidateTimePickerTest()
584          {
585              var comp = Context.RenderComponent<FormWithTimePickerTest>();
586              var form = comp.FindComponent<MudForm>().Instance;
587              var timeComp = comp.FindComponent<MudTimePicker>();
588              var timePicker = comp.FindComponent<MudTimePicker>().Instance;
589              timeComp.SetParam(x => x.Validation, new Func<TimeSpan?, string>(time => time != null && time.Value.Minutes == 0 ? null : "Only full hours allowed"));
590              timeComp.Find("input").Change("09:00");
591              form.IsValid.Should().Be(true);
592              form.Errors.Length.Should().Be(0);
593              timePicker.Error.Should().BeFalse();
594              timePicker.ErrorText.Should().BeNullOrEmpty();
595              comp.SetParam(x => x.Time, (TimeSpan?)new TimeSpan(0, 17, 05, 00)); 
596              form.IsValid.Should().Be(false);
597              form.Errors.Length.Should().Be(1);
598              form.Errors[0].Should().Be("Only full hours allowed");
599              timePicker.Error.Should().BeTrue();
600              timePicker.ErrorText.Should().Be("Only full hours allowed");
601          }
602          [Test]
603          public async Task FormWithTimePickerTest_When_TimeSelectedViaPicker()
604          {
605              var comp = Context.RenderComponent<FormWithTimePickerTest>();
606              var form = comp.FindComponent<MudForm>().Instance;
607              var timePicker = comp.FindComponent<MudTimePicker>().Instance;
608              form.IsValid.Should().Be(false);
609              timePicker.Error.Should().BeFalse();
610              timePicker.ErrorText.Should().BeNullOrEmpty();
611              comp.Find("input").Click();
612              comp.FindAll("div.mud-picker-stick-inner.mud-hour")[8].Click();
613              comp.FindAll("div.mud-minute")[30].Click();
614              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(0));
615              form.IsTouched.Should().Be(true);
616              form.IsValid.Should().Be(true);
617              form.Errors.Length.Should().Be(0);
618              timePicker.Error.Should().BeFalse();
619              timePicker.ErrorText.Should().BeNullOrEmpty();
620              comp.SetParam(x => x.Time, null);
621              form.IsValid.Should().Be(false);
622              form.Errors.Length.Should().Be(1);
623              form.Errors[0].Should().Be("Required");
624              timePicker.Error.Should().BeTrue();
625              timePicker.ErrorText.Should().Be("Required");
626          }
627          [Test]
628          public async Task Form_Should_ValidateTimePickerTest_When_TimeSelectedViaPicker()
629          {
630              var comp = Context.RenderComponent<FormWithTimePickerTest>();
631              var form = comp.FindComponent<MudForm>().Instance;
632              var timePickerComp = comp.FindComponent<MudTimePicker>();
633              var timePicker = comp.FindComponent<MudTimePicker>().Instance;
634              timePickerComp.SetParam(x => x.Validation, new Func<TimeSpan?, string>(time => time != null && time.Value.Minutes == 0 ? null : "Only full hours allowed"));
635              await comp.InvokeAsync(() => comp.Find("input").Click());
636              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(1));
637              await comp.InvokeAsync(() => comp.FindAll("div.mud-picker-stick-inner.mud-hour")[8].Click());
638              await comp.InvokeAsync(() => comp.FindAll("div.mud-minute")[0].Click());
639              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(0));
640              form.IsTouched.Should().Be(true);
641              form.IsValid.Should().Be(true);
642              form.Errors.Length.Should().Be(0);
643              timePicker.Error.Should().BeFalse();
644              timePicker.ErrorText.Should().BeNullOrEmpty();
645              await comp.InvokeAsync(() => comp.Find("input").Click());
646              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(1));
647              await comp.InvokeAsync(() => comp.FindAll("div.mud-picker-stick-outer.mud-hour")[4].Click());
648              await comp.InvokeAsync(() => comp.FindAll("div.mud-minute")[5].Click());
649              form.IsValid.Should().Be(false);
650              form.Errors.Length.Should().Be(1);
651              form.Errors[0].Should().Be("Only full hours allowed");
652              timePicker.Error.Should().BeTrue();
653              timePicker.ErrorText.Should().Be("Only full hours allowed");
654          }
655          [Test]
656          public async Task EditFormExample_EmptyValidation()
657          {
658              var comp = Context.RenderComponent<EditFormExample>();
659              comp.Find("form").Submit();
660              var textfields = comp.FindComponents<MudTextField<string>>();
661              textfields[0].Instance.HasErrors.Should().BeTrue();
662              textfields[0].Instance.ErrorText.Should().Be("The Username field is required.");
663              textfields[1].Instance.HasErrors.Should().BeTrue();
664              textfields[1].Instance.ErrorText.Should().Be("The Email field is required.");
665              textfields[2].Instance.HasErrors.Should().BeTrue();
666              textfields[2].Instance.ErrorText.Should().Be("The Password field is required.");
667              textfields[3].Instance.HasErrors.Should().BeTrue();
668              textfields[3].Instance.ErrorText.Should().Be("The Password2 field is required.");
669          }
670          [Test]
671          public async Task EditFormExample_FillInValues()
672          {
673              var comp = Context.RenderComponent<EditFormExample>();
674              comp.FindAll("input")[0].Change("Rick Sanchez");
675              comp.FindAll("input")[0].Blur();
676              comp.FindAll("input")[1].Change("rick.sanchez@citadel-of-ricks.com");
677              comp.FindAll("input")[1].Blur();
678              comp.FindAll("input")[2].Change("Wabalabadubdub1234!");
679              comp.FindAll("input")[2].Blur();
680              comp.FindAll("input")[3].Change("Wabalabadubdub1234!");
681              comp.FindAll("input")[3].Blur();
682              comp.Find("form").Submit();
683              var textfields = comp.FindComponents<MudTextField<string>>();
684              textfields[0].Instance.ErrorText.Should().Be("Name length can't be more than 8.");
685              textfields[0].Instance.HasErrors.Should().BeTrue();
686              textfields[1].Instance.HasErrors.Should().BeFalse();
687              textfields[1].Instance.ErrorText.Should().BeNullOrEmpty();
688              textfields[2].Instance.HasErrors.Should().BeFalse();
689              textfields[2].Instance.ErrorText.Should().BeNullOrEmpty();
690              textfields[3].Instance.HasErrors.Should().BeFalse();
691              textfields[3].Instance.ErrorText.Should().BeNullOrEmpty();
692          }
693          [Test]
694          public async Task EditForm_Validation_NullContext()
695          {
696              var comp = Context.RenderComponent<EditFormIssue1229>();
697              EditFormIssue1229.TestAttribute.ValidationContextOnCall.Should().BeEmpty();
698              var input = comp.Find("input");
699              input.Change("Test");
700              input.Blur();
701              EditFormIssue1229.TestAttribute.ValidationContextOnCall.Should().NotBeEmpty();
702              foreach (var vc in EditFormIssue1229.TestAttribute.ValidationContextOnCall)
703              {
704                  vc.Should().NotBeNull();
705              }
706          }
707          [Test]
708          public async Task MudForm_MustNot_ValidateOnInitialRender()
709          {
710              var comp = Context.RenderComponent<MudFormExample>();
711              await Task.Delay(100);
712              var form = comp.FindComponent<MudForm>().Instance;
713              form.Errors.Should().BeEmpty();
714          }
715          [Test]
716          public async Task MudFormExample_FillInValuesRootForm()
717          {
718              var comp = Context.RenderComponent<FluentValidationComplexExample>();
719              comp.FindAll("input")[0].Input("Rick Sanchez");
720              comp.FindAll("input")[0].Blur();
721              comp.FindAll("input")[1].Input("rick.sanchez@citadel-of-ricks.com");
722              comp.FindAll("input")[1].Blur();
723              comp.FindAll("input")[3].Input("Wabalabadubdub1234!");
724              comp.FindAll("input")[3].Blur();
725              comp.FindAll("input")[4].Input("sdfsfsdf!");
726              comp.FindAll("input")[4].Blur();
727              comp.FindAll("input")[5].Input("adsadasad!");
728              comp.FindAll("input")[5].Blur();
729              var form = comp.FindComponent<MudForm>().Instance;
730              await comp.InvokeAsync(() => form.Validate());
731              form.IsValid.Should().BeFalse();
732              var textfields = comp.FindComponents<MudTextField<string>>();
733              var numericFields = comp.FindComponents<MudNumericField<decimal>>();
734              textfields[0].Instance.HasErrors.Should().BeFalse();
735              textfields[0].Instance.ErrorText.Should().BeNullOrEmpty();
736              textfields[1].Instance.HasErrors.Should().BeFalse();
737              textfields[1].Instance.ErrorText.Should().BeNullOrEmpty();
738              textfields[2].Instance.HasErrors.Should().BeFalse();
739              textfields[2].Instance.ErrorText.Should().BeNullOrEmpty();
740              textfields[3].Instance.HasErrors.Should().BeFalse();
741              textfields[3].Instance.ErrorText.Should().BeNullOrEmpty();
742              textfields[4].Instance.HasErrors.Should().BeFalse();
743              textfields[4].Instance.ErrorText.Should().BeNullOrEmpty();
744              textfields[5].Instance.HasErrors.Should().BeFalse();
745              textfields[5].Instance.ErrorText.Should().BeNullOrEmpty();
746              textfields[6].Instance.HasErrors.Should().BeFalse();
747              textfields[6].Instance.ErrorText.Should().BeNullOrEmpty();
748              numericFields[0].Instance.HasErrors.Should().BeFalse();
749              numericFields[0].Instance.ErrorText.Should().BeNullOrEmpty();
750              textfields[7].Instance.HasErrors.Should().BeTrue();
751              textfields[7].Instance.ErrorText.Should().NotBeNullOrEmpty();
752              numericFields[1].Instance.HasErrors.Should().BeTrue();
753              numericFields[1].Instance.ErrorText.Should().NotBeNullOrEmpty();
754          }
755          [Test]
756          public async Task MudFormExample_FillInValuesNestedForm()
757          {
758              var comp = Context.RenderComponent<FluentValidationComplexExample>();
759              comp.FindAll("input")[8].Change("SomeWork");
760              comp.FindAll("input")[8].Blur();
761              comp.FindAll("input")[9].Change("99");
762              comp.FindAll("input")[9].Blur();
763              var form = comp.FindComponent<MudForm>().Instance;
764              await comp.InvokeAsync(() => form.Validate());
765              form.IsValid.Should().BeFalse();
766              var textfields = comp.FindComponents<MudTextField<string>>();
767              var numericFields = comp.FindComponents<MudNumericField<decimal>>();
768              textfields[0].Instance.HasErrors.Should().BeTrue();
769              textfields[0].Instance.ErrorText.Should().NotBeNullOrEmpty();
770              textfields[1].Instance.HasErrors.Should().BeTrue();
771              textfields[1].Instance.ErrorText.Should().NotBeNullOrEmpty();
772              textfields[2].Instance.HasErrors.Should().BeFalse();
773              textfields[2].Instance.ErrorText.Should().BeNullOrEmpty();
774              textfields[3].Instance.HasErrors.Should().BeTrue();
775              textfields[3].Instance.ErrorText.Should().NotBeNullOrEmpty();
776              textfields[4].Instance.HasErrors.Should().BeTrue();
777              textfields[4].Instance.ErrorText.Should().NotBeNullOrEmpty();
778              textfields[5].Instance.HasErrors.Should().BeTrue();
779              textfields[5].Instance.ErrorText.Should().NotBeNullOrEmpty();
780              textfields[6].Instance.HasErrors.Should().BeFalse();
781              textfields[6].Instance.ErrorText.Should().BeNullOrEmpty();
782              numericFields[0].Instance.HasErrors.Should().BeFalse();
783              numericFields[0].Instance.ErrorText.Should().BeNullOrEmpty();
784              textfields[7].Instance.HasErrors.Should().BeFalse();
785              textfields[7].Instance.ErrorText.Should().BeNullOrEmpty();
786              numericFields[1].Instance.HasErrors.Should().BeFalse();
787              numericFields[1].Instance.ErrorText.Should().BeNullOrEmpty();
788          }
789          [Test]
790          public async Task MudFormExample_FillInValues()
791          {
792              var comp = Context.RenderComponent<FluentValidationComplexExample>();
793              comp.FindAll("input")[0].Input("Rick Sanchez");
794              comp.FindAll("input")[0].Blur();
795              comp.FindAll("input")[1].Input("rick.sanchez@citadel-of-ricks.com");
796              comp.FindAll("input")[1].Blur();
797              comp.FindAll("input")[3].Input("Wabalabadubdub1234!");
798              comp.FindAll("input")[3].Blur();
799              comp.FindAll("input")[4].Input("sdfsfsdf!");
800              comp.FindAll("input")[4].Blur();
801              comp.FindAll("input")[5].Input("adsadasad!");
802              comp.FindAll("input")[5].Blur();
803              comp.FindAll("input")[8].Change("SomeWork");
804              comp.FindAll("input")[8].Blur();
805              comp.FindAll("input")[9].Change("99");
806              comp.FindAll("input")[9].Blur();
807              var form = comp.FindComponent<MudForm>().Instance;
808              await comp.InvokeAsync(() => form.Validate());
809              form.IsValid.Should().BeTrue();
810              var textfields = comp.FindComponents<MudTextField<string>>();
811              var numericFields = comp.FindComponents<MudNumericField<decimal>>();
812              textfields[0].Instance.HasErrors.Should().BeFalse();
813              textfields[0].Instance.ErrorText.Should().BeNullOrEmpty();
814              textfields[1].Instance.HasErrors.Should().BeFalse();
815              textfields[1].Instance.ErrorText.Should().BeNullOrEmpty();
816              textfields[2].Instance.HasErrors.Should().BeFalse();
817              textfields[2].Instance.ErrorText.Should().BeNullOrEmpty();
818              textfields[3].Instance.HasErrors.Should().BeFalse();
819              textfields[3].Instance.ErrorText.Should().BeNullOrEmpty();
820              textfields[4].Instance.HasErrors.Should().BeFalse();
821              textfields[4].Instance.ErrorText.Should().BeNullOrEmpty();
822              textfields[5].Instance.HasErrors.Should().BeFalse();
823              textfields[5].Instance.ErrorText.Should().BeNullOrEmpty();
824              textfields[6].Instance.HasErrors.Should().BeFalse();
825              textfields[6].Instance.ErrorText.Should().BeNullOrEmpty();
826              numericFields[0].Instance.HasErrors.Should().BeFalse();
827              numericFields[0].Instance.ErrorText.Should().BeNullOrEmpty();
828              textfields[7].Instance.HasErrors.Should().BeFalse();
829              textfields[7].Instance.ErrorText.Should().BeNullOrEmpty();
830              numericFields[1].Instance.HasErrors.Should().BeFalse();
831              numericFields[1].Instance.ErrorText.Should().BeNullOrEmpty();
832          }
833          [Test]
834          public async Task MudFormComponent_ValidationWithModel_UnexpectedErrorInValidationFunc3()
835          {
836              var comp = Context.RenderComponent<FormWithSingleTextField>();
837              var form = comp.FindComponent<MudForm>();
838              var model = new { data = "asdf" };
839              form.SetParam(nameof(MudForm.Model), model);
840              var tf = comp.FindComponent<MudTextField<string>>();
841              var validationFunc = new Func<object, string, IEnumerable<string>>((obj, property) =>
842              {
843                  throw new InvalidOperationException("User error");
844              });
845              tf.SetParam(nameof(MudTextField<string>.Validation), validationFunc);
846              Expression<Func<string>> expression = () => model.data;
847              tf.SetParam(nameof(MudTextField<string>.For), expression);
848              await comp.InvokeAsync(tf.Instance.Validate);
849              tf.Instance.Error.Should().Be(true);
850              tf.Instance.ErrorText.Should().Be("Error in validation func: User error");
851          }
852          [Test]
853          public async Task MudFormComponent_ValidationWithModelWithNoFor_ShouldShow_ExpectedError()
854          {
855              var comp = Context.RenderComponent<FormWithSingleTextField>();
856              var form = comp.FindComponent<MudForm>();
857              var model = new { data = "asdf" };
858              form.SetParam(nameof(MudForm.Model), model);
859              var tf = comp.FindComponent<MudTextField<string>>();
860              var validationFunc = new Func<object, string, IEnumerable<string>>((obj, property) =>
861              {
862                  throw new InvalidOperationException("User error");
863              });
864              tf.SetParam(nameof(MudTextField<string>.Validation), validationFunc);
865              await comp.InvokeAsync(tf.Instance.Validate);
866              tf.Instance.Error.Should().Be(true);
867              tf.Instance.ErrorText.Should().Be("For is null, please set parameter For on the form input component of type MudTextField`1");
868          }
869          [Test]
870          public async Task MudFormComponent_AsyncValidationWithModelWithNoFor_ShouldShow_ExpectedError()
871          {
872              var comp = Context.RenderComponent<FormWithSingleTextField>();
873              var form = comp.FindComponent<MudForm>();
874              var model = new { data = "asdf" };
875              form.SetParam(nameof(MudForm.Model), model);
876              var tf = comp.FindComponent<MudTextField<string>>();
877              var validationFunc = new Func<object, string, Task<IEnumerable<string>>>((obj, property) =>
878              {
879                  throw new InvalidOperationException("User error");
880              });
881              tf.SetParam(nameof(MudTextField<string>.Validation), validationFunc);
882              await comp.InvokeAsync(tf.Instance.Validate);
883              tf.Instance.Error.Should().Be(true);
884              tf.Instance.ErrorText.Should().Be("For is null, please set parameter For on the form input component of type MudTextField`1");
885          }
886          [Test]
887          public async Task MudFormComponent_ValidationWithModel_UnexpectedErrorInValidationFunc5()
888          {
889              var comp = Context.RenderComponent<FormWithSingleTextField>();
890              var form = comp.FindComponent<MudForm>();
891              var model = new { data = "asdf" };
892              form.SetParam(nameof(MudForm.Model), model);
893              var tf = comp.FindComponent<MudTextField<string>>();
894              var validationFunc = new Func<object, string, IEnumerable<string>>((obj, property) =>
895              {
896                  obj.Should().Be(model);
897                  property.Should().Be("data");
898                  return new[] { "Error1", "Error2" };
899              });
900              tf.SetParam(nameof(MudTextField<string>.Validation), validationFunc);
901              Expression<Func<string>> expression = () => model.data;
902              tf.SetParam(nameof(MudTextField<string>.For), expression);
903              await comp.InvokeAsync(tf.Instance.Validate);
904              tf.Instance.Error.Should().Be(true);
905              tf.Instance.ErrorText.Should().Be("Error1");
906          }
907          [Test]
908          public async Task FormReset_Should_ClearTextField()
909          {
910              var comp = Context.RenderComponent<FormResetTest>();
911              var form = comp.FindComponent<MudForm>();
912              var textFieldComp = comp.FindComponents<MudTextField<string>>()[1]; 
913              var textField = textFieldComp.Instance;
914              textFieldComp.Find("input").Input("asdf");
915              textField.Value.Should().Be("asdf");
916              textField.Text.Should().Be("asdf");
917              await comp.InvokeAsync(() => form.Instance.ResetAsync());
918              textField.Value.Should().BeNullOrEmpty();
919              textField.Text.Should().BeNullOrEmpty();
920              textFieldComp.Find("input").Input("asdf");
921              textField.Value.Should().Be("asdf");
922              textField.Text.Should().Be("asdf");
923              comp.Find("button.reset").Click();
924              textField.Value.Should().BeNullOrEmpty();
925              textField.Text.Should().BeNullOrEmpty();
926          }
927          [Test]
928          public async Task FormReset_Should_ClearNumericField()
929          {
930              var comp = Context.RenderComponent<FormResetTest>();
931              var form = comp.FindComponent<MudForm>().Instance;
932              var numericFieldComp = comp.FindComponent<MudNumericField<int?>>();
933              var numericField = numericFieldComp.Instance;
934              numericFieldComp.Find("input").Input(10);
935              numericField.Value.Should().Be(10);
936              numericField.Text.Should().Be("10");
937              await comp.InvokeAsync(() => form.ResetAsync());
938              numericField.Value.Should().BeNull();
939              numericField.Text.Should().BeNullOrEmpty();
940              numericFieldComp.Find("input").Input(20);
941              numericField.Value.Should().Be(20);
942              numericField.Text.Should().Be("20");
943              comp.Find("button.reset").Click();
944              numericField.Value.Should().BeNull();
945              numericField.Text.Should().BeNullOrEmpty();
946          }
947          [Test]
948          public async Task FormReset_Should_ClearDatePicker()
949          {
950              var comp = Context.RenderComponent<FormResetTest>();
951              var form = comp.FindComponent<MudForm>().Instance;
952              var datePickerComp = comp.FindComponent<MudDatePicker>();
953              var datePicker = datePickerComp.Instance;
954              var testDate = new DateTime(2020, 05, 24);
955              var testDateString = testDate.ToShortDateString();  
956              datePickerComp.Find("input").Change(testDateString);
957              datePicker.Date.Should().Be(testDate);
958              datePicker.Text.Should().Be(testDateString);
959              await comp.InvokeAsync(() => form.ResetAsync());
960              datePicker.Date.Should().BeNull();
961              datePicker.Text.Should().BeNullOrEmpty();
962              datePickerComp.Find("input").Change(testDateString);
963              datePicker.Date.Should().Be(testDate);
964              datePicker.Text.Should().Be(testDateString);
965              comp.Find("button.reset").Click();
966              datePicker.Date.Should().BeNull();
967              datePicker.Text.Should().BeNullOrEmpty();
968          }
969          [Test]
970          public async Task FormReset_Should_ResetFormStateForFieldsThatWrapMudInput()
971          {
972              var comp = Context.RenderComponent<FormResetTest>();
973              var form = comp.FindComponent<MudForm>().Instance;
974              var datePickerComp = comp.FindComponent<MudDatePicker>();
975              var textFieldComp = comp.FindComponents<MudTextField<string>>()[1]; 
976              var numericFieldComp = comp.FindComponent<MudNumericField<int?>>();
977              var testDate = new DateTime(2022, 07, 29);
978              var testDateString = testDate.ToShortDateString();  
979              form.IsValid.Should().Be(false);
980              datePickerComp.Find("input").Change(testDateString);
981              form.IsValid.Should().Be(false);
982              textFieldComp.Find("input").Input("Some value");
983              form.IsValid.Should().Be(false);
984              numericFieldComp.Find("input").Input("1");
985              form.IsValid.Should().Be(true);
986              await comp.InvokeAsync(() => form.ResetAsync());
987              form.IsValid.Should().Be(false); 
988          }
989          [Test]
990          public async Task MudForm_Should_RegisterOnlyTopSubscribeToParentFormFormControls()
991          {
<span onclick='openModal()' class='match'>992              var comp = Context.RenderComponent<FormShouldRegisterOnlyTopSubscribeToParentFormFormControlsTest>();
993              var form = comp.FindComponent<MudFormTestable>().Instance;
994              Assert.AreEqual(14, form.FormControls.Count);
995          }
996          [Test]
997          public async Task MudForm_Validation_Should_OverrideFieldValidation()
998          {
999              var comp = Context.RenderComponent<FormValidationOverrideFieldValidationTest>();
1000              var textFields = comp.FindComponents<MudTextField<string>>();
1001              var numericFields = comp.FindComponents<MudNumericField<int>>();
1002              var defaultValidation = "v";
1003              textFields[0].Instance.Validation.Should().Be(defaultValidation);
</span>1004              textFields[1].Instance.Validation.Should().Be(defaultValidation);
1005              textFields[2].Instance.Validation.Should().Be(defaultValidation);
1006              textFields[3].Instance.Validation.Should().Be("a");
1007              numericFields[0].Instance.Validation.Should().Be(defaultValidation);
1008              numericFields[1].Instance.Validation.Should().NotBe(defaultValidation);
1009              numericFields[2].Instance.Validation.Should().Be(defaultValidation);
1010              numericFields[3].Instance.Validation.Should().Be("b");
1011          }
1012          [Test]
1013          public async Task FieldValidationWithoutRequiredForm_ShouldNot_Validate()
1014          {
1015              var comp = Context.RenderComponent<FieldValidationWithoutRequiredFormTest>();
1016              Assert.Throws<ElementNotFoundException>(() => comp.Find(".mud-input-error"));
1017          }
1018          [Test]
1019          public async Task FieldChangedEventShouldTriggerTest()
1020          {
1021              var comp = Context.RenderComponent<FormFieldChangedTest>();
1022              var formsComp = comp.FindComponents<MudForm>();
1023              var textField = comp.FindComponent<MudTextField<string>>().Instance;
1024              var numeric = comp.FindComponent<MudNumericField<int>>().Instance;
1025              var radioGroup = comp.FindComponent<MudRadioGroup<string>>().Instance;
1026              comp.Instance.FormFieldChangedEventArgs.Should().BeNull();
1027              await comp.InvokeAsync(() => textField.SetText("new value"));
1028              comp.Instance.FormFieldChangedEventArgs.NewValue.Should().Be("new value");
1029              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, textField);
1030              numeric.Value.Should().Be(0);
1031              await comp.InvokeAsync(() => numeric.Increment());
1032              comp.Instance.FormFieldChangedEventArgs.NewValue.Should().Be(1);
1033              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, numeric);
1034              var inputs = comp.FindAll("input").ToArray();
1035              radioGroup.SelectedOption.Should().Be(null);
1036              inputs[2].Click();
1037              radioGroup.SelectedOption.Should().Be("1");
1038              comp.Instance.FormFieldChangedEventArgs.NewValue.Should().Be("1");
1039              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, radioGroup);
1040              var fileContent = InputFileContent.CreateFromText("", "upload.txt");
1041              var mudFile = comp.FindComponent<MudFileUpload<IBrowserFile>>().Instance;
1042              var input = comp.FindComponent<InputFile>();
1043              input.UploadFiles(fileContent);
1044              (comp.Instance.FormFieldChangedEventArgs.NewValue is IBrowserFile).Should().BeTrue();
1045              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, mudFile);
1046          }
1047          [Test]
1048          public async Task FieldChangedEventShouldTriggerPickerTest()
1049          {
1050              var comp = Context.RenderComponent<FormFieldChangedPickerTest>();
1051              var formsComp = comp.FindComponents<MudForm>();
1052              var datePicker = comp.FindComponent<MudDatePicker>();
1053              var timePicker = comp.FindComponent<MudTimePicker>();
1054              var colorPicker = comp.FindComponent<MudColorPicker>();
1055              comp.Instance.FormFieldChangedEventArgs.Should().BeNull();
1056              var dateString = new DateTime(2022, 04, 03).ToShortDateString();
1057              await comp.InvokeAsync(() => datePicker.Find("input").Change(dateString));
1058              comp.Instance.FormFieldChangedEventArgs.NewValue.Should().Be(new DateTime(2022, 04, 03));
1059              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, datePicker.Instance);
1060              await comp.InvokeAsync(() => timePicker.Find("input").Change("00:45"));
1061              comp.Instance.FormFieldChangedEventArgs.NewValue.Should().Be(new TimeSpan(00, 45, 00));
1062              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, timePicker.Instance);
1063              await comp.InvokeAsync(() => colorPicker.Find("input").Change("#180f6fff"));
1064              comp.Instance.FormFieldChangedEventArgs.NewValue.Should().Be(new MudColor("#180f6fff"));
1065              Assert.AreEqual(comp.Instance.FormFieldChangedEventArgs.Field, colorPicker.Instance);
1066          }
1067          [Test]
1068          public async Task FormAutoValidationSetTest()
1069          {
1070              var comp = Context.RenderComponent<FormAutomaticValidationTest>();
1071              var textComps = comp.FindComponents<MudTextField<string>>();
1072              var dateComps = comp.FindComponents<MudDatePicker>();
1073              textComps[0].Instance.For.Should().NotBeNull(); 
1074              textComps[1].Instance.For.Should().BeNull(); 
1075              dateComps[0].Instance.For.Should().NotBeNull(); 
1076              dateComps[1].Instance.For.Should().BeNull(); 
1077              textComps[0].Instance.Validation.Should().NotBeNull(); 
1078              textComps[1].Instance.Validation.Should().BeNull(); 
1079              dateComps[0].Instance.Validation.Should().NotBeNull(); 
1080              dateComps[1].Instance.Validation.Should().BeNull(); 
1081          }
1082          [Test]
1083          public async Task FormReadonlyTest()
1084          {
1085              var comp = Context.RenderComponent<FormReadOnlyDisabledTest>();
1086              var textField = comp.FindComponents<MudTextField<string>>()[0];
1087              var maskedTextField = comp.FindComponents<MudTextField<string>>()[1];
1088              var checkBox = comp.FindComponent<MudCheckBox<bool>>();
1089              var radioGroup = comp.FindComponent<MudRadioGroup<string>>();
1090              var switch_ = comp.FindComponent<MudSwitch<bool>>();
1091              var select = comp.FindComponent<MudSelect<string>>(); 
1092              var colorPicker = comp.FindComponent<MudColorPicker>();
1093              var datePicker = comp.FindComponent<MudDatePicker>();
1094              var dateRangePicker = comp.FindComponent<MudDateRangePicker>();
1095              var timePicker = comp.FindComponent<MudTimePicker>();
1096              var autocomplete = comp.FindComponent<MudAutocomplete<string>>();
1097              var numericField = comp.FindComponent<MudNumericField<int>>();
1098              var fileUpload = comp.FindComponent<MudFileUpload<IBrowserFile>>();
1099              textField.Find("input").HasAttribute("readonly").Should().BeFalse();
1100              maskedTextField.Find("input").HasAttribute("readonly").Should().BeFalse();
1101              checkBox.Find("label").ClassList.Should().NotContain("mud-readonly");
1102              radioGroup.Find("label").ClassList.Should().NotContain("mud-readonly");
1103              switch_.Find("label").ClassList.Should().NotContain("mud-readonly");
1104              autocomplete.Find("input").HasAttribute("readonly").Should().BeFalse();
1105              numericField.Find("input").HasAttribute("readonly").Should().BeFalse();
1106              fileUpload.Find("input").HasAttribute("disabled").Should().BeFalse(); 
1107              comp.SetParametersAndRender(parameters => parameters.Add(p => p.FormReadOnly, true).Add(p => p.CompReadOnly, false));
1108              textField.Find("input").HasAttribute("readonly").Should().BeTrue();
1109              maskedTextField.Find("input").HasAttribute("readonly").Should().BeTrue();
1110              checkBox.Find("label").ClassList.Should().Contain("mud-readonly");
1111              radioGroup.Find("label").ClassList.Should().Contain("mud-readonly");
1112              switch_.Find("label").ClassList.Should().Contain("mud-readonly");
1113              autocomplete.Find("input").HasAttribute("readonly").Should().BeTrue();
1114              numericField.Find("input").HasAttribute("readonly").Should().BeTrue();
1115              fileUpload.Find("input").HasAttribute("disabled").Should().BeTrue();
1116              comp.SetParametersAndRender(parameters => parameters.Add(p => p.FormReadOnly, false).Add(p => p.CompReadOnly, true));
1117              textField.Find("input").HasAttribute("readonly").Should().BeTrue();
1118              maskedTextField.Find("input").HasAttribute("readonly").Should().BeTrue();
1119              checkBox.Find("label").ClassList.Should().Contain("mud-readonly");
1120              radioGroup.Find("label").ClassList.Should().Contain("mud-readonly");
1121              switch_.Find("label").ClassList.Should().Contain("mud-readonly");
1122              autocomplete.Find("input").HasAttribute("readonly").Should().BeTrue();
1123              numericField.Find("input").HasAttribute("readonly").Should().BeTrue();
1124              fileUpload.Find("input").HasAttribute("disabled").Should().BeFalse(); 
1125              comp.SetParametersAndRender(parameters => parameters.Add(p => p.FormReadOnly, false).Add(p => p.CompReadOnly, false));
1126              textField.Find("input").HasAttribute("readonly").Should().BeFalse();
1127              maskedTextField.Find("input").HasAttribute("readonly").Should().BeFalse();
1128              checkBox.Find("label").ClassList.Should().NotContain("mud-readonly");
1129              radioGroup.Find("label").ClassList.Should().NotContain("mud-readonly");
1130              switch_.Find("label").ClassList.Should().NotContain("mud-readonly");
1131              autocomplete.Find("input").HasAttribute("readonly").Should().BeFalse();
1132              numericField.Find("input").HasAttribute("readonly").Should().BeFalse();
1133              fileUpload.Find("input").HasAttribute("disabled").Should().BeFalse();
1134          }
1135          [Test]
1136          public async Task FormDisabledTest()
1137          {
1138              var comp = Context.RenderComponent<FormReadOnlyDisabledTest>();
1139              var textField = comp.FindComponents<MudTextField<string>>()[0];
1140              var maskedTextField = comp.FindComponents<MudTextField<string>>()[1];
1141              var checkBox = comp.FindComponent<MudCheckBox<bool>>();
1142              var radioGroup = comp.FindComponent<MudRadioGroup<string>>();
1143              var switch_ = comp.FindComponent<MudSwitch<bool>>();
1144              var select = comp.FindComponent<MudSelect<string>>();
1145              var colorPicker = comp.FindComponent<MudColorPicker>();
1146              var datePicker = comp.FindComponent<MudDatePicker>();
1147              var dateRangePicker = comp.FindComponent<MudDateRangePicker>();
1148              var timePicker = comp.FindComponent<MudTimePicker>();
1149              var autocomplete = comp.FindComponent<MudAutocomplete<string>>();
1150              var numericField = comp.FindComponent<MudNumericField<int>>();
1151              var fileUpload = comp.FindComponent<MudFileUpload<IBrowserFile>>();
1152              textField.Find("input").HasAttribute("disabled").Should().BeFalse();
1153              maskedTextField.Find("input").HasAttribute("disabled").Should().BeFalse();
1154              checkBox.Find("input").HasAttribute("disabled").Should().BeFalse();
1155              radioGroup.Find("input").HasAttribute("disabled").Should().BeFalse();
1156              switch_.Find("input").HasAttribute("disabled").Should().BeFalse();
1157              select.Find("input").HasAttribute("disabled").Should().BeFalse();
1158              colorPicker.Find("input").HasAttribute("disabled").Should().BeFalse();
1159              datePicker.Find("input").HasAttribute("disabled").Should().BeFalse();
1160              dateRangePicker.Find("input").HasAttribute("disabled").Should().BeFalse();
1161              timePicker.Find("input").HasAttribute("disabled").Should().BeFalse();
1162              autocomplete.Find("input").HasAttribute("disabled").Should().BeFalse();
1163              numericField.Find("input").HasAttribute("disabled").Should().BeFalse();
1164              fileUpload.Find("input").HasAttribute("disabled").Should().BeFalse();
1165              comp.SetParametersAndRender(parameters => parameters.Add(p => p.FormDisabled, true).Add(p => p.CompDisabled, false));
1166              textField.Find("input").HasAttribute("disabled").Should().BeTrue();
1167              maskedTextField.Find("input").HasAttribute("disabled").Should().BeTrue();
1168              checkBox.Find("input").HasAttribute("disabled").Should().BeTrue();
1169              radioGroup.Find("input").HasAttribute("disabled").Should().BeTrue();
1170              switch_.Find("input").HasAttribute("disabled").Should().BeTrue();
1171              select.Find("input").HasAttribute("disabled").Should().BeTrue();
1172              colorPicker.Find("input").HasAttribute("disabled").Should().BeTrue();
1173              datePicker.Find("input").HasAttribute("disabled").Should().BeTrue();
1174              dateRangePicker.Find("input").HasAttribute("disabled").Should().BeTrue();
1175              timePicker.Find("input").HasAttribute("disabled").Should().BeTrue();
1176              autocomplete.Find("input").HasAttribute("disabled").Should().BeTrue();
1177              numericField.Find("input").HasAttribute("disabled").Should().BeTrue();
1178              fileUpload.Find("input").HasAttribute("disabled").Should().BeTrue();
1179              comp.SetParametersAndRender(parameters => parameters.Add(p => p.FormDisabled, false).Add(p => p.CompDisabled, true));
1180              textField.Find("input").HasAttribute("disabled").Should().BeTrue();
1181              maskedTextField.Find("input").HasAttribute("disabled").Should().BeTrue();
1182              checkBox.Find("input").HasAttribute("disabled").Should().BeTrue();
1183              radioGroup.Find("input").HasAttribute("disabled").Should().BeTrue();
1184              switch_.Find("input").HasAttribute("disabled").Should().BeTrue();
1185              select.Find("input").HasAttribute("disabled").Should().BeTrue();
1186              colorPicker.Find("input").HasAttribute("disabled").Should().BeTrue();
1187              datePicker.Find("input").HasAttribute("disabled").Should().BeTrue();
1188              dateRangePicker.Find("input").HasAttribute("disabled").Should().BeTrue();
1189              timePicker.Find("input").HasAttribute("disabled").Should().BeTrue();
1190              autocomplete.Find("input").HasAttribute("disabled").Should().BeTrue();
1191              numericField.Find("input").HasAttribute("disabled").Should().BeTrue();
1192              fileUpload.Find("input").HasAttribute("disabled").Should().BeTrue();
1193              comp.SetParametersAndRender(parameters => parameters.Add(p => p.FormDisabled, false).Add(p => p.CompDisabled, false));
1194              textField.Find("input").HasAttribute("disabled").Should().BeFalse();
1195              maskedTextField.Find("input").HasAttribute("disabled").Should().BeFalse();
1196              checkBox.Find("input").HasAttribute("disabled").Should().BeFalse();
1197              radioGroup.Find("input").HasAttribute("disabled").Should().BeFalse();
1198              switch_.Find("input").HasAttribute("disabled").Should().BeFalse();
1199              select.Find("input").HasAttribute("disabled").Should().BeFalse();
1200              colorPicker.Find("input").HasAttribute("disabled").Should().BeFalse();
1201              datePicker.Find("input").HasAttribute("disabled").Should().BeFalse();
1202              dateRangePicker.Find("input").HasAttribute("disabled").Should().BeFalse();
1203              timePicker.Find("input").HasAttribute("disabled").Should().BeFalse();
1204              autocomplete.Find("input").HasAttribute("disabled").Should().BeFalse();
1205              numericField.Find("input").HasAttribute("disabled").Should().BeFalse();
1206              fileUpload.Find("input").HasAttribute("disabled").Should().BeFalse();
1207          }
1208          [Test]
1209          public async Task FormNestedReadOnlyTest()
1210          {
1211              var comp = Context.RenderComponent<FormNestedReadOnlyDisabledTest>();
1212              comp.FindAll(".mud-checkbox.mud-readonly").Count.Should().Be(0);
1213              comp.SetParametersAndRender(parameters => parameters.Add(p => p.ReadOnly, true));
1214              comp.FindAll(".mud-checkbox.mud-readonly").Count.Should().Be(1);
1215              comp.SetParametersAndRender(parameters => parameters.Add(p => p.NestedReadOnly, true));
1216              comp.FindAll(".mud-checkbox.mud-readonly").Count.Should().Be(1);
1217              comp.SetParametersAndRender(parameters => parameters.Add(p => p.ReadOnly, true).Add(p => p.NestedReadOnly, true));
1218              comp.FindAll(".mud-checkbox.mud-readonly").Count.Should().Be(1);
1219              comp.SetParametersAndRender(parameters => parameters.Add(p => p.ReadOnly, false).Add(p => p.NestedReadOnly, false));
1220              comp.FindAll(".mud-checkbox.mud-readonly").Count.Should().Be(0);
1221          }
1222          [Test]
1223          public async Task FormNestedDisabledTest()
1224          {
1225              var comp = Context.RenderComponent<FormNestedReadOnlyDisabledTest>();
1226              comp.FindAll(".mud-checkbox.mud-disabled").Count.Should().Be(0);
1227              comp.SetParametersAndRender(parameters => parameters.Add(p => p.Disabled, true));
1228              comp.FindAll(".mud-checkbox.mud-disabled").Count.Should().Be(1);
1229              comp.SetParametersAndRender(parameters => parameters.Add(p => p.NestedDisabled, true));
1230              comp.FindAll(".mud-checkbox.mud-disabled").Count.Should().Be(1);
1231              comp.SetParametersAndRender(parameters => parameters.Add(p => p.Disabled, true).Add(p => p.NestedDisabled, true));
1232              comp.FindAll(".mud-checkbox.mud-disabled").Count.Should().Be(1);
1233              comp.SetParametersAndRender(parameters => parameters.Add(p => p.Disabled, false).Add(p => p.NestedDisabled, false));
1234              comp.FindAll(".mud-checkbox.mud-disabled").Count.Should().Be(0);
1235          }
1236      }
1237  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-MultipleHostsTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from MudBlazor-MDEwOlJlcG9zaXRvcnkyODg0Mjg2NzY=-flat-FormTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>430          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.InvalidAuthorizationSpecification));
431          var state = conn.NpgsqlDataSource.GetDatabaseState();
432          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
433      }
434      [Test]
435      public async Task Offline_state_on_query_execution_pg_critical_failure()
436      {
437          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
438          await using var dataSource = postmaster.CreateDataSource();
439          await using var conn = await dataSource.OpenConnectionAsync();
440          await using var anotherConn = await dataSource.OpenConnectionAsync();
441          await anotherConn.CloseAsync();
</pre></code></div>
                <div class="column column_space"><pre><code>992              var comp = Context.RenderComponent<FormShouldRegisterOnlyTopSubscribeToParentFormFormControlsTest>();
993              var form = comp.FindComponent<MudFormTestable>().Instance;
994              Assert.AreEqual(14, form.FormControls.Count);
995          }
996          [Test]
997          public async Task MudForm_Validation_Should_OverrideFieldValidation()
998          {
999              var comp = Context.RenderComponent<FormValidationOverrideFieldValidationTest>();
1000              var textFields = comp.FindComponents<MudTextField<string>>();
1001              var numericFields = comp.FindComponents<MudNumericField<int>>();
1002              var defaultValidation = "v";
1003              textFields[0].Instance.Validation.Should().Be(defaultValidation);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    