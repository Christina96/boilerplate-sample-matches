
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 15, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ConfigurationManagerL0.cs</h3>
            <pre><code>1  using GitHub.DistributedTask.WebApi;
2  using GitHub.Runner.Listener;
3  using GitHub.Runner.Listener.Configuration;
4  using GitHub.Runner.Common.Util;
5  using GitHub.Services.WebApi;
6  using Moq;
7  using System;
8  using System.Collections.Generic;
9  using System.Linq;
10  using System.Runtime.CompilerServices;
11  using System.Security.Cryptography;
12  using System.Threading.Tasks;
13  using Xunit;
14  using GitHub.Services.Location;
15  using GitHub.Services.Common;
16  namespace GitHub.Runner.Common.Tests.Listener.Configuration
17  {
18      public class ConfigurationManagerL0
19      {
20          private Mock<IRunnerServer> _runnerServer;
21          private Mock<IRunnerDotcomServer> _dotcomServer;
22          private Mock<ILocationServer> _locationServer;
23          private Mock<ICredentialManager> _credMgr;
24          private Mock<IPromptManager> _promptManager;
25          private Mock<IConfigurationStore> _store;
26          private Mock<IExtensionManager> _extnMgr;
27  #if OS_WINDOWS
28          private Mock<IWindowsServiceControlManager> _serviceControlManager;
29  #endif
30  #if !OS_WINDOWS
31          private Mock<ILinuxServiceControlManager> _serviceControlManager;
32  #endif
33          private Mock<IRSAKeyManager> _rsaKeyManager;
34          private string _expectedToken = "expectedToken";
35          private string _expectedServerUrl = "https:&bsol;&bsol;codedev.ms";
36          private string _expectedAgentName = "expectedAgentName";
37          private string _defaultRunnerGroupName = "defaultRunnerGroup";
38          private string _secondRunnerGroupName = "secondRunnerGroup";
39          private string _expectedAuthType = "pat";
40          private string _expectedWorkFolder = "_work";
41          private int _defaultRunnerGroupId = 1;
42          private int _secondRunnerGroupId = 2;
43          private RSACryptoServiceProvider rsa = null;
44          private RunnerSettings _configMgrAgentSettings = new();
45          public ConfigurationManagerL0()
46          {
47              _runnerServer = new Mock<IRunnerServer>();
48              _locationServer = new Mock<ILocationServer>();
49              _credMgr = new Mock<ICredentialManager>();
50              _promptManager = new Mock<IPromptManager>();
51              _store = new Mock<IConfigurationStore>();
52              _extnMgr = new Mock<IExtensionManager>();
53              _rsaKeyManager = new Mock<IRSAKeyManager>();
54              _dotcomServer = new Mock<IRunnerDotcomServer>();
55  #if OS_WINDOWS
56              _serviceControlManager = new Mock<IWindowsServiceControlManager>();
57  #endif
58  #if !OS_WINDOWS
59              _serviceControlManager = new Mock<ILinuxServiceControlManager>();
60  #endif
61              var expectedAgent = new TaskAgent(_expectedAgentName) { Id = 1, Ephemeral = true, DisableUpdate = true };
62              expectedAgent.Authorization = new TaskAgentAuthorization
63              {
64                  ClientId = Guid.NewGuid(),
65                  AuthorizationUrl = new Uri("http:&bsol;&bsol;localhost:8080/pipelines"),
66              };
67              var expectedRunner = new GitHub.DistributedTask.WebApi.Runner() { Name = expectedAgent.Name, Id = 1 };
68              expectedRunner.RunnerAuthorization = new GitHub.DistributedTask.WebApi.Runner.Authorization
69              {
70                  ClientId = expectedAgent.Authorization.ClientId.ToString(),
71                  AuthorizationUrl = new Uri("http:&bsol;&bsol;localhost:8080/pipelines"),
72              };
73              var connectionData = new ConnectionData()
74              {
75                  InstanceId = Guid.NewGuid(),
76                  DeploymentType = DeploymentFlags.Hosted,
77                  DeploymentId = Guid.NewGuid()
78              };
79              _runnerServer.Setup(x => x.ConnectAsync(It.IsAny<Uri>(), It.IsAny<VssCredentials>())).Returns(Task.FromResult<object>(null));
80              _locationServer.Setup(x => x.ConnectAsync(It.IsAny<VssConnection>())).Returns(Task.FromResult<object>(null));
81              _locationServer.Setup(x => x.GetConnectionDataAsync()).Returns(Task.FromResult<ConnectionData>(connectionData));
82              _store.Setup(x => x.IsConfigured()).Returns(false);
83              _store.Setup(x => x.HasCredentials()).Returns(false);
84              _store.Setup(x => x.GetSettings()).Returns(() => _configMgrAgentSettings);
85              _store.Setup(x => x.SaveSettings(It.IsAny<RunnerSettings>()))
86                  .Callback((RunnerSettings settings) =>
87                  {
88                      _configMgrAgentSettings = settings;
89                  });
90              _credMgr.Setup(x => x.GetCredentialProvider(It.IsAny<string>())).Returns(new TestRunnerCredential());
91  #if !OS_WINDOWS
92              _serviceControlManager.Setup(x => x.GenerateScripts(It.IsAny<RunnerSettings>()));
93  #endif
94              var expectedPools = new List<TaskAgentPool>() { new TaskAgentPool(_defaultRunnerGroupName) { Id = _defaultRunnerGroupId, IsInternal = true }, new TaskAgentPool(_secondRunnerGroupName) { Id = _secondRunnerGroupId } };
95              _runnerServer.Setup(x => x.GetAgentPoolsAsync(It.IsAny<string>(), It.IsAny<TaskAgentPoolType>())).Returns(Task.FromResult(expectedPools));
96              var expectedAgents = new List<TaskAgent>();
97              _runnerServer.Setup(x => x.GetAgentsAsync(It.IsAny<int>(), It.IsAny<string>())).Returns(Task.FromResult(expectedAgents));
98              _runnerServer.Setup(x => x.AddAgentAsync(It.IsAny<int>(), It.IsAny<TaskAgent>())).Returns(Task.FromResult(expectedAgent));
99              _runnerServer.Setup(x => x.ReplaceAgentAsync(It.IsAny<int>(), It.IsAny<TaskAgent>())).Returns(Task.FromResult(expectedAgent));
100              _dotcomServer.Setup(x => x.GetRunnersAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>(), It.IsAny<string>())).Returns(Task.FromResult(expectedAgents));
101              _dotcomServer.Setup(x => x.GetRunnerGroupsAsync(It.IsAny<string>(), It.IsAny<string>())).Returns(Task.FromResult(expectedPools));
102              _dotcomServer.Setup(x => x.AddRunnerAsync(It.IsAny<int>(), It.IsAny<TaskAgent>(), It.IsAny<string>(), It.IsAny<string>(), It.IsAny<string>())).Returns(Task.FromResult(expectedRunner));
103              rsa = new RSACryptoServiceProvider(2048);
104              _rsaKeyManager.Setup(x => x.CreateKey()).Returns(rsa);
105          }
106          private TestHostContext CreateTestContext([CallerMemberName] String testName = "")
107          {
108              TestHostContext tc = new(this, testName);
109              tc.SetSingleton<ICredentialManager>(_credMgr.Object);
110              tc.SetSingleton<IPromptManager>(_promptManager.Object);
111              tc.SetSingleton<IConfigurationStore>(_store.Object);
112              tc.SetSingleton<IExtensionManager>(_extnMgr.Object);
113              tc.SetSingleton<IRunnerServer>(_runnerServer.Object);
114              tc.SetSingleton<IRunnerDotcomServer>(_dotcomServer.Object);
115              tc.SetSingleton<ILocationServer>(_locationServer.Object);
116  #if OS_WINDOWS
117              tc.SetSingleton<IWindowsServiceControlManager>(_serviceControlManager.Object);
118  #else
119              tc.SetSingleton<ILinuxServiceControlManager>(_serviceControlManager.Object);
120  #endif
121              tc.SetSingleton<IRSAKeyManager>(_rsaKeyManager.Object);
122              return tc;
123          }
124          [Fact]
125          [Trait("Level", "L0")]
126          [Trait("Category", "ConfigurationManagement")]
127          public async Task CanEnsureConfigure()
128          {
129              using (TestHostContext tc = CreateTestContext())
130              {
131                  Tracing trace = tc.GetTrace();
<span onclick='openModal()' class='match'>132                  trace.Info("Creating config manager");
133                  IConfigurationManager configManager = new ConfigurationManager();
134                  configManager.Initialize(tc);
</span>135                  var userLabels = "userlabel1,userlabel2";
136                  trace.Info("Preparing command line arguments");
137                  var command = new CommandSettings(
138                      tc,
139                      new[]
140                      {
141                         "configure",
142                         "--url", _expectedServerUrl,
143                         "--name", _expectedAgentName,
144                         "--runnergroup", _secondRunnerGroupName,
145                         "--work", _expectedWorkFolder,
146                         "--auth", _expectedAuthType,
147                         "--token", _expectedToken,
148                         "--labels", userLabels,
149                         "--ephemeral",
150                         "--disableupdate",
151                         "--unattended",
152                      });
153                  trace.Info("Constructed.");
154                  _store.Setup(x => x.IsConfigured()).Returns(false);
155                  _configMgrAgentSettings = null;
156                  trace.Info("Ensuring all the required parameters are available in the command line parameter");
157                  await configManager.ConfigureAsync(command);
158                  _store.Setup(x => x.IsConfigured()).Returns(true);
159                  trace.Info("Configured, verifying all the parameter value");
160                  var s = configManager.LoadSettings();
161                  Assert.NotNull(s);
162                  Assert.True(s.ServerUrl.Equals(_expectedServerUrl));
163                  Assert.True(s.AgentName.Equals(_expectedAgentName));
164                  Assert.True(s.PoolId.Equals(_secondRunnerGroupId));
165                  Assert.True(s.WorkFolder.Equals(_expectedWorkFolder));
166                  Assert.True(s.Ephemeral.Equals(true));
167                  _runnerServer.Verify(x => x.GetAgentPoolsAsync(It.IsAny<string>(), It.Is<TaskAgentPoolType>(p => p == TaskAgentPoolType.Automation)), Times.Exactly(2));
168                  var expectedLabels = new List<string>() { "self-hosted", VarUtil.OS, VarUtil.OSArchitecture };
169                  expectedLabels.AddRange(userLabels.Split(",").ToList());
170                  _runnerServer.Verify(x => x.AddAgentAsync(It.IsAny<int>(), It.Is<TaskAgent>(a => a.Labels.Select(x => x.Name).ToHashSet().SetEquals(expectedLabels))), Times.Once);
171              }
172          }
173          [Fact]
174          [Trait("Level", "L0")]
175          [Trait("Category", "ConfigurationManagement")]
176          public async Task ConfigureErrorDefaultLabelsDisabledWithNoCustomLabels()
177          {
178              using (TestHostContext tc = CreateTestContext())
179              {
180                  Tracing trace = tc.GetTrace();
181                  trace.Info("Creating config manager");
182                  IConfigurationManager configManager = new ConfigurationManager();
183                  configManager.Initialize(tc);
184                  trace.Info("Preparing command line arguments");
185                  var command = new CommandSettings(
186                      tc,
187                      new[]
188                      {
189                         "configure",
190                         "--url", _expectedServerUrl,
191                         "--name", _expectedAgentName,
192                         "--runnergroup", _secondRunnerGroupName,
193                         "--work", _expectedWorkFolder,
194                         "--auth", _expectedAuthType,
195                         "--token", _expectedToken,
196                         "--no-default-labels",
197                         "--ephemeral",
198                         "--disableupdate",
199                         "--unattended",
200                      });
201                  trace.Info("Constructed.");
202                  _store.Setup(x => x.IsConfigured()).Returns(false);
203                  _configMgrAgentSettings = null;
204                  trace.Info("Ensuring configure fails if default labels are disabled and no custom labels are set");
205                  var ex = await Assert.ThrowsAsync<NotSupportedException>(() => configManager.ConfigureAsync(command));
206                  Assert.Contains("--no-default-labels without specifying --labels is not supported", ex.Message);
207              }
208          }
209          [Fact]
210          [Trait("Level", "L0")]
211          [Trait("Category", "ConfigurationManagement")]
212          public async Task ConfigureDefaultLabelsDisabledWithCustomLabels()
213          {
214              using (TestHostContext tc = CreateTestContext())
215              {
216                  Tracing trace = tc.GetTrace();
217                  trace.Info("Creating config manager");
218                  IConfigurationManager configManager = new ConfigurationManager();
219                  configManager.Initialize(tc);
220                  var userLabels = "userlabel1,userlabel2";
221                  trace.Info("Preparing command line arguments");
222                  var command = new CommandSettings(
223                      tc,
224                      new[]
225                      {
226                         "configure",
227                         "--url", _expectedServerUrl,
228                         "--name", _expectedAgentName,
229                         "--runnergroup", _secondRunnerGroupName,
230                         "--work", _expectedWorkFolder,
231                         "--auth", _expectedAuthType,
232                         "--token", _expectedToken,
233                         "--labels", userLabels,
234                         "--no-default-labels",
235                         "--ephemeral",
236                         "--disableupdate",
237                         "--unattended",
238                      });
239                  trace.Info("Constructed.");
240                  _store.Setup(x => x.IsConfigured()).Returns(false);
241                  _configMgrAgentSettings = null;
242                  trace.Info("Ensuring all the required parameters are available in the command line parameter");
243                  await configManager.ConfigureAsync(command);
244                  _store.Setup(x => x.IsConfigured()).Returns(true);
245                  trace.Info("Configured, verifying all the parameter value");
246                  var s = configManager.LoadSettings();
247                  Assert.NotNull(s);
248                  Assert.True(s.ServerUrl.Equals(_expectedServerUrl));
249                  Assert.True(s.AgentName.Equals(_expectedAgentName));
250                  Assert.True(s.PoolId.Equals(_secondRunnerGroupId));
251                  Assert.True(s.WorkFolder.Equals(_expectedWorkFolder));
252                  Assert.True(s.Ephemeral.Equals(true));
253                  _runnerServer.Verify(x => x.GetAgentPoolsAsync(It.IsAny<string>(), It.Is<TaskAgentPoolType>(p => p == TaskAgentPoolType.Automation)), Times.Exactly(2));
254                  var expectedLabels = userLabels.Split(",").ToList();
255                  _runnerServer.Verify(x => x.AddAgentAsync(It.IsAny<int>(), It.Is<TaskAgent>(a => a.Labels.Select(x => x.Name).ToHashSet().SetEquals(expectedLabels))), Times.Once);
256              }
257          }
258          [Fact]
259          [Trait("Level", "L0")]
260          [Trait("Category", "ConfigurationManagement")]
261          public async Task ConfigureErrorOnMissingRunnerGroup()
262          {
263              using (TestHostContext tc = CreateTestContext())
264              {
265                  var expectedPools = new List<TaskAgentPool>() { new TaskAgentPool(_defaultRunnerGroupName) { Id = _defaultRunnerGroupId, IsInternal = true } };
266                  _runnerServer.Setup(x => x.GetAgentPoolsAsync(It.IsAny<string>(), It.IsAny<TaskAgentPoolType>())).Returns(Task.FromResult(expectedPools));
267                  Tracing trace = tc.GetTrace();
268                  trace.Info("Creating config manager");
269                  IConfigurationManager configManager = new ConfigurationManager();
270                  configManager.Initialize(tc);
271                  trace.Info("Preparing command line arguments");
272                  var command = new CommandSettings(
273                      tc,
274                      new[]
275                      {
276                         "configure",
277                         "--url", _expectedServerUrl,
278                         "--name", _expectedAgentName,
279                         "--runnergroup", "notexists",
280                         "--work", _expectedWorkFolder,
281                         "--auth", _expectedAuthType,
282                         "--token", _expectedToken,
283                      });
284                  trace.Info("Constructed.");
285                  _store.Setup(x => x.IsConfigured()).Returns(false);
286                  _configMgrAgentSettings = null;
287                  trace.Info("Ensuring all the required parameters are available in the command line parameter");
288                  var ex = await Assert.ThrowsAsync<TaskAgentPoolNotFoundException>(() => configManager.ConfigureAsync(command));
289                  Assert.Contains("notexists", ex.Message);
290                  _runnerServer.Verify(x => x.GetAgentPoolsAsync(It.IsAny<string>(), It.Is<TaskAgentPoolType>(p => p == TaskAgentPoolType.Automation)), Times.Exactly(1));
291              }
292          }
293  #if OS_LINUX
294          [Fact]
295          [Trait("Level", "L0")]
296          [Trait("Category", "ConfigurationManagement")]
297          public async Task ConfigureRunnerServiceFailsOnUnconfiguredRunners()
298          {
299              using (TestHostContext tc = CreateTestContext())
300              {
301                  Tracing trace = tc.GetTrace();
302                  trace.Info("Creating config manager");
303                  IConfigurationManager configManager = new ConfigurationManager();
304                  configManager.Initialize(tc);
305                  trace.Info("Preparing command line arguments");
306                  var command = new CommandSettings(
307                      tc,
308                      new[]
309                      {
310                         "configure",
311                         "--generateServiceConfig",
312                      });
313                  trace.Info("Constructed");
314                  _store.Setup(x => x.IsConfigured()).Returns(false);
315                  trace.Info("Ensuring service generation mode fails when on un-configured runners");
316                  var ex = await Assert.ThrowsAsync<InvalidOperationException>(() => configManager.ConfigureAsync(command));
317                  Assert.Contains("requires that the runner is already configured", ex.Message);
318              }
319          }
320          [Fact]
321          [Trait("Level", "L0")]
322          [Trait("Category", "ConfigurationManagement")]
323          public async Task ConfigureRunnerServiceCreatesService()
324          {
325              using (TestHostContext tc = CreateTestContext())
326              {
327                  Tracing trace = tc.GetTrace();
328                  trace.Info("Creating config manager");
329                  IConfigurationManager configManager = new ConfigurationManager();
330                  configManager.Initialize(tc);
331                  trace.Info("Preparing command line arguments");
332                  var command = new CommandSettings(
333                      tc,
334                      new[]
335                      {
336                         "configure",
337                         "--generateServiceConfig",
338                      });
339                  trace.Info("Constructed");
340                  _store.Setup(x => x.IsConfigured()).Returns(true);
341                  trace.Info("Ensuring service generation mode fails when on un-configured runners");
342                  await configManager.ConfigureAsync(command);
343                  _serviceControlManager.Verify(x => x.GenerateScripts(It.IsAny<RunnerSettings>()), Times.Once);
344              }
345          }
346  #endif
347  #if !OS_LINUX
348          [Fact]
349          [Trait("Level", "L0")]
350          [Trait("Category", "ConfigurationManagement")]
351          public async Task ConfigureRunnerServiceFailsOnUnsupportedPlatforms()
352          {
353              using (TestHostContext tc = CreateTestContext())
354              {
355                  Tracing trace = tc.GetTrace();
356                  trace.Info("Creating config manager");
357                  IConfigurationManager configManager = new ConfigurationManager();
358                  configManager.Initialize(tc);
359                  trace.Info("Preparing command line arguments");
360                  var command = new CommandSettings(
361                      tc,
362                      new[]
363                      {
364                         "configure",
365                         "--generateServiceConfig",
366                      });
367                  trace.Info("Constructed");
368                  _store.Setup(x => x.IsConfigured()).Returns(true);
369                  trace.Info("Ensuring service generation mode fails on unsupported runner platforms");
370                  var ex = await Assert.ThrowsAsync<NotSupportedException>(() => configManager.ConfigureAsync(command));
371                  Assert.Contains("only supported on Linux", ex.Message);
372              }
373          }
374  #endif
375      }
376  }
</code></pre>
        </div>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ConfigurationManagerL0.cs</h3>
            <pre><code>1  using GitHub.DistributedTask.WebApi;
2  using GitHub.Runner.Listener;
3  using GitHub.Runner.Listener.Configuration;
4  using GitHub.Runner.Common.Util;
5  using GitHub.Services.WebApi;
6  using Moq;
7  using System;
8  using System.Collections.Generic;
9  using System.Linq;
10  using System.Runtime.CompilerServices;
11  using System.Security.Cryptography;
12  using System.Threading.Tasks;
13  using Xunit;
14  using GitHub.Services.Location;
15  using GitHub.Services.Common;
16  namespace GitHub.Runner.Common.Tests.Listener.Configuration
17  {
18      public class ConfigurationManagerL0
19      {
20          private Mock<IRunnerServer> _runnerServer;
21          private Mock<IRunnerDotcomServer> _dotcomServer;
22          private Mock<ILocationServer> _locationServer;
23          private Mock<ICredentialManager> _credMgr;
24          private Mock<IPromptManager> _promptManager;
25          private Mock<IConfigurationStore> _store;
26          private Mock<IExtensionManager> _extnMgr;
27  #if OS_WINDOWS
28          private Mock<IWindowsServiceControlManager> _serviceControlManager;
29  #endif
30  #if !OS_WINDOWS
31          private Mock<ILinuxServiceControlManager> _serviceControlManager;
32  #endif
33          private Mock<IRSAKeyManager> _rsaKeyManager;
34          private string _expectedToken = "expectedToken";
35          private string _expectedServerUrl = "https:&bsol;&bsol;codedev.ms";
36          private string _expectedAgentName = "expectedAgentName";
37          private string _defaultRunnerGroupName = "defaultRunnerGroup";
38          private string _secondRunnerGroupName = "secondRunnerGroup";
39          private string _expectedAuthType = "pat";
40          private string _expectedWorkFolder = "_work";
41          private int _defaultRunnerGroupId = 1;
42          private int _secondRunnerGroupId = 2;
43          private RSACryptoServiceProvider rsa = null;
44          private RunnerSettings _configMgrAgentSettings = new();
45          public ConfigurationManagerL0()
46          {
47              _runnerServer = new Mock<IRunnerServer>();
48              _locationServer = new Mock<ILocationServer>();
49              _credMgr = new Mock<ICredentialManager>();
50              _promptManager = new Mock<IPromptManager>();
51              _store = new Mock<IConfigurationStore>();
52              _extnMgr = new Mock<IExtensionManager>();
53              _rsaKeyManager = new Mock<IRSAKeyManager>();
54              _dotcomServer = new Mock<IRunnerDotcomServer>();
55  #if OS_WINDOWS
56              _serviceControlManager = new Mock<IWindowsServiceControlManager>();
57  #endif
58  #if !OS_WINDOWS
59              _serviceControlManager = new Mock<ILinuxServiceControlManager>();
60  #endif
61              var expectedAgent = new TaskAgent(_expectedAgentName) { Id = 1, Ephemeral = true, DisableUpdate = true };
62              expectedAgent.Authorization = new TaskAgentAuthorization
63              {
64                  ClientId = Guid.NewGuid(),
65                  AuthorizationUrl = new Uri("http:&bsol;&bsol;localhost:8080/pipelines"),
66              };
67              var expectedRunner = new GitHub.DistributedTask.WebApi.Runner() { Name = expectedAgent.Name, Id = 1 };
68              expectedRunner.RunnerAuthorization = new GitHub.DistributedTask.WebApi.Runner.Authorization
69              {
70                  ClientId = expectedAgent.Authorization.ClientId.ToString(),
71                  AuthorizationUrl = new Uri("http:&bsol;&bsol;localhost:8080/pipelines"),
72              };
73              var connectionData = new ConnectionData()
74              {
75                  InstanceId = Guid.NewGuid(),
76                  DeploymentType = DeploymentFlags.Hosted,
77                  DeploymentId = Guid.NewGuid()
78              };
79              _runnerServer.Setup(x => x.ConnectAsync(It.IsAny<Uri>(), It.IsAny<VssCredentials>())).Returns(Task.FromResult<object>(null));
80              _locationServer.Setup(x => x.ConnectAsync(It.IsAny<VssConnection>())).Returns(Task.FromResult<object>(null));
81              _locationServer.Setup(x => x.GetConnectionDataAsync()).Returns(Task.FromResult<ConnectionData>(connectionData));
82              _store.Setup(x => x.IsConfigured()).Returns(false);
83              _store.Setup(x => x.HasCredentials()).Returns(false);
84              _store.Setup(x => x.GetSettings()).Returns(() => _configMgrAgentSettings);
85              _store.Setup(x => x.SaveSettings(It.IsAny<RunnerSettings>()))
86                  .Callback((RunnerSettings settings) =>
87                  {
88                      _configMgrAgentSettings = settings;
89                  });
90              _credMgr.Setup(x => x.GetCredentialProvider(It.IsAny<string>())).Returns(new TestRunnerCredential());
91  #if !OS_WINDOWS
92              _serviceControlManager.Setup(x => x.GenerateScripts(It.IsAny<RunnerSettings>()));
93  #endif
94              var expectedPools = new List<TaskAgentPool>() { new TaskAgentPool(_defaultRunnerGroupName) { Id = _defaultRunnerGroupId, IsInternal = true }, new TaskAgentPool(_secondRunnerGroupName) { Id = _secondRunnerGroupId } };
95              _runnerServer.Setup(x => x.GetAgentPoolsAsync(It.IsAny<string>(), It.IsAny<TaskAgentPoolType>())).Returns(Task.FromResult(expectedPools));
96              var expectedAgents = new List<TaskAgent>();
97              _runnerServer.Setup(x => x.GetAgentsAsync(It.IsAny<int>(), It.IsAny<string>())).Returns(Task.FromResult(expectedAgents));
98              _runnerServer.Setup(x => x.AddAgentAsync(It.IsAny<int>(), It.IsAny<TaskAgent>())).Returns(Task.FromResult(expectedAgent));
99              _runnerServer.Setup(x => x.ReplaceAgentAsync(It.IsAny<int>(), It.IsAny<TaskAgent>())).Returns(Task.FromResult(expectedAgent));
100              _dotcomServer.Setup(x => x.GetRunnersAsync(It.IsAny<int>(), It.IsAny<string>(), It.IsAny<string>(), It.IsAny<string>())).Returns(Task.FromResult(expectedAgents));
101              _dotcomServer.Setup(x => x.GetRunnerGroupsAsync(It.IsAny<string>(), It.IsAny<string>())).Returns(Task.FromResult(expectedPools));
102              _dotcomServer.Setup(x => x.AddRunnerAsync(It.IsAny<int>(), It.IsAny<TaskAgent>(), It.IsAny<string>(), It.IsAny<string>(), It.IsAny<string>())).Returns(Task.FromResult(expectedRunner));
103              rsa = new RSACryptoServiceProvider(2048);
104              _rsaKeyManager.Setup(x => x.CreateKey()).Returns(rsa);
105          }
106          private TestHostContext CreateTestContext([CallerMemberName] String testName = "")
107          {
108              TestHostContext tc = new(this, testName);
109              tc.SetSingleton<ICredentialManager>(_credMgr.Object);
110              tc.SetSingleton<IPromptManager>(_promptManager.Object);
111              tc.SetSingleton<IConfigurationStore>(_store.Object);
112              tc.SetSingleton<IExtensionManager>(_extnMgr.Object);
113              tc.SetSingleton<IRunnerServer>(_runnerServer.Object);
114              tc.SetSingleton<IRunnerDotcomServer>(_dotcomServer.Object);
115              tc.SetSingleton<ILocationServer>(_locationServer.Object);
116  #if OS_WINDOWS
117              tc.SetSingleton<IWindowsServiceControlManager>(_serviceControlManager.Object);
118  #else
119              tc.SetSingleton<ILinuxServiceControlManager>(_serviceControlManager.Object);
120  #endif
121              tc.SetSingleton<IRSAKeyManager>(_rsaKeyManager.Object);
122              return tc;
123          }
124          [Fact]
125          [Trait("Level", "L0")]
126          [Trait("Category", "ConfigurationManagement")]
127          public async Task CanEnsureConfigure()
128          {
129              using (TestHostContext tc = CreateTestContext())
130              {
131                  Tracing trace = tc.GetTrace();
132                  trace.Info("Creating config manager");
133                  IConfigurationManager configManager = new ConfigurationManager();
134                  configManager.Initialize(tc);
135                  var userLabels = "userlabel1,userlabel2";
136                  trace.Info("Preparing command line arguments");
137                  var command = new CommandSettings(
138                      tc,
139                      new[]
140                      {
141                         "configure",
142                         "--url", _expectedServerUrl,
143                         "--name", _expectedAgentName,
144                         "--runnergroup", _secondRunnerGroupName,
145                         "--work", _expectedWorkFolder,
146                         "--auth", _expectedAuthType,
147                         "--token", _expectedToken,
148                         "--labels", userLabels,
149                         "--ephemeral",
150                         "--disableupdate",
151                         "--unattended",
152                      });
153                  trace.Info("Constructed.");
154                  _store.Setup(x => x.IsConfigured()).Returns(false);
155                  _configMgrAgentSettings = null;
156                  trace.Info("Ensuring all the required parameters are available in the command line parameter");
157                  await configManager.ConfigureAsync(command);
158                  _store.Setup(x => x.IsConfigured()).Returns(true);
159                  trace.Info("Configured, verifying all the parameter value");
160                  var s = configManager.LoadSettings();
161                  Assert.NotNull(s);
162                  Assert.True(s.ServerUrl.Equals(_expectedServerUrl));
163                  Assert.True(s.AgentName.Equals(_expectedAgentName));
164                  Assert.True(s.PoolId.Equals(_secondRunnerGroupId));
165                  Assert.True(s.WorkFolder.Equals(_expectedWorkFolder));
166                  Assert.True(s.Ephemeral.Equals(true));
167                  _runnerServer.Verify(x => x.GetAgentPoolsAsync(It.IsAny<string>(), It.Is<TaskAgentPoolType>(p => p == TaskAgentPoolType.Automation)), Times.Exactly(2));
168                  var expectedLabels = new List<string>() { "self-hosted", VarUtil.OS, VarUtil.OSArchitecture };
169                  expectedLabels.AddRange(userLabels.Split(",").ToList());
170                  _runnerServer.Verify(x => x.AddAgentAsync(It.IsAny<int>(), It.Is<TaskAgent>(a => a.Labels.Select(x => x.Name).ToHashSet().SetEquals(expectedLabels))), Times.Once);
171              }
172          }
173          [Fact]
174          [Trait("Level", "L0")]
175          [Trait("Category", "ConfigurationManagement")]
176          public async Task ConfigureErrorDefaultLabelsDisabledWithNoCustomLabels()
177          {
178              using (TestHostContext tc = CreateTestContext())
179              {
180                  Tracing trace = tc.GetTrace();
181                  trace.Info("Creating config manager");
182                  IConfigurationManager configManager = new ConfigurationManager();
183                  configManager.Initialize(tc);
184                  trace.Info("Preparing command line arguments");
185                  var command = new CommandSettings(
186                      tc,
187                      new[]
188                      {
189                         "configure",
190                         "--url", _expectedServerUrl,
191                         "--name", _expectedAgentName,
192                         "--runnergroup", _secondRunnerGroupName,
193                         "--work", _expectedWorkFolder,
194                         "--auth", _expectedAuthType,
195                         "--token", _expectedToken,
196                         "--no-default-labels",
197                         "--ephemeral",
198                         "--disableupdate",
199                         "--unattended",
200                      });
201                  trace.Info("Constructed.");
202                  _store.Setup(x => x.IsConfigured()).Returns(false);
203                  _configMgrAgentSettings = null;
204                  trace.Info("Ensuring configure fails if default labels are disabled and no custom labels are set");
205                  var ex = await Assert.ThrowsAsync<NotSupportedException>(() => configManager.ConfigureAsync(command));
206                  Assert.Contains("--no-default-labels without specifying --labels is not supported", ex.Message);
207              }
208          }
209          [Fact]
210          [Trait("Level", "L0")]
211          [Trait("Category", "ConfigurationManagement")]
212          public async Task ConfigureDefaultLabelsDisabledWithCustomLabels()
213          {
214              using (TestHostContext tc = CreateTestContext())
215              {
216                  Tracing trace = tc.GetTrace();
217                  trace.Info("Creating config manager");
218                  IConfigurationManager configManager = new ConfigurationManager();
219                  configManager.Initialize(tc);
220                  var userLabels = "userlabel1,userlabel2";
221                  trace.Info("Preparing command line arguments");
222                  var command = new CommandSettings(
223                      tc,
224                      new[]
225                      {
226                         "configure",
227                         "--url", _expectedServerUrl,
228                         "--name", _expectedAgentName,
229                         "--runnergroup", _secondRunnerGroupName,
230                         "--work", _expectedWorkFolder,
231                         "--auth", _expectedAuthType,
232                         "--token", _expectedToken,
233                         "--labels", userLabels,
234                         "--no-default-labels",
235                         "--ephemeral",
236                         "--disableupdate",
237                         "--unattended",
238                      });
239                  trace.Info("Constructed.");
240                  _store.Setup(x => x.IsConfigured()).Returns(false);
241                  _configMgrAgentSettings = null;
242                  trace.Info("Ensuring all the required parameters are available in the command line parameter");
243                  await configManager.ConfigureAsync(command);
244                  _store.Setup(x => x.IsConfigured()).Returns(true);
245                  trace.Info("Configured, verifying all the parameter value");
246                  var s = configManager.LoadSettings();
247                  Assert.NotNull(s);
248                  Assert.True(s.ServerUrl.Equals(_expectedServerUrl));
249                  Assert.True(s.AgentName.Equals(_expectedAgentName));
250                  Assert.True(s.PoolId.Equals(_secondRunnerGroupId));
251                  Assert.True(s.WorkFolder.Equals(_expectedWorkFolder));
252                  Assert.True(s.Ephemeral.Equals(true));
253                  _runnerServer.Verify(x => x.GetAgentPoolsAsync(It.IsAny<string>(), It.Is<TaskAgentPoolType>(p => p == TaskAgentPoolType.Automation)), Times.Exactly(2));
254                  var expectedLabels = userLabels.Split(",").ToList();
255                  _runnerServer.Verify(x => x.AddAgentAsync(It.IsAny<int>(), It.Is<TaskAgent>(a => a.Labels.Select(x => x.Name).ToHashSet().SetEquals(expectedLabels))), Times.Once);
256              }
257          }
258          [Fact]
259          [Trait("Level", "L0")]
260          [Trait("Category", "ConfigurationManagement")]
261          public async Task ConfigureErrorOnMissingRunnerGroup()
262          {
263              using (TestHostContext tc = CreateTestContext())
264              {
265                  var expectedPools = new List<TaskAgentPool>() { new TaskAgentPool(_defaultRunnerGroupName) { Id = _defaultRunnerGroupId, IsInternal = true } };
266                  _runnerServer.Setup(x => x.GetAgentPoolsAsync(It.IsAny<string>(), It.IsAny<TaskAgentPoolType>())).Returns(Task.FromResult(expectedPools));
267                  Tracing trace = tc.GetTrace();
<span onclick='openModal()' class='match'>268                  trace.Info("Creating config manager");
269                  IConfigurationManager configManager = new ConfigurationManager();
270                  configManager.Initialize(tc);
</span>271                  trace.Info("Preparing command line arguments");
272                  var command = new CommandSettings(
273                      tc,
274                      new[]
275                      {
276                         "configure",
277                         "--url", _expectedServerUrl,
278                         "--name", _expectedAgentName,
279                         "--runnergroup", "notexists",
280                         "--work", _expectedWorkFolder,
281                         "--auth", _expectedAuthType,
282                         "--token", _expectedToken,
283                      });
284                  trace.Info("Constructed.");
285                  _store.Setup(x => x.IsConfigured()).Returns(false);
286                  _configMgrAgentSettings = null;
287                  trace.Info("Ensuring all the required parameters are available in the command line parameter");
288                  var ex = await Assert.ThrowsAsync<TaskAgentPoolNotFoundException>(() => configManager.ConfigureAsync(command));
289                  Assert.Contains("notexists", ex.Message);
290                  _runnerServer.Verify(x => x.GetAgentPoolsAsync(It.IsAny<string>(), It.Is<TaskAgentPoolType>(p => p == TaskAgentPoolType.Automation)), Times.Exactly(1));
291              }
292          }
293  #if OS_LINUX
294          [Fact]
295          [Trait("Level", "L0")]
296          [Trait("Category", "ConfigurationManagement")]
297          public async Task ConfigureRunnerServiceFailsOnUnconfiguredRunners()
298          {
299              using (TestHostContext tc = CreateTestContext())
300              {
301                  Tracing trace = tc.GetTrace();
302                  trace.Info("Creating config manager");
303                  IConfigurationManager configManager = new ConfigurationManager();
304                  configManager.Initialize(tc);
305                  trace.Info("Preparing command line arguments");
306                  var command = new CommandSettings(
307                      tc,
308                      new[]
309                      {
310                         "configure",
311                         "--generateServiceConfig",
312                      });
313                  trace.Info("Constructed");
314                  _store.Setup(x => x.IsConfigured()).Returns(false);
315                  trace.Info("Ensuring service generation mode fails when on un-configured runners");
316                  var ex = await Assert.ThrowsAsync<InvalidOperationException>(() => configManager.ConfigureAsync(command));
317                  Assert.Contains("requires that the runner is already configured", ex.Message);
318              }
319          }
320          [Fact]
321          [Trait("Level", "L0")]
322          [Trait("Category", "ConfigurationManagement")]
323          public async Task ConfigureRunnerServiceCreatesService()
324          {
325              using (TestHostContext tc = CreateTestContext())
326              {
327                  Tracing trace = tc.GetTrace();
328                  trace.Info("Creating config manager");
329                  IConfigurationManager configManager = new ConfigurationManager();
330                  configManager.Initialize(tc);
331                  trace.Info("Preparing command line arguments");
332                  var command = new CommandSettings(
333                      tc,
334                      new[]
335                      {
336                         "configure",
337                         "--generateServiceConfig",
338                      });
339                  trace.Info("Constructed");
340                  _store.Setup(x => x.IsConfigured()).Returns(true);
341                  trace.Info("Ensuring service generation mode fails when on un-configured runners");
342                  await configManager.ConfigureAsync(command);
343                  _serviceControlManager.Verify(x => x.GenerateScripts(It.IsAny<RunnerSettings>()), Times.Once);
344              }
345          }
346  #endif
347  #if !OS_LINUX
348          [Fact]
349          [Trait("Level", "L0")]
350          [Trait("Category", "ConfigurationManagement")]
351          public async Task ConfigureRunnerServiceFailsOnUnsupportedPlatforms()
352          {
353              using (TestHostContext tc = CreateTestContext())
354              {
355                  Tracing trace = tc.GetTrace();
356                  trace.Info("Creating config manager");
357                  IConfigurationManager configManager = new ConfigurationManager();
358                  configManager.Initialize(tc);
359                  trace.Info("Preparing command line arguments");
360                  var command = new CommandSettings(
361                      tc,
362                      new[]
363                      {
364                         "configure",
365                         "--generateServiceConfig",
366                      });
367                  trace.Info("Constructed");
368                  _store.Setup(x => x.IsConfigured()).Returns(true);
369                  trace.Info("Ensuring service generation mode fails on unsupported runner platforms");
370                  var ex = await Assert.ThrowsAsync<NotSupportedException>(() => configManager.ConfigureAsync(command));
371                  Assert.Contains("only supported on Linux", ex.Message);
372              }
373          }
374  #endif
375      }
376  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ConfigurationManagerL0.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ConfigurationManagerL0.cs</div>
                </div>
                <div class="column column_space"><pre><code>132                  trace.Info("Creating config manager");
133                  IConfigurationManager configManager = new ConfigurationManager();
134                  configManager.Initialize(tc);
</pre></code></div>
                <div class="column column_space"><pre><code>268                  trace.Info("Creating config manager");
269                  IConfigurationManager configManager = new ConfigurationManager();
270                  configManager.Initialize(tc);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    