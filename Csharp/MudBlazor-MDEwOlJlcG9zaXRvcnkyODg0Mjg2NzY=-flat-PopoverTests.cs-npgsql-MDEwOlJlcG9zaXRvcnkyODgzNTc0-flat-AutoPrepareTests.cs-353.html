
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 19, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>MudBlazor-MDEwOlJlcG9zaXRvcnkyODg0Mjg2NzY=-flat-PopoverTests.cs</h3>
            <pre><code>1  #pragma warning disable CS1998 
2  using System;
3  using System.Collections.Generic;
4  using System.Threading;
5  using System.Threading.Tasks;
6  using Bunit;
7  using FluentAssertions;
8  using Microsoft.AspNetCore.Components;
9  using Microsoft.AspNetCore.Components.Rendering;
10  using Microsoft.Extensions.DependencyInjection;
11  using Microsoft.Extensions.Options;
12  using Microsoft.JSInterop;
13  using Microsoft.JSInterop.Infrastructure;
14  using Moq;
15  using MudBlazor.UnitTests.TestComponents;
16  using MudBlazor.UnitTests.TestComponents.Popover;
17  using NUnit.Framework;
18  using static Bunit.ComponentParameterFactory;
19  namespace MudBlazor.UnitTests.Components
20  {
21      [TestFixture]
22      public class PopoverTests : BunitTest
23      {
24          [Test]
25          public void PopoverOptions_Defaults()
26          {
27              var options = new PopoverOptions();
28              options.ContainerClass.Should().Be(&quot;mudblazor-main-content&quot;);
29              options.FlipMargin.Should().Be(0);
30              options.ThrowOnDuplicateProvider.Should().Be(true);
31          }
32          [Test]
33          [Obsolete]
34          public void MudPopoverHandler_Constructor()
35          {
36              RenderFragment renderFragement = (tree) =&gt; { };
37              var mock = Mock.Of&lt;IJSRuntime&gt;();
38              Action updater = () =&gt; { };
39              var handler = new MudPopoverHandler(renderFragement, mock, updater);
40              handler.Id.Should().NotBe(default(Guid));
41              handler.UserAttributes.Should().BeEmpty();
42              handler.Class.Should().BeNull();
43              handler.Tag.Should().BeNull();
44              handler.Fragment.Should().BeSameAs(renderFragement);
45              handler.IsConnected.Should().BeFalse();
46              handler.ShowContent.Should().BeFalse();
47          }
48          [Test]
49          [Obsolete]
50          public void MudPopoverHandler_PreventNullValuesInConstructor()
51          {
52              RenderFragment renderFragement = (tree) =&gt; { };
53              var mock = Mock.Of&lt;IJSRuntime&gt;();
54              Action updater = () =&gt; { };
55              Assert.Throws&lt;ArgumentNullException&gt;(() =&gt; new MudPopoverHandler(null, mock, updater));
56              Assert.Throws&lt;ArgumentNullException&gt;(() =&gt; new MudPopoverHandler(renderFragement, null, updater));
57              Assert.Throws&lt;ArgumentNullException&gt;(() =&gt; new MudPopoverHandler(renderFragement, mock, null));
58          }
59          [Test]
60          [Obsolete]
61          public void MudPopoverHandler_SetComponentBaseParameters()
62          {
63              RenderFragment renderFragement = (tree) =&gt; { };
64              var mock = Mock.Of&lt;IJSRuntime&gt;();
65              Action updater = () =&gt; { };
66              var handler = new MudPopoverHandler(renderFragement, mock, updater);
67              var comp = Context.RenderComponent&lt;MudBadge&gt;(p =&gt;
68              {
69                  p.Add(x =&gt; x.UserAttributes, new Dictionary&lt;string, object&gt; { { &quot;myprop1&quot;, &quot;myValue1&quot; } });
70                  p.Add(x =&gt; x.Tag, &quot;my tag&quot;);
71              });
72              handler.SetComponentBaseParameters(comp.Instance, &quot;my-extra-class&quot;, &quot;my-extra-style:2px&quot;, true);
73              handler.Id.Should().NotBe(default(Guid));
74              handler.UserAttributes.Should().BeEquivalentTo(new Dictionary&lt;string, object&gt; { { &quot;myprop1&quot;, &quot;myValue1&quot; } });
75              handler.Class.Should().Be(&quot;my-extra-class&quot;);
76              handler.Tag.Should().Be(&quot;my tag&quot;);
77              handler.Fragment.Should().BeSameAs(renderFragement);
78              handler.IsConnected.Should().BeFalse();
79              handler.ShowContent.Should().BeTrue();
80          }
81          [Test(Description = &quot;Remove in v7&quot;)]
82          [Obsolete]
83          public void MudPopoverHandler_UpdateFragment()
84          {
85              RenderFragment initialRenderFragement = (tree) =&gt; { };
86              var mock = Mock.Of&lt;IJSRuntime&gt;();
87              var updateCounter = 0;
88              Action updater = () =&gt; { updateCounter++; };
89              var handler = new MudPopoverHandler(initialRenderFragement, mock, updater);
90              var comp = Context.RenderComponent&lt;MudBadge&gt;(p =&gt;
91              {
92                  p.Add(x =&gt; x.UserAttributes, new Dictionary&lt;string, object&gt; { { &quot;myprop1&quot;, &quot;myValue1&quot; } });
93                  p.Add(x =&gt; x.Tag, &quot;my tag&quot;);
94              });
95              RenderFragment newRenderFragement = (tree) =&gt; { };
96              handler.UpdateFragment(newRenderFragement, comp.Instance, &quot;my-extra-class&quot;, &quot;my-extra-style:2px&quot;, true);
97              handler.Id.Should().NotBe(default(Guid));
98              handler.UserAttributes.Should().BeEquivalentTo(new Dictionary&lt;string, object&gt; { { &quot;myprop1&quot;, &quot;myValue1&quot; } });
99              handler.Class.Should().Be(&quot;my-extra-class&quot;);
100              handler.Style.Should().Be(&quot;my-extra-style:2px&quot;);
101              handler.Tag.Should().Be(&quot;my tag&quot;);
102              handler.Fragment.Should().BeSameAs(newRenderFragement);
103              handler.IsConnected.Should().BeFalse();
104              handler.ShowContent.Should().BeTrue();
105              updateCounter.Should().Be(1);
106          }
107          [Test]
108          [Obsolete]
109          public async Task MudPopoverHandler_UpdateFragmentAsync()
110          {
111              var mock = Mock.Of&lt;IJSRuntime&gt;();
112              var updateCounter = 0;
113              RenderFragment initialRenderFragment = _ =&gt; { };
114              RenderFragment newRenderFragment = _ =&gt; { };
115              void Updater() =&gt; updateCounter++;
116              var handler = new MudPopoverHandler(initialRenderFragment, mock, Updater);
117              var comp = Context.RenderComponent&lt;MudBadge&gt;(p =&gt;
118              {
119                  p.Add(x =&gt; x.UserAttributes, new Dictionary&lt;string, object&gt; { { &quot;myprop1&quot;, &quot;myValue1&quot; } });
120                  p.Add(x =&gt; x.Tag, &quot;my tag&quot;);
121              });
122              await handler.UpdateFragmentAsync(newRenderFragment, comp.Instance, &quot;my-extra-class&quot;, &quot;my-extra-style:2px&quot;, true);
123              handler.Id.Should().NotBe(default(Guid));
124              handler.UserAttributes.Should().BeEquivalentTo(new Dictionary&lt;string, object&gt; { { &quot;myprop1&quot;, &quot;myValue1&quot; } });
125              handler.Class.Should().Be(&quot;my-extra-class&quot;);
126              handler.Style.Should().Be(&quot;my-extra-style:2px&quot;);
127              handler.Tag.Should().Be(&quot;my tag&quot;);
128              handler.Fragment.Should().BeSameAs(newRenderFragment);
129              handler.IsConnected.Should().BeFalse();
130              handler.ShowContent.Should().BeTrue();
131              updateCounter.Should().Be(1);
132          }
133          [Test]
134          [Obsolete]
135          public async Task MudPopoverHandler_DetachAndUpdateFragmentAsync()
136          {
137              var mock = Mock.Of&lt;IJSRuntime&gt;();
138              var updateCounter = 0;
139              RenderFragment initialRenderFragment = _ =&gt; { };
140              RenderFragment newRenderFragment = _ =&gt; { };
141              void Updater() =&gt; updateCounter++;
142              var handler = new MudPopoverHandler(initialRenderFragment, mock, Updater);
143              var comp = Context.RenderComponent&lt;MudBadge&gt;(p =&gt;
144              {
145                  p.Add(x =&gt; x.UserAttributes, new Dictionary&lt;string, object&gt; { { &quot;myprop1&quot;, &quot;myValue1&quot; } });
146                  p.Add(x =&gt; x.Tag, &quot;my tag&quot;);
147              });
148              await handler.Detach();
149              await handler.UpdateFragmentAsync(newRenderFragment, comp.Instance, &quot;my-new-extra-class&quot;, &quot;my-new-extra-style:2px&quot;, true);
150              updateCounter.Should().Be(0);
151          }
152          [Test]
153          [Obsolete]
154          public async Task MudPopoverHandler_DetachAndUpdateFragmentConcurrent_UpdateFragmentDoesNotRunInTheSameTimeAsDetach()
155          {
156              var connectTcs = new TaskCompletionSource&lt;IJSVoidResult&gt;();
157              var mock = new Mock&lt;IJSRuntime&gt;();
158              var handler = new MudPopoverHandler((tree) =&gt; { }, mock.Object, () =&gt; { });
159              mock.Setup(x =&gt; x.InvokeAsync&lt;IJSVoidResult&gt;(&quot;mudPopover.connect&quot;, It.Is&lt;object[]&gt;(y =&gt; y.Length == 1 &amp;&amp; (Guid)y[0] == handler.Id)))
160                  .ReturnsAsync(Mock.Of&lt;IJSVoidResult&gt;())
161                  .Verifiable();
162              mock.Setup(x =&gt; x.InvokeAsync&lt;IJSVoidResult&gt;(&quot;mudPopover.disconnect&quot;, It.Is&lt;object[]&gt;(y =&gt; y.Length == 1 &amp;&amp; (Guid)y[0] == handler.Id)))
163                  .Returns(new ValueTask&lt;IJSVoidResult&gt;(connectTcs.Task))
164                  .Verifiable();
165              var comp = Context.RenderComponent&lt;MudBadge&gt;(p =&gt;
166              {
167                  p.Add(x =&gt; x.UserAttributes, new Dictionary&lt;string, object&gt; { { &quot;myprop1&quot;, &quot;myValue1&quot; } });
168                  p.Add(x =&gt; x.Tag, &quot;my tag&quot;);
169              });
170              RenderFragment newRenderFragement = (tree) =&gt; { };
171              await handler.Initialize();
172              _ = handler.Detach();
173              var task2 = handler.UpdateFragmentAsync(newRenderFragement, comp.Instance, &quot;my-new-extra-class&quot;, &quot;my-new-extra-style:2px&quot;, true);
174              var completedTask = await Task.WhenAny(Task.Delay(50), task2);
175              completedTask.Should().NotBe(task2);
176              mock.Verify();
177              mock.VerifyNoOtherCalls();
178          }
179          [Test]
180          [Obsolete]
181          public async Task MudPopoverHandler_DetachAndUpdateFragmentConcurrent_UpdateFragmentAsyncShouldRunAfterDetach()
182          {
183              var connectTcs = new TaskCompletionSource&lt;IJSVoidResult&gt;();
184              var mock = new Mock&lt;IJSRuntime&gt;();
185              var handler = new MudPopoverHandler(_ =&gt; { }, mock.Object, () =&gt; { });
186              mock.Setup(x =&gt; x.InvokeAsync&lt;IJSVoidResult&gt;(&quot;mudPopover.connect&quot;, It.Is&lt;object[]&gt;(y =&gt; y.Length == 1 &amp;&amp; (Guid)y[0] == handler.Id)))
187                  .ReturnsAsync(Mock.Of&lt;IJSVoidResult&gt;())
188                  .Verifiable();
189              mock.Setup(x =&gt; x.InvokeAsync&lt;IJSVoidResult&gt;(&quot;mudPopover.disconnect&quot;, It.Is&lt;object[]&gt;(y =&gt; y.Length == 1 &amp;&amp; (Guid)y[0] == handler.Id)))
190                  .Returns(new ValueTask&lt;IJSVoidResult&gt;(connectTcs.Task))
191                  .Verifiable();
192              var comp = Context.RenderComponent&lt;MudBadge&gt;(p =&gt;
193              {
194                  p.Add(x =&gt; x.UserAttributes, new Dictionary&lt;string, object&gt; { { &quot;myprop1&quot;, &quot;myValue1&quot; } });
195                  p.Add(x =&gt; x.Tag, &quot;my tag&quot;);
196              });
197              RenderFragment newRenderFragement = (tree) =&gt; { };
198              await handler.Initialize();
199              var task1 = handler.Detach();
200              var task2 = handler.UpdateFragmentAsync(newRenderFragement, comp.Instance, &quot;my-new-extra-class&quot;, &quot;my-new-extra-style:2px&quot;, true);
201              connectTcs.SetResult(Mock.Of&lt;IJSVoidResult&gt;());
202              await Task.WhenAll(task1, task2);
203              mock.Verify();
204              mock.VerifyNoOtherCalls();
205          }
206          [Test(Description = &quot;Remove in v7&quot;)]
207          [Obsolete]
208          public void MudPopoverHandler_UpdaterInvokationTest()
209          {
210              RenderFragment initialRenderFragement = (tree) =&gt; { };
211              var mock = Mock.Of&lt;IJSRuntime&gt;();
212              var updateCounter = 0;
213              Action updater = () =&gt; { updateCounter++; };
214              var handler = new MudPopoverHandler(initialRenderFragement, mock, updater);
215              var comp = Context.RenderComponent&lt;MudBadge&gt;(p =&gt;
216              {
217                  p.Add(x =&gt; x.UserAttributes, new Dictionary&lt;string, object&gt; { { &quot;myprop1&quot;, &quot;myValue1&quot; } });
218                  p.Add(x =&gt; x.Tag, &quot;my tag&quot;);
219              });
220              RenderFragment newRenderFragement = (tree) =&gt; { };
221              for (int i = 0; i &lt; 4; i++)
222              {
223                  handler.UpdateFragment(newRenderFragement, comp.Instance, &quot;my-extra-class&quot;, &quot;my-extra-style:2px&quot;, i % 2 == 0);
224              }
225              updateCounter.Should().Be(4);
226              handler.UpdateFragment(newRenderFragement, comp.Instance, &quot;my-new-extra-class&quot;, &quot;my-new-extra-style:2px&quot;, true);
227              updateCounter.Should().Be(5);
228              handler.Class.Should().Be(&quot;my-new-extra-class&quot;);
229              handler.Style.Should().Be(&quot;my-new-extra-style:2px&quot;);
230          }
231          [Test]
232          [Obsolete]
233          public async Task MudPopoverHandler_UpdaterInvocationAsync()
234          {
235              var mock = Mock.Of&lt;IJSRuntime&gt;();
236              var updateCounter = 0;
237              RenderFragment initialRenderFragment = _ =&gt; { };
238              RenderFragment newRenderFragment = _ =&gt; { };
239              void Updater() =&gt; updateCounter++;
240              var handler = new MudPopoverHandler(initialRenderFragment, mock, Updater);
241              var comp = Context.RenderComponent&lt;MudBadge&gt;(p =&gt;
242              {
243                  p.Add(x =&gt; x.UserAttributes, new Dictionary&lt;string, object&gt; { { &quot;myprop1&quot;, &quot;myValue1&quot; } });
244                  p.Add(x =&gt; x.Tag, &quot;my tag&quot;);
245              });
246              for (int i = 0; i &lt; 4; i++)
247              {
248                 await handler.UpdateFragmentAsync(newRenderFragment, comp.Instance, &quot;my-extra-class&quot;, &quot;my-extra-style:2px&quot;, i % 2 == 0);
249              }
250              updateCounter.Should().Be(4);
251              await handler.UpdateFragmentAsync(newRenderFragment, comp.Instance, &quot;my-new-extra-class&quot;, &quot;my-new-extra-style:2px&quot;, true);
252              updateCounter.Should().Be(5);
253              handler.Class.Should().Be(&quot;my-new-extra-class&quot;);
254              handler.Style.Should().Be(&quot;my-new-extra-style:2px&quot;);
255          }
256          [Test]
257          [Obsolete]
258          public async Task MudPopoverHandler_InitializeAndDetach()
259          {
260              var handlerId = Guid.NewGuid();
261              RenderFragment renderFragement = (tree) =&gt; { };
262              var mock = new Mock&lt;IJSRuntime&gt;();
263              mock.Setup(x =&gt;
264              x.InvokeAsync&lt;IJSVoidResult&gt;(
265                  &quot;mudPopover.connect&quot;,
266                  It.Is&lt;object[]&gt;(x =&gt; x.Length == 1 &amp;&amp; (Guid)x[0] == handlerId))).ReturnsAsync(Mock.Of&lt;IJSVoidResult&gt;).Verifiable();
267              mock.Setup(x =&gt;
268              x.InvokeAsync&lt;IJSVoidResult&gt;(
269                  &quot;mudPopover.disconnect&quot;,
270                  It.Is&lt;object[]&gt;(x =&gt; x.Length == 1 &amp;&amp; (Guid)x[0] == handlerId))).ReturnsAsync(Mock.Of&lt;IJSVoidResult&gt;).Verifiable();
271              var updateCounter = 0;
272              Action updater = () =&gt; { updateCounter++; };
273              var handler = new MudPopoverHandler(renderFragement, mock.Object, updater);
274              handlerId = handler.Id;
275              handler.IsConnected.Should().BeFalse();
276              await handler.Initialize();
277              handler.IsConnected.Should().BeTrue();
278              await handler.Detach();
279              handler.IsConnected.Should().BeFalse();
280          }
281          [Test]
282          [Obsolete]
283          public async Task MudPopoverHandler_InitializeAndDetach_DetachThrowsTaskCanceledException()
284          {
285              var handlerId = Guid.NewGuid();
286              RenderFragment renderFragement = (tree) =&gt; { };
287              var mock = new Mock&lt;IJSRuntime&gt;();
288              mock.Setup(x =&gt;
289              x.InvokeAsync&lt;IJSVoidResult&gt;(
290                  &quot;mudPopover.connect&quot;,
291                  It.Is&lt;object[]&gt;(x =&gt; x.Length == 1 &amp;&amp; (Guid)x[0] == handlerId))).ReturnsAsync(Mock.Of&lt;IJSVoidResult&gt;).Verifiable();
292              mock.Setup(x =&gt;
293              x.InvokeAsync&lt;IJSVoidResult&gt;(
294                  &quot;mudPopover.disconnect&quot;,
295                  It.Is&lt;object[]&gt;(x =&gt; x.Length == 1 &amp;&amp; (Guid)x[0] == handlerId))).ThrowsAsync(new TaskCanceledException()).Verifiable();
296              var updateCounter = 0;
297              Action updater = () =&gt; { updateCounter++; };
298              var handler = new MudPopoverHandler(renderFragement, mock.Object, updater);
299              handlerId = handler.Id;
300              await handler.Initialize();
301              await handler.Detach();
302              handler.IsConnected.Should().BeFalse();
303          }
304          [Test]
305          [Obsolete]
306          public async Task MudPopoverHandler_InitializeAndDetach_DetachThrowsNotTaskCanceledException()
307          {
308              var handlerId = Guid.NewGuid();
309              RenderFragment renderFragement = (tree) =&gt; { };
310              var mock = new Mock&lt;IJSRuntime&gt;();
311              mock.Setup(x =&gt;
312              x.InvokeAsync&lt;IJSVoidResult&gt;(
313                  &quot;mudPopover.connect&quot;,
314                  It.Is&lt;object[]&gt;(x =&gt; x.Length == 1 &amp;&amp; (Guid)x[0] == handlerId))).ReturnsAsync(Mock.Of&lt;IJSVoidResult&gt;).Verifiable();
315              mock.Setup(x =&gt;
316              x.InvokeAsync&lt;IJSVoidResult&gt;(
317                  &quot;mudPopover.disconnect&quot;,
318                  It.Is&lt;object[]&gt;(x =&gt; x.Length == 1 &amp;&amp; (Guid)x[0] == handlerId))).ThrowsAsync(new InvalidOperationException()).Verifiable();
319              var updateCounter = 0;
320              Action updater = () =&gt; { updateCounter++; };
321              var handler = new MudPopoverHandler(renderFragement, mock.Object, updater);
322              handlerId = handler.Id;
323              await handler.Initialize();
<span onclick='openModal()' class='match'>324              Assert.ThrowsAsync&lt;InvalidOperationException&gt;(async () =&gt; await handler.Detach());
325              handler.IsConnected.Should().BeFalse();
</span>326          }
327          [Test]
328          [Obsolete]
329          public async Task MudPopoverHandler_InitializeAndDetachConcurrent_DetachDoesNotRunAtSameTimeAsInitialize()
330          {
331              var connectTcs = new TaskCompletionSource&lt;IJSVoidResult&gt;();
332              var mock = new Mock&lt;IJSRuntime&gt;();
333              var handler = new MudPopoverHandler(_ =&gt; { }, mock.Object, () =&gt; { });
334              mock.Setup(x =&gt; x.InvokeAsync&lt;IJSVoidResult&gt;(&quot;mudPopover.connect&quot;, It.Is&lt;object[]&gt;(y =&gt; y.Length == 1 &amp;&amp; (Guid)y[0] == handler.Id)))
335                  .Returns(new ValueTask&lt;IJSVoidResult&gt;(connectTcs.Task))
336                  .Verifiable();
337              _ = handler.Initialize();
338              var task2 = handler.Detach();
339              var completedTask = await Task.WhenAny(Task.Delay(50), task2);
340              completedTask.Should().NotBe(task2);
341              mock.Verify();
342              mock.VerifyNoOtherCalls();
343          }
344          [Test]
345          [Obsolete]
346          public async Task MudPopoverHandler_InitializeAndDetachConcurrent_DetachRunsAfterInitialize()
347          {
348              var connectTcs = new TaskCompletionSource&lt;IJSVoidResult&gt;();
349              var mock = new Mock&lt;IJSRuntime&gt;();
350              var handler = new MudPopoverHandler(_ =&gt; { }, mock.Object, () =&gt; { });
351              mock.Setup(x =&gt; x.InvokeAsync&lt;IJSVoidResult&gt;(&quot;mudPopover.connect&quot;, It.Is&lt;object[]&gt;(y =&gt; y.Length == 1 &amp;&amp; (Guid)y[0] == handler.Id)))
352                  .Returns(new ValueTask&lt;IJSVoidResult&gt;(connectTcs.Task))
353                  .Verifiable();
354              mock.Setup(x =&gt; x.InvokeAsync&lt;IJSVoidResult&gt;(&quot;mudPopover.disconnect&quot;, It.Is&lt;object[]&gt;(y =&gt; y.Length == 1 &amp;&amp; (Guid)y[0] == handler.Id)))
355                  .ReturnsAsync(Mock.Of&lt;IJSVoidResult&gt;())
356                  .Verifiable();
357              var task1 = handler.Initialize();
358              var task2 = handler.Detach();
359              connectTcs.SetResult(Mock.Of&lt;IJSVoidResult&gt;());
360              await Task.WhenAll(task1, task2);
361              mock.Verify();
362              mock.VerifyNoOtherCalls();
363          }
364          [Test]
365          [Obsolete]
366          public async Task MudPopoverHandler_DetachCalledBeforeInitialize_NoInteropShouldOccur()
367          {
368              var mock = new Mock&lt;IJSRuntime&gt;();
369              var handler = new MudPopoverHandler(_ =&gt; { }, mock.Object, () =&gt; { });
370              await handler.Detach();
371              handler.IsConnected.Should().BeFalse();
372              await handler.Initialize();
373              handler.IsConnected.Should().BeFalse();
374              mock.VerifyNoOtherCalls();
375          }
376          [Test]
377          [Obsolete]
378          public void MudPopoverService_Constructor_NoJsInterop()
379          {
380              Assert.Throws&lt;ArgumentNullException&gt;(() =&gt; _ = new MudPopoverService(null));
381          }
382          [Test]
383          [Obsolete]
384          public async Task MudPopoverService_Constructor_NullOption()
385          {
386              var mock = new Mock&lt;IJSRuntime&gt;();
387              mock.Setup(x =&gt;
388             x.InvokeAsync&lt;IJSVoidResult&gt;(
389                 &quot;mudPopover.initialize&quot;,
390                 It.Is&lt;object[]&gt;(x =&gt; x.Length == 2 &amp;&amp; (string)x[0] == &quot;mudblazor-main-content&quot; &amp;&amp; (int)x[1] == 0))).ReturnsAsync(Mock.Of&lt;IJSVoidResult&gt;).Verifiable();
391              {
392                  var service = new MudPopoverService(mock.Object, null);
393                  await service.InitializeIfNeeded();
394              }
395              {
396                  var service = new MudPopoverService(mock.Object);
397                  await service.InitializeIfNeeded();
398              }
399              mock.Verify();
400          }
401          [Test]
402          [Obsolete]
403          public async Task MudPopoverService_Initialize_Catch_JSDisconnectedException()
404          {
405              var mock = new Mock&lt;IJSRuntime&gt;();
406              mock.Setup(x =&gt;
407             x.InvokeAsync&lt;IJSVoidResult&gt;(
408                 &quot;mudPopover.initialize&quot;,
409                 It.Is&lt;object[]&gt;(x =&gt; x.Length == 2 &amp;&amp; (string)x[0] == &quot;mudblazor-main-content&quot; &amp;&amp; (int)x[1] == 0))).ThrowsAsync(new JSDisconnectedException(&quot;JSDisconnectedException&quot;)).Verifiable();
410              {
411                  var service = new MudPopoverService(mock.Object);
412                  await service.InitializeIfNeeded();
413              }
414              mock.Verify();
415          }
416          [Test]
417          [Obsolete]
418          public async Task MudPopoverService_Initialize_Catch_TaskCanceledException()
419          {
420              var mock = new Mock&lt;IJSRuntime&gt;();
421              mock.Setup(x =&gt;
422             x.InvokeAsync&lt;IJSVoidResult&gt;(
423                 &quot;mudPopover.initialize&quot;,
424                 It.Is&lt;object[]&gt;(x =&gt; x.Length == 2 &amp;&amp; (string)x[0] == &quot;mudblazor-main-content&quot; &amp;&amp; (int)x[1] == 0))).ThrowsAsync(new TaskCanceledException()).Verifiable();
425              {
426                  var service = new MudPopoverService(mock.Object);
427                  await service.InitializeIfNeeded();
428              }
429              mock.Verify();
430          }
431          [Test]
432          [Obsolete]
433          public async Task MudPopoverService_Constructor_OptionWithCustomClass()
434          {
435              var mock = new Mock&lt;IJSRuntime&gt;();
436              var option = new PopoverOptions
437              {
438                  ContainerClass = &quot;my-custom-class&quot;,
439                  FlipMargin = 12,
440              };
441              var optionMock = new Mock&lt;IOptions&lt;PopoverOptions&gt;&gt;();
442              optionMock.SetupGet(x =&gt; x.Value).Returns(option);
443              mock.Setup(x =&gt;
444             x.InvokeAsync&lt;IJSVoidResult&gt;(
445                 &quot;mudPopover.initialize&quot;,
446                 It.Is&lt;object[]&gt;(x =&gt; x.Length == 2 &amp;&amp; (string)x[0] == &quot;my-custom-class&quot; &amp;&amp; (int)x[1] == 12))).ReturnsAsync(Mock.Of&lt;IJSVoidResult&gt;).Verifiable();
447              var service = new MudPopoverService(mock.Object, optionMock.Object);
448              await service.InitializeIfNeeded();
449              mock.Verify();
450          }
451          [Test]
452          [Obsolete]
453          public async Task MudPopoverService_CallInitializeOnlyOnce()
454          {
455              var mock = new Mock&lt;IJSRuntime&gt;();
456              mock.Setup(x =&gt;
457             x.InvokeAsync&lt;IJSVoidResult&gt;(
458                 &quot;mudPopover.initialize&quot;,
459                 It.Is&lt;object[]&gt;(x =&gt; x.Length == 2 &amp;&amp; (string)x[0] == &quot;mudblazor-main-content&quot; &amp;&amp; (int)x[1] == 0))).ReturnsAsync(Mock.Of&lt;IJSVoidResult&gt;(), TimeSpan.FromMilliseconds(300)).Verifiable();
460              Task[] tasks = new Task[5];
461              var service = new MudPopoverService(mock.Object);
462              for (int i = 0; i &lt; 5; i++)
463              {
464                  tasks[i] = Task.Run(async () =&gt; await service.InitializeIfNeeded());
465              }
466              Task.WaitAll(tasks);
467              mock.Verify(x =&gt;
468             x.InvokeAsync&lt;IJSVoidResult&gt;(
469                 &quot;mudPopover.initialize&quot;,
470                 It.Is&lt;object[]&gt;(x =&gt; x.Length == 2 &amp;&amp; (string)x[0] == &quot;mudblazor-main-content&quot; &amp;&amp; (int)x[1] == 0)), Times.Once());
471          }
472          [Test]
473          [Obsolete]
474          public async Task MudPopoverService_OnlyDisposeIfConnected()
475          {
476              var service = new MudPopoverService(Mock.Of&lt;IJSRuntime&gt;(MockBehavior.Strict));
477              await service.DisposeAsync();
478          }
479          [Test]
480          [Obsolete]
481          public async Task MudPopoverService_DisposeAsync()
482          {
483              var mock = new Mock&lt;IJSRuntime&gt;();
484              mock.Setup(x =&gt;
485             x.InvokeAsync&lt;IJSVoidResult&gt;(
486                 &quot;mudPopover.initialize&quot;,
487                 It.Is&lt;object[]&gt;(x =&gt; x.Length == 2 &amp;&amp; (string)x[0] == &quot;mudblazor-main-content&quot; &amp;&amp; (int)x[1] == 0))).ReturnsAsync(Mock.Of&lt;IJSVoidResult&gt;).Verifiable();
488              mock.Setup(x =&gt;
489              x.InvokeAsync&lt;IJSVoidResult&gt;(
490              &quot;mudPopover.dispose&quot;,
491              It.Is&lt;object[]&gt;(x =&gt; x.Length == 0))).ReturnsAsync(Mock.Of&lt;IJSVoidResult&gt;).Verifiable();
492              var service = new MudPopoverService(mock.Object);
493              await service.InitializeIfNeeded();
494              await service.DisposeAsync();
495              mock.Verify();
496          }
497          [Test]
498          [Obsolete]
499          public async Task MudPopoverService_DisposeAsync_WithTaskCancelException()
500          {
501              var mock = new Mock&lt;IJSRuntime&gt;();
502              mock.Setup(x =&gt;
503             x.InvokeAsync&lt;IJSVoidResult&gt;(
504                 &quot;mudPopover.initialize&quot;,
505                 It.Is&lt;object[]&gt;(x =&gt; x.Length == 2 &amp;&amp; (string)x[0] == &quot;mudblazor-main-content&quot; &amp;&amp; (int)x[1] == 0))).ReturnsAsync(Mock.Of&lt;IJSVoidResult&gt;).Verifiable();
506              mock.Setup(x =&gt;
507              x.InvokeAsync&lt;IJSVoidResult&gt;(
508              &quot;mudPopover.dispose&quot;,
509              It.Is&lt;object[]&gt;(x =&gt; x.Length == 0))).ThrowsAsync(new TaskCanceledException()).Verifiable();
510              var service = new MudPopoverService(mock.Object);
511              await service.InitializeIfNeeded();
512              await service.DisposeAsync();
513              mock.Verify();
514          }
515          [Test(Description = &quot;Remove in v7&quot;)]
516          [Obsolete]
517          public void MudPopoverService_RegisterAndUseHandler()
518          {
519              var service = new MudPopoverService(Mock.Of&lt;IJSRuntime&gt;(MockBehavior.Strict));
520              int fragmentChangedCounter = 0;
521              service.FragmentsChanged += (e, args) =&gt;
522              {
523                  fragmentChangedCounter++;
524              };
525              RenderFragment fragment = (builder) =&gt; { };
526              var handler = service.Register(fragment);
527              handler.Should().NotBeNull();
528              fragmentChangedCounter.Should().Be(1);
529              RenderFragment changedFragment = (builder) =&gt; { };
530              var comp = Context.RenderComponent&lt;MudBadge&gt;(p =&gt;
531              {
532                  p.Add(x =&gt; x.UserAttributes, new Dictionary&lt;string, object&gt; { { &quot;myprop1&quot;, &quot;myValue1&quot; } });
533                  p.Add(x =&gt; x.Tag, &quot;my tag&quot;);
534              });
535              handler.UpdateFragment(changedFragment, comp.Instance, &quot;my-class&quot;, &quot;my-style&quot;, true);
536              fragmentChangedCounter.Should().Be(1);
537          }
538          [Test]
539          [Obsolete]
540          public async Task MudPopoverService_RegisterAndUseHandlerAsync()
541          {
542              var service = new MudPopoverService(Mock.Of&lt;IJSRuntime&gt;(MockBehavior.Strict));
543              int fragmentChangedCounter = 0;
544              service.FragmentsChanged += (_, _) =&gt;
545              {
546                  fragmentChangedCounter++;
547              };
548              RenderFragment fragment = _ =&gt; { };
549              RenderFragment changedFragment = _ =&gt; { };
550              var handler = service.Register(fragment);
551              handler.Should().NotBeNull();
552              fragmentChangedCounter.Should().Be(1);
553              var comp = Context.RenderComponent&lt;MudBadge&gt;(p =&gt;
554              {
555                  p.Add(x =&gt; x.UserAttributes, new Dictionary&lt;string, object&gt; { { &quot;myprop1&quot;, &quot;myValue1&quot; } });
556                  p.Add(x =&gt; x.Tag, &quot;my tag&quot;);
557              });
558              await handler.UpdateFragmentAsync(changedFragment, comp.Instance, &quot;my-class&quot;, &quot;my-style&quot;, true);
559              fragmentChangedCounter.Should().Be(1);
560          }
561          [Test]
562          [Obsolete]
563          public async Task MudPopoverService_Unregister_NullFragment()
564          {
565              var service = new MudPopoverService(Mock.Of&lt;IJSRuntime&gt;(MockBehavior.Strict));
566              var result = await service.Unregister(null);
567              result.Should().BeFalse();
568          }
569          [Test]
570          [Obsolete]
571          public async Task MudPopoverService_Unregister_HandlerNotFound()
572          {
573              var service = new MudPopoverService(Mock.Of&lt;IJSRuntime&gt;(MockBehavior.Strict));
574              var handler = new MudPopoverHandler((tree) =&gt; { }, Mock.Of&lt;IJSRuntime&gt;(MockBehavior.Strict), () =&gt; { });
575              var result = await service.Unregister(handler);
576              result.Should().BeFalse();
577          }
578          [Test]
579          [Obsolete]
580          public async Task MudPopoverService_Unregister_NotConnected()
581          {
582              var service = new MudPopoverService(Mock.Of&lt;IJSRuntime&gt;(MockBehavior.Strict));
583              RenderFragment fragment = (builder) =&gt; { };
584              var handler = service.Register(fragment);
585              var result = await service.Unregister(handler);
586              result.Should().BeTrue();
587          }
588          [Test]
589          [Obsolete]
590          public async Task MudPopoverService_Unregister()
591          {
592              var handlerId = Guid.NewGuid();
593              var mock = new Mock&lt;IJSRuntime&gt;();
594              mock.Setup(jsRuntime =&gt;
595                      jsRuntime.InvokeAsync&lt;IJSVoidResult&gt;(
596                          &quot;mudPopover.connect&quot;,
597                          It.Is&lt;object[]&gt;(x =&gt; x.Length == 1 &amp;&amp; (Guid)x[0] == handlerId)))
598                  .ReturnsAsync(Mock.Of&lt;IJSVoidResult&gt;)
599                  .Verifiable();
600              mock.Setup(jsRuntime =&gt;
601                      jsRuntime.InvokeAsync&lt;IJSVoidResult&gt;(
602                          &quot;mudPopover.disconnect&quot;,
603                          It.Is&lt;object[]&gt;(x =&gt; x.Length == 1 &amp;&amp; (Guid)x[0] == handlerId)))
604                  .ReturnsAsync(Mock.Of&lt;IJSVoidResult&gt;)
605                  .Verifiable();
606              var service = new MudPopoverService(mock.Object);
607              await service.InitializeIfNeeded();
608              RenderFragment fragment = (builder) =&gt; { };
609              var handler = service.Register(fragment);
610              handlerId = handler.Id;
611              await handler.Initialize();
612              int fragmentChangedCounter = 0;
613              service.FragmentsChanged += (_, _) =&gt;
614              {
615                  fragmentChangedCounter++;
616              };
617              var result = await service.Unregister(handler);
618              result.Should().BeTrue();
619              fragmentChangedCounter.Should().Be(1);
620              var secondResult = await service.Unregister(handler);
621              secondResult.Should().BeFalse();
622              mock.Verify();
623          }
624          [Test]
625          public void MudPopover_DefaultValues()
626          {
627              var popover = new MudPopover();
628              popover.MaxHeight.Should().BeNull();
629              popover.Paper.Should().BeTrue();
630              popover.Elevation.Should().Be(8);
631              popover.Square.Should().BeFalse();
632              popover.Open.Should().BeFalse();
633              popover.Fixed.Should().BeFalse();
634              popover.AnchorOrigin.Should().Be(Origin.TopLeft);
635              popover.TransformOrigin.Should().Be(Origin.TopLeft);
636              popover.RelativeWidth.Should().BeFalse();
637              popover.OverflowBehavior.Should().Be(OverflowBehavior.FlipOnOpen);
638              popover.Duration.Should().Be(251);
639          }
640          [Test]
641          public async Task MudPopover_OpenAndClose()
642          {
643              var comp = Context.RenderComponent&lt;PopoverTest&gt;();
644              var provider = comp.Find(&quot;.mud-popover-provider&quot;);
645              provider.Children.Should().ContainSingle();
646              var popoverNode = comp.Find(&quot;.popoverparent&quot;).Children[1];
647              popoverNode.Id.Should().StartWith(&quot;popover-&quot;);
648              var handlerId = Guid.Parse(popoverNode.Id.Substring(8));
649              handlerId.Should().NotBe(Guid.Empty);
650              provider.Children.Should().ContainSingle();
651              provider.FirstElementChild.Id.Should().Be($&quot;popovercontent-{handlerId}&quot;);
652              provider.FirstElementChild.Children.Should().BeEmpty();
653              await comp.Instance.Open();
654              provider.FirstElementChild.Children.Should().ContainSingle();
655              provider.FirstElementChild.Children[0].TextContent.Should().Be(&quot;Popover content&quot;);
656              await comp.Instance.Close();
657              provider.FirstElementChild.Children.Should().BeEmpty();
658          }
659          [Test]
660          public void MudPopover_Property_MaxHeight()
661          {
662              var comp = Context.RenderComponent&lt;PopoverPropertyTest&gt;(p =&gt; p.Add(x =&gt; x.MaxHeight, 100));
663              var popoverElement = comp.Find(&quot;.test-popover-content&quot;).ParentElement;
664              popoverElement.GetAttribute(&quot;style&quot;).Split(&#x27;;&#x27;, StringSplitOptions.RemoveEmptyEntries).Should().Contain(new[] { &quot;max-height:100px&quot;, &quot;my-custom-style:3px&quot; });
665          }
666          [Test]
667          public void MudPopover_Property_TransitionDuration()
668          {
669              var comp = Context.RenderComponent&lt;PopoverPropertyTest&gt;(p =&gt; p.Add(x =&gt; x.Duration, 100));
670              var popoverElement = comp.Find(&quot;.test-popover-content&quot;).ParentElement;
671              popoverElement.GetAttribute(&quot;style&quot;).Split(&#x27;;&#x27;, StringSplitOptions.RemoveEmptyEntries).Should().Contain(new[] { &quot;transition-duration:100ms&quot; });
672          }
673          [Test]
674          public void MudPopover_Property_Fixed()
675          {
676              var comp = Context.RenderComponent&lt;PopoverPropertyTest&gt;(p =&gt; p.Add(
677                  x =&gt; x.Fixed, true));
678              var popoverElement = comp.Find(&quot;.test-popover-content&quot;).ParentElement;
679              popoverElement.ClassList.Should().Contain(new[] { &quot;mud-popover-open&quot;, &quot;mud-popover-fixed&quot;, &quot;my-custom-class&quot; });
680          }
681          [Test]
682          public void MudPopover_Property_RelativeWidth()
683          {
684              var comp = Context.RenderComponent&lt;PopoverPropertyTest&gt;(p =&gt; p.Add(
685                  x =&gt; x.RelativeWidth, true));
686              var popoverElement = comp.Find(&quot;.test-popover-content&quot;).ParentElement;
687              popoverElement.ClassList.Should().Contain(new[] { &quot;mud-popover-open&quot;, &quot;mud-popover-relative-width&quot;, &quot;my-custom-class&quot; });
688          }
689          [Test]
690          public void MudPopover_Property_Paper()
691          {
692              var comp = Context.RenderComponent&lt;PopoverPropertyTest&gt;(p =&gt; p.Add(
693                  x =&gt; x.Paper, true));
694              var popoverElement = comp.Find(&quot;.test-popover-content&quot;).ParentElement;
695              popoverElement.ClassList.Should().Contain(new[] { &quot;mud-popover-open&quot;, &quot;mud-paper&quot;, &quot;mud-elevation-8&quot;, &quot;my-custom-class&quot; });
696          }
697          [Test]
698          public void MudPopover_Property_PaperAndSqaure()
699          {
700              var comp = Context.RenderComponent&lt;PopoverPropertyTest&gt;(p =&gt;
701              {
702                  p.Add(x =&gt; x.Paper, true);
703                  p.Add(x =&gt; x.Square, true);
704              });
705              var popoverElement = comp.Find(&quot;.test-popover-content&quot;).ParentElement;
706              popoverElement.ClassList.Should().Contain(new[] { &quot;mud-popover-open&quot;, &quot;mud-paper-square&quot;, &quot;mud-elevation-8&quot;, &quot;my-custom-class&quot; });
707          }
708          [Test]
709          public void MudPopover_Property_Elevation()
710          {
711              var comp = Context.RenderComponent&lt;PopoverPropertyTest&gt;(p =&gt;
712              {
713                  p.Add(x =&gt; x.Paper, true);
714                  p.Add(x =&gt; x.Elevation, 10);
715              });
716              var popoverElement = comp.Find(&quot;.test-popover-content&quot;).ParentElement;
717              popoverElement.ClassList.Should().Contain(new[] { &quot;mud-popover-open&quot;, &quot;mud-paper&quot;, &quot;mud-elevation-10&quot;, &quot;my-custom-class&quot; });
718          }
719          [Test]
720          [TestCase(Origin.BottomCenter, &quot;bottom-center&quot;)]
721          [TestCase(Origin.BottomLeft, &quot;bottom-left&quot;)]
722          [TestCase(Origin.BottomRight, &quot;bottom-right&quot;)]
723          [TestCase(Origin.CenterCenter, &quot;center-center&quot;)]
724          [TestCase(Origin.CenterLeft, &quot;center-left&quot;)]
725          [TestCase(Origin.CenterRight, &quot;center-right&quot;)]
726          [TestCase(Origin.TopCenter, &quot;top-center&quot;)]
727          [TestCase(Origin.TopLeft, &quot;top-left&quot;)]
728          [TestCase(Origin.TopRight, &quot;top-right&quot;)]
729          public void MudPopover_Property_TransformOrigin(Origin transformOrigin, string expectedClass)
730          {
731              var comp = Context.RenderComponent&lt;PopoverPropertyTest&gt;(p =&gt; p.Add(
732                  x =&gt; x.TransformOrigin, transformOrigin));
733              var popoverElement = comp.Find(&quot;.test-popover-content&quot;).ParentElement;
734              popoverElement.ClassList.Should().Contain(new[] { &quot;mud-popover-open&quot;, $&quot;mud-popover-{expectedClass}&quot;, &quot;my-custom-class&quot; });
735          }
736          [Test]
737          [TestCase(Origin.BottomCenter, &quot;bottom-center&quot;)]
738          [TestCase(Origin.BottomLeft, &quot;bottom-left&quot;)]
739          [TestCase(Origin.BottomRight, &quot;bottom-right&quot;)]
740          [TestCase(Origin.CenterCenter, &quot;center-center&quot;)]
741          [TestCase(Origin.CenterLeft, &quot;center-left&quot;)]
742          [TestCase(Origin.CenterRight, &quot;center-right&quot;)]
743          [TestCase(Origin.TopCenter, &quot;top-center&quot;)]
744          [TestCase(Origin.TopLeft, &quot;top-left&quot;)]
745          [TestCase(Origin.TopRight, &quot;top-right&quot;)]
746          public void MudPopover_Property_AnchorOrigin(Origin anchorOrigin, string expectedClass)
747          {
748              var comp = Context.RenderComponent&lt;PopoverPropertyTest&gt;(p =&gt; p.Add(
749                  x =&gt; x.AnchorOrigin, anchorOrigin));
750              var popoverElement = comp.Find(&quot;.test-popover-content&quot;).ParentElement;
751              popoverElement.ClassList.Should().Contain(new[] { &quot;mud-popover-open&quot;, $&quot;mud-popover-anchor-{expectedClass}&quot;, &quot;my-custom-class&quot; });
752          }
753          [Test]
754          [TestCase(OverflowBehavior.FlipNever, &quot;flip-never&quot;)]
755          [TestCase(OverflowBehavior.FlipOnOpen, &quot;flip-onopen&quot;)]
756          [TestCase(OverflowBehavior.FlipAlways, &quot;flip-always&quot;)]
757          public void MudPopover_Property_OverflowBehavior(OverflowBehavior overflowBehavior, string expectedClass)
758          {
759              var comp = Context.RenderComponent&lt;PopoverPropertyTest&gt;(p =&gt; p.Add(
760                  x =&gt; x.OverflowBehavior, overflowBehavior));
761              var popoverElement = comp.Find(&quot;.test-popover-content&quot;).ParentElement;
762              popoverElement.ClassList.Should().Contain(new[] { &quot;mud-popover-open&quot;, $&quot;mud-popover-overflow-{expectedClass}&quot;, &quot;my-custom-class&quot; });
763          }
764          [Test]
765          public async Task MudPopover_WithDynamicContent()
766          {
767              var comp = Context.RenderComponent&lt;PopoverComplexContent&gt;();
768              var dynamicContentElement = comp.Find(&quot;.dynamic-content&quot;);
769              dynamicContentElement.ChildNodes.Should().BeEmpty();
770              await comp.Instance.AddRow();
771              dynamicContentElement.ChildNodes.Should().ContainSingle();
772              dynamicContentElement.ChildNodes[0].TextContent.Should().Be(&quot;Popover content 0&quot;);
773              await comp.Instance.AddRow();
774              dynamicContentElement.ChildNodes.Should().HaveCount(2);
775              dynamicContentElement.ChildNodes[0].TextContent.Should().Be(&quot;Popover content 0&quot;);
776              dynamicContentElement.ChildNodes[1].TextContent.Should().Be(&quot;Popover content 1&quot;);
777              await comp.Instance.AddRow();
778              dynamicContentElement.ChildNodes.Should().HaveCount(3);
779              dynamicContentElement.ChildNodes[0].TextContent.Should().Be(&quot;Popover content 0&quot;);
780              dynamicContentElement.ChildNodes[1].TextContent.Should().Be(&quot;Popover content 1&quot;);
781              dynamicContentElement.ChildNodes[2].TextContent.Should().Be(&quot;Popover content 2&quot;);
782          }
783          [Test]
784          public void MudPopoverProvider_DefaultValue()
785          {
786              var provider = new MudPopoverProvider();
787              provider.IsEnabled.Should().BeTrue();
788          }
789          [Test]
790          public void MudPopoverProvider_RenderElementsBasedOnEnableState()
791          {
792              var comp = Context.RenderComponent&lt;PopoverProviderTest&gt;(p =&gt; p.Add(x =&gt; x.ProviderIsEnabled, true));
793              comp.Find(&quot;#my-content&quot;).TextContent.Should().Be(&quot;Popover content&quot;);
794              for (int i = 0; i &lt; 3; i++)
795              {
796                  comp.SetParametersAndRender(p =&gt; p.Add(x =&gt; x.ProviderIsEnabled, false));
797                  Assert.Throws&lt;ElementNotFoundException&gt;(() =&gt; comp.Find(&quot;#my-content&quot;));
798                  comp.SetParametersAndRender(p =&gt; p.Add(x =&gt; x.ProviderIsEnabled, true));
799                  comp.Find(&quot;#my-content&quot;).TextContent.Should().Be(&quot;Popover content&quot;);
800              }
801          }
802          [Test]
803          public void MudPopoverProvider_NoRenderWhenIsEnabledIsFalse()
804          {
805              var comp = Context.RenderComponent&lt;PopoverProviderTest&gt;(p =&gt; p.Add(x =&gt; x.ProviderIsEnabled, false));
806              Assert.Throws&lt;ElementNotFoundException&gt;(() =&gt; comp.Find(&quot;#my-content&quot;));
807          }
808          [TestCase(false)]
809          [TestCase(true)]
810          public async Task MudPopoverProvider_ThrowOnDuplicate(bool ThrowOnDuplicateProvider)
811          {
812              var options = new PopoverOptions
813              {
814                  ThrowOnDuplicateProvider = ThrowOnDuplicateProvider
815              };
816              Context.Services.Configure&lt;PopoverOptions&gt;(x =&gt; x.ThrowOnDuplicateProvider = ThrowOnDuplicateProvider);
817              Context.JSInterop.Setup&lt;int&gt;(&quot;mudpopoverHelper.countProviders&quot;).SetResult(ThrowOnDuplicateProvider == true ? 2 : 1);
818              if (ThrowOnDuplicateProvider == true)
819              {
820                  var ex = Assert.Throws&lt;InvalidOperationException&gt;(() =&gt; Context.RenderComponent&lt;PopoverDuplicationTest&gt;());
821                  ex.Message.Should().StartWith(&quot;Duplicate MudPopoverProvider detected&quot;);
822              }
823              else
824              {
825                  var comp = Context.RenderComponent&lt;PopoverDuplicationTest&gt;();
826                  await comp.Instance.Open();
827                  await comp.Instance.Close();
828              }
829          }
830      }
831  }
</code></pre>
        </div>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-AutoPrepareTests.cs</h3>
            <pre><code>1  using NpgsqlTypes;
2  using NUnit.Framework;
3  using System;
4  using System.Data;
5  using System.Linq;
6  using System.Threading.Tasks;
7  using static Npgsql.Tests.TestUtil;
8  namespace Npgsql.Tests;
9  public class AutoPrepareTests : TestBase
10  {
11      [Test]
12      public void Basic()
13      {
14          using var dataSource = CreateDataSource(csb =&gt;
15          {
16              csb.MaxAutoPrepare = 10;
17              csb.AutoPrepareMinUsages = 2;
18          });
19          using var conn = dataSource.OpenConnection();
20          using var checkCmd = new NpgsqlCommand(CountPreparedStatements, conn);
21          checkCmd.Prepare();
22          conn.ExecuteNonQuery(&quot;SELECT 1&quot;);
23          Assert.That(checkCmd.ExecuteScalar(), Is.EqualTo(0));
24          using (var cmd = new NpgsqlCommand(&quot;SELECT 1&quot;, conn))
25          {
26              Assert.That(cmd.IsPrepared, Is.False);
27              cmd.ExecuteScalar();
28              Assert.That(cmd.IsPrepared, Is.True);
29              Assert.That(checkCmd.ExecuteScalar(), Is.EqualTo(1));
30              cmd.ExecuteScalar();
31              Assert.That(cmd.IsPrepared, Is.True);
32              Assert.That(checkCmd.ExecuteScalar(), Is.EqualTo(1));
33          }
34          using (var cmd = new NpgsqlCommand(&quot;SELECT 1&quot;, conn))
35          {
36              cmd.ExecuteScalar();
37              Assert.That(cmd.IsPrepared, Is.True);
38          }
39          Assert.That(checkCmd.ExecuteScalar(), Is.EqualTo(1));
40      }
41      [Test, Description(&quot;Passes the maximum limit for autoprepared statements, recycling the least-recently used one&quot;)]
42      public void Recycle()
43      {
44          using var dataSource = CreateDataSource(csb =&gt;
45          {
46              csb.AutoPrepareMinUsages = 2;
47              csb.MaxAutoPrepare = 2;
48          });
49          using var conn = dataSource.OpenConnection();
50          using var checkCmd = new NpgsqlCommand(CountPreparedStatements, conn);
51          checkCmd.Prepare();
52          Assert.That(checkCmd.ExecuteScalar(), Is.EqualTo(0));
53          var cmd1 = new NpgsqlCommand(&quot;SELECT 1&quot;, conn);
54          cmd1.ExecuteNonQuery(); cmd1.ExecuteNonQuery();
55          Assert.That(cmd1.IsPrepared, Is.True);
56          Assert.That(checkCmd.ExecuteScalar(), Is.EqualTo(1));
57          var cmd2 = new NpgsqlCommand(&quot;SELECT 2&quot;, conn);
58          cmd2.ExecuteNonQuery(); cmd2.ExecuteNonQuery();
59          Assert.That(cmd2.IsPrepared, Is.True);
60          Assert.That(checkCmd.ExecuteScalar(), Is.EqualTo(2));
61          cmd1.ExecuteNonQuery();
62          conn.ExecuteNonQuery(&quot;SELECT 3&quot;); conn.ExecuteNonQuery(&quot;SELECT 3&quot;);
63          Assert.That(checkCmd.ExecuteScalar(), Is.EqualTo(2));
64          cmd2.ExecuteNonQuery();
65          Assert.That(cmd2.IsPrepared, Is.False);
66          using (var getTextCmd = new NpgsqlCommand(&quot;SELECT statement FROM pg_prepared_statements WHERE statement NOT LIKE &#x27;%COUNT%&#x27; ORDER BY statement&quot;, conn))
67          using (var reader = getTextCmd.ExecuteReader())
68          {
69              Assert.That(reader.Read(), Is.True);
70              Assert.That(reader.GetString(0), Is.EqualTo(&quot;SELECT 1&quot;));
71              Assert.That(reader.Read(), Is.True);
72              Assert.That(reader.GetString(0), Is.EqualTo(&quot;SELECT 3&quot;));
73          }
74      }
75      [Test]
76      public void Persist()
77      {
78          using var dataSource = CreateDataSource(csb =&gt;
79          {
80              csb.MaxAutoPrepare = 10;
81              csb.AutoPrepareMinUsages = 2;
82          });
83          using (var conn = dataSource.OpenConnection())
84          using (var checkCmd = new NpgsqlCommand(CountPreparedStatements, conn))
85          {
86              checkCmd.Prepare();
87              conn.ExecuteNonQuery(&quot;SELECT 1&quot;); conn.ExecuteNonQuery(&quot;SELECT 1&quot;);
88              Assert.That(checkCmd.ExecuteScalar(), Is.EqualTo(1));
89          }
90          using (var conn = dataSource.OpenConnection())
91          using (var checkCmd = new NpgsqlCommand(CountPreparedStatements, conn))
92          {
93              checkCmd.Prepare();
94              Assert.That(checkCmd.ExecuteScalar(), Is.EqualTo(1));
95              using (var cmd = new NpgsqlCommand(&quot;SELECT 1&quot;, conn))
96              {
97                  cmd.ExecuteScalar();
98              }
99              Assert.That(checkCmd.ExecuteScalar(), Is.EqualTo(1));
100          }
101      }
102      [Test]
103      public async Task Positional_parameter()
104      {
105          await using var dataSource = CreateDataSource(csb =&gt;
106          {
107              csb.AutoPrepareMinUsages = 2;
108              csb.MaxAutoPrepare = 2;
109          });
110          await using var conn = await dataSource.OpenConnectionAsync();
111          await using var checkCmd = new NpgsqlCommand(CountPreparedStatements, conn);
112          await checkCmd.PrepareAsync();
113          await using var cmd = new NpgsqlCommand(&quot;SELECT $1&quot;, conn);
114          cmd.Parameters.Add(new NpgsqlParameter { NpgsqlDbType = NpgsqlDbType.Integer, Value = 8 });
115          Assert.That(cmd.IsPrepared, Is.False);
116          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(8));
117          Assert.That(cmd.IsPrepared, Is.False);
118          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(8));
119          Assert.That(cmd.IsPrepared, Is.True);
120          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(8));
121          Assert.That(cmd.IsPrepared, Is.True);
122      }
123      [Test]
124      public void Promote_auto_to_explicit()
125      {
126          using var dataSource = CreateDataSource(csb =&gt;
127          {
128              csb.MaxAutoPrepare = 10;
129              csb.AutoPrepareMinUsages = 2;
130          });
131          using var conn = dataSource.OpenConnection();
132          using var checkCmd = new NpgsqlCommand(CountPreparedStatements, conn);
133          using var cmd1 = new NpgsqlCommand(&quot;SELECT 1&quot;, conn);
134          using var cmd2 = new NpgsqlCommand(&quot;SELECT 1&quot;, conn);
135          checkCmd.Prepare();
136          cmd1.ExecuteNonQuery(); cmd1.ExecuteNonQuery();
137          Assert.That(checkCmd.ExecuteScalar(), Is.EqualTo(1));
138          Assert.That(conn.Connector!.PreparedStatementManager.NumPrepared, Is.EqualTo(2));
139          cmd2.Prepare();
140          Assert.That(checkCmd.ExecuteScalar(), Is.EqualTo(1));
141          Assert.That(conn.Connector.PreparedStatementManager.NumPrepared, Is.EqualTo(2));
142          cmd2.ExecuteScalar();
143      }
144      [Test]
145      public void Candidate_eject()
146      {
147          using var dataSource = CreateDataSource(csb =&gt;
148          {
149              csb.MaxAutoPrepare = 10;
150              csb.AutoPrepareMinUsages = 3;
151          });
152          using var conn = dataSource.OpenConnection();
153          using var cmd = conn.CreateCommand();
154          for (var i = 0; i &lt; PreparedStatementManager.CandidateCount; i++)
155          {
156              cmd.CommandText = $&quot;SELECT {i}&quot;;
157              cmd.ExecuteNonQuery();
158          }
159          cmd.CommandText = &quot;SELECT &#x27;double_use&#x27;&quot;;
160          cmd.ExecuteNonQuery(); cmd.ExecuteNonQuery();
161          for (var i = PreparedStatementManager.CandidateCount; i &lt; PreparedStatementManager.CandidateCount * 2; i++)
162          {
163              cmd.CommandText = $&quot;SELECT {i}&quot;;
164              cmd.ExecuteNonQuery();
165          }
166          cmd.CommandText = &quot;SELECT 1&quot;;
167          cmd.ExecuteNonQuery(); cmd.ExecuteNonQuery();
168          Assert.That(cmd.IsPrepared, Is.False);
169          cmd.CommandText = &quot;SELECT &#x27;double_use&#x27;&quot;;
170          cmd.ExecuteNonQuery();
171          Assert.That(cmd.IsPrepared, Is.True);
172      }
173      [Test]
174      public void One_command_same_sql_twice()
175      {
176          using var dataSource = CreateDataSource(csb =&gt;
177          {
178              csb.MaxAutoPrepare = 10;
179              csb.AutoPrepareMinUsages = 2;
180          });
181          using var conn = dataSource.OpenConnection();
182          using var cmd = new NpgsqlCommand(&quot;SELECT 1; SELECT 1; SELECT 1; SELECT 1&quot;, conn);
183          cmd.ExecuteNonQuery();
184          Assert.That(conn.ExecuteScalar(CountPreparedStatements), Is.EqualTo(1));
185      }
186      [Test]
187      public void Across_close_open_different_connector()
188      {
189          using var dataSource = CreateDataSource(csb =&gt;
190          {
191              csb.MaxAutoPrepare = 10;
192              csb.AutoPrepareMinUsages = 2;
193          });
194          using var conn1 = dataSource.CreateConnection();
195          using var conn2 = dataSource.CreateConnection();
196          using var cmd = new NpgsqlCommand(&quot;SELECT 1&quot;, conn1);
197          conn1.Open();
198          cmd.ExecuteNonQuery(); cmd.ExecuteNonQuery();
199          Assert.That(cmd.IsPrepared, Is.True);
200          var processId = conn1.ProcessID;
201          conn1.Close();
202          conn2.Open();
203          conn1.Open();
204          Assert.That(conn1.ProcessID, Is.Not.EqualTo(processId));
205          Assert.That(cmd.IsPrepared, Is.False);
206          Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));  
207          cmd.Prepare();
208          Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
209      }
210      [Test]
211      public void Unprepare_all()
212      {
213          using var dataSource = CreateDataSource(csb =&gt;
214          {
215              csb.MaxAutoPrepare = 10;
216              csb.AutoPrepareMinUsages = 2;
217          });
218          using var conn = dataSource.OpenConnection();
219          using var cmd = new NpgsqlCommand(&quot;SELECT 1&quot;, conn);
220          cmd.Prepare();  
221          conn.ExecuteNonQuery(&quot;SELECT 2&quot;); conn.ExecuteNonQuery(&quot;SELECT 2&quot;);  
222          Assert.That(conn.ExecuteScalar(CountPreparedStatements), Is.EqualTo(2));
223          conn.UnprepareAll();
224          Assert.That(conn.ExecuteScalar(CountPreparedStatements), Is.Zero);
225      }
226      [Test, Description(&quot;Prepares the same SQL with different parameters (overloading)&quot;)]
227      public void Overloaded_sql()
228      {
229          using var dataSource = CreateDataSource(csb =&gt;
230          {
231              csb.MaxAutoPrepare = 10;
232              csb.AutoPrepareMinUsages = 2;
233          });
234          using var conn = dataSource.OpenConnection();
235          using (var cmd = new NpgsqlCommand(&quot;SELECT @p&quot;, conn))
236          {
237              cmd.Parameters.AddWithValue(&quot;p&quot;, NpgsqlDbType.Integer, 8);
238              cmd.ExecuteNonQuery();
239              cmd.ExecuteNonQuery();
240              Assert.That(cmd.IsPrepared, Is.True);
241          }
242          using (var cmd = new NpgsqlCommand(&quot;SELECT @p&quot;, conn))
243          {
244              cmd.Parameters.AddWithValue(&quot;p&quot;, NpgsqlDbType.Text, &quot;foo&quot;);
245              Assert.That(cmd.ExecuteScalar(), Is.EqualTo(&quot;foo&quot;));
246              Assert.That(cmd.ExecuteScalar(), Is.EqualTo(&quot;foo&quot;));
247              Assert.That(cmd.IsPrepared, Is.False);
248          }
249          Assert.That(conn.ExecuteScalar(CountPreparedStatements), Is.EqualTo(1));
250      }
251      [Test, Description(&quot;Tests parameter derivation a parameterized query (CommandType.Text) that is already auto-prepared.&quot;)]
252      public void Derive_parameters_for_auto_prepared_statement()
253      {
254          const string query = &quot;SELECT @p::integer&quot;;
255          const int answer = 42;
256          using var dataSource = CreateDataSource(csb =&gt;
257          {
258              csb.MaxAutoPrepare = 10;
259              csb.AutoPrepareMinUsages = 2;
260          });
261          using var conn = dataSource.OpenConnection();
262          using var checkCmd = new NpgsqlCommand(CountPreparedStatements, conn);
263          using var cmd = new NpgsqlCommand(query, conn);
264          checkCmd.Prepare();
265          cmd.Parameters.AddWithValue(&quot;@p&quot;, NpgsqlDbType.Integer, answer);
266          cmd.ExecuteNonQuery(); cmd.ExecuteNonQuery(); 
267          Assert.That(checkCmd.ExecuteScalar(), Is.EqualTo(1));
268          Assert.That(conn.Connector!.PreparedStatementManager.NumPrepared, Is.EqualTo(2));
269          NpgsqlCommandBuilder.DeriveParameters(cmd);
270          Assert.That(cmd.Parameters.Count, Is.EqualTo(1));
271          Assert.That(cmd.Parameters[0].ParameterName, Is.EqualTo(&quot;p&quot;));
272          Assert.That(checkCmd.ExecuteScalar(), Is.EqualTo(0));
273          Assert.That(conn.Connector.PreparedStatementManager.NumPrepared, Is.EqualTo(1));
274          cmd.Parameters[&quot;@p&quot;].Value = answer;
275          Assert.That(cmd.ExecuteScalar(), Is.EqualTo(answer));
276      }
277      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2644&quot;)]
278      public void Row_description_properly_cloned()
279      {
280          using var dataSource = CreateDataSource(csb =&gt;
281          {
282              csb.MaxAutoPrepare = 10;
283              csb.AutoPrepareMinUsages = 2;
284          });
285          using var conn = dataSource.OpenConnection();
286          conn.UnprepareAll();
287          using var cmd1 = new NpgsqlCommand(&quot;SELECT 1 AS foo&quot;, conn);
288          using var cmd2 = new NpgsqlCommand(&quot;SELECT 1 AS bar&quot;, conn);
289          cmd1.ExecuteNonQuery();
290          cmd1.ExecuteNonQuery();  
291          cmd2.ExecuteNonQuery();
292          using var reader = cmd1.ExecuteReader();
293          Assert.That(reader.GetName(0), Is.EqualTo(&quot;foo&quot;));
294      }
295      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/3106&quot;)]
296      public async Task Dont_auto_prepare_more_than_max_statements_in_batch()
297      {
298          const int maxAutoPrepare = 50;
299          await using var dataSource = CreateDataSource(csb =&gt; csb.MaxAutoPrepare = maxAutoPrepare);
300          await using var connection = await dataSource.OpenConnectionAsync();
301          for (var i = 0; i &lt; 100; i++)
302          {
303              await using var command = connection.CreateCommand();
304              command.CommandText = string.Join(&quot;&quot;, Enumerable.Range(0, 100).Select(n =&gt; $&quot;SELECT {n};&quot;));
305              await command.ExecuteNonQueryAsync();
306          }
307          Assert.That(await connection.ExecuteScalarAsync(CountPreparedStatements), Is.LessThanOrEqualTo(maxAutoPrepare));
308      }
309      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/3106&quot;)]
310      public async Task Dont_auto_prepare_more_than_max_statements_in_batch_random()
311      {
312          const int maxAutoPrepare = 10;
313          await using var dataSource = CreateDataSource(csb =&gt; csb.MaxAutoPrepare = maxAutoPrepare);
314          await using var connection = await dataSource.OpenConnectionAsync();
315          var random = new Random(1);
316          for (var i = 0; i &lt; 100; i++)
317          {
318              await using var command = connection.CreateCommand();
319              command.CommandText = string.Join(&quot;&quot;, Enumerable.Range(0, 100).Select(n =&gt; $&quot;SELECT {random.Next(200)};&quot;));
320              await command.ExecuteNonQueryAsync();
321          }
322          Assert.That(await connection.ExecuteScalarAsync(CountPreparedStatements), Is.LessThanOrEqualTo(maxAutoPrepare));
323      }
324      [Test]
325      public async Task Replace_and_execute_within_same_batch()
326      {
327          await using var dataSource = CreateDataSource(csb =&gt;
328          {
329              csb.MaxAutoPrepare = 1;
330              csb.AutoPrepareMinUsages = 2;
331          });
332          await using var connection = await dataSource.OpenConnectionAsync();
333          for (var i = 0; i &lt; 2; i++)
334              await connection.ExecuteNonQueryAsync(&quot;SELECT 1&quot;);
335          await connection.ExecuteNonQueryAsync(&quot;SELECT 2; SELECT 2; SELECT 1&quot;);
336      }
337      const string CountPreparedStatements = &quot;&quot;&quot;
338  SELECT COUNT(*) FROM pg_prepared_statements
339  WHERE statement NOT LIKE &#x27;%pg_prepared_statements%&#x27;
340  AND statement NOT LIKE &#x27;%pg_type%&#x27;
341  &quot;&quot;&quot;;
342      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2665&quot;)]
343      public async Task Auto_prepared_command_failure()
344      {
345          await using var dataSource = CreateDataSource(csb =&gt;
346          {
347              csb.MaxAutoPrepare = 10;
348              csb.AutoPrepareMinUsages = 2;
349          });
350          await using var conn = await dataSource.OpenConnectionAsync();
351          var tableName = await GetTempTableName(conn);
352          await conn.ExecuteNonQueryAsync($&quot;CREATE TABLE {tableName} (id integer)&quot;);
353          await using (var command = new NpgsqlCommand($&quot;INSERT INTO {tableName} (id) VALUES (1)&quot;, conn))
354          {
355              await command.ExecuteNonQueryAsync();
356              await conn.ExecuteNonQueryAsync($&quot;DROP TABLE {tableName}&quot;);
<span onclick='openModal()' class='match'>357              Assert.ThrowsAsync&lt;PostgresException&gt;(async () =&gt; await command.ExecuteNonQueryAsync());
358          }
</span>359          await conn.ExecuteNonQueryAsync($&quot;CREATE TABLE {tableName} (id integer)&quot;);
360          await using (var command = new NpgsqlCommand($&quot;INSERT INTO {tableName} (id) VALUES (1)&quot;, conn))
361          {
362              await command.ExecuteNonQueryAsync();
363              await command.ExecuteNonQueryAsync();
364          }
365      }
366      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/3002&quot;)]
367      public void Replace_with_bad_sql()
368      {
369          using var dataSource = CreateDataSource(csb =&gt;
370          {
371              csb.MaxAutoPrepare = 2;
372              csb.AutoPrepareMinUsages = 1;
373          });
374          using var conn = dataSource.OpenConnection();
375          conn.ExecuteNonQuery(&quot;SELECT 1&quot;);
376          conn.ExecuteNonQuery(&quot;SELECT 2&quot;);
377          Assert.That(() =&gt; conn.ExecuteNonQuery(&quot;SELECTBAD&quot;), Throws.Exception.TypeOf&lt;PostgresException&gt;()
378              .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.SyntaxError));
379          conn.ExecuteNonQuery(&quot;SELECT 2&quot;);
380          Assert.That(() =&gt; conn.ExecuteNonQuery(&quot;SELECTBAD&quot;), Throws.Exception.TypeOf&lt;PostgresException&gt;()
381              .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.SyntaxError));
382          conn.Close();
383          conn.Open();
384          Assert.That(conn.ExecuteScalar(&quot;SELECT 2&quot;), Is.EqualTo(2));
385      }
386      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/4082&quot;)]
387      public async Task Batch_statement_execution_error_cleanup()
388      {
389          await using var dataSource = CreateDataSource(csb =&gt;
390          {
391              csb.MaxAutoPrepare = 2;
392              csb.AutoPrepareMinUsages = 1;
393          });
394          await using var conn = await dataSource.OpenConnectionAsync();
395          var funcName = await GetTempFunctionName(conn);
396          await conn.ExecuteNonQueryAsync(
397  $&quot;&quot;&quot;
398  CREATE OR REPLACE FUNCTION {funcName}() RETURNS VOID AS
399      &#x27;BEGIN RAISE EXCEPTION &#x27;&#x27;testexception&#x27;&#x27; USING ERRCODE = &#x27;&#x27;12345&#x27;&#x27;, DETAIL = &#x27;&#x27;testdetail&#x27;&#x27;; END;&#x27;
400  LANGUAGE &#x27;plpgsql&#x27;;
401  &quot;&quot;&quot;);
402          conn.UnprepareAll();
403          await conn.ExecuteNonQueryAsync(&quot;SELECT 1&quot;);
404          await conn.ExecuteNonQueryAsync(&quot;SELECT 2&quot;);
405          var ex = Assert.ThrowsAsync&lt;PostgresException&gt;(async () =&gt; await conn.ExecuteNonQueryAsync($&quot;SELECT {funcName}(); SELECT 4&quot;))!;
406          Assert.That(ex, Is.TypeOf&lt;PostgresException&gt;().With.Property(nameof(PostgresException.SqlState)).EqualTo(&quot;12345&quot;));
407          Assert.That(await conn.ExecuteScalarAsync(&quot;SELECT 3&quot;), Is.EqualTo(3));
408      }
409      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/4404&quot;)]
410      public async Task SchemaOnly()
411      {
412          await using var dataSource = CreateDataSource(csb =&gt;
413          {
414              csb.AutoPrepareMinUsages = 2;
415              csb.MaxAutoPrepare = 10;
416          });
417          await using var conn = await dataSource.OpenConnectionAsync();
418          await using var cmd = new NpgsqlCommand(&quot;SELECT 1&quot;, conn);
419          for (var i = 0; i &lt; 5; i++)
420          {
421              await using var reader = await cmd.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
422          }
423      }
424      [Test]
425      public async Task Auto_prepared_statement_invalidation()
426      {
427          await using var dataSource = CreateDataSource(csb =&gt;
428          {
429              csb.MaxAutoPrepare = 10;
430              csb.AutoPrepareMinUsages = 2;
431          });
432          await using var connection = await dataSource.OpenConnectionAsync();
433          var table = await CreateTempTable(connection, &quot;foo int&quot;);
434          await using var command = new NpgsqlCommand($&quot;SELECT * FROM {table}&quot;, connection);
435          for (var i = 0; i &lt; 2; i++)
436              await command.ExecuteNonQueryAsync();
437          await connection.ExecuteNonQueryAsync($&quot;ALTER TABLE {table} RENAME COLUMN foo TO bar&quot;);
438          var exception = Assert.ThrowsAsync&lt;PostgresException&gt;(() =&gt; command.ExecuteNonQueryAsync())!;
439          Assert.That(exception.SqlState, Is.EqualTo(PostgresErrorCodes.FeatureNotSupported)); 
440          Assert.DoesNotThrowAsync(() =&gt; command.ExecuteNonQueryAsync());
441      }
442      void DumpPreparedStatements(NpgsqlConnection conn)
443      {
444          using var cmd = new NpgsqlCommand(&quot;SELECT name,statement FROM pg_prepared_statements&quot;, conn);
445          using var reader = cmd.ExecuteReader();
446          while (reader.Read())
447              Console.WriteLine($&quot;{reader.GetString(0)}: {reader.GetString(1)}&quot;);
448      }
449  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from MudBlazor-MDEwOlJlcG9zaXRvcnkyODg0Mjg2NzY=-flat-PopoverTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-AutoPrepareTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>324              Assert.ThrowsAsync&lt;InvalidOperationException&gt;(async () =&gt; await handler.Detach());
325              handler.IsConnected.Should().BeFalse();
</pre></code></div>
                <div class="column column_space"><pre><code>357              Assert.ThrowsAsync&lt;PostgresException&gt;(async () =&gt; await command.ExecuteNonQueryAsync());
358          }
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    