
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 16, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-JsonWebToken.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Net;
4  using System.Net.Http;
5  using System.Net.Http.Headers;
6  using System.Reflection;
7  using System.Runtime.Serialization;
8  using System.Security.Claims;
9  using System.Text;
10  using GitHub.Services.Common;
11  using Newtonsoft.Json;
12  using Newtonsoft.Json.Linq;
13  namespace GitHub.Services.WebApi.Jwt
14  {
15      [DataContract]
16      public enum JWTAlgorithm
17      {
18          [EnumMember]
19          None,
20          [EnumMember]
21          HS256,
22          [EnumMember]
23          RS256
24      }
25      [DataContract]
26      [JsonConverter(typeof(JsonWebTokenConverter))]
27      public sealed class JsonWebToken : IssuedToken
28      {
29          private const int DefaultLifetime = 300;
30          #region Factory Methods
31          public static JsonWebToken Create(string issuer, string audience, DateTime validFrom, DateTime validTo, VssSigningCredentials credentials)
32          {
33              return Create(issuer, audience, validFrom, validTo, default(DateTime), null, null, null, credentials, allowExpiredCertificate: false);
34          }
35          public static JsonWebToken Create(string issuer, string audience, DateTime validFrom, DateTime validTo, IEnumerable&lt;Claim&gt; additionalClaims, JsonWebToken actor)
36          {
37              ArgumentUtility.CheckForNull(additionalClaims, nameof(additionalClaims));
38              ArgumentUtility.CheckForNull(actor, nameof(actor));
39              return Create(issuer, audience, validFrom, validTo, default(DateTime), additionalClaims, actor, null, null, allowExpiredCertificate: false);
40          }
41          public static JsonWebToken Create(string issuer, string audience, DateTime validFrom, DateTime validTo, IEnumerable&lt;Claim&gt; additionalClaims, string actorToken)
42          {
43              ArgumentUtility.CheckForNull(additionalClaims, nameof(additionalClaims));
44              ArgumentUtility.CheckStringForNullOrEmpty(actorToken, nameof(actorToken));
45              return Create(issuer, audience, validFrom, validTo, default(DateTime), additionalClaims, null, actorToken, null, allowExpiredCertificate: false);
46          }
47          public static JsonWebToken Create(string issuer, string audience, DateTime validFrom, DateTime validTo, IEnumerable&lt;Claim&gt; additionalClaims, VssSigningCredentials credentials)
48          {
49              ArgumentUtility.CheckForNull(additionalClaims, nameof(additionalClaims));
50              return Create(issuer, audience, validFrom, validTo, default(DateTime), additionalClaims, null, null, credentials, allowExpiredCertificate: false);
51          }
52          public static JsonWebToken Create(string issuer, string audience, DateTime validFrom, DateTime validTo, IEnumerable&lt;Claim&gt; additionalClaims, VssSigningCredentials credentials, bool allowExpiredCertificate)
53          {
54              ArgumentUtility.CheckForNull(additionalClaims, nameof(additionalClaims));
55              return Create(issuer, audience, validFrom, validTo, default(DateTime), additionalClaims, null, null, credentials, allowExpiredCertificate);
56          }
57          public static JsonWebToken Create(string issuer, string audience, DateTime validFrom, DateTime validTo, DateTime issuedAt, IEnumerable&lt;Claim&gt; additionalClaims, VssSigningCredentials credentials)
58          {
59              ArgumentUtility.CheckForNull(additionalClaims, nameof(additionalClaims));
60              return Create(issuer, audience, validFrom, validTo, issuedAt, additionalClaims, null, null, credentials, allowExpiredCertificate: false);
61          }
62          private static JsonWebToken Create(string issuer, string audience, DateTime validFrom, DateTime validTo, DateTime issuedAt, IEnumerable&lt;Claim&gt; additionalClaims, JsonWebToken actor, string actorToken, VssSigningCredentials credentials, bool allowExpiredCertificate)
63          {
64              ArgumentUtility.CheckStringForNullOrEmpty(issuer, nameof(issuer));
65              ArgumentUtility.CheckStringForNullOrEmpty(audience, nameof(audience)); 
66              validFrom = validFrom == default(DateTime) ? DateTime.UtcNow : validFrom.ToUniversalTime();
67              validTo = validTo == default(DateTime) ? DateTime.UtcNow + TimeSpan.FromSeconds(DefaultLifetime) : validTo.ToUniversalTime();
68              issuedAt = issuedAt == default(DateTime) ? default(DateTime) : issuedAt.ToUniversalTime();
69              JWTHeader header = GetHeader(credentials, allowExpiredCertificate);
70              JWTPayload payload = new JWTPayload(additionalClaims) { Issuer = issuer, Audience = audience, ValidFrom = validFrom, ValidTo = validTo, IssuedAt = issuedAt };
71              if (actor != null)
72              {
73                  payload.Actor = actor;
74              }
75              else if (actorToken != null)
76              {
77                  payload.ActorToken = actorToken;
78              }
79              byte[] signature = GetSignature(header, payload, header.Algorithm, credentials);
80              return new JsonWebToken(header, payload, signature);
81          }
82          public static JsonWebToken Create(string jwtEncodedString)
83          {
84              ArgumentUtility.CheckStringForNullOrEmpty(jwtEncodedString, nameof(jwtEncodedString));
85              JValue value = new JValue(jwtEncodedString);
86              return value.ToObject&lt;JsonWebToken&gt;();
87          }
88          #endregion
89          #region .ctors
90          private JsonWebToken() { }
91          private JsonWebToken(JWTHeader header, JWTPayload payload, byte[] signature)
92          {
93              ArgumentUtility.CheckForNull(header, nameof(header));
94              ArgumentUtility.CheckForNull(payload, nameof(payload));
95              _header = header;
96              _payload = payload;
97              _signature = signature;
98          }
99          #endregion
100          #region Base Class Overrides
101          protected internal override VssCredentialsType CredentialType
102          {
103              get
104              {
105                  return VssCredentialsType.S2S;
106              }
107          }
108          internal override void ApplyTo(IHttpRequest request)
109          {
110              request.Headers.SetValue(Common.Internal.HttpHeaders.Authorization, $&quot;Bearer {this.EncodedToken}&quot;);
111          }
112          #endregion
113          #region Private Fields
114          JWTHeader _header;
115          JWTPayload _payload;
116          byte[] _signature;
117          string _encodedToken;
118          #endregion
119          #region Public Properties
120          public string TokenType =&gt; _header.Type;
121          public JWTAlgorithm Algorithm =&gt; _header.Algorithm;
122          public string CertificateThumbprint =&gt; _header.CertificateThumbprint;
123          public string Audience =&gt; _payload.Audience;
124          public string Issuer =&gt; _payload.Issuer;
125          public string Subject =&gt; _payload.Subject;
126          public string NameIdentifier =&gt; _payload.NameIdentifier;
127          public string IdentityProvider =&gt; _payload.IdentityProvider;
128          public DateTime ValidTo =&gt; _payload.ValidTo;
129          public DateTime ValidFrom =&gt; _payload.ValidFrom;
130          public DateTime IssuedAt =&gt; _payload.IssuedAt;
131          public bool TrustedForDelegation =&gt; _payload.TrustedForDelegation;
132          public JsonWebToken Actor =&gt; _payload.Actor;
133          public string ApplicationIdentifier =&gt; _payload.ApplicationIdentifier;
134          public string EncodedToken
135          {
136              get
137              {
138                  if (string.IsNullOrEmpty(_encodedToken))
139                  {
140                      _encodedToken = this.Encode();
141                  }
142                  return _encodedToken;
143              }
144              private set
145              {
146                  this._encodedToken = value;
147              }
148          }
149          public string Scopes =&gt; _payload.Scopes;
150          #endregion
151          #region Public \ Protected Overrides
152          public override string ToString()
153          {
154              return string.Format(&quot;{0}.{1}&quot;,
155                  this._header.ToString(), this._payload.ToString());
156          }
157          #endregion
158          #region Internal Properties
159          internal IDictionary&lt;string, object&gt; Header =&gt; this._header;
160          internal IDictionary&lt;string, object&gt; Payload =&gt; this._payload;
161          internal byte[] Signature =&gt; this._signature;
162          #endregion
163          #region Private Helpers
164          private static JWTHeader GetHeader(VssSigningCredentials credentials, bool allowExpired)
165          {
166              JWTHeader header = new JWTHeader();
167              JWTAlgorithm alg = JsonWebTokenUtilities.ValidateSigningCredentials(credentials, allowExpired);
168              header.Algorithm = alg;
169              if (alg != JWTAlgorithm.None)
170              {
171                  var jwtHeaderProvider = credentials as IJsonWebTokenHeaderProvider;
172                  if (jwtHeaderProvider != null)
173                  {
174                      jwtHeaderProvider.SetHeaders(header);
175                  }
176              }
177              return header;
178          }
179          private static byte[] GetSignature(JWTHeader header, JWTPayload payload, VssSigningCredentials credentials, bool allowExpired)
180          {
181              JWTAlgorithm alg = JsonWebTokenUtilities.ValidateSigningCredentials(credentials, allowExpired);
182              return GetSignature(header, payload, alg, credentials);
183          }
184          private static byte[] GetSignature(JWTHeader header, JWTPayload payload, JWTAlgorithm alg, VssSigningCredentials signingCredentials)
185          {
186              if (alg == JWTAlgorithm.None)
187              {
188                  return null;
189              }
190              ArgumentUtility.CheckForNull(header, nameof(header));
191              ArgumentUtility.CheckForNull(payload, nameof(payload));
192              string encoding = string.Format(&quot;{0}.{1}&quot;, header.JsonEncode(), payload.JsonEncode());
193              byte[] bytes = Encoding.UTF8.GetBytes(encoding);
194              switch (alg)
195              {
196                  case JWTAlgorithm.HS256:
197                  case JWTAlgorithm.RS256:
198                      return signingCredentials.SignData(bytes);
199                  default:
200                      throw new InvalidOperationException();
201              }
202          }
203          private string Encode()
204          {
205              string encodedHeader = JsonWebTokenUtilities.JsonEncode(this._header);
206              string encodedPayload = JsonWebTokenUtilities.JsonEncode(this._payload);
207              string encodedSignature = null;
208              if (this._signature != null)
209              {
210                  encodedSignature = this._signature.ToBase64StringNoPadding();
211              }
212              return string.Format(&quot;{0}.{1}.{2}&quot;, encodedHeader, encodedPayload, encodedSignature);
213          }
214          private void OnDeserialized(&amp;bsol;*StreamingContext context*/)
215          {
216              if (string.IsNullOrEmpty(this._encodedToken))
217                  throw new JsonWebTokenDeserializationException();
218              string[] fields = this._encodedToken.Split(&#x27;.&#x27;);
219              if (fields.Length != 3)
220                  throw new JsonWebTokenDeserializationException();
221              this._header = JsonWebTokenUtilities.JsonDecode&lt;JWTHeader&gt;(fields[0]);
222              this._payload = JsonWebTokenUtilities.JsonDecode&lt;JWTPayload&gt;(fields[1]);
223              if (!string.IsNullOrEmpty(fields[2]))
224              {
225                  this._signature = fields[2].FromBase64StringNoPadding();
226              }
227          }
228          #endregion
229          #region Nested Types
230          [JsonDictionary]
231          private abstract class JWTSectionBase : Dictionary&lt;string, object&gt;
232          {
233              public override string ToString()
234              {
235                  return JsonConvert.SerializeObject(this, JsonWebTokenUtilities.DefaultSerializerSettings);
236              }
237              protected T TryGetValueOrDefault&lt;T&gt;(string key)
238              {
239                  object ret;
240                  if (TryGetValue(key, out ret))
241                  {
242                      if (typeof(T) == typeof(DateTime))
243                      {
244                          return (T)(object)ConvertDateTime(ret);
245                      }
246                      if (typeof(T).GetTypeInfo().IsEnum &amp;&amp; ret is string)
247                      {
248                          return (T)Enum.Parse(typeof(T), (string)ret);
249                      }
250                      return (T)Convert.ChangeType(ret, typeof(T));
251                  }
252                  return default(T);
253              }
254              protected System.DateTime ConvertDateTime(object obj)
255              {
256                  if (obj is DateTime)
257                  {
258                      return (DateTime)obj;
259                  }
260                  else
261                  {
262                      long longVal = Convert.ToInt64(obj);
263                      return longVal.FromUnixEpochTime();
264                  }
265              }
266          }
267          private class JWTHeader : JWTSectionBase
268          {
269              public JWTHeader() : base()
270              {
271                  this.Type = &quot;JWT&quot;;
272              }
273              internal string Type
274              {
275                  get
276                  {
277                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenHeaderParameters.Type);
278                  }
279                  set
280                  {
281                      if (string.IsNullOrEmpty(value))
282                      {
283                          this.Remove(JsonWebTokenHeaderParameters.Type);
284                      }
285                      else
286                      {
287                          this[JsonWebTokenHeaderParameters.Type] = value;
288                      }
289                  }
290              }
291              internal JWTAlgorithm Algorithm
292              {
293                  get
294                  {
295                      return TryGetValueOrDefault&lt;JWTAlgorithm&gt;(JsonWebTokenHeaderParameters.Algorithm);
296                  }
297                  set
298                  {
299                      this[JsonWebTokenHeaderParameters.Algorithm] = value;
300                  }
301              }
302              internal string CertificateThumbprint
303              {
304                  get
305                  {
306                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenHeaderParameters.X509CertificateThumbprint);
307                  }
308                  set
309                  {
310                      if (string.IsNullOrEmpty(value))
311                      {
312                          this.Remove(JsonWebTokenHeaderParameters.X509CertificateThumbprint);
313                      }
314                      else
315                      {
316                          this[JsonWebTokenHeaderParameters.X509CertificateThumbprint] = value;
317                      }
318                  }
319              }
320          }
321          private class JWTPayload : JWTSectionBase
322          {
323              public JWTPayload() { }
324              internal JWTPayload(IEnumerable&lt;Claim&gt; claims)
325              {
326                  this.AddRange(JsonWebTokenUtilities.TranslateToJwtClaims(claims.AsEmptyIfNull()));
327              }
328              internal string Audience
329              {
330                  get
331                  {
332                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenClaims.Audience);
333                  }
334                  set
335                  {
336                      ArgumentUtility.CheckStringForNullOrEmpty(value, nameof(Audience));
337                      this[JsonWebTokenClaims.Audience] = value;
338                  }
339              }
340              internal string Issuer
341              {
342                  get
343                  {
344                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenClaims.Issuer);
345                  }
346                  set
347                  {
348                      ArgumentUtility.CheckStringForNullOrEmpty(value, nameof(Issuer));
349                      this[JsonWebTokenClaims.Issuer] = value;
350                  }
351              }
352              internal string Subject
353              {
354                  get
355                  {
356                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenClaims.Subject);
357                  }
358                  set
359                  {
360                      ArgumentUtility.CheckStringForNullOrEmpty(value, nameof(Subject));
361                      this[JsonWebTokenClaims.Subject] = value;
362                  }
363              }
364              internal string NameIdentifier
365              {
366                  get
367                  {
368                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenClaims.NameId);
369                  }
370                  set
371                  {
372                      if (string.IsNullOrEmpty(value))
373                      {
374                          this.Remove(JsonWebTokenClaims.NameId);
375                      }
376                      else
377                      {
378                          this[JsonWebTokenClaims.NameId] = value;
379                      }
380                  }
381              }
382              internal string IdentityProvider
383              {
384                  get
385                  {
386                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenClaims.IdentityProvider);
387                  }
388                  set
389                  {
390                      if (string.IsNullOrEmpty(value))
391                      {
392                          this.Remove(JsonWebTokenClaims.IdentityProvider);
393                      }
394                      else
395                      {
396                          this[JsonWebTokenClaims.IdentityProvider] = value;
397                      }
398                  }
399              }
400              internal DateTime ValidTo
401              {
402                  get
403                  {
404                      return TryGetValueOrDefault&lt;DateTime&gt;(JsonWebTokenClaims.ValidTo);
405                  }
406                  set
407                  {
408                      this[JsonWebTokenClaims.ValidTo] = value;
409                  }
410              }
411              internal DateTime ValidFrom
412              {
413                  get
414                  {
415                      return TryGetValueOrDefault&lt;DateTime&gt;(JsonWebTokenClaims.ValidFrom);
416                  }
417                  set
418                  {
419                      this[JsonWebTokenClaims.ValidFrom] = value;
420                  }
421              }
422              internal DateTime IssuedAt
423              {
<span onclick='openModal()' class='match'>424                  get
425                  {
426                      return TryGetValueOrDefault&lt;DateTime&gt;(JsonWebTokenClaims.IssuedAt);
427                  }
428                  set
429                  {
430                      if (value == default(DateTime))
</span>431                      {
432                          this.Remove(JsonWebTokenClaims.IssuedAt);
433                      }
434                      else
435                      {
436                          this[JsonWebTokenClaims.IssuedAt] = value;
437                      }
438                  }
439              }
440              internal bool TrustedForDelegation
441              {
442                  get
443                  {
444                      return TryGetValueOrDefault&lt;bool&gt;(JsonWebTokenClaims.TrustedForDelegation);
445                  }
446                  set
447                  {
448                      this[JsonWebTokenClaims.TrustedForDelegation] = value;
449                  }
450              }
451              internal string ApplicationIdentifier
452              {
453                  get
454                  {
455                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenClaims.AppId);
456                  }
457                  set
458                  {
459                      if (string.IsNullOrEmpty(value))
460                      {
461                          this.Remove(JsonWebTokenClaims.AppId);
462                      }
463                      else
464                      {
465                          this[JsonWebTokenClaims.AppId] = value;
466                      }
467                  }
468              }
469              internal JsonWebToken Actor
470              {
471                  get
472                  {
473                      if (_actorToken == null &amp;&amp; TryGetValueOrDefault&lt;string&gt;(JsonWebTokenClaims.ActorToken) != null)
474                      {
475                          _actorToken = JsonConvert.DeserializeObject&lt;JsonWebToken&gt;((string)this[JsonWebTokenClaims.ActorToken], JsonWebTokenUtilities.DefaultSerializerSettings);
476                      }
477                      return _actorToken;
478                  }
479                  set
480                  {
481                      if (value == null)
482                      {
483                          this.Remove(JsonWebTokenClaims.ActorToken);
484                      }
485                      else
486                      {
487                          this[JsonWebTokenClaims.ActorToken] = JsonConvert.SerializeObject(value);
488                      }
489                  }
490              }
491              internal string ActorToken
492              {
493                  get
494                  {
495                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenClaims.ActorToken);
496                  }
497                  set
498                  {
499                      this[JsonWebTokenClaims.ActorToken] = value;
500                  }
501              }
502              internal string Scopes
503              {
504                  get
505                  {
506                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenClaims.Scopes);
507                  }
508                  set
509                  {
510                      this[JsonWebTokenClaims.Scopes] = value;
511                  }
512              }
513              private JsonWebToken _actorToken;
514          }
515          internal class JsonWebTokenConverter : VssSecureJsonConverter
516          {
517              public override bool CanConvert(Type objectType)
518              {
519                  return (objectType == typeof(JsonWebToken));
520              }
521              public override object ReadJson(JsonReader reader, Type objectType, object existingValue, JsonSerializer serializer)
522              {
523                  if (reader.TokenType == JsonToken.Null) return null;
524                  else if (reader.TokenType == JsonToken.String)
525                  {
526                      var ret = new JsonWebToken { EncodedToken = (string)reader.Value };
527                      ret.OnDeserialized();
528                      return ret;
529                  }
530                  else
531                      throw new JsonWebTokenDeserializationException();
532              }
533              public override void WriteJson(JsonWriter writer, object value, JsonSerializer serializer)
534              {
535                  base.WriteJson(writer, value, serializer);
536                  if (!(value is JsonWebToken)) throw new JsonWebTokenSerializationException();
537                  writer.WriteValue(((JsonWebToken)value).EncodedToken);
538              }
539          }
540          #endregion
541      }
542  }
</code></pre>
        </div>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-JsonWebToken.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Net;
4  using System.Net.Http;
5  using System.Net.Http.Headers;
6  using System.Reflection;
7  using System.Runtime.Serialization;
8  using System.Security.Claims;
9  using System.Text;
10  using GitHub.Services.Common;
11  using Newtonsoft.Json;
12  using Newtonsoft.Json.Linq;
13  namespace GitHub.Services.WebApi.Jwt
14  {
15      [DataContract]
16      public enum JWTAlgorithm
17      {
18          [EnumMember]
19          None,
20          [EnumMember]
21          HS256,
22          [EnumMember]
23          RS256
24      }
25      [DataContract]
26      [JsonConverter(typeof(JsonWebTokenConverter))]
27      public sealed class JsonWebToken : IssuedToken
28      {
29          private const int DefaultLifetime = 300;
30          #region Factory Methods
31          public static JsonWebToken Create(string issuer, string audience, DateTime validFrom, DateTime validTo, VssSigningCredentials credentials)
32          {
33              return Create(issuer, audience, validFrom, validTo, default(DateTime), null, null, null, credentials, allowExpiredCertificate: false);
34          }
35          public static JsonWebToken Create(string issuer, string audience, DateTime validFrom, DateTime validTo, IEnumerable&lt;Claim&gt; additionalClaims, JsonWebToken actor)
36          {
37              ArgumentUtility.CheckForNull(additionalClaims, nameof(additionalClaims));
38              ArgumentUtility.CheckForNull(actor, nameof(actor));
39              return Create(issuer, audience, validFrom, validTo, default(DateTime), additionalClaims, actor, null, null, allowExpiredCertificate: false);
40          }
41          public static JsonWebToken Create(string issuer, string audience, DateTime validFrom, DateTime validTo, IEnumerable&lt;Claim&gt; additionalClaims, string actorToken)
42          {
43              ArgumentUtility.CheckForNull(additionalClaims, nameof(additionalClaims));
44              ArgumentUtility.CheckStringForNullOrEmpty(actorToken, nameof(actorToken));
45              return Create(issuer, audience, validFrom, validTo, default(DateTime), additionalClaims, null, actorToken, null, allowExpiredCertificate: false);
46          }
47          public static JsonWebToken Create(string issuer, string audience, DateTime validFrom, DateTime validTo, IEnumerable&lt;Claim&gt; additionalClaims, VssSigningCredentials credentials)
48          {
49              ArgumentUtility.CheckForNull(additionalClaims, nameof(additionalClaims));
50              return Create(issuer, audience, validFrom, validTo, default(DateTime), additionalClaims, null, null, credentials, allowExpiredCertificate: false);
51          }
52          public static JsonWebToken Create(string issuer, string audience, DateTime validFrom, DateTime validTo, IEnumerable&lt;Claim&gt; additionalClaims, VssSigningCredentials credentials, bool allowExpiredCertificate)
53          {
54              ArgumentUtility.CheckForNull(additionalClaims, nameof(additionalClaims));
55              return Create(issuer, audience, validFrom, validTo, default(DateTime), additionalClaims, null, null, credentials, allowExpiredCertificate);
56          }
57          public static JsonWebToken Create(string issuer, string audience, DateTime validFrom, DateTime validTo, DateTime issuedAt, IEnumerable&lt;Claim&gt; additionalClaims, VssSigningCredentials credentials)
58          {
59              ArgumentUtility.CheckForNull(additionalClaims, nameof(additionalClaims));
60              return Create(issuer, audience, validFrom, validTo, issuedAt, additionalClaims, null, null, credentials, allowExpiredCertificate: false);
61          }
62          private static JsonWebToken Create(string issuer, string audience, DateTime validFrom, DateTime validTo, DateTime issuedAt, IEnumerable&lt;Claim&gt; additionalClaims, JsonWebToken actor, string actorToken, VssSigningCredentials credentials, bool allowExpiredCertificate)
63          {
64              ArgumentUtility.CheckStringForNullOrEmpty(issuer, nameof(issuer));
65              ArgumentUtility.CheckStringForNullOrEmpty(audience, nameof(audience)); 
66              validFrom = validFrom == default(DateTime) ? DateTime.UtcNow : validFrom.ToUniversalTime();
67              validTo = validTo == default(DateTime) ? DateTime.UtcNow + TimeSpan.FromSeconds(DefaultLifetime) : validTo.ToUniversalTime();
68              issuedAt = issuedAt == default(DateTime) ? default(DateTime) : issuedAt.ToUniversalTime();
69              JWTHeader header = GetHeader(credentials, allowExpiredCertificate);
70              JWTPayload payload = new JWTPayload(additionalClaims) { Issuer = issuer, Audience = audience, ValidFrom = validFrom, ValidTo = validTo, IssuedAt = issuedAt };
71              if (actor != null)
72              {
73                  payload.Actor = actor;
74              }
75              else if (actorToken != null)
76              {
77                  payload.ActorToken = actorToken;
78              }
79              byte[] signature = GetSignature(header, payload, header.Algorithm, credentials);
80              return new JsonWebToken(header, payload, signature);
81          }
82          public static JsonWebToken Create(string jwtEncodedString)
83          {
84              ArgumentUtility.CheckStringForNullOrEmpty(jwtEncodedString, nameof(jwtEncodedString));
85              JValue value = new JValue(jwtEncodedString);
86              return value.ToObject&lt;JsonWebToken&gt;();
87          }
88          #endregion
89          #region .ctors
90          private JsonWebToken() { }
91          private JsonWebToken(JWTHeader header, JWTPayload payload, byte[] signature)
92          {
93              ArgumentUtility.CheckForNull(header, nameof(header));
94              ArgumentUtility.CheckForNull(payload, nameof(payload));
95              _header = header;
96              _payload = payload;
97              _signature = signature;
98          }
99          #endregion
100          #region Base Class Overrides
101          protected internal override VssCredentialsType CredentialType
102          {
103              get
104              {
105                  return VssCredentialsType.S2S;
106              }
107          }
108          internal override void ApplyTo(IHttpRequest request)
109          {
110              request.Headers.SetValue(Common.Internal.HttpHeaders.Authorization, $&quot;Bearer {this.EncodedToken}&quot;);
111          }
112          #endregion
113          #region Private Fields
114          JWTHeader _header;
115          JWTPayload _payload;
116          byte[] _signature;
117          string _encodedToken;
118          #endregion
119          #region Public Properties
120          public string TokenType =&gt; _header.Type;
121          public JWTAlgorithm Algorithm =&gt; _header.Algorithm;
122          public string CertificateThumbprint =&gt; _header.CertificateThumbprint;
123          public string Audience =&gt; _payload.Audience;
124          public string Issuer =&gt; _payload.Issuer;
125          public string Subject =&gt; _payload.Subject;
126          public string NameIdentifier =&gt; _payload.NameIdentifier;
127          public string IdentityProvider =&gt; _payload.IdentityProvider;
128          public DateTime ValidTo =&gt; _payload.ValidTo;
129          public DateTime ValidFrom =&gt; _payload.ValidFrom;
130          public DateTime IssuedAt =&gt; _payload.IssuedAt;
131          public bool TrustedForDelegation =&gt; _payload.TrustedForDelegation;
132          public JsonWebToken Actor =&gt; _payload.Actor;
133          public string ApplicationIdentifier =&gt; _payload.ApplicationIdentifier;
134          public string EncodedToken
135          {
136              get
137              {
138                  if (string.IsNullOrEmpty(_encodedToken))
139                  {
140                      _encodedToken = this.Encode();
141                  }
142                  return _encodedToken;
143              }
144              private set
145              {
146                  this._encodedToken = value;
147              }
148          }
149          public string Scopes =&gt; _payload.Scopes;
150          #endregion
151          #region Public \ Protected Overrides
152          public override string ToString()
153          {
154              return string.Format(&quot;{0}.{1}&quot;,
155                  this._header.ToString(), this._payload.ToString());
156          }
157          #endregion
158          #region Internal Properties
159          internal IDictionary&lt;string, object&gt; Header =&gt; this._header;
160          internal IDictionary&lt;string, object&gt; Payload =&gt; this._payload;
161          internal byte[] Signature =&gt; this._signature;
162          #endregion
163          #region Private Helpers
164          private static JWTHeader GetHeader(VssSigningCredentials credentials, bool allowExpired)
165          {
166              JWTHeader header = new JWTHeader();
167              JWTAlgorithm alg = JsonWebTokenUtilities.ValidateSigningCredentials(credentials, allowExpired);
168              header.Algorithm = alg;
169              if (alg != JWTAlgorithm.None)
170              {
171                  var jwtHeaderProvider = credentials as IJsonWebTokenHeaderProvider;
172                  if (jwtHeaderProvider != null)
173                  {
174                      jwtHeaderProvider.SetHeaders(header);
175                  }
176              }
177              return header;
178          }
179          private static byte[] GetSignature(JWTHeader header, JWTPayload payload, VssSigningCredentials credentials, bool allowExpired)
180          {
181              JWTAlgorithm alg = JsonWebTokenUtilities.ValidateSigningCredentials(credentials, allowExpired);
182              return GetSignature(header, payload, alg, credentials);
183          }
184          private static byte[] GetSignature(JWTHeader header, JWTPayload payload, JWTAlgorithm alg, VssSigningCredentials signingCredentials)
185          {
186              if (alg == JWTAlgorithm.None)
187              {
188                  return null;
189              }
190              ArgumentUtility.CheckForNull(header, nameof(header));
191              ArgumentUtility.CheckForNull(payload, nameof(payload));
192              string encoding = string.Format(&quot;{0}.{1}&quot;, header.JsonEncode(), payload.JsonEncode());
193              byte[] bytes = Encoding.UTF8.GetBytes(encoding);
194              switch (alg)
195              {
196                  case JWTAlgorithm.HS256:
197                  case JWTAlgorithm.RS256:
198                      return signingCredentials.SignData(bytes);
199                  default:
200                      throw new InvalidOperationException();
201              }
202          }
203          private string Encode()
204          {
205              string encodedHeader = JsonWebTokenUtilities.JsonEncode(this._header);
206              string encodedPayload = JsonWebTokenUtilities.JsonEncode(this._payload);
207              string encodedSignature = null;
208              if (this._signature != null)
209              {
210                  encodedSignature = this._signature.ToBase64StringNoPadding();
211              }
212              return string.Format(&quot;{0}.{1}.{2}&quot;, encodedHeader, encodedPayload, encodedSignature);
213          }
214          private void OnDeserialized(&amp;bsol;*StreamingContext context*/)
215          {
216              if (string.IsNullOrEmpty(this._encodedToken))
217                  throw new JsonWebTokenDeserializationException();
218              string[] fields = this._encodedToken.Split(&#x27;.&#x27;);
219              if (fields.Length != 3)
220                  throw new JsonWebTokenDeserializationException();
221              this._header = JsonWebTokenUtilities.JsonDecode&lt;JWTHeader&gt;(fields[0]);
222              this._payload = JsonWebTokenUtilities.JsonDecode&lt;JWTPayload&gt;(fields[1]);
223              if (!string.IsNullOrEmpty(fields[2]))
224              {
225                  this._signature = fields[2].FromBase64StringNoPadding();
226              }
227          }
228          #endregion
229          #region Nested Types
230          [JsonDictionary]
231          private abstract class JWTSectionBase : Dictionary&lt;string, object&gt;
232          {
233              public override string ToString()
234              {
235                  return JsonConvert.SerializeObject(this, JsonWebTokenUtilities.DefaultSerializerSettings);
236              }
237              protected T TryGetValueOrDefault&lt;T&gt;(string key)
238              {
239                  object ret;
240                  if (TryGetValue(key, out ret))
241                  {
242                      if (typeof(T) == typeof(DateTime))
243                      {
244                          return (T)(object)ConvertDateTime(ret);
245                      }
246                      if (typeof(T).GetTypeInfo().IsEnum &amp;&amp; ret is string)
247                      {
248                          return (T)Enum.Parse(typeof(T), (string)ret);
249                      }
250                      return (T)Convert.ChangeType(ret, typeof(T));
251                  }
252                  return default(T);
253              }
254              protected System.DateTime ConvertDateTime(object obj)
255              {
256                  if (obj is DateTime)
257                  {
258                      return (DateTime)obj;
259                  }
260                  else
261                  {
262                      long longVal = Convert.ToInt64(obj);
263                      return longVal.FromUnixEpochTime();
264                  }
265              }
266          }
267          private class JWTHeader : JWTSectionBase
268          {
269              public JWTHeader() : base()
270              {
271                  this.Type = &quot;JWT&quot;;
272              }
273              internal string Type
274              {
275                  get
276                  {
277                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenHeaderParameters.Type);
278                  }
279                  set
280                  {
281                      if (string.IsNullOrEmpty(value))
282                      {
283                          this.Remove(JsonWebTokenHeaderParameters.Type);
284                      }
285                      else
286                      {
287                          this[JsonWebTokenHeaderParameters.Type] = value;
288                      }
289                  }
290              }
291              internal JWTAlgorithm Algorithm
292              {
293                  get
294                  {
295                      return TryGetValueOrDefault&lt;JWTAlgorithm&gt;(JsonWebTokenHeaderParameters.Algorithm);
296                  }
297                  set
298                  {
299                      this[JsonWebTokenHeaderParameters.Algorithm] = value;
300                  }
301              }
302              internal string CertificateThumbprint
303              {
304                  get
305                  {
306                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenHeaderParameters.X509CertificateThumbprint);
307                  }
308                  set
309                  {
310                      if (string.IsNullOrEmpty(value))
311                      {
312                          this.Remove(JsonWebTokenHeaderParameters.X509CertificateThumbprint);
313                      }
314                      else
315                      {
316                          this[JsonWebTokenHeaderParameters.X509CertificateThumbprint] = value;
317                      }
318                  }
319              }
320          }
321          private class JWTPayload : JWTSectionBase
322          {
323              public JWTPayload() { }
324              internal JWTPayload(IEnumerable&lt;Claim&gt; claims)
325              {
326                  this.AddRange(JsonWebTokenUtilities.TranslateToJwtClaims(claims.AsEmptyIfNull()));
327              }
328              internal string Audience
329              {
330                  get
331                  {
332                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenClaims.Audience);
333                  }
334                  set
335                  {
336                      ArgumentUtility.CheckStringForNullOrEmpty(value, nameof(Audience));
337                      this[JsonWebTokenClaims.Audience] = value;
338                  }
339              }
340              internal string Issuer
341              {
342                  get
343                  {
344                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenClaims.Issuer);
345                  }
346                  set
347                  {
348                      ArgumentUtility.CheckStringForNullOrEmpty(value, nameof(Issuer));
349                      this[JsonWebTokenClaims.Issuer] = value;
350                  }
351              }
352              internal string Subject
353              {
354                  get
355                  {
356                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenClaims.Subject);
357                  }
358                  set
359                  {
360                      ArgumentUtility.CheckStringForNullOrEmpty(value, nameof(Subject));
361                      this[JsonWebTokenClaims.Subject] = value;
362                  }
363              }
364              internal string NameIdentifier
365              {
366                  get
367                  {
368                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenClaims.NameId);
369                  }
370                  set
371                  {
372                      if (string.IsNullOrEmpty(value))
373                      {
374                          this.Remove(JsonWebTokenClaims.NameId);
375                      }
376                      else
377                      {
378                          this[JsonWebTokenClaims.NameId] = value;
379                      }
380                  }
381              }
382              internal string IdentityProvider
383              {
384                  get
385                  {
386                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenClaims.IdentityProvider);
387                  }
388                  set
389                  {
390                      if (string.IsNullOrEmpty(value))
391                      {
392                          this.Remove(JsonWebTokenClaims.IdentityProvider);
393                      }
394                      else
395                      {
396                          this[JsonWebTokenClaims.IdentityProvider] = value;
397                      }
398                  }
399              }
400              internal DateTime ValidTo
401              {
402                  get
403                  {
404                      return TryGetValueOrDefault&lt;DateTime&gt;(JsonWebTokenClaims.ValidTo);
405                  }
406                  set
407                  {
408                      this[JsonWebTokenClaims.ValidTo] = value;
409                  }
410              }
411              internal DateTime ValidFrom
412              {
<span onclick='openModal()' class='match'>413                  get
414                  {
415                      return TryGetValueOrDefault&lt;DateTime&gt;(JsonWebTokenClaims.ValidFrom);
416                  }
417                  set
418                  {
419                      this[JsonWebTokenClaims.ValidFrom] = value;
</span>420                  }
421              }
422              internal DateTime IssuedAt
423              {
424                  get
425                  {
426                      return TryGetValueOrDefault&lt;DateTime&gt;(JsonWebTokenClaims.IssuedAt);
427                  }
428                  set
429                  {
430                      if (value == default(DateTime))
431                      {
432                          this.Remove(JsonWebTokenClaims.IssuedAt);
433                      }
434                      else
435                      {
436                          this[JsonWebTokenClaims.IssuedAt] = value;
437                      }
438                  }
439              }
440              internal bool TrustedForDelegation
441              {
442                  get
443                  {
444                      return TryGetValueOrDefault&lt;bool&gt;(JsonWebTokenClaims.TrustedForDelegation);
445                  }
446                  set
447                  {
448                      this[JsonWebTokenClaims.TrustedForDelegation] = value;
449                  }
450              }
451              internal string ApplicationIdentifier
452              {
453                  get
454                  {
455                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenClaims.AppId);
456                  }
457                  set
458                  {
459                      if (string.IsNullOrEmpty(value))
460                      {
461                          this.Remove(JsonWebTokenClaims.AppId);
462                      }
463                      else
464                      {
465                          this[JsonWebTokenClaims.AppId] = value;
466                      }
467                  }
468              }
469              internal JsonWebToken Actor
470              {
471                  get
472                  {
473                      if (_actorToken == null &amp;&amp; TryGetValueOrDefault&lt;string&gt;(JsonWebTokenClaims.ActorToken) != null)
474                      {
475                          _actorToken = JsonConvert.DeserializeObject&lt;JsonWebToken&gt;((string)this[JsonWebTokenClaims.ActorToken], JsonWebTokenUtilities.DefaultSerializerSettings);
476                      }
477                      return _actorToken;
478                  }
479                  set
480                  {
481                      if (value == null)
482                      {
483                          this.Remove(JsonWebTokenClaims.ActorToken);
484                      }
485                      else
486                      {
487                          this[JsonWebTokenClaims.ActorToken] = JsonConvert.SerializeObject(value);
488                      }
489                  }
490              }
491              internal string ActorToken
492              {
493                  get
494                  {
495                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenClaims.ActorToken);
496                  }
497                  set
498                  {
499                      this[JsonWebTokenClaims.ActorToken] = value;
500                  }
501              }
502              internal string Scopes
503              {
504                  get
505                  {
506                      return TryGetValueOrDefault&lt;string&gt;(JsonWebTokenClaims.Scopes);
507                  }
508                  set
509                  {
510                      this[JsonWebTokenClaims.Scopes] = value;
511                  }
512              }
513              private JsonWebToken _actorToken;
514          }
515          internal class JsonWebTokenConverter : VssSecureJsonConverter
516          {
517              public override bool CanConvert(Type objectType)
518              {
519                  return (objectType == typeof(JsonWebToken));
520              }
521              public override object ReadJson(JsonReader reader, Type objectType, object existingValue, JsonSerializer serializer)
522              {
523                  if (reader.TokenType == JsonToken.Null) return null;
524                  else if (reader.TokenType == JsonToken.String)
525                  {
526                      var ret = new JsonWebToken { EncodedToken = (string)reader.Value };
527                      ret.OnDeserialized();
528                      return ret;
529                  }
530                  else
531                      throw new JsonWebTokenDeserializationException();
532              }
533              public override void WriteJson(JsonWriter writer, object value, JsonSerializer serializer)
534              {
535                  base.WriteJson(writer, value, serializer);
536                  if (!(value is JsonWebToken)) throw new JsonWebTokenSerializationException();
537                  writer.WriteValue(((JsonWebToken)value).EncodedToken);
538              }
539          }
540          #endregion
541      }
542  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-JsonWebToken.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-JsonWebToken.cs</div>
                </div>
                <div class="column column_space"><pre><code>424                  get
425                  {
426                      return TryGetValueOrDefault&lt;DateTime&gt;(JsonWebTokenClaims.IssuedAt);
427                  }
428                  set
429                  {
430                      if (value == default(DateTime))
</pre></code></div>
                <div class="column column_space"><pre><code>413                  get
414                  {
415                      return TryGetValueOrDefault&lt;DateTime&gt;(JsonWebTokenClaims.ValidFrom);
416                  }
417                  set
418                  {
419                      this[JsonWebTokenClaims.ValidFrom] = value;
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    