
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 12, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-VssHttpClientBase.cs</h3>
            <pre><code>1  using System;
2  using System.Collections;
3  using System.Collections.Generic;
4  using System.ComponentModel;
5  using System.Globalization;
6  using System.IO;
7  using System.Linq;
8  using System.Net;
9  using System.Net.Http;
10  using System.Net.Http.Formatting;
11  using System.Net.Http.Headers;
12  using System.Reflection;
13  using System.Threading;
14  using System.Threading.Tasks;
15  using GitHub.Services.Common;
16  using GitHub.Services.Common.Diagnostics;
17  using GitHub.Services.Common.Internal;
18  using GitHub.Services.WebApi.Utilities.Internal;
19  using Newtonsoft.Json;
20  using Newtonsoft.Json.Linq;
21  namespace GitHub.Services.WebApi
22  {
23      public abstract class VssHttpClientBase : IDisposable
24      {
25          protected VssHttpClientBase(
26              Uri baseUrl,
27              VssCredentials credentials)
28              : this(baseUrl, credentials, settings: null)
29          {
30          }
31          protected VssHttpClientBase(
32              Uri baseUrl,
33              VssCredentials credentials,
34              VssHttpRequestSettings settings)
35              : this(baseUrl, credentials, settings: settings, handlers: null)
36          {
37          }
38          protected VssHttpClientBase(
39              Uri baseUrl,
40              VssCredentials credentials,
41              params DelegatingHandler[] handlers)
42              : this(baseUrl, credentials, null, handlers)
43          {
44          }
<span onclick='openModal()' class='match'>45          protected VssHttpClientBase(
46              Uri baseUrl,
47              VssCredentials credentials,
48              VssHttpRequestSettings settings,
49              params DelegatingHandler[] handlers)
</span>50              : this(baseUrl, BuildHandler(credentials, settings, handlers), disposeHandler: true)
51          {
52          }
53          protected VssHttpClientBase(
54              Uri baseUrl,
55              HttpMessageHandler pipeline,
56              bool disposeHandler)
57          {
58              m_client = new HttpClient(pipeline, disposeHandler);
59              m_client.Timeout = TimeSpan.FromMilliseconds(-1.0);
60              m_client.BaseAddress = baseUrl;
61              m_formatter = new VssJsonMediaTypeFormatter();
62              SetServicePointOptions();
63              SetTokenStorageUrlIfNeeded(pipeline);
64          }
65          private void SetTokenStorageUrlIfNeeded(HttpMessageHandler handler)
66          {
67              if (handler is VssHttpMessageHandler vssHttpMessageHandler)
68              {
69                  if (vssHttpMessageHandler.Credentials != null)
70                  {
71                      if (vssHttpMessageHandler.Credentials.Federated != null
72                          &amp;&amp; vssHttpMessageHandler.Credentials.Federated.TokenStorageUrl == null)
73                      {
74                          vssHttpMessageHandler.Credentials.Federated.TokenStorageUrl = m_client.BaseAddress;
75                      }
76                  }
77              }
78              else if (handler is DelegatingHandler delegatingHandler)
79              {
80                  SetTokenStorageUrlIfNeeded(delegatingHandler.InnerHandler);
81              }
82          }
83          private static HttpMessageHandler BuildHandler(VssCredentials credentials, VssHttpRequestSettings settings, DelegatingHandler[] handlers)
84          {
85              VssHttpMessageHandler innerHandler = new VssHttpMessageHandler(credentials, settings ?? new VssHttpRequestSettings());
86              if (null == handlers ||
87                  0 == handlers.Length)
88              {
89                  return innerHandler;
90              }
91              return HttpClientFactory.CreatePipeline(innerHandler, handlers);
92          }
93          public Uri BaseAddress
94          {
95              get
96              {
97                  return m_client.BaseAddress;
98              }
99          }
100          public VssResponseContext LastResponseContext
101          {
102              get { return m_LastResponseContext; }
103          }
104          protected HttpClient Client
105          {
106              get
107              {
108                  return m_client;
109              }
110          }
111          protected MediaTypeFormatter Formatter
112          {
113              get
114              {
115                  return m_formatter;
116              }
117          }
118          protected virtual IDictionary&lt;String, Type&gt; TranslatedExceptions
119          {
120              get
121              {
122                  return null;
123              }
124          }
125          protected HttpResponseMessage Send(
126              HttpRequestMessage message,
127              Object userState = null)
128          {
129              try
130              {
131                  var response = SendAsync(message, userState);
132                  return response.Result;
133              }
134              catch (AggregateException ag)
135              {
136                  ag = ag.Flatten();
137                  if (ag.InnerExceptions.Count == 1)
138                  {
139                      throw ag.InnerExceptions[0];
140                  }
141                  throw;
142              }
143          }
144          protected Task&lt;HttpResponseMessage&gt; DeleteAsync(
145              Guid locationId,
146              Object routeValues = null,
147              ApiResourceVersion version = null,
148              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; queryParameters = null,
149              Object userState = null,
150              CancellationToken cancellationToken = default(CancellationToken))
151          {
152              return this.SendAsync(
153                   HttpMethod.Delete,
154                  locationId,
155                  routeValues,
156                  version,
157                   null,
158                  queryParameters,
159                  userState,
160                  cancellationToken);
161          }
162          protected Task&lt;HttpResponseMessage&gt; GetAsync(
163              Guid locationId,
164              Object routeValues = null,
165              ApiResourceVersion version = null,
166              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; queryParameters = null,
167              Object userState = null,
168              CancellationToken cancellationToken = default(CancellationToken))
169          {
170              return this.SendAsync(
171                   HttpMethod.Get,
172                  locationId,
173                  routeValues,
174                  version,
175                   null,
176                  queryParameters,
177                  userState,
178                  cancellationToken);
179          }
180          protected Task&lt;TResult&gt; GetAsync&lt;TResult&gt;(
181              Guid locationId,
182              Object routeValues = null,
183              ApiResourceVersion version = null,
184              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; queryParameters = null,
185              Object userState = null,
186              CancellationToken cancellationToken = default(CancellationToken))
187          {
188              return this.SendAsync&lt;TResult&gt;(
189                   HttpMethod.Get,
190                  locationId,
191                  routeValues,
192                  version,
193                   null,
194                  queryParameters,
195                  userState,
196                  cancellationToken);
197          }
198          protected Task&lt;HttpResponseMessage&gt; PatchAsync&lt;T&gt;(
199              T value,
200              Guid locationId,
201              Object routeValues = null,
202              ApiResourceVersion version = null,
203              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; queryParameters = null,
204              Object userState = null,
205              CancellationToken cancellationToken = default(CancellationToken))
206          {
207              return this.SendAsync(
208                   s_patchMethod.Value,
209                  locationId,
210                  routeValues,
211                  version,
212                   new ObjectContent&lt;T&gt;(value, m_formatter),
213                  queryParameters,
214                  userState,
215                  cancellationToken);
216          }
217          protected Task&lt;TResult&gt; PatchAsync&lt;T, TResult&gt;(
218              T value,
219              Guid locationId,
220              Object routeValues = null,
221              ApiResourceVersion version = null,
222              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; queryParameters = null,
223              Object userState = null,
224              CancellationToken cancellationToken = default(CancellationToken))
225          {
226              return this.SendAsync&lt;TResult&gt;(
227                   s_patchMethod.Value,
228                  locationId,
229                  routeValues,
230                  version,
231                   new ObjectContent&lt;T&gt;(value, m_formatter),
232                  queryParameters,
233                  userState,
234                  cancellationToken);
235          }
236          protected Task&lt;HttpResponseMessage&gt; PostAsync&lt;T&gt;(
237              T value,
238              Guid locationId,
239              Object routeValues = null,
240              ApiResourceVersion version = null,
241              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; queryParameters = null,
242              Object userState = null,
243              CancellationToken cancellationToken = default(CancellationToken))
244          {
245              return this.SendAsync(
246                   HttpMethod.Post,
247                  locationId,
248                  routeValues,
249                  version,
250                   new ObjectContent&lt;T&gt;(value, m_formatter),
251                  queryParameters,
252                  userState,
253                  cancellationToken);
254          }
255          protected Task&lt;TResult&gt; PostAsync&lt;T, TResult&gt;(
256              T value,
257              Guid locationId,
258              Object routeValues = null,
259              ApiResourceVersion version = null,
260              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; queryParameters = null,
261              Object userState = null,
262              CancellationToken cancellationToken = default(CancellationToken))
263          {
264              return this.SendAsync&lt;TResult&gt;(
265                   HttpMethod.Post,
266                  locationId,
267                  routeValues,
268                  version,
269                   new ObjectContent&lt;T&gt;(value, m_formatter),
270                  queryParameters,
271                  userState,
272                  cancellationToken);
273          }
274          protected Task&lt;HttpResponseMessage&gt; PutAsync&lt;T&gt;(
275              T value,
276              Guid locationId,
277              Object routeValues = null,
278              ApiResourceVersion version = null,
279              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; queryParameters = null,
280              Object userState = null,
281              CancellationToken cancellationToken = default(CancellationToken))
282          {
283              return this.SendAsync(
284                   HttpMethod.Put,
285                  locationId,
286                  routeValues,
287                  version,
288                   new ObjectContent&lt;T&gt;(value, m_formatter),
289                  queryParameters,
290                  userState,
291                  cancellationToken);
292          }
293          protected Task&lt;TResult&gt; PutAsync&lt;T, TResult&gt;(
294              T value,
295              Guid locationId,
296              Object routeValues = null,
297              ApiResourceVersion version = null,
298              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; queryParameters = null,
299              Object userState = null,
300              CancellationToken cancellationToken = default(CancellationToken))
301          {
302              return this.SendAsync&lt;TResult&gt;(
303                   HttpMethod.Put,
304                  locationId,
305                  routeValues,
306                  version,
307                   new ObjectContent&lt;T&gt;(value, m_formatter),
308                  queryParameters,
309                  userState,
310                  cancellationToken);
311          }
312          protected Task&lt;T&gt; SendAsync&lt;T&gt;(
313              HttpMethod method,
314              Guid locationId,
315              Object routeValues = null,
316              ApiResourceVersion version = null,
317              HttpContent content = null,
318              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; queryParameters = null,
319              Object userState = null,
320              CancellationToken cancellationToken = default(CancellationToken))
321          {
322              return SendAsync&lt;T&gt;(method, null, locationId, routeValues, version, content, queryParameters, userState, cancellationToken);
323          }
324          protected async Task&lt;T&gt; SendAsync&lt;T&gt;(
325              HttpMethod method,
326              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; additionalHeaders,
327              Guid locationId,
328              Object routeValues = null,
329              ApiResourceVersion version = null,
330              HttpContent content = null,
331              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; queryParameters = null,
332              Object userState = null,
333              CancellationToken cancellationToken = default(CancellationToken))
334          {
335              using (VssTraceActivity.GetOrCreate().EnterCorrelationScope())
336              using (HttpRequestMessage requestMessage = await CreateRequestMessageAsync(method, additionalHeaders, locationId, routeValues, version, content, queryParameters, userState, cancellationToken).ConfigureAwait(false))
337              {
338                  return await SendAsync&lt;T&gt;(requestMessage, userState, cancellationToken).ConfigureAwait(false);
339              }
340          }
341          protected async Task&lt;HttpResponseMessage&gt; SendAsync(
342              HttpMethod method,
343              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; additionalHeaders,
344              Guid locationId,
345              Object routeValues = null,
346              ApiResourceVersion version = null,
347              HttpContent content = null,
348              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; queryParameters = null,
349              Object userState = null,
350              CancellationToken cancellationToken = default(CancellationToken))
351          {
352              using (VssTraceActivity.GetOrCreate().EnterCorrelationScope())
353              using (HttpRequestMessage requestMessage = await CreateRequestMessageAsync(method, additionalHeaders, locationId, routeValues, version, content, queryParameters, userState, cancellationToken).ConfigureAwait(false))
354              {
355                  return await SendAsync(requestMessage, userState, cancellationToken).ConfigureAwait(false);
356              }
357          }
358          protected HttpResponseMessage Send(
359              HttpMethod method,
360              Guid locationId,
361              Object routeValues = null,
362              ApiResourceVersion version = null,
363              HttpContent content = null,
364              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; queryParameters = null,
365              Object userState = null)
366          {
367              using (VssTraceActivity.GetOrCreate().EnterCorrelationScope())
368              using (HttpRequestMessage requestMessage = CreateRequestMessageAsync(method, locationId, routeValues, version, content, queryParameters, userState, CancellationToken.None).SyncResult())
369              {
370                  return Send(requestMessage, userState);
371              }
372          }
373          protected async Task&lt;HttpResponseMessage&gt; SendAsync(
374              HttpMethod method,
375              Guid locationId,
376              Object routeValues = null,
377              ApiResourceVersion version = null,
378              HttpContent content = null,
379              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; queryParameters = null,
380              Object userState = null,
381              CancellationToken cancellationToken = default(CancellationToken))
382          {
383              using (VssTraceActivity.GetOrCreate().EnterCorrelationScope())
384              using (HttpRequestMessage requestMessage = await CreateRequestMessageAsync(method, locationId, routeValues, version, content, queryParameters, userState, cancellationToken).ConfigureAwait(false))
385              {
386                  return await SendAsync(requestMessage, userState, cancellationToken).ConfigureAwait(false);
387              }
388          }
389          protected async Task&lt;HttpResponseMessage&gt; SendAsync(
390              HttpMethod method,
391              Guid locationId,
392              HttpCompletionOption completionOption,
393              Object routeValues = null,
394              ApiResourceVersion version = null,
395              HttpContent content = null,
396              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; queryParameters = null,
397              Object userState = null,
398              CancellationToken cancellationToken = default(CancellationToken))
399          {
400              using (VssTraceActivity.GetOrCreate().EnterCorrelationScope())
401              using (HttpRequestMessage requestMessage = await CreateRequestMessageAsync(method, locationId, routeValues, version, content, queryParameters, userState, cancellationToken).ConfigureAwait(false))
402              {
403                  return await SendAsync(requestMessage, completionOption, userState, cancellationToken).ConfigureAwait(false);
404              }
405          }
406          protected Task&lt;HttpRequestMessage&gt; CreateRequestMessageAsync(
407              HttpMethod method,
408              Guid locationId,
409              Object routeValues = null,
410              ApiResourceVersion version = null,
411              HttpContent content = null,
412              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; queryParameters = null,
413              Object userState = null,
414              CancellationToken cancellationToken = default(CancellationToken),
415              String mediaType = c_jsonMediaType)
416          {
417              return CreateRequestMessageAsync(method, null, locationId, routeValues, version, content, queryParameters, userState, cancellationToken, mediaType);
418          }
419          protected virtual async Task&lt;HttpRequestMessage&gt; CreateRequestMessageAsync(
420              HttpMethod method,
421              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; additionalHeaders,
422              Guid locationId,
423              Object routeValues = null,
424              ApiResourceVersion version = null,
425              HttpContent content = null,
426              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; queryParameters = null,
427              Object userState = null,
428              CancellationToken cancellationToken = default(CancellationToken),
429              String mediaType = c_jsonMediaType)
430          {
431              ApiResourceLocation location = await GetResourceLocationAsync(locationId, userState, cancellationToken).ConfigureAwait(false);
432              if (location == null)
433              {
434                  throw new VssResourceNotFoundException(locationId, BaseAddress);
435              }
436              return CreateRequestMessage(method, additionalHeaders, location, routeValues, version, content, queryParameters, mediaType);
437          }
438          protected HttpRequestMessage CreateRequestMessage(
439              HttpMethod method,
440              ApiResourceLocation location,
441              Object routeValues = null,
442              ApiResourceVersion version = null,
443              HttpContent content = null,
444              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; queryParameters = null,
445              String mediaType = c_jsonMediaType)
446          {
447              return CreateRequestMessage(method, null, location, routeValues, version, content, queryParameters, mediaType);
448          }
449          protected HttpRequestMessage CreateRequestMessage(
450              HttpMethod method,
451              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; additionalHeaders,
452              ApiResourceLocation location,
453              Object routeValues = null,
454              ApiResourceVersion version = null,
455              HttpContent content = null,
456              IEnumerable&lt;KeyValuePair&lt;String, String&gt;&gt; queryParameters = null,
457              String mediaType = c_jsonMediaType)
458          {
459              CheckForDisposed();
460              ApiResourceVersion requestVersion = NegotiateRequestVersion(location, version);
461              if (requestVersion == null)
462              {
463                  throw new VssVersionNotSupportedException(location, version.ApiVersion, location.MinVersion, BaseAddress);
464              }
465              Dictionary&lt;String, Object&gt; valuesDictionary = VssHttpUriUtility.ToRouteDictionary(routeValues, location.Area, location.ResourceName);
466              String locationRelativePath = VssHttpUriUtility.ReplaceRouteValues(location.RouteTemplate, valuesDictionary);
467              Uri locationUri = VssHttpUriUtility.ConcatUri(BaseAddress, locationRelativePath);
468              if (queryParameters != null &amp;&amp; queryParameters.Any())
469              {
470                  locationUri = locationUri.AppendQuery(queryParameters);
471              }
472              HttpRequestMessage requestMessage = new HttpRequestMessage(method, locationUri.AbsoluteUri);
473              MediaTypeWithQualityHeaderValue acceptType = CreateAcceptHeader(requestVersion, mediaType);
474              if (m_excludeUrlsHeader)
475              {
476                  acceptType.Parameters.Add(new NameValueHeaderValue(VssHttpRequestSettings.ExcludeUrlsHeader, &quot;true&quot;));
477              }
478              if (m_lightweightHeader)
479              {
480                  acceptType.Parameters.Add(new NameValueHeaderValue(VssHttpRequestSettings.LightweightHeader, &quot;true&quot;));
481              }
482              requestMessage.Headers.Accept.Add(acceptType);
483              if (additionalHeaders != null)
484              {
485                  foreach (KeyValuePair&lt;String, String&gt; kvp in additionalHeaders)
486                  {
487                      requestMessage.Headers.Add(kvp.Key, kvp.Value);
488                  }
489              }
490              if (content != null)
491              {
492                  requestMessage.Content = content;
493                  if (requestMessage.Content.Headers.ContentType != null &amp;&amp; !requestMessage.Content.Headers.ContentType.Parameters.Any(p =&gt; p.Name.Equals(ApiResourceVersionExtensions.c_apiVersionHeaderKey)))
494                  {
495                      requestMessage.Content.Headers.ContentType.Parameters.Add(new NameValueHeaderValue(ApiResourceVersionExtensions.c_apiVersionHeaderKey, requestVersion.ToString()));
496                  }
497              }
498              return requestMessage;
499          }
500          protected virtual MediaTypeWithQualityHeaderValue CreateAcceptHeader(ApiResourceVersion requestVersion, String mediaType)
501          {
502              MediaTypeWithQualityHeaderValue acceptType = new MediaTypeWithQualityHeaderValue(mediaType);
503              acceptType.Parameters.AddApiResourceVersionValues(requestVersion, replaceExisting: true, useLegacyFormat: requestVersion.ApiVersion.Major &lt;= 1);
504              return acceptType;
505          }
506          protected virtual void AddModelAsQueryParams(IList&lt;KeyValuePair&lt;String, String&gt;&gt; queryParams, string parameterName, object model)
507          {
508              JObject jObject = JObject.FromObject(model, new VssJsonMediaTypeFormatter().CreateJsonSerializer());
509              AddModelAsQueryParams(queryParams, parameterName, jObject);
510          }
511          protected virtual void AddIEnumerableAsQueryParams(IList&lt;KeyValuePair&lt;String, String&gt;&gt; queryParams, string parameterName, object model)
512          {
513              JArray jArray = JArray.FromObject(model, new VssJsonMediaTypeFormatter().CreateJsonSerializer());
514              AddModelAsQueryParams(queryParams, parameterName, jArray);
515          }
516          private void AddModelAsQueryParams(IList&lt;KeyValuePair&lt;String, String&gt;&gt; queryParams, string parameterName, JObject jObject)
517          {
518              foreach (JProperty property in jObject.Properties())
519              {
520                  AddModelAsQueryParams(queryParams, parameterName, property);
521              }
522          }
523          private void AddModelAsQueryParams(IList&lt;KeyValuePair&lt;String, String&gt;&gt; queryParams, string key, JProperty property)
524          {
525              if (property.Value != null)
526              {
527                  string newKey = string.Format(&quot;{0}[{1}]&quot;, key, property.Name);
528                  AddModelAsQueryParams(queryParams, newKey, property.Value);
529              }
530          }
531          private void AddModelAsQueryParams(IList&lt;KeyValuePair&lt;String, String&gt;&gt; queryParams, string key, JArray array)
532          {
533              int i = 0;
534              foreach (JToken childToken in array.Children())
535              {
536                  string newKey = string.Format(&quot;{0}[{1}]&quot;, key, i);
537                  AddModelAsQueryParams(queryParams, newKey, childToken);
538                  i++;
539              }
540          }
541          private void AddModelAsQueryParams(IList&lt;KeyValuePair&lt;String, String&gt;&gt; queryParams, string key, JToken token)
542          {
543              if (token.Type == JTokenType.Array)
544              {
545                  AddModelAsQueryParams(queryParams, key, (JArray)token);
546              }
547              else if (token.Type == JTokenType.Object)
548              {
549                  AddModelAsQueryParams(queryParams, key, (JObject)token);
550              }
551              else if (token.Type == JTokenType.Property)
552              {
553                  AddModelAsQueryParams(queryParams, key, (JProperty)token);
554              }
555              else if (token.Type == JTokenType.Date)
556              {
557                  AddDateTimeToQueryParams(queryParams, key, (DateTime)token);
558              }
559              else
560              {
561                  queryParams.Add(key, token.ToString());
562              }
563          }
564          protected void AddDateTimeToQueryParams(IList&lt;KeyValuePair&lt;String, String&gt;&gt; queryParams, String name, DateTime localDateTime)
565          {
566              queryParams.Add(name, localDateTime.ToUniversalTime().ToString(&quot;o&quot;, CultureInfo.InvariantCulture));
567          }
568          protected void AddDateTimeToQueryParams(IList&lt;KeyValuePair&lt;String, String&gt;&gt; queryParams, String name, DateTimeOffset dateTimeOffset)
569          {
570              queryParams.Add(name, dateTimeOffset.ToString(&quot;o&quot;, CultureInfo.InvariantCulture));
571          }
572          protected void AddDateTimeToHeaders(IList&lt;KeyValuePair&lt;String, String&gt;&gt; queryParams, String name, DateTimeOffset dateTimeOffset)
573          {
574              queryParams.Add(name, dateTimeOffset.ToString(&quot;r&quot;, CultureInfo.InvariantCulture));
575          }
576          protected async Task&lt;T&gt; SendAsync&lt;T&gt;(
577              HttpRequestMessage message,
578              Object userState = null,
579              CancellationToken cancellationToken = default(CancellationToken))
580          {
581              using (HttpResponseMessage response = await this.SendAsync(message, userState, cancellationToken).ConfigureAwait(false))
582              {
583                  return await ReadContentAsAsync&lt;T&gt;(response, cancellationToken).ConfigureAwait(false);
584              }
585          }
586          protected async Task&lt;T&gt; ReadContentAsAsync&lt;T&gt;(HttpResponseMessage response, CancellationToken cancellationToken = default(CancellationToken))
587          {
588              CheckForDisposed();
589              Boolean isJson = IsJsonResponse(response);
590              bool mismatchContentType = false;
591              try
592              {
593                  if (isJson &amp;&amp;
594                      typeof(IEnumerable).GetTypeInfo().IsAssignableFrom(typeof(T).GetTypeInfo()) &amp;&amp;
595                      !typeof(Byte[]).GetTypeInfo().IsAssignableFrom(typeof(T).GetTypeInfo()) &amp;&amp;
596                      !typeof(JObject).GetTypeInfo().IsAssignableFrom(typeof(T).GetTypeInfo()))
597                  {
598                      var wrapper = await ReadJsonContentAsync&lt;VssJsonCollectionWrapper&lt;T&gt;&gt;(response, cancellationToken).ConfigureAwait(false);
599                      return wrapper.Value;
600                  }
601                  else if (isJson)
602                  {
603                      return await ReadJsonContentAsync&lt;T&gt;(response, cancellationToken).ConfigureAwait(false);
604                  }
605              }
606              catch (JsonReaderException)
607              {
608                  mismatchContentType = true;
609              }
610              if (HasContent(response))
611              {
612                  return await HandleInvalidContentType&lt;T&gt;(response, mismatchContentType).ConfigureAwait(false);
613              }
614              else
615              {
616                  return default(T);
617              }
618          }
619          protected virtual async Task&lt;T&gt; ReadJsonContentAsync&lt;T&gt;(HttpResponseMessage response, CancellationToken cancellationToken = default(CancellationToken))
620          {
621              return await response.Content.ReadAsAsync&lt;T&gt;(new[] { m_formatter }, cancellationToken).ConfigureAwait(false);
622          }
623          protected Task&lt;HttpResponseMessage&gt; SendAsync(
624              HttpRequestMessage message,
625              Object userState = null,
626              CancellationToken cancellationToken = default(CancellationToken))
627          {
628              return this.SendAsync(
629                  message,
630                   HttpCompletionOption.ResponseContentRead,
631                  userState,
632                  cancellationToken);
633          }
634          protected async Task&lt;HttpResponseMessage&gt; SendAsync(
635              HttpRequestMessage message,
636              HttpCompletionOption completionOption,
637              Object userState = null,
638              CancellationToken cancellationToken = default(CancellationToken))
639          {
640              CheckForDisposed();
641              if (message.Headers.UserAgent != null)
642              {
643                  foreach (ProductInfoHeaderValue headerValue in UserAgentUtility.GetDefaultRestUserAgent())
644                  {
645                      if (!message.Headers.UserAgent.Contains(headerValue))
646                      {
647                          message.Headers.UserAgent.Add(headerValue);
648                      }
649                  }
650              }
651              VssTraceActivity traceActivity = VssTraceActivity.GetOrCreate();
652              using (traceActivity.EnterCorrelationScope())
653              {
654                  if (userState != null)
655                  {
656                      message.Options.Set(new HttpRequestOptionsKey&lt;object&gt;(UserStatePropertyName), userState);
657                  }
658                  if (!message.Headers.Contains(Common.Internal.HttpHeaders.VssE2EID))
659                  {
660                      message.Headers.Add(Common.Internal.HttpHeaders.VssE2EID, Guid.NewGuid().ToString(&quot;D&quot;));
661                  }
662                  VssHttpEventSource.Log.HttpRequestStart(traceActivity, message);
663                  message.Trace();
664                  message.Options.Set(new HttpRequestOptionsKey&lt;VssTraceActivity&gt;(VssTraceActivity.PropertyName), traceActivity);
665                  message.Options.Set(new HttpRequestOptionsKey&lt;HttpCompletionOption&gt;(VssHttpRequestSettings.HttpCompletionOptionPropertyName), completionOption);
666                  HttpResponseMessage response = await Client.SendAsync(message, completionOption, cancellationToken).ConfigureAwait(false);
667                  if (TestDelay != TimeSpan.Zero)
668                  {
669                      await ProcessDelayAsync().ConfigureAwait(false);
670                  }
671                  await HandleResponseAsync(response, cancellationToken).ConfigureAwait(false);
672                  return response;
673              }
674          }
675          [Obsolete(&quot;Use VssHttpClientBase.HandleResponseAsync instead&quot;)]
676          protected virtual void HandleResponse(HttpResponseMessage response)
677          {
678          }
679          protected virtual async Task HandleResponseAsync(
680              HttpResponseMessage response,
681              CancellationToken cancellationToken)
682          {
683              response.Trace();
684              VssHttpEventSource.Log.HttpRequestStop(VssTraceActivity.Current, response);
685              m_LastResponseContext = new VssResponseContext(response.StatusCode, response.Headers);
686              if (response.StatusCode == HttpStatusCode.ProxyAuthenticationRequired)
687              {
688                  throw (m_LastResponseContext.Exception = new ProxyAuthenticationRequiredException());
689              }
690              else if (ShouldThrowError(response))
691              {
692                  Exception exToThrow = null;
693                  if (IsJsonResponse(response))
694                  {
695                      exToThrow = await UnwrapExceptionAsync(response.Content, cancellationToken).ConfigureAwait(false);
696                  }
697                  if (exToThrow == null || !(exToThrow is VssException))
698                  {
699                      String message = null;
700                      if (exToThrow != null)
701                      {
702                          message = exToThrow.Message;
703                      }
704                      IEnumerable&lt;String&gt; serviceError;
705                      if (response.Headers.TryGetValues(Common.Internal.HttpHeaders.TfsServiceError, out serviceError))
706                      {
707                          message = UriUtility.UrlDecode(serviceError.FirstOrDefault());
708                      }
709                      else if (String.IsNullOrEmpty(message) &amp;&amp; !String.IsNullOrEmpty(response.ReasonPhrase))
710                      {
711                          message = response.ReasonPhrase;
712                      }
713                      exToThrow = new VssServiceResponseException(response.StatusCode, message, exToThrow);
714                  }
715                  m_LastResponseContext.Exception = exToThrow;
716                  throw exToThrow;
717              }
718          }
719          protected async Task&lt;Exception&gt; UnwrapExceptionAsync(HttpContent content, CancellationToken cancellationToken)
720          {
721              WrappedException wrappedException = await content.ReadAsAsync&lt;WrappedException&gt;(new MediaTypeFormatter[] { m_formatter }, cancellationToken).ConfigureAwait(false);
722              return wrappedException.Unwrap(this.TranslatedExceptions);
723          }
724          protected virtual bool ShouldThrowError(HttpResponseMessage response)
725          {
726              return !response.IsSuccessStatusCode;
727          }
728          protected async Task&lt;ApiResourceVersion&gt; NegotiateRequestVersionAsync(
729              Guid locationId,
730              ApiResourceVersion version = null,
731              Object userState = null,
732              CancellationToken cancellationToken = default(CancellationToken))
733          {
734              ApiResourceLocation location = await GetResourceLocationAsync(locationId, userState, cancellationToken).ConfigureAwait(false);
735              if (location == null)
736              {
737                  return null;
738              }
739              else
740              {
741                  return NegotiateRequestVersion(location, version);
742              }
743          }
744          protected ApiResourceVersion NegotiateRequestVersion(
745              ApiResourceLocation location,
746              ApiResourceVersion version = null)
747          {
748              if (version == null)
749              {
750                  version = m_defaultApiVersion;
751              }
752              if (location.MinVersion &gt; version.ApiVersion)
753              {
754                  return null;
755              }
756              else if (location.MaxVersion &lt; version.ApiVersion)
757              {
758                  ApiResourceVersion negotiatedVersion = new ApiResourceVersion(location.MaxVersion, 0);
759                  negotiatedVersion.IsPreview = location.ReleasedVersion &lt; location.MaxVersion;
760                  return negotiatedVersion;
761              }
762              else
763              {
764                  int resourceVersion = Math.Min(version.ResourceVersion, location.ResourceVersion);
765                  ApiResourceVersion negotiatedVersion = new ApiResourceVersion(version.ApiVersion, resourceVersion);
766                  if (location.ReleasedVersion &lt; version.ApiVersion)
767                  {
768                      negotiatedVersion.IsPreview = true;
769                  }
770                  else
771                  {
772                      negotiatedVersion.IsPreview = version.IsPreview;
773                  }
774                  return negotiatedVersion;
775              }
776          }
777          public void SetResourceLocations(ApiResourceLocationCollection resourceLocations)
778          {
779              if (null == m_resourceLocations)
780              {
781                  m_resourceLocations = resourceLocations;
782              }
783          }
784          public bool ExcludeUrlsHeader
785          {
786              get
787              {
788                  return m_excludeUrlsHeader;
789              }
790              set
791              {
792                  m_excludeUrlsHeader = value;
793              }
794          }
795          public bool LightweightHeader
796          {
797              get
798              {
799                  return m_lightweightHeader;
800              }
801              set
802              {
803                  m_lightweightHeader = value;
804              }
805          }
806          protected async Task&lt;ApiResourceLocation&gt; GetResourceLocationAsync(
807              Guid locationId,
808              Object userState = null,
809              CancellationToken cancellationToken = default(CancellationToken))
810          {
811              CheckForDisposed();
812              await EnsureResourceLocationsPopulated(userState, cancellationToken).ConfigureAwait(false);
813              return m_resourceLocations.TryGetLocationById(locationId);
814          }
815          internal virtual async Task&lt;IEnumerable&lt;ApiResourceLocation&gt;&gt; GetResourceLocationsAsync(
816                              Boolean allHostTypes,
817                              Object userState = null,
818                              CancellationToken cancellationToken = default(CancellationToken))
819          {
820              CheckForDisposed();
821              Uri optionsUri = VssHttpUriUtility.ConcatUri(BaseAddress, allHostTypes ? c_optionsRelativePathWithAllHostTypes : c_optionsRelativePath);
822              using (HttpRequestMessage optionsRequest = new HttpRequestMessage(HttpMethod.Options, optionsUri))
823              {
824                  return await SendAsync&lt;IEnumerable&lt;ApiResourceLocation&gt;&gt;(optionsRequest, userState, cancellationToken: cancellationToken).ConfigureAwait(false);
825              }
826          }
827          internal async Task EnsureResourceLocationsPopulated(
828              Object userState = null,
829              CancellationToken cancellationToken = default(CancellationToken))
830          {
831              if (m_resourceLocations == null)
832              {
833                  Uri optionsUri = VssHttpUriUtility.ConcatUri(BaseAddress, c_optionsRelativePath);
834                  IEnumerable&lt;ApiResourceLocation&gt; locations = await GetResourceLocationsAsync(allHostTypes: false, userState: userState, cancellationToken: cancellationToken).ConfigureAwait(false);
835                  ApiResourceLocationCollection resourceLocations = new ApiResourceLocationCollection();
836                  resourceLocations.AddResourceLocations(locations);
837                  m_resourceLocations = resourceLocations;
838              }
839          }
840          private Boolean HasContent(HttpResponseMessage response)
841          {
842              if (response != null &amp;&amp;
843                  response.StatusCode != HttpStatusCode.NoContent &amp;&amp;
844                  response.RequestMessage?.Method != HttpMethod.Head &amp;&amp;
845                  response.Content?.Headers != null &amp;&amp;
846                  (!response.Content.Headers.ContentLength.HasValue ||
847                   (response.Content.Headers.ContentLength.HasValue &amp;&amp; response.Content.Headers.ContentLength != 0)))
848              {
849                  return true;
850              }
851              return false;
852          }
853          private Boolean IsJsonResponse(
854              HttpResponseMessage response)
855          {
856              if (HasContent(response)
857                  &amp;&amp; response.Content.Headers != null &amp;&amp; response.Content.Headers.ContentType != null
858                  &amp;&amp; !String.IsNullOrEmpty(response.Content.Headers.ContentType.MediaType))
859              {
860                  return (0 == String.Compare(&quot;application/json&quot;, response.Content.Headers.ContentType.MediaType, StringComparison.OrdinalIgnoreCase));
861              }
862              return false;
863          }
864          private async Task&lt;T&gt; HandleInvalidContentType&lt;T&gt;(HttpResponseMessage response, bool isMismatchedContentType)
865          {
866              String responseType = response.Content?.Headers?.ContentType?.MediaType ?? &quot;Unknown&quot;;
867              using (var responseStream = await response.Content.ReadAsStreamAsync().ConfigureAwait(false))
868              {
869                  using (var streamReader = new StreamReader(responseStream))
870                  {
871                      const int oneK = 1024;
872                      char[] contentBuffer = new char[4 * oneK];
873                      int contentLength = 0;
874                      for (int i = 0; i &lt; 4; i++)
875                      {
876                          int read = await streamReader.ReadAsync(contentBuffer, i * oneK, oneK).ConfigureAwait(false);
877                          contentLength += read;
878                          if (read &lt; oneK) break;
879                      }
880                      string responseText;
881                      if (isMismatchedContentType)
882                      {
883                          responseText = $&quot;Mismatched response content type. {responseType} Response Content: {new String(contentBuffer, 0, contentLength)}&quot;;
884                      }
885                      else
886                      {
887                          responseText = $&quot;Invalid response content type: {responseType} Response Content: {new String(contentBuffer, 0, contentLength)}&quot;;
888                      }
889                      throw new VssServiceResponseException(response.StatusCode, responseText, null);
890                  }
891              }
892          }
893          private void SetServicePointOptions()
894          {
895              if (BaseAddress != null)
896              {
897  #pragma warning disable SYSLIB0014
898                  ServicePoint servicePoint = ServicePointManager.FindServicePoint(BaseAddress);
899                  servicePoint.UseNagleAlgorithm = false;
900                  servicePoint.SetTcpKeepAlive(
901                      enabled: true,
902                      keepAliveTime: c_keepAliveTime,
903                      keepAliveInterval: c_keepAliveInterval);
904  #pragma warning restore SYSLIB0014
905              }
906          }
907          private const int c_keepAliveTime = 30000;
908          private const int c_keepAliveInterval = 5000;
909          #region IDisposable Support
910          private bool m_isDisposed = false;
911          private object m_disposeLock = new object();
912          [Obsolete(&quot;This overload of Dispose has been deprecated.  Use the Dispose() method.&quot;)]
913          [EditorBrowsable(EditorBrowsableState.Never)]
914          protected virtual void Dispose(bool disposing)
915          {
916              if (disposing)
917              {
918                  Dispose();
919              }
920          }
921          public void Dispose()
922          {
923              if (!m_isDisposed)
924              {
925                  lock (m_disposeLock)
926                  {
927                      if (!m_isDisposed)
928                      {
929                          m_isDisposed = true;
930                          m_client.Dispose();
931                      }
932                  }
933              }
934          }
935          private void CheckForDisposed()
936          {
937              if (m_isDisposed)
938              {
939                  throw new ObjectDisposedException(this.GetType().Name);
940              }
941          }
942          #endregion
943          protected IEnumerable&lt;String&gt; GetHeaderValue(HttpResponseMessage response, string headerName)
944          {
945              IEnumerable&lt;string&gt; headerValue;
946              if (!response.Headers.TryGetValues(headerName, out headerValue))
947              {
948                  if (response.Content != null)
949                  {
950                      response.Content.Headers.TryGetValues(headerName, out headerValue);
951                  }
952              }
953              return headerValue;
954          }
955          [EditorBrowsable(EditorBrowsableState.Never)]
956          public static TimeSpan TestDelay { get; set; }
957          private async Task ProcessDelayAsync()
958          {
959              await Task.Delay(Math.Abs((Int32)TestDelay.TotalMilliseconds)).ConfigureAwait(false);
960              if (TestDelay &lt; TimeSpan.Zero)
961              {
962                  throw new Exception(&quot;User injected failure.&quot;);
963              }
964          }
965          internal bool HasResourceLocations
966          {
967              get
968              {
969                  return m_resourceLocations != null;
970              }
971          }
972          private readonly HttpClient m_client;
973          private MediaTypeFormatter m_formatter;
974          private VssResponseContext m_LastResponseContext;
975          private ApiResourceLocationCollection m_resourceLocations;
976          private ApiResourceVersion m_defaultApiVersion = new ApiResourceVersion(1.0);
977          private bool m_excludeUrlsHeader;
978          private bool m_lightweightHeader;
979          private Lazy&lt;HttpMethod&gt; s_patchMethod = new Lazy&lt;HttpMethod&gt;(() =&gt; new HttpMethod(&quot;PATCH&quot;));
980          private const String c_optionsRelativePath = &quot;_apis/&quot;;
981          private const String c_optionsRelativePathWithAllHostTypes = &quot;_apis/?allHostTypes=true&quot;;
982          private const String c_jsonMediaType = &quot;application/json&quot;;
983          public readonly static String UserStatePropertyName = &quot;VssClientBaseUserState&quot;;
984          protected sealed class OperationScope : IDisposable
985          {
986              public OperationScope(
987                  String area,
988                  String operation)
989              {
990                  m_area = area;
991                  m_operation = operation;
992                  m_activity = VssTraceActivity.GetOrCreate();
993                  m_correlationScope = m_activity.EnterCorrelationScope();
994                  VssHttpEventSource.Log.HttpOperationStart(m_activity, m_area, operation);
995              }
996              public void Dispose()
997              {
998                  if (!m_disposed)
999                  {
1000                      m_disposed = true;
1001                      VssHttpEventSource.Log.HttpOperationStop(m_activity, m_area, m_operation);
1002                      if (m_correlationScope != null)
1003                      {
1004                          m_correlationScope.Dispose();
1005                          m_correlationScope = null;
1006                      }
1007                  }
1008              }
1009              private String m_area;
1010              private String m_operation;
1011              private Boolean m_disposed;
1012              private VssTraceActivity m_activity;
1013              private IDisposable m_correlationScope;
1014          }
1015      }
1016  }
</code></pre>
        </div>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-RemoteAuthenticationContext.cs</h3>
            <pre><code>1  using System;
2  using System.Security.Claims;
3  using Microsoft.AspNetCore.Http;
4  namespace Microsoft.AspNetCore.Authentication
5  {
6      public abstract class RemoteAuthenticationContext&lt;TOptions&gt; : HandleRequestContext&lt;TOptions&gt; where TOptions : AuthenticationSchemeOptions
7      {
<span onclick='openModal()' class='match'>8          protected RemoteAuthenticationContext(
9              HttpContext context,
10              AuthenticationScheme scheme,
11              TOptions options,
12              AuthenticationProperties properties)
</span>13              : base(context, scheme, options)
14              =&gt; Properties = properties ?? new AuthenticationProperties();
15          public ClaimsPrincipal Principal { get; set; }
16          public virtual AuthenticationProperties Properties { get; set; }
17          public void Success() =&gt; Result = HandleRequestResult.Success(new AuthenticationTicket(Principal, Properties, Scheme.Name));
18          public void Fail(Exception failure) =&gt; Result = HandleRequestResult.Fail(failure);
19          public void Fail(string failureMessage) =&gt; Result = HandleRequestResult.Fail(failureMessage);
20      }
21  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-VssHttpClientBase.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-RemoteAuthenticationContext.cs</div>
                </div>
                <div class="column column_space"><pre><code>45          protected VssHttpClientBase(
46              Uri baseUrl,
47              VssCredentials credentials,
48              VssHttpRequestSettings settings,
49              params DelegatingHandler[] handlers)
</pre></code></div>
                <div class="column column_space"><pre><code>8          protected RemoteAuthenticationContext(
9              HttpContext context,
10              AuthenticationScheme scheme,
11              TOptions options,
12              AuthenticationProperties properties)
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    