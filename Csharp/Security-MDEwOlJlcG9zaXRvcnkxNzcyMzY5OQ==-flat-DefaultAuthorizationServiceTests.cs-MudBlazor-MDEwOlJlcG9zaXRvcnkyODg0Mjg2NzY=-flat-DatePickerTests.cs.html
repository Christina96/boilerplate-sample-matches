
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 13.273942093541201%, Tokens: 11, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-DefaultAuthorizationServiceTests.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Linq;
4  using System.Security.Claims;
5  using System.Threading.Tasks;
6  using Microsoft.AspNetCore.Authorization.Infrastructure;
7  using Microsoft.Extensions.DependencyInjection;
8  using Microsoft.Extensions.Options;
9  using Xunit;
10  namespace Microsoft.AspNetCore.Authorization.Test
11  {
12      public class DefaultAuthorizationServiceTests
13      {
14          private IAuthorizationService BuildAuthorizationService(Action<IServiceCollection> setupServices = null)
15          {
16              var services = new ServiceCollection();
17              services.AddAuthorization();
18              services.AddLogging();
19              services.AddOptions();
20              setupServices?.Invoke(services);
21              return services.BuildServiceProvider().GetRequiredService<IAuthorizationService>();
22          }
23          [Fact]
24          public async Task AuthorizeCombineThrowsOnUnknownPolicy()
25          {
26              var provider = new DefaultAuthorizationPolicyProvider(Options.Create(new AuthorizationOptions()));
27              await Assert.ThrowsAsync<InvalidOperationException>(() => AuthorizationPolicy.CombineAsync(provider, new AuthorizeAttribute[] {
28                  new AuthorizeAttribute { Policy = "Wut" }
29              }));
30          }
31          [Fact]
32          public async Task Authorize_ShouldAllowIfClaimIsPresent()
33          {
34              var authorizationService = BuildAuthorizationService(services =>
35              {
36                  services.AddAuthorization(options =>
37                  {
38                      options.AddPolicy("Basic", policy => policy.RequireClaim("Permission", "CanViewPage"));
39                  });
40              });
41              var user = new ClaimsPrincipal(new ClaimsIdentity(new Claim[] { new Claim("Permission", "CanViewPage") }));
<span onclick='openModal()' class='match'>42              var allowed = await authorizationService.AuthorizeAsync(user, "Basic");
43              Assert.True(allowed.Succeeded);
44          }
45          [Fact]
46          public async Task Authorize_ShouldAllowIfClaimIsPresentWithSpecifiedAuthType()
47          {
48              var authorizationService = BuildAuthorizationService(services =>
49              {
50                  services.AddAuthorization(options =>
51                  {
52                      options.AddPolicy("Basic", policy => {
53                          policy.AddAuthenticationSchemes("Basic");
54                          policy.RequireClaim("Permission", "CanViewPage");
</span>55                      });
56                  });
57              });
58              var user = new ClaimsPrincipal(new ClaimsIdentity(new Claim[] { new Claim("Permission", "CanViewPage") }, "Basic"));
59              var allowed = await authorizationService.AuthorizeAsync(user, "Basic");
60              Assert.True(allowed.Succeeded);
61          }
62          [Fact]
63          public async Task Authorize_ShouldAllowIfClaimIsAmongValues()
64          {
65              var authorizationService = BuildAuthorizationService(services =>
66              {
67                  services.AddAuthorization(options =>
68                  {
69                      options.AddPolicy("Basic", policy => policy.RequireClaim("Permission", "CanViewPage", "CanViewAnything"));
70                  });
71              });
72              var user = new ClaimsPrincipal(
73                  new ClaimsIdentity(
74                      new Claim[] {
75                          new Claim("Permission", "CanViewPage"),
76                          new Claim("Permission", "CanViewAnything")
77                      },
78                      "Basic")
79                  );
80              var allowed = await authorizationService.AuthorizeAsync(user, "Basic");
81              Assert.True(allowed.Succeeded);
82          }
83          [Fact]
84          public async Task Authorize_ShouldInvokeAllHandlersByDefault()
85          {
86              var handler1 = new FailHandler();
87              var handler2 = new FailHandler();
88              var authorizationService = BuildAuthorizationService(services =>
89              {
90                  services.AddSingleton<IAuthorizationHandler>(handler1);
91                  services.AddSingleton<IAuthorizationHandler>(handler2);
92                  services.AddAuthorization(options =>
93                  {
94                      options.AddPolicy("Custom", policy => policy.Requirements.Add(new CustomRequirement()));
95                  });
96              });
97              var allowed = await authorizationService.AuthorizeAsync(new ClaimsPrincipal(), "Custom");
98              Assert.False(allowed.Succeeded);
99              Assert.True(allowed.Failure.FailCalled);
100              Assert.True(handler1.Invoked);
101              Assert.True(handler2.Invoked);
102          }
103          [Theory]
104          [InlineData(true)]
105          [InlineData(false)]
106          public async Task Authorize_ShouldInvokeAllHandlersDependingOnSetting(bool invokeAllHandlers)
107          {
108              var handler1 = new FailHandler();
109              var handler2 = new FailHandler();
110              var authorizationService = BuildAuthorizationService(services =>
111              {
112                  services.AddSingleton<IAuthorizationHandler>(handler1);
113                  services.AddSingleton<IAuthorizationHandler>(handler2);
114                  services.AddAuthorization(options =>
115                  {
116                      options.InvokeHandlersAfterFailure = invokeAllHandlers;
117                      options.AddPolicy("Custom", policy => policy.Requirements.Add(new CustomRequirement()));
118                  });
119              });
120              var allowed = await authorizationService.AuthorizeAsync(new ClaimsPrincipal(), "Custom");
121              Assert.False(allowed.Succeeded);
122              Assert.True(handler1.Invoked);
123              Assert.Equal(invokeAllHandlers, handler2.Invoked);
124          }
125          private class FailHandler : IAuthorizationHandler
126          {
127              public bool Invoked { get; set; }
128              public Task HandleAsync(AuthorizationHandlerContext context)
129              {
130                  Invoked = true;
131                  context.Fail();
132                  return Task.FromResult(0);
133              }
134          }
135          [Fact]
136          public async Task Authorize_ShouldFailWhenAllRequirementsNotHandled()
137          {
138              var authorizationService = BuildAuthorizationService(services =>
139              {
140                  services.AddAuthorization(options =>
141                  {
142                      options.AddPolicy("Basic", policy => policy.RequireClaim("Permission", "CanViewPage", "CanViewAnything"));
143                  });
144              });
145              var user = new ClaimsPrincipal(
146                  new ClaimsIdentity(
147                      new Claim[] {
148                          new Claim("SomethingElse", "CanViewPage"),
149                      },
150                      "Basic")
151                  );
152              var allowed = await authorizationService.AuthorizeAsync(user, "Basic");
153              Assert.False(allowed.Succeeded);
154              Assert.IsType<ClaimsAuthorizationRequirement>(allowed.Failure.FailedRequirements.First());
155          }
156          [Fact]
157          public async Task Authorize_ShouldNotAllowIfClaimTypeIsNotPresent()
158          {
159              var authorizationService = BuildAuthorizationService(services =>
160              {
161                  services.AddAuthorization(options =>
162                  {
163                      options.AddPolicy("Basic", policy => policy.RequireClaim("Permission", "CanViewPage", "CanViewAnything"));
164                  });
165              });
166              var user = new ClaimsPrincipal(
167                  new ClaimsIdentity(
168                      new Claim[] {
169                          new Claim("SomethingElse", "CanViewPage"),
170                      },
171                      "Basic")
172                  );
173              var allowed = await authorizationService.AuthorizeAsync(user, "Basic");
174              Assert.False(allowed.Succeeded);
175          }
176          [Fact]
177          public async Task Authorize_ShouldNotAllowIfClaimValueIsNotPresent()
178          {
179              var authorizationService = BuildAuthorizationService(services =>
180              {
181                  services.AddAuthorization(options =>
182                  {
183                      options.AddPolicy("Basic", policy => policy.RequireClaim("Permission", "CanViewPage"));
184                  });
185              });
186              var user = new ClaimsPrincipal(
187                  new ClaimsIdentity(
188                      new Claim[] {
189                          new Claim("Permission", "CanViewComment"),
190                      },
191                      "Basic")
192                  );
193              var allowed = await authorizationService.AuthorizeAsync(user, "Basic");
194              Assert.False(allowed.Succeeded);
195          }
196          [Fact]
197          public async Task Authorize_ShouldNotAllowIfNoClaims()
198          {
199              var authorizationService = BuildAuthorizationService(services =>
200              {
201                  services.AddAuthorization(options =>
202                  {
203                      options.AddPolicy("Basic", policy => policy.RequireClaim("Permission", "CanViewPage"));
204                  });
205              });
206              var user = new ClaimsPrincipal(
207                  new ClaimsIdentity(
208                      new Claim[0],
209                      "Basic")
210                  );
211              var allowed = await authorizationService.AuthorizeAsync(user, "Basic");
212              Assert.False(allowed.Succeeded);
213          }
214          [Fact]
215          public async Task Authorize_ShouldNotAllowIfUserIsNull()
216          {
217              var authorizationService = BuildAuthorizationService(services =>
218              {
219                  services.AddAuthorization(options =>
220                  {
221                      options.AddPolicy("Basic", policy => policy.RequireClaim("Permission", "CanViewPage"));
222                  });
223              });
224              var allowed = await authorizationService.AuthorizeAsync(null, null, "Basic");
225              Assert.False(allowed.Succeeded);
226          }
227          [Fact]
228          public async Task Authorize_ShouldNotAllowIfNotCorrectAuthType()
229          {
230              var authorizationService = BuildAuthorizationService(services =>
231              {
232                  services.AddAuthorization(options =>
233                  {
234                      options.AddPolicy("Basic", policy => policy.RequireClaim("Permission", "CanViewPage"));
235                  });
236              });
237              var user = new ClaimsPrincipal(new ClaimsIdentity());
238              var allowed = await authorizationService.AuthorizeAsync(user, "Basic");
239              Assert.False(allowed.Succeeded);
240          }
241          [Fact]
242          public async Task Authorize_ShouldAllowWithNoAuthType()
243          {
244              var authorizationService = BuildAuthorizationService(services =>
245              {
246                  services.AddAuthorization(options =>
247                  {
248                      options.AddPolicy("Basic", policy => policy.RequireClaim("Permission", "CanViewPage"));
249                  });
250              });
251              var user = new ClaimsPrincipal(
252                  new ClaimsIdentity(
253                      new Claim[] {
254                          new Claim("Permission", "CanViewPage"),
255                      },
256                      "Basic")
257                  );
258              var allowed = await authorizationService.AuthorizeAsync(user, "Basic");
259              Assert.True(allowed.Succeeded);
260          }
261          [Fact]
262          public async Task Authorize_ThrowsWithUnknownPolicy()
263          {
264              var authorizationService = BuildAuthorizationService();
265              var exception = await Assert.ThrowsAsync<InvalidOperationException>(() => authorizationService.AuthorizeAsync(new ClaimsPrincipal(), "whatever", "BogusPolicy"));
266              Assert.Equal("No policy found: BogusPolicy.", exception.Message);
267          }
268          [Fact]
269          public async Task Authorize_CustomRolePolicy()
270          {
271              var policy = new AuthorizationPolicyBuilder().RequireRole("Administrator")
272                  .RequireClaim(ClaimTypes.Role, "User");
273              var authorizationService = BuildAuthorizationService();
274              var user = new ClaimsPrincipal(
275                  new ClaimsIdentity(
276                      new Claim[] {
277                          new Claim(ClaimTypes.Role, "User"),
278                          new Claim(ClaimTypes.Role, "Administrator")
279                      },
280                      "Basic")
281                  );
282              var allowed = await authorizationService.AuthorizeAsync(user, policy.Build());
283              Assert.True(allowed.Succeeded);
284          }
285          [Fact]
286          public async Task Authorize_HasAnyClaimOfTypePolicy()
287          {
288              var policy = new AuthorizationPolicyBuilder().RequireClaim(ClaimTypes.Role);
289              var authorizationService = BuildAuthorizationService();
290              var user = new ClaimsPrincipal(
291                  new ClaimsIdentity(
292                      new Claim[] {
293                          new Claim(ClaimTypes.Role, "none"),
294                      },
295                      "Basic")
296                  );
297              var allowed = await authorizationService.AuthorizeAsync(user, policy.Build());
298              Assert.True(allowed.Succeeded);
299          }
300          [Fact]
301          public async Task Authorize_PolicyCanAuthenticationSchemeWithNameClaim()
302          {
303              var policy = new AuthorizationPolicyBuilder("AuthType").RequireClaim(ClaimTypes.Name);
304              var authorizationService = BuildAuthorizationService();
305              var user = new ClaimsPrincipal(
306                  new ClaimsIdentity(new Claim[] { new Claim(ClaimTypes.Name, "Name") }, "AuthType")
307                  );
308              var allowed = await authorizationService.AuthorizeAsync(user, policy.Build());
309              Assert.True(allowed.Succeeded);
310          }
311          [Fact]
312          public async Task RolePolicyCanRequireSingleRole()
313          {
314              var policy = new AuthorizationPolicyBuilder("AuthType").RequireRole("Admin");
315              var authorizationService = BuildAuthorizationService();
316              var user = new ClaimsPrincipal(
317                  new ClaimsIdentity(new Claim[] { new Claim(ClaimTypes.Role, "Admin") }, "AuthType")
318              );
319              var allowed = await authorizationService.AuthorizeAsync(user, null, policy.Build());
320              Assert.True(allowed.Succeeded);
321          }
322          [Fact]
323          public async Task RolePolicyCanRequireOneOfManyRoles()
324          {
325              var policy = new AuthorizationPolicyBuilder("AuthType").RequireRole("Admin", "Users");
326              var authorizationService = BuildAuthorizationService();
327              var user = new ClaimsPrincipal(
328                  new ClaimsIdentity(new Claim[] { new Claim(ClaimTypes.Role, "Users") }, "AuthType"));
329              var allowed = await authorizationService.AuthorizeAsync(user, policy.Build());
330              Assert.True(allowed.Succeeded);
331          }
332          [Fact]
333          public async Task RolePolicyCanBlockWrongRole()
334          {
335              var policy = new AuthorizationPolicyBuilder().RequireClaim("Permission", "CanViewPage");
336              var authorizationService = BuildAuthorizationService();
337              var user = new ClaimsPrincipal(
338                  new ClaimsIdentity(
339                      new Claim[] {
340                          new Claim(ClaimTypes.Role, "Nope"),
341                      },
342                      "AuthType")
343                  );
344              var allowed = await authorizationService.AuthorizeAsync(user, policy.Build());
345              Assert.False(allowed.Succeeded);
346          }
347          [Fact]
348          public async Task RolePolicyCanBlockNoRole()
349          {
350              var authorizationService = BuildAuthorizationService(services =>
351              {
352                  services.AddAuthorization(options =>
353                  {
354                      options.AddPolicy("Basic", policy => policy.RequireRole("Admin", "Users"));
355                  });
356              });
357              var user = new ClaimsPrincipal(
358                  new ClaimsIdentity(
359                      new Claim[] {
360                      },
361                      "AuthType")
362                  );
363              var allowed = await authorizationService.AuthorizeAsync(user, "Basic");
364              Assert.False(allowed.Succeeded);
365          }
366          [Fact]
367          public void PolicyThrowsWithNoRequirements()
368          {
369              Assert.Throws<InvalidOperationException>(() => BuildAuthorizationService(services =>
370              {
371                  services.AddAuthorization(options =>
372                  {
373                      options.AddPolicy("Basic", policy => { });
374                  });
375              }));
376          }
377          [Fact]
378          public async Task RequireUserNameFailsForWrongUserName()
379          {
380              var authorizationService = BuildAuthorizationService(services =>
381              {
382                  services.AddAuthorization(options =>
383                  {
384                      options.AddPolicy("Hao", policy => policy.RequireUserName("Hao"));
385                  });
386              });
387              var user = new ClaimsPrincipal(
388                  new ClaimsIdentity(
389                      new Claim[] {
390                          new Claim(ClaimTypes.Name, "Tek"),
391                      },
392                      "AuthType")
393                  );
394              var allowed = await authorizationService.AuthorizeAsync(user, "Hao");
395              Assert.False(allowed.Succeeded);
396          }
397          [Fact]
398          public async Task CanRequireUserName()
399          {
400              var authorizationService = BuildAuthorizationService(services =>
401              {
402                  services.AddAuthorization(options =>
403                  {
404                      options.AddPolicy("Hao", policy => policy.RequireUserName("Hao"));
405                  });
406              });
407              var user = new ClaimsPrincipal(
408                  new ClaimsIdentity(
409                      new Claim[] {
410                          new Claim(ClaimTypes.Name, "Hao"),
411                      },
412                      "AuthType")
413                  );
414              var allowed = await authorizationService.AuthorizeAsync(user, "Hao");
415              Assert.True(allowed.Succeeded);
416          }
417          [Fact]
418          public async Task CanRequireUserNameWithDiffClaimType()
419          {
420              var authorizationService = BuildAuthorizationService(services =>
421              {
422                  services.AddAuthorization(options =>
423                  {
424                      options.AddPolicy("Hao", policy => policy.RequireUserName("Hao"));
425                  });
426              });
427              var identity = new ClaimsIdentity("AuthType", "Name", "Role");
428              identity.AddClaim(new Claim("Name", "Hao"));
429              var user = new ClaimsPrincipal(identity);
430              var allowed = await authorizationService.AuthorizeAsync(user, "Hao");
431              Assert.True(allowed.Succeeded);
432          }
433          [Fact]
434          public async Task CanRequireRoleWithDiffClaimType()
435          {
436              var authorizationService = BuildAuthorizationService(services =>
437              {
438                  services.AddAuthorization(options =>
439                  {
440                      options.AddPolicy("Hao", policy => policy.RequireRole("Hao"));
441                  });
442              });
443              var identity = new ClaimsIdentity("AuthType", "Name", "Role");
444              identity.AddClaim(new Claim("Role", "Hao"));
445              var user = new ClaimsPrincipal(identity);
446              var allowed = await authorizationService.AuthorizeAsync(user, "Hao");
447              Assert.True(allowed.Succeeded);
448          }
449          [Fact]
450          public async Task CanApproveAnyAuthenticatedUser()
451          {
452              var authorizationService = BuildAuthorizationService(services =>
453              {
454                  services.AddAuthorization(options =>
455                  {
456                      options.AddPolicy("Any", policy => policy.RequireAuthenticatedUser());
457                  });
458              });
459              var user = new ClaimsPrincipal(new ClaimsIdentity());
460              user.AddIdentity(new ClaimsIdentity(
461                  new Claim[] {
462                      new Claim(ClaimTypes.Name, "Name"),
463                  },
464                  "AuthType"));
465              var allowed = await authorizationService.AuthorizeAsync(user, null, "Any");
466              Assert.True(allowed.Succeeded);
467          }
468          [Fact]
469          public async Task CanBlockNonAuthenticatedUser()
470          {
471              var authorizationService = BuildAuthorizationService(services =>
472              {
473                  services.AddAuthorization(options =>
474                  {
475                      options.AddPolicy("Any", policy => policy.RequireAuthenticatedUser());
476                  });
477              });
478              var user = new ClaimsPrincipal(new ClaimsIdentity());
479              var allowed = await authorizationService.AuthorizeAsync(user, null, "Any");
480              Assert.False(allowed.Succeeded);
481          }
482          public class CustomRequirement : IAuthorizationRequirement { }
483          public class CustomHandler : AuthorizationHandler<CustomRequirement>
484          {
485              public bool Invoked { get; set; }
486              protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, CustomRequirement requirement)
487              {
488                  Invoked = true;
489                  context.Succeed(requirement);
490                  return Task.FromResult(0);
491              }
492          }
493          [Fact]
494          public async Task CustomReqWithNoHandlerFails()
495          {
496              var authorizationService = BuildAuthorizationService(services =>
497              {
498                  services.AddAuthorization(options =>
499                  {
500                      options.AddPolicy("Custom", policy => policy.Requirements.Add(new CustomRequirement()));
501                  });
502              });
503              var user = new ClaimsPrincipal();
504              var allowed = await authorizationService.AuthorizeAsync(user, null, "Custom");
505              Assert.False(allowed.Succeeded);
506          }
507          [Fact]
508          public async Task CustomReqWithHandlerSucceeds()
509          {
510              var authorizationService = BuildAuthorizationService(services =>
511              {
512                  services.AddTransient<IAuthorizationHandler, CustomHandler>();
513                  services.AddAuthorization(options =>
514                  {
515                      options.AddPolicy("Custom", policy => policy.Requirements.Add(new CustomRequirement()));
516                  });
517              });
518              var user = new ClaimsPrincipal();
519              var allowed = await authorizationService.AuthorizeAsync(user, null, "Custom");
520              Assert.True(allowed.Succeeded);
521          }
522          public class PassThroughRequirement : AuthorizationHandler<PassThroughRequirement>, IAuthorizationRequirement
523          {
524              public PassThroughRequirement(bool succeed)
525              {
526                  Succeed = succeed;
527              }
528              public bool Succeed { get; set; }
529              protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, PassThroughRequirement requirement)
530              {
531                  if (Succeed) {
532                      context.Succeed(requirement);
533                  }
534                  return Task.FromResult(0);
535              }
536          }
537          [Theory]
538          [InlineData(true)]
539          [InlineData(false)]
540          public async Task PassThroughRequirementWillSucceedWithoutCustomHandler(bool shouldSucceed)
541          {
542              var authorizationService = BuildAuthorizationService(services =>
543              {
544                  services.AddAuthorization(options =>
545                  {
546                      options.AddPolicy("Passthrough", policy => policy.Requirements.Add(new PassThroughRequirement(shouldSucceed)));
547                  });
548              });
549              var user = new ClaimsPrincipal();
550              var allowed = await authorizationService.AuthorizeAsync(user, null, "Passthrough");
551              Assert.Equal(shouldSucceed, allowed.Succeeded);
552          }
553          [Fact]
554          public async Task CanCombinePolicies()
555          {
556              var authorizationService = BuildAuthorizationService(services =>
557              {
558                  services.AddAuthorization(options =>
559                  {
560                      var basePolicy = new AuthorizationPolicyBuilder().RequireClaim("Base", "Value").Build();
561                      options.AddPolicy("Combined", policy => policy.Combine(basePolicy).RequireClaim("Claim", "Exists"));
562                  });
563              });
564              var user = new ClaimsPrincipal(
565                  new ClaimsIdentity(
566                      new Claim[] {
567                          new Claim("Base", "Value"),
568                          new Claim("Claim", "Exists")
569                      },
570                      "AuthType")
571                  );
572              var allowed = await authorizationService.AuthorizeAsync(user, null, "Combined");
573              Assert.True(allowed.Succeeded);
574          }
575          [Fact]
576          public async Task CombinePoliciesWillFailIfBasePolicyFails()
577          {
578              var authorizationService = BuildAuthorizationService(services =>
579              {
580                  services.AddAuthorization(options =>
581                  {
582                      var basePolicy = new AuthorizationPolicyBuilder().RequireClaim("Base", "Value").Build();
583                      options.AddPolicy("Combined", policy => policy.Combine(basePolicy).RequireClaim("Claim", "Exists"));
584                  });
585              });
586              var user = new ClaimsPrincipal(
587                  new ClaimsIdentity(
588                      new Claim[] {
589                          new Claim("Claim", "Exists")
590                      },
591                      "AuthType")
592                  );
593              var allowed = await authorizationService.AuthorizeAsync(user, null, "Combined");
594              Assert.False(allowed.Succeeded);
595          }
596          [Fact]
597          public async Task CombinedPoliciesWillFailIfExtraRequirementFails()
598          {
599              var authorizationService = BuildAuthorizationService(services =>
600              {
601                  services.AddAuthorization(options =>
602                  {
603                      var basePolicy = new AuthorizationPolicyBuilder().RequireClaim("Base", "Value").Build();
604                      options.AddPolicy("Combined", policy => policy.Combine(basePolicy).RequireClaim("Claim", "Exists"));
605                  });
606              });
607              var user = new ClaimsPrincipal(
608                  new ClaimsIdentity(
609                      new Claim[] {
610                          new Claim("Base", "Value"),
611                      },
612                      "AuthType")
613                  );
614              var allowed = await authorizationService.AuthorizeAsync(user, null, "Combined");
615              Assert.False(allowed.Succeeded);
616          }
617          public class ExpenseReport { }
618          public static class Operations
619          {
620              public static OperationAuthorizationRequirement Edit = new OperationAuthorizationRequirement { Name = "Edit" };
621              public static OperationAuthorizationRequirement Create = new OperationAuthorizationRequirement { Name = "Create" };
622              public static OperationAuthorizationRequirement Delete = new OperationAuthorizationRequirement { Name = "Delete" };
623          }
624          public class ExpenseReportAuthorizationHandler : AuthorizationHandler<OperationAuthorizationRequirement, ExpenseReport>
625          {
626              public ExpenseReportAuthorizationHandler(IEnumerable<OperationAuthorizationRequirement> authorized)
627              {
628                  _allowed = authorized;
629              }
630              private IEnumerable<OperationAuthorizationRequirement> _allowed;
631              protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, OperationAuthorizationRequirement requirement, ExpenseReport resource)
632              {
633                  if (_allowed.Contains(requirement))
634                  {
635                      context.Succeed(requirement);
636                  }
637                  return Task.FromResult(0);
638              }
639          }
640          public class SuperUserHandler : AuthorizationHandler<OperationAuthorizationRequirement>
641          {
642              protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, OperationAuthorizationRequirement requirement)
643              {
644                  if (context.User.HasClaim("SuperUser", "yes"))
645                  {
646                      context.Succeed(requirement);
647                  }
648                  return Task.FromResult(0);
649              }
650          }
651          [Fact]
652          public async Task CanAuthorizeAllSuperuserOperations()
653          {
654              var authorizationService = BuildAuthorizationService(services =>
655              {
656                  services.AddSingleton<IAuthorizationHandler>(new ExpenseReportAuthorizationHandler(new OperationAuthorizationRequirement[] { Operations.Edit }));
657                  services.AddTransient<IAuthorizationHandler, SuperUserHandler>();
658              });
659              var user = new ClaimsPrincipal(
660                  new ClaimsIdentity(
661                      new Claim[] {
662                          new Claim("SuperUser", "yes"),
663                      },
664                      "AuthType")
665                  );
666              Assert.True((await authorizationService.AuthorizeAsync(user, null, Operations.Edit)).Succeeded);
667              Assert.True((await authorizationService.AuthorizeAsync(user, null, Operations.Delete)).Succeeded);
668              Assert.True((await authorizationService.AuthorizeAsync(user, null, Operations.Create)).Succeeded);
669          }
670          public class NotCalledHandler : AuthorizationHandler<OperationAuthorizationRequirement, string>
671          {
672              protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, OperationAuthorizationRequirement requirement, string resource)
673              {
674                  throw new NotImplementedException();
675              }
676          }
677          public class EvenHandler : AuthorizationHandler<OperationAuthorizationRequirement, int>
678          {
679              protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, OperationAuthorizationRequirement requirement, int id)
680              {
681                  if (id % 2 == 0)
682                  {
683                      context.Succeed(requirement);
684                  }
685                  return Task.FromResult(0);
686              }
687          }
688          [Fact]
689          public async Task CanUseValueTypeResource()
690          {
691              var authorizationService = BuildAuthorizationService(services =>
692              {
693                  services.AddTransient<IAuthorizationHandler, EvenHandler>();
694              });
695              var user = new ClaimsPrincipal(
696                  new ClaimsIdentity(
697                      new Claim[] {
698                      },
699                      "AuthType")
700                  );
701              Assert.False((await authorizationService.AuthorizeAsync(user, 1, Operations.Edit)).Succeeded);
702              Assert.True((await authorizationService.AuthorizeAsync(user, 2, Operations.Edit)).Succeeded);
703          }
704          [Fact]
705          public async Task DoesNotCallHandlerWithWrongResourceType()
706          {
707              var authorizationService = BuildAuthorizationService(services =>
708              {
709                  services.AddTransient<IAuthorizationHandler, NotCalledHandler>();
710              });
711              var user = new ClaimsPrincipal(
712                  new ClaimsIdentity(
713                      new Claim[] {
714                          new Claim("SuperUser", "yes")
715                      },
716                      "AuthType")
717                  );
718              Assert.False((await authorizationService.AuthorizeAsync(user, 1, Operations.Edit)).Succeeded);
719          }
720          [Fact]
721          public async Task CanAuthorizeOnlyAllowedOperations()
722          {
723              var authorizationService = BuildAuthorizationService(services =>
724              {
725                  services.AddSingleton<IAuthorizationHandler>(new ExpenseReportAuthorizationHandler(new OperationAuthorizationRequirement[] { Operations.Edit }));
726              });
727              var user = new ClaimsPrincipal();
728              Assert.True((await authorizationService.AuthorizeAsync(user, new ExpenseReport(), Operations.Edit)).Succeeded);
729              Assert.False((await authorizationService.AuthorizeAsync(user, new ExpenseReport(), Operations.Delete)).Succeeded);
730              Assert.False((await authorizationService.AuthorizeAsync(user, new ExpenseReport(), Operations.Create)).Succeeded);
731          }
732          [Fact]
733          public async Task AuthorizeHandlerNotCalledWithNullResource()
734          {
735              var authorizationService = BuildAuthorizationService(services =>
736              {
737                  services.AddSingleton<IAuthorizationHandler>(new ExpenseReportAuthorizationHandler(new OperationAuthorizationRequirement[] { Operations.Edit }));
738              });
739              var user = new ClaimsPrincipal();
740              Assert.False((await authorizationService.AuthorizeAsync(user, null, Operations.Edit)).Succeeded);
741          }
742          [Fact]
743          public async Task CanAuthorizeWithAssertionRequirement()
744          {
745              var authorizationService = BuildAuthorizationService(services =>
746              {
747                  services.AddAuthorization(options =>
748                  {
749                      options.AddPolicy("Basic", policy => policy.RequireAssertion(context => true));
750                  });
751              });
752              var user = new ClaimsPrincipal();
753              var allowed = await authorizationService.AuthorizeAsync(user, "Basic");
754              Assert.True(allowed.Succeeded);
755          }
756          [Fact]
757          public async Task CanAuthorizeWithAsyncAssertionRequirement()
758          {
759              var authorizationService = BuildAuthorizationService(services =>
760              {
761                  services.AddAuthorization(options =>
762                  {
763                      options.AddPolicy("Basic", policy => policy.RequireAssertion(context => Task.FromResult(true)));
764                  });
765              });
766              var user = new ClaimsPrincipal();
767              var allowed = await authorizationService.AuthorizeAsync(user, "Basic");
768              Assert.True(allowed.Succeeded);
769          }
770          public class StaticPolicyProvider : IAuthorizationPolicyProvider
771          {
772              public Task<AuthorizationPolicy> GetDefaultPolicyAsync()
773              {
774                  return Task.FromResult(new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build());
775              }
776              public Task<AuthorizationPolicy> GetRequiredPolicyAsync()
777              {
778                  return Task.FromResult<AuthorizationPolicy>(null);
779              }
780              public Task<AuthorizationPolicy> GetPolicyAsync(string policyName)
781              {
782                  return Task.FromResult(new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build());
783              }
784          }
785          [Fact]
786          public async Task CanReplaceDefaultPolicyProvider()
787          {
788              var authorizationService = BuildAuthorizationService(services =>
789              {
790                  services.AddSingleton<IAuthorizationPolicyProvider, StaticPolicyProvider>();
791                  services.AddAuthorization(options =>
792                  {
793                      options.AddPolicy("Basic", policy => policy.RequireAssertion(context => true));
794                  });
795              });
796              var user = new ClaimsPrincipal();
797              var allowed = await authorizationService.AuthorizeAsync(user, "Basic");
798              Assert.False(allowed.Succeeded);
799          }
800          public class DynamicPolicyProvider : IAuthorizationPolicyProvider
801          {
802              public Task<AuthorizationPolicy> GetDefaultPolicyAsync()
803              {
804                  return Task.FromResult(new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build());
805              }
806              public Task<AuthorizationPolicy> GetRequiredPolicyAsync()
807              {
808                  return Task.FromResult<AuthorizationPolicy>(null);
809              }
810              public Task<AuthorizationPolicy> GetPolicyAsync(string policyName)
811              {
812                  return Task.FromResult(new AuthorizationPolicyBuilder().RequireClaim(policyName).Build());
813              }
814          }
815          [Fact]
816          public async Task CanUseDynamicPolicyProvider()
817          {
818              var authorizationService = BuildAuthorizationService(services =>
819              {
820                  services.AddSingleton<IAuthorizationPolicyProvider, DynamicPolicyProvider>();
821                  services.AddAuthorization(options => { });
822              });
823              var id = new ClaimsIdentity();
824              id.AddClaim(new Claim("1", "1"));
825              id.AddClaim(new Claim("2", "2"));
826              var user = new ClaimsPrincipal(id);
827              Assert.False((await authorizationService.AuthorizeAsync(user, "0")).Succeeded);
828              Assert.True((await authorizationService.AuthorizeAsync(user, "1")).Succeeded);
829              Assert.True((await authorizationService.AuthorizeAsync(user, "2")).Succeeded);
830              Assert.False((await authorizationService.AuthorizeAsync(user, "3")).Succeeded);
831          }
832          public class SuccessEvaluator : IAuthorizationEvaluator
833          {
834              public AuthorizationResult Evaluate(AuthorizationHandlerContext context) => AuthorizationResult.Success();
835          }
836          [Fact]
837          public async Task CanUseCustomEvaluatorThatOverridesRequirement()
838          {
839              var authorizationService = BuildAuthorizationService(services =>
840              {
841                  services.AddSingleton<IAuthorizationEvaluator, SuccessEvaluator>();
842                  services.AddAuthorization(options => options.AddPolicy("Fail", p => p.RequireAssertion(c => false)));
843              });
844              var result = await authorizationService.AuthorizeAsync(null, "Fail");
845              Assert.True(result.Succeeded);
846          }
847          public class BadContextMaker : IAuthorizationHandlerContextFactory
848          {
849              public AuthorizationHandlerContext CreateContext(IEnumerable<IAuthorizationRequirement> requirements, ClaimsPrincipal user, object resource)
850              {
851                  return new BadContext();
852              }
853          }
854          public class BadContext : AuthorizationHandlerContext
855          {
856              public BadContext() : base(new List<IAuthorizationRequirement>(), null, null) { }
857              public override bool HasFailed
858              {
859                  get
860                  {
861                      return true;
862                  }
863              }
864              public override bool HasSucceeded
865              {
866                  get
867                  {
868                      return false;
869                  }
870              }
871          }
872          [Fact]
873          public async Task CanUseCustomContextThatAlwaysFails()
874          {
875              var authorizationService = BuildAuthorizationService(services =>
876              {
877                  services.AddSingleton<IAuthorizationHandlerContextFactory, BadContextMaker>();
878                  services.AddAuthorization(options => options.AddPolicy("Success", p => p.RequireAssertion(c => true)));
879              });
880              Assert.False((await authorizationService.AuthorizeAsync(null, "Success")).Succeeded);
881          }
882          public class SadHandlerProvider : IAuthorizationHandlerProvider
883          {
884              public Task<IEnumerable<IAuthorizationHandler>> GetHandlersAsync(AuthorizationHandlerContext context)
885              {
886                  return Task.FromResult<IEnumerable<IAuthorizationHandler>>(new IAuthorizationHandler[1] { new FailHandler() });
887              }
888          }
889          [Fact]
890          public async Task CanUseCustomHandlerProvider()
891          {
892              var authorizationService = BuildAuthorizationService(services =>
893              {
894                  services.AddSingleton<IAuthorizationHandlerProvider, SadHandlerProvider>();
895                  services.AddAuthorization(options => options.AddPolicy("Success", p => p.RequireAssertion(c => true)));
896              });
897              Assert.False((await authorizationService.AuthorizeAsync(null, "Success")).Succeeded);
898          }
899      }
900  }
</code></pre>
        </div>
        <div class="column">
            <h3>MudBlazor-MDEwOlJlcG9zaXRvcnkyODg0Mjg2NzY=-flat-DatePickerTests.cs</h3>
            <pre><code>1  #pragma warning disable CS1998 
2  #pragma warning disable BL0005 
3  using System;
4  using System.Collections.Generic;
5  using System.Diagnostics;
6  using System.Globalization;
7  using System.Linq;
8  using System.Threading.Tasks;
9  using AngleSharp.Dom;
10  using AngleSharp.Html.Dom;
11  using Bunit;
12  using FluentAssertions;
13  using Microsoft.AspNetCore.Components.Web;
14  using MudBlazor.UnitTests.TestComponents;
15  using MudBlazor.UnitTests.TestComponents.DatePicker;
16  using NUnit.Framework;
17  using static Bunit.ComponentParameterFactory;
18  namespace MudBlazor.UnitTests.Components
19  {
20      [TestFixture]
21      public class DatePickerTests : BunitTest
22      {
23          [Test]
24          public void Default()
25          {
26              var comp = Context.RenderComponent<MudDatePicker>();
27              var picker = comp.Instance;
28              picker.Text.Should().Be(null);
29              picker.Date.Should().Be(null);
30              picker.MaxDate.Should().Be(null);
31              picker.MinDate.Should().Be(null);
32              picker.OpenTo.Should().Be(OpenTo.Date);
33              picker.FirstDayOfWeek.Should().Be(null);
34              picker.ClosingDelay.Should().Be(100);
35              picker.DisplayMonths.Should().Be(1);
36              picker.MaxMonthColumns.Should().Be(null);
37              picker.StartMonth.Should().Be(null);
38              picker.ShowWeekNumbers.Should().BeFalse();
39              picker.AutoClose.Should().BeFalse();
40              picker.FixYear.Should().Be(null);
41              picker.FixMonth.Should().Be(null);
42              picker.FixDay.Should().Be(null);
43          }
44          [Test]
45          public void DatePickerOpenButtonAriaLabel()
46          {
47              var comp = Context.RenderComponent<DatePickerValidationTest>();
48              var openButton = comp.Find(".mud-input-adornment button");
49              openButton.Attributes.GetNamedItem("aria-label")?.Value.Should().Be("Open Date Picker");
50          }
51          [Test]
52          public void DatePickerLabelFor()
53          {
54              var comp = Context.RenderComponent<DatePickerValidationTest>();
55              var label = comp.Find(".mud-input-label");
56              label.Attributes.GetNamedItem("for")?.Value.Should().Be("datePickerLabelTest");
57          }
58          [Test]
59          [Ignore("Unignore for performance measurements, not needed for code coverage")]
60          public void DatePicker_Render_Performance()
61          {
62              Context.RenderComponent<MudDatePicker>();
63              var watch = Stopwatch.StartNew();
64              for (var i = 0; i < 1000; i++)
65                  Context.RenderComponent<MudDatePicker>();
66              watch.Stop();
67              watch.Elapsed.Should().BeLessThan(TimeSpan.FromSeconds(10));
68          }
69          [Test]
70          public async Task DatePicker_OpenClose_Performance()
71          {
72              var comp = Context.RenderComponent<MudDatePicker>();
73              var datepicker = comp.Instance;
74              var watch = Stopwatch.StartNew();
75              for (var i = 0; i < 1000; i++)
76              {
77                  await comp.InvokeAsync(() => datepicker.Open());
78                  await comp.InvokeAsync(() => datepicker.Close());
79              }
80              watch.Stop();
81              watch.Elapsed.Should().BeLessThan(TimeSpan.FromSeconds(10));
82          }
83          [Test]
84          public async Task SetPickerValue_CheckDate_SetPickerDate_CheckValue()
85          {
86              var comp = Context.RenderComponent<MudDatePicker>();
87              var picker = comp.Instance;
88              picker.Text.Should().Be(null);
89              picker.Date.Should().Be(null);
90              comp.SetParam(p => p.Text, new DateTime(2020, 10, 23).ToShortDateString());
91              picker.Date.Should().Be(new DateTime(2020, 10, 23));
92              comp.SetParam(p => p.Date, new DateTime(2020, 10, 26));
93              picker.Text.Should().Be(new DateTime(2020, 10, 26).ToShortDateString());
94          }
95          [Test]
96          public async Task DatePicker_Should_ApplyDateFormat()
97          {
98              var comp = Context.RenderComponent<MudDatePicker>();
99              var picker = comp.Instance;
100              picker.Text.Should().Be(null);
101              picker.Date.Should().Be(null);
102              comp.SetParam(p => p.DateFormat, "dd/MM/yyyy");
103              comp.SetParam(p => p.Culture, CultureInfo.InvariantCulture); 
104              comp.SetParam(p => p.Text, "23/10/2020");
105              picker.Date.Should().Be(new DateTime(2020, 10, 23));
106              comp.SetParam(p => p.Date, new DateTime(2020, 10, 26));
107              picker.Text.Should().Be("26/10/2020");
108          }
109          [Test]
110          public async Task DatePicker_Should_ApplyDateFormatAfterDate()
111          {
112              var comp = Context.RenderComponent<MudDatePicker>();
113              var picker = comp.Instance;
114              picker.Text.Should().Be(null);
115              picker.Date.Should().Be(null);
116              comp.SetParam(p => p.DateFormat, "dd/MM/yyyy");
117              comp.SetParam(p => p.Culture, CultureInfo.InvariantCulture); 
118              comp.SetParam(p => p.Date, new DateTime(2020, 10, 26));
119              picker.Date.Should().Be(new DateTime(2020, 10, 26));
120              picker.Text.Should().Be("26/10/2020");
121          }
122          [Test]
123          public async Task DatePicker_Should_ApplyCultureDateFormat()
124          {
125              var comp = Context.RenderComponent<MudDatePicker>();
126              var picker = comp.Instance;
127              picker.Text.Should().Be(null);
128              picker.Date.Should().Be(null);
129              var customCulture = new CultureInfo("en-US");
130              customCulture.DateTimeFormat.ShortDatePattern.Should().Be("M/d/yyyy");
131              customCulture.DateTimeFormat.ShortDatePattern = "dd MM yyyy";
132              comp.SetParam(p => p.Culture, customCulture);
133              comp.SetParam(p => p.Text, "23 10 2020");
134              picker.Date.Should().Be(new DateTime(2020, 10, 23));
135              comp.SetParam(p => p.Date, new DateTime(2020, 10, 26));
136              picker.Text.Should().Be("26 10 2020");
137              customCulture.DateTimeFormat.ShortDatePattern = "yyyy-MM-dd";
138              comp.SetParam(p => p.Text, "13 10 2020");
139              picker.Date.Should().Be(new DateTime(2020, 10, 13));
140              comp.SetParam(p => p.Date, new DateTime(2020, 10, 16));
141              picker.Text.Should().Be("16 10 2020");
142          }
143          [Test]
144          public async Task DatePicker_Should_DateFormatTakesPrecedenceOverCulture()
145          {
146              var comp = Context.RenderComponent<MudDatePicker>();
147              var picker = comp.Instance;
148              picker.Text.Should().Be(null);
149              picker.Date.Should().Be(null);
150              comp.SetParam(p => p.DateFormat, "dd MM yyyy");
151              comp.SetParam(p => p.Culture, CultureInfo.InvariantCulture); 
152              comp.SetParam(p => p.Date, new DateTime(2020, 10, 26));
153              picker.Date.Should().Be(new DateTime(2020, 10, 26));
154              picker.Text.Should().Be("26 10 2020");
155          }
156          [Test]
157          public async Task DatePicker_Should_Clear()
158          {
159              var comp = Context.RenderComponent<MudDatePicker>();
160              var picker = comp.Instance;
161              picker.Text.Should().Be(null);
162              picker.Date.Should().Be(null);
163              comp.SetParam(p => p.Clearable, true);
164              comp.SetParam(p => p.Date, new DateTime(2020, 10, 26));
165              picker.Date.Should().Be(new DateTime(2020, 10, 26));
166              picker.Text.Should().Be(new DateTime(2020, 10, 26).ToShortDateString());
167              comp.Find("button").Click(); 
168              picker.Text.Should().Be(""); 
169              picker.Date.Should().Be(null);
170          }
171          [Test]
172          public void Check_Intial_Date_Format()
173          {
174              DateTime? date = new DateTime(2021, 1, 13);
175              var comp = Context.RenderComponent<MudDatePicker>(parameters => parameters
176                  .Add(p => p.Culture, CultureInfo.InvariantCulture)
177                  .Add(p => p.DateFormat, "dd/MM/yyyy")
178                  .Add(p => p.Date, date)
179              );
180              var picker = comp.Instance;
181              var instance = comp.Instance;
182              picker.Date.Should().Be(new DateTime(2021, 1, 13));
183              picker.Text.Should().Be("13/01/2021");
184          }
185          public IRenderedComponent<SimpleMudDatePickerTest> OpenPicker(ComponentParameter parameter)
186          {
187              return OpenPicker(new ComponentParameter[] { parameter });
188          }
189          public IRenderedComponent<SimpleMudDatePickerTest> OpenPicker(ComponentParameter[] parameters = null)
190          {
191              IRenderedComponent<SimpleMudDatePickerTest> comp;
192              if (parameters is null)
193              {
194                  comp = Context.RenderComponent<SimpleMudDatePickerTest>();
195              }
196              else
197              {
198                  comp = Context.RenderComponent<SimpleMudDatePickerTest>(parameters);
199              }
200              comp.FindAll("div.mud-picker-open").Count.Should().Be(0);
201              comp.Find("input").Click();
202              comp.FindAll("div.mud-picker-open").Count.Should().Be(1);
203              return comp;
204          }
205          [Test]
206          public void Open_CloseByClickingOutsidePicker_CheckClosed()
207          {
208              var comp = OpenPicker();
209              comp.Find("div.mud-overlay").Click();
210              comp.FindAll("div.mud-picker-open").Count.Should().Be(0);
211          }
212          [Test]
213          public void Open_CloseBySelectingADate_CheckClosed()
214          {
215              var comp = OpenPicker();
216              comp.FindAll("button.mud-picker-calendar-day")
217                  .Where(x => x.TrimmedText().Equals("23")).First().Click();
218              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(0), TimeSpan.FromSeconds(5));
219              comp.Instance.Date.Should().NotBeNull();
220          }
221          [Test]
222          public void Open_CloseBySelectingADate_CheckClosed_Check_DateChangedCount()
223          {
224              var eventCount = 0;
225              DateTime? returnDate = null;
226              var comp = OpenPicker(EventCallback(nameof(MudDatePicker.DateChanged), (DateTime? date) => { eventCount++; returnDate = date; }));
227              comp.FindAll("button.mud-picker-calendar-day")
228                  .Where(x => x.TrimmedText().Equals("23")).First().Click();
229              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(0), TimeSpan.FromSeconds(5));
230              comp.Instance.Date.Should().NotBeNull();
231              eventCount.Should().Be(1);
232              var now = DateTime.Now;
233              returnDate.Should().Be(new DateTime(now.Year, now.Month, 23));
234          }
235          [Test]
236          public void OpenToYear_CheckYearsShown()
237          {
238              var comp = OpenPicker(Parameter("OpenTo", OpenTo.Year));
239              comp.Instance.Date.Should().BeNull();
240              comp.FindAll("div.mud-picker-year-container").Count.Should().Be(1);
241          }
242          [Test]
243          public void OpenToYear_ClickYear_CheckMonthsShown()
244          {
245              var comp = OpenPicker(Parameter("OpenTo", OpenTo.Year));
246              comp.Instance.Date.Should().BeNull();
247              comp.FindAll("div.mud-picker-year-container").Count.Should().Be(1);
248              comp.FindAll("div.mud-picker-year")[0].Click();
<span onclick='openModal()' class='match'>249              comp.FindAll("div.mud-picker-month-container").Count.Should().Be(1);
250          }
251          [Test]
252          public void OpenToYear_ClickYear_CheckMonthsShown_Close_Reopen_CheckYearsShown()
253          {
254              var comp = OpenPicker(Parameter("OpenTo", OpenTo.Year));
255              comp.Instance.Date.Should().BeNull();
256              comp.FindAll("div.mud-picker-year-container").Count.Should().Be(1);
</span>257              comp.FindAll("div.mud-picker-year")[0].Click();
258              comp.FindAll("div.mud-picker-month-container").Count.Should().Be(1);
259              comp.Find("div.mud-overlay").Click();
260              comp.FindAll("div.mud-picker-open").Count.Should().Be(0);
261              comp.Find("input").Click();
262              comp.FindAll("div.mud-picker-year-container").Count.Should().Be(1);
263          }
264          [Test]
265          public void OpenToMonth_CheckMonthsShown()
266          {
267              var comp = OpenPicker(Parameter("OpenTo", OpenTo.Month));
268              comp.Instance.Date.Should().BeNull();
269              comp.FindAll("div.mud-picker-month-container").Count.Should().Be(1);
270          }
271          [Test]
272          public void Open_ClickCalendarHeader_CheckMonthsShown()
273          {
274              var comp = OpenPicker();
275              comp.FindAll("button.mud-picker-calendar-header-transition")[0].Click();
276              comp.FindAll("div.mud-picker-month-container").Count.Should().Be(1);
277          }
278          [Test]
279          public void Open_ClickYear_CheckYearsShown()
280          {
281              var comp = OpenPicker(Parameter(nameof(MudDatePicker.OpenTo), OpenTo.Month));
282              comp.FindAll("button.mud-picker-calendar-header-transition")[0].Click();
283              comp.FindAll("div.mud-picker-year-container").Count.Should().Be(1);
284          }
285          [Test]
286          public void OpenToMonth_Select3rdMonth_Select2ndDay_CheckDate()
287          {
288              var comp = OpenPicker(Parameter("OpenTo", OpenTo.Month));
289              comp.Instance.Date.Should().BeNull();
290              comp.FindAll("div.mud-picker-month-container").Count.Should().Be(1);
291              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-month-container > button.mud-picker-month")
292                  [2].Click();
293              comp.FindAll("button.mud-picker-calendar-day")
294                  .Where(x => x.TrimmedText().Equals("2")).First().Click();
295              comp.Instance.Date.Value.Date.Should().Be(new DateTime(DateTime.Now.Year, 3, 2));
296          }
297          public IRenderedComponent<SimpleMudDatePickerTest> OpenTo12thMonth()
298          {
299              var comp = OpenPicker(Parameter("PickerMonth", new DateTime(DateTime.Now.Year, 12, 01)));
300              comp.Instance.PickerMonth.Value.Month.Should().Be(12);
301              return comp;
302          }
303          [Test]
304          public void Open_ClickCalendarHeader_Click4thMonth_Click23rdDay_CheckDate()
305          {
306              var comp = OpenPicker();
307              var picker = comp.Instance;
308              comp.Find("button.mud-picker-calendar-header-transition").Click();
309              comp.FindAll("div.mud-picker-month-container").Count.Should().Be(1);
310              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-month-container > button.mud-picker-month")
311                  [3].Click();
312              comp.FindAll("button.mud-picker-calendar-day")
313                  .Where(x => x.TrimmedText().Equals("23")).First().Click();
314              comp.Instance.Date.Value.Date.Should().Be(new DateTime(DateTime.Now.Year, 4, 23));
315          }
316          [Test]
317          public void DatePickerStaticWithPickerActionsDayClick_Test()
318          {
319              var comp = Context.RenderComponent<DatePickerStaticTest>();
320              var picker = comp.FindComponent<MudDatePicker>();
321              comp.FindAll("button.mud-picker-calendar-day")
322                  .Where(x => x.TrimmedText().Equals("23")).First().Click();
323              picker.Instance.Date.Should().Be(new DateTime(DateTime.Now.Year, DateTime.Now.Month, 23));
324          }
325          [Test]
326          public void OpenTo12thMonth_NavigateBack_CheckMonth()
327          {
328              var comp = OpenTo12thMonth();
329              var picker = comp.Instance;
330              comp.Find("div.mud-picker-calendar-header-switch > button:nth-child(1)").Click();
331              picker.PickerMonth.Value.Month.Should().Be(11);
332              picker.PickerMonth.Value.Year.Should().Be(DateTime.Now.Year);
333          }
334          [Test]
335          public void OpenTo12thMonth_NavigateForward_CheckYear()
336          {
337              var comp = OpenTo12thMonth();
338              var picker = comp.Instance;
339              comp.Find("div.mud-picker-calendar-header-switch > button:nth-child(3)").Click();
340              picker.PickerMonth.Value.Month.Should().Be(1);
341              picker.PickerMonth.Value.Year.Should().Be(DateTime.Now.Year + 1);
342          }
343          [Test]
344          public void Open_ClickYear_ClickCurrentYear_Click2ndMonth_Click1_CheckDate()
345          {
346              var comp = OpenPicker();
347              comp.Find("div.mud-picker-datepicker-toolbar > button.mud-button-year").Click();
348              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-year-container").Count.Should().Be(1);
349              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-year-container > div.mud-picker-year")
350                  .Where(x => x.TrimmedText().Contains("2022")).First().Click();
351              comp.FindAll("div.mud-picker-month-container").Count.Should().Be(1);
352              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-month-container > button.mud-picker-month")[1].Click();
353              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-calendar-header").Count.Should().Be(1);
354              comp.FindAll("button.mud-picker-calendar-day")
355                  .Where(x => x.TrimmedText().Equals("1")).First().Click();
356              comp.Instance.Date.Value.Date.Should().Be(new DateTime(2022, 2, 1));
357          }
358          [Test]
359          public void Open_FixYear_Click2ndMonth_Click3_CheckDate()
360          {
361              var comp = OpenPicker(ComponentParameter.CreateParameter("FixYear", 2021));
362              comp.Find("div.mud-picker-datepicker-toolbar > button.mud-button-year").Click();
363              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-year-container").Count.Should().Be(0);
364              comp.Find("div.mud-picker-calendar-container > .mud-picker-calendar-header > .mud-picker-calendar-header-switch > .mud-button-month").Click();
365              comp.FindAll("div.mud-picker-month-container").Count.Should().Be(1);
366              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-month-container > button.mud-picker-month")[1].Click();
367              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-calendar-header").Count.Should().Be(1);
368              comp.FindAll("button.mud-picker-calendar-day")
369                  .Where(x => x.TrimmedText().Equals("3")).First().Click();
370              comp.Instance.Date.Value.Date.Should().Be(new DateTime(2021, 2, 3));
371          }
372          [Test]
373          public void Open_FixDay_ClickYear_Click2ndMonth_CheckDate()
374          {
375              var comp = OpenPicker(ComponentParameter.CreateParameter("FixDay", 1));
376              comp.Find("div.mud-picker-datepicker-toolbar > button.mud-button-year").Click();
377              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-year-container").Count.Should().Be(1);
378              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-year-container > div.mud-picker-year")
379                  .Where(x => x.TrimmedText().Contains("2022")).First().Click();
380              comp.FindAll("div.mud-picker-month-container").Count.Should().Be(1);
381              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-month-container > button.mud-picker-month")[1].Click();
382              comp.Instance.Date.Value.Date.Should().Be(new DateTime(2022, 2, 1));
383          }
384          [Test]
385          public void Open_FixMonth_ClickYear_Click3_CheckDate()
386          {
387              var comp = OpenPicker(ComponentParameter.CreateParameter("FixMonth", 1));
388              comp.FindAll("div.mud-picker-calendar-container > .mud-picker-calendar-header > .mud-picker-calendar-header-switch > .mud-button-month").Count().Should().Be(0);
389              comp.Find("div.mud-picker-datepicker-toolbar > button.mud-button-year").Click();
390              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-year-container").Count.Should().Be(1);
391              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-year-container > div.mud-picker-year")
392                  .Where(x => x.TrimmedText().Contains("2022")).First().Click();
393              comp.FindAll("div.mud-picker-month-container").Count.Should().Be(0);
394              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-calendar-header").Count.Should().Be(1);
395              comp.FindAll("button.mud-picker-calendar-day")
396                  .Where(x => x.TrimmedText().Equals("3")).First().Click();
397              comp.Instance.Date.Value.Date.Should().Be(new DateTime(2022, 1, 3));
398          }
399          [Test]
400          public void Open_FixYear_FixMonth_Click3_CheckDate()
401          {
402              var comp = OpenPicker(new ComponentParameter[] { ComponentParameter.CreateParameter("FixMonth", 1), ComponentParameter.CreateParameter("FixYear", 2022) });
403              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-year-container").Count.Should().Be(0);
404              comp.Find("div.mud-picker-datepicker-toolbar > button.mud-button-year").Click();
405              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-year-container").Count.Should().Be(0);
406              comp.FindAll("div.mud-picker-calendar-container > .mud-picker-calendar-header > .mud-picker-calendar-header-switch > .mud-button-month").Count().Should().Be(0);
407              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-calendar-header").Count.Should().Be(1);
408              comp.FindAll("button.mud-picker-calendar-day")
409                  .Where(x => x.TrimmedText().Equals("3")).First().Click();
410              comp.Instance.Date.Value.Date.Should().Be(new DateTime(2022, 1, 3));
411          }
412          [Test]
413          public void Open_FixMonth_FixDay_ClickYear2022_CheckDate()
414          {
415              var comp = OpenPicker(new ComponentParameter[] { ComponentParameter.CreateParameter("OpenTo", OpenTo.Year), ComponentParameter.CreateParameter("FixMonth", 1), ComponentParameter.CreateParameter("FixDay", 1) });
416              comp.FindAll("div.mud-picker-calendar-container > .mud-picker-calendar-header > .mud-picker-calendar-header-switch > .mud-button-month").Count().Should().Be(0);
417              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-year-container").Count.Should().Be(1);
418              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-year-container > div.mud-picker-year")
419                  .Where(x => x.TrimmedText().Contains("2022")).First().Click();
420              comp.Instance.Date.Value.Date.Should().Be(new DateTime(2022, 1, 1));
421          }
422          [Test]
423          public void Open_FixYear_FixDay_Click3rdMonth_CheckDate()
424          {
425              var comp = OpenPicker(new ComponentParameter[] { ComponentParameter.CreateParameter("OpenTo", OpenTo.Month), ComponentParameter.CreateParameter("FixYear", 2022), ComponentParameter.CreateParameter("FixDay", 1) });
426              comp.Find("div.mud-picker-datepicker-toolbar > button.mud-button-year").Click();
427              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-year-container").Count.Should().Be(0);
428              comp.FindAll("div.mud-picker-month-container").Count.Should().Be(1);
429              comp.FindAll("div.mud-picker-calendar-container > div.mud-picker-month-container > button.mud-picker-month")[2].Click();
430              comp.Instance.Date.Value.Date.Should().Be(new DateTime(2022, 3, 1));
431          }
432          [Test]
433          public async Task Open_Programmatically_CheckOpen_Close_Programmatically_CheckClosed()
434          {
435              var comp = Context.RenderComponent<SimpleMudDatePickerTest>();
436              comp.FindAll("div.mud-picker-content").Count.Should().Be(0);
437              await comp.InvokeAsync(() => comp.Instance.Open());
438              comp.FindAll("div.mud-picker-content").Count.Should().Be(1);
439              await comp.InvokeAsync(() => comp.Instance.Close());
440              comp.FindAll("div.mud-picker-content").Count.Should().Be(0);
441          }
442          [Test]
443          public async Task PersianCalendar()
444          {
445              var cal = new PersianCalendar();
446              var date = new DateTime(2021, 02, 14);
447              cal.GetYear(date).Should().Be(1399);
448              cal.GetMonth(date).Should().Be(11);
449              cal.GetDayOfMonth(date).Should().Be(26);
450              var comp = Context.RenderComponent<PersianDatePickerTest>();
451              var datePicker = comp.FindComponent<MudDatePicker>();
452              await comp.InvokeAsync(() => datePicker.Instance.Open());
453          }
454          [Test]
455          public void SetPickerValue_CheckText()
456          {
457              var date = DateTime.Now;
458              var comp = Context.RenderComponent<MudDatePicker>(
459                  Parameter(nameof(MudDatePicker.Date), date));
460              var picker = comp.Instance;
461              var text = date.ToShortDateString();
462              picker.Text.Should().Be(text);
463              ((IHtmlInputElement)comp.FindAll("input")[0]).Value.Should().Be(text);
464          }
465          [Test]
466          public void IsDateDisabledFunc_DisablesCalendarDateButtons()
467          {
468              Func<DateTime, bool> isDisabledFunc = date => true;
469              var comp = OpenPicker(Parameter(nameof(MudDatePicker.IsDateDisabledFunc), isDisabledFunc));
470              comp.Instance.IsDateDisabledFunc.Should().Be(isDisabledFunc);
471              comp.FindAll("button.mud-picker-calendar-day").Select(button => ((IHtmlButtonElement)button).IsDisabled)
472                  .Should().OnlyContain(disabled => disabled == true);
473          }
474          [Test]
475          public void IsDateDisabledFunc_DisablesCalendarMonthButtons()
476          {
477              Func<DateTime, bool> isDisabledFunc = date => true;
478              var comp = OpenPicker(new[]
479              {
480                  Parameter(nameof(MudDatePicker.IsDateDisabledFunc), isDisabledFunc),
481                  Parameter(nameof(MudDatePicker.OpenTo), OpenTo.Month),
482                  Parameter(nameof(MudDatePicker.FixDay), 1)
483              });
484              comp.Instance.IsDateDisabledFunc.Should().Be(isDisabledFunc);
485              comp.FindAll("button.mud-picker-month").Select(button => ((IHtmlButtonElement)button).IsDisabled)
486                  .Should().OnlyContain(disabled => disabled == true);
487              comp.FindAll("button.mud-picker-month > .mud-typography").Select(
488                  text => ((IHtmlElement)text).ClassList.Any(cls => cls == "mud-picker-month-select" || cls == "mud-primary-text"))
489                  .Should().OnlyContain(selected => selected == false);
490          }
491          [Test]
492          public void IsDateDisabledFunc_DoesNotHaveEffectOnMonthsIfDayNotFixed()
493          {
494              Func<DateTime, bool> isDisabledFunc = date => true;
495              var comp = OpenPicker(new[]
496              {
497                  Parameter(nameof(MudDatePicker.IsDateDisabledFunc), isDisabledFunc),
498                  Parameter(nameof(MudDatePicker.OpenTo), OpenTo.Month)
499              });
500              comp.Instance.IsDateDisabledFunc.Should().Be(isDisabledFunc);
501              comp.FindAll("button.mud-picker-month").Select(button => ((IHtmlButtonElement)button).IsDisabled)
502                  .Should().OnlyContain(disabled => disabled == false);
503          }
504          [Test]
505          public void IsDateDisabledFunc_DoesNotHaveEffectOnMonthsIfFuncReturnsFalse()
506          {
507              Func<DateTime, bool> isDisabledFunc = date => false;
508              var comp = OpenPicker(new[]
509              {
510                  Parameter(nameof(MudDatePicker.IsDateDisabledFunc), isDisabledFunc),
511                  Parameter(nameof(MudDatePicker.OpenTo), OpenTo.Month),
512                  Parameter(nameof(MudDatePicker.FixDay), 1)
513              });
514              comp.Instance.IsDateDisabledFunc.Should().Be(isDisabledFunc);
515              comp.FindAll("button.mud-picker-month").Select(button => ((IHtmlButtonElement)button).IsDisabled)
516                  .Should().OnlyContain(disabled => disabled == false);
517          }
518          [TestCase(10, 8, 2, 2)]
519          [TestCase(10, 9, 2, 2)]
520          [TestCase(10, 10, 2, 1)]
521          [TestCase(10, 11, 2, 1)]
522          public void MinDateEffectOnDisablingMonthsIfDayFixed(int minDatesDay, int fixedDay,
523              int month, int disabledOnes)
524          {
525              var currentDate = DateTime.Now;
526              var minDate = new DateTime(currentDate.Year, month, minDatesDay);
527              var comp = OpenPicker(new[]
528              {
529                  Parameter(nameof(MudDatePicker.MinDate), minDate),
530                  Parameter(nameof(MudDatePicker.OpenTo), OpenTo.Month),
531                  Parameter(nameof(MudDatePicker.FixDay), fixedDay),
532              });
533              var expectedResult = new bool[12];
534              for (var i = 0; i < disabledOnes; ++i) expectedResult[i] = true;
535              comp.Instance.MinDate.Should().Be(minDate);
536              comp.FindAll("button.mud-picker-month").Select(button => ((IHtmlButtonElement)button).IsDisabled)
537                  .Should().ContainInConsecutiveOrder(expectedResult);
538          }
539          [TestCase(10, 9, 11, 1)]
540          [TestCase(10, 10, 11, 1)]
541          [TestCase(10, 11, 11, 2)]
542          [TestCase(10, 12, 11, 2)]
543          public void MaxDateEffectOnDisablingMonthsIfDayFixed(int maxDatesDay, int fixedDay,
544              int month, int disabledOnes)
545          {
546              var currentDate = DateTime.Now;
547              var maxDate = new DateTime(currentDate.Year, month, maxDatesDay);
548              var comp = OpenPicker(new[]
549              {
550                  Parameter(nameof(MudDatePicker.MaxDate), maxDate),
551                  Parameter(nameof(MudDatePicker.OpenTo), OpenTo.Month),
552                  Parameter(nameof(MudDatePicker.FixDay), fixedDay),
553              });
554              var expectedResult = new bool[12];
555              for (var i = 0; i < disabledOnes; ++i) expectedResult[11 - i] = true;
556              comp.Instance.MaxDate.Should().Be(maxDate);
557              comp.FindAll("button.mud-picker-month").Select(button => ((IHtmlButtonElement)button).IsDisabled)
558                  .Should().ContainInConsecutiveOrder(expectedResult);
559          }
560          [TestCase(30, 3, 2)]
561          [TestCase(31, 3, 2)]
562          [TestCase(1, 4, 3)]
563          [TestCase(2, 4, 3)]
564          public void MinDateEffectOnDisablingMonthsIfDayNotFixed(int minDatesDay, int month, int disabledOnes)
565          {
566              var currentYear = DateTime.Now.Year;
567              var minDate = new DateTime(currentYear, month, minDatesDay);
568              var comp = OpenPicker(new[]
569              {
570                  Parameter(nameof(MudDatePicker.MinDate), minDate),
571                  Parameter(nameof(MudDatePicker.OpenTo), OpenTo.Month),
572              });
573              var expectedResult = new bool[12];
574              for (var i = 0; i < disabledOnes; ++i) expectedResult[i] = true;
575              comp.Instance.MinDate.Should().Be(minDate);
576              comp.FindAll("button.mud-picker-month").Select(button => ((IHtmlButtonElement)button).IsDisabled)
577                  .Should().ContainInConsecutiveOrder(expectedResult);
578          }
579          [TestCase(1, 10, 2)]
580          [TestCase(2, 10, 2)]
581          [TestCase(30, 9, 3)]
582          [TestCase(29, 9, 3)]
583          public void MaxDateEffectOnDisablingMonthsIfDayNotFixed(int maxDatesDay, int month, int disabledOnes)
584          {
585              var currentYear = DateTime.Now.Year;
586              var maxDate = new DateTime(currentYear, month, maxDatesDay);
587              var comp = OpenPicker(new[]
588              {
589                  Parameter(nameof(MudDatePicker.MaxDate), maxDate),
590                  Parameter(nameof(MudDatePicker.OpenTo), OpenTo.Month),
591              });
592              var expectedResult = new bool[12];
593              for (var i = 0; i < disabledOnes; ++i) expectedResult[11 - i] = true;
594              comp.Instance.MaxDate.Should().Be(maxDate);
595              comp.FindAll("button.mud-picker-month").Select(button => ((IHtmlButtonElement)button).IsDisabled)
596                  .Should().ContainInConsecutiveOrder(expectedResult);
597          }
598          [Test]
599          public void IsDateDisabledFunc_SettingDateToADisabledDateYieldsNull()
600          {
601              var wasEventCallbackCalled = false;
602              Func<DateTime, bool> isDisabledFunc = date => true;
603              var comp = Context.RenderComponent<MudDatePicker>(
604                  Parameter(nameof(MudDatePicker.IsDateDisabledFunc), isDisabledFunc),
605                  EventCallback("DateChanged", (DateTime? _) => wasEventCallbackCalled = true)
606              );
607              comp.SetParam(picker => picker.Date, DateTime.Now);
608              comp.Instance.Date.Should().BeNull();
609              wasEventCallbackCalled.Should().BeFalse();
610          }
611          [Test]
612          public void IsDateDisabledFunc_SettingDateToAnEnabledDateYieldsTheDate()
613          {
614              var wasEventCallbackCalled = false;
615              var today = DateTime.Today;
616              Func<DateTime, bool> isDisabledFunc = date => date < today;
617              var comp = Context.RenderComponent<MudDatePicker>(
618                  Parameter(nameof(MudDatePicker.IsDateDisabledFunc), isDisabledFunc),
619                  EventCallback("DateChanged", (DateTime? _) => wasEventCallbackCalled = true)
620              );
621              comp.SetParam(picker => picker.Date, today);
622              comp.Instance.Date.Should().Be(today);
623              wasEventCallbackCalled.Should().BeTrue();
624          }
625          [Test]
626          public void IsDateDisabledFunc_NoDisabledDatesByDefault()
627          {
628              var comp = OpenPicker();
629              comp.FindAll("button.mud-picker-calendar-day").Select(button => ((IHtmlButtonElement)button).IsDisabled)
630                  .Should().OnlyContain(disabled => disabled == false);
631          }
632          [Test]
633          public void MonthButtons_ButtonRootClassPresent()
634          {
635              var comp = OpenPicker(Parameter(nameof(MudDatePicker.FixDay), 1));
636              var monthsCount = 12;
637              comp.FindAll("button.mud-picker-month").Select(button =>
638                  ((IHtmlButtonElement)button).ClassName.Contains("mud-button-root"))
639                  .Should().HaveCount(monthsCount);
640          }
641          [Test]
642          public void AdditionalDateClassesFunc_ClassIsAdded()
643          {
644              Func<DateTime, string> additionalDateClassesFunc = date => "__addedtestclass__";
645              var comp = Context.RenderComponent<MudDatePicker>(
646                  Parameter(nameof(MudDatePicker.AdditionalDateClassesFunc), additionalDateClassesFunc));
647              var daysCount = comp.FindAll("button.mud-picker-calendar-day").Select(button =>
648                  ((IHtmlBaseElement)button)).Count();
649              comp.FindAll("button.mud-picker-calendar-day").Select(button =>
650                  ((IHtmlBaseElement)button).ClassName.Contains("__addedtestclass__"))
651                  .Should().HaveCount(daysCount);
652          }
653          public async Task CheckAutoCloseDatePickerTest()
654          {
655              var now = new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day);
656              var comp = Context.RenderComponent<AutoCompleteDatePickerTest>();
657              var datePicker = comp.FindComponent<MudDatePicker>();
658              await comp.InvokeAsync(() => datePicker.Instance.Open());
659              if (now.Day != 20)
660              {
661                  comp.FindAll("button.mud-picker-calendar-day")
662                      .Where(x => x.TrimmedText().Equals("20")).First().Click();
663              }
664              else
665              {
666                  comp.FindAll("button.mud-picker-calendar-day")
667                      .Where(x => x.TrimmedText().Equals("19")).First().Click();
668              }
669              datePicker.Instance.Date.Should().Be(now);
670              await comp.InvokeAsync(() => datePicker.Instance.Close(false));
671              await comp.InvokeAsync(() => datePicker.Instance.Open());
672              comp.WaitForAssertion(() => comp.FindAll("div.mud-popover").Count.Should().Be(1));
673              await comp.InvokeAsync(() => datePicker.Instance.Clear());
674              comp.WaitForAssertion(() => comp.FindAll("div.mud-popover").Count.Should().Be(1));
675              await comp.InvokeAsync(() => datePicker.Instance.Close(false));
676              datePicker.Instance.AutoClose = true;
677              await comp.InvokeAsync(() => datePicker.Instance.Open());
678              if (now.Day != 20)
679              {
680                  comp.FindAll("button.mud-picker-calendar-day")
681                      .Where(x => x.TrimmedText().Equals("20")).First().Click();
682              }
683              else
684              {
685                  comp.FindAll("button.mud-picker-calendar-day")
686                      .Where(x => x.TrimmedText().Equals("19")).First().Click();
687              }
688              if (now.Day != 20)
689              {
690                  datePicker.Instance.Date.Should().Be(new DateTime(now.Year, now.Month, 20));
691              }
692              else
693              {
694                  datePicker.Instance.Date.Should().Be(new DateTime(now.Year, now.Month, 19));
695              }
696              await comp.InvokeAsync(() => datePicker.Instance.Open());
697              comp.WaitForAssertion(() => comp.FindAll("div.mud-popover").Count.Should().Be(1));
698              await comp.InvokeAsync(() => datePicker.Instance.Clear());
699              comp.WaitForAssertion(() => comp.FindAll("div.mud-popover").Count.Should().Be(0));
700          }
701          [Test]
702          public async Task CheckReadOnlyTest()
703          {
704              var now = new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day);
705              var comp = Context.RenderComponent<SimpleMudDatePickerTest>();
706              var picker = comp.Instance;
707              await picker.Open();
708              if (now.Day != 20)
709              {
710                  comp.FindAll("button.mud-picker-calendar-day")
711                      .Where(x => x.TrimmedText().Equals("20")).First().Click();
712              }
713              else
714              {
715                  comp.FindAll("button.mud-picker-calendar-day")
716                      .Where(x => x.TrimmedText().Equals("19")).First().Click();
717              }
718              await picker.Close();
719              if (now.Day != 20)
720              {
721                  picker.Date.Should().Be(new DateTime(now.Year, now.Month, 20));
722              }
723              else
724              {
725                  picker.Date.Should().Be(new DateTime(now.Year, now.Month, 19));
726              }
727              now = picker.Date.Value;
728              comp.SetParametersAndRender(p => p.Add(x => x.Readonly, true));
729              await picker.Open();
730              if (now.Day != 21)
731              {
732                  comp.FindAll("button.mud-picker-calendar-day")
733                      .Where(x => x.TrimmedText().Equals("22")).First().Click();
734              }
735              else
736              {
737                  comp.FindAll("button.mud-picker-calendar-day")
738                      .Where(x => x.TrimmedText().Equals("21")).First().Click();
739              }
740              await picker.Close();
741              picker.Date.Should().Be(now);
742          }
743          [Test]
744          public async Task CheckDateTimeMinValueTest()
745          {
746              var date = DateTime.MinValue;
747              var comp = Context.RenderComponent<DateTimeMinValueDatePickerTest>();
748              var datePicker = comp.FindComponent<MudDatePicker>();
749              var picker = comp.Instance;
750              await comp.InvokeAsync(() => datePicker.Instance.Open());
751              comp.FindAll("button.mud-picker-calendar-day").Where(x => x.TrimmedText().Equals("1")).First().Click();
752          }
753          [TestCase(false)]
754          [TestCase(true)]
755          [Test]
756          public void CheckButtonTypeTest(bool navigateToMonthSelection)
757          {
758              var dateComp = Context.RenderComponent<MudDatePicker>(p =>
759              p.Add(x => x.PickerVariant, PickerVariant.Dialog));
760              dateComp.Find(".mud-picker input").Click();
761              if (navigateToMonthSelection)
762              {
763                  dateComp.Find(".mud-picker button.mud-picker-calendar-header-transition").Click();
764              }
765              var buttons = dateComp.FindAll(".mud-picker button");
766              foreach (var button in buttons)
767              {
768                  button.ToMarkup().Contains("type=\"button\"").Should().BeTrue();
769              }
770          }
771          [Test]
772          public async Task DatePickerTest_Editable()
773          {
774              var comp = Context.RenderComponent<SimpleMudDatePickerTest>();
775              CultureInfo cultureInfo = new CultureInfo("en-US");
776              var datePicker = comp.FindComponent<MudDatePicker>().Instance;
777              datePicker.Editable = true;
778              datePicker.Culture = cultureInfo;
779              await comp.InvokeAsync(() => comp.Find("input").Change("10/10/2020"));
780              comp.WaitForAssertion(() => datePicker.Date.Should().Be(new DateTime(2020, 10, 10)));
781              comp.WaitForAssertion(() => datePicker.PickerMonth.Should().Be(null));
782              await comp.InvokeAsync(() => datePicker.Open());
783              comp.WaitForAssertion(() => datePicker.PickerMonth.Should().Be(new DateTime(2020, 10, 01)));
784          }
785          [Test]
786          public async Task DatePickerTest_KeyboardNavigation()
787          {
788              var comp = Context.RenderComponent<SimpleMudDatePickerTest>();
789              var datePicker = comp.FindComponent<MudDatePicker>().Instance;
790              await comp.InvokeAsync(() => datePicker.HandleKeyDown(new KeyboardEventArgs() { Key = "Enter", Type = "keydown", }));
791              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(1));
792              await comp.InvokeAsync(() => datePicker.HandleKeyDown(new KeyboardEventArgs() { Key = "Escape", Type = "keydown", }));
793              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(0));
794              await comp.InvokeAsync(() => datePicker.HandleKeyDown(new KeyboardEventArgs() { Key = " ", Type = "keydown", }));
795              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(1));
796              await comp.InvokeAsync(() => datePicker.HandleKeyDown(new KeyboardEventArgs() { Key = " ", Type = "keydown", }));
797              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(0));
798              await comp.InvokeAsync(() => datePicker.HandleKeyDown(new KeyboardEventArgs() { Key = "ArrowDown", AltKey = true, Type = "keydown", }));
799              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(1));
800              await comp.InvokeAsync(() => datePicker.HandleKeyDown(new KeyboardEventArgs() { Key = "ArrowUp", AltKey = true, Type = "keydown", }));
801              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(0));
802              await comp.InvokeAsync(() => datePicker.HandleKeyDown(new KeyboardEventArgs() { Key = "NumpadEnter", Type = "keydown", }));
803              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(1));
804              await comp.InvokeAsync(() => datePicker.HandleKeyDown(new KeyboardEventArgs() { Key = "Tab", Type = "keydown", }));
805              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(0));
806              datePicker.Disabled = true;
807              await comp.InvokeAsync(() => datePicker.HandleKeyDown(new KeyboardEventArgs() { Key = "Enter", Type = "keydown", }));
808              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(0));
809              await comp.InvokeAsync(() => datePicker.ToggleOpen());
810              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(1));
811              await comp.InvokeAsync(() => datePicker.ToggleOpen());
812              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(0));
813              await comp.InvokeAsync(() => datePicker.ToggleState());
814              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(0));
815              datePicker.Disabled = false;
816              await comp.InvokeAsync(() => datePicker.HandleKeyDown(new KeyboardEventArgs() { Key = "NumpadEnter", Type = "keydown", }));
817              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(1));
818              await comp.InvokeAsync(() => datePicker.ToggleState());
819              comp.WaitForAssertion(() => comp.FindAll("div.mud-picker-open").Count.Should().Be(1));
820          }
821          [Test]
822          public async Task DatePickerTest_GoToDate()
823          {
824              var comp = Context.RenderComponent<SimpleMudDatePickerTest>();
825              var datePicker = comp.FindComponent<MudDatePicker>().Instance;
826              await comp.InvokeAsync(() => datePicker.GoToDate(new DateTime(2022, 03, 20)));
827              comp.WaitForAssertion(() => datePicker.Date.Should().Be(new DateTime(2022, 03, 20)));
828              await comp.InvokeAsync(() => datePicker.GoToDate(new DateTime(2023, 04, 21), false));
829              comp.WaitForAssertion(() => datePicker.Date.Should().Be(new DateTime(2022, 03, 20)));
830              await comp.InvokeAsync(() => datePicker.GoToDate(new DateTime(2023, 04, 21)));
831              comp.WaitForAssertion(() => datePicker.Date.Should().Be(new DateTime(2023, 04, 21)));
832              await comp.InvokeAsync(() => datePicker.GoToDate());
833              comp.WaitForAssertion(() => datePicker.Date.Should().Be(new DateTime(2023, 04, 21)));
834          }
835          [Test]
836          public async Task DatePickerTest_CheckIfMonthsAreDisabled()
837          {
838              var comp = Context.RenderComponent<SimpleMudDatePickerTest>();
839              var datePicker = comp.FindComponent<MudDatePicker>().Instance;
840              datePicker.MinDate = DateTime.Now.AddDays(-1);
841              datePicker.MaxDate = DateTime.Now.AddDays(1);
842              await comp.InvokeAsync(datePicker.Open);
843              comp.Find("button.mud-button-month").Click();
844              comp.WaitForAssertion(() => comp.FindAll("button.mud-picker-month").Any(x => x.IsDisabled()).Should().Be(true));
845              comp.FindAll("button.mud-picker-month").First(x => x.IsDisabled()).Click();
846              var months = comp.FindAll("button.mud-picker-month");
847              months.Should().NotBeNull();
848              comp.Instance.Date.Should().BeNull();
849          }
850      }
851  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-DefaultAuthorizationServiceTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from MudBlazor-MDEwOlJlcG9zaXRvcnkyODg0Mjg2NzY=-flat-DatePickerTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>42              var allowed = await authorizationService.AuthorizeAsync(user, "Basic");
43              Assert.True(allowed.Succeeded);
44          }
45          [Fact]
46          public async Task Authorize_ShouldAllowIfClaimIsPresentWithSpecifiedAuthType()
47          {
48              var authorizationService = BuildAuthorizationService(services =>
49              {
50                  services.AddAuthorization(options =>
51                  {
52                      options.AddPolicy("Basic", policy => {
53                          policy.AddAuthenticationSchemes("Basic");
54                          policy.RequireClaim("Permission", "CanViewPage");
</pre></code></div>
                <div class="column column_space"><pre><code>249              comp.FindAll("div.mud-picker-month-container").Count.Should().Be(1);
250          }
251          [Test]
252          public void OpenToYear_ClickYear_CheckMonthsShown_Close_Reopen_CheckYearsShown()
253          {
254              var comp = OpenPicker(Parameter("OpenTo", OpenTo.Year));
255              comp.Instance.Date.Should().BeNull();
256              comp.FindAll("div.mud-picker-year-container").Count.Should().Be(1);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    