
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 163, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-Startup_8.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Linq;
4  using System.Text.Encodings.Web;
5  using System.Threading.Tasks;
6  using Microsoft.AspNetCore.Authentication;
7  using Microsoft.AspNetCore.Authentication.Cookies;
8  using Microsoft.AspNetCore.Authentication.WsFederation;
9  using Microsoft.AspNetCore.Builder;
10  using Microsoft.AspNetCore.Http;
11  using Microsoft.Extensions.Configuration;
12  using Microsoft.Extensions.DependencyInjection;
13  namespace WsFedSample
14  {
15      public class Startup
16      {
17          public Startup(IConfiguration configuration)
18          {
19              Configuration = configuration;
20          }
21          public IConfiguration Configuration { get; }
22          public void ConfigureServices(IServiceCollection services)
23          {
24              services.AddAuthentication(sharedOptions =>
25              {
26                  sharedOptions.DefaultScheme = CookieAuthenticationDefaults.AuthenticationScheme;
27                  sharedOptions.DefaultSignInScheme = CookieAuthenticationDefaults.AuthenticationScheme;
28                  sharedOptions.DefaultChallengeScheme = WsFederationDefaults.AuthenticationScheme;
29              })
30              .AddWsFederation(options =>
31              {
32                  options.Wtrealm = "https:&bsol;&bsol;Tratcheroutlook.onmicrosoft.com/WsFedSample";
33                  options.MetadataAddress = "https:&bsol;&bsol;login.windows.net/cdc690f9-b6b8-4023-813a-bae7143d1f87/FederationMetadata/2007-06/FederationMetadata.xml";
34              })
35              .AddCookie();
36          }
37          public void Configure(IApplicationBuilder app)
38          {
39              app.UseDeveloperExceptionPage();
40              app.UseAuthentication();
41              app.Run(async context =>
42              {
43                  if (context.Request.Path.Equals("/signedout"))
44                  {
45                      await WriteHtmlAsync(context.Response, async res =>
46                      {
47                          await res.WriteAsync($"<h1>You have been signed out.</h1>");
48                          await res.WriteAsync("<a class=\"btn btn-link\" href=\"/\">Sign In</a>");
49                      });
50                      return;
51                  }
52                  if (context.Request.Path.Equals("/signout"))
53                  {
54                      await context.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
55                      await WriteHtmlAsync(context.Response, async res =>
56                      {
57                          await context.Response.WriteAsync($"<h1>Signed out {HtmlEncode(context.User.Identity.Name)}</h1>");
58                          await context.Response.WriteAsync("<a class=\"btn btn-link\" href=\"/\">Sign In</a>");
59                      });
60                      return;
61                  }
62                  if (context.Request.Path.Equals("/signout-remote"))
63                  {
64                      await context.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
65                      await context.SignOutAsync(WsFederationDefaults.AuthenticationScheme, new AuthenticationProperties()
66                      {
67                          RedirectUri = "/signedout"
68                      });
69                      return;
70                  }
71                  if (context.Request.Path.Equals("/Account/AccessDenied"))
72                  {
73                      await WriteHtmlAsync(context.Response, async res =>
74                      {
75                          await context.Response.WriteAsync($"<h1>Access Denied for user {HtmlEncode(context.User.Identity.Name)} to resource '{HtmlEncode(context.Request.Query["ReturnUrl"])}'</h1>");
76                          await context.Response.WriteAsync("<a class=\"btn btn-link\" href=\"/signout\">Sign Out</a>");
77                      });
78                      return;
79                  }
80                  var user = context.User;
81                  if (user == null || !user.Identities.Any(identity => identity.IsAuthenticated))
82                  {
83                      await context.ChallengeAsync();
84                      return;
85                  }
86                  if (context.Request.Path.Equals("/restricted") && !user.Identities.Any(identity => identity.HasClaim("special", "true")))
87                  {
88                      await context.ForbidAsync();
89                      return;
90                  }
91                  await WriteHtmlAsync(context.Response, async response =>
92                  {
93                      await response.WriteAsync($"<h1>Hello Authenticated User {HtmlEncode(user.Identity.Name)}</h1>");
94                      await response.WriteAsync("<a class=\"btn btn-default\" href=\"/restricted\">Restricted</a>");
95                      await response.WriteAsync("<a class=\"btn btn-default\" href=\"/signout\">Sign Out</a>");
96                      await response.WriteAsync("<a class=\"btn btn-default\" href=\"/signout-remote\">Sign Out Remote</a>");
97                      await response.WriteAsync("<h2>Claims:</h2>");
98                      await WriteTableHeader(response, new string[] { "Claim Type", "Value" }, context.User.Claims.Select(c => new string[] { c.Type, c.Value }));
99                  });
100              });
101          }
102          private static async Task WriteHtmlAsync(HttpResponse response, Func<HttpResponse, Task> writeContent)
103          {
104              var bootstrap = "<link rel=\"stylesheet\" href=\"https:&bsol;&bsol;maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css\" integrity=\"sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u\" crossorigin=\"anonymous\">";
105              response.ContentType = "text/html";
106              await response.WriteAsync($"<html><head>{bootstrap}</head><body><div class=\"container\">");
<span onclick='openModal()' class='match'>107              await writeContent(response);
108              await response.WriteAsync("</div></body></html>");
109          }
110          private static async Task WriteTableHeader(HttpResponse response, IEnumerable<string> columns, IEnumerable<IEnumerable<string>> data)
111          {
112              await response.WriteAsync("<table class=\"table table-condensed\">");
113              await response.WriteAsync("<tr>");
114              foreach (var column in columns)
115              {
116                  await response.WriteAsync($"<th>{HtmlEncode(column)}</th>");
117              }
118              await response.WriteAsync("</tr>");
119              foreach (var row in data)
120              {
121                  await response.WriteAsync("<tr>");
122                  foreach (var column in row)
123                  {
124                      await response.WriteAsync($"<td>{HtmlEncode(column)}</td>");
125                  }
126                  await response.WriteAsync("</tr>");
127              }
128              await response.WriteAsync("</table>");
129          }
130          private static string HtmlEncode(string content) =>
131              string.IsNullOrEmpty(content) ? string.Empty : HtmlEncoder.Default.Encode(content);
132      }
133  }
</span></code></pre>
        </div>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-Startup.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Globalization;
4  using System.IdentityModel.Tokens.Jwt;
5  using System.Linq;
6  using System.Net.Http;
7  using System.Text.Encodings.Web;
8  using System.Threading.Tasks;
9  using Microsoft.AspNetCore.Authentication;
10  using Microsoft.AspNetCore.Authentication.Cookies;
11  using Microsoft.AspNetCore.Authentication.OpenIdConnect;
12  using Microsoft.AspNetCore.Builder;
13  using Microsoft.AspNetCore.Hosting;
14  using Microsoft.AspNetCore.Http;
15  using Microsoft.Extensions.Configuration;
16  using Microsoft.Extensions.DependencyInjection;
17  using Microsoft.Extensions.Options;
18  using Microsoft.IdentityModel.Protocols.OpenIdConnect;
19  using Newtonsoft.Json.Linq;
20  namespace OpenIdConnectSample
21  {
22      public class Startup
23      {
24          public Startup(IHostingEnvironment env)
25          {
26              Environment = env;
27              var builder = new ConfigurationBuilder()
28                  .SetBasePath(env.ContentRootPath);
29              if (env.IsDevelopment())
30              {
31                  builder.AddUserSecrets<Startup>();
32              }
33              builder.AddEnvironmentVariables();
34              Configuration = builder.Build();
35          }
36          public IConfiguration Configuration { get; set; }
37          public IHostingEnvironment Environment { get; set; }
38          public void ConfigureServices(IServiceCollection services)
39          {
40              JwtSecurityTokenHandler.DefaultInboundClaimTypeMap.Clear();
41              services.AddAuthentication(sharedOptions =>
42              {
43                  sharedOptions.DefaultAuthenticateScheme = CookieAuthenticationDefaults.AuthenticationScheme;
44                  sharedOptions.DefaultSignInScheme = CookieAuthenticationDefaults.AuthenticationScheme;
45                  sharedOptions.DefaultChallengeScheme = OpenIdConnectDefaults.AuthenticationScheme;
46              })
47                  .AddCookie()
48                  .AddOpenIdConnect(o =>
49              {
50                  o.ClientId = Configuration["oidc:clientid"];
51                  o.ClientSecret = Configuration["oidc:clientsecret"]; 
52                  o.Authority = Configuration["oidc:authority"];
53                  o.ResponseType = OpenIdConnectResponseType.CodeIdToken;
54                  o.SaveTokens = true;
55                  o.GetClaimsFromUserInfoEndpoint = true;
56                  o.AccessDeniedPath = "/access-denied-from-remote";
57                  o.ClaimActions.MapAllExcept("aud", "iss", "iat", "nbf", "exp", "aio", "c_hash", "uti", "nonce");
58                  o.Events = new OpenIdConnectEvents()
59                  {
60                      OnAuthenticationFailed = c =>
61                      {
62                          c.HandleResponse();
63                          c.Response.StatusCode = 500;
64                          c.Response.ContentType = "text/plain";
65                          if (Environment.IsDevelopment())
66                          {
67                              return c.Response.WriteAsync(c.Exception.ToString());
68                          }
69                          return c.Response.WriteAsync("An error occurred processing your authentication.");
70                      }
71                  };
72              });
73          }
74          public void Configure(IApplicationBuilder app, IOptionsMonitor<OpenIdConnectOptions> optionsMonitor)
75          {
76              app.UseDeveloperExceptionPage();
77              app.UseAuthentication();
78              app.Run(async context =>
79              {
80                  var response = context.Response;
81                  if (context.Request.Path.Equals("/signedout"))
82                  {
83                      await WriteHtmlAsync(response, async res =>
84                      {
85                          await res.WriteAsync($"<h1>You have been signed out.</h1>");
86                          await res.WriteAsync("<a class=\"btn btn-default\" href=\"/\">Home</a>");
87                      });
88                      return;
89                  }
90                  if (context.Request.Path.Equals("/signout"))
91                  {
92                      await context.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
93                      await WriteHtmlAsync(response, async res =>
94                      {
95                          await res.WriteAsync($"<h1>Signed out {HtmlEncode(context.User.Identity.Name)}</h1>");
96                          await res.WriteAsync("<a class=\"btn btn-default\" href=\"/\">Home</a>");
97                      });
98                      return;
99                  }
100                  if (context.Request.Path.Equals("/signout-remote"))
101                  {
102                      await context.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
103                      await context.SignOutAsync(OpenIdConnectDefaults.AuthenticationScheme, new AuthenticationProperties()
104                      {
105                          RedirectUri = "/signedout"
106                      });
107                      return;
108                  }
109                  if (context.Request.Path.Equals("/access-denied-from-remote"))
110                  {
111                      await WriteHtmlAsync(response, async res =>
112                      {
113                          await res.WriteAsync($"<h1>Access Denied error received from the remote authorization server</h1>");
114                          await res.WriteAsync("<a class=\"btn btn-default\" href=\"/\">Home</a>");
115                      });
116                      return;
117                  }
118                  if (context.Request.Path.Equals("/Account/AccessDenied"))
119                  {
120                      await context.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
121                      await WriteHtmlAsync(response, async res =>
122                      {
123                          await res.WriteAsync($"<h1>Access Denied for user {HtmlEncode(context.User.Identity.Name)} to resource '{HtmlEncode(context.Request.Query["ReturnUrl"])}'</h1>");
124                          await res.WriteAsync("<a class=\"btn btn-default\" href=\"/signout\">Sign Out</a>");
125                          await res.WriteAsync("<a class=\"btn btn-default\" href=\"/\">Home</a>");
126                      });
127                      return;
128                  }
129                  var userResult = await context.AuthenticateAsync();
130                  var user = userResult.Principal;
131                  var props = userResult.Properties;
132                  if (user == null || !user.Identities.Any(identity => identity.IsAuthenticated))
133                  {
134                      await context.ChallengeAsync();
135                      return;
136                  }
137                  if (context.Request.Path.Equals("/restricted") && !user.Identities.Any(identity => identity.HasClaim("special", "true")))
138                  {
139                      await context.ForbidAsync();
140                      return;
141                  }
142                  if (context.Request.Path.Equals("/refresh"))
143                  {
144                      var refreshToken = props.GetTokenValue("refresh_token");
145                      if (string.IsNullOrEmpty(refreshToken))
146                      {
147                          await WriteHtmlAsync(response, async res =>
148                          {
149                              await res.WriteAsync($"No refresh_token is available.<br>");
150                              await res.WriteAsync("<a class=\"btn btn-link\" href=\"/signout\">Sign Out</a>");
151                          });
152                          return;
153                      }
154                      var options = optionsMonitor.Get(OpenIdConnectDefaults.AuthenticationScheme);
155                      var metadata = await options.ConfigurationManager.GetConfigurationAsync(context.RequestAborted);
156                      var pairs = new Dictionary<string, string>()
157                      {
158                          { "client_id", options.ClientId },
159                          { "client_secret", options.ClientSecret },
160                          { "grant_type", "refresh_token" },
161                          { "refresh_token", refreshToken }
162                      };
163                      var content = new FormUrlEncodedContent(pairs);
164                      var tokenResponse = await options.Backchannel.PostAsync(metadata.TokenEndpoint, content, context.RequestAborted);
165                      tokenResponse.EnsureSuccessStatusCode();
166                      var payload = JObject.Parse(await tokenResponse.Content.ReadAsStringAsync());
167                      props.UpdateTokenValue("access_token", payload.Value<string>("access_token"));
168                      props.UpdateTokenValue("refresh_token", payload.Value<string>("refresh_token"));
169                      if (int.TryParse(payload.Value<string>("expires_in"), NumberStyles.Integer, CultureInfo.InvariantCulture, out var seconds))
170                      {
171                          var expiresAt = DateTimeOffset.UtcNow + TimeSpan.FromSeconds(seconds);
172                          props.UpdateTokenValue("expires_at", expiresAt.ToString("o", CultureInfo.InvariantCulture));
173                      }
174                      await context.SignInAsync(user, props);
175                      await WriteHtmlAsync(response, async res =>
176                      {
177                          await res.WriteAsync($"<h1>Refreshed.</h1>");
178                          await res.WriteAsync("<a class=\"btn btn-default\" href=\"/refresh\">Refresh tokens</a>");
179                          await res.WriteAsync("<a class=\"btn btn-default\" href=\"/\">Home</a>");
180                          await res.WriteAsync("<h2>Tokens:</h2>");
181                          await WriteTableHeader(res, new string[] { "Token Type", "Value" }, props.GetTokens().Select(token => new string[] { token.Name, token.Value }));
182                          await res.WriteAsync("<h2>Payload:</h2>");
183                          await res.WriteAsync(HtmlEncoder.Default.Encode(payload.ToString()).Replace(",", ",<br>") + "<br>");
184                      });
185                      return;
186                  }
187                  if (context.Request.Path.Equals("/login-challenge"))
188                  {
189                      await context.ChallengeAsync(OpenIdConnectDefaults.AuthenticationScheme, new OpenIdConnectChallengeProperties()
190                      {
191                          Prompt = "login",
192                      });
193                      return;
194                  }
195                  await WriteHtmlAsync(response, async res =>
196                  {
197                      await res.WriteAsync($"<h1>Hello Authenticated User {HtmlEncode(user.Identity.Name)}</h1>");
198                      await res.WriteAsync("<a class=\"btn btn-default\" href=\"/refresh\">Refresh tokens</a>");
199                      await res.WriteAsync("<a class=\"btn btn-default\" href=\"/restricted\">Restricted</a>");
200                      await res.WriteAsync("<a class=\"btn btn-default\" href=\"/login-challenge\">Login challenge</a>");
201                      await res.WriteAsync("<a class=\"btn btn-default\" href=\"/signout\">Sign Out</a>");
202                      await res.WriteAsync("<a class=\"btn btn-default\" href=\"/signout-remote\">Sign Out Remote</a>");
203                      await res.WriteAsync("<h2>Claims:</h2>");
204                      await WriteTableHeader(res, new string[] { "Claim Type", "Value" }, context.User.Claims.Select(c => new string[] { c.Type, c.Value }));
205                      await res.WriteAsync("<h2>Tokens:</h2>");
206                      await WriteTableHeader(res, new string[] { "Token Type", "Value" }, props.GetTokens().Select(token => new string[] { token.Name, token.Value }));
207                  });
208              });
209          }
210          private static async Task WriteHtmlAsync(HttpResponse response, Func<HttpResponse, Task> writeContent)
211          {
212              var bootstrap = "<link rel=\"stylesheet\" href=\"https:&bsol;&bsol;maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css\" integrity=\"sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u\" crossorigin=\"anonymous\">";
213              response.ContentType = "text/html";
214              await response.WriteAsync($"<html><head>{bootstrap}</head><body><div class=\"container\">");
<span onclick='openModal()' class='match'>215              await writeContent(response);
216              await response.WriteAsync("</div></body></html>");
217          }
218          private static async Task WriteTableHeader(HttpResponse response, IEnumerable<string> columns, IEnumerable<IEnumerable<string>> data)
219          {
220              await response.WriteAsync("<table class=\"table table-condensed\">");
221              await response.WriteAsync("<tr>");
222              foreach (var column in columns)
223              {
224                  await response.WriteAsync($"<th>{HtmlEncode(column)}</th>");
225              }
226              await response.WriteAsync("</tr>");
227              foreach (var row in data)
228              {
229                  await response.WriteAsync("<tr>");
230                  foreach (var column in row)
231                  {
232                      await response.WriteAsync($"<td>{HtmlEncode(column)}</td>");
233                  }
234                  await response.WriteAsync("</tr>");
235              }
236              await response.WriteAsync("</table>");
237          }
238          private static string HtmlEncode(string content) =>
239              string.IsNullOrEmpty(content) ? string.Empty : HtmlEncoder.Default.Encode(content);
240      }
241  }
</span></code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-Startup_8.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-Startup.cs</div>
                </div>
                <div class="column column_space"><pre><code>107              await writeContent(response);
108              await response.WriteAsync("</div></body></html>");
109          }
110          private static async Task WriteTableHeader(HttpResponse response, IEnumerable<string> columns, IEnumerable<IEnumerable<string>> data)
111          {
112              await response.WriteAsync("<table class=\"table table-condensed\">");
113              await response.WriteAsync("<tr>");
114              foreach (var column in columns)
115              {
116                  await response.WriteAsync($"<th>{HtmlEncode(column)}</th>");
117              }
118              await response.WriteAsync("</tr>");
119              foreach (var row in data)
120              {
121                  await response.WriteAsync("<tr>");
122                  foreach (var column in row)
123                  {
124                      await response.WriteAsync($"<td>{HtmlEncode(column)}</td>");
125                  }
126                  await response.WriteAsync("</tr>");
127              }
128              await response.WriteAsync("</table>");
129          }
130          private static string HtmlEncode(string content) =>
131              string.IsNullOrEmpty(content) ? string.Empty : HtmlEncoder.Default.Encode(content);
132      }
133  }
</pre></code></div>
                <div class="column column_space"><pre><code>215              await writeContent(response);
216              await response.WriteAsync("</div></body></html>");
217          }
218          private static async Task WriteTableHeader(HttpResponse response, IEnumerable<string> columns, IEnumerable<IEnumerable<string>> data)
219          {
220              await response.WriteAsync("<table class=\"table table-condensed\">");
221              await response.WriteAsync("<tr>");
222              foreach (var column in columns)
223              {
224                  await response.WriteAsync($"<th>{HtmlEncode(column)}</th>");
225              }
226              await response.WriteAsync("</tr>");
227              foreach (var row in data)
228              {
229                  await response.WriteAsync("<tr>");
230                  foreach (var column in row)
231                  {
232                      await response.WriteAsync($"<td>{HtmlEncode(column)}</td>");
233                  }
234                  await response.WriteAsync("</tr>");
235              }
236              await response.WriteAsync("</table>");
237          }
238          private static string HtmlEncode(string content) =>
239              string.IsNullOrEmpty(content) ? string.Empty : HtmlEncoder.Default.Encode(content);
240      }
241  }
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    