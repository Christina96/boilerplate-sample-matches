
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 27, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-CommonLogicalReplicationTests.cs</h3>
            <pre><code>1  using System;
2  using System.Data;
3  using System.Threading.Tasks;
4  using NUnit.Framework;
5  using Npgsql.Replication;
6  using Npgsql.Replication.Internal;
7  using NpgsqlTypes;
8  namespace Npgsql.Tests.Replication;
9  [Platform(Exclude = "MacOsX", Reason = "Replication tests are flaky in CI on Mac")]
10  [NonParallelizable]
11  public class CommonLogicalReplicationTests : SafeReplicationTestBase<LogicalReplicationConnection>
12  {
13      const string OutputPlugin = "test_decoding";
14      [Test]
15      public Task CreateLogicalReplicationSlot([Values]bool temporary, [Values]bool twoPhase)
16          => SafeReplicationTest(
17              async (slotName, _) =>
18              {
19                  await using var c = await OpenConnectionAsync();
20                  if (twoPhase)
21                      TestUtil.MinimumPgVersion(c, "15.0", "Replication slots with two phase commit support were introduced in PostgreSQL 15");
22                  if (temporary)
23                      TestUtil.MinimumPgVersion(c, "10.0", "Temporary replication slots were introduced in PostgreSQL 10");
24                  await using var rc = await OpenReplicationConnectionAsync();
25                  var options = await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin, temporary, twoPhase: twoPhase);
26                  using var cmd =
27                      new NpgsqlCommand($"SELECT * FROM pg_replication_slots WHERE slot_name = '{options.SlotName}'",
28                          c);
29                  await using var reader = await cmd.ExecuteReaderAsync();
30                  Assert.That(reader.Read, Is.True);
31                  Assert.That(reader.GetFieldValue<string>(reader.GetOrdinal("slot_type")), Is.EqualTo("logical"));
32                  if (c.PostgreSqlVersion >= Version.Parse("15.0"))
<span onclick='openModal()' class='match'>33                      Assert.That(reader.GetFieldValue<bool>(reader.GetOrdinal("two_phase")), Is.EqualTo(twoPhase));
34                  if (c.PostgreSqlVersion >= Version.Parse("10.0"))
</span>35                      Assert.That(reader.GetFieldValue<bool>(reader.GetOrdinal("temporary")), Is.EqualTo(temporary));
36                  Assert.That(reader.GetFieldValue<bool>(reader.GetOrdinal("active")), Is.EqualTo(temporary));
37                  if (c.PostgreSqlVersion >= Version.Parse("9.6"))
38                      Assert.That(reader.GetFieldValue<NpgsqlLogSequenceNumber>(reader.GetOrdinal("confirmed_flush_lsn")),
39                          Is.EqualTo(options.ConsistentPoint));
40                  Assert.That(reader.Read, Is.False);
41              }, nameof(CreateLogicalReplicationSlot) + (temporary ? "_tmp" : "") + (twoPhase ? "_tp" : ""));
42      [Test]
43      public Task CreateLogicalReplicationSlot_NoExport([Values]bool temporary, [Values]bool twoPhase)
44          => SafeReplicationTest(
45              async (slotName, _) =>
46              {
47                  await using var c = await OpenConnectionAsync();
48                  if (temporary)
49                      TestUtil.MinimumPgVersion(c, "10.0", "Temporary replication slots were introduced in PostgreSQL 10");
50                  if (twoPhase)
51                      TestUtil.MinimumPgVersion(c, "15.0", "Replication slots with two phase commit support were introduced in PostgreSQL 15");
52                  TestUtil.MinimumPgVersion(c, "10.0", "The *_SNAPSHOT syntax was introduced in PostgreSQL 10");
53                  await using var rc = await OpenReplicationConnectionAsync();
54                  var options = await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin, temporary, LogicalSlotSnapshotInitMode.NoExport, twoPhase);
55                  Assert.That(options.SnapshotName, Is.Null);
56              }, nameof(CreateLogicalReplicationSlot_NoExport) + (temporary ? "_tmp" : "") + (twoPhase ? "_tp" : ""));
57      [Test(Description = "Tests whether we throw a helpful exception about the unsupported *_SNAPSHOT syntax on old servers.")]
58      [TestCase(LogicalSlotSnapshotInitMode.Export)]
59      [TestCase(LogicalSlotSnapshotInitMode.NoExport)]
60      [TestCase(LogicalSlotSnapshotInitMode.Use)]
61      public Task CreateLogicalReplicationSlot_with_SnapshotInitMode_on_old_postgres_throws(LogicalSlotSnapshotInitMode mode)
62          => SafeReplicationTest(
63              async (slotName, _) =>
64              {
65                  await using var c = await OpenConnectionAsync();
66                  TestUtil.MaximumPgVersionExclusive(c, "10.0", "The *_SNAPSHOT syntax was introduced in PostgreSQL 10");
67                  Assert.That(async () =>
68                  {
69                      await using var rc = await OpenReplicationConnectionAsync();
70                      await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin, slotSnapshotInitMode: mode);
71                  }, Throws.InstanceOf<NotSupportedException>()
72                      .With.Message.StartsWith("The EXPORT_SNAPSHOT, USE_SNAPSHOT and NOEXPORT_SNAPSHOT syntax was introduced in PostgreSQL")
73                      .And.InnerException.TypeOf<PostgresException>()
74                      .And.InnerException.Property("SqlState").EqualTo(PostgresErrorCodes.SyntaxError));
75              });
76      [Test(Description = "Tests whether we throw a helpful exception about unsupported temporary replication slots on old servers.")]
77      public Task CreateLogicalReplicationSlot_with_isTemporary_set_to_true_on_old_postgres_throws()
78          => SafeReplicationTest(
79              async (slotName, _) =>
80              {
81                  await using var c = await OpenConnectionAsync();
82                  TestUtil.MaximumPgVersionExclusive(c, "10.0", "Temporary replication slots were introduced in PostgreSQL 10");
83                  Assert.That(async () =>
84                  {
85                      await using var rc = await OpenReplicationConnectionAsync();
86                      await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin, isTemporary: true);
87                  }, Throws.InstanceOf<NotSupportedException>()
88                      .With.Message.StartsWith("Temporary replication slots were introduced in PostgreSQL")
89                      .And.InnerException.TypeOf<PostgresException>()
90                      .And.InnerException.Property("SqlState").EqualTo(PostgresErrorCodes.SyntaxError));
91              });
92      [Test(Description = "Tests whether we throw a helpful exception about the unsupported TWO_PHASE syntax on old servers.")]
93      public Task CreateLogicalReplicationSlot_with_twoPhase_set_to_true_on_old_postgres_throws()
94          => SafeReplicationTest(
95              async (slotName, _) =>
96              {
97                  await using var c = await OpenConnectionAsync();
98                  TestUtil.MaximumPgVersionExclusive(c, "15.0",
99                      "Logical replication support for prepared transactions was  introduced in PostgreSQL 15");
100                  Assert.That(async () =>
101                  {
102                      await using var rc = await OpenReplicationConnectionAsync();
103                      await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin, twoPhase: true);
104                  }, Throws.InstanceOf<NotSupportedException>()
105                      .With.Message.StartsWith("Logical replication support for prepared transactions was introduced in PostgreSQL")
106                      .And.InnerException.TypeOf<PostgresException>()
107                      .And.InnerException.Property("SqlState").EqualTo(PostgresErrorCodes.SyntaxError));
108              });
109      [Test(Description = "We can use the exported snapshot to query the database in the very moment the replication slot was created.")]
110      public Task CreateLogicalReplicationSlot_Export([Values]bool temporary, [Values]bool twoPhase, [Values]bool implicitInitMode)
111          => SafeReplicationTest(
112              async (slotName, tableName) =>
113              {
114                  await using var c = await OpenConnectionAsync();
115                  if (temporary)
116                      TestUtil.MinimumPgVersion(c, "10.0", "Temporary replication slots were introduced in PostgreSQL 10");
117                  if (twoPhase)
118                      TestUtil.MinimumPgVersion(c, "15.0", "Replication slots with two phase commit support were introduced in PostgreSQL 15");
119                  if (!implicitInitMode)
120                      TestUtil.MinimumPgVersion(c, "10.0", "The *_SNAPSHOT syntax was introduced in PostgreSQL 10");
121                  await using (var transaction = c.BeginTransaction())
122                  {
123                      await c.ExecuteNonQueryAsync($"CREATE TABLE {tableName} (value text)");
124                      await c.ExecuteNonQueryAsync($"INSERT INTO {tableName} (value) VALUES('Before snapshot')");
125                      transaction.Commit();
126                  }
127                  await using var rc = await OpenReplicationConnectionAsync();
128                  var options = await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin, temporary, implicitInitMode ? null : LogicalSlotSnapshotInitMode.Export, twoPhase);
129                  await using (var transaction = c.BeginTransaction())
130                  {
131                      await c.ExecuteNonQueryAsync($"INSERT INTO {tableName} (value) VALUES('After snapshot')");
132                      transaction.Commit();
133                  }
134                  await using (var transaction = c.BeginTransaction(IsolationLevel.RepeatableRead))
135                  {
136                      await c.ExecuteScalarAsync($"SET TRANSACTION SNAPSHOT '{options.SnapshotName}';", transaction);
137                      using var cmd = new NpgsqlCommand($"SELECT value FROM {tableName}", c, transaction);
138                      await using var reader = await cmd.ExecuteReaderAsync();
139                      Assert.That(reader.Read, Is.True);
140                      Assert.That(reader.GetFieldValue<string>(0), Is.EqualTo("Before snapshot"));
141                      Assert.That(reader.Read, Is.False);
142                  }
143              }, nameof(CreateLogicalReplicationSlot_Export) + (temporary ? "_tmp" : "") + (twoPhase ? "_tp" : "") + (implicitInitMode ? "_i" : ""));
144      [Test(Description = "Since we currently don't provide an API to start a transaction on a logical replication connection, " +
145                          "USE_SNAPSHOT currently doesn't work and always leads to an exception. On the other hand, starting" +
146                          "a transaction would only be useful if we'd also provide an API to issue commands.")]
147      public Task CreateLogicalReplicationSlot_Use([Values]bool temporary, [Values]bool twoPhase)
148          => SafeReplicationTest(
149              async (slotName, _) =>
150              {
151                  await using var c = await OpenConnectionAsync();
152                  if (temporary)
153                      TestUtil.MinimumPgVersion(c, "10.0", "Temporary replication slots were introduced in PostgreSQL 10");
154                  if (twoPhase)
155                      TestUtil.MinimumPgVersion(c, "15.0", "Replication slots with two phase commit support were introduced in PostgreSQL 15");
156                  TestUtil.MinimumPgVersion(c, "10.0", "The *_SNAPSHOT syntax was introduced in PostgreSQL 10");
157                  Assert.That(async () =>
158                  {
159                      await using var rc = await OpenReplicationConnectionAsync();
160                      await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin, temporary, LogicalSlotSnapshotInitMode.Use, twoPhase);
161                  }, Throws.InstanceOf<PostgresException>()
162                      .With.Property("SqlState")
163                      .EqualTo("XX000")
164                      .And.Message.Contains(
165                          c.PostgreSqlVersion.Major < 15
166                              ? "USE_SNAPSHOT"
167                              : "(SNAPSHOT 'use')"
168                          ));
169              }, nameof(CreateLogicalReplicationSlot_Use) + (temporary ? "_tmp" : "") + (twoPhase ? "_tp" : ""));
170      [Test]
171      public void CreateLogicalReplicationSlot_with_null_slot_throws()
172          => Assert.That(async () =>
173          {
174              await using var rc = await OpenReplicationConnectionAsync();
175              await rc.CreateLogicalReplicationSlot(null!, OutputPlugin);
176          }, Throws.ArgumentNullException
177              .With.Property("ParamName")
178              .EqualTo("slotName"));
179      [Test]
180      public Task CreateLogicalReplicationSlot_with_null_output_plugin_throws()
181          => SafeReplicationTest(
182              (slotName, _) =>
183              {
184                  Assert.That(async () =>
185                  {
186                      await using var rc = await OpenReplicationConnectionAsync();
187                      await rc.CreateLogicalReplicationSlot(slotName, null!);
188                  }, Throws.ArgumentNullException
189                      .With.Property("ParamName")
190                      .EqualTo("outputPlugin"));
191                  return Task.CompletedTask;
192              });
193      [Test]
194      public Task CreateLogicalReplicationSlot_with_cancelled_token()
195          => SafeReplicationTest(
196              (slotName, _) =>
197              {
198                  Assert.That(async () =>
199                  {
200                      await using var rc = await OpenReplicationConnectionAsync();
201                      var token = GetCancelledCancellationToken();
202                      await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin, cancellationToken: token);
203                  }, Throws.Exception.AssignableTo<OperationCanceledException>());
204                  return Task.CompletedTask;
205              });
206      [Test]
207      public Task CreateLogicalReplicationSlot_with_invalid_SnapshotInitMode_throws()
208          => SafeReplicationTest(
209              (slotName, _) =>
210              {
211                  Assert.That(async () =>
212                  {
213                      await using var rc = await OpenReplicationConnectionAsync();
214                      await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin, slotSnapshotInitMode: (LogicalSlotSnapshotInitMode)42);
215                  }, Throws.InstanceOf<ArgumentOutOfRangeException>()
216                      .With.Property("ParamName")
217                      .EqualTo("slotSnapshotInitMode")
218                      .And.Property("ActualValue")
219                      .EqualTo((LogicalSlotSnapshotInitMode)42));
220                  return Task.CompletedTask;
221              });
222      [Test]
223      public Task CreateLogicalReplicationSlot_with_disposed_connection_throws()
224          => SafeReplicationTest(
225              (slotName, _) =>
226              {
227                  Assert.That(async () =>
228                  {
229                      var rc = await OpenReplicationConnectionAsync();
230                      await rc.DisposeAsync();
231                      await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin);
232                  }, Throws.InstanceOf<ObjectDisposedException>()
233                      .With.Property(nameof(ObjectDisposedException.ObjectName))
234                      .EqualTo(nameof(LogicalReplicationConnection)));
235                  return Task.CompletedTask;
236              });
237      protected override string Postfix => "commonl_l";
238  }
</code></pre>
        </div>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-CommonLogicalReplicationTests.cs</h3>
            <pre><code>1  using System;
2  using System.Data;
3  using System.Threading.Tasks;
4  using NUnit.Framework;
5  using Npgsql.Replication;
6  using Npgsql.Replication.Internal;
7  using NpgsqlTypes;
8  namespace Npgsql.Tests.Replication;
9  [Platform(Exclude = "MacOsX", Reason = "Replication tests are flaky in CI on Mac")]
10  [NonParallelizable]
11  public class CommonLogicalReplicationTests : SafeReplicationTestBase<LogicalReplicationConnection>
12  {
13      const string OutputPlugin = "test_decoding";
14      [Test]
15      public Task CreateLogicalReplicationSlot([Values]bool temporary, [Values]bool twoPhase)
16          => SafeReplicationTest(
17              async (slotName, _) =>
18              {
19                  await using var c = await OpenConnectionAsync();
20                  if (twoPhase)
21                      TestUtil.MinimumPgVersion(c, "15.0", "Replication slots with two phase commit support were introduced in PostgreSQL 15");
22                  if (temporary)
23                      TestUtil.MinimumPgVersion(c, "10.0", "Temporary replication slots were introduced in PostgreSQL 10");
24                  await using var rc = await OpenReplicationConnectionAsync();
25                  var options = await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin, temporary, twoPhase: twoPhase);
26                  using var cmd =
27                      new NpgsqlCommand($"SELECT * FROM pg_replication_slots WHERE slot_name = '{options.SlotName}'",
28                          c);
29                  await using var reader = await cmd.ExecuteReaderAsync();
30                  Assert.That(reader.Read, Is.True);
31                  Assert.That(reader.GetFieldValue<string>(reader.GetOrdinal("slot_type")), Is.EqualTo("logical"));
32                  if (c.PostgreSqlVersion >= Version.Parse("15.0"))
33                      Assert.That(reader.GetFieldValue<bool>(reader.GetOrdinal("two_phase")), Is.EqualTo(twoPhase));
34                  if (c.PostgreSqlVersion >= Version.Parse("10.0"))
<span onclick='openModal()' class='match'>35                      Assert.That(reader.GetFieldValue<bool>(reader.GetOrdinal("temporary")), Is.EqualTo(temporary));
36                  Assert.That(reader.GetFieldValue<bool>(reader.GetOrdinal("active")), Is.EqualTo(temporary));
</span>37                  if (c.PostgreSqlVersion >= Version.Parse("9.6"))
38                      Assert.That(reader.GetFieldValue<NpgsqlLogSequenceNumber>(reader.GetOrdinal("confirmed_flush_lsn")),
39                          Is.EqualTo(options.ConsistentPoint));
40                  Assert.That(reader.Read, Is.False);
41              }, nameof(CreateLogicalReplicationSlot) + (temporary ? "_tmp" : "") + (twoPhase ? "_tp" : ""));
42      [Test]
43      public Task CreateLogicalReplicationSlot_NoExport([Values]bool temporary, [Values]bool twoPhase)
44          => SafeReplicationTest(
45              async (slotName, _) =>
46              {
47                  await using var c = await OpenConnectionAsync();
48                  if (temporary)
49                      TestUtil.MinimumPgVersion(c, "10.0", "Temporary replication slots were introduced in PostgreSQL 10");
50                  if (twoPhase)
51                      TestUtil.MinimumPgVersion(c, "15.0", "Replication slots with two phase commit support were introduced in PostgreSQL 15");
52                  TestUtil.MinimumPgVersion(c, "10.0", "The *_SNAPSHOT syntax was introduced in PostgreSQL 10");
53                  await using var rc = await OpenReplicationConnectionAsync();
54                  var options = await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin, temporary, LogicalSlotSnapshotInitMode.NoExport, twoPhase);
55                  Assert.That(options.SnapshotName, Is.Null);
56              }, nameof(CreateLogicalReplicationSlot_NoExport) + (temporary ? "_tmp" : "") + (twoPhase ? "_tp" : ""));
57      [Test(Description = "Tests whether we throw a helpful exception about the unsupported *_SNAPSHOT syntax on old servers.")]
58      [TestCase(LogicalSlotSnapshotInitMode.Export)]
59      [TestCase(LogicalSlotSnapshotInitMode.NoExport)]
60      [TestCase(LogicalSlotSnapshotInitMode.Use)]
61      public Task CreateLogicalReplicationSlot_with_SnapshotInitMode_on_old_postgres_throws(LogicalSlotSnapshotInitMode mode)
62          => SafeReplicationTest(
63              async (slotName, _) =>
64              {
65                  await using var c = await OpenConnectionAsync();
66                  TestUtil.MaximumPgVersionExclusive(c, "10.0", "The *_SNAPSHOT syntax was introduced in PostgreSQL 10");
67                  Assert.That(async () =>
68                  {
69                      await using var rc = await OpenReplicationConnectionAsync();
70                      await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin, slotSnapshotInitMode: mode);
71                  }, Throws.InstanceOf<NotSupportedException>()
72                      .With.Message.StartsWith("The EXPORT_SNAPSHOT, USE_SNAPSHOT and NOEXPORT_SNAPSHOT syntax was introduced in PostgreSQL")
73                      .And.InnerException.TypeOf<PostgresException>()
74                      .And.InnerException.Property("SqlState").EqualTo(PostgresErrorCodes.SyntaxError));
75              });
76      [Test(Description = "Tests whether we throw a helpful exception about unsupported temporary replication slots on old servers.")]
77      public Task CreateLogicalReplicationSlot_with_isTemporary_set_to_true_on_old_postgres_throws()
78          => SafeReplicationTest(
79              async (slotName, _) =>
80              {
81                  await using var c = await OpenConnectionAsync();
82                  TestUtil.MaximumPgVersionExclusive(c, "10.0", "Temporary replication slots were introduced in PostgreSQL 10");
83                  Assert.That(async () =>
84                  {
85                      await using var rc = await OpenReplicationConnectionAsync();
86                      await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin, isTemporary: true);
87                  }, Throws.InstanceOf<NotSupportedException>()
88                      .With.Message.StartsWith("Temporary replication slots were introduced in PostgreSQL")
89                      .And.InnerException.TypeOf<PostgresException>()
90                      .And.InnerException.Property("SqlState").EqualTo(PostgresErrorCodes.SyntaxError));
91              });
92      [Test(Description = "Tests whether we throw a helpful exception about the unsupported TWO_PHASE syntax on old servers.")]
93      public Task CreateLogicalReplicationSlot_with_twoPhase_set_to_true_on_old_postgres_throws()
94          => SafeReplicationTest(
95              async (slotName, _) =>
96              {
97                  await using var c = await OpenConnectionAsync();
98                  TestUtil.MaximumPgVersionExclusive(c, "15.0",
99                      "Logical replication support for prepared transactions was  introduced in PostgreSQL 15");
100                  Assert.That(async () =>
101                  {
102                      await using var rc = await OpenReplicationConnectionAsync();
103                      await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin, twoPhase: true);
104                  }, Throws.InstanceOf<NotSupportedException>()
105                      .With.Message.StartsWith("Logical replication support for prepared transactions was introduced in PostgreSQL")
106                      .And.InnerException.TypeOf<PostgresException>()
107                      .And.InnerException.Property("SqlState").EqualTo(PostgresErrorCodes.SyntaxError));
108              });
109      [Test(Description = "We can use the exported snapshot to query the database in the very moment the replication slot was created.")]
110      public Task CreateLogicalReplicationSlot_Export([Values]bool temporary, [Values]bool twoPhase, [Values]bool implicitInitMode)
111          => SafeReplicationTest(
112              async (slotName, tableName) =>
113              {
114                  await using var c = await OpenConnectionAsync();
115                  if (temporary)
116                      TestUtil.MinimumPgVersion(c, "10.0", "Temporary replication slots were introduced in PostgreSQL 10");
117                  if (twoPhase)
118                      TestUtil.MinimumPgVersion(c, "15.0", "Replication slots with two phase commit support were introduced in PostgreSQL 15");
119                  if (!implicitInitMode)
120                      TestUtil.MinimumPgVersion(c, "10.0", "The *_SNAPSHOT syntax was introduced in PostgreSQL 10");
121                  await using (var transaction = c.BeginTransaction())
122                  {
123                      await c.ExecuteNonQueryAsync($"CREATE TABLE {tableName} (value text)");
124                      await c.ExecuteNonQueryAsync($"INSERT INTO {tableName} (value) VALUES('Before snapshot')");
125                      transaction.Commit();
126                  }
127                  await using var rc = await OpenReplicationConnectionAsync();
128                  var options = await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin, temporary, implicitInitMode ? null : LogicalSlotSnapshotInitMode.Export, twoPhase);
129                  await using (var transaction = c.BeginTransaction())
130                  {
131                      await c.ExecuteNonQueryAsync($"INSERT INTO {tableName} (value) VALUES('After snapshot')");
132                      transaction.Commit();
133                  }
134                  await using (var transaction = c.BeginTransaction(IsolationLevel.RepeatableRead))
135                  {
136                      await c.ExecuteScalarAsync($"SET TRANSACTION SNAPSHOT '{options.SnapshotName}';", transaction);
137                      using var cmd = new NpgsqlCommand($"SELECT value FROM {tableName}", c, transaction);
138                      await using var reader = await cmd.ExecuteReaderAsync();
139                      Assert.That(reader.Read, Is.True);
140                      Assert.That(reader.GetFieldValue<string>(0), Is.EqualTo("Before snapshot"));
141                      Assert.That(reader.Read, Is.False);
142                  }
143              }, nameof(CreateLogicalReplicationSlot_Export) + (temporary ? "_tmp" : "") + (twoPhase ? "_tp" : "") + (implicitInitMode ? "_i" : ""));
144      [Test(Description = "Since we currently don't provide an API to start a transaction on a logical replication connection, " +
145                          "USE_SNAPSHOT currently doesn't work and always leads to an exception. On the other hand, starting" +
146                          "a transaction would only be useful if we'd also provide an API to issue commands.")]
147      public Task CreateLogicalReplicationSlot_Use([Values]bool temporary, [Values]bool twoPhase)
148          => SafeReplicationTest(
149              async (slotName, _) =>
150              {
151                  await using var c = await OpenConnectionAsync();
152                  if (temporary)
153                      TestUtil.MinimumPgVersion(c, "10.0", "Temporary replication slots were introduced in PostgreSQL 10");
154                  if (twoPhase)
155                      TestUtil.MinimumPgVersion(c, "15.0", "Replication slots with two phase commit support were introduced in PostgreSQL 15");
156                  TestUtil.MinimumPgVersion(c, "10.0", "The *_SNAPSHOT syntax was introduced in PostgreSQL 10");
157                  Assert.That(async () =>
158                  {
159                      await using var rc = await OpenReplicationConnectionAsync();
160                      await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin, temporary, LogicalSlotSnapshotInitMode.Use, twoPhase);
161                  }, Throws.InstanceOf<PostgresException>()
162                      .With.Property("SqlState")
163                      .EqualTo("XX000")
164                      .And.Message.Contains(
165                          c.PostgreSqlVersion.Major < 15
166                              ? "USE_SNAPSHOT"
167                              : "(SNAPSHOT 'use')"
168                          ));
169              }, nameof(CreateLogicalReplicationSlot_Use) + (temporary ? "_tmp" : "") + (twoPhase ? "_tp" : ""));
170      [Test]
171      public void CreateLogicalReplicationSlot_with_null_slot_throws()
172          => Assert.That(async () =>
173          {
174              await using var rc = await OpenReplicationConnectionAsync();
175              await rc.CreateLogicalReplicationSlot(null!, OutputPlugin);
176          }, Throws.ArgumentNullException
177              .With.Property("ParamName")
178              .EqualTo("slotName"));
179      [Test]
180      public Task CreateLogicalReplicationSlot_with_null_output_plugin_throws()
181          => SafeReplicationTest(
182              (slotName, _) =>
183              {
184                  Assert.That(async () =>
185                  {
186                      await using var rc = await OpenReplicationConnectionAsync();
187                      await rc.CreateLogicalReplicationSlot(slotName, null!);
188                  }, Throws.ArgumentNullException
189                      .With.Property("ParamName")
190                      .EqualTo("outputPlugin"));
191                  return Task.CompletedTask;
192              });
193      [Test]
194      public Task CreateLogicalReplicationSlot_with_cancelled_token()
195          => SafeReplicationTest(
196              (slotName, _) =>
197              {
198                  Assert.That(async () =>
199                  {
200                      await using var rc = await OpenReplicationConnectionAsync();
201                      var token = GetCancelledCancellationToken();
202                      await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin, cancellationToken: token);
203                  }, Throws.Exception.AssignableTo<OperationCanceledException>());
204                  return Task.CompletedTask;
205              });
206      [Test]
207      public Task CreateLogicalReplicationSlot_with_invalid_SnapshotInitMode_throws()
208          => SafeReplicationTest(
209              (slotName, _) =>
210              {
211                  Assert.That(async () =>
212                  {
213                      await using var rc = await OpenReplicationConnectionAsync();
214                      await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin, slotSnapshotInitMode: (LogicalSlotSnapshotInitMode)42);
215                  }, Throws.InstanceOf<ArgumentOutOfRangeException>()
216                      .With.Property("ParamName")
217                      .EqualTo("slotSnapshotInitMode")
218                      .And.Property("ActualValue")
219                      .EqualTo((LogicalSlotSnapshotInitMode)42));
220                  return Task.CompletedTask;
221              });
222      [Test]
223      public Task CreateLogicalReplicationSlot_with_disposed_connection_throws()
224          => SafeReplicationTest(
225              (slotName, _) =>
226              {
227                  Assert.That(async () =>
228                  {
229                      var rc = await OpenReplicationConnectionAsync();
230                      await rc.DisposeAsync();
231                      await rc.CreateLogicalReplicationSlot(slotName, OutputPlugin);
232                  }, Throws.InstanceOf<ObjectDisposedException>()
233                      .With.Property(nameof(ObjectDisposedException.ObjectName))
234                      .EqualTo(nameof(LogicalReplicationConnection)));
235                  return Task.CompletedTask;
236              });
237      protected override string Postfix => "commonl_l";
238  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-CommonLogicalReplicationTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-CommonLogicalReplicationTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>33                      Assert.That(reader.GetFieldValue<bool>(reader.GetOrdinal("two_phase")), Is.EqualTo(twoPhase));
34                  if (c.PostgreSqlVersion >= Version.Parse("10.0"))
</pre></code></div>
                <div class="column column_space"><pre><code>35                      Assert.That(reader.GetFieldValue<bool>(reader.GetOrdinal("temporary")), Is.EqualTo(temporary));
36                  Assert.That(reader.GetFieldValue<bool>(reader.GetOrdinal("active")), Is.EqualTo(temporary));
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    