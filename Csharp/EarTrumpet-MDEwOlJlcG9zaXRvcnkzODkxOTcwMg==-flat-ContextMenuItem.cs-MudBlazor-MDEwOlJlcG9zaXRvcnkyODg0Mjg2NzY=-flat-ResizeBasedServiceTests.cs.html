
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 6.896551724137931%, Tokens: 15</h2>
        <div class="column">
            <h3>EarTrumpet-MDEwOlJlcG9zaXRvcnkzODkxOTcwMg==-flat-ContextMenuItem.cs</h3>
            <pre><code>1  using System.Collections.Generic;
2  using System.Windows.Input;
3  namespace EarTrumpet.UI.ViewModels
4  {
5      public class ContextMenuItem
<span onclick='openModal()' class='match'>6      {
7          public string Glyph { get; set; } = "\xE0E7"; 
8          public string DisplayName { get; set; }
</span>9          public ICommand Command { get; set; }
10          public bool IsChecked { get; set; }
11          public IEnumerable<ContextMenuItem> Children { get; set; }
12          public bool IsEnabled { get; set; } = true;
13      }
14      public class ContextMenuSeparator : ContextMenuItem
15      {
16      }
17  }
</code></pre>
        </div>
        <div class="column">
            <h3>MudBlazor-MDEwOlJlcG9zaXRvcnkyODg0Mjg2NzY=-flat-ResizeBasedServiceTests.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Linq;
4  using System.Text;
5  using System.Threading.Tasks;
6  using FluentAssertions;
7  using Microsoft.Extensions.Options;
8  using Microsoft.JSInterop;
9  using Microsoft.JSInterop.Infrastructure;
10  using Moq;
11  using MudBlazor.Services;
12  using NUnit.Framework;
13  namespace MudBlazor.UnitTests.Services
14  {
15      [TestFixture]
16      public class ResizeBasedServiceTests
17      {
18          private Mock<IBrowserWindowSizeProvider> _browserWindowSizeProvider;
19          private Mock<IJSRuntime> _jsruntimeMock;
20          private ResizeService _service;
21          [SetUp]
22          public void SetUp()
23          {
24              _browserWindowSizeProvider = new Mock<IBrowserWindowSizeProvider>();
25              _jsruntimeMock = new Mock<IJSRuntime>();
26              _service = new ResizeService(_jsruntimeMock.Object, _browserWindowSizeProvider.Object);
27          }
28          [Test]
29          public async Task GetBrowserWindowSize()
30          {
31              var size = new BrowserWindowSize
32              {
33                  Height = 200,
34                  Width = 200,
35              };
36              _browserWindowSizeProvider.Setup(x => x.GetBrowserWindowSize()).ReturnsAsync(size);
37              var actualSize = await _service.GetBrowserWindowSize();
38              actualSize.Should().Be(size);
39              _browserWindowSizeProvider.Verify(x => x.GetBrowserWindowSize(), Times.Once());
40          }
41          private record ListenForResizeCallbackInfo(
42              DotNetObjectReference<ResizeService> DotnetRef, ResizeOptions options, Guid ListenerId);
43          private void SetupJsMockForSubscription(ResizeOptions expectedOptions, Action<ListenForResizeCallbackInfo> callbackInfo = null)
44          {
45              _jsruntimeMock.Setup(x => x.InvokeAsync<IJSVoidResult>("mudResizeListenerFactory.listenForResize",
46                 It.Is<object[]>(z =>
47                     z[0] is DotNetObjectReference<ResizeService> == true &&
48                     (ResizeOptions)z[1] == expectedOptions &&
49                     (Guid)z[2] != default
50                 ))).ReturnsAsync(Mock.Of<IJSVoidResult>).Callback<string, object[]>((x, z) => callbackInfo?.Invoke(new ListenForResizeCallbackInfo(
51                      (DotNetObjectReference<ResizeService>)z[0],
52                      (ResizeOptions)z[1], (Guid)z[2]
53                     ))).Verifiable();
54          }
55          private void SetupJsMockForUnsubscription(Guid listenerId)
56          {
57              _jsruntimeMock.Setup(x => x.InvokeAsync<IJSVoidResult>("mudResizeListenerFactory.cancelListener",
58                 It.Is<object[]>(z =>
59                     (Guid)z[0] == listenerId
60                 ))).ReturnsAsync(Mock.Of<IJSVoidResult>).Verifiable();
61          }
62          private async Task CheckSubscriptionOptions(ResizeOptions expectedOptions)
63          {
64              SetupJsMockForSubscription(expectedOptions);
65              var subscriptionId = await _service.SubscribeAsync((BrowserWindowSize size) => { });
66              subscriptionId.Should().NotBe(Guid.Empty);
67              _jsruntimeMock.Verify();
68          }
69          [Test]
70          public async Task Subscribe_WithDefaultOptions()
71          {
72              await CheckSubscriptionOptions(new ResizeOptions());
73          }
74          [Test]
75          public async Task Subscribe_WithOptionsSetInConstructor()
76          {
77              var customResizeOptioons = new ResizeOptions
78              {
79                  ReportRate = 120,
80              };
81              var optionGetter = new Mock<IOptions<ResizeOptions>>();
82              optionGetter.SetupGet(x => x.Value).Returns(customResizeOptioons);
83              _service = new ResizeService(_jsruntimeMock.Object, _browserWindowSizeProvider.Object, optionGetter.Object);
84              await CheckSubscriptionOptions(customResizeOptioons);
85          }
86          [Test]
87          public async Task Subscribe_WithPerCallOption()
88          {
89              var customResizeOptioons = new ResizeOptions
90              {
91                  ReportRate = 130,
92              };
93              SetupJsMockForSubscription(customResizeOptioons);
94              var subscriptionId = await _service.SubscribeAsync((BrowserWindowSize size) => { }, customResizeOptioons);
95              subscriptionId.Should().NotBe(Guid.Empty);
96              _jsruntimeMock.Verify();
97          }
98          [Test]
99          public async Task Subscribe_WithPerCallOptionSetAsNull()
100          {
101              var customResizeOptioons = new ResizeOptions();
102              SetupJsMockForSubscription(customResizeOptioons);
103              var subscriptionId = await _service.SubscribeAsync((BrowserWindowSize size) => { }, null);
104              subscriptionId.Should().NotBe(Guid.Empty);
105              _jsruntimeMock.Verify();
106          }
107          [Test]
108          public void Subscribe_Failed_NullCallback()
109          {
110              Assert.ThrowsAsync<ArgumentNullException>(() => _service.SubscribeAsync(null!));
111              Assert.ThrowsAsync<ArgumentNullException>(() => _service.SubscribeAsync(null!, new ResizeOptions()));
112          }
113          [Test]
114          public async Task SubscribeAndUnsubcribe_SingleSubscription()
115          {
116              var customResizeOptioons = new ResizeOptions();
117              Action<ListenForResizeCallbackInfo> feedbackCaller = (x) =>
118              {
119                  if (x.ListenerId == default)
120                  {
121                      throw new ArgumentException();
122                  }
123                  SetupJsMockForUnsubscription(x.ListenerId);
124              };
125              SetupJsMockForSubscription(customResizeOptioons, feedbackCaller);
126              var subscriptionId = await _service.SubscribeAsync((BrowserWindowSize size) => { }, null);
127              var result = await _service.UnsubscribeAsync(subscriptionId);
128              result.Should().BeTrue();
129              _jsruntimeMock.Verify();
130          }
131          [Test]
132          public async Task SubscribeAndUnsubcribe_DisposeOfDotNet()
133          {
134              var customResizeOptioons = new ResizeOptions();
135              for (int i = 0; i < 4; i++)
136              {
137                  var lastDotnetRefHashCode = 0;
138                  Action<ListenForResizeCallbackInfo> feedbackCaller = (x) =>
139                  {
140                      if (x.ListenerId == default)
141                      {
142                          throw new ArgumentException();
143                      }
144                      if (x.DotnetRef.GetHashCode() == lastDotnetRefHashCode)
145                      {
146                          throw new ArgumentException();
147                      }
148                      lastDotnetRefHashCode = x.DotnetRef.GetHashCode();
149                      SetupJsMockForUnsubscription(x.ListenerId);
150                  };
151                  SetupJsMockForSubscription(customResizeOptioons, feedbackCaller);
152                  var subscriptionId = await _service.SubscribeAsync((BrowserWindowSize size) => { }, null);
153                  var result = await _service.UnsubscribeAsync(subscriptionId);
154                  result.Should().BeTrue();
155                  _jsruntimeMock.Verify();
156              }
157          }
158          [Test]
159          public async Task SubscribeAndUnsubcribe_MultipleSubscription()
160          {
161              var customResizeOptioons = new ResizeOptions();
162              var feedbackCallerCount = 0;
163              Action<ListenForResizeCallbackInfo> feedbackCaller = (x) =>
164              {
165                  if (x.ListenerId == default)
166                  {
167                      throw new ArgumentException();
168                  }
169                  feedbackCallerCount++;
170              };
171              SetupJsMockForSubscription(customResizeOptioons, feedbackCaller);
172              HashSet<Guid> subscriptionIds = new HashSet<Guid>();
173              for (int i = 0; i < 10; i++)
174              {
175                  var subscriptionId = await _service.SubscribeAsync((BrowserWindowSize size) => { });
176                  subscriptionIds.Add(subscriptionId);
177              }
178              feedbackCallerCount.Should().Be(1);
179              subscriptionIds.Should().HaveCount(10);
180              _jsruntimeMock.Verify();
181          }
182          [Test]
183          public async Task SubscribeAndUnsubcribe_MultipleSubscription_WithMultipleOptions()
184          {
185              List<ListenForResizeCallbackInfo> callerFeedbacks = new();
186              Action<ListenForResizeCallbackInfo> feedbackCaller = (x) =>
187              {
188                  if (x.ListenerId == default)
189                  {
190                      throw new ArgumentException();
191                  }
192                  callerFeedbacks.Add(x);
193              };
194              var options = new[]
195              {
196                  new ResizeOptions(),
197                  new ResizeOptions { EnableLogging = !(new ResizeOptions().EnableLogging) },
198                  new ResizeOptions { ReportRate = 50 },
199                  new ResizeOptions { SuppressInitEvent = !(new ResizeOptions().SuppressInitEvent) },
200              };
201              foreach (var item in options)
202              {
203                  SetupJsMockForSubscription(item, feedbackCaller);
204              }
205              var subscriptionIds = options.ToDictionary(x => x, x => new HashSet<Guid>());
206              for (int i = 0; i < 40; i++)
207              {
208                  var index = i % 4;
209                  var option = options[index];
210                  var subscriptionId = await _service.SubscribeAsync((BrowserWindowSize size) => { }, option);
211                  subscriptionIds[option].Add(subscriptionId);
212              }
213              foreach (var item in subscriptionIds)
214              {
215                  item.Value.Should().HaveCount(10);
216              }
217              callerFeedbacks.Should().HaveCount(4);
218              for (int i = 0; i < callerFeedbacks.Count; i++)
219              {
220                  var feedback = callerFeedbacks[i];
221                  feedback.options.Should().Be(options[i]);
222              }
223              callerFeedbacks.Select(x => x.ListenerId).ToHashSet().Should().HaveCount(4);
224              _jsruntimeMock.Verify();
225          }
226          [Test]
227          public async Task Unsubscribe_Failed_NoActiveSubscription()
228          {
229              var result = await _service.UnsubscribeAsync(Guid.NewGuid());
230              result.Should().BeFalse();
231          }
232          [Test]
233          public async Task Unsubscribe_Failed_SubscriptioonIdNotFound()
234          {
235              var customResizeOptioons = new ResizeOptions();
236              SetupJsMockForSubscription(customResizeOptioons);
237              var subscriptionId = await _service.SubscribeAsync((BrowserWindowSize size) => { }, null);
238              var result = await _service.UnsubscribeAsync(Guid.NewGuid());
239              result.Should().BeFalse();
240          }
241          [Test]
242          public async Task DisposeAsync_Failed_NoActiveSubscription()
243          {
244              await _service.DisposeAsync();
245          }
246          [Test]
247          public async Task DisposeAsync_MultipleSubscription_WithMultipleOptions()
248          {
249              List<Guid> callerIds = new();
250              Action<ListenForResizeCallbackInfo> feedbackCaller = (x) =>
251              {
252                  if (x.ListenerId == default)
253                  {
254                      throw new ArgumentException();
255                  }
256                  callerIds.Add(x.ListenerId);
257              };
258              var options = new[]
259              {
260                  new ResizeOptions(),
261                  new ResizeOptions { EnableLogging = !(new ResizeOptions().EnableLogging) },
262                  new ResizeOptions { ReportRate = 50 },
263                  new ResizeOptions { SuppressInitEvent = !(new ResizeOptions().SuppressInitEvent) },
264              };
265              foreach (var item in options)
266              {
267                  SetupJsMockForSubscription(item, feedbackCaller);
268              }
269              for (int i = 0; i < 40; i++)
270              {
271                  var index = i % 4;
272                  var option = options[index];
273                  await _service.SubscribeAsync((BrowserWindowSize size) => { }, option);
274              }
275              Func<IEnumerable<Guid>, bool> idChecker = (ids) =>
276               {
277                   try
278                   {
279                       ids.Should().BeEquivalentTo(callerIds);
280                       return true;
281                   }
282                   catch (Exception)
283                   {
284                       return false;
285                   }
286               };
287              _jsruntimeMock.Setup(x => x.InvokeAsync<IJSVoidResult>("mudResizeListenerFactory.cancelListeners",
288               It.Is<object[]>(z =>
289                   z[0] is IEnumerable<Guid> &&
290                   idChecker((IEnumerable<Guid>)z[0]) == true
291               ))).ReturnsAsync(Mock.Of<IJSVoidResult>).Verifiable();
292              await _service.DisposeAsync();
293              _jsruntimeMock.Verify();
294          }
295          private class FakeSubscriber
<span onclick='openModal()' class='match'>296          {
297              public Guid SubscriptionId { get; set; }
298              public BrowserWindowSize ActualSize { get; set; } = new BrowserWindowSize { };
</span>299              public async Task Subscribe(ResizeService service,
300                  ResizeOptions options)
301              {
302                  SubscriptionId = await service.SubscribeAsync((x) => ActualSize = x, options);
303              }
304          }
305          [Test]
306          public async Task RaiseOnResized_MultipleSubscription_WithMultipleOptions()
307          {
308              Dictionary<ResizeOptions, Guid> listenerIds = new();
309              Action<ListenForResizeCallbackInfo> feedbackCaller = (x) => listenerIds.Add(x.options, x.ListenerId); ;
310              var options = new[]
311              {
312                  (new ResizeOptions(),new BrowserWindowSize { Height = 20,  Width = 200 }),
313                  (new ResizeOptions { EnableLogging = !(new ResizeOptions().EnableLogging) }, new BrowserWindowSize { Height = 30,  Width = 300 }),
314                  (new ResizeOptions { ReportRate = 50 },new BrowserWindowSize { Height = 40,  Width = 400 }),
315                  (new ResizeOptions { SuppressInitEvent = !(new ResizeOptions().SuppressInitEvent) },new BrowserWindowSize { Height = 50,  Width = 500 })
316              };
317              Dictionary<FakeSubscriber, BrowserWindowSize> subscribers = new();
318              foreach (var item in options)
319              {
320                  SetupJsMockForSubscription(item.Item1, feedbackCaller);
321              }
322              for (int i = 0; i < 40; i++)
323              {
324                  var index = i % 4;
325                  var option = options[index];
326                  var subscriber = new FakeSubscriber();
327                  await subscriber.Subscribe(_service, option.Item1);
328                  subscribers.Add(subscriber, option.Item2);
329              }
330              foreach (var item in options)
331              {
332                  var listenerId = listenerIds[item.Item1];
333                  _service.RaiseOnResized(item.Item2, Breakpoint.None, listenerId);
334              }
335              foreach (var item in subscribers)
336              {
337                  item.Key.ActualSize.Should().Be(item.Value);
338              }
339              _jsruntimeMock.Verify();
340          }
341          [Test]
342          public async Task RaiseOnResized_InvalidListenerId()
343          {
344              var customResizeOptions = new ResizeOptions();
345              SetupJsMockForSubscription(customResizeOptions);
346              FakeSubscriber subscriber = new FakeSubscriber();
347              await subscriber.Subscribe(_service, customResizeOptions);
348              _service.RaiseOnResized(new BrowserWindowSize { Height = 2000 }, Breakpoint.None, Guid.NewGuid());
349              subscriber.ActualSize.Height.Should().NotBe(2000);
350          }
351          [Test]
352          public async Task Unsubcribe_MultipleSubscription_InParallel()
353          {
354              var customResizeOptioons = new ResizeOptions();
355              var feedbackCallerCount = 0;
356              var listenerId = Guid.Empty;
357              Action<ListenForResizeCallbackInfo> feedbackCaller = (x) =>
358              {
359                  if (x.ListenerId == default)
360                  {
361                      throw new ArgumentException();
362                  }
363                  feedbackCallerCount++;
364                  listenerId = x.ListenerId;
365              };
366              SetupJsMockForSubscription(customResizeOptioons, feedbackCaller);
367              var subscriptionIds = new HashSet<Guid>();
368              for (int i = 0; i < 40; i++)
369              {
370                  var subscriptionId = await _service.SubscribeAsync((BrowserWindowSize size) => { });
371                  subscriptionIds.Add(subscriptionId);
372              }
373              subscriptionIds.Should().HaveCount(40);
374              feedbackCallerCount.Should().Be(1);
375              SetupJsMockForUnsubscription(listenerId);
376              var tasksToExecute = new Task[subscriptionIds.Count];
377              for (int i = 0; i < subscriptionIds.Count; i++)
378              {
379                  var temp = i;
380                  var task = Task.Run(async () =>
381                  {
382                      _ = await _service.UnsubscribeAsync(subscriptionIds.ElementAt(temp));
383                  });
384                  tasksToExecute[i] = task;
385              }
386              Task.WaitAll(tasksToExecute);
387              _jsruntimeMock.Verify((x => x.InvokeAsync<IJSVoidResult>("mudResizeListenerFactory.cancelListener",
388                 It.Is<object[]>(z =>
389                     (Guid)z[0] == listenerId
390                 ))), Times.Once());
391          }
392      }
393  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from EarTrumpet-MDEwOlJlcG9zaXRvcnkzODkxOTcwMg==-flat-ContextMenuItem.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from MudBlazor-MDEwOlJlcG9zaXRvcnkyODg0Mjg2NzY=-flat-ResizeBasedServiceTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>6      {
7          public string Glyph { get; set; } = "\xE0E7"; 
8          public string DisplayName { get; set; }
</pre></code></div>
                <div class="column column_space"><pre><code>296          {
297              public Guid SubscriptionId { get; set; }
298              public BrowserWindowSize ActualSize { get; set; } = new BrowserWindowSize { };
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    