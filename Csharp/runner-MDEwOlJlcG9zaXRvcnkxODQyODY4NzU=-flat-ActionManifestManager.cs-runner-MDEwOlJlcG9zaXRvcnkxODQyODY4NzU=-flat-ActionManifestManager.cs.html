
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 31, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ActionManifestManager.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.IO;
4  using System.Threading;
5  using GitHub.Runner.Common;
6  using GitHub.Runner.Sdk;
7  using System.Reflection;
8  using GitHub.DistributedTask.Pipelines.ObjectTemplating;
9  using GitHub.DistributedTask.ObjectTemplating.Schema;
10  using GitHub.DistributedTask.ObjectTemplating;
11  using GitHub.DistributedTask.ObjectTemplating.Tokens;
12  using GitHub.DistributedTask.Pipelines.ContextData;
13  using System.Linq;
14  using Pipelines = GitHub.DistributedTask.Pipelines;
15  namespace GitHub.Runner.Worker
16  {
17      [ServiceLocator(Default = typeof(ActionManifestManager))]
18      public interface IActionManifestManager : IRunnerService
19      {
20          ActionDefinitionData Load(IExecutionContext executionContext, string manifestFile);
21          DictionaryContextData EvaluateCompositeOutputs(IExecutionContext executionContext, TemplateToken token, IDictionary<string, PipelineContextData> extraExpressionValues);
22          List<string> EvaluateContainerArguments(IExecutionContext executionContext, SequenceToken token, IDictionary<string, PipelineContextData> extraExpressionValues);
23          Dictionary<string, string> EvaluateContainerEnvironment(IExecutionContext executionContext, MappingToken token, IDictionary<string, PipelineContextData> extraExpressionValues);
24          string EvaluateDefaultInput(IExecutionContext executionContext, string inputName, TemplateToken token);
25      }
26      public sealed class ActionManifestManager : RunnerService, IActionManifestManager
27      {
28          private TemplateSchema _actionManifestSchema;
29          public override void Initialize(IHostContext hostContext)
30          {
31              base.Initialize(hostContext);
32              var assembly = Assembly.GetExecutingAssembly();
33              var json = default(string);
34              using (var stream = assembly.GetManifestResourceStream("GitHub.Runner.Worker.action_yaml.json"))
35              using (var streamReader = new StreamReader(stream))
36              {
37                  json = streamReader.ReadToEnd();
38              }
39              var objectReader = new JsonObjectReader(null, json);
40              _actionManifestSchema = TemplateSchema.Load(objectReader);
41              ArgUtil.NotNull(_actionManifestSchema, nameof(_actionManifestSchema));
42              Trace.Info($"Load schema file with definitions: {StringUtil.ConvertToJson(_actionManifestSchema.Definitions.Keys)}");
43          }
44          public ActionDefinitionData Load(IExecutionContext executionContext, string manifestFile)
45          {
46              var templateContext = CreateTemplateContext(executionContext);
47              ActionDefinitionData actionDefinition = new();
48              string basePath = HostContext.GetDirectory(WellKnownDirectory.Actions);
49              string fileRelativePath = manifestFile;
50              if (manifestFile.Contains(basePath))
51              {
52                  fileRelativePath = manifestFile.Remove(0, basePath.Length + 1);
53              }
54              try
55              {
56                  var token = default(TemplateToken);
57                  var fileId = templateContext.GetFileId(fileRelativePath);
58                  if (fileId > executionContext.Global.FileTable.Count)
59                  {
60                      executionContext.Global.FileTable.Add(fileRelativePath);
61                  }
62                  var fileContent = File.ReadAllText(manifestFile);
63                  using (var stringReader = new StringReader(fileContent))
64                  {
65                      var yamlObjectReader = new YamlObjectReader(fileId, stringReader);
66                      token = TemplateReader.Read(templateContext, "action-root", yamlObjectReader, fileId, out _);
67                  }
68                  var actionMapping = token.AssertMapping("action manifest root");
69                  var actionOutputs = default(MappingToken);
70                  var actionRunValueToken = default(TemplateToken);
71                  foreach (var actionPair in actionMapping)
72                  {
73                      var propertyName = actionPair.Key.AssertString($"action.yml property key");
74                      switch (propertyName.Value)
75                      {
76                          case "name":
77                              actionDefinition.Name = actionPair.Value.AssertString("name").Value;
78                              break;
79                          case "outputs":
80                              actionOutputs = actionPair.Value.AssertMapping("outputs");
81                              break;
82                          case "description":
83                              actionDefinition.Description = actionPair.Value.AssertString("description").Value;
84                              break;
85                          case "inputs":
86                              ConvertInputs(actionPair.Value, actionDefinition);
87                              break;
88                          case "runs":
89                              actionRunValueToken = actionPair.Value;
90                              break;
91                          default:
92                              Trace.Info($"Ignore action property {propertyName}.");
93                              break;
94                      }
95                  }
96                  if (actionRunValueToken != null)
97                  {
98                      actionDefinition.Execution = ConvertRuns(executionContext, templateContext, actionRunValueToken, fileRelativePath, actionOutputs);
99                  }
100              }
101              catch (Exception ex)
102              {
103                  Trace.Error(ex);
104                  templateContext.Errors.Add(ex);
105              }
106              if (templateContext.Errors.Count > 0)
107              {
108                  foreach (var error in templateContext.Errors)
109                  {
110                      Trace.Error($"Action.yml load error: {error.Message}");
111                      executionContext.Error(error.Message);
112                  }
113                  throw new ArgumentException($"Fail to load {fileRelativePath}");
114              }
115              if (actionDefinition.Execution == null)
116              {
117                  executionContext.Debug($"Loaded action.yml file: {StringUtil.ConvertToJson(actionDefinition)}");
118                  throw new ArgumentException($"Top level 'runs:' section is required for {fileRelativePath}");
119              }
120              else
121              {
122                  Trace.Info($"Loaded action.yml file: {StringUtil.ConvertToJson(actionDefinition)}");
123              }
124              return actionDefinition;
125          }
126          public DictionaryContextData EvaluateCompositeOutputs(
127              IExecutionContext executionContext,
128              TemplateToken token,
129              IDictionary<string, PipelineContextData> extraExpressionValues)
130          {
131              var result = default(DictionaryContextData);
132              if (token != null)
133              {
134                  var templateContext = CreateTemplateContext(executionContext, extraExpressionValues);
135                  try
136                  {
137                      token = TemplateEvaluator.Evaluate(templateContext, "outputs", token, 0, null, omitHeader: true);
138                      templateContext.Errors.Check();
139                      result = token.ToContextData().AssertDictionary("composite outputs");
140                  }
141                  catch (Exception ex) when (!(ex is TemplateValidationException))
142                  {
143                      templateContext.Errors.Add(ex);
144                  }
145                  templateContext.Errors.Check();
146              }
147              return result ?? new DictionaryContextData();
148          }
149          public List<string> EvaluateContainerArguments(
150              IExecutionContext executionContext,
151              SequenceToken token,
152              IDictionary<string, PipelineContextData> extraExpressionValues)
153          {
154              var result = new List<string>();
155              if (token != null)
156              {
157                  var templateContext = CreateTemplateContext(executionContext, extraExpressionValues);
158                  try
159                  {
160                      var evaluateResult = TemplateEvaluator.Evaluate(templateContext, "container-runs-args", token, 0, null, omitHeader: true);
161                      templateContext.Errors.Check();
162                      Trace.Info($"Arguments evaluate result: {StringUtil.ConvertToJson(evaluateResult)}");
163                      var args = evaluateResult.AssertSequence("container args");
164                      foreach (var arg in args)
165                      {
166                          var str = arg.AssertString("container arg").Value;
167                          result.Add(str);
168                          Trace.Info($"Add argument {str}");
169                      }
170                  }
171                  catch (Exception ex) when (!(ex is TemplateValidationException))
172                  {
173                      Trace.Error(ex);
174                      templateContext.Errors.Add(ex);
175                  }
176                  templateContext.Errors.Check();
177              }
178              return result;
179          }
180          public Dictionary<string, string> EvaluateContainerEnvironment(
181              IExecutionContext executionContext,
182              MappingToken token,
183              IDictionary<string, PipelineContextData> extraExpressionValues)
184          {
185              var result = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
186              if (token != null)
187              {
188                  var templateContext = CreateTemplateContext(executionContext, extraExpressionValues);
189                  try
190                  {
191                      var evaluateResult = TemplateEvaluator.Evaluate(templateContext, "container-runs-env", token, 0, null, omitHeader: true);
192                      templateContext.Errors.Check();
193                      Trace.Info($"Environments evaluate result: {StringUtil.ConvertToJson(evaluateResult)}");
194                      var mapping = evaluateResult.AssertMapping("container env");
195                      foreach (var pair in mapping)
196                      {
197                          var key = pair.Key.AssertString("container env key");
198                          var value = pair.Value.AssertString("container env value");
199                          result[key.Value] = value.Value;
200                          Trace.Info($"Add env {key} = {value}");
201                      }
202                  }
203                  catch (Exception ex) when (!(ex is TemplateValidationException))
204                  {
205                      Trace.Error(ex);
206                      templateContext.Errors.Add(ex);
207                  }
208                  templateContext.Errors.Check();
209              }
210              return result;
211          }
212          public string EvaluateDefaultInput(
213              IExecutionContext executionContext,
214              string inputName,
215              TemplateToken token)
216          {
217              string result = "";
218              if (token != null)
219              {
220                  var templateContext = CreateTemplateContext(executionContext);
221                  try
222                  {
223                      var evaluateResult = TemplateEvaluator.Evaluate(templateContext, "input-default-context", token, 0, null, omitHeader: true);
224                      templateContext.Errors.Check();
225                      Trace.Info($"Input '{inputName}': default value evaluate result: {StringUtil.ConvertToJson(evaluateResult)}");
226                      result = evaluateResult.AssertString($"default value for input '{inputName}'").Value;
227                  }
228                  catch (Exception ex) when (!(ex is TemplateValidationException))
229                  {
230                      Trace.Error(ex);
231                      templateContext.Errors.Add(ex);
232                  }
233                  templateContext.Errors.Check();
234              }
235              return result;
236          }
237          private TemplateContext CreateTemplateContext(
238              IExecutionContext executionContext,
239              IDictionary<string, PipelineContextData> extraExpressionValues = null)
240          {
241              var result = new TemplateContext
242              {
243                  CancellationToken = CancellationToken.None,
244                  Errors = new TemplateValidationErrors(10, int.MaxValue), 
245                  Memory = new TemplateMemory(
246                      maxDepth: 100,
247                      maxEvents: 1000000,
248                      maxBytes: 10 * 1024 * 1024),
249                  Schema = _actionManifestSchema,
250                  TraceWriter = executionContext.ToTemplateTraceWriter(),
251              };
252              foreach (var pair in executionContext.ExpressionValues)
253              {
254                  result.ExpressionValues[pair.Key] = pair.Value;
255              }
256              if (extraExpressionValues?.Count > 0)
257              {
258                  foreach (var pair in extraExpressionValues)
259                  {
260                      result.ExpressionValues[pair.Key] = pair.Value;
261                  }
262              }
263              foreach (var item in executionContext.ExpressionFunctions)
264              {
265                  result.ExpressionFunctions.Add(item);
266              }
267              for (var i = 0; i < executionContext.Global.FileTable.Count; i++)
268              {
269                  result.GetFileId(executionContext.Global.FileTable[i]);
270              }
271              return result;
272          }
273          private ActionExecutionData ConvertRuns(
274              IExecutionContext executionContext,
275              TemplateContext templateContext,
276              TemplateToken inputsToken,
277              String fileRelativePath,
278              MappingToken outputs = null)
279          {
280              var runsMapping = inputsToken.AssertMapping("runs");
281              var usingToken = default(StringToken);
282              var imageToken = default(StringToken);
283              var argsToken = default(SequenceToken);
284              var entrypointToken = default(StringToken);
285              var envToken = default(MappingToken);
286              var mainToken = default(StringToken);
287              var pluginToken = default(StringToken);
288              var preToken = default(StringToken);
289              var preEntrypointToken = default(StringToken);
290              var preIfToken = default(StringToken);
291              var postToken = default(StringToken);
292              var postEntrypointToken = default(StringToken);
293              var postIfToken = default(StringToken);
294              var steps = default(List<Pipelines.Step>);
295              foreach (var run in runsMapping)
296              {
297                  var runsKey = run.Key.AssertString("runs key").Value;
298                  switch (runsKey)
299                  {
300                      case "using":
301                          usingToken = run.Value.AssertString("using");
302                          break;
303                      case "image":
304                          imageToken = run.Value.AssertString("image");
305                          break;
306                      case "args":
307                          argsToken = run.Value.AssertSequence("args");
308                          break;
309                      case "entrypoint":
310                          entrypointToken = run.Value.AssertString("entrypoint");
311                          break;
312                      case "env":
313                          envToken = run.Value.AssertMapping("env");
314                          break;
315                      case "main":
316                          mainToken = run.Value.AssertString("main");
317                          break;
318                      case "plugin":
319                          pluginToken = run.Value.AssertString("plugin");
320                          break;
321                      case "post":
322                          postToken = run.Value.AssertString("post");
323                          break;
324                      case "post-entrypoint":
325                          postEntrypointToken = run.Value.AssertString("post-entrypoint");
326                          break;
327                      case "post-if":
328                          postIfToken = run.Value.AssertString("post-if");
329                          break;
330                      case "pre":
331                          preToken = run.Value.AssertString("pre");
332                          break;
333                      case "pre-entrypoint":
334                          preEntrypointToken = run.Value.AssertString("pre-entrypoint");
335                          break;
336                      case "pre-if":
337                          preIfToken = run.Value.AssertString("pre-if");
338                          break;
339                      case "steps":
340                          var stepsToken = run.Value.AssertSequence("steps");
341                          steps = PipelineTemplateConverter.ConvertToSteps(templateContext, stepsToken);
342                          templateContext.Errors.Check();
343                          break;
344                      default:
345                          Trace.Info($"Ignore run property {runsKey}.");
346                          break;
347                  }
348              }
349              if (usingToken != null)
350              {
351                  if (string.Equals(usingToken.Value, "docker", StringComparison.OrdinalIgnoreCase))
352                  {
353                      if (string.IsNullOrEmpty(imageToken?.Value))
354                      {
355                          throw new ArgumentNullException($"You are using a Container Action but an image is not provided in {fileRelativePath}.");
356                      }
357                      else
358                      {
359                          return new ContainerActionExecutionData()
360                          {
361                              Image = imageToken.Value,
362                              Arguments = argsToken,
363                              EntryPoint = entrypointToken?.Value,
364                              Environment = envToken,
<span onclick='openModal()' class='match'>365                              Pre = preEntrypointToken?.Value,
366                              InitCondition = preIfToken?.Value ?? "always()",
367                              Post = postEntrypointToken?.Value,
368                              CleanupCondition = postIfToken?.Value ?? "always()"
369                          };
370                      }
371                  }
372                  else if (string.Equals(usingToken.Value, "node12", StringComparison.OrdinalIgnoreCase) ||
</span>373                           string.Equals(usingToken.Value, "node16", StringComparison.OrdinalIgnoreCase))
374                  {
375                      if (string.IsNullOrEmpty(mainToken?.Value))
376                      {
377                          throw new ArgumentNullException($"You are using a JavaScript Action but there is not an entry JavaScript file provided in {fileRelativePath}.");
378                      }
379                      else
380                      {
381                          return new NodeJSActionExecutionData()
382                          {
383                              NodeVersion = usingToken.Value,
384                              Script = mainToken.Value,
385                              Pre = preToken?.Value,
386                              InitCondition = preIfToken?.Value ?? "always()",
387                              Post = postToken?.Value,
388                              CleanupCondition = postIfToken?.Value ?? "always()"
389                          };
390                      }
391                  }
392                  else if (string.Equals(usingToken.Value, "composite", StringComparison.OrdinalIgnoreCase))
393                  {
394                      if (steps == null)
395                      {
396                          throw new ArgumentNullException($"You are using a composite action but there are no steps provided in {fileRelativePath}.");
397                      }
398                      else
399                      {
400                          return new CompositeActionExecutionData()
401                          {
402                              Steps = steps.Cast<Pipelines.ActionStep>().ToList(),
403                              PreSteps = new List<Pipelines.ActionStep>(),
404                              PostSteps = new Stack<Pipelines.ActionStep>(),
405                              InitCondition = "always()",
406                              CleanupCondition = "always()",
407                              Outputs = outputs
408                          };
409                      }
410                  }
411                  else
412                  {
413                      throw new ArgumentOutOfRangeException($"'using: {usingToken.Value}' is not supported, use 'docker', 'node12' or 'node16' instead.");
414                  }
415              }
416              else if (pluginToken != null)
417              {
418                  return new PluginActionExecutionData()
419                  {
420                      Plugin = pluginToken.Value
421                  };
422              }
423              throw new NotSupportedException("Missing 'using' value. 'using' requires 'composite', 'docker', 'node12' or 'node16'.");
424          }
425          private void ConvertInputs(
426              TemplateToken inputsToken,
427              ActionDefinitionData actionDefinition)
428          {
429              actionDefinition.Inputs = new MappingToken(null, null, null);
430              var inputsMapping = inputsToken.AssertMapping("inputs");
431              foreach (var input in inputsMapping)
432              {
433                  bool hasDefault = false;
434                  var inputName = input.Key.AssertString("input name");
435                  var inputMetadata = input.Value.AssertMapping("input metadata");
436                  foreach (var metadata in inputMetadata)
437                  {
438                      var metadataName = metadata.Key.AssertString("input metadata").Value;
439                      if (string.Equals(metadataName, "default", StringComparison.OrdinalIgnoreCase))
440                      {
441                          hasDefault = true;
442                          actionDefinition.Inputs.Add(inputName, metadata.Value);
443                      }
444                      else if (string.Equals(metadataName, "deprecationMessage", StringComparison.OrdinalIgnoreCase))
445                      {
446                          if (actionDefinition.Deprecated == null)
447                          {
448                              actionDefinition.Deprecated = new Dictionary<String, String>();
449                          }
450                          var message = metadata.Value.AssertString("input deprecationMessage");
451                          actionDefinition.Deprecated.Add(inputName.Value, message.Value);
452                      }
453                  }
454                  if (!hasDefault)
455                  {
456                      actionDefinition.Inputs.Add(inputName, new StringToken(null, null, null, string.Empty));
457                  }
458              }
459          }
460      }
461  }
</code></pre>
        </div>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ActionManifestManager.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.IO;
4  using System.Threading;
5  using GitHub.Runner.Common;
6  using GitHub.Runner.Sdk;
7  using System.Reflection;
8  using GitHub.DistributedTask.Pipelines.ObjectTemplating;
9  using GitHub.DistributedTask.ObjectTemplating.Schema;
10  using GitHub.DistributedTask.ObjectTemplating;
11  using GitHub.DistributedTask.ObjectTemplating.Tokens;
12  using GitHub.DistributedTask.Pipelines.ContextData;
13  using System.Linq;
14  using Pipelines = GitHub.DistributedTask.Pipelines;
15  namespace GitHub.Runner.Worker
16  {
17      [ServiceLocator(Default = typeof(ActionManifestManager))]
18      public interface IActionManifestManager : IRunnerService
19      {
20          ActionDefinitionData Load(IExecutionContext executionContext, string manifestFile);
21          DictionaryContextData EvaluateCompositeOutputs(IExecutionContext executionContext, TemplateToken token, IDictionary<string, PipelineContextData> extraExpressionValues);
22          List<string> EvaluateContainerArguments(IExecutionContext executionContext, SequenceToken token, IDictionary<string, PipelineContextData> extraExpressionValues);
23          Dictionary<string, string> EvaluateContainerEnvironment(IExecutionContext executionContext, MappingToken token, IDictionary<string, PipelineContextData> extraExpressionValues);
24          string EvaluateDefaultInput(IExecutionContext executionContext, string inputName, TemplateToken token);
25      }
26      public sealed class ActionManifestManager : RunnerService, IActionManifestManager
27      {
28          private TemplateSchema _actionManifestSchema;
29          public override void Initialize(IHostContext hostContext)
30          {
31              base.Initialize(hostContext);
32              var assembly = Assembly.GetExecutingAssembly();
33              var json = default(string);
34              using (var stream = assembly.GetManifestResourceStream("GitHub.Runner.Worker.action_yaml.json"))
35              using (var streamReader = new StreamReader(stream))
36              {
37                  json = streamReader.ReadToEnd();
38              }
39              var objectReader = new JsonObjectReader(null, json);
40              _actionManifestSchema = TemplateSchema.Load(objectReader);
41              ArgUtil.NotNull(_actionManifestSchema, nameof(_actionManifestSchema));
42              Trace.Info($"Load schema file with definitions: {StringUtil.ConvertToJson(_actionManifestSchema.Definitions.Keys)}");
43          }
44          public ActionDefinitionData Load(IExecutionContext executionContext, string manifestFile)
45          {
46              var templateContext = CreateTemplateContext(executionContext);
47              ActionDefinitionData actionDefinition = new();
48              string basePath = HostContext.GetDirectory(WellKnownDirectory.Actions);
49              string fileRelativePath = manifestFile;
50              if (manifestFile.Contains(basePath))
51              {
52                  fileRelativePath = manifestFile.Remove(0, basePath.Length + 1);
53              }
54              try
55              {
56                  var token = default(TemplateToken);
57                  var fileId = templateContext.GetFileId(fileRelativePath);
58                  if (fileId > executionContext.Global.FileTable.Count)
59                  {
60                      executionContext.Global.FileTable.Add(fileRelativePath);
61                  }
62                  var fileContent = File.ReadAllText(manifestFile);
63                  using (var stringReader = new StringReader(fileContent))
64                  {
65                      var yamlObjectReader = new YamlObjectReader(fileId, stringReader);
66                      token = TemplateReader.Read(templateContext, "action-root", yamlObjectReader, fileId, out _);
67                  }
68                  var actionMapping = token.AssertMapping("action manifest root");
69                  var actionOutputs = default(MappingToken);
70                  var actionRunValueToken = default(TemplateToken);
71                  foreach (var actionPair in actionMapping)
72                  {
73                      var propertyName = actionPair.Key.AssertString($"action.yml property key");
74                      switch (propertyName.Value)
75                      {
76                          case "name":
77                              actionDefinition.Name = actionPair.Value.AssertString("name").Value;
78                              break;
79                          case "outputs":
80                              actionOutputs = actionPair.Value.AssertMapping("outputs");
81                              break;
82                          case "description":
83                              actionDefinition.Description = actionPair.Value.AssertString("description").Value;
84                              break;
85                          case "inputs":
86                              ConvertInputs(actionPair.Value, actionDefinition);
87                              break;
88                          case "runs":
89                              actionRunValueToken = actionPair.Value;
90                              break;
91                          default:
92                              Trace.Info($"Ignore action property {propertyName}.");
93                              break;
94                      }
95                  }
96                  if (actionRunValueToken != null)
97                  {
98                      actionDefinition.Execution = ConvertRuns(executionContext, templateContext, actionRunValueToken, fileRelativePath, actionOutputs);
99                  }
100              }
101              catch (Exception ex)
102              {
103                  Trace.Error(ex);
104                  templateContext.Errors.Add(ex);
105              }
106              if (templateContext.Errors.Count > 0)
107              {
108                  foreach (var error in templateContext.Errors)
109                  {
110                      Trace.Error($"Action.yml load error: {error.Message}");
111                      executionContext.Error(error.Message);
112                  }
113                  throw new ArgumentException($"Fail to load {fileRelativePath}");
114              }
115              if (actionDefinition.Execution == null)
116              {
117                  executionContext.Debug($"Loaded action.yml file: {StringUtil.ConvertToJson(actionDefinition)}");
118                  throw new ArgumentException($"Top level 'runs:' section is required for {fileRelativePath}");
119              }
120              else
121              {
122                  Trace.Info($"Loaded action.yml file: {StringUtil.ConvertToJson(actionDefinition)}");
123              }
124              return actionDefinition;
125          }
126          public DictionaryContextData EvaluateCompositeOutputs(
127              IExecutionContext executionContext,
128              TemplateToken token,
129              IDictionary<string, PipelineContextData> extraExpressionValues)
130          {
131              var result = default(DictionaryContextData);
132              if (token != null)
133              {
134                  var templateContext = CreateTemplateContext(executionContext, extraExpressionValues);
135                  try
136                  {
137                      token = TemplateEvaluator.Evaluate(templateContext, "outputs", token, 0, null, omitHeader: true);
138                      templateContext.Errors.Check();
139                      result = token.ToContextData().AssertDictionary("composite outputs");
140                  }
141                  catch (Exception ex) when (!(ex is TemplateValidationException))
142                  {
143                      templateContext.Errors.Add(ex);
144                  }
145                  templateContext.Errors.Check();
146              }
147              return result ?? new DictionaryContextData();
148          }
149          public List<string> EvaluateContainerArguments(
150              IExecutionContext executionContext,
151              SequenceToken token,
152              IDictionary<string, PipelineContextData> extraExpressionValues)
153          {
154              var result = new List<string>();
155              if (token != null)
156              {
157                  var templateContext = CreateTemplateContext(executionContext, extraExpressionValues);
158                  try
159                  {
160                      var evaluateResult = TemplateEvaluator.Evaluate(templateContext, "container-runs-args", token, 0, null, omitHeader: true);
161                      templateContext.Errors.Check();
162                      Trace.Info($"Arguments evaluate result: {StringUtil.ConvertToJson(evaluateResult)}");
163                      var args = evaluateResult.AssertSequence("container args");
164                      foreach (var arg in args)
165                      {
166                          var str = arg.AssertString("container arg").Value;
167                          result.Add(str);
168                          Trace.Info($"Add argument {str}");
169                      }
170                  }
171                  catch (Exception ex) when (!(ex is TemplateValidationException))
172                  {
173                      Trace.Error(ex);
174                      templateContext.Errors.Add(ex);
175                  }
176                  templateContext.Errors.Check();
177              }
178              return result;
179          }
180          public Dictionary<string, string> EvaluateContainerEnvironment(
181              IExecutionContext executionContext,
182              MappingToken token,
183              IDictionary<string, PipelineContextData> extraExpressionValues)
184          {
185              var result = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
186              if (token != null)
187              {
188                  var templateContext = CreateTemplateContext(executionContext, extraExpressionValues);
189                  try
190                  {
191                      var evaluateResult = TemplateEvaluator.Evaluate(templateContext, "container-runs-env", token, 0, null, omitHeader: true);
192                      templateContext.Errors.Check();
193                      Trace.Info($"Environments evaluate result: {StringUtil.ConvertToJson(evaluateResult)}");
194                      var mapping = evaluateResult.AssertMapping("container env");
195                      foreach (var pair in mapping)
196                      {
197                          var key = pair.Key.AssertString("container env key");
198                          var value = pair.Value.AssertString("container env value");
199                          result[key.Value] = value.Value;
200                          Trace.Info($"Add env {key} = {value}");
201                      }
202                  }
203                  catch (Exception ex) when (!(ex is TemplateValidationException))
204                  {
205                      Trace.Error(ex);
206                      templateContext.Errors.Add(ex);
207                  }
208                  templateContext.Errors.Check();
209              }
210              return result;
211          }
212          public string EvaluateDefaultInput(
213              IExecutionContext executionContext,
214              string inputName,
215              TemplateToken token)
216          {
217              string result = "";
218              if (token != null)
219              {
220                  var templateContext = CreateTemplateContext(executionContext);
221                  try
222                  {
223                      var evaluateResult = TemplateEvaluator.Evaluate(templateContext, "input-default-context", token, 0, null, omitHeader: true);
224                      templateContext.Errors.Check();
225                      Trace.Info($"Input '{inputName}': default value evaluate result: {StringUtil.ConvertToJson(evaluateResult)}");
226                      result = evaluateResult.AssertString($"default value for input '{inputName}'").Value;
227                  }
228                  catch (Exception ex) when (!(ex is TemplateValidationException))
229                  {
230                      Trace.Error(ex);
231                      templateContext.Errors.Add(ex);
232                  }
233                  templateContext.Errors.Check();
234              }
235              return result;
236          }
237          private TemplateContext CreateTemplateContext(
238              IExecutionContext executionContext,
239              IDictionary<string, PipelineContextData> extraExpressionValues = null)
240          {
241              var result = new TemplateContext
242              {
243                  CancellationToken = CancellationToken.None,
244                  Errors = new TemplateValidationErrors(10, int.MaxValue), 
245                  Memory = new TemplateMemory(
246                      maxDepth: 100,
247                      maxEvents: 1000000,
248                      maxBytes: 10 * 1024 * 1024),
249                  Schema = _actionManifestSchema,
250                  TraceWriter = executionContext.ToTemplateTraceWriter(),
251              };
252              foreach (var pair in executionContext.ExpressionValues)
253              {
254                  result.ExpressionValues[pair.Key] = pair.Value;
255              }
256              if (extraExpressionValues?.Count > 0)
257              {
258                  foreach (var pair in extraExpressionValues)
259                  {
260                      result.ExpressionValues[pair.Key] = pair.Value;
261                  }
262              }
263              foreach (var item in executionContext.ExpressionFunctions)
264              {
265                  result.ExpressionFunctions.Add(item);
266              }
267              for (var i = 0; i < executionContext.Global.FileTable.Count; i++)
268              {
269                  result.GetFileId(executionContext.Global.FileTable[i]);
270              }
271              return result;
272          }
273          private ActionExecutionData ConvertRuns(
274              IExecutionContext executionContext,
275              TemplateContext templateContext,
276              TemplateToken inputsToken,
277              String fileRelativePath,
278              MappingToken outputs = null)
279          {
280              var runsMapping = inputsToken.AssertMapping("runs");
281              var usingToken = default(StringToken);
282              var imageToken = default(StringToken);
283              var argsToken = default(SequenceToken);
284              var entrypointToken = default(StringToken);
285              var envToken = default(MappingToken);
286              var mainToken = default(StringToken);
287              var pluginToken = default(StringToken);
288              var preToken = default(StringToken);
289              var preEntrypointToken = default(StringToken);
290              var preIfToken = default(StringToken);
291              var postToken = default(StringToken);
292              var postEntrypointToken = default(StringToken);
293              var postIfToken = default(StringToken);
294              var steps = default(List<Pipelines.Step>);
295              foreach (var run in runsMapping)
296              {
297                  var runsKey = run.Key.AssertString("runs key").Value;
298                  switch (runsKey)
299                  {
300                      case "using":
301                          usingToken = run.Value.AssertString("using");
302                          break;
303                      case "image":
304                          imageToken = run.Value.AssertString("image");
305                          break;
306                      case "args":
307                          argsToken = run.Value.AssertSequence("args");
308                          break;
309                      case "entrypoint":
310                          entrypointToken = run.Value.AssertString("entrypoint");
311                          break;
312                      case "env":
313                          envToken = run.Value.AssertMapping("env");
314                          break;
315                      case "main":
316                          mainToken = run.Value.AssertString("main");
317                          break;
318                      case "plugin":
319                          pluginToken = run.Value.AssertString("plugin");
320                          break;
321                      case "post":
322                          postToken = run.Value.AssertString("post");
323                          break;
324                      case "post-entrypoint":
325                          postEntrypointToken = run.Value.AssertString("post-entrypoint");
326                          break;
327                      case "post-if":
328                          postIfToken = run.Value.AssertString("post-if");
329                          break;
330                      case "pre":
331                          preToken = run.Value.AssertString("pre");
332                          break;
333                      case "pre-entrypoint":
334                          preEntrypointToken = run.Value.AssertString("pre-entrypoint");
335                          break;
336                      case "pre-if":
337                          preIfToken = run.Value.AssertString("pre-if");
338                          break;
339                      case "steps":
340                          var stepsToken = run.Value.AssertSequence("steps");
341                          steps = PipelineTemplateConverter.ConvertToSteps(templateContext, stepsToken);
342                          templateContext.Errors.Check();
343                          break;
344                      default:
345                          Trace.Info($"Ignore run property {runsKey}.");
346                          break;
347                  }
348              }
349              if (usingToken != null)
350              {
351                  if (string.Equals(usingToken.Value, "docker", StringComparison.OrdinalIgnoreCase))
352                  {
353                      if (string.IsNullOrEmpty(imageToken?.Value))
354                      {
355                          throw new ArgumentNullException($"You are using a Container Action but an image is not provided in {fileRelativePath}.");
356                      }
357                      else
358                      {
359                          return new ContainerActionExecutionData()
360                          {
361                              Image = imageToken.Value,
362                              Arguments = argsToken,
363                              EntryPoint = entrypointToken?.Value,
364                              Environment = envToken,
<span onclick='openModal()' class='match'>365                              Pre = preEntrypointToken?.Value,
366                              InitCondition = preIfToken?.Value ?? "always()",
367                              Post = postEntrypointToken?.Value,
368                              CleanupCondition = postIfToken?.Value ?? "always()"
369                          };
370                      }
371                  }
372                  else if (string.Equals(usingToken.Value, "node12", StringComparison.OrdinalIgnoreCase) ||
</span>373                           string.Equals(usingToken.Value, "node16", StringComparison.OrdinalIgnoreCase))
374                  {
375                      if (string.IsNullOrEmpty(mainToken?.Value))
376                      {
377                          throw new ArgumentNullException($"You are using a JavaScript Action but there is not an entry JavaScript file provided in {fileRelativePath}.");
378                      }
379                      else
380                      {
381                          return new NodeJSActionExecutionData()
382                          {
383                              NodeVersion = usingToken.Value,
384                              Script = mainToken.Value,
385                              Pre = preToken?.Value,
386                              InitCondition = preIfToken?.Value ?? "always()",
387                              Post = postToken?.Value,
388                              CleanupCondition = postIfToken?.Value ?? "always()"
389                          };
390                      }
391                  }
392                  else if (string.Equals(usingToken.Value, "composite", StringComparison.OrdinalIgnoreCase))
393                  {
394                      if (steps == null)
395                      {
396                          throw new ArgumentNullException($"You are using a composite action but there are no steps provided in {fileRelativePath}.");
397                      }
398                      else
399                      {
400                          return new CompositeActionExecutionData()
401                          {
402                              Steps = steps.Cast<Pipelines.ActionStep>().ToList(),
403                              PreSteps = new List<Pipelines.ActionStep>(),
404                              PostSteps = new Stack<Pipelines.ActionStep>(),
405                              InitCondition = "always()",
406                              CleanupCondition = "always()",
407                              Outputs = outputs
408                          };
409                      }
410                  }
411                  else
412                  {
413                      throw new ArgumentOutOfRangeException($"'using: {usingToken.Value}' is not supported, use 'docker', 'node12' or 'node16' instead.");
414                  }
415              }
416              else if (pluginToken != null)
417              {
418                  return new PluginActionExecutionData()
419                  {
420                      Plugin = pluginToken.Value
421                  };
422              }
423              throw new NotSupportedException("Missing 'using' value. 'using' requires 'composite', 'docker', 'node12' or 'node16'.");
424          }
425          private void ConvertInputs(
426              TemplateToken inputsToken,
427              ActionDefinitionData actionDefinition)
428          {
429              actionDefinition.Inputs = new MappingToken(null, null, null);
430              var inputsMapping = inputsToken.AssertMapping("inputs");
431              foreach (var input in inputsMapping)
432              {
433                  bool hasDefault = false;
434                  var inputName = input.Key.AssertString("input name");
435                  var inputMetadata = input.Value.AssertMapping("input metadata");
436                  foreach (var metadata in inputMetadata)
437                  {
438                      var metadataName = metadata.Key.AssertString("input metadata").Value;
439                      if (string.Equals(metadataName, "default", StringComparison.OrdinalIgnoreCase))
440                      {
441                          hasDefault = true;
442                          actionDefinition.Inputs.Add(inputName, metadata.Value);
443                      }
444                      else if (string.Equals(metadataName, "deprecationMessage", StringComparison.OrdinalIgnoreCase))
445                      {
446                          if (actionDefinition.Deprecated == null)
447                          {
448                              actionDefinition.Deprecated = new Dictionary<String, String>();
449                          }
450                          var message = metadata.Value.AssertString("input deprecationMessage");
451                          actionDefinition.Deprecated.Add(inputName.Value, message.Value);
452                      }
453                  }
454                  if (!hasDefault)
455                  {
456                      actionDefinition.Inputs.Add(inputName, new StringToken(null, null, null, string.Empty));
457                  }
458              }
459          }
460      }
461  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ActionManifestManager.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ActionManifestManager.cs</div>
                </div>
                <div class="column column_space"><pre><code>365                              Pre = preEntrypointToken?.Value,
366                              InitCondition = preIfToken?.Value ?? "always()",
367                              Post = postEntrypointToken?.Value,
368                              CleanupCondition = postIfToken?.Value ?? "always()"
369                          };
370                      }
371                  }
372                  else if (string.Equals(usingToken.Value, "node12", StringComparison.OrdinalIgnoreCase) ||
</pre></code></div>
                <div class="column column_space"><pre><code>365                              Pre = preEntrypointToken?.Value,
366                              InitCondition = preIfToken?.Value ?? "always()",
367                              Post = postEntrypointToken?.Value,
368                              CleanupCondition = postIfToken?.Value ?? "always()"
369                          };
370                      }
371                  }
372                  else if (string.Equals(usingToken.Value, "node12", StringComparison.OrdinalIgnoreCase) ||
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    