
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 13, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-FunctionTests.cs</h3>
            <pre><code>1  using System;
2  using System.Data;
3  using System.Threading.Tasks;
4  using Npgsql.PostgresTypes;
5  using NpgsqlTypes;
6  using NUnit.Framework;
7  using static Npgsql.Util.Statics;
8  using static Npgsql.Tests.TestUtil;
9  namespace Npgsql.Tests;
10  [NonParallelizable] 
11  public class FunctionTests : TestBase
12  {
13      [Test, Description(&quot;Simple function with no parameters, results accessed as a resultset&quot;)]
14      public async Task Resultset()
15      {
16          await using var conn = await OpenConnectionAsync();
17          var function = await GetTempFunctionName(conn);
18          await conn.ExecuteNonQueryAsync($&quot;CREATE FUNCTION {function}() RETURNS integer AS &#x27;SELECT 8&#x27; LANGUAGE sql&quot;);
19          await using var cmd = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
20          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(8));
21      }
22      [Test, Description(&quot;Basic function call with an in parameter&quot;)]
23      public async Task Param_Input()
24      {
25          await using var conn = await OpenConnectionAsync();
26          var function = await GetTempFunctionName(conn);
27          await conn.ExecuteNonQueryAsync($&quot;CREATE FUNCTION {function}(IN param text) RETURNS text AS &#x27;SELECT param&#x27; LANGUAGE sql&quot;);
28          await using var cmd = new NpgsqlCommand(function, conn);
29          cmd.CommandType = CommandType.StoredProcedure;
30          cmd.Parameters.AddWithValue(&quot;@param&quot;, &quot;hello&quot;);
31          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(&quot;hello&quot;));
32      }
33      [Test, Description(&quot;Basic function call with an out parameter&quot;)]
34      public async Task Param_Output()
35      {
36          await using var conn = await OpenConnectionAsync();
37          var function = await GetTempFunctionName(conn);
38          await conn.ExecuteNonQueryAsync(@$&quot;
39  CREATE FUNCTION {function} (IN param_in text, OUT param_out text) AS $$
40  BEGIN
41      param_out=param_in;
42  END
43  $$ LANGUAGE plpgsql&quot;);
44          await using var cmd = new NpgsqlCommand(function, conn);
45          cmd.CommandType = CommandType.StoredProcedure;
46          cmd.Parameters.AddWithValue(&quot;@param_in&quot;, &quot;hello&quot;);
47          var outParam = new NpgsqlParameter(&quot;param_out&quot;, DbType.String) { Direction = ParameterDirection.Output };
48          cmd.Parameters.Add(outParam);
49          await cmd.ExecuteNonQueryAsync();
50          Assert.That(outParam.Value, Is.EqualTo(&quot;hello&quot;));
51      }
52      [Test, Description(&quot;Basic function call with an in/out parameter&quot;)]
53      public async Task Param_InputOutput()
54      {
55          await using var conn = await OpenConnectionAsync();
56          var function = await GetTempFunctionName(conn);
57          await conn.ExecuteNonQueryAsync($@&quot;
58  CREATE FUNCTION {function} (INOUT param integer) AS $$
59  BEGIN
60      param=param+1;
61  END
62  $$ LANGUAGE plpgsql&quot;);
63          await using var cmd = new NpgsqlCommand(function, conn);
64          cmd.CommandType = CommandType.StoredProcedure;
65          var outParam = new NpgsqlParameter(&quot;param&quot;, DbType.Int32)
66          {
67              Direction = ParameterDirection.InputOutput,
68              Value = 8
69          };
70          cmd.Parameters.Add(outParam);
71          await cmd.ExecuteNonQueryAsync();
72          Assert.That(outParam.Value, Is.EqualTo(9));
73      }
74      [Test]
75      public async Task Void()
76      {
77          await using var conn = await OpenConnectionAsync();
78          MinimumPgVersion(conn, &quot;9.1.0&quot;, &quot;no binary output function available for type void before 9.1.0&quot;);
79          var command = new NpgsqlCommand(&quot;pg_sleep&quot;, conn);
80          command.Parameters.AddWithValue(0);
81          command.CommandType = CommandType.StoredProcedure;
82          await command.ExecuteNonQueryAsync();
83      }
84      [Test]
85      public async Task Named_parameters()
86      {
87          await using var conn = await OpenConnectionAsync();
88          MinimumPgVersion(conn, &quot;9.4.0&quot;, &quot;make_timestamp was introduced in 9.4&quot;);
89          await using var command = new NpgsqlCommand(&quot;make_timestamp&quot;, conn);
90          command.CommandType = CommandType.StoredProcedure;
91          command.Parameters.AddWithValue(&quot;year&quot;, 2015);
92          command.Parameters.AddWithValue(&quot;month&quot;, 8);
93          command.Parameters.AddWithValue(&quot;mday&quot;, 1);
94          command.Parameters.AddWithValue(&quot;hour&quot;, 2);
95          command.Parameters.AddWithValue(&quot;min&quot;, 3);
96          command.Parameters.AddWithValue(&quot;sec&quot;, 4);
97          var dt = (DateTime)(await command.ExecuteScalarAsync())!;
98          Assert.AreEqual(new DateTime(2015, 8, 1, 2, 3, 4), dt);
99          command.Parameters[0].Value = 2014;
100          command.Parameters[0].ParameterName = &quot;&quot;; 
101          dt = (DateTime)(await command.ExecuteScalarAsync())!;
102          Assert.AreEqual(new DateTime(2014, 8, 1, 2, 3, 4), dt);
103      }
104      [Test]
105      public async Task Too_many_output_params()
106      {
107          await using var conn = await OpenConnectionAsync();
108          var command = new NpgsqlCommand(&quot;VALUES (4,5), (6,7)&quot;, conn);
109          command.Parameters.Add(new NpgsqlParameter(&quot;a&quot;, DbType.Int32)
110          {
<span onclick='openModal()' class='match'>111              Direction = ParameterDirection.Output,
112              Value = -1
113          });
114          command.Parameters.Add(new NpgsqlParameter(&quot;b&quot;, DbType.Int32)
</span>115          {
116              Direction = ParameterDirection.Output,
117              Value = -1
118          });
119          command.Parameters.Add(new NpgsqlParameter(&quot;c&quot;, DbType.Int32)
120          {
121              Direction = ParameterDirection.Output,
122              Value = -1
123          });
124          await command.ExecuteNonQueryAsync();
125          Assert.That(command.Parameters[&quot;a&quot;].Value, Is.EqualTo(4));
126          Assert.That(command.Parameters[&quot;b&quot;].Value, Is.EqualTo(5));
127          Assert.That(command.Parameters[&quot;c&quot;].Value, Is.EqualTo(-1));
128      }
129      [Test]
130      public async Task CommandBehavior_SchemaOnly_support_function_call()
131      {
132          await using var conn = await OpenConnectionAsync();
133          var function = await GetTempFunctionName(conn);
134          await conn.ExecuteNonQueryAsync($&quot;CREATE OR REPLACE FUNCTION {function}() RETURNS SETOF integer as &#x27;SELECT 1;&#x27; LANGUAGE &#x27;sql&#x27;;&quot;);
135          var command = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
136          await using var dr = await command.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
137          var i = 0;
138          while (dr.Read())
139              i++;
140          Assert.AreEqual(0, i);
141      }
142      #region DeriveParameters
143      [Test, Description(&quot;Tests function parameter derivation with IN, OUT and INOUT parameters&quot;)]
144      public async Task DeriveParameters_function_various()
145      {
146          await using var conn = await OpenConnectionAsync();
147          var function = await GetTempFunctionName(conn);
148          await conn.ExecuteNonQueryAsync($@&quot;
149  CREATE FUNCTION {function}(IN param1 INT, OUT param2 text, INOUT param3 INT) RETURNS record AS $$
150  BEGIN
151      param2 = &#x27;sometext&#x27;;
152      param3 = param1 + param3;
153  END;
154  $$ LANGUAGE plpgsql&quot;);
155          await using var cmd = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
156          NpgsqlCommandBuilder.DeriveParameters(cmd);
157          Assert.That(cmd.Parameters, Has.Count.EqualTo(3));
158          Assert.That(cmd.Parameters[0].Direction, Is.EqualTo(ParameterDirection.Input));
159          Assert.That(cmd.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Integer));
160          Assert.That(cmd.Parameters[0].PostgresType, Is.TypeOf&lt;PostgresBaseType&gt;());
161          Assert.That(cmd.Parameters[0].DataTypeName, Is.EqualTo(&quot;integer&quot;));
162          Assert.That(cmd.Parameters[0].ParameterName, Is.EqualTo(&quot;param1&quot;));
163          Assert.That(cmd.Parameters[1].Direction, Is.EqualTo(ParameterDirection.Output));
164          Assert.That(cmd.Parameters[1].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Text));
165          Assert.That(cmd.Parameters[1].PostgresType, Is.TypeOf&lt;PostgresBaseType&gt;());
166          Assert.That(cmd.Parameters[1].DataTypeName, Is.EqualTo(&quot;text&quot;));
167          Assert.That(cmd.Parameters[1].ParameterName, Is.EqualTo(&quot;param2&quot;));
168          Assert.That(cmd.Parameters[2].Direction, Is.EqualTo(ParameterDirection.InputOutput));
169          Assert.That(cmd.Parameters[2].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Integer));
170          Assert.That(cmd.Parameters[2].PostgresType, Is.TypeOf&lt;PostgresBaseType&gt;());
171          Assert.That(cmd.Parameters[2].DataTypeName, Is.EqualTo(&quot;integer&quot;));
172          Assert.That(cmd.Parameters[2].ParameterName, Is.EqualTo(&quot;param3&quot;));
173          cmd.Parameters[0].Value = 5;
174          cmd.Parameters[2].Value = 4;
175          await cmd.ExecuteNonQueryAsync();
176          Assert.That(cmd.Parameters[0].Value, Is.EqualTo(5));
177          Assert.That(cmd.Parameters[1].Value, Is.EqualTo(&quot;sometext&quot;));
178          Assert.That(cmd.Parameters[2].Value, Is.EqualTo(9));
179      }
180      [Test, Description(&quot;Tests function parameter derivation with IN-only parameters&quot;)]
181      public async Task DeriveParameters_function_in_only()
182      {
183          await using var conn = await OpenConnectionAsync();
184          var function = await GetTempFunctionName(conn);
185          await conn.ExecuteNonQueryAsync(
186              $@&quot;CREATE FUNCTION {function}(IN param1 INT, IN param2 INT) RETURNS int AS &#x27;SELECT param1 + param2&#x27; LANGUAGE sql&quot;);
187          await using var cmd = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
188          NpgsqlCommandBuilder.DeriveParameters(cmd);
189          Assert.That(cmd.Parameters, Has.Count.EqualTo(2));
190          Assert.That(cmd.Parameters[0].Direction, Is.EqualTo(ParameterDirection.Input));
191          Assert.That(cmd.Parameters[1].Direction, Is.EqualTo(ParameterDirection.Input));
192          cmd.Parameters[0].Value = 5;
193          cmd.Parameters[1].Value = 4;
194          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(9));
195      }
196      [Test, Description(&quot;Tests function parameter derivation with no parameters&quot;)]
197      public async Task DeriveParameters_function_no_params()
198      {
199          await using var conn = await OpenConnectionAsync();
200          var function = await GetTempFunctionName(conn);
201          await conn.ExecuteNonQueryAsync($@&quot;CREATE FUNCTION {function}() RETURNS int AS &#x27;SELECT 4&#x27; LANGUAGE sql&quot;);
202          await using var cmd = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
203          NpgsqlCommandBuilder.DeriveParameters(cmd);
204          Assert.That(cmd.Parameters, Is.Empty);
205      }
206      [Test]
207      public async Task DeriveParameters_function_with_case_sensitive_name()
208      {
209          await using var conn = await OpenConnectionAsync();
210          await conn.ExecuteNonQueryAsync(
211              @&quot;CREATE OR REPLACE FUNCTION &quot;&quot;FunctionCaseSensitive&quot;&quot;(int4, text) RETURNS int4 AS &#x27;SELECT 0&#x27; LANGUAGE sql&quot;);
212          try
213          {
214              await using var command = new NpgsqlCommand(@&quot;&quot;&quot;FunctionCaseSensitive&quot;&quot;&quot;, conn) { CommandType = CommandType.StoredProcedure };
215              NpgsqlCommandBuilder.DeriveParameters(command);
216              Assert.AreEqual(NpgsqlDbType.Integer, command.Parameters[0].NpgsqlDbType);
217              Assert.AreEqual(NpgsqlDbType.Text, command.Parameters[1].NpgsqlDbType);
218          }
219          finally
220          {
221              await conn.ExecuteNonQueryAsync(@&quot;DROP FUNCTION &quot;&quot;FunctionCaseSensitive&quot;&quot;&quot;);
222          }
223      }
224      [Test, Description(&quot;Tests function parameter derivation for quoted functions with double quotes in the name works&quot;)]
225      public async Task DeriveParameters_quote_characters_in_function_name()
226      {
227          await using var conn = await OpenConnectionAsync();
228          var function = @&quot;&quot;&quot;&quot;&quot;&quot;&quot;FunctionQuote&quot;&quot;&quot;&quot;CharactersInName&quot;&quot;&quot;&quot;&quot;&quot;&quot;;
229          await conn.ExecuteNonQueryAsync($&quot;CREATE OR REPLACE FUNCTION {function}(int4, text) RETURNS int4 AS &#x27;SELECT 0&#x27; LANGUAGE sql&quot;);
230          try
231          {
232              await using var command = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
233              NpgsqlCommandBuilder.DeriveParameters(command);
234              Assert.AreEqual(NpgsqlDbType.Integer, command.Parameters[0].NpgsqlDbType);
235              Assert.AreEqual(NpgsqlDbType.Text, command.Parameters[1].NpgsqlDbType);
236          }
237          finally
238          {
239              await conn.ExecuteNonQueryAsync(&quot;DROP FUNCTION &quot; + function);
240          }
241      }
242      [Test, Description(&quot;Tests function parameter derivation for quoted functions with dots in the name works&quot;)]
243      public async Task DeriveParameters_dot_character_in_function_name()
244      {
245          await using var conn = await OpenConnectionAsync();
246          await conn.ExecuteNonQueryAsync(
247              @&quot;CREATE OR REPLACE FUNCTION &quot;&quot;My.Dotted.Function&quot;&quot;(int4, text) RETURNS int4 AS &#x27;SELECT 0&#x27; LANGUAGE sql&quot;);
248          try
249          {
250              await using var command = new NpgsqlCommand(@&quot;&quot;&quot;My.Dotted.Function&quot;&quot;&quot;, conn) { CommandType = CommandType.StoredProcedure };
251              NpgsqlCommandBuilder.DeriveParameters(command);
252              Assert.AreEqual(NpgsqlDbType.Integer, command.Parameters[0].NpgsqlDbType);
253              Assert.AreEqual(NpgsqlDbType.Text, command.Parameters[1].NpgsqlDbType);
254          }
255          finally
256          {
257              await conn.ExecuteNonQueryAsync(@&quot;DROP FUNCTION &quot;&quot;My.Dotted.Function&quot;&quot;&quot;);
258          }
259      }
260      [Test]
261      public async Task DeriveParameters_parameter_name_from_function()
262      {
263          await using var conn = await OpenConnectionAsync();
264          var function = await GetTempFunctionName(conn);
265          await conn.ExecuteNonQueryAsync(
266              $&quot;CREATE FUNCTION {function}(x int, y int, out sum int, out product int) AS &#x27;SELECT $1 + $2, $1 * $2&#x27; LANGUAGE sql&quot;);
267          await using var command = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
268          NpgsqlCommandBuilder.DeriveParameters(command);
269          Assert.AreEqual(&quot;x&quot;, command.Parameters[0].ParameterName);
270          Assert.AreEqual(&quot;y&quot;, command.Parameters[1].ParameterName);
271      }
272      [Test]
273      public async Task DeriveParameters_non_existing_function()
274      {
275          await using var conn = await OpenConnectionAsync();
276          var invalidCommandName = new NpgsqlCommand(&quot;invalidfunctionname&quot;, conn) { CommandType = CommandType.StoredProcedure };
277          Assert.That(() =&gt; NpgsqlCommandBuilder.DeriveParameters(invalidCommandName),
278              Throws.Exception.TypeOf&lt;PostgresException&gt;()
279                  .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.UndefinedFunction));
280      }
281      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/1212&quot;)]
282      public async Task DeriveParameters_function_with_table_parameters()
283      {
284          await using var conn = await OpenConnectionAsync();
285          MinimumPgVersion(conn, &quot;9.2.0&quot;);
286          var function = await GetTempFunctionName(conn);
287          await conn.ExecuteNonQueryAsync(
288              $&quot;CREATE FUNCTION {function}(IN in1 INT) RETURNS TABLE(t1 INT, t2 INT) AS &#x27;SELECT in1, in1+1&#x27; LANGUAGE sql&quot;);
289          await using var cmd = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
290          NpgsqlCommandBuilder.DeriveParameters(cmd);
291          Assert.That(cmd.Parameters, Has.Count.EqualTo(3));
292          Assert.That(cmd.Parameters[0].Direction, Is.EqualTo(ParameterDirection.Input));
293          Assert.That(cmd.Parameters[1].Direction, Is.EqualTo(ParameterDirection.Output));
294          Assert.That(cmd.Parameters[2].Direction, Is.EqualTo(ParameterDirection.Output));
295          cmd.Parameters[0].Value = 5;
296          await cmd.ExecuteNonQueryAsync();
297          Assert.That(cmd.Parameters[1].Value, Is.EqualTo(5));
298          Assert.That(cmd.Parameters[2].Value, Is.EqualTo(6));
299      }
300      [Test, Description(&quot;Tests if the right function according to search_path is used in function parameter derivation&quot;)]
301      public async Task DeriveParameters_function_correct_schema_resolution()
302      {
303          await using var conn = await OpenConnectionAsync();
304          var schema1 = await CreateTempSchema(conn);
305          var schema2 = await CreateTempSchema(conn);
306          await conn.ExecuteNonQueryAsync($@&quot;
307  CREATE FUNCTION {schema1}.redundantfunc() RETURNS int AS &#x27;SELECT 1&#x27; LANGUAGE sql;
308  CREATE FUNCTION {schema2}.redundantfunc(IN param1 INT, IN param2 INT) RETURNS int AS &#x27;SELECT param1 + param2&#x27; LANGUAGE sql;
309  SET search_path TO {schema2};&quot;);
310          await using var command = new NpgsqlCommand(&quot;redundantfunc&quot;, conn) { CommandType = CommandType.StoredProcedure };
311          NpgsqlCommandBuilder.DeriveParameters(command);
312          Assert.That(command.Parameters, Has.Count.EqualTo(2));
313          Assert.That(command.Parameters[0].Direction, Is.EqualTo(ParameterDirection.Input));
314          Assert.That(command.Parameters[1].Direction, Is.EqualTo(ParameterDirection.Input));
315          command.Parameters[0].Value = 5;
316          command.Parameters[1].Value = 4;
317          Assert.That(await command.ExecuteScalarAsync(), Is.EqualTo(9));
318      }
319      [Test, Description(&quot;Tests if function parameter derivation throws an exception if the specified function is not in the search_path&quot;)]
320      public async Task DeriveParameters_throws_for_existing_function_that_is_not_in_search_path()
321      {
322          await using var conn = await OpenConnectionAsync();
323          var schema = await CreateTempSchema(conn);
324          await conn.ExecuteNonQueryAsync($@&quot;
325  CREATE FUNCTION {schema}.schema1func() RETURNS int AS &#x27;SELECT 1&#x27; LANGUAGE sql;
326  RESET search_path;&quot;);
327          await using var command = new NpgsqlCommand(&quot;schema1func&quot;, conn) { CommandType = CommandType.StoredProcedure };
328          Assert.That(() =&gt; NpgsqlCommandBuilder.DeriveParameters(command),
329              Throws.Exception.TypeOf&lt;PostgresException&gt;()
330                  .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.UndefinedFunction));
331      }
332      [Test, Description(&quot;Tests if an exception is thrown if multiple functions with the specified name are in the search_path&quot;)]
333      public async Task DeriveParameters_throws_for_multiple_function_name_hits_in_search_path()
334      {
335          await using var conn = await OpenConnectionAsync();
336          var schema1 = await CreateTempSchema(conn);
337          var schema2 = await CreateTempSchema(conn);
338          await conn.ExecuteNonQueryAsync(
339              $@&quot;
340  CREATE FUNCTION {schema1}.redundantfunc() RETURNS int AS &#x27;SELECT 1&#x27; LANGUAGE sql;
341  CREATE FUNCTION {schema1}.redundantfunc(IN param1 INT, IN param2 INT) RETURNS int AS &#x27;SELECT param1 + param2&#x27; LANGUAGE sql;
342  SET search_path TO {schema1}, {schema2};&quot;);
343          var command = new NpgsqlCommand(&quot;redundantfunc&quot;, conn) { CommandType = CommandType.StoredProcedure };
344          Assert.That(() =&gt; NpgsqlCommandBuilder.DeriveParameters(command),
345              Throws.Exception.TypeOf&lt;PostgresException&gt;()
346                  .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.AmbiguousFunction));
347      }
348      #region Set returning functions
349      [Test, Description(&quot;Tests parameter derivation for a function that returns SETOF sometype&quot;)]
350      public async Task DeriveParameters_function_returning_setof_type()
351      {
352          await using var conn = await OpenConnectionAsync();
353          MinimumPgVersion(conn, &quot;9.2.0&quot;);
354          var table = await GetTempTableName(conn);
355          var function = await GetTempFunctionName(conn);
356          await conn.ExecuteNonQueryAsync($@&quot;
357  CREATE TABLE {table} (fooid int, foosubid int, fooname text);
358  INSERT INTO {table} VALUES (1, 1, &#x27;Joe&#x27;), (1, 2, &#x27;Ed&#x27;), (2, 1, &#x27;Mary&#x27;);
359  CREATE FUNCTION {function}(int) RETURNS SETOF {table} AS $$
360      SELECT * FROM {table} WHERE {table}.fooid = $1 ORDER BY {table}.foosubid;
361  $$ LANGUAGE sql&quot;);
362          await using var cmd = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
363          NpgsqlCommandBuilder.DeriveParameters(cmd);
364          Assert.That(cmd.Parameters, Has.Count.EqualTo(4));
365          Assert.That(cmd.Parameters[0].Direction, Is.EqualTo(ParameterDirection.Input));
366          Assert.That(cmd.Parameters[1].Direction, Is.EqualTo(ParameterDirection.Output));
367          Assert.That(cmd.Parameters[2].Direction, Is.EqualTo(ParameterDirection.Output));
368          Assert.That(cmd.Parameters[3].Direction, Is.EqualTo(ParameterDirection.Output));
369          cmd.Parameters[0].Value = 1;
370          await cmd.ExecuteNonQueryAsync();
371          Assert.That(cmd.Parameters[0].Value, Is.EqualTo(1));
372      }
373      [Test, Description(&quot;Tests parameter derivation for a function that returns TABLE&quot;)]
374      public async Task DeriveParameters_function_returning_table()
375      {
376          await using var conn = await OpenConnectionAsync();
377          MinimumPgVersion(conn, &quot;9.2.0&quot;);
378          var table = await GetTempTableName(conn);
379          var function = await GetTempFunctionName(conn);
380          await conn.ExecuteNonQueryAsync($@&quot;
381  CREATE TABLE {table} (fooid int, foosubid int, fooname text);
382  INSERT INTO {table} VALUES (1, 1, &#x27;Joe&#x27;), (1, 2, &#x27;Ed&#x27;), (2, 1, &#x27;Mary&#x27;);
383  CREATE FUNCTION {function}(int) RETURNS TABLE(fooid int, foosubid int, fooname text) AS $$
384      SELECT * FROM {table} WHERE {table}.fooid = $1 ORDER BY {table}.foosubid;
385  $$ LANGUAGE sql&quot;);
386          await using var cmd = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
387          NpgsqlCommandBuilder.DeriveParameters(cmd);
388          Assert.That(cmd.Parameters, Has.Count.EqualTo(4));
389          Assert.That(cmd.Parameters[0].Direction, Is.EqualTo(ParameterDirection.Input));
390          Assert.That(cmd.Parameters[1].Direction, Is.EqualTo(ParameterDirection.Output));
391          Assert.That(cmd.Parameters[2].Direction, Is.EqualTo(ParameterDirection.Output));
392          Assert.That(cmd.Parameters[3].Direction, Is.EqualTo(ParameterDirection.Output));
393          cmd.Parameters[0].Value = 1;
394          await cmd.ExecuteNonQueryAsync();
395          Assert.That(cmd.Parameters[0].Value, Is.EqualTo(1));
396      }
397      [Test, Description(&quot;Tests parameter derivation for a function that returns SETOF record&quot;)]
398      public async Task DeriveParameters_function_returning_setof_record()
399      {
400          await using var conn = await OpenConnectionAsync();
401          MinimumPgVersion(conn, &quot;9.2.0&quot;);
402          var table = await GetTempTableName(conn);
403          var function = await GetTempFunctionName(conn);
404          await conn.ExecuteNonQueryAsync($@&quot;
405  CREATE TABLE {table} (fooid int, foosubid int, fooname text);
406  INSERT INTO {table} VALUES (1, 1, &#x27;Joe&#x27;), (1, 2, &#x27;Ed&#x27;), (2, 1, &#x27;Mary&#x27;);
407  CREATE FUNCTION {function}(int, OUT fooid int, OUT foosubid int, OUT fooname text) RETURNS SETOF record AS $$
408      SELECT * FROM {table} WHERE {table}.fooid = $1 ORDER BY {table}.foosubid;
409  $$ LANGUAGE sql&quot;);
410          await using var cmd = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
411          NpgsqlCommandBuilder.DeriveParameters(cmd);
412          Assert.That(cmd.Parameters, Has.Count.EqualTo(4));
413          Assert.That(cmd.Parameters[0].Direction, Is.EqualTo(ParameterDirection.Input));
414          Assert.That(cmd.Parameters[1].Direction, Is.EqualTo(ParameterDirection.Output));
415          Assert.That(cmd.Parameters[2].Direction, Is.EqualTo(ParameterDirection.Output));
416          Assert.That(cmd.Parameters[3].Direction, Is.EqualTo(ParameterDirection.Output));
417          cmd.Parameters[0].Value = 1;
418          await cmd.ExecuteNonQueryAsync();
419          Assert.That(cmd.Parameters[0].Value, Is.EqualTo(1));
420      }
421      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2022&quot;)]
422      public async Task DeriveParameters_function_returning_setof_type_with_dropped_column()
423      {
424          await using var conn = await OpenConnectionAsync();
425          MinimumPgVersion(conn, &quot;9.2.0&quot;);
426          var table = await GetTempTableName(conn);
427          var function = await GetTempFunctionName(conn);
428          await conn.ExecuteNonQueryAsync($@&quot;
429  CREATE TABLE {table} (id serial PRIMARY KEY, t1 text, t2 text);
430  CREATE FUNCTION {function}() RETURNS SETOF {table} AS &#x27;SELECT * FROM {table}&#x27; LANGUAGE sql;
431  ALTER TABLE {table} DROP t2;&quot;);
432          await using var cmd = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
433          NpgsqlCommandBuilder.DeriveParameters(cmd);
434          Assert.That(cmd.Parameters, Has.Count.EqualTo(2));
435          Assert.That(cmd.Parameters[0].Direction, Is.EqualTo(ParameterDirection.Output));
436          Assert.That(cmd.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Integer));
437          Assert.That(cmd.Parameters[1].Direction, Is.EqualTo(ParameterDirection.Output));
438          Assert.That(cmd.Parameters[1].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Text));
439      }
440      #endregion
441      #endregion DeriveParameters
442  #if DEBUG
443      [OneTimeSetUp]
444      public void OneTimeSetup() =&gt; NpgsqlCommand.EnableStoredProcedureCompatMode = true;
445      [OneTimeTearDown]
446      public void OneTimeTeardown() =&gt; NpgsqlCommand.EnableStoredProcedureCompatMode = false;
447  #else
448      [OneTimeSetUp]
449      public void OneTimeSetup()
450          =&gt; Assert.Ignore(&quot;Cannot test function invocation via CommandType.StoredProcedure since that depends on the global EnableStoredProcedureCompatMode compatibility flag&quot;);
451  #endif
452  }
</code></pre>
        </div>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-FunctionTests.cs</h3>
            <pre><code>1  using System;
2  using System.Data;
3  using System.Threading.Tasks;
4  using Npgsql.PostgresTypes;
5  using NpgsqlTypes;
6  using NUnit.Framework;
7  using static Npgsql.Util.Statics;
8  using static Npgsql.Tests.TestUtil;
9  namespace Npgsql.Tests;
10  [NonParallelizable] 
11  public class FunctionTests : TestBase
12  {
13      [Test, Description(&quot;Simple function with no parameters, results accessed as a resultset&quot;)]
14      public async Task Resultset()
15      {
16          await using var conn = await OpenConnectionAsync();
17          var function = await GetTempFunctionName(conn);
18          await conn.ExecuteNonQueryAsync($&quot;CREATE FUNCTION {function}() RETURNS integer AS &#x27;SELECT 8&#x27; LANGUAGE sql&quot;);
19          await using var cmd = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
20          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(8));
21      }
22      [Test, Description(&quot;Basic function call with an in parameter&quot;)]
23      public async Task Param_Input()
24      {
25          await using var conn = await OpenConnectionAsync();
26          var function = await GetTempFunctionName(conn);
27          await conn.ExecuteNonQueryAsync($&quot;CREATE FUNCTION {function}(IN param text) RETURNS text AS &#x27;SELECT param&#x27; LANGUAGE sql&quot;);
28          await using var cmd = new NpgsqlCommand(function, conn);
29          cmd.CommandType = CommandType.StoredProcedure;
30          cmd.Parameters.AddWithValue(&quot;@param&quot;, &quot;hello&quot;);
31          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(&quot;hello&quot;));
32      }
33      [Test, Description(&quot;Basic function call with an out parameter&quot;)]
34      public async Task Param_Output()
35      {
36          await using var conn = await OpenConnectionAsync();
37          var function = await GetTempFunctionName(conn);
38          await conn.ExecuteNonQueryAsync(@$&quot;
39  CREATE FUNCTION {function} (IN param_in text, OUT param_out text) AS $$
40  BEGIN
41      param_out=param_in;
42  END
43  $$ LANGUAGE plpgsql&quot;);
44          await using var cmd = new NpgsqlCommand(function, conn);
45          cmd.CommandType = CommandType.StoredProcedure;
46          cmd.Parameters.AddWithValue(&quot;@param_in&quot;, &quot;hello&quot;);
47          var outParam = new NpgsqlParameter(&quot;param_out&quot;, DbType.String) { Direction = ParameterDirection.Output };
48          cmd.Parameters.Add(outParam);
49          await cmd.ExecuteNonQueryAsync();
50          Assert.That(outParam.Value, Is.EqualTo(&quot;hello&quot;));
51      }
52      [Test, Description(&quot;Basic function call with an in/out parameter&quot;)]
53      public async Task Param_InputOutput()
54      {
55          await using var conn = await OpenConnectionAsync();
56          var function = await GetTempFunctionName(conn);
57          await conn.ExecuteNonQueryAsync($@&quot;
58  CREATE FUNCTION {function} (INOUT param integer) AS $$
59  BEGIN
60      param=param+1;
61  END
62  $$ LANGUAGE plpgsql&quot;);
63          await using var cmd = new NpgsqlCommand(function, conn);
64          cmd.CommandType = CommandType.StoredProcedure;
65          var outParam = new NpgsqlParameter(&quot;param&quot;, DbType.Int32)
66          {
67              Direction = ParameterDirection.InputOutput,
68              Value = 8
69          };
70          cmd.Parameters.Add(outParam);
71          await cmd.ExecuteNonQueryAsync();
72          Assert.That(outParam.Value, Is.EqualTo(9));
73      }
74      [Test]
75      public async Task Void()
76      {
77          await using var conn = await OpenConnectionAsync();
78          MinimumPgVersion(conn, &quot;9.1.0&quot;, &quot;no binary output function available for type void before 9.1.0&quot;);
79          var command = new NpgsqlCommand(&quot;pg_sleep&quot;, conn);
80          command.Parameters.AddWithValue(0);
81          command.CommandType = CommandType.StoredProcedure;
82          await command.ExecuteNonQueryAsync();
83      }
84      [Test]
85      public async Task Named_parameters()
86      {
87          await using var conn = await OpenConnectionAsync();
88          MinimumPgVersion(conn, &quot;9.4.0&quot;, &quot;make_timestamp was introduced in 9.4&quot;);
89          await using var command = new NpgsqlCommand(&quot;make_timestamp&quot;, conn);
90          command.CommandType = CommandType.StoredProcedure;
91          command.Parameters.AddWithValue(&quot;year&quot;, 2015);
92          command.Parameters.AddWithValue(&quot;month&quot;, 8);
93          command.Parameters.AddWithValue(&quot;mday&quot;, 1);
94          command.Parameters.AddWithValue(&quot;hour&quot;, 2);
95          command.Parameters.AddWithValue(&quot;min&quot;, 3);
96          command.Parameters.AddWithValue(&quot;sec&quot;, 4);
97          var dt = (DateTime)(await command.ExecuteScalarAsync())!;
98          Assert.AreEqual(new DateTime(2015, 8, 1, 2, 3, 4), dt);
99          command.Parameters[0].Value = 2014;
100          command.Parameters[0].ParameterName = &quot;&quot;; 
101          dt = (DateTime)(await command.ExecuteScalarAsync())!;
102          Assert.AreEqual(new DateTime(2014, 8, 1, 2, 3, 4), dt);
103      }
104      [Test]
105      public async Task Too_many_output_params()
106      {
107          await using var conn = await OpenConnectionAsync();
108          var command = new NpgsqlCommand(&quot;VALUES (4,5), (6,7)&quot;, conn);
109          command.Parameters.Add(new NpgsqlParameter(&quot;a&quot;, DbType.Int32)
110          {
111              Direction = ParameterDirection.Output,
112              Value = -1
113          });
114          command.Parameters.Add(new NpgsqlParameter(&quot;b&quot;, DbType.Int32)
115          {
<span onclick='openModal()' class='match'>116              Direction = ParameterDirection.Output,
117              Value = -1
118          });
119          command.Parameters.Add(new NpgsqlParameter(&quot;c&quot;, DbType.Int32)
</span>120          {
121              Direction = ParameterDirection.Output,
122              Value = -1
123          });
124          await command.ExecuteNonQueryAsync();
125          Assert.That(command.Parameters[&quot;a&quot;].Value, Is.EqualTo(4));
126          Assert.That(command.Parameters[&quot;b&quot;].Value, Is.EqualTo(5));
127          Assert.That(command.Parameters[&quot;c&quot;].Value, Is.EqualTo(-1));
128      }
129      [Test]
130      public async Task CommandBehavior_SchemaOnly_support_function_call()
131      {
132          await using var conn = await OpenConnectionAsync();
133          var function = await GetTempFunctionName(conn);
134          await conn.ExecuteNonQueryAsync($&quot;CREATE OR REPLACE FUNCTION {function}() RETURNS SETOF integer as &#x27;SELECT 1;&#x27; LANGUAGE &#x27;sql&#x27;;&quot;);
135          var command = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
136          await using var dr = await command.ExecuteReaderAsync(CommandBehavior.SchemaOnly);
137          var i = 0;
138          while (dr.Read())
139              i++;
140          Assert.AreEqual(0, i);
141      }
142      #region DeriveParameters
143      [Test, Description(&quot;Tests function parameter derivation with IN, OUT and INOUT parameters&quot;)]
144      public async Task DeriveParameters_function_various()
145      {
146          await using var conn = await OpenConnectionAsync();
147          var function = await GetTempFunctionName(conn);
148          await conn.ExecuteNonQueryAsync($@&quot;
149  CREATE FUNCTION {function}(IN param1 INT, OUT param2 text, INOUT param3 INT) RETURNS record AS $$
150  BEGIN
151      param2 = &#x27;sometext&#x27;;
152      param3 = param1 + param3;
153  END;
154  $$ LANGUAGE plpgsql&quot;);
155          await using var cmd = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
156          NpgsqlCommandBuilder.DeriveParameters(cmd);
157          Assert.That(cmd.Parameters, Has.Count.EqualTo(3));
158          Assert.That(cmd.Parameters[0].Direction, Is.EqualTo(ParameterDirection.Input));
159          Assert.That(cmd.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Integer));
160          Assert.That(cmd.Parameters[0].PostgresType, Is.TypeOf&lt;PostgresBaseType&gt;());
161          Assert.That(cmd.Parameters[0].DataTypeName, Is.EqualTo(&quot;integer&quot;));
162          Assert.That(cmd.Parameters[0].ParameterName, Is.EqualTo(&quot;param1&quot;));
163          Assert.That(cmd.Parameters[1].Direction, Is.EqualTo(ParameterDirection.Output));
164          Assert.That(cmd.Parameters[1].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Text));
165          Assert.That(cmd.Parameters[1].PostgresType, Is.TypeOf&lt;PostgresBaseType&gt;());
166          Assert.That(cmd.Parameters[1].DataTypeName, Is.EqualTo(&quot;text&quot;));
167          Assert.That(cmd.Parameters[1].ParameterName, Is.EqualTo(&quot;param2&quot;));
168          Assert.That(cmd.Parameters[2].Direction, Is.EqualTo(ParameterDirection.InputOutput));
169          Assert.That(cmd.Parameters[2].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Integer));
170          Assert.That(cmd.Parameters[2].PostgresType, Is.TypeOf&lt;PostgresBaseType&gt;());
171          Assert.That(cmd.Parameters[2].DataTypeName, Is.EqualTo(&quot;integer&quot;));
172          Assert.That(cmd.Parameters[2].ParameterName, Is.EqualTo(&quot;param3&quot;));
173          cmd.Parameters[0].Value = 5;
174          cmd.Parameters[2].Value = 4;
175          await cmd.ExecuteNonQueryAsync();
176          Assert.That(cmd.Parameters[0].Value, Is.EqualTo(5));
177          Assert.That(cmd.Parameters[1].Value, Is.EqualTo(&quot;sometext&quot;));
178          Assert.That(cmd.Parameters[2].Value, Is.EqualTo(9));
179      }
180      [Test, Description(&quot;Tests function parameter derivation with IN-only parameters&quot;)]
181      public async Task DeriveParameters_function_in_only()
182      {
183          await using var conn = await OpenConnectionAsync();
184          var function = await GetTempFunctionName(conn);
185          await conn.ExecuteNonQueryAsync(
186              $@&quot;CREATE FUNCTION {function}(IN param1 INT, IN param2 INT) RETURNS int AS &#x27;SELECT param1 + param2&#x27; LANGUAGE sql&quot;);
187          await using var cmd = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
188          NpgsqlCommandBuilder.DeriveParameters(cmd);
189          Assert.That(cmd.Parameters, Has.Count.EqualTo(2));
190          Assert.That(cmd.Parameters[0].Direction, Is.EqualTo(ParameterDirection.Input));
191          Assert.That(cmd.Parameters[1].Direction, Is.EqualTo(ParameterDirection.Input));
192          cmd.Parameters[0].Value = 5;
193          cmd.Parameters[1].Value = 4;
194          Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(9));
195      }
196      [Test, Description(&quot;Tests function parameter derivation with no parameters&quot;)]
197      public async Task DeriveParameters_function_no_params()
198      {
199          await using var conn = await OpenConnectionAsync();
200          var function = await GetTempFunctionName(conn);
201          await conn.ExecuteNonQueryAsync($@&quot;CREATE FUNCTION {function}() RETURNS int AS &#x27;SELECT 4&#x27; LANGUAGE sql&quot;);
202          await using var cmd = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
203          NpgsqlCommandBuilder.DeriveParameters(cmd);
204          Assert.That(cmd.Parameters, Is.Empty);
205      }
206      [Test]
207      public async Task DeriveParameters_function_with_case_sensitive_name()
208      {
209          await using var conn = await OpenConnectionAsync();
210          await conn.ExecuteNonQueryAsync(
211              @&quot;CREATE OR REPLACE FUNCTION &quot;&quot;FunctionCaseSensitive&quot;&quot;(int4, text) RETURNS int4 AS &#x27;SELECT 0&#x27; LANGUAGE sql&quot;);
212          try
213          {
214              await using var command = new NpgsqlCommand(@&quot;&quot;&quot;FunctionCaseSensitive&quot;&quot;&quot;, conn) { CommandType = CommandType.StoredProcedure };
215              NpgsqlCommandBuilder.DeriveParameters(command);
216              Assert.AreEqual(NpgsqlDbType.Integer, command.Parameters[0].NpgsqlDbType);
217              Assert.AreEqual(NpgsqlDbType.Text, command.Parameters[1].NpgsqlDbType);
218          }
219          finally
220          {
221              await conn.ExecuteNonQueryAsync(@&quot;DROP FUNCTION &quot;&quot;FunctionCaseSensitive&quot;&quot;&quot;);
222          }
223      }
224      [Test, Description(&quot;Tests function parameter derivation for quoted functions with double quotes in the name works&quot;)]
225      public async Task DeriveParameters_quote_characters_in_function_name()
226      {
227          await using var conn = await OpenConnectionAsync();
228          var function = @&quot;&quot;&quot;&quot;&quot;&quot;&quot;FunctionQuote&quot;&quot;&quot;&quot;CharactersInName&quot;&quot;&quot;&quot;&quot;&quot;&quot;;
229          await conn.ExecuteNonQueryAsync($&quot;CREATE OR REPLACE FUNCTION {function}(int4, text) RETURNS int4 AS &#x27;SELECT 0&#x27; LANGUAGE sql&quot;);
230          try
231          {
232              await using var command = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
233              NpgsqlCommandBuilder.DeriveParameters(command);
234              Assert.AreEqual(NpgsqlDbType.Integer, command.Parameters[0].NpgsqlDbType);
235              Assert.AreEqual(NpgsqlDbType.Text, command.Parameters[1].NpgsqlDbType);
236          }
237          finally
238          {
239              await conn.ExecuteNonQueryAsync(&quot;DROP FUNCTION &quot; + function);
240          }
241      }
242      [Test, Description(&quot;Tests function parameter derivation for quoted functions with dots in the name works&quot;)]
243      public async Task DeriveParameters_dot_character_in_function_name()
244      {
245          await using var conn = await OpenConnectionAsync();
246          await conn.ExecuteNonQueryAsync(
247              @&quot;CREATE OR REPLACE FUNCTION &quot;&quot;My.Dotted.Function&quot;&quot;(int4, text) RETURNS int4 AS &#x27;SELECT 0&#x27; LANGUAGE sql&quot;);
248          try
249          {
250              await using var command = new NpgsqlCommand(@&quot;&quot;&quot;My.Dotted.Function&quot;&quot;&quot;, conn) { CommandType = CommandType.StoredProcedure };
251              NpgsqlCommandBuilder.DeriveParameters(command);
252              Assert.AreEqual(NpgsqlDbType.Integer, command.Parameters[0].NpgsqlDbType);
253              Assert.AreEqual(NpgsqlDbType.Text, command.Parameters[1].NpgsqlDbType);
254          }
255          finally
256          {
257              await conn.ExecuteNonQueryAsync(@&quot;DROP FUNCTION &quot;&quot;My.Dotted.Function&quot;&quot;&quot;);
258          }
259      }
260      [Test]
261      public async Task DeriveParameters_parameter_name_from_function()
262      {
263          await using var conn = await OpenConnectionAsync();
264          var function = await GetTempFunctionName(conn);
265          await conn.ExecuteNonQueryAsync(
266              $&quot;CREATE FUNCTION {function}(x int, y int, out sum int, out product int) AS &#x27;SELECT $1 + $2, $1 * $2&#x27; LANGUAGE sql&quot;);
267          await using var command = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
268          NpgsqlCommandBuilder.DeriveParameters(command);
269          Assert.AreEqual(&quot;x&quot;, command.Parameters[0].ParameterName);
270          Assert.AreEqual(&quot;y&quot;, command.Parameters[1].ParameterName);
271      }
272      [Test]
273      public async Task DeriveParameters_non_existing_function()
274      {
275          await using var conn = await OpenConnectionAsync();
276          var invalidCommandName = new NpgsqlCommand(&quot;invalidfunctionname&quot;, conn) { CommandType = CommandType.StoredProcedure };
277          Assert.That(() =&gt; NpgsqlCommandBuilder.DeriveParameters(invalidCommandName),
278              Throws.Exception.TypeOf&lt;PostgresException&gt;()
279                  .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.UndefinedFunction));
280      }
281      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/1212&quot;)]
282      public async Task DeriveParameters_function_with_table_parameters()
283      {
284          await using var conn = await OpenConnectionAsync();
285          MinimumPgVersion(conn, &quot;9.2.0&quot;);
286          var function = await GetTempFunctionName(conn);
287          await conn.ExecuteNonQueryAsync(
288              $&quot;CREATE FUNCTION {function}(IN in1 INT) RETURNS TABLE(t1 INT, t2 INT) AS &#x27;SELECT in1, in1+1&#x27; LANGUAGE sql&quot;);
289          await using var cmd = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
290          NpgsqlCommandBuilder.DeriveParameters(cmd);
291          Assert.That(cmd.Parameters, Has.Count.EqualTo(3));
292          Assert.That(cmd.Parameters[0].Direction, Is.EqualTo(ParameterDirection.Input));
293          Assert.That(cmd.Parameters[1].Direction, Is.EqualTo(ParameterDirection.Output));
294          Assert.That(cmd.Parameters[2].Direction, Is.EqualTo(ParameterDirection.Output));
295          cmd.Parameters[0].Value = 5;
296          await cmd.ExecuteNonQueryAsync();
297          Assert.That(cmd.Parameters[1].Value, Is.EqualTo(5));
298          Assert.That(cmd.Parameters[2].Value, Is.EqualTo(6));
299      }
300      [Test, Description(&quot;Tests if the right function according to search_path is used in function parameter derivation&quot;)]
301      public async Task DeriveParameters_function_correct_schema_resolution()
302      {
303          await using var conn = await OpenConnectionAsync();
304          var schema1 = await CreateTempSchema(conn);
305          var schema2 = await CreateTempSchema(conn);
306          await conn.ExecuteNonQueryAsync($@&quot;
307  CREATE FUNCTION {schema1}.redundantfunc() RETURNS int AS &#x27;SELECT 1&#x27; LANGUAGE sql;
308  CREATE FUNCTION {schema2}.redundantfunc(IN param1 INT, IN param2 INT) RETURNS int AS &#x27;SELECT param1 + param2&#x27; LANGUAGE sql;
309  SET search_path TO {schema2};&quot;);
310          await using var command = new NpgsqlCommand(&quot;redundantfunc&quot;, conn) { CommandType = CommandType.StoredProcedure };
311          NpgsqlCommandBuilder.DeriveParameters(command);
312          Assert.That(command.Parameters, Has.Count.EqualTo(2));
313          Assert.That(command.Parameters[0].Direction, Is.EqualTo(ParameterDirection.Input));
314          Assert.That(command.Parameters[1].Direction, Is.EqualTo(ParameterDirection.Input));
315          command.Parameters[0].Value = 5;
316          command.Parameters[1].Value = 4;
317          Assert.That(await command.ExecuteScalarAsync(), Is.EqualTo(9));
318      }
319      [Test, Description(&quot;Tests if function parameter derivation throws an exception if the specified function is not in the search_path&quot;)]
320      public async Task DeriveParameters_throws_for_existing_function_that_is_not_in_search_path()
321      {
322          await using var conn = await OpenConnectionAsync();
323          var schema = await CreateTempSchema(conn);
324          await conn.ExecuteNonQueryAsync($@&quot;
325  CREATE FUNCTION {schema}.schema1func() RETURNS int AS &#x27;SELECT 1&#x27; LANGUAGE sql;
326  RESET search_path;&quot;);
327          await using var command = new NpgsqlCommand(&quot;schema1func&quot;, conn) { CommandType = CommandType.StoredProcedure };
328          Assert.That(() =&gt; NpgsqlCommandBuilder.DeriveParameters(command),
329              Throws.Exception.TypeOf&lt;PostgresException&gt;()
330                  .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.UndefinedFunction));
331      }
332      [Test, Description(&quot;Tests if an exception is thrown if multiple functions with the specified name are in the search_path&quot;)]
333      public async Task DeriveParameters_throws_for_multiple_function_name_hits_in_search_path()
334      {
335          await using var conn = await OpenConnectionAsync();
336          var schema1 = await CreateTempSchema(conn);
337          var schema2 = await CreateTempSchema(conn);
338          await conn.ExecuteNonQueryAsync(
339              $@&quot;
340  CREATE FUNCTION {schema1}.redundantfunc() RETURNS int AS &#x27;SELECT 1&#x27; LANGUAGE sql;
341  CREATE FUNCTION {schema1}.redundantfunc(IN param1 INT, IN param2 INT) RETURNS int AS &#x27;SELECT param1 + param2&#x27; LANGUAGE sql;
342  SET search_path TO {schema1}, {schema2};&quot;);
343          var command = new NpgsqlCommand(&quot;redundantfunc&quot;, conn) { CommandType = CommandType.StoredProcedure };
344          Assert.That(() =&gt; NpgsqlCommandBuilder.DeriveParameters(command),
345              Throws.Exception.TypeOf&lt;PostgresException&gt;()
346                  .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.AmbiguousFunction));
347      }
348      #region Set returning functions
349      [Test, Description(&quot;Tests parameter derivation for a function that returns SETOF sometype&quot;)]
350      public async Task DeriveParameters_function_returning_setof_type()
351      {
352          await using var conn = await OpenConnectionAsync();
353          MinimumPgVersion(conn, &quot;9.2.0&quot;);
354          var table = await GetTempTableName(conn);
355          var function = await GetTempFunctionName(conn);
356          await conn.ExecuteNonQueryAsync($@&quot;
357  CREATE TABLE {table} (fooid int, foosubid int, fooname text);
358  INSERT INTO {table} VALUES (1, 1, &#x27;Joe&#x27;), (1, 2, &#x27;Ed&#x27;), (2, 1, &#x27;Mary&#x27;);
359  CREATE FUNCTION {function}(int) RETURNS SETOF {table} AS $$
360      SELECT * FROM {table} WHERE {table}.fooid = $1 ORDER BY {table}.foosubid;
361  $$ LANGUAGE sql&quot;);
362          await using var cmd = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
363          NpgsqlCommandBuilder.DeriveParameters(cmd);
364          Assert.That(cmd.Parameters, Has.Count.EqualTo(4));
365          Assert.That(cmd.Parameters[0].Direction, Is.EqualTo(ParameterDirection.Input));
366          Assert.That(cmd.Parameters[1].Direction, Is.EqualTo(ParameterDirection.Output));
367          Assert.That(cmd.Parameters[2].Direction, Is.EqualTo(ParameterDirection.Output));
368          Assert.That(cmd.Parameters[3].Direction, Is.EqualTo(ParameterDirection.Output));
369          cmd.Parameters[0].Value = 1;
370          await cmd.ExecuteNonQueryAsync();
371          Assert.That(cmd.Parameters[0].Value, Is.EqualTo(1));
372      }
373      [Test, Description(&quot;Tests parameter derivation for a function that returns TABLE&quot;)]
374      public async Task DeriveParameters_function_returning_table()
375      {
376          await using var conn = await OpenConnectionAsync();
377          MinimumPgVersion(conn, &quot;9.2.0&quot;);
378          var table = await GetTempTableName(conn);
379          var function = await GetTempFunctionName(conn);
380          await conn.ExecuteNonQueryAsync($@&quot;
381  CREATE TABLE {table} (fooid int, foosubid int, fooname text);
382  INSERT INTO {table} VALUES (1, 1, &#x27;Joe&#x27;), (1, 2, &#x27;Ed&#x27;), (2, 1, &#x27;Mary&#x27;);
383  CREATE FUNCTION {function}(int) RETURNS TABLE(fooid int, foosubid int, fooname text) AS $$
384      SELECT * FROM {table} WHERE {table}.fooid = $1 ORDER BY {table}.foosubid;
385  $$ LANGUAGE sql&quot;);
386          await using var cmd = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
387          NpgsqlCommandBuilder.DeriveParameters(cmd);
388          Assert.That(cmd.Parameters, Has.Count.EqualTo(4));
389          Assert.That(cmd.Parameters[0].Direction, Is.EqualTo(ParameterDirection.Input));
390          Assert.That(cmd.Parameters[1].Direction, Is.EqualTo(ParameterDirection.Output));
391          Assert.That(cmd.Parameters[2].Direction, Is.EqualTo(ParameterDirection.Output));
392          Assert.That(cmd.Parameters[3].Direction, Is.EqualTo(ParameterDirection.Output));
393          cmd.Parameters[0].Value = 1;
394          await cmd.ExecuteNonQueryAsync();
395          Assert.That(cmd.Parameters[0].Value, Is.EqualTo(1));
396      }
397      [Test, Description(&quot;Tests parameter derivation for a function that returns SETOF record&quot;)]
398      public async Task DeriveParameters_function_returning_setof_record()
399      {
400          await using var conn = await OpenConnectionAsync();
401          MinimumPgVersion(conn, &quot;9.2.0&quot;);
402          var table = await GetTempTableName(conn);
403          var function = await GetTempFunctionName(conn);
404          await conn.ExecuteNonQueryAsync($@&quot;
405  CREATE TABLE {table} (fooid int, foosubid int, fooname text);
406  INSERT INTO {table} VALUES (1, 1, &#x27;Joe&#x27;), (1, 2, &#x27;Ed&#x27;), (2, 1, &#x27;Mary&#x27;);
407  CREATE FUNCTION {function}(int, OUT fooid int, OUT foosubid int, OUT fooname text) RETURNS SETOF record AS $$
408      SELECT * FROM {table} WHERE {table}.fooid = $1 ORDER BY {table}.foosubid;
409  $$ LANGUAGE sql&quot;);
410          await using var cmd = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
411          NpgsqlCommandBuilder.DeriveParameters(cmd);
412          Assert.That(cmd.Parameters, Has.Count.EqualTo(4));
413          Assert.That(cmd.Parameters[0].Direction, Is.EqualTo(ParameterDirection.Input));
414          Assert.That(cmd.Parameters[1].Direction, Is.EqualTo(ParameterDirection.Output));
415          Assert.That(cmd.Parameters[2].Direction, Is.EqualTo(ParameterDirection.Output));
416          Assert.That(cmd.Parameters[3].Direction, Is.EqualTo(ParameterDirection.Output));
417          cmd.Parameters[0].Value = 1;
418          await cmd.ExecuteNonQueryAsync();
419          Assert.That(cmd.Parameters[0].Value, Is.EqualTo(1));
420      }
421      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2022&quot;)]
422      public async Task DeriveParameters_function_returning_setof_type_with_dropped_column()
423      {
424          await using var conn = await OpenConnectionAsync();
425          MinimumPgVersion(conn, &quot;9.2.0&quot;);
426          var table = await GetTempTableName(conn);
427          var function = await GetTempFunctionName(conn);
428          await conn.ExecuteNonQueryAsync($@&quot;
429  CREATE TABLE {table} (id serial PRIMARY KEY, t1 text, t2 text);
430  CREATE FUNCTION {function}() RETURNS SETOF {table} AS &#x27;SELECT * FROM {table}&#x27; LANGUAGE sql;
431  ALTER TABLE {table} DROP t2;&quot;);
432          await using var cmd = new NpgsqlCommand(function, conn) { CommandType = CommandType.StoredProcedure };
433          NpgsqlCommandBuilder.DeriveParameters(cmd);
434          Assert.That(cmd.Parameters, Has.Count.EqualTo(2));
435          Assert.That(cmd.Parameters[0].Direction, Is.EqualTo(ParameterDirection.Output));
436          Assert.That(cmd.Parameters[0].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Integer));
437          Assert.That(cmd.Parameters[1].Direction, Is.EqualTo(ParameterDirection.Output));
438          Assert.That(cmd.Parameters[1].NpgsqlDbType, Is.EqualTo(NpgsqlDbType.Text));
439      }
440      #endregion
441      #endregion DeriveParameters
442  #if DEBUG
443      [OneTimeSetUp]
444      public void OneTimeSetup() =&gt; NpgsqlCommand.EnableStoredProcedureCompatMode = true;
445      [OneTimeTearDown]
446      public void OneTimeTeardown() =&gt; NpgsqlCommand.EnableStoredProcedureCompatMode = false;
447  #else
448      [OneTimeSetUp]
449      public void OneTimeSetup()
450          =&gt; Assert.Ignore(&quot;Cannot test function invocation via CommandType.StoredProcedure since that depends on the global EnableStoredProcedureCompatMode compatibility flag&quot;);
451  #endif
452  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-FunctionTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-FunctionTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>111              Direction = ParameterDirection.Output,
112              Value = -1
113          });
114          command.Parameters.Add(new NpgsqlParameter(&quot;b&quot;, DbType.Int32)
</pre></code></div>
                <div class="column column_space"><pre><code>116              Direction = ParameterDirection.Output,
117              Value = -1
118          });
119          command.Parameters.Add(new NpgsqlParameter(&quot;c&quot;, DbType.Int32)
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    