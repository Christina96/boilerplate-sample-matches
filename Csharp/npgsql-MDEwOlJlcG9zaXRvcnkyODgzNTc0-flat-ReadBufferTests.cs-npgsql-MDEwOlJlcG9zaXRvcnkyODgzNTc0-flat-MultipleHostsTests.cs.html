
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 4.945054945054945%, Tokens: 16</h2>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-ReadBufferTests.cs</h3>
            <pre><code>1  using Npgsql.Internal;
2  using Npgsql.Util;
3  using NUnit.Framework;
4  using System;
5  using System.IO;
6  using System.Threading;
7  using System.Threading.Tasks;
8  namespace Npgsql.Tests;
9  [FixtureLifeCycle(LifeCycle.InstancePerTestCase)] 
10  class ReadBufferTests
11  {
12      [Test]
13      public void Skip()
14      {
<span onclick='openModal()' class='match'>15          for (byte i = 0; i < 50; i++)
16              Writer.WriteByte(i);
17          ReadBuffer.Ensure(10);
18          ReadBuffer.Skip(7);
19          Assert.That(ReadBuffer.ReadByte(), Is.EqualTo(7));
20          ReadBuffer.Skip(10);
21          ReadBuffer.Ensure(1);
22          Assert.That(ReadBuffer.ReadByte(), Is.EqualTo(18));
23          ReadBuffer.Skip(20);
24          ReadBuffer.Ensure(1);
25          Assert.That(ReadBuffer.ReadByte(), Is.EqualTo(39));
26      }
27      [Test]
</span>28      public void ReadSingle()
29      {
30          const float expected = 8.7f;
31          var bytes = BitConverter.GetBytes(expected);
32          Array.Reverse(bytes);
33          Writer.Write(bytes);
34          ReadBuffer.Ensure(4);
35          Assert.That(ReadBuffer.ReadSingle(), Is.EqualTo(expected));
36      }
37      [Test]
38      public void ReadDouble()
39      {
40          const double expected = 8.7;
41          var bytes = BitConverter.GetBytes(expected);
42          Array.Reverse(bytes);
43          Writer.Write(bytes);
44          ReadBuffer.Ensure(8);
45          Assert.That(ReadBuffer.ReadDouble(), Is.EqualTo(expected));
46      }
47      [Test]
48      public void ReadNullTerminatedString_buffered_only()
49      {
50          Writer
51              .Write(PGUtil.UTF8Encoding.GetBytes(new string("foo")))
52              .WriteByte(0)
53              .Write(PGUtil.UTF8Encoding.GetBytes(new string("bar")))
54              .WriteByte(0);
55          ReadBuffer.Ensure(1);
56          Assert.That(ReadBuffer.ReadNullTerminatedString(), Is.EqualTo("foo"));
57          Assert.That(ReadBuffer.ReadNullTerminatedString(), Is.EqualTo("bar"));
58      }
59      [Test]
60      public async Task ReadNullTerminatedString_with_io()
61      {
62          Writer.Write(PGUtil.UTF8Encoding.GetBytes(new string("Chunked ")));
63          ReadBuffer.Ensure(1);
64          var task = ReadBuffer.ReadNullTerminatedString(async: true);
65          Assert.That(!task.IsCompleted);
66          Writer
67              .Write(PGUtil.UTF8Encoding.GetBytes(new string("string")))
68              .WriteByte(0)
69              .Write(PGUtil.UTF8Encoding.GetBytes(new string("bar")))
70              .WriteByte(0);
71          Assert.That(task.IsCompleted);
72          Assert.That(await task, Is.EqualTo("Chunked string"));
73          Assert.That(ReadBuffer.ReadNullTerminatedString(), Is.EqualTo("bar"));
74      }
75  #pragma warning disable CS8625
76      [SetUp]
77      public void SetUp()
78      {
79          var stream = new MockStream();
80          ReadBuffer = new NpgsqlReadBuffer(null, stream, null, NpgsqlReadBuffer.DefaultSize, PGUtil.UTF8Encoding, PGUtil.RelaxedUTF8Encoding);
81          Writer = stream.Writer;
82      }
83  #pragma warning restore CS8625
84      NpgsqlReadBuffer ReadBuffer = default!;
85      MockStream.MockStreamWriter Writer = default!;
86      class MockStream : Stream
87      {
88          const int Size = 8192;
89          internal MockStreamWriter Writer { get; }
90          public MockStream() => Writer = new MockStreamWriter(this);
91          TaskCompletionSource<object> _tcs = new();
92          readonly byte[] _data = new byte[Size];
93          int _filled;
94          public override int Read(byte[] buffer, int offset, int count)
95              => Read(buffer, offset, count, async: false).GetAwaiter().GetResult();
96          public override Task<int> ReadAsync(byte[] buffer, int offset, int count, CancellationToken cancellationToken)
97              => Read(buffer, offset, count, async: true);
98          async Task<int> Read(byte[] buffer, int offset, int count, bool async)
99          {
100              if (_filled == 0)
101              {
102                  _tcs = new TaskCompletionSource<object>();
103                  if (async)
104                      await _tcs.Task;
105                  else
106                      _tcs.Task.Wait();
107              }
108              count = Math.Min(count, _filled);
109              new Span<byte>(_data, 0, count).CopyTo(new Span<byte>(buffer, offset, count));
110              new Span<byte>(_data, count, _filled - count).CopyTo(_data);
111              _filled -= count;
112              return count;
113          }
114          internal class MockStreamWriter
115          {
116              readonly MockStream _stream;
117              public MockStreamWriter(MockStream stream) => _stream = stream;
118              public MockStreamWriter WriteByte(byte b)
119              {
120                  Span<byte> bytes = stackalloc byte[1];
121                  bytes[0] = b;
122                  Write(bytes);
123                  return this;
124              }
125              public MockStreamWriter Write(ReadOnlySpan<byte> bytes)
126              {
127                  if (_stream._filled + bytes.Length > Size)
128                      throw new Exception("Mock stream overrun");
129                  bytes.CopyTo(new Span<byte>(_stream._data, _stream._filled, bytes.Length));
130                  _stream._filled += bytes.Length;
131                  _stream._tcs.TrySetResult(new());
132                  return this;
133              }
134          }
135          public override void SetLength(long value) => throw new NotSupportedException();
136          public override void Write(byte[] buffer, int offset, int count) => throw new NotSupportedException();
137          public override long Seek(long offset, SeekOrigin origin) => throw new NotSupportedException();
138          public override void Flush() => throw new NotSupportedException();
139          public override bool CanRead => true;
140          public override bool CanSeek => false;
141          public override bool CanWrite => false;
142          public override long Length => throw new NotSupportedException();
143          public override long Position
144          {
145              get => throw new NotSupportedException();
146              set => throw new NotSupportedException();
147          }
148      }
149  }
</code></pre>
        </div>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-MultipleHostsTests.cs</h3>
            <pre><code>1  using Npgsql.Internal;
2  using Npgsql.Tests.Support;
3  using NUnit.Framework;
4  using System;
5  using System.Collections.Generic;
6  using System.Data;
7  using System.IO;
8  using System.Linq;
9  using System.Net;
10  using System.Net.Sockets;
11  using System.Runtime.InteropServices;
12  using System.Threading;
13  using System.Threading.Tasks;
14  using System.Transactions;
15  using Npgsql.Properties;
16  using static Npgsql.Tests.Support.MockState;
17  using static Npgsql.Tests.TestUtil;
18  using IsolationLevel = System.Transactions.IsolationLevel;
19  using TransactionStatus = Npgsql.Internal.TransactionStatus;
20  namespace Npgsql.Tests;
21  public class MultipleHostsTests : TestBase
22  {
23      static readonly object[] MyCases =
24      {
25          new object[] { TargetSessionAttributes.Standby,        new[] { Primary,         Standby         }, 1 },
26          new object[] { TargetSessionAttributes.Standby,        new[] { PrimaryReadOnly, Standby         }, 1 },
27          new object[] { TargetSessionAttributes.PreferStandby,  new[] { Primary,         Standby         }, 1 },
28          new object[] { TargetSessionAttributes.PreferStandby,  new[] { PrimaryReadOnly, Standby         }, 1 },
29          new object[] { TargetSessionAttributes.PreferStandby,  new[] { Primary,         Primary         }, 0 },
30          new object[] { TargetSessionAttributes.Primary,        new[] { Standby,         Primary         }, 1 },
31          new object[] { TargetSessionAttributes.Primary,        new[] { Standby,         PrimaryReadOnly }, 1 },
32          new object[] { TargetSessionAttributes.PreferPrimary,  new[] { Standby,         Primary         }, 1 },
33          new object[] { TargetSessionAttributes.PreferPrimary,  new[] { Standby,         PrimaryReadOnly }, 1 },
34          new object[] { TargetSessionAttributes.PreferPrimary,  new[] { Standby,         Standby         }, 0 },
35          new object[] { TargetSessionAttributes.Any,            new[] { Standby,         Primary         }, 0 },
36          new object[] { TargetSessionAttributes.Any,            new[] { Primary,         Standby         }, 0 },
37          new object[] { TargetSessionAttributes.Any,            new[] { PrimaryReadOnly, Standby         }, 0 },
38          new object[] { TargetSessionAttributes.ReadWrite,      new[] { Standby,         Primary         }, 1 },
39          new object[] { TargetSessionAttributes.ReadWrite,      new[] { PrimaryReadOnly, Primary         }, 1 },
40          new object[] { TargetSessionAttributes.ReadOnly,       new[] { Primary,         Standby         }, 1 },
41          new object[] { TargetSessionAttributes.ReadOnly,       new[] { PrimaryReadOnly, Standby         }, 0 }
42      };
43      [Test]
44      [TestCaseSource(nameof(MyCases))]
45      public async Task Connect_to_correct_host_pooled(TargetSessionAttributes targetSessionAttributes, MockState[] servers, int expectedServer)
46      {
47          var postmasters = servers.Select(s => PgPostmasterMock.Start(state: s)).ToArray();
48          await using var __ = new DisposableWrapper(postmasters);
49          var connectionStringBuilder = new NpgsqlConnectionStringBuilder
50          {
51              Host = MultipleHosts(postmasters),
52              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
53              Pooling = true
54          };
55          await using var dataSource = new NpgsqlDataSourceBuilder(connectionStringBuilder.ConnectionString)
56              .BuildMultiHost();
57          await using var conn = await dataSource.OpenConnectionAsync(targetSessionAttributes);
58          Assert.That(conn.Port, Is.EqualTo(postmasters[expectedServer].Port));
59          for (var i = 0; i <= expectedServer; i++)
60              _ = await postmasters[i].WaitForServerConnection();
61      }
62      [Test]
63      [TestCaseSource(nameof(MyCases))]
64      public async Task Connect_to_correct_host_unpooled(TargetSessionAttributes targetSessionAttributes, MockState[] servers, int expectedServer)
65      {
66          var postmasters = servers.Select(s => PgPostmasterMock.Start(state: s)).ToArray();
67          await using var __ = new DisposableWrapper(postmasters);
68          var connectionStringBuilder = new NpgsqlConnectionStringBuilder
69          {
70              Host = MultipleHosts(postmasters),
71              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
72              Pooling = false
73          };
74          await using var dataSource = new NpgsqlDataSourceBuilder(connectionStringBuilder.ConnectionString)
75              .BuildMultiHost();
76          await using var conn = await dataSource.OpenConnectionAsync(targetSessionAttributes);
77          Assert.That(conn.Port, Is.EqualTo(postmasters[expectedServer].Port));
78          for (var i = 0; i <= expectedServer; i++)
79              _ = await postmasters[i].WaitForServerConnection();
80      }
81      [Test]
82      [TestCaseSource(nameof(MyCases))]
83      public async Task Connect_to_correct_host_with_available_idle(
84          TargetSessionAttributes targetSessionAttributes, MockState[] servers, int expectedServer)
85      {
86          var postmasters = servers.Select(s => PgPostmasterMock.Start(state: s)).ToArray();
87          await using var __ = new DisposableWrapper(postmasters);
88          var connectionStringBuilder = new NpgsqlConnectionStringBuilder
89          {
90              Host = MultipleHosts(postmasters),
91              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
92          };
93          await using var dataSource = new NpgsqlDataSourceBuilder(connectionStringBuilder.ConnectionString)
94              .BuildMultiHost();
95          var idleConnTargetSessionAttributes = servers[0] switch
96          {
97              Primary => TargetSessionAttributes.ReadWrite,
98              PrimaryReadOnly => TargetSessionAttributes.ReadOnly,
99              Standby => TargetSessionAttributes.Standby,
100              _ => throw new ArgumentOutOfRangeException()
101          };
102          await using (_ = await dataSource.OpenConnectionAsync(idleConnTargetSessionAttributes))
103          {
104          }
105          await using var conn = await dataSource.OpenConnectionAsync(targetSessionAttributes);
106          Assert.That(conn.Port, Is.EqualTo(postmasters[expectedServer].Port));
107          for (var i = 0; i <= expectedServer; i++)
108              _ = await postmasters[i].WaitForServerConnection();
109      }
110      [Test]
111      [TestCase(TargetSessionAttributes.Standby,   new[] { Primary,         Primary })]
112      [TestCase(TargetSessionAttributes.Primary,   new[] { Standby,         Standby })]
113      [TestCase(TargetSessionAttributes.ReadWrite, new[] { PrimaryReadOnly, Standby })]
114      [TestCase(TargetSessionAttributes.ReadOnly,  new[] { Primary,         Primary })]
115      public async Task Valid_host_not_found(TargetSessionAttributes targetSessionAttributes, MockState[] servers)
116      {
117          var postmasters = servers.Select(s => PgPostmasterMock.Start(state: s)).ToArray();
118          await using var __ = new DisposableWrapper(postmasters);
119          var connectionStringBuilder = new NpgsqlConnectionStringBuilder
120          {
121              Host = MultipleHosts(postmasters),
122              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
123          };
124          await using var dataSource = new NpgsqlDataSourceBuilder(connectionStringBuilder.ConnectionString)
125              .BuildMultiHost();
126          var exception = Assert.ThrowsAsync<NpgsqlException>(async () => await dataSource.OpenConnectionAsync(targetSessionAttributes))!;
127          Assert.That(exception.Message, Is.EqualTo("No suitable host was found."));
128          Assert.That(exception.InnerException, Is.Null);
129          for (var i = 0; i < servers.Length; i++)
130              _ = await postmasters[i].WaitForServerConnection();
131      }
132      [Test, Platform(Exclude = "MacOsX", Reason = "#3786")]
133      public void All_hosts_are_down()
134      {
135          if (RuntimeInformation.FrameworkDescription.StartsWith(".NET Core 3.1"))
136              return;
137          var endpoint = new IPEndPoint(IPAddress.Loopback, 0);
138          using var socket1 = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
139          socket1.Bind(endpoint);
140          var localEndPoint1 = (IPEndPoint)socket1.LocalEndPoint!;
141          using var socket2 = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
142          socket2.Bind(endpoint);
143          var localEndPoint2 = (IPEndPoint)socket2.LocalEndPoint!;
144          var connectionString = new NpgsqlConnectionStringBuilder
145          {
146              Host = $"{localEndPoint1.Address}:{localEndPoint1.Port},{localEndPoint2.Address}:{localEndPoint2.Port}"
147          }.ConnectionString;
148          using var dataSource = new NpgsqlDataSourceBuilder(connectionString).BuildMultiHost();
149          var exception = Assert.ThrowsAsync<NpgsqlException>(async () => await dataSource.OpenConnectionAsync(TargetSessionAttributes.Any))!;
150          var aggregateException = (AggregateException)exception.InnerException!;
151          Assert.That(aggregateException.InnerExceptions, Has.Count.EqualTo(2));
152          for (var i = 0; i < aggregateException.InnerExceptions.Count; i++)
153          {
154              Assert.That(aggregateException.InnerExceptions[i], Is.TypeOf<NpgsqlException>()
155                  .With.InnerException.TypeOf<SocketException>()
156                  .With.InnerException.Property(nameof(SocketException.SocketErrorCode)).EqualTo(SocketError.ConnectionRefused));
157          }
158      }
159      [Test]
160      public async Task All_hosts_are_unavailable(
161          [Values] bool pooling,
162          [Values(PostgresErrorCodes.InvalidCatalogName, PostgresErrorCodes.CannotConnectNow)] string errorCode)
163      {
164          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary, startupErrorCode: errorCode);
165          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby, startupErrorCode: errorCode);
166          var builder = new NpgsqlConnectionStringBuilder
167          {
168              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
169              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
170              Pooling = pooling,
171          };
172          await using var dataSource = new NpgsqlDataSourceBuilder(builder.ConnectionString).BuildMultiHost();
173          var ex = Assert.ThrowsAsync<PostgresException>(async () => await dataSource.OpenConnectionAsync(TargetSessionAttributes.Any))!;
174          Assert.That(ex.SqlState, Is.EqualTo(errorCode));
175      }
176      [Test]
177      [Platform(Exclude = "MacOsX", Reason = "Flaky in CI on Mac")]
178      public async Task First_host_is_down()
179      {
180          using var socket = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
181          var endpoint = new IPEndPoint(IPAddress.Loopback, 0);
182          socket.Bind(endpoint);
183          var localEndPoint = (IPEndPoint)socket.LocalEndPoint!;
184          await using var postmaster = PgPostmasterMock.Start(state: Primary);
185          var connectionString = new NpgsqlConnectionStringBuilder
186          {
187              Host = $"{localEndPoint.Address}:{localEndPoint.Port},{postmaster.Host}:{postmaster.Port}",
188              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading
189          }.ConnectionString;
190          await using var dataSource = new NpgsqlDataSourceBuilder(connectionString).BuildMultiHost();
191          await using var conn = await dataSource.OpenConnectionAsync(TargetSessionAttributes.Any);
192          Assert.That(conn.Port, Is.EqualTo(postmaster.Port));
193      }
194      [Test]
195      [TestCase("any")]
196      [TestCase("primary")]
197      [TestCase("standby")]
198      [TestCase("prefer-primary")]
199      [TestCase("prefer-standby")]
200      [TestCase("read-write")]
201      [TestCase("read-only")]
202      public async Task TargetSessionAttributes_with_single_host(string targetSessionAttributes)
203      {
204          var connectionString = new NpgsqlConnectionStringBuilder(ConnectionString)
205          {
206              TargetSessionAttributes = targetSessionAttributes
207          }.ConnectionString;
208          if (targetSessionAttributes == "any")
209          {
210              await using var postmasterMock = PgPostmasterMock.Start(ConnectionString);
211              using var pool = CreateTempPool(postmasterMock.ConnectionString, out connectionString);
212              await using var conn = new NpgsqlConnection(connectionString);
213              await conn.OpenAsync();
214              _ = await postmasterMock.WaitForServerConnection();
215          }
216          else
217          {
218              Assert.That(() => new NpgsqlConnection(connectionString), Throws.Exception.TypeOf<NotSupportedException>());
219          }
220      }
221      [Test]
222      public void TargetSessionAttributes_default_is_null()
223          => Assert.That(new NpgsqlConnectionStringBuilder().TargetSessionAttributes, Is.Null);
224      [Test]
225      [NonParallelizable] 
226      public async Task TargetSessionAttributes_uses_environment_variable()
227      {
228          using var envVarResetter = SetEnvironmentVariable("PGTARGETSESSIONATTRS", "prefer-standby");
229          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary);
230          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby);
231          var builder = new NpgsqlConnectionStringBuilder
232          {
233              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
234              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading
235          };
236          Assert.That(builder.TargetSessionAttributes, Is.Null);
237          await using var dataSource = new NpgsqlDataSourceBuilder(builder.ConnectionString)
238              .BuildMultiHost();
239          await using var conn = await dataSource.OpenConnectionAsync();
240          Assert.That(conn.Port, Is.EqualTo(standbyPostmaster.Port));
241      }
242      [Test]
243      public void TargetSessionAttributes_invalid_throws()
244          => Assert.Throws<ArgumentException>(() =>
245              new NpgsqlConnectionStringBuilder
246              {
247                  TargetSessionAttributes = nameof(TargetSessionAttributes_invalid_throws)
248              });
249      [Test]
250      public void HostRecheckSeconds_default_value()
251      {
252          var builder = new NpgsqlConnectionStringBuilder();
253          Assert.That(builder.HostRecheckSeconds, Is.EqualTo(10));
254          Assert.That(builder.HostRecheckSecondsTranslated, Is.EqualTo(TimeSpan.FromSeconds(10)));
255      }
256      [Test]
257      public void HostRecheckSeconds_zero_value()
258      {
259          var builder = new NpgsqlConnectionStringBuilder
260          {
261              HostRecheckSeconds = 0,
262          };
263          Assert.That(builder.HostRecheckSeconds, Is.EqualTo(0));
264          Assert.That(builder.HostRecheckSecondsTranslated, Is.EqualTo(TimeSpan.FromSeconds(-1)));
265      }
266      [Test]
267      public void HostRecheckSeconds_invalid_throws()
268          => Assert.Throws<ArgumentException>(() =>
269              new NpgsqlConnectionStringBuilder
270              {
271                  HostRecheckSeconds = -1
272              });
273      [Test]
274      public async Task Connect_with_load_balancing()
275      {
276          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary);
277          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby);
278          var defaultCsb = new NpgsqlConnectionStringBuilder
279          {
280              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
281              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
282              MaxPoolSize = 1,
283              LoadBalanceHosts = true,
284          };
285          await using var dataSource = new NpgsqlDataSourceBuilder(defaultCsb.ConnectionString)
286              .BuildMultiHost();
287          NpgsqlConnector firstConnector;
288          NpgsqlConnector secondConnector;
289          await using (var firstConnection = await dataSource.OpenConnectionAsync())
290          {
291              firstConnector = firstConnection.Connector!;
292          }
293          await using (var secondConnection = await dataSource.OpenConnectionAsync())
294          {
295              secondConnector = secondConnection.Connector!;
296          }
297          Assert.AreNotSame(firstConnector, secondConnector);
298          await using (var firstBalancedConnection = await dataSource.OpenConnectionAsync())
299          {
300              Assert.AreSame(firstConnector, firstBalancedConnection.Connector);
301          }
302          await using (var secondBalancedConnection = await dataSource.OpenConnectionAsync())
303          {
304              Assert.AreSame(secondConnector, secondBalancedConnection.Connector);
305          }
306          await using (var thirdBalancedConnection = await dataSource.OpenConnectionAsync())
307          {
308              Assert.AreSame(firstConnector, thirdBalancedConnection.Connector);
309          }
310      }
311      [Test]
312      public async Task Connect_without_load_balancing()
313      {
314          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary);
315          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby);
316          var defaultCsb = new NpgsqlConnectionStringBuilder
317          {
318              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
319              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
320              MaxPoolSize = 1,
321              LoadBalanceHosts = false,
322          };
323          await using var dataSource = new NpgsqlDataSourceBuilder(defaultCsb.ConnectionString)
324              .BuildMultiHost();
325          NpgsqlConnector firstConnector;
326          NpgsqlConnector secondConnector;
327          await using (var firstConnection = await dataSource.OpenConnectionAsync())
328          {
329              firstConnector = firstConnection.Connector!;
330          }
331          await using (var secondConnection = await dataSource.OpenConnectionAsync())
332          {
333              Assert.AreSame(firstConnector, secondConnection.Connector);
334          }
335          await using (var firstConnection = await dataSource.OpenConnectionAsync())
336          await using (var secondConnection = await dataSource.OpenConnectionAsync())
337          {
338              secondConnector = secondConnection.Connector!;
339          }
340          Assert.AreNotSame(firstConnector, secondConnector);
341          await using (var firstUnbalancedConnection = await dataSource.OpenConnectionAsync())
342          {
343              Assert.AreSame(firstConnector, firstUnbalancedConnection.Connector);
344          }
345          await using (var secondUnbalancedConnection = await dataSource.OpenConnectionAsync())
346          {
347              Assert.AreSame(firstConnector, secondUnbalancedConnection.Connector);
348          }
349      }
350      [Test]
351      public async Task Connect_state_changing_hosts([Values] bool alwaysCheckHostState)
352      {
353          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary);
354          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby);
355          var defaultCsb = new NpgsqlConnectionStringBuilder
356          {
357              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
358              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
359              MaxPoolSize = 1,
360              HostRecheckSeconds = alwaysCheckHostState ? 0 : int.MaxValue,
361              NoResetOnClose = true,
362          };
363          await using var dataSource = new NpgsqlDataSourceBuilder(defaultCsb.ConnectionString)
364              .BuildMultiHost();
365          NpgsqlConnector firstConnector;
366          NpgsqlConnector secondConnector;
367          var firstServerTask = Task.Run(async () =>
368          {
369              var server = await primaryPostmaster.WaitForServerConnection();
370              if (!alwaysCheckHostState)
371                  return;
372              await server.SendMockState(Primary);
373              await server.SendMockState(Standby);
374          });
375          var secondServerTask = Task.Run(async () =>
376          {
377              var server = await standbyPostmaster.WaitForServerConnection();
378              if (!alwaysCheckHostState)
379                  return;
380              await server.SendMockState(Standby);
381              await server.SendMockState(Standby);
382              await server.SendMockState(Primary);
383          });
384          await using (var firstConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.PreferPrimary))
385          await using (var secondConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.PreferPrimary))
386          {
387              firstConnector = firstConnection.Connector!;
388              secondConnector = secondConnection.Connector!;
389          }
390          await using var thirdConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.PreferPrimary);
391          Assert.AreSame(alwaysCheckHostState ? secondConnector : firstConnector, thirdConnection.Connector);
392          await firstServerTask;
393          await secondServerTask;
394      }
395      [Test]
396      public void Database_state_cache_basic()
397      {
398          using var dataSource = CreateDataSource();
399          var timeStamp = DateTime.UtcNow;
400          dataSource.UpdateDatabaseState(DatabaseState.PrimaryReadWrite, timeStamp, TimeSpan.Zero);
401          Assert.AreEqual(DatabaseState.PrimaryReadWrite, dataSource.GetDatabaseState());
402          dataSource.UpdateDatabaseState(DatabaseState.Standby, timeStamp, TimeSpan.Zero);
403          Assert.AreEqual(DatabaseState.PrimaryReadWrite, dataSource.GetDatabaseState());
404          timeStamp = timeStamp.AddSeconds(1);
405          dataSource.UpdateDatabaseState(DatabaseState.PrimaryReadOnly, timeStamp, TimeSpan.Zero);
406          Assert.AreEqual(DatabaseState.PrimaryReadOnly, dataSource.GetDatabaseState());
407          timeStamp = timeStamp.AddSeconds(1);
408          dataSource.UpdateDatabaseState(DatabaseState.PrimaryReadWrite, timeStamp, TimeSpan.FromSeconds(-1));
409          Assert.AreEqual(DatabaseState.Unknown, dataSource.GetDatabaseState(ignoreExpiration: false));
410          Assert.AreEqual(DatabaseState.PrimaryReadWrite, dataSource.GetDatabaseState(ignoreExpiration: true));
411      }
412      [Test]
413      public async Task Offline_state_on_connection_failure()
414      {
415          await using var server = PgPostmasterMock.Start(ConnectionString, startupErrorCode: PostgresErrorCodes.ConnectionFailure);
416          await using var dataSource = server.CreateDataSource();
417          await using var conn = dataSource.CreateConnection();
418          var ex = Assert.ThrowsAsync<PostgresException>(conn.OpenAsync)!;
419          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.ConnectionFailure));
420          var state = conn.NpgsqlDataSource.GetDatabaseState();
421          Assert.That(state, Is.EqualTo(DatabaseState.Offline));
422      }
423      [Test]
424      public async Task Unknown_state_on_connection_authentication_failure()
425      {
426          await using var server = PgPostmasterMock.Start(ConnectionString, startupErrorCode: PostgresErrorCodes.InvalidAuthorizationSpecification);
427          await using var dataSource = server.CreateDataSource();
428          await using var conn = dataSource.CreateConnection();
429          var ex = Assert.ThrowsAsync<PostgresException>(conn.OpenAsync)!;
430          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.InvalidAuthorizationSpecification));
431          var state = conn.NpgsqlDataSource.GetDatabaseState();
432          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
433      }
434      [Test]
435      public async Task Offline_state_on_query_execution_pg_critical_failure()
436      {
437          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
438          await using var dataSource = postmaster.CreateDataSource();
439          await using var conn = await dataSource.OpenConnectionAsync();
440          await using var anotherConn = await dataSource.OpenConnectionAsync();
441          await anotherConn.CloseAsync();
442          var state = conn.NpgsqlDataSource.GetDatabaseState();
443          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
444          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
445          var server = await postmaster.WaitForServerConnection();
446          await server.WriteErrorResponse(PostgresErrorCodes.CrashShutdown).FlushAsync();
447          var ex = Assert.ThrowsAsync<PostgresException>(() => conn.ExecuteNonQueryAsync("SELECT 1"))!;
448          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.CrashShutdown));
449          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
450          state = conn.NpgsqlDataSource.GetDatabaseState();
451          Assert.That(state, Is.EqualTo(DatabaseState.Offline));
452          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(0));
453      }
454      [Test, NonParallelizable]
455      public async Task Offline_state_on_query_execution_pg_non_critical_failure()
456      {
457          await using var dataSource = CreateDataSource();
458          await using var conn = await dataSource.OpenConnectionAsync();
459          var expectedState = conn.PostgreSqlVersion.Major > 13 ? DatabaseState.PrimaryReadWrite : DatabaseState.Unknown;
460          var state = dataSource.GetDatabaseState();
461          Assert.That(state, Is.EqualTo(expectedState));
462          Assert.That(dataSource.Statistics.Total, Is.EqualTo(1));
463          var ex = Assert.ThrowsAsync<PostgresException>(() => conn.ExecuteNonQueryAsync("SELECT abc"))!;
464          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.UndefinedColumn));
465          Assert.That(conn.State, Is.EqualTo(ConnectionState.Open));
466          state = dataSource.GetDatabaseState();
467          Assert.That(state, Is.EqualTo(expectedState));
468          Assert.That(dataSource.Statistics.Total, Is.EqualTo(1));
469      }
470      [Test]
471      public async Task Offline_state_on_query_execution_IOException()
472      {
473          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
474          await using var dataSource = postmaster.CreateDataSource();
475          await using var conn = await dataSource.OpenConnectionAsync();
476          await using var anotherConn = await dataSource.OpenConnectionAsync();
477          await anotherConn.CloseAsync();
478          var state = conn.NpgsqlDataSource.GetDatabaseState();
479          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
480          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
481          var server = await postmaster.WaitForServerConnection();
482          server.Close();
483          var ex = Assert.ThrowsAsync<NpgsqlException>(() => conn.ExecuteNonQueryAsync("SELECT 1"))!;
484          Assert.That(ex.InnerException, Is.InstanceOf<IOException>());
485          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
486          state = conn.NpgsqlDataSource.GetDatabaseState();
487          Assert.That(state, Is.EqualTo(DatabaseState.Offline));
488          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(0));
489      }
490      [Test]
491      public async Task Offline_state_on_query_execution_TimeoutException()
492      {
493          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
494          var dataSourceBuilder = postmaster.GetDataSourceBuilder();
495          dataSourceBuilder.ConnectionStringBuilder.CommandTimeout = 1;
496          dataSourceBuilder.ConnectionStringBuilder.CancellationTimeout = 1;
497          await using var dataSource = dataSourceBuilder.Build();
498          await using var conn = await dataSource.OpenConnectionAsync();
499          await using var anotherConn = await dataSource.OpenConnectionAsync();
500          await anotherConn.CloseAsync();
501          var state = conn.NpgsqlDataSource.GetDatabaseState();
502          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
503          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
504          var ex = Assert.ThrowsAsync<NpgsqlException>(() => conn.ExecuteNonQueryAsync("SELECT 1"))!;
505          Assert.That(ex.InnerException, Is.TypeOf<TimeoutException>());
506          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
507          state = conn.NpgsqlDataSource.GetDatabaseState();
508          Assert.That(state, Is.EqualTo(DatabaseState.Offline));
509          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(0));
510      }
511      [Test]
512      public async Task Unknown_state_on_query_execution_TimeoutException_with_disabled_cancellation()
513      {
514          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
515          var dataSourceBuilder = postmaster.GetDataSourceBuilder();
516          dataSourceBuilder.ConnectionStringBuilder.CommandTimeout = 1;
517          dataSourceBuilder.ConnectionStringBuilder.CancellationTimeout = -1;
518          await using var dataSource = dataSourceBuilder.Build();
519          await using var conn = await dataSource.OpenConnectionAsync();
520          await using var anotherConn = await dataSource.OpenConnectionAsync();
521          await anotherConn.CloseAsync();
522          var state = conn.NpgsqlDataSource.GetDatabaseState();
523          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
524          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
525          var ex = Assert.ThrowsAsync<NpgsqlException>(() => conn.ExecuteNonQueryAsync("SELECT 1"))!;
526          Assert.That(ex.InnerException, Is.TypeOf<TimeoutException>());
527          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
528          state = conn.NpgsqlDataSource.GetDatabaseState();
529          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
530          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
531      }
532      [Test]
533      public async Task Unknown_state_on_query_execution_cancellation_with_disabled_cancellation_timeout()
534      {
535          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
536          var dataSourceBuilder = postmaster.GetDataSourceBuilder();
537          dataSourceBuilder.ConnectionStringBuilder.CommandTimeout = 30;
538          dataSourceBuilder.ConnectionStringBuilder.CancellationTimeout = -1;
539          await using var dataSource = dataSourceBuilder.Build();
540          await using var conn = await dataSource.OpenConnectionAsync();
541          await using var anotherConn = await dataSource.OpenConnectionAsync();
542          await anotherConn.CloseAsync();
543          var state = conn.NpgsqlDataSource.GetDatabaseState();
544          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
545          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
546          using var cts = new CancellationTokenSource();
547          var query = conn.ExecuteNonQueryAsync("SELECT 1", cancellationToken: cts.Token);
548          cts.Cancel();
549          var ex = Assert.ThrowsAsync<OperationCanceledException>(async () => await query)!;
550          Assert.That(ex.InnerException, Is.TypeOf<TimeoutException>());
551          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
552          state = conn.NpgsqlDataSource.GetDatabaseState();
553          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
554          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
555      }
556      [Test]
557      public async Task Unknown_state_on_query_execution_TimeoutException_with_cancellation_failure()
558      {
559          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
560          var dataSourceBuilder = postmaster.GetDataSourceBuilder();
561          dataSourceBuilder.ConnectionStringBuilder.CommandTimeout = 1;
562          dataSourceBuilder.ConnectionStringBuilder.CancellationTimeout = 0;
563          await using var dataSource = dataSourceBuilder.Build();
564          await using var conn = await dataSource.OpenConnectionAsync();
565          var state = conn.NpgsqlDataSource.GetDatabaseState();
566          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
567          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
568          var server = await postmaster.WaitForServerConnection();
569          var query = conn.ExecuteNonQueryAsync("SELECT 1");
570          await postmaster.WaitForCancellationRequest();
571          await server.WriteCancellationResponse().WriteReadyForQuery().FlushAsync();
572          var ex = Assert.ThrowsAsync<NpgsqlException>(async () => await query)!;
573          Assert.That(ex.InnerException, Is.TypeOf<TimeoutException>());
574          Assert.That(conn.State, Is.EqualTo(ConnectionState.Open));
575          state = conn.NpgsqlDataSource.GetDatabaseState();
576          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
577          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
578      }
579      [Test]
580      public async Task Clear_pool_one_host_only_on_admin_shutdown()
581      {
582          await using var primaryPostmaster = PgPostmasterMock.Start(ConnectionString, state: Primary);
583          await using var standbyPostmaster = PgPostmasterMock.Start(ConnectionString, state: Standby);
584          var dataSourceBuilder = new NpgsqlDataSourceBuilder
585          {
586              ConnectionStringBuilder =
587              {
588                  Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
589                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
590                  MaxPoolSize = 2
591              }
592          };
593          await using var multiHostDataSource = dataSourceBuilder.BuildMultiHost();
594          await using var preferPrimaryDataSource = multiHostDataSource.WithTargetSession(TargetSessionAttributes.PreferPrimary);
595          await using var primaryConn = await preferPrimaryDataSource.OpenConnectionAsync();
596          await using var anotherPrimaryConn = await preferPrimaryDataSource.OpenConnectionAsync();
597          await using var standbyConn = await preferPrimaryDataSource.OpenConnectionAsync();
598          var primaryDataSource = primaryConn.Connector!.DataSource;
599          var standbyDataSource = standbyConn.Connector!.DataSource;
600          await anotherPrimaryConn.CloseAsync();
601          await standbyConn.CloseAsync();
602          Assert.That(primaryDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.PrimaryReadWrite));
603          Assert.That(standbyDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Standby));
604          Assert.That(primaryConn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(3));
605          var server = await primaryPostmaster.WaitForServerConnection();
606          await server.WriteErrorResponse(PostgresErrorCodes.AdminShutdown).FlushAsync();
607          var ex = Assert.ThrowsAsync<PostgresException>(() => primaryConn.ExecuteNonQueryAsync("SELECT 1"))!;
608          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.AdminShutdown));
609          Assert.That(primaryConn.State, Is.EqualTo(ConnectionState.Closed));
610          Assert.That(primaryDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Offline));
611          Assert.That(standbyDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Standby));
612          Assert.That(primaryConn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
613          multiHostDataSource.ClearDatabaseStates();
614          Assert.That(primaryDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Unknown));
615          Assert.That(standbyDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Unknown));
616      }
617      [Test]
618      [TestCase("any", true)]
619      [TestCase("primary", true)]
620      [TestCase("standby", false)]
621      [TestCase("prefer-primary", true)]
622      [TestCase("prefer-standby", false)]
623      [TestCase("read-write", true)]
624      [TestCase("read-only", false)]
625      public async Task Transaction_enlist_reuses_connection(string targetSessionAttributes, bool primary)
626      {
627          await using var primaryPostmaster = PgPostmasterMock.Start(ConnectionString, state: Primary);
628          await using var standbyPostmaster = PgPostmasterMock.Start(ConnectionString, state: Standby);
629          var csb = new NpgsqlConnectionStringBuilder
630          {
631              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
632              TargetSessionAttributes = targetSessionAttributes,
633              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
634              MaxPoolSize = 10,
635          };
636          using var _ = CreateTempPool(csb, out var connString);
637          using var scope = new TransactionScope(TransactionScopeOption.Required,
638              new TransactionOptions { IsolationLevel = IsolationLevel.ReadCommitted }, TransactionScopeAsyncFlowOption.Enabled);
639          var query1Task = Query(connString);
640          var server = primary
641              ? await primaryPostmaster.WaitForServerConnection()
642              : await standbyPostmaster.WaitForServerConnection();
643          await server
644              .WriteCommandComplete()
645              .WriteReadyForQuery(TransactionStatus.InTransactionBlock)
646              .WriteParseComplete()
647              .WriteBindComplete()
648              .WriteNoData()
649              .WriteCommandComplete()
650              .WriteReadyForQuery(TransactionStatus.InTransactionBlock)
651              .FlushAsync();
652          await query1Task;
653          var query2Task = Query(connString);
654          await server
655              .WriteParseComplete()
656              .WriteBindComplete()
657              .WriteNoData()
658              .WriteCommandComplete()
659              .WriteReadyForQuery(TransactionStatus.InTransactionBlock)
660              .FlushAsync();
661          await query2Task;
662          await server
663              .WriteCommandComplete()
664              .WriteReadyForQuery()
665              .FlushAsync();
666          scope.Complete();
667          async Task Query(string connectionString)
668          {
669              await using var conn = new NpgsqlConnection(connectionString);
670              await conn.OpenAsync();
671              await using var cmd = conn.CreateCommand();
672              cmd.CommandText = "SELECT 1";
673              await cmd.ExecuteNonQueryAsync();
674          }
675      }
676      [Test]
677      public async Task Primary_host_failover_can_connect()
678      {
679          await using var firstPostmaster = PgPostmasterMock.Start(ConnectionString, state: Primary);
680          await using var secondPostmaster = PgPostmasterMock.Start(ConnectionString, state: Standby);
681          var dataSourceBuilder = new NpgsqlDataSourceBuilder
682          {
683              ConnectionStringBuilder =
684              {
685                  Host = MultipleHosts(firstPostmaster, secondPostmaster),
686                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
687                  HostRecheckSeconds = 5
688              }
689          };
690          await using var multiHostDataSource = dataSourceBuilder.BuildMultiHost();
691          var (firstDataSource, secondDataSource) = (multiHostDataSource.Pools[0], multiHostDataSource.Pools[1]);
692          await using var primaryDataSource = multiHostDataSource.WithTargetSession(TargetSessionAttributes.Primary);
693          await using var conn = await primaryDataSource.OpenConnectionAsync();
694          Assert.That(conn.Port, Is.EqualTo(firstPostmaster.Port));
695          var firstServer = await firstPostmaster.WaitForServerConnection();
696          await firstServer
697              .WriteErrorResponse(PostgresErrorCodes.AdminShutdown)
698              .FlushAsync();
699          var failoverEx = Assert.ThrowsAsync<PostgresException>(async () => await conn.ExecuteNonQueryAsync("SELECT 1"))!;
700          Assert.That(failoverEx.SqlState, Is.EqualTo(PostgresErrorCodes.AdminShutdown));
701          var noHostFoundEx = Assert.ThrowsAsync<NpgsqlException>(async () => await conn.OpenAsync())!;
702          Assert.That(noHostFoundEx.Message, Is.EqualTo("No suitable host was found."));
703          Assert.That(firstDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Offline));
704          Assert.That(secondDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Standby));
705          firstPostmaster.State = Standby;
706          secondPostmaster.State = Primary;
<span onclick='openModal()' class='match'>707          var secondServer = await secondPostmaster.WaitForServerConnection();
708          await secondServer.SendMockState(Primary);
709          await Task.Delay(TimeSpan.FromSeconds(10));
710          Assert.That(firstDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Unknown));
711          Assert.That(secondDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Unknown));
712          await conn.OpenAsync();
713          Assert.That(conn.Port, Is.EqualTo(secondPostmaster.Port));
714          Assert.That(firstDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Standby));
715          Assert.That(secondDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.PrimaryReadWrite));
716      }
717      [Test, NonParallelizable]
</span>718      public void IntegrationTest([Values] bool loadBalancing, [Values] bool alwaysCheckHostState)
719      {
720          PoolManager.Reset();
721          var dataSourceBuilder = new NpgsqlDataSourceBuilder(ConnectionString)
722          {
723              ConnectionStringBuilder =
724              {
725                  Host = "localhost,127.0.0.1",
726                  Pooling = true,
727                  MaxPoolSize = 2,
728                  LoadBalanceHosts = loadBalancing,
729                  HostRecheckSeconds = alwaysCheckHostState ? 0 : 10,
730              }
731          };
732          using var dataSource = dataSourceBuilder.BuildMultiHost();
733          var queriesDone = 0;
734          var clientsTask = Task.WhenAll(
735              Client(dataSource, TargetSessionAttributes.Any),
736              Client(dataSource, TargetSessionAttributes.Primary),
737              Client(dataSource, TargetSessionAttributes.PreferPrimary),
738              Client(dataSource, TargetSessionAttributes.PreferStandby),
739              Client(dataSource, TargetSessionAttributes.ReadWrite));
740          var onlyStandbyClient = Client(dataSource, TargetSessionAttributes.Standby);
741          var readOnlyClient = Client(dataSource, TargetSessionAttributes.ReadOnly);
742          Assert.DoesNotThrowAsync(() => clientsTask);
743          Assert.ThrowsAsync<NpgsqlException>(() => onlyStandbyClient);
744          Assert.ThrowsAsync<NpgsqlException>(() => readOnlyClient);
745          Assert.AreEqual(125, queriesDone);
746          Task Client(NpgsqlMultiHostDataSource multiHostDataSource, TargetSessionAttributes targetSessionAttributes)
747          {
748              var dataSource = multiHostDataSource.WithTargetSession(targetSessionAttributes);
749              var tasks = new List<Task>(5);
750              for (var i = 0; i < 5; i++)
751              {
752                  tasks.Add(Task.Run(() => Query(dataSource)));
753              }
754              return Task.WhenAll(tasks);
755          }
756          async Task Query(NpgsqlDataSource dataSource)
757          {
758              await using var conn = dataSource.CreateConnection();
759              for (var i = 0; i < 5; i++)
760              {
761                  await conn.OpenAsync();
762                  await conn.ExecuteNonQueryAsync("SELECT 1");
763                  await conn.CloseAsync();
764                  Interlocked.Increment(ref queriesDone);
765              }
766          }
767      }
768      [Test]
769      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/5055")]
770      [NonParallelizable] 
771      public async Task Multiple_hosts_with_disabled_sql_rewriting()
772      {
773          using var _ = DisableSqlRewriting();
774          var dataSourceBuilder = new NpgsqlDataSourceBuilder(ConnectionString)
775          {
776              ConnectionStringBuilder =
777              {
778                  Host = "localhost,127.0.0.1",
779                  Pooling = true,
780                  HostRecheckSeconds = 0
781              }
782          };
783          await using var dataSource = dataSourceBuilder.BuildMultiHost();
784          await using var conn = await dataSource.OpenConnectionAsync();
785      }
786      [Test]
787      public async Task DataSource_with_wrappers()
788      {
789          await using var primaryPostmasterMock = PgPostmasterMock.Start(state: Primary);
790          await using var standbyPostmasterMock = PgPostmasterMock.Start(state: Standby);
791          var builder = new NpgsqlDataSourceBuilder
792          {
793              ConnectionStringBuilder =
794              {
795                  Host = MultipleHosts(primaryPostmasterMock, standbyPostmasterMock),
796                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
797              }
798          };
799          await using var dataSource = builder.BuildMultiHost();
800          await using var primaryDataSource = dataSource.WithTargetSession(TargetSessionAttributes.Primary);
801          await using var standbyDataSource = dataSource.WithTargetSession(TargetSessionAttributes.Standby);
802          await using var primaryConnection = await primaryDataSource.OpenConnectionAsync();
803          Assert.That(primaryConnection.Port, Is.EqualTo(primaryPostmasterMock.Port));
804          await using var standbyConnection = await standbyDataSource.OpenConnectionAsync();
805          Assert.That(standbyConnection.Port, Is.EqualTo(standbyPostmasterMock.Port));
806      }
807      [Test]
808      public async Task DataSource_without_wrappers()
809      {
810          await using var primaryPostmasterMock = PgPostmasterMock.Start(state: Primary);
811          await using var standbyPostmasterMock = PgPostmasterMock.Start(state: Standby);
812          var builder = new NpgsqlDataSourceBuilder
813          {
814              ConnectionStringBuilder =
815              {
816                  Host = MultipleHosts(primaryPostmasterMock, standbyPostmasterMock),
817                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
818              }
819          };
820          await using var dataSource = builder.BuildMultiHost();
821          await using var primaryConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.Primary);
822          Assert.That(primaryConnection.Port, Is.EqualTo(primaryPostmasterMock.Port));
823          await using var standbyConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.Standby);
824          Assert.That(standbyConnection.Port, Is.EqualTo(standbyPostmasterMock.Port));
825      }
826      [Test]
827      public void DataSource_with_TargetSessionAttributes_is_not_supported()
828      {
829          var builder = new NpgsqlDataSourceBuilder("Host=foo,bar;Target Session Attributes=primary");
830          Assert.That(() => builder.BuildMultiHost(), Throws.Exception.TypeOf<InvalidOperationException>()
831              .With.Message.EqualTo(NpgsqlStrings.CannotSpecifyTargetSessionAttributes));
832      }
833      [Test]
834      public async Task BuildMultiHost_with_single_host_is_supported()
835      {
836          var builder = new NpgsqlDataSourceBuilder(ConnectionString);
837          await using var dataSource = builder.BuildMultiHost();
838          await using var connection = await dataSource.OpenConnectionAsync();
839          Assert.That(await connection.ExecuteScalarAsync("SELECT 1"), Is.EqualTo(1));
840      }
841      [Test]
842      public async Task Build_with_multiple_hosts_is_supported()
843      {
844          await using var primaryPostmasterMock = PgPostmasterMock.Start(state: Primary);
845          await using var standbyPostmasterMock = PgPostmasterMock.Start(state: Standby);
846          var builder = new NpgsqlDataSourceBuilder
847          {
848              ConnectionStringBuilder =
849              {
850                  Host = MultipleHosts(primaryPostmasterMock, standbyPostmasterMock),
851                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
852              }
853          };
854          await using var dataSource = builder.Build();
855          await using var connection = await dataSource.OpenConnectionAsync();
856      }
857      static string MultipleHosts(params PgPostmasterMock[] postmasters)
858          => string.Join(",", postmasters.Select(p => $"{p.Host}:{p.Port}"));
859      class DisposableWrapper : IAsyncDisposable
860      {
861          readonly IEnumerable<IAsyncDisposable> _disposables;
862          public DisposableWrapper(IEnumerable<IAsyncDisposable> disposables) => _disposables = disposables;
863          public async ValueTask DisposeAsync()
864          {
865              foreach (var disposable in _disposables)
866                  await disposable.DisposeAsync();
867          }
868      }
869  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-ReadBufferTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-MultipleHostsTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>15          for (byte i = 0; i < 50; i++)
16              Writer.WriteByte(i);
17          ReadBuffer.Ensure(10);
18          ReadBuffer.Skip(7);
19          Assert.That(ReadBuffer.ReadByte(), Is.EqualTo(7));
20          ReadBuffer.Skip(10);
21          ReadBuffer.Ensure(1);
22          Assert.That(ReadBuffer.ReadByte(), Is.EqualTo(18));
23          ReadBuffer.Skip(20);
24          ReadBuffer.Ensure(1);
25          Assert.That(ReadBuffer.ReadByte(), Is.EqualTo(39));
26      }
27      [Test]
</pre></code></div>
                <div class="column column_space"><pre><code>707          var secondServer = await secondPostmaster.WaitForServerConnection();
708          await secondServer.SendMockState(Primary);
709          await Task.Delay(TimeSpan.FromSeconds(10));
710          Assert.That(firstDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Unknown));
711          Assert.That(secondDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Unknown));
712          await conn.OpenAsync();
713          Assert.That(conn.Port, Is.EqualTo(secondPostmaster.Port));
714          Assert.That(firstDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Standby));
715          Assert.That(secondDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.PrimaryReadWrite));
716      }
717      [Test, NonParallelizable]
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    