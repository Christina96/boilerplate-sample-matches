
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 55, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ActionRunnerL0.cs</h3>
            <pre><code>1  using GitHub.DistributedTask.Expressions2;
2  using GitHub.DistributedTask.ObjectTemplating.Tokens;
3  using GitHub.DistributedTask.Pipelines;
4  using GitHub.DistributedTask.Pipelines.ContextData;
5  using GitHub.DistributedTask.WebApi;
6  using GitHub.Runner.Worker;
7  using GitHub.Runner.Worker.Handlers;
8  using Moq;
9  using Newtonsoft.Json.Linq;
10  using System;
11  using System.Collections.Generic;
12  using System.Runtime.CompilerServices;
13  using System.Threading;
14  using Xunit;
15  using Pipelines = GitHub.DistributedTask.Pipelines;
16  namespace GitHub.Runner.Common.Tests.Worker
17  {
18      public sealed class ActionRunnerL0
19      {
20          private CancellationTokenSource _ecTokenSource;
21          private Mock<IHandlerFactory> _handlerFactory;
22          private Mock<IActionManager> _actionManager;
23          private Mock<IDefaultStepHost> _defaultStepHost;
24          private Mock<IExecutionContext> _ec;
25          private TestHostContext _hc;
26          private ActionRunner _actionRunner;
27          private IActionManifestManager _actionManifestManager;
28          private Mock<IFileCommandManager> _fileCommandManager;
29          private DictionaryContextData _context = new();
30          [Fact]
31          [Trait("Level", "L0")]
32          [Trait("Category", "Worker")]
33          public async void MergeDefaultInputs()
34          {
35              Setup();
36              var actionId = Guid.NewGuid();
37              var actionInputs = new MappingToken(null, null, null);
38              actionInputs.Add(new StringToken(null, null, null, "input1"), new StringToken(null, null, null, "test1"));
39              actionInputs.Add(new StringToken(null, null, null, "input2"), new StringToken(null, null, null, "test2"));
40              var action = new Pipelines.ActionStep()
41              {
42                  Name = "action",
43                  Id = actionId,
44                  Reference = new Pipelines.ContainerRegistryReference()
45                  {
46                      Image = "ubuntu:16.04"
47                  },
48                  Inputs = actionInputs
49              };
50              _actionRunner.Action = action;
51              Dictionary<string, string> finialInputs = new();
52              _handlerFactory.Setup(x => x.Create(It.IsAny<IExecutionContext>(), It.IsAny<ActionStepDefinitionReference>(), It.IsAny<IStepHost>(), It.IsAny<ActionExecutionData>(), It.IsAny<Dictionary<string, string>>(), It.IsAny<Dictionary<string, string>>(), It.IsAny<Variables>(), It.IsAny<string>(), It.IsAny<List<JobExtensionRunner>>()))
53                             .Callback((IExecutionContext executionContext, Pipelines.ActionStepDefinitionReference actionReference, IStepHost stepHost, ActionExecutionData data, Dictionary<string, string> inputs, Dictionary<string, string> environment, Variables runtimeVariables, string taskDirectory, List<JobExtensionRunner> localActionContainerSetupSteps) =>
54                             {
55                                 finialInputs = inputs;
56                             })
57                             .Returns(new Mock<IHandler>().Object);
58              await _actionRunner.RunAsync();
59              foreach (var input in finialInputs)
60              {
61                  _hc.GetTrace().Info($"Input: {input.Key}={input.Value}");
62              }
63              Assert.Equal("test1", finialInputs["input1"]);
64              Assert.Equal("test2", finialInputs["input2"]);
65              Assert.Equal("github", finialInputs["input3"]);
66          }
67          [Fact]
68          [Trait("Level", "L0")]
69          [Trait("Category", "Worker")]
70          public async void WriteEventPayload()
71          {
72              Setup();
73              var actionId = Guid.NewGuid();
74              var actionInputs = new MappingToken(null, null, null);
75              actionInputs.Add(new StringToken(null, null, null, "input1"), new StringToken(null, null, null, "test1"));
76              actionInputs.Add(new StringToken(null, null, null, "input2"), new StringToken(null, null, null, "test2"));
77              var action = new Pipelines.ActionStep()
78              {
79                  Name = "action",
80                  Id = actionId,
81                  Reference = new Pipelines.ContainerRegistryReference()
82                  {
83                      Image = "ubuntu:16.04"
84                  },
85                  Inputs = actionInputs
86              };
87              _actionRunner.Action = action;
88              Dictionary<string, string> finialInputs = new();
89              _handlerFactory.Setup(x => x.Create(It.IsAny<IExecutionContext>(), It.IsAny<ActionStepDefinitionReference>(), It.IsAny<IStepHost>(), It.IsAny<ActionExecutionData>(), It.IsAny<Dictionary<string, string>>(), It.IsAny<Dictionary<string, string>>(), It.IsAny<Variables>(), It.IsAny<string>(), It.IsAny<List<JobExtensionRunner>>()))
90                             .Callback((IExecutionContext executionContext, Pipelines.ActionStepDefinitionReference actionReference, IStepHost stepHost, ActionExecutionData data, Dictionary<string, string> inputs, Dictionary<string, string> environment, Variables runtimeVariables, string taskDirectory, List<JobExtensionRunner> localActionContainerSetupSteps) =>
91                             {
92                                 finialInputs = inputs;
93                             })
94                             .Returns(new Mock<IHandler>().Object);
95              await _actionRunner.RunAsync();
96              _ec.Verify(x => x.WriteWebhookPayload(), Times.Once);
97          }
98          [Fact]
99          [Trait("Level", "L0")]
100          [Trait("Category", "Worker")]
101          public void EvaluateLegacyDisplayName()
102          {
<span onclick='openModal()' class='match'>103              Setup();
104              var actionInputs = new MappingToken(null, null, null);
105              actionInputs.Add(new StringToken(null, null, null, "script"), new StringToken(null, null, null, "echo hello world"));
106              var actionId = Guid.NewGuid();
107              var actionDisplayName = "Run echo hello world";
</span>108              var action = new Pipelines.ActionStep()
109              {
110                  Name = "action",
111                  Id = actionId,
112                  DisplayName = actionDisplayName,
113                  Inputs = actionInputs,
114              };
115              _actionRunner.Action = action;
116              var matrixData = new DictionaryContextData
117              {
118                  ["node"] = new NumberContextData(8)
119              };
120              _context.Add("matrix", matrixData);
121              var validDisplayName = _actionRunner.EvaluateDisplayName(_context, _actionRunner.ExecutionContext, out bool updated);
122              Assert.True(validDisplayName);
123              Assert.False(updated);
124              Assert.Equal(actionDisplayName, _actionRunner.DisplayName);
125          }
126          [Fact]
127          [Trait("Level", "L0")]
128          [Trait("Category", "Worker")]
129          public void EvaluateExpansionOfDisplayNameToken()
130          {
131              Setup();
132              var actionId = Guid.NewGuid();
133              var action = new Pipelines.ActionStep()
134              {
135                  Name = "action",
136                  Id = actionId,
137                  DisplayNameToken = new BasicExpressionToken(null, null, null, "matrix.node"),
138              };
139              _actionRunner.Action = action;
140              var expectedString = "8";
141              var matrixData = new DictionaryContextData
142              {
143                  ["node"] = new StringContextData(expectedString)
144              };
145              _context.Add("matrix", matrixData);
146              var validDisplayName = _actionRunner.EvaluateDisplayName(_context, _actionRunner.ExecutionContext, out bool updated);
147              Assert.True(validDisplayName);
148              Assert.True(updated);
149              Assert.Equal(expectedString, _actionRunner.DisplayName);
150          }
151          [Fact]
152          [Trait("Level", "L0")]
153          [Trait("Category", "Worker")]
154          public void IgnoreDisplayNameTokenWhenDisplayNameIsExplicitlySet()
155          {
156              var explicitDisplayName = "Explcitly Set Name";
157              Setup();
158              var actionId = Guid.NewGuid();
159              var action = new Pipelines.ActionStep()
160              {
161                  Name = "action",
162                  Id = actionId,
163                  DisplayName = explicitDisplayName,
164                  DisplayNameToken = new BasicExpressionToken(null, null, null, "matrix.node"),
165              };
166              _actionRunner.Action = action;
167              var matrixData = new DictionaryContextData
168              {
169                  ["node"] = new StringContextData("8")
170              };
171              _context.Add("matrix", matrixData);
172              var validDisplayName = _actionRunner.EvaluateDisplayName(_context, _actionRunner.ExecutionContext, out bool updated);
173              Assert.True(validDisplayName);
174              Assert.False(updated);
175              Assert.Equal(explicitDisplayName, _actionRunner.DisplayName);
176          }
177          [Fact]
178          [Trait("Level", "L0")]
179          [Trait("Category", "Worker")]
180          public void EvaluateExpansionOfScriptDisplayName()
181          {
182              Setup();
183              var actionInputs = new MappingToken(null, null, null);
184              actionInputs.Add(new StringToken(null, null, null, "script"), new BasicExpressionToken(null, null, null, "matrix.node"));
185              var actionId = Guid.NewGuid();
186              var action = new Pipelines.ActionStep()
187              {
188                  Name = "action",
189                  Id = actionId,
190                  Inputs = actionInputs,
191                  Reference = new Pipelines.ScriptReference()
192              };
193              _actionRunner.Action = action;
194              var matrixData = new DictionaryContextData
195              {
196                  ["node"] = new StringContextData("8")
197              };
198              _context.Add("matrix", matrixData);
199              var validDisplayName = _actionRunner.EvaluateDisplayName(_context, _actionRunner.ExecutionContext, out bool updated);
200              Assert.True(validDisplayName);
201              Assert.True(updated);
202              Assert.Equal("Run 8", _actionRunner.DisplayName);
203          }
204          [Fact]
205          [Trait("Level", "L0")]
206          [Trait("Category", "Worker")]
207          public void EvaluateExpansionOfContainerDisplayName()
208          {
209              Setup();
210              var actionId = Guid.NewGuid();
211              var action = new Pipelines.ActionStep()
212              {
213                  Name = "action",
214                  Id = actionId,
215                  Reference = new Pipelines.ContainerRegistryReference()
216                  {
217                      Image = "TestImageName:latest"
218                  }
219              };
220              _actionRunner.Action = action;
221              var validDisplayName = _actionRunner.EvaluateDisplayName(_context, _actionRunner.ExecutionContext, out bool updated);
222              Assert.True(validDisplayName);
223              Assert.True(updated);
224              Assert.Equal("Run TestImageName:latest", _actionRunner.DisplayName);
225          }
226          [Fact]
227          [Trait("Level", "L0")]
228          [Trait("Category", "Worker")]
229          public void EvaluateDisplayNameWithoutContext()
230          {
231              Setup();
232              var actionId = Guid.NewGuid();
233              var action = new Pipelines.ActionStep()
234              {
235                  Name = "action",
236                  Id = actionId,
237                  DisplayNameToken = new BasicExpressionToken(null, null, null, "matrix.node"),
238              };
239              _actionRunner.Action = action;
240              var validDisplayName = _actionRunner.EvaluateDisplayName(_context, _actionRunner.ExecutionContext, out bool updated);
241              Assert.False(validDisplayName);
242              Assert.False(updated);
243              Assert.Equal("${{ matrix.node }}", _actionRunner.DisplayName);
244          }
245          [Fact]
246          [Trait("Level", "L0")]
247          [Trait("Category", "Worker")]
248          public async void WarnInvalidInputs()
249          {
250              Setup();
251              var actionId = Guid.NewGuid();
252              var actionInputs = new MappingToken(null, null, null);
253              actionInputs.Add(new StringToken(null, null, null, "input1"), new StringToken(null, null, null, "test1"));
254              actionInputs.Add(new StringToken(null, null, null, "input2"), new StringToken(null, null, null, "test2"));
255              actionInputs.Add(new StringToken(null, null, null, "invalid1"), new StringToken(null, null, null, "invalid1"));
256              actionInputs.Add(new StringToken(null, null, null, "invalid2"), new StringToken(null, null, null, "invalid2"));
257              var action = new Pipelines.ActionStep()
258              {
259                  Name = "action",
260                  Id = actionId,
261                  Reference = new Pipelines.RepositoryPathReference()
262                  {
263                      Name = "actions/runner",
264                      Ref = "v1"
265                  },
266                  Inputs = actionInputs
267              };
268              _actionRunner.Action = action;
269              Dictionary<string, string> finialInputs = new();
270              _handlerFactory.Setup(x => x.Create(It.IsAny<IExecutionContext>(), It.IsAny<ActionStepDefinitionReference>(), It.IsAny<IStepHost>(), It.IsAny<ActionExecutionData>(), It.IsAny<Dictionary<string, string>>(), It.IsAny<Dictionary<string, string>>(), It.IsAny<Variables>(), It.IsAny<string>(), It.IsAny<List<JobExtensionRunner>>()))
271                             .Callback((IExecutionContext executionContext, Pipelines.ActionStepDefinitionReference actionReference, IStepHost stepHost, ActionExecutionData data, Dictionary<string, string> inputs, Dictionary<string, string> environment, Variables runtimeVariables, string taskDirectory, List<JobExtensionRunner> localActionContainerSetupSteps) =>
272                             {
273                                 finialInputs = inputs;
274                             })
275                             .Returns(new Mock<IHandler>().Object);
276              await _actionRunner.RunAsync();
277              foreach (var input in finialInputs)
278              {
279                  _hc.GetTrace().Info($"Input: {input.Key}={input.Value}");
280              }
281              Assert.Equal("test1", finialInputs["input1"]);
282              Assert.Equal("test2", finialInputs["input2"]);
283              Assert.Equal("github", finialInputs["input3"]);
284              Assert.Equal("invalid1", finialInputs["invalid1"]);
285              Assert.Equal("invalid2", finialInputs["invalid2"]);
286              _ec.Verify(x => x.AddIssue(It.Is<Issue>(s => s.Message.Contains("Unexpected input(s) 'invalid1', 'invalid2'")), It.IsAny<ExecutionContextLogOptions>()), Times.Once);
287          }
288          [Fact]
289          [Trait("Level", "L0")]
290          [Trait("Category", "Worker")]
291          public async void SetGitHubContextActionRepoRef()
292          {
293              Setup();
294              var actionId = Guid.NewGuid();
295              var actionInputs = new MappingToken(null, null, null);
296              actionInputs.Add(new StringToken(null, null, null, "input1"), new StringToken(null, null, null, "test1"));
297              actionInputs.Add(new StringToken(null, null, null, "input2"), new StringToken(null, null, null, "test2"));
298              var action = new Pipelines.ActionStep()
299              {
300                  Name = "action",
301                  Id = actionId,
302                  Reference = new Pipelines.RepositoryPathReference()
303                  {
304                      Name = "actions/test",
305                      Ref = "master"
306                  },
307                  Inputs = actionInputs
308              };
309              _actionRunner.Action = action;
310              Dictionary<string, string> finialInputs = new();
311              _handlerFactory.Setup(x => x.Create(It.IsAny<IExecutionContext>(), It.IsAny<ActionStepDefinitionReference>(), It.IsAny<IStepHost>(), It.IsAny<ActionExecutionData>(), It.IsAny<Dictionary<string, string>>(), It.IsAny<Dictionary<string, string>>(), It.IsAny<Variables>(), It.IsAny<string>(), It.IsAny<List<JobExtensionRunner>>()))
312                             .Callback((IExecutionContext executionContext, Pipelines.ActionStepDefinitionReference actionReference, IStepHost stepHost, ActionExecutionData data, Dictionary<string, string> inputs, Dictionary<string, string> environment, Variables runtimeVariables, string taskDirectory, List<JobExtensionRunner> localActionContainerSetupSteps) =>
313                             {
314                                 finialInputs = inputs;
315                             })
316                             .Returns(new Mock<IHandler>().Object);
317              await _actionRunner.RunAsync();
318              _ec.Verify(x => x.SetGitHubContext("action_repository", "actions/test"), Times.Once);
319              _ec.Verify(x => x.SetGitHubContext("action_ref", "master"), Times.Once);
320              action = new Pipelines.ActionStep()
321              {
322                  Name = "action",
323                  Id = actionId,
324                  Reference = new Pipelines.ScriptReference(),
325                  Inputs = actionInputs
326              };
327              _actionRunner.Action = action;
328              _hc.EnqueueInstance<IDefaultStepHost>(_defaultStepHost.Object);
329              _hc.EnqueueInstance(_fileCommandManager.Object);
330              await _actionRunner.RunAsync();
331              _ec.Verify(x => x.SetGitHubContext("action_repository", null), Times.Once);
332              _ec.Verify(x => x.SetGitHubContext("action_ref", null), Times.Once);
333          }
334          private void Setup([CallerMemberName] string name = "")
335          {
336              _ecTokenSource?.Dispose();
337              _ecTokenSource = new CancellationTokenSource();
338              _hc = new TestHostContext(this, name);
339              var actionInputs = new MappingToken(null, null, null);
340              actionInputs.Add(new StringToken(null, null, null, "input1"), new StringToken(null, null, null, "input1"));
341              actionInputs.Add(new StringToken(null, null, null, "input2"), new StringToken(null, null, null, ""));
342              actionInputs.Add(new StringToken(null, null, null, "input3"), new StringToken(null, null, null, "github"));
343              var actionDefinition = new Definition()
344              {
345                  Directory = _hc.GetDirectory(WellKnownDirectory.Work),
346                  Data = new ActionDefinitionData()
347                  {
348                      Name = name,
349                      Description = name,
350                      Inputs = actionInputs,
351                      Execution = new ScriptActionExecutionData()
352                  }
353              };
354              _actionManager = new Mock<IActionManager>();
355              _actionManager.Setup(x => x.LoadAction(It.IsAny<IExecutionContext>(), It.IsAny<ActionStep>())).Returns(actionDefinition);
356              _handlerFactory = new Mock<IHandlerFactory>();
357              _defaultStepHost = new Mock<IDefaultStepHost>();
358              _actionManifestManager = new ActionManifestManager();
359              _fileCommandManager = new Mock<IFileCommandManager>();
360              _actionManifestManager.Initialize(_hc);
361              var githubContext = new GitHubContext();
362              githubContext.Add("event", JToken.Parse("{\"foo\":\"bar\"}").ToPipelineContextData());
363              _context.Add("github", githubContext);
364  #if OS_WINDOWS
365              _context["env"] = new DictionaryContextData();
366  #else
367              _context["env"] = new CaseSensitiveDictionaryContextData();
368  #endif
369              _ec = new Mock<IExecutionContext>();
370              _ec.Setup(x => x.Global).Returns(new GlobalContext());
371              _ec.Setup(x => x.ExpressionValues).Returns(_context);
372              _ec.Setup(x => x.ExpressionFunctions).Returns(new List<IFunctionInfo>());
373              _ec.Setup(x => x.IntraActionState).Returns(new Dictionary<string, string>());
374              _ec.Object.Global.EnvironmentVariables = new Dictionary<string, string>();
375              _ec.Object.Global.FileTable = new List<String>();
376              _ec.Setup(x => x.SetGitHubContext(It.IsAny<string>(), It.IsAny<string>()));
377              _ec.Setup(x => x.GetGitHubContext(It.IsAny<string>())).Returns("{\"foo\":\"bar\"}");
378              _ec.Setup(x => x.CancellationToken).Returns(_ecTokenSource.Token);
379              _ec.Object.Global.Variables = new Variables(_hc, new Dictionary<string, VariableValue>());
380              _ec.Setup(x => x.Write(It.IsAny<string>(), It.IsAny<string>())).Callback((string tag, string message) => { _hc.GetTrace().Info($"[{tag}]{message}"); });
381              _ec.Setup(x => x.AddIssue(It.IsAny<Issue>(), It.IsAny<ExecutionContextLogOptions>())).Callback((Issue issue, ExecutionContextLogOptions logOptions) => { _hc.GetTrace().Info($"[{issue.Type}]{logOptions.LogMessageOverride ?? issue.Message}"); });
382              _hc.SetSingleton<IActionManager>(_actionManager.Object);
383              _hc.SetSingleton<IHandlerFactory>(_handlerFactory.Object);
384              _hc.SetSingleton<IActionManifestManager>(_actionManifestManager);
385              _hc.EnqueueInstance<IDefaultStepHost>(_defaultStepHost.Object);
386              _hc.EnqueueInstance(_fileCommandManager.Object);
387              _actionRunner = new ActionRunner();
388              _actionRunner.Initialize(_hc);
389              _actionRunner.ExecutionContext = _ec.Object;
390          }
391      }
392  }
</code></pre>
        </div>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ActionRunnerL0.cs</h3>
            <pre><code>1  using GitHub.DistributedTask.Expressions2;
2  using GitHub.DistributedTask.ObjectTemplating.Tokens;
3  using GitHub.DistributedTask.Pipelines;
4  using GitHub.DistributedTask.Pipelines.ContextData;
5  using GitHub.DistributedTask.WebApi;
6  using GitHub.Runner.Worker;
7  using GitHub.Runner.Worker.Handlers;
8  using Moq;
9  using Newtonsoft.Json.Linq;
10  using System;
11  using System.Collections.Generic;
12  using System.Runtime.CompilerServices;
13  using System.Threading;
14  using Xunit;
15  using Pipelines = GitHub.DistributedTask.Pipelines;
16  namespace GitHub.Runner.Common.Tests.Worker
17  {
18      public sealed class ActionRunnerL0
19      {
20          private CancellationTokenSource _ecTokenSource;
21          private Mock<IHandlerFactory> _handlerFactory;
22          private Mock<IActionManager> _actionManager;
23          private Mock<IDefaultStepHost> _defaultStepHost;
24          private Mock<IExecutionContext> _ec;
25          private TestHostContext _hc;
26          private ActionRunner _actionRunner;
27          private IActionManifestManager _actionManifestManager;
28          private Mock<IFileCommandManager> _fileCommandManager;
29          private DictionaryContextData _context = new();
30          [Fact]
31          [Trait("Level", "L0")]
32          [Trait("Category", "Worker")]
33          public async void MergeDefaultInputs()
34          {
35              Setup();
36              var actionId = Guid.NewGuid();
37              var actionInputs = new MappingToken(null, null, null);
38              actionInputs.Add(new StringToken(null, null, null, "input1"), new StringToken(null, null, null, "test1"));
39              actionInputs.Add(new StringToken(null, null, null, "input2"), new StringToken(null, null, null, "test2"));
40              var action = new Pipelines.ActionStep()
41              {
42                  Name = "action",
43                  Id = actionId,
44                  Reference = new Pipelines.ContainerRegistryReference()
45                  {
46                      Image = "ubuntu:16.04"
47                  },
48                  Inputs = actionInputs
49              };
50              _actionRunner.Action = action;
51              Dictionary<string, string> finialInputs = new();
52              _handlerFactory.Setup(x => x.Create(It.IsAny<IExecutionContext>(), It.IsAny<ActionStepDefinitionReference>(), It.IsAny<IStepHost>(), It.IsAny<ActionExecutionData>(), It.IsAny<Dictionary<string, string>>(), It.IsAny<Dictionary<string, string>>(), It.IsAny<Variables>(), It.IsAny<string>(), It.IsAny<List<JobExtensionRunner>>()))
53                             .Callback((IExecutionContext executionContext, Pipelines.ActionStepDefinitionReference actionReference, IStepHost stepHost, ActionExecutionData data, Dictionary<string, string> inputs, Dictionary<string, string> environment, Variables runtimeVariables, string taskDirectory, List<JobExtensionRunner> localActionContainerSetupSteps) =>
54                             {
55                                 finialInputs = inputs;
56                             })
57                             .Returns(new Mock<IHandler>().Object);
58              await _actionRunner.RunAsync();
59              foreach (var input in finialInputs)
60              {
61                  _hc.GetTrace().Info($"Input: {input.Key}={input.Value}");
62              }
63              Assert.Equal("test1", finialInputs["input1"]);
64              Assert.Equal("test2", finialInputs["input2"]);
65              Assert.Equal("github", finialInputs["input3"]);
66          }
67          [Fact]
68          [Trait("Level", "L0")]
69          [Trait("Category", "Worker")]
70          public async void WriteEventPayload()
71          {
72              Setup();
73              var actionId = Guid.NewGuid();
74              var actionInputs = new MappingToken(null, null, null);
75              actionInputs.Add(new StringToken(null, null, null, "input1"), new StringToken(null, null, null, "test1"));
76              actionInputs.Add(new StringToken(null, null, null, "input2"), new StringToken(null, null, null, "test2"));
77              var action = new Pipelines.ActionStep()
78              {
79                  Name = "action",
80                  Id = actionId,
81                  Reference = new Pipelines.ContainerRegistryReference()
82                  {
83                      Image = "ubuntu:16.04"
84                  },
85                  Inputs = actionInputs
86              };
87              _actionRunner.Action = action;
88              Dictionary<string, string> finialInputs = new();
89              _handlerFactory.Setup(x => x.Create(It.IsAny<IExecutionContext>(), It.IsAny<ActionStepDefinitionReference>(), It.IsAny<IStepHost>(), It.IsAny<ActionExecutionData>(), It.IsAny<Dictionary<string, string>>(), It.IsAny<Dictionary<string, string>>(), It.IsAny<Variables>(), It.IsAny<string>(), It.IsAny<List<JobExtensionRunner>>()))
90                             .Callback((IExecutionContext executionContext, Pipelines.ActionStepDefinitionReference actionReference, IStepHost stepHost, ActionExecutionData data, Dictionary<string, string> inputs, Dictionary<string, string> environment, Variables runtimeVariables, string taskDirectory, List<JobExtensionRunner> localActionContainerSetupSteps) =>
91                             {
92                                 finialInputs = inputs;
93                             })
94                             .Returns(new Mock<IHandler>().Object);
95              await _actionRunner.RunAsync();
96              _ec.Verify(x => x.WriteWebhookPayload(), Times.Once);
97          }
98          [Fact]
99          [Trait("Level", "L0")]
100          [Trait("Category", "Worker")]
101          public void EvaluateLegacyDisplayName()
102          {
103              Setup();
104              var actionInputs = new MappingToken(null, null, null);
105              actionInputs.Add(new StringToken(null, null, null, "script"), new StringToken(null, null, null, "echo hello world"));
106              var actionId = Guid.NewGuid();
107              var actionDisplayName = "Run echo hello world";
108              var action = new Pipelines.ActionStep()
109              {
110                  Name = "action",
111                  Id = actionId,
112                  DisplayName = actionDisplayName,
113                  Inputs = actionInputs,
114              };
115              _actionRunner.Action = action;
116              var matrixData = new DictionaryContextData
117              {
118                  ["node"] = new NumberContextData(8)
119              };
120              _context.Add("matrix", matrixData);
121              var validDisplayName = _actionRunner.EvaluateDisplayName(_context, _actionRunner.ExecutionContext, out bool updated);
122              Assert.True(validDisplayName);
123              Assert.False(updated);
124              Assert.Equal(actionDisplayName, _actionRunner.DisplayName);
125          }
126          [Fact]
127          [Trait("Level", "L0")]
128          [Trait("Category", "Worker")]
129          public void EvaluateExpansionOfDisplayNameToken()
130          {
131              Setup();
132              var actionId = Guid.NewGuid();
133              var action = new Pipelines.ActionStep()
134              {
135                  Name = "action",
136                  Id = actionId,
137                  DisplayNameToken = new BasicExpressionToken(null, null, null, "matrix.node"),
138              };
139              _actionRunner.Action = action;
140              var expectedString = "8";
141              var matrixData = new DictionaryContextData
142              {
143                  ["node"] = new StringContextData(expectedString)
144              };
145              _context.Add("matrix", matrixData);
146              var validDisplayName = _actionRunner.EvaluateDisplayName(_context, _actionRunner.ExecutionContext, out bool updated);
147              Assert.True(validDisplayName);
148              Assert.True(updated);
149              Assert.Equal(expectedString, _actionRunner.DisplayName);
150          }
151          [Fact]
152          [Trait("Level", "L0")]
153          [Trait("Category", "Worker")]
154          public void IgnoreDisplayNameTokenWhenDisplayNameIsExplicitlySet()
155          {
156              var explicitDisplayName = "Explcitly Set Name";
157              Setup();
158              var actionId = Guid.NewGuid();
159              var action = new Pipelines.ActionStep()
160              {
161                  Name = "action",
162                  Id = actionId,
163                  DisplayName = explicitDisplayName,
164                  DisplayNameToken = new BasicExpressionToken(null, null, null, "matrix.node"),
165              };
166              _actionRunner.Action = action;
167              var matrixData = new DictionaryContextData
168              {
169                  ["node"] = new StringContextData("8")
170              };
171              _context.Add("matrix", matrixData);
172              var validDisplayName = _actionRunner.EvaluateDisplayName(_context, _actionRunner.ExecutionContext, out bool updated);
173              Assert.True(validDisplayName);
174              Assert.False(updated);
175              Assert.Equal(explicitDisplayName, _actionRunner.DisplayName);
176          }
177          [Fact]
178          [Trait("Level", "L0")]
179          [Trait("Category", "Worker")]
180          public void EvaluateExpansionOfScriptDisplayName()
181          {
<span onclick='openModal()' class='match'>182              Setup();
183              var actionInputs = new MappingToken(null, null, null);
184              actionInputs.Add(new StringToken(null, null, null, "script"), new BasicExpressionToken(null, null, null, "matrix.node"));
185              var actionId = Guid.NewGuid();
186              var action = new Pipelines.ActionStep()
</span>187              {
188                  Name = "action",
189                  Id = actionId,
190                  Inputs = actionInputs,
191                  Reference = new Pipelines.ScriptReference()
192              };
193              _actionRunner.Action = action;
194              var matrixData = new DictionaryContextData
195              {
196                  ["node"] = new StringContextData("8")
197              };
198              _context.Add("matrix", matrixData);
199              var validDisplayName = _actionRunner.EvaluateDisplayName(_context, _actionRunner.ExecutionContext, out bool updated);
200              Assert.True(validDisplayName);
201              Assert.True(updated);
202              Assert.Equal("Run 8", _actionRunner.DisplayName);
203          }
204          [Fact]
205          [Trait("Level", "L0")]
206          [Trait("Category", "Worker")]
207          public void EvaluateExpansionOfContainerDisplayName()
208          {
209              Setup();
210              var actionId = Guid.NewGuid();
211              var action = new Pipelines.ActionStep()
212              {
213                  Name = "action",
214                  Id = actionId,
215                  Reference = new Pipelines.ContainerRegistryReference()
216                  {
217                      Image = "TestImageName:latest"
218                  }
219              };
220              _actionRunner.Action = action;
221              var validDisplayName = _actionRunner.EvaluateDisplayName(_context, _actionRunner.ExecutionContext, out bool updated);
222              Assert.True(validDisplayName);
223              Assert.True(updated);
224              Assert.Equal("Run TestImageName:latest", _actionRunner.DisplayName);
225          }
226          [Fact]
227          [Trait("Level", "L0")]
228          [Trait("Category", "Worker")]
229          public void EvaluateDisplayNameWithoutContext()
230          {
231              Setup();
232              var actionId = Guid.NewGuid();
233              var action = new Pipelines.ActionStep()
234              {
235                  Name = "action",
236                  Id = actionId,
237                  DisplayNameToken = new BasicExpressionToken(null, null, null, "matrix.node"),
238              };
239              _actionRunner.Action = action;
240              var validDisplayName = _actionRunner.EvaluateDisplayName(_context, _actionRunner.ExecutionContext, out bool updated);
241              Assert.False(validDisplayName);
242              Assert.False(updated);
243              Assert.Equal("${{ matrix.node }}", _actionRunner.DisplayName);
244          }
245          [Fact]
246          [Trait("Level", "L0")]
247          [Trait("Category", "Worker")]
248          public async void WarnInvalidInputs()
249          {
250              Setup();
251              var actionId = Guid.NewGuid();
252              var actionInputs = new MappingToken(null, null, null);
253              actionInputs.Add(new StringToken(null, null, null, "input1"), new StringToken(null, null, null, "test1"));
254              actionInputs.Add(new StringToken(null, null, null, "input2"), new StringToken(null, null, null, "test2"));
255              actionInputs.Add(new StringToken(null, null, null, "invalid1"), new StringToken(null, null, null, "invalid1"));
256              actionInputs.Add(new StringToken(null, null, null, "invalid2"), new StringToken(null, null, null, "invalid2"));
257              var action = new Pipelines.ActionStep()
258              {
259                  Name = "action",
260                  Id = actionId,
261                  Reference = new Pipelines.RepositoryPathReference()
262                  {
263                      Name = "actions/runner",
264                      Ref = "v1"
265                  },
266                  Inputs = actionInputs
267              };
268              _actionRunner.Action = action;
269              Dictionary<string, string> finialInputs = new();
270              _handlerFactory.Setup(x => x.Create(It.IsAny<IExecutionContext>(), It.IsAny<ActionStepDefinitionReference>(), It.IsAny<IStepHost>(), It.IsAny<ActionExecutionData>(), It.IsAny<Dictionary<string, string>>(), It.IsAny<Dictionary<string, string>>(), It.IsAny<Variables>(), It.IsAny<string>(), It.IsAny<List<JobExtensionRunner>>()))
271                             .Callback((IExecutionContext executionContext, Pipelines.ActionStepDefinitionReference actionReference, IStepHost stepHost, ActionExecutionData data, Dictionary<string, string> inputs, Dictionary<string, string> environment, Variables runtimeVariables, string taskDirectory, List<JobExtensionRunner> localActionContainerSetupSteps) =>
272                             {
273                                 finialInputs = inputs;
274                             })
275                             .Returns(new Mock<IHandler>().Object);
276              await _actionRunner.RunAsync();
277              foreach (var input in finialInputs)
278              {
279                  _hc.GetTrace().Info($"Input: {input.Key}={input.Value}");
280              }
281              Assert.Equal("test1", finialInputs["input1"]);
282              Assert.Equal("test2", finialInputs["input2"]);
283              Assert.Equal("github", finialInputs["input3"]);
284              Assert.Equal("invalid1", finialInputs["invalid1"]);
285              Assert.Equal("invalid2", finialInputs["invalid2"]);
286              _ec.Verify(x => x.AddIssue(It.Is<Issue>(s => s.Message.Contains("Unexpected input(s) 'invalid1', 'invalid2'")), It.IsAny<ExecutionContextLogOptions>()), Times.Once);
287          }
288          [Fact]
289          [Trait("Level", "L0")]
290          [Trait("Category", "Worker")]
291          public async void SetGitHubContextActionRepoRef()
292          {
293              Setup();
294              var actionId = Guid.NewGuid();
295              var actionInputs = new MappingToken(null, null, null);
296              actionInputs.Add(new StringToken(null, null, null, "input1"), new StringToken(null, null, null, "test1"));
297              actionInputs.Add(new StringToken(null, null, null, "input2"), new StringToken(null, null, null, "test2"));
298              var action = new Pipelines.ActionStep()
299              {
300                  Name = "action",
301                  Id = actionId,
302                  Reference = new Pipelines.RepositoryPathReference()
303                  {
304                      Name = "actions/test",
305                      Ref = "master"
306                  },
307                  Inputs = actionInputs
308              };
309              _actionRunner.Action = action;
310              Dictionary<string, string> finialInputs = new();
311              _handlerFactory.Setup(x => x.Create(It.IsAny<IExecutionContext>(), It.IsAny<ActionStepDefinitionReference>(), It.IsAny<IStepHost>(), It.IsAny<ActionExecutionData>(), It.IsAny<Dictionary<string, string>>(), It.IsAny<Dictionary<string, string>>(), It.IsAny<Variables>(), It.IsAny<string>(), It.IsAny<List<JobExtensionRunner>>()))
312                             .Callback((IExecutionContext executionContext, Pipelines.ActionStepDefinitionReference actionReference, IStepHost stepHost, ActionExecutionData data, Dictionary<string, string> inputs, Dictionary<string, string> environment, Variables runtimeVariables, string taskDirectory, List<JobExtensionRunner> localActionContainerSetupSteps) =>
313                             {
314                                 finialInputs = inputs;
315                             })
316                             .Returns(new Mock<IHandler>().Object);
317              await _actionRunner.RunAsync();
318              _ec.Verify(x => x.SetGitHubContext("action_repository", "actions/test"), Times.Once);
319              _ec.Verify(x => x.SetGitHubContext("action_ref", "master"), Times.Once);
320              action = new Pipelines.ActionStep()
321              {
322                  Name = "action",
323                  Id = actionId,
324                  Reference = new Pipelines.ScriptReference(),
325                  Inputs = actionInputs
326              };
327              _actionRunner.Action = action;
328              _hc.EnqueueInstance<IDefaultStepHost>(_defaultStepHost.Object);
329              _hc.EnqueueInstance(_fileCommandManager.Object);
330              await _actionRunner.RunAsync();
331              _ec.Verify(x => x.SetGitHubContext("action_repository", null), Times.Once);
332              _ec.Verify(x => x.SetGitHubContext("action_ref", null), Times.Once);
333          }
334          private void Setup([CallerMemberName] string name = "")
335          {
336              _ecTokenSource?.Dispose();
337              _ecTokenSource = new CancellationTokenSource();
338              _hc = new TestHostContext(this, name);
339              var actionInputs = new MappingToken(null, null, null);
340              actionInputs.Add(new StringToken(null, null, null, "input1"), new StringToken(null, null, null, "input1"));
341              actionInputs.Add(new StringToken(null, null, null, "input2"), new StringToken(null, null, null, ""));
342              actionInputs.Add(new StringToken(null, null, null, "input3"), new StringToken(null, null, null, "github"));
343              var actionDefinition = new Definition()
344              {
345                  Directory = _hc.GetDirectory(WellKnownDirectory.Work),
346                  Data = new ActionDefinitionData()
347                  {
348                      Name = name,
349                      Description = name,
350                      Inputs = actionInputs,
351                      Execution = new ScriptActionExecutionData()
352                  }
353              };
354              _actionManager = new Mock<IActionManager>();
355              _actionManager.Setup(x => x.LoadAction(It.IsAny<IExecutionContext>(), It.IsAny<ActionStep>())).Returns(actionDefinition);
356              _handlerFactory = new Mock<IHandlerFactory>();
357              _defaultStepHost = new Mock<IDefaultStepHost>();
358              _actionManifestManager = new ActionManifestManager();
359              _fileCommandManager = new Mock<IFileCommandManager>();
360              _actionManifestManager.Initialize(_hc);
361              var githubContext = new GitHubContext();
362              githubContext.Add("event", JToken.Parse("{\"foo\":\"bar\"}").ToPipelineContextData());
363              _context.Add("github", githubContext);
364  #if OS_WINDOWS
365              _context["env"] = new DictionaryContextData();
366  #else
367              _context["env"] = new CaseSensitiveDictionaryContextData();
368  #endif
369              _ec = new Mock<IExecutionContext>();
370              _ec.Setup(x => x.Global).Returns(new GlobalContext());
371              _ec.Setup(x => x.ExpressionValues).Returns(_context);
372              _ec.Setup(x => x.ExpressionFunctions).Returns(new List<IFunctionInfo>());
373              _ec.Setup(x => x.IntraActionState).Returns(new Dictionary<string, string>());
374              _ec.Object.Global.EnvironmentVariables = new Dictionary<string, string>();
375              _ec.Object.Global.FileTable = new List<String>();
376              _ec.Setup(x => x.SetGitHubContext(It.IsAny<string>(), It.IsAny<string>()));
377              _ec.Setup(x => x.GetGitHubContext(It.IsAny<string>())).Returns("{\"foo\":\"bar\"}");
378              _ec.Setup(x => x.CancellationToken).Returns(_ecTokenSource.Token);
379              _ec.Object.Global.Variables = new Variables(_hc, new Dictionary<string, VariableValue>());
380              _ec.Setup(x => x.Write(It.IsAny<string>(), It.IsAny<string>())).Callback((string tag, string message) => { _hc.GetTrace().Info($"[{tag}]{message}"); });
381              _ec.Setup(x => x.AddIssue(It.IsAny<Issue>(), It.IsAny<ExecutionContextLogOptions>())).Callback((Issue issue, ExecutionContextLogOptions logOptions) => { _hc.GetTrace().Info($"[{issue.Type}]{logOptions.LogMessageOverride ?? issue.Message}"); });
382              _hc.SetSingleton<IActionManager>(_actionManager.Object);
383              _hc.SetSingleton<IHandlerFactory>(_handlerFactory.Object);
384              _hc.SetSingleton<IActionManifestManager>(_actionManifestManager);
385              _hc.EnqueueInstance<IDefaultStepHost>(_defaultStepHost.Object);
386              _hc.EnqueueInstance(_fileCommandManager.Object);
387              _actionRunner = new ActionRunner();
388              _actionRunner.Initialize(_hc);
389              _actionRunner.ExecutionContext = _ec.Object;
390          }
391      }
392  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ActionRunnerL0.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ActionRunnerL0.cs</div>
                </div>
                <div class="column column_space"><pre><code>103              Setup();
104              var actionInputs = new MappingToken(null, null, null);
105              actionInputs.Add(new StringToken(null, null, null, "script"), new StringToken(null, null, null, "echo hello world"));
106              var actionId = Guid.NewGuid();
107              var actionDisplayName = "Run echo hello world";
</pre></code></div>
                <div class="column column_space"><pre><code>182              Setup();
183              var actionInputs = new MappingToken(null, null, null);
184              actionInputs.Add(new StringToken(null, null, null, "script"), new BasicExpressionToken(null, null, null, "matrix.node"));
185              var actionId = Guid.NewGuid();
186              var action = new Pipelines.ActionStep()
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    