
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 45, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-MicrosoftAccountTests.cs</h3>
            <pre><code>1  using Microsoft.AspNetCore.Authentication.MicrosoftAccount;
2  using Microsoft.AspNetCore.Authentication.OAuth;
3  using Microsoft.AspNetCore.Builder;
4  using Microsoft.AspNetCore.DataProtection;
5  using Microsoft.AspNetCore.Hosting;
6  using Microsoft.AspNetCore.Http;
7  using Microsoft.AspNetCore.TestHost;
8  using Microsoft.Extensions.DependencyInjection;
9  using Microsoft.Extensions.Logging.Abstractions;
10  using Newtonsoft.Json;
11  using System;
12  using System.Linq;
13  using System.Net;
14  using System.Net.Http;
15  using System.Security.Claims;
16  using System.Text;
17  using System.Text.Encodings.Web;
18  using System.Threading.Tasks;
19  using Xunit;
20  namespace Microsoft.AspNetCore.Authentication.Tests.MicrosoftAccount
21  {
22      public class MicrosoftAccountTests : RemoteAuthenticationTests&lt;MicrosoftAccountOptions&gt;
23      {
24          protected override string DefaultScheme =&gt; MicrosoftAccountDefaults.AuthenticationScheme;
25          protected override Type HandlerType =&gt; typeof(MicrosoftAccountHandler);
26          protected override bool SupportsSignIn { get =&gt; false; }
27          protected override bool SupportsSignOut { get =&gt; false; }
28          protected override void RegisterAuth(AuthenticationBuilder services, Action&lt;MicrosoftAccountOptions&gt; configure)
29          {
30              services.AddMicrosoftAccount(o =&gt;
31              {
32                  ConfigureDefaults(o);
33                  configure.Invoke(o);
34              });
35          }
36          protected override void ConfigureDefaults(MicrosoftAccountOptions o)
37          {
38              o.ClientId = &quot;whatever&quot;;
39              o.ClientSecret = &quot;whatever&quot;;
40              o.SignInScheme = &quot;auth1&quot;;
41          }
42          [Fact]
43          public async Task ChallengeWillTriggerApplyRedirectEvent()
44          {
45              var server = CreateServer(o =&gt;
46              {
47                  o.ClientId = &quot;Test Client Id&quot;;
48                  o.ClientSecret = &quot;Test Client Secret&quot;;
49                  o.Events = new OAuthEvents
50                  {
51                      OnRedirectToAuthorizationEndpoint = context =&gt;
52                      {
53                          context.Response.Redirect(context.RedirectUri + &quot;&amp;custom=test&quot;);
54                          return Task.FromResult(0);
55                      }
56                  };
57              });
58              var transaction = await server.SendAsync(&quot;http:&amp;bsol;&amp;bsol;example.com/challenge&quot;);
59              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
60              var query = transaction.Response.Headers.Location.Query;
61              Assert.Contains(&quot;custom=test&quot;, query);
62          }
63          [Fact]
64          public async Task SignInThrows()
65          {
66              var server = CreateServer(o =&gt;
67              {
68                  o.ClientId = &quot;Test Id&quot;;
69                  o.ClientSecret = &quot;Test Secret&quot;;
70              });
71              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signIn&quot;);
72              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
73          }
74          [Fact]
75          public async Task SignOutThrows()
76          {
77              var server = CreateServer(o =&gt;
78              {
79                  o.ClientId = &quot;Test Id&quot;;
80                  o.ClientSecret = &quot;Test Secret&quot;;
81              });
82              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signOut&quot;);
83              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
84          }
85          [Fact]
86          public async Task ForbidThrows()
87          {
88              var server = CreateServer(o =&gt;
89              {
90                  o.ClientId = &quot;Test Id&quot;;
91                  o.ClientSecret = &quot;Test Secret&quot;;
92              });
93              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signOut&quot;);
94              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
95          }
96          [Fact]
97          public async Task ChallengeWillTriggerRedirection()
98          {
99              var server = CreateServer(o =&gt;
100              {
101                  o.ClientId = &quot;Test Id&quot;;
102                  o.ClientSecret = &quot;Test Secret&quot;;
103              });
104              var transaction = await server.SendAsync(&quot;http:&amp;bsol;&amp;bsol;example.com/challenge&quot;);
105              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
106              var location = transaction.Response.Headers.Location.AbsoluteUri;
107              Assert.Contains(&quot;https:&amp;bsol;&amp;bsol;login.microsoftonline.com/common/oauth2/v2.0/authorize&quot;, location);
108              Assert.Contains(&quot;response_type=code&quot;, location);
109              Assert.Contains(&quot;client_id=&quot;, location);
110              Assert.Contains(&quot;redirect_uri=&quot;, location);
111              Assert.Contains(&quot;scope=&quot;, location);
112              Assert.Contains(&quot;state=&quot;, location);
113          }
114          [Fact]
115          public async Task ChallengeWillIncludeScopeAsConfigured()
116          {
117              var server = CreateServer(o =&gt;
118              {
119                  o.ClientId = &quot;Test Id&quot;;
120                  o.ClientSecret = &quot;Test Secret&quot;;
121                  o.Scope.Clear();
122                  o.Scope.Add(&quot;foo&quot;);
123                  o.Scope.Add(&quot;bar&quot;);
124              });
125              var transaction = await server.SendAsync(&quot;http:&amp;bsol;&amp;bsol;example.com/challenge&quot;);
126              var res = transaction.Response;
127              Assert.Equal(HttpStatusCode.Redirect, res.StatusCode);
128              Assert.Contains(&quot;scope=foo%20bar&quot;, res.Headers.Location.Query);
129          }
130          [Fact]
131          public async Task ChallengeWillIncludeScopeAsOverwritten()
132          {
133              var server = CreateServer(o =&gt;
134              {
135                  o.ClientId = &quot;Test Id&quot;;
136                  o.ClientSecret = &quot;Test Secret&quot;;
137                  o.Scope.Clear();
138                  o.Scope.Add(&quot;foo&quot;);
139                  o.Scope.Add(&quot;bar&quot;);
140              });
141              var transaction = await server.SendAsync(&quot;http:&amp;bsol;&amp;bsol;example.com/challengeWithOtherScope&quot;);
142              var res = transaction.Response;
143              Assert.Equal(HttpStatusCode.Redirect, res.StatusCode);
144              Assert.Contains(&quot;scope=baz%20qux&quot;, res.Headers.Location.Query);
145          }
146          [Fact]
147          public async Task ChallengeWillIncludeScopeAsOverwrittenWithBaseAuthenticationProperties()
148          {
149              var server = CreateServer(o =&gt;
150              {
151                  o.ClientId = &quot;Test Id&quot;;
152                  o.ClientSecret = &quot;Test Secret&quot;;
153                  o.Scope.Clear();
154                  o.Scope.Add(&quot;foo&quot;);
155                  o.Scope.Add(&quot;bar&quot;);
156              });
157              var transaction = await server.SendAsync(&quot;http:&amp;bsol;&amp;bsol;example.com/challengeWithOtherScopeWithBaseAuthenticationProperties&quot;);
158              var res = transaction.Response;
159              Assert.Equal(HttpStatusCode.Redirect, res.StatusCode);
160              Assert.Contains(&quot;scope=baz%20qux&quot;, res.Headers.Location.Query);
161          }
162          [Fact]
163          public async Task AuthenticatedEventCanGetRefreshToken()
164          {
165              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;MsftTest&quot;));
166              var server = CreateServer(o =&gt;
167              {
168                  o.ClientId = &quot;Test Client Id&quot;;
169                  o.ClientSecret = &quot;Test Client Secret&quot;;
170                  o.StateDataFormat = stateFormat;
171                  o.BackchannelHttpHandler = new TestHttpMessageHandler
172                  {
173                      Sender = req =&gt;
174                      {
175                          if (req.RequestUri.AbsoluteUri == &quot;https:&amp;bsol;&amp;bsol;login.microsoftonline.com/common/oauth2/v2.0/token&quot;)
176                          {
177                              return ReturnJsonResponse(new
178                              {
179                                  access_token = &quot;Test Access Token&quot;,
180                                  expire_in = 3600,
181                                  token_type = &quot;Bearer&quot;,
182                                  refresh_token = &quot;Test Refresh Token&quot;
183                              });
184                          }
185                          else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == &quot;https:&amp;bsol;&amp;bsol;graph.microsoft.com/v1.0/me&quot;)
186                          {
187                              return ReturnJsonResponse(new
188                              {
189                                  id = &quot;Test User ID&quot;,
190                                  displayName = &quot;Test Name&quot;,
191                                  givenName = &quot;Test Given Name&quot;,
192                                  surname = &quot;Test Family Name&quot;,
193                                  mail = &quot;Test email&quot;
194                              });
195                          }
196                          return null;
197                      }
198                  };
199                  o.Events = new OAuthEvents
200                  {
<span onclick='openModal()' class='match'>201                      OnCreatingTicket = context =&gt;
202                      {
203                          var refreshToken = context.RefreshToken;
204                          context.Principal.AddIdentity(new ClaimsIdentity(new Claim[] { new Claim(&quot;RefreshToken&quot;, refreshToken, ClaimValueTypes.String, &quot;Microsoft&quot;) }, &quot;Microsoft&quot;));
205                          return Task.FromResult&lt;object&gt;(null);
</span>206                      }
207                  };
208              });
209              var properties = new AuthenticationProperties();
210              var correlationKey = &quot;.xsrf&quot;;
211              var correlationValue = &quot;TestCorrelationId&quot;;
212              properties.Items.Add(correlationKey, correlationValue);
213              properties.RedirectUri = &quot;/me&quot;;
214              var state = stateFormat.Protect(properties);
215              var transaction = await server.SendAsync(
216                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-microsoft?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
217                  $&quot;.AspNetCore.Correlation.Microsoft.{correlationValue}=N&quot;);
218              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
219              Assert.Equal(&quot;/me&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
220              Assert.Equal(2, transaction.SetCookie.Count);
221              Assert.Contains($&quot;.AspNetCore.Correlation.Microsoft.{correlationValue}&quot;, transaction.SetCookie[0]);
222              Assert.Contains(&quot;.AspNetCore.&quot; + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
223              var authCookie = transaction.AuthenticationCookieValue;
224              transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/me&quot;, authCookie);
225              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
226              Assert.Equal(&quot;Test Refresh Token&quot;, transaction.FindClaimValue(&quot;RefreshToken&quot;));
227          }
228          private static TestServer CreateServer(Action&lt;MicrosoftAccountOptions&gt; configureOptions)
229          {
230              var builder = new WebHostBuilder()
231                  .Configure(app =&gt;
232                  {
233                      app.UseAuthentication();
234                      app.Use(async (context, next) =&gt;
235                      {
236                          var req = context.Request;
237                          var res = context.Response;
238                          if (req.Path == new PathString(&quot;/challenge&quot;))
239                          {
240                              await context.ChallengeAsync(&quot;Microsoft&quot;);
241                          }
242                          else if (req.Path == new PathString(&quot;/challengeWithOtherScope&quot;))
243                          {
244                              var properties = new OAuthChallengeProperties();
245                              properties.SetScope(&quot;baz&quot;, &quot;qux&quot;);
246                              await context.ChallengeAsync(&quot;Microsoft&quot;, properties);
247                          }
248                          else if (req.Path == new PathString(&quot;/challengeWithOtherScopeWithBaseAuthenticationProperties&quot;))
249                          {
250                              var properties = new AuthenticationProperties();
251                              properties.SetParameter(OAuthChallengeProperties.ScopeKey, new string[] { &quot;baz&quot;, &quot;qux&quot; });
252                              await context.ChallengeAsync(&quot;Microsoft&quot;, properties);
253                          }
254                          else if (req.Path == new PathString(&quot;/me&quot;))
255                          {
256                              res.Describe(context.User);
257                          }
258                          else if (req.Path == new PathString(&quot;/signIn&quot;))
259                          {
260                              await Assert.ThrowsAsync&lt;InvalidOperationException&gt;(() =&gt; context.SignInAsync(&quot;Microsoft&quot;, new ClaimsPrincipal()));
261                          }
262                          else if (req.Path == new PathString(&quot;/signOut&quot;))
263                          {
264                              await Assert.ThrowsAsync&lt;InvalidOperationException&gt;(() =&gt; context.SignOutAsync(&quot;Microsoft&quot;));
265                          }
266                          else if (req.Path == new PathString(&quot;/forbid&quot;))
267                          {
268                              await Assert.ThrowsAsync&lt;InvalidOperationException&gt;(() =&gt; context.ForbidAsync(&quot;Microsoft&quot;));
269                          }
270                          else
271                          {
272                              await next();
273                          }
274                      });
275                  })
276                  .ConfigureServices(services =&gt;
277                  {
278                      services.AddAuthentication(TestExtensions.CookieAuthenticationScheme)
279                          .AddCookie(TestExtensions.CookieAuthenticationScheme, o =&gt; { })
280                          .AddMicrosoftAccount(configureOptions);
281                  });
282              return new TestServer(builder);
283          }
284          private static HttpResponseMessage ReturnJsonResponse(object content)
285          {
286              var res = new HttpResponseMessage(HttpStatusCode.OK);
287              var text = JsonConvert.SerializeObject(content);
288              res.Content = new StringContent(text, Encoding.UTF8, &quot;application/json&quot;);
289              return res;
290          }
291      }
292  }
</code></pre>
        </div>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-GoogleTests.cs</h3>
            <pre><code>1  using Microsoft.AspNetCore.Authentication.OAuth;
2  using Microsoft.AspNetCore.Builder;
3  using Microsoft.AspNetCore.DataProtection;
4  using Microsoft.AspNetCore.Hosting;
5  using Microsoft.AspNetCore.Http;
6  using Microsoft.AspNetCore.TestHost;
7  using Microsoft.AspNetCore.WebUtilities;
8  using Microsoft.Extensions.DependencyInjection;
9  using Microsoft.Extensions.Logging.Abstractions;
10  using Newtonsoft.Json;
11  using System;
12  using System.Collections.Generic;
13  using System.Linq;
14  using System.Net;
15  using System.Net.Http;
16  using System.Security.Claims;
17  using System.Text;
18  using System.Text.Encodings.Web;
19  using System.Threading.Tasks;
20  using Xunit;
21  namespace Microsoft.AspNetCore.Authentication.Google
22  {
23      public class GoogleTests : RemoteAuthenticationTests&lt;GoogleOptions&gt;
24      {
25          protected override string DefaultScheme =&gt; GoogleDefaults.AuthenticationScheme;
26          protected override Type HandlerType =&gt; typeof(GoogleHandler);
27          protected override bool SupportsSignIn { get =&gt; false; }
28          protected override bool SupportsSignOut { get =&gt; false; }
29          protected override void RegisterAuth(AuthenticationBuilder services, Action&lt;GoogleOptions&gt; configure)
30          {
31              services.AddGoogle(o =&gt;
32              {
33                  ConfigureDefaults(o);
34                  configure.Invoke(o);
35              });
36          }
37          protected override void ConfigureDefaults(GoogleOptions o)
38          {
39              o.ClientId = &quot;whatever&quot;;
40              o.ClientSecret = &quot;whatever&quot;;
41              o.SignInScheme = &quot;auth1&quot;;
42          }
43          [Fact]
44          public async Task ChallengeWillTriggerRedirection()
45          {
46              var server = CreateServer(o =&gt;
47              {
48                  o.ClientId = &quot;Test Id&quot;;
49                  o.ClientSecret = &quot;Test Secret&quot;;
50              });
51              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/challenge&quot;);
52              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
53              var location = transaction.Response.Headers.Location.ToString();
54              Assert.Contains(&quot;https:&amp;bsol;&amp;bsol;accounts.google.com/o/oauth2/v2/auth?response_type=code&quot;, location);
55              Assert.Contains(&quot;&amp;client_id=&quot;, location);
56              Assert.Contains(&quot;&amp;redirect_uri=&quot;, location);
57              Assert.Contains(&quot;&amp;scope=&quot;, location);
58              Assert.Contains(&quot;&amp;state=&quot;, location);
59              Assert.DoesNotContain(&quot;access_type=&quot;, location);
60              Assert.DoesNotContain(&quot;prompt=&quot;, location);
61              Assert.DoesNotContain(&quot;approval_prompt=&quot;, location);
62              Assert.DoesNotContain(&quot;login_hint=&quot;, location);
63              Assert.DoesNotContain(&quot;include_granted_scopes=&quot;, location);
64          }
65          [Fact]
66          public async Task SignInThrows()
67          {
68              var server = CreateServer(o =&gt;
69              {
70                  o.ClientId = &quot;Test Id&quot;;
71                  o.ClientSecret = &quot;Test Secret&quot;;
72              });
73              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signIn&quot;);
74              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
75          }
76          [Fact]
77          public async Task SignOutThrows()
78          {
79              var server = CreateServer(o =&gt;
80              {
81                  o.ClientId = &quot;Test Id&quot;;
82                  o.ClientSecret = &quot;Test Secret&quot;;
83              });
84              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signOut&quot;);
85              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
86          }
87          [Fact]
88          public async Task ForbidThrows()
89          {
90              var server = CreateServer(o =&gt;
91              {
92                  o.ClientId = &quot;Test Id&quot;;
93                  o.ClientSecret = &quot;Test Secret&quot;;
94              });
95              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signOut&quot;);
96              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
97          }
98          [Fact]
99          public async Task Challenge401WillNotTriggerRedirection()
100          {
101              var server = CreateServer(o =&gt;
102              {
103                  o.ClientId = &quot;Test Id&quot;;
104                  o.ClientSecret = &quot;Test Secret&quot;;
105              });
106              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/401&quot;);
107              Assert.Equal(HttpStatusCode.Unauthorized, transaction.Response.StatusCode);
108          }
109          [Fact]
110          public async Task ChallengeWillSetCorrelationCookie()
111          {
112              var server = CreateServer(o =&gt;
113              {
114                  o.ClientId = &quot;Test Id&quot;;
115                  o.ClientSecret = &quot;Test Secret&quot;;
116              });
117              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/challenge&quot;);
118              Assert.Contains(transaction.SetCookie, cookie =&gt; cookie.StartsWith(&quot;.AspNetCore.Correlation.Google.&quot;));
119          }
120          [Fact]
121          public async Task ChallengeWillSetDefaultScope()
122          {
123              var server = CreateServer(o =&gt;
124              {
125                  o.ClientId = &quot;Test Id&quot;;
126                  o.ClientSecret = &quot;Test Secret&quot;;
127              });
128              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/challenge&quot;);
129              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
130              var query = transaction.Response.Headers.Location.Query;
131              Assert.Contains(&quot;&amp;scope=&quot; + UrlEncoder.Default.Encode(&quot;openid profile email&quot;), query);
132          }
133          [Fact]
134          public async Task ChallengeWillUseAuthenticationPropertiesParametersAsQueryArguments()
135          {
136              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
137              var server = CreateServer(o =&gt;
138              {
139                  o.ClientId = &quot;Test Id&quot;;
140                  o.ClientSecret = &quot;Test Secret&quot;;
141                  o.StateDataFormat = stateFormat;
142              },
143              context =&gt;
144              {
145                  var req = context.Request;
146                  var res = context.Response;
147                  if (req.Path == new PathString(&quot;/challenge2&quot;))
148                  {
149                      return context.ChallengeAsync(&quot;Google&quot;, new GoogleChallengeProperties
150                      {
151                          Scope = new string[] { &quot;openid&quot;, &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/auth/plus.login&quot; },
152                          AccessType = &quot;offline&quot;,
153                          ApprovalPrompt = &quot;force&quot;,
154                          Prompt = &quot;consent&quot;,
155                          LoginHint = &quot;test@example.com&quot;,
156                          IncludeGrantedScopes = false,
157                      });
158                  }
159                  return Task.FromResult&lt;object&gt;(null);
160              });
161              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/challenge2&quot;);
162              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
163              var query = QueryHelpers.ParseQuery(transaction.Response.Headers.Location.Query);
164              Assert.Equal(&quot;openid https:&amp;bsol;&amp;bsol;www.googleapis.com/auth/plus.login&quot;, query[&quot;scope&quot;]);
165              Assert.Equal(&quot;offline&quot;, query[&quot;access_type&quot;]);
166              Assert.Equal(&quot;force&quot;, query[&quot;approval_prompt&quot;]);
167              Assert.Equal(&quot;consent&quot;, query[&quot;prompt&quot;]);
168              Assert.Equal(&quot;false&quot;, query[&quot;include_granted_scopes&quot;]);
169              Assert.Equal(&quot;test@example.com&quot;, query[&quot;login_hint&quot;]);
170              var stateProperties = stateFormat.Unprotect(query[&quot;state&quot;]);
171              Assert.DoesNotContain(&quot;scope&quot;, stateProperties.Items.Keys);
172              Assert.DoesNotContain(&quot;access_type&quot;, stateProperties.Items.Keys);
173              Assert.DoesNotContain(&quot;include_granted_scopes&quot;, stateProperties.Items.Keys);
174              Assert.DoesNotContain(&quot;approval_prompt&quot;, stateProperties.Items.Keys);
175              Assert.DoesNotContain(&quot;prompt&quot;, stateProperties.Items.Keys);
176              Assert.DoesNotContain(&quot;login_hint&quot;, stateProperties.Items.Keys);
177          }
178          [Fact]
179          public async Task ChallengeWillUseAuthenticationPropertiesItemsAsParameters()
180          {
181              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
182              var server = CreateServer(o =&gt;
183              {
184                  o.ClientId = &quot;Test Id&quot;;
185                  o.ClientSecret = &quot;Test Secret&quot;;
186                  o.StateDataFormat = stateFormat;
187              },
188              context =&gt;
189              {
190                  var req = context.Request;
191                  var res = context.Response;
192                  if (req.Path == new PathString(&quot;/challenge2&quot;))
193                  {
194                      return context.ChallengeAsync(&quot;Google&quot;, new AuthenticationProperties(new Dictionary&lt;string, string&gt;()
195                      {
196                          { &quot;scope&quot;, &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/auth/plus.login&quot; },
197                          { &quot;access_type&quot;, &quot;offline&quot; },
198                          { &quot;approval_prompt&quot;, &quot;force&quot; },
199                          { &quot;prompt&quot;, &quot;consent&quot; },
200                          { &quot;login_hint&quot;, &quot;test@example.com&quot; },
201                          { &quot;include_granted_scopes&quot;, &quot;false&quot; }
202                      }));
203                  }
204                  return Task.FromResult&lt;object&gt;(null);
205              });
206              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/challenge2&quot;);
207              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
208              var query = QueryHelpers.ParseQuery(transaction.Response.Headers.Location.Query);
209              Assert.Equal(&quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/auth/plus.login&quot;, query[&quot;scope&quot;]);
210              Assert.Equal(&quot;offline&quot;, query[&quot;access_type&quot;]);
211              Assert.Equal(&quot;force&quot;, query[&quot;approval_prompt&quot;]);
212              Assert.Equal(&quot;consent&quot;, query[&quot;prompt&quot;]);
213              Assert.Equal(&quot;false&quot;, query[&quot;include_granted_scopes&quot;]);
214              Assert.Equal(&quot;test@example.com&quot;, query[&quot;login_hint&quot;]);
215              var stateProperties = stateFormat.Unprotect(query[&quot;state&quot;]);
216              Assert.DoesNotContain(&quot;scope&quot;, stateProperties.Items.Keys);
217              Assert.DoesNotContain(&quot;access_type&quot;, stateProperties.Items.Keys);
218              Assert.DoesNotContain(&quot;include_granted_scopes&quot;, stateProperties.Items.Keys);
219              Assert.DoesNotContain(&quot;approval_prompt&quot;, stateProperties.Items.Keys);
220              Assert.DoesNotContain(&quot;prompt&quot;, stateProperties.Items.Keys);
221              Assert.DoesNotContain(&quot;login_hint&quot;, stateProperties.Items.Keys);
222          }
223          [Fact]
224          public async Task ChallengeWillUseAuthenticationPropertiesItemsAsQueryArgumentsButParametersWillOverwrite()
225          {
226              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
227              var server = CreateServer(o =&gt;
228              {
229                  o.ClientId = &quot;Test Id&quot;;
230                  o.ClientSecret = &quot;Test Secret&quot;;
231                  o.StateDataFormat = stateFormat;
232              },
233              context =&gt;
234              {
235                  var req = context.Request;
236                  var res = context.Response;
237                  if (req.Path == new PathString(&quot;/challenge2&quot;))
238                  {
239                      return context.ChallengeAsync(&quot;Google&quot;, new GoogleChallengeProperties(new Dictionary&lt;string, string&gt;
240                      {
241                          [&quot;scope&quot;] = &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/auth/plus.login&quot;,
242                          [&quot;access_type&quot;] = &quot;offline&quot;,
243                          [&quot;include_granted_scopes&quot;] = &quot;false&quot;,
244                          [&quot;approval_prompt&quot;] = &quot;force&quot;,
245                          [&quot;prompt&quot;] = &quot;login&quot;,
246                          [&quot;login_hint&quot;] = &quot;this-will-be-overwritten@example.com&quot;,
247                      })
248                      {
249                          Prompt = &quot;consent&quot;,
250                          LoginHint = &quot;test@example.com&quot;,
251                      });
252                  }
253                  return Task.FromResult&lt;object&gt;(null);
254              });
255              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/challenge2&quot;);
256              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
257              var query = QueryHelpers.ParseQuery(transaction.Response.Headers.Location.Query);
258              Assert.Equal(&quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/auth/plus.login&quot;, query[&quot;scope&quot;]);
259              Assert.Equal(&quot;offline&quot;, query[&quot;access_type&quot;]);
260              Assert.Equal(&quot;force&quot;, query[&quot;approval_prompt&quot;]);
261              Assert.Equal(&quot;consent&quot;, query[&quot;prompt&quot;]);
262              Assert.Equal(&quot;false&quot;, query[&quot;include_granted_scopes&quot;]);
263              Assert.Equal(&quot;test@example.com&quot;, query[&quot;login_hint&quot;]);
264              var stateProperties = stateFormat.Unprotect(query[&quot;state&quot;]);
265              Assert.DoesNotContain(&quot;scope&quot;, stateProperties.Items.Keys);
266              Assert.DoesNotContain(&quot;access_type&quot;, stateProperties.Items.Keys);
267              Assert.DoesNotContain(&quot;include_granted_scopes&quot;, stateProperties.Items.Keys);
268              Assert.DoesNotContain(&quot;approval_prompt&quot;, stateProperties.Items.Keys);
269              Assert.DoesNotContain(&quot;prompt&quot;, stateProperties.Items.Keys);
270              Assert.DoesNotContain(&quot;login_hint&quot;, stateProperties.Items.Keys);
271          }
272          [Fact]
273          public async Task ChallengeWillTriggerApplyRedirectEvent()
274          {
275              var server = CreateServer(o =&gt;
276              {
277                  o.ClientId = &quot;Test Id&quot;;
278                  o.ClientSecret = &quot;Test Secret&quot;;
279                  o.Events = new OAuthEvents
280                  {
281                      OnRedirectToAuthorizationEndpoint = context =&gt;
282                      {
283                          context.Response.Redirect(context.RedirectUri + &quot;&amp;custom=test&quot;);
284                          return Task.FromResult(0);
285                      }
286                  };
287              });
288              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/challenge&quot;);
289              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
290              var query = transaction.Response.Headers.Location.Query;
291              Assert.Contains(&quot;custom=test&quot;, query);
292          }
293          [Fact]
294          public async Task AuthenticateWithoutCookieWillFail()
295          {
296              var server = CreateServer(o =&gt;
297              {
298                  o.ClientId = &quot;Test Id&quot;;
299                  o.ClientSecret = &quot;Test Secret&quot;;
300              },
301              async context =&gt;
302              {
303                  var req = context.Request;
304                  var res = context.Response;
305                  if (req.Path == new PathString(&quot;/auth&quot;))
306                  {
307                      var result = await context.AuthenticateAsync(&quot;Google&quot;);
308                      Assert.NotNull(result.Failure);
309                  }
310              });
311              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/auth&quot;);
312              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
313          }
314          [Fact]
315          public async Task ReplyPathWithoutStateQueryStringWillBeRejected()
316          {
317              var server = CreateServer(o =&gt;
318              {
319                  o.ClientId = &quot;Test Id&quot;;
320                  o.ClientSecret = &quot;Test Secret&quot;;
321              });
322              var error = await Assert.ThrowsAnyAsync&lt;Exception&gt;(() =&gt; server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&quot;));
323              Assert.Equal(&quot;The oauth state was missing or invalid.&quot;, error.GetBaseException().Message);
324          }
325          [Theory]
326          [InlineData(true)]
327          [InlineData(false)]
328          public async Task ReplyPathWithAccessDeniedErrorFails(bool redirect)
329          {
330              var server = CreateServer(o =&gt;
331              {
332                  o.ClientId = &quot;Test Id&quot;;
333                  o.ClientSecret = &quot;Test Secret&quot;;
334                  o.StateDataFormat = new TestStateDataFormat();
335                  o.Events = redirect ? new OAuthEvents()
336                  {
337                      OnAccessDenied = ctx =&gt;
338                      {
339                          ctx.Response.Redirect(&quot;/error?FailureMessage=AccessDenied&quot;);
340                          ctx.HandleResponse();
341                          return Task.FromResult(0);
342                      }
343                  } : new OAuthEvents();
344              });
345              var sendTask = server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?error=access_denied&amp;error_description=SoBad&amp;error_uri=foobar&amp;state=protected_state&quot;,
346                  &quot;.AspNetCore.Correlation.Google.correlationId=N&quot;);
347              if (redirect)
348              {
349                  var transaction = await sendTask;
350                  Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
351                  Assert.Equal(&quot;/error?FailureMessage=AccessDenied&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
352              }
353              else
354              {
355                  var error = await Assert.ThrowsAnyAsync&lt;Exception&gt;(() =&gt; sendTask);
356                  Assert.Equal(&quot;Access was denied by the resource owner or by the remote server.&quot;, error.GetBaseException().Message);
357              }
358          }
359          [Fact]
360          public async Task ReplyPathWithAccessDeniedError_AllowsCustomizingPath()
361          {
362              var server = CreateServer(o =&gt;
363              {
364                  o.ClientId = &quot;Test Id&quot;;
365                  o.ClientSecret = &quot;Test Secret&quot;;
366                  o.StateDataFormat = new TestStateDataFormat();
367                  o.AccessDeniedPath = &quot;/access-denied&quot;;
368                  o.Events = new OAuthEvents()
369                  {
370                      OnAccessDenied = ctx =&gt;
371                      {
372                          Assert.Equal(&quot;/access-denied&quot;, ctx.AccessDeniedPath.Value);
373                          Assert.Equal(&quot;http:&amp;bsol;&amp;bsol;testhost/redirect&quot;, ctx.ReturnUrl);
374                          Assert.Equal(&quot;ReturnUrl&quot;, ctx.ReturnUrlParameter);
375                          ctx.AccessDeniedPath = &quot;/custom-denied-page&quot;;
376                          ctx.ReturnUrl = &quot;http:&amp;bsol;&amp;bsol;www.google.com/&quot;;
377                          ctx.ReturnUrlParameter = &quot;rurl&quot;;
378                          return Task.FromResult(0);
379                      }
380                  };
381              });
382              var transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?error=access_denied&amp;error_description=SoBad&amp;error_uri=foobar&amp;state=protected_state&quot;,
383                  &quot;.AspNetCore.Correlation.Google.correlationId=N&quot;);
384              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
385              Assert.Equal(&quot;/custom-denied-page?rurl=http%3A%2F%2Fwww.google.com%2F&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
386          }
387          [Theory]
388          [InlineData(true)]
389          [InlineData(false)]
390          public async Task ReplyPathWithErrorFails(bool redirect)
391          {
392              var server = CreateServer(o =&gt;
393              {
394                  o.ClientId = &quot;Test Id&quot;;
395                  o.ClientSecret = &quot;Test Secret&quot;;
396                  o.StateDataFormat = new TestStateDataFormat();
397                  o.Events = redirect ? new OAuthEvents()
398                  {
399                      OnRemoteFailure = ctx =&gt;
400                      {
401                          ctx.Response.Redirect(&quot;/error?FailureMessage=&quot; + UrlEncoder.Default.Encode(ctx.Failure.Message));
402                          ctx.HandleResponse();
403                          return Task.FromResult(0);
404                      }
405                  } : new OAuthEvents();
406              });
407              var sendTask = server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?error=OMG&amp;error_description=SoBad&amp;error_uri=foobar&amp;state=protected_state&quot;,
408                  &quot;.AspNetCore.Correlation.Google.correlationId=N&quot;);
409              if (redirect)
410              {
411                  var transaction = await sendTask;
412                  Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
413                  Assert.Equal(&quot;/error?FailureMessage=OMG&quot; + UrlEncoder.Default.Encode(&quot;;Description=SoBad;Uri=foobar&quot;), transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
414              }
415              else
416              {
417                  var error = await Assert.ThrowsAnyAsync&lt;Exception&gt;(() =&gt; sendTask);
418                  Assert.Equal(&quot;OMG;Description=SoBad;Uri=foobar&quot;, error.GetBaseException().Message);
419              }
420          }
421          [Theory]
422          [InlineData(null)]
423          [InlineData(&quot;CustomIssuer&quot;)]
424          public async Task ReplyPathWillAuthenticateValidAuthorizeCodeAndState(string claimsIssuer)
425          {
426              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
427              var server = CreateServer(o =&gt;
428              {
429                  o.ClientId = &quot;Test Id&quot;;
430                  o.ClientSecret = &quot;Test Secret&quot;;
431                  o.SaveTokens = true;
432                  o.StateDataFormat = stateFormat;
433                  if (claimsIssuer != null)
434                  {
435                      o.ClaimsIssuer = claimsIssuer;
436                  }
437                  o.BackchannelHttpHandler = new TestHttpMessageHandler
438                  {
439                      Sender = req =&gt;
440                      {
441                          if (req.RequestUri.AbsoluteUri == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/oauth2/v4/token&quot;)
442                          {
443                              return ReturnJsonResponse(new
444                              {
445                                  access_token = &quot;Test Access Token&quot;,
446                                  expires_in = 3600,
447                                  token_type = &quot;Bearer&quot;
448                              });
449                          }
450                          else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/plus/v1/people/me&quot;)
451                          {
452                              return ReturnJsonResponse(new
453                              {
454                                  id = &quot;Test User ID&quot;,
455                                  displayName = &quot;Test Name&quot;,
456                                  name = new
457                                  {
458                                      familyName = &quot;Test Family Name&quot;,
459                                      givenName = &quot;Test Given Name&quot;
460                                  },
461                                  url = &quot;Profile link&quot;,
462                                  emails = new[]
463                                  {
464                                      new
465                                      {
466                                          value = &quot;Test email&quot;,
467                                          type = &quot;account&quot;
468                                      }
469                                  }
470                              });
471                          }
472                          throw new NotImplementedException(req.RequestUri.AbsoluteUri);
473                      }
474                  };
475              });
476              var properties = new AuthenticationProperties();
477              var correlationKey = &quot;.xsrf&quot;;
478              var correlationValue = &quot;TestCorrelationId&quot;;
479              properties.Items.Add(correlationKey, correlationValue);
480              properties.RedirectUri = &quot;/me&quot;;
481              var state = stateFormat.Protect(properties);
482              var transaction = await server.SendAsync(
483                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
484                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
485              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
486              Assert.Equal(&quot;/me&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
487              Assert.Equal(2, transaction.SetCookie.Count);
488              Assert.Contains($&quot;.AspNetCore.Correlation.Google.{correlationValue}&quot;, transaction.SetCookie[0]);
489              Assert.Contains(&quot;.AspNetCore.&quot; + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
490              var authCookie = transaction.AuthenticationCookieValue;
491              transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/me&quot;, authCookie);
492              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
493              var expectedIssuer = claimsIssuer ?? GoogleDefaults.AuthenticationScheme;
494              Assert.Equal(&quot;Test Name&quot;, transaction.FindClaimValue(ClaimTypes.Name, expectedIssuer));
495              Assert.Equal(&quot;Test User ID&quot;, transaction.FindClaimValue(ClaimTypes.NameIdentifier, expectedIssuer));
496              Assert.Equal(&quot;Test Given Name&quot;, transaction.FindClaimValue(ClaimTypes.GivenName, expectedIssuer));
497              Assert.Equal(&quot;Test Family Name&quot;, transaction.FindClaimValue(ClaimTypes.Surname, expectedIssuer));
498              Assert.Equal(&quot;Test email&quot;, transaction.FindClaimValue(ClaimTypes.Email, expectedIssuer));
499              Assert.Equal(&quot;yup&quot;, transaction.FindClaimValue(&quot;xform&quot;));
500              transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/tokens&quot;, authCookie);
501              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
502              Assert.Equal(&quot;Test Access Token&quot;, transaction.FindTokenValue(&quot;access_token&quot;));
503              Assert.Equal(&quot;Bearer&quot;, transaction.FindTokenValue(&quot;token_type&quot;));
504              Assert.NotNull(transaction.FindTokenValue(&quot;expires_at&quot;));
505          }
506          [Theory]
507          [InlineData(true)]
508          [InlineData(false)]
509          public async Task ReplyPathWillThrowIfCodeIsInvalid(bool redirect)
510          {
511              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
512              var server = CreateServer(o =&gt;
513              {
514                  o.ClientId = &quot;Test Id&quot;;
515                  o.ClientSecret = &quot;Test Secret&quot;;
516                  o.StateDataFormat = stateFormat;
517                  o.BackchannelHttpHandler = new TestHttpMessageHandler
518                  {
519                      Sender = req =&gt;
520                      {
521                          return ReturnJsonResponse(new { Error = &quot;Error&quot; },
522                              HttpStatusCode.BadRequest);
523                      }
524                  };
525                  o.Events = redirect ? new OAuthEvents()
526                  {
527                      OnRemoteFailure = ctx =&gt;
528                      {
529                          ctx.Response.Redirect(&quot;/error?FailureMessage=&quot; + UrlEncoder.Default.Encode(ctx.Failure.Message));
530                          ctx.HandleResponse();
531                          return Task.FromResult(0);
532                      }
533                  } : new OAuthEvents();
534              });
535              var properties = new AuthenticationProperties();
536              var correlationKey = &quot;.xsrf&quot;;
537              var correlationValue = &quot;TestCorrelationId&quot;;
538              properties.Items.Add(correlationKey, correlationValue);
539              properties.RedirectUri = &quot;/me&quot;;
540              var state = stateFormat.Protect(properties);
541              var sendTask = server.SendAsync(
542                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
543                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
544              if (redirect)
545              {
546                  var transaction = await sendTask;
547                  Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
548                  Assert.Equal(&quot;/error?FailureMessage=&quot; + UrlEncoder.Default.Encode(&quot;OAuth token endpoint failure: Status: BadRequest;Headers: ;Body: {\&quot;Error\&quot;:\&quot;Error\&quot;};&quot;),
549                      transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
550              }
551              else
552              {
553                  var error = await Assert.ThrowsAnyAsync&lt;Exception&gt;(() =&gt; sendTask);
554                  Assert.Equal(&quot;OAuth token endpoint failure: Status: BadRequest;Headers: ;Body: {\&quot;Error\&quot;:\&quot;Error\&quot;};&quot;, error.GetBaseException().Message);
555              }
556          }
557          [Theory]
558          [InlineData(true)]
559          [InlineData(false)]
560          public async Task ReplyPathWillRejectIfAccessTokenIsMissing(bool redirect)
561          {
562              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
563              var server = CreateServer(o =&gt;
564              {
565                  o.ClientId = &quot;Test Id&quot;;
566                  o.ClientSecret = &quot;Test Secret&quot;;
567                  o.StateDataFormat = stateFormat;
568                  o.BackchannelHttpHandler = new TestHttpMessageHandler
569                  {
570                      Sender = req =&gt;
571                      {
572                          return ReturnJsonResponse(new object());
573                      }
574                  };
575                  o.Events = redirect ? new OAuthEvents()
576                  {
577                      OnRemoteFailure = ctx =&gt;
578                      {
579                          ctx.Response.Redirect(&quot;/error?FailureMessage=&quot; + UrlEncoder.Default.Encode(ctx.Failure.Message));
580                          ctx.HandleResponse();
581                          return Task.FromResult(0);
582                      }
583                  } : new OAuthEvents();
584              });
585              var properties = new AuthenticationProperties();
586              var correlationKey = &quot;.xsrf&quot;;
587              var correlationValue = &quot;TestCorrelationId&quot;;
588              properties.Items.Add(correlationKey, correlationValue);
589              properties.RedirectUri = &quot;/me&quot;;
590              var state = stateFormat.Protect(properties);
591              var sendTask = server.SendAsync(
592                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
593                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
594              if (redirect)
595              {
596                  var transaction = await sendTask;
597                  Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
598                  Assert.Equal(&quot;/error?FailureMessage=&quot; + UrlEncoder.Default.Encode(&quot;Failed to retrieve access token.&quot;),
599                      transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
600              }
601              else
602              {
603                  var error = await Assert.ThrowsAnyAsync&lt;Exception&gt;(() =&gt; sendTask);
604                  Assert.Equal(&quot;Failed to retrieve access token.&quot;, error.GetBaseException().Message);
605              }
606          }
607          [Fact]
608          public async Task AuthenticatedEventCanGetRefreshToken()
609          {
610              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
611              var server = CreateServer(o =&gt;
612              {
613                  o.ClientId = &quot;Test Id&quot;;
614                  o.ClientSecret = &quot;Test Secret&quot;;
615                  o.StateDataFormat = stateFormat;
616                  o.BackchannelHttpHandler = new TestHttpMessageHandler
617                  {
618                      Sender = req =&gt;
619                      {
620                          if (req.RequestUri.AbsoluteUri == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/oauth2/v4/token&quot;)
621                          {
622                              return ReturnJsonResponse(new
623                              {
624                                  access_token = &quot;Test Access Token&quot;,
625                                  expires_in = 3600,
626                                  token_type = &quot;Bearer&quot;,
627                                  refresh_token = &quot;Test Refresh Token&quot;
628                              });
629                          }
630                          else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/plus/v1/people/me&quot;)
631                          {
632                              return ReturnJsonResponse(new
633                              {
634                                  id = &quot;Test User ID&quot;,
635                                  displayName = &quot;Test Name&quot;,
636                                  name = new
637                                  {
638                                      familyName = &quot;Test Family Name&quot;,
639                                      givenName = &quot;Test Given Name&quot;
640                                  },
641                                  url = &quot;Profile link&quot;,
642                                  emails = new[]
643                                      {
644                                          new
645                                          {
646                                              value = &quot;Test email&quot;,
647                                              type = &quot;account&quot;
648                                          }
649                                      }
650                              });
651                          }
652                          throw new NotImplementedException(req.RequestUri.AbsoluteUri);
653                      }
654                  };
655                  o.Events = new OAuthEvents
656                  {
<span onclick='openModal()' class='match'>657                      OnCreatingTicket = context =&gt;
658                      {
659                          var refreshToken = context.RefreshToken;
660                          context.Principal.AddIdentity(new ClaimsIdentity(new Claim[] { new Claim(&quot;RefreshToken&quot;, refreshToken, ClaimValueTypes.String, &quot;Google&quot;) }, &quot;Google&quot;));
661                          return Task.FromResult(0);
</span>662                      }
663                  };
664              });
665              var properties = new AuthenticationProperties();
666              var correlationKey = &quot;.xsrf&quot;;
667              var correlationValue = &quot;TestCorrelationId&quot;;
668              properties.Items.Add(correlationKey, correlationValue);
669              properties.RedirectUri = &quot;/me&quot;;
670              var state = stateFormat.Protect(properties);
671              var transaction = await server.SendAsync(
672                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
673                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
674              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
675              Assert.Equal(&quot;/me&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
676              Assert.Equal(2, transaction.SetCookie.Count);
677              Assert.Contains($&quot;.AspNetCore.Correlation.Google.{correlationValue}&quot;, transaction.SetCookie[0]);
678              Assert.Contains(&quot;.AspNetCore.&quot; + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
679              var authCookie = transaction.AuthenticationCookieValue;
680              transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/me&quot;, authCookie);
681              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
682              Assert.Equal(&quot;Test Refresh Token&quot;, transaction.FindClaimValue(&quot;RefreshToken&quot;));
683          }
684          [Fact]
685          public async Task NullRedirectUriWillRedirectToSlash()
686          {
687              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
688              var server = CreateServer(o =&gt;
689              {
690                  o.ClientId = &quot;Test Id&quot;;
691                  o.ClientSecret = &quot;Test Secret&quot;;
692                  o.StateDataFormat = stateFormat;
693                  o.BackchannelHttpHandler = new TestHttpMessageHandler
694                  {
695                      Sender = req =&gt;
696                      {
697                          if (req.RequestUri.AbsoluteUri == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/oauth2/v4/token&quot;)
698                          {
699                              return ReturnJsonResponse(new
700                              {
701                                  access_token = &quot;Test Access Token&quot;,
702                                  expires_in = 3600,
703                                  token_type = &quot;Bearer&quot;,
704                                  refresh_token = &quot;Test Refresh Token&quot;
705                              });
706                          }
707                          else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/plus/v1/people/me&quot;)
708                          {
709                              return ReturnJsonResponse(new
710                              {
711                                  id = &quot;Test User ID&quot;,
712                                  displayName = &quot;Test Name&quot;,
713                                  name = new
714                                  {
715                                      familyName = &quot;Test Family Name&quot;,
716                                      givenName = &quot;Test Given Name&quot;
717                                  },
718                                  url = &quot;Profile link&quot;,
719                                  emails = new[]
720                                      {
721                                          new
722                                          {
723                                              value = &quot;Test email&quot;,
724                                              type = &quot;account&quot;
725                                          }
726                                      }
727                              });
728                          }
729                          throw new NotImplementedException(req.RequestUri.AbsoluteUri);
730                      }
731                  };
732                  o.Events = new OAuthEvents
733                  {
734                      OnTicketReceived = context =&gt;
735                      {
736                          context.Properties.RedirectUri = null;
737                          return Task.FromResult(0);
738                      }
739                  };
740              });
741              var properties = new AuthenticationProperties();
742              var correlationKey = &quot;.xsrf&quot;;
743              var correlationValue = &quot;TestCorrelationId&quot;;
744              properties.Items.Add(correlationKey, correlationValue);
745              var state = stateFormat.Protect(properties);
746              var transaction = await server.SendAsync(
747                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
748                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
749              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
750              Assert.Equal(&quot;/&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
751              Assert.Equal(2, transaction.SetCookie.Count);
752              Assert.Contains($&quot;.AspNetCore.Correlation.Google.{correlationValue}&quot;, transaction.SetCookie[0]);
753              Assert.Contains(&quot;.AspNetCore.&quot; + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
754          }
755          [Fact]
756          public async Task ValidateAuthenticatedContext()
757          {
758              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
759              var server = CreateServer(o =&gt;
760              {
761                  o.ClientId = &quot;Test Id&quot;;
762                  o.ClientSecret = &quot;Test Secret&quot;;
763                  o.StateDataFormat = stateFormat;
764                  o.AccessType = &quot;offline&quot;;
765                  o.Events = new OAuthEvents()
766                  {
767                      OnCreatingTicket = context =&gt;
768                      {
769                          Assert.NotNull(context.User);
770                          Assert.Equal(&quot;Test Access Token&quot;, context.AccessToken);
771                          Assert.Equal(&quot;Test Refresh Token&quot;, context.RefreshToken);
772                          Assert.Equal(TimeSpan.FromSeconds(3600), context.ExpiresIn);
773                          Assert.Equal(&quot;Test email&quot;, context.Identity.FindFirst(ClaimTypes.Email)?.Value);
774                          Assert.Equal(&quot;Test User ID&quot;, context.Identity.FindFirst(ClaimTypes.NameIdentifier)?.Value);
775                          Assert.Equal(&quot;Test Name&quot;, context.Identity.FindFirst(ClaimTypes.Name)?.Value);
776                          Assert.Equal(&quot;Test Family Name&quot;, context.Identity.FindFirst(ClaimTypes.Surname)?.Value);
777                          Assert.Equal(&quot;Test Given Name&quot;, context.Identity.FindFirst(ClaimTypes.GivenName)?.Value);
778                          return Task.FromResult(0);
779                      }
780                  };
781                  o.BackchannelHttpHandler = new TestHttpMessageHandler
782                  {
783                      Sender = req =&gt;
784                      {
785                          if (req.RequestUri.AbsoluteUri == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/oauth2/v4/token&quot;)
786                          {
787                              return ReturnJsonResponse(new
788                              {
789                                  access_token = &quot;Test Access Token&quot;,
790                                  expires_in = 3600,
791                                  token_type = &quot;Bearer&quot;,
792                                  refresh_token = &quot;Test Refresh Token&quot;
793                              });
794                          }
795                          else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/plus/v1/people/me&quot;)
796                          {
797                              return ReturnJsonResponse(new
798                              {
799                                  id = &quot;Test User ID&quot;,
800                                  displayName = &quot;Test Name&quot;,
801                                  name = new
802                                  {
803                                      familyName = &quot;Test Family Name&quot;,
804                                      givenName = &quot;Test Given Name&quot;
805                                  },
806                                  url = &quot;Profile link&quot;,
807                                  emails = new[]
808                                      {
809                                          new
810                                          {
811                                              value = &quot;Test email&quot;,
812                                              type = &quot;account&quot;
813                                          }
814                                      }
815                              });
816                          }
817                          throw new NotImplementedException(req.RequestUri.AbsoluteUri);
818                      }
819                  };
820              });
821              var properties = new AuthenticationProperties();
822              var correlationKey = &quot;.xsrf&quot;;
823              var correlationValue = &quot;TestCorrelationId&quot;;
824              properties.Items.Add(correlationKey, correlationValue);
825              properties.RedirectUri = &quot;/foo&quot;;
826              var state = stateFormat.Protect(properties);
827              var transaction = await server.SendAsync(
828                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
829                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
830              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
831              Assert.Equal(&quot;/foo&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
832          }
833          [Fact]
834          public async Task NoStateCausesException()
835          {
836              var server = CreateServer(o =&gt;
837              {
838                  o.ClientId = &quot;Test Id&quot;;
839                  o.ClientSecret = &quot;Test Secret&quot;;
840              });
841              var error = await Assert.ThrowsAnyAsync&lt;Exception&gt;(() =&gt; server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&quot;));
842              Assert.Equal(&quot;The oauth state was missing or invalid.&quot;, error.GetBaseException().Message);
843          }
844          [Fact]
845          public async Task CanRedirectOnError()
846          {
847              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
848              var server = CreateServer(o =&gt;
849              {
850                  o.ClientId = &quot;Test Id&quot;;
851                  o.ClientSecret = &quot;Test Secret&quot;;
852                  o.Events = new OAuthEvents()
853                  {
854                      OnRemoteFailure = ctx =&gt;
855                      {
856                          ctx.Response.Redirect(&quot;/error?FailureMessage=&quot; + UrlEncoder.Default.Encode(ctx.Failure.Message));
857                          ctx.HandleResponse();
858                          return Task.FromResult(0);
859                      }
860                  };
861              });
862              var transaction = await server.SendAsync(
863                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&quot;);
864              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
865              Assert.Equal(&quot;/error?FailureMessage=&quot; + UrlEncoder.Default.Encode(&quot;The oauth state was missing or invalid.&quot;),
866                  transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
867          }
868          [Fact]
869          public async Task AuthenticateAutomaticWhenAlreadySignedInSucceeds()
870          {
871              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
872              var server = CreateServer(o =&gt;
873              {
874                  o.ClientId = &quot;Test Id&quot;;
875                  o.ClientSecret = &quot;Test Secret&quot;;
876                  o.StateDataFormat = stateFormat;
877                  o.SaveTokens = true;
878                  o.BackchannelHttpHandler = CreateBackchannel();
879              });
880              var properties = new AuthenticationProperties();
881              var correlationKey = &quot;.xsrf&quot;;
882              var correlationValue = &quot;TestCorrelationId&quot;;
883              properties.Items.Add(correlationKey, correlationValue);
884              properties.RedirectUri = &quot;/me&quot;;
885              var state = stateFormat.Protect(properties);
886              var transaction = await server.SendAsync(
887                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
888                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
889              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
890              Assert.Equal(&quot;/me&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
891              Assert.Equal(2, transaction.SetCookie.Count);
892              Assert.Contains($&quot;.AspNetCore.Correlation.Google.{correlationValue}&quot;, transaction.SetCookie[0]); 
893              Assert.Contains(&quot;.AspNetCore.&quot; + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
894              var authCookie = transaction.AuthenticationCookieValue;
895              transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/authenticate&quot;, authCookie);
896              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
897              Assert.Equal(&quot;Test Name&quot;, transaction.FindClaimValue(ClaimTypes.Name));
898              Assert.Equal(&quot;Test User ID&quot;, transaction.FindClaimValue(ClaimTypes.NameIdentifier));
899              Assert.Equal(&quot;Test Given Name&quot;, transaction.FindClaimValue(ClaimTypes.GivenName));
900              Assert.Equal(&quot;Test Family Name&quot;, transaction.FindClaimValue(ClaimTypes.Surname));
901              Assert.Equal(&quot;Test email&quot;, transaction.FindClaimValue(ClaimTypes.Email));
902              Assert.Equal(&quot;yup&quot;, transaction.FindClaimValue(&quot;xform&quot;));
903          }
904          [Fact]
905          public async Task AuthenticateGoogleWhenAlreadySignedInSucceeds()
906          {
907              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
908              var server = CreateServer(o =&gt;
909              {
910                  o.ClientId = &quot;Test Id&quot;;
911                  o.ClientSecret = &quot;Test Secret&quot;;
912                  o.StateDataFormat = stateFormat;
913                  o.SaveTokens = true;
914                  o.BackchannelHttpHandler = CreateBackchannel();
915              });
916              var properties = new AuthenticationProperties();
917              var correlationKey = &quot;.xsrf&quot;;
918              var correlationValue = &quot;TestCorrelationId&quot;;
919              properties.Items.Add(correlationKey, correlationValue);
920              properties.RedirectUri = &quot;/me&quot;;
921              var state = stateFormat.Protect(properties);
922              var transaction = await server.SendAsync(
923                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
924                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
925              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
926              Assert.Equal(&quot;/me&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
927              Assert.Equal(2, transaction.SetCookie.Count);
928              Assert.Contains($&quot;.AspNetCore.Correlation.Google.{correlationValue}&quot;, transaction.SetCookie[0]); 
929              Assert.Contains(&quot;.AspNetCore.&quot; + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
930              var authCookie = transaction.AuthenticationCookieValue;
931              transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/authenticateGoogle&quot;, authCookie);
932              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
933              Assert.Equal(&quot;Test Name&quot;, transaction.FindClaimValue(ClaimTypes.Name));
934              Assert.Equal(&quot;Test User ID&quot;, transaction.FindClaimValue(ClaimTypes.NameIdentifier));
935              Assert.Equal(&quot;Test Given Name&quot;, transaction.FindClaimValue(ClaimTypes.GivenName));
936              Assert.Equal(&quot;Test Family Name&quot;, transaction.FindClaimValue(ClaimTypes.Surname));
937              Assert.Equal(&quot;Test email&quot;, transaction.FindClaimValue(ClaimTypes.Email));
938              Assert.Equal(&quot;yup&quot;, transaction.FindClaimValue(&quot;xform&quot;));
939          }
940          [Fact]
941          public async Task AuthenticateFacebookWhenAlreadySignedWithGoogleReturnsNull()
942          {
943              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
944              var server = CreateServer(o =&gt;
945              {
946                  o.ClientId = &quot;Test Id&quot;;
947                  o.ClientSecret = &quot;Test Secret&quot;;
948                  o.StateDataFormat = stateFormat;
949                  o.SaveTokens = true;
950                  o.BackchannelHttpHandler = CreateBackchannel();
951              });
952              var properties = new AuthenticationProperties();
953              var correlationKey = &quot;.xsrf&quot;;
954              var correlationValue = &quot;TestCorrelationId&quot;;
955              properties.Items.Add(correlationKey, correlationValue);
956              properties.RedirectUri = &quot;/me&quot;;
957              var state = stateFormat.Protect(properties);
958              var transaction = await server.SendAsync(
959                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
960                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
961              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
962              Assert.Equal(&quot;/me&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
963              Assert.Equal(2, transaction.SetCookie.Count);
964              Assert.Contains($&quot;.AspNetCore.Correlation.Google.{correlationValue}&quot;, transaction.SetCookie[0]); 
965              Assert.Contains(&quot;.AspNetCore.&quot; + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
966              var authCookie = transaction.AuthenticationCookieValue;
967              transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/authenticateFacebook&quot;, authCookie);
968              Assert.Equal(HttpStatusCode.OK, transaction.Response.StatusCode);
969              Assert.Null(transaction.FindClaimValue(ClaimTypes.Name));
970          }
971          [Fact]
972          public async Task ChallengeFacebookWhenAlreadySignedWithGoogleSucceeds()
973          {
974              var stateFormat = new PropertiesDataFormat(new EphemeralDataProtectionProvider(NullLoggerFactory.Instance).CreateProtector(&quot;GoogleTest&quot;));
975              var server = CreateServer(o =&gt;
976              {
977                  o.ClientId = &quot;Test Id&quot;;
978                  o.ClientSecret = &quot;Test Secret&quot;;
979                  o.StateDataFormat = stateFormat;
980                  o.SaveTokens = true;
981                  o.BackchannelHttpHandler = CreateBackchannel();
982              });
983              var properties = new AuthenticationProperties();
984              var correlationKey = &quot;.xsrf&quot;;
985              var correlationValue = &quot;TestCorrelationId&quot;;
986              properties.Items.Add(correlationKey, correlationValue);
987              properties.RedirectUri = &quot;/me&quot;;
988              var state = stateFormat.Protect(properties);
989              var transaction = await server.SendAsync(
990                  &quot;https:&amp;bsol;&amp;bsol;example.com/signin-google?code=TestCode&amp;state=&quot; + UrlEncoder.Default.Encode(state),
991                  $&quot;.AspNetCore.Correlation.Google.{correlationValue}=N&quot;);
992              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
993              Assert.Equal(&quot;/me&quot;, transaction.Response.Headers.GetValues(&quot;Location&quot;).First());
994              Assert.Equal(2, transaction.SetCookie.Count);
995              Assert.Contains($&quot;.AspNetCore.Correlation.Google.{correlationValue}&quot;, transaction.SetCookie[0]); 
996              Assert.Contains(&quot;.AspNetCore.&quot; + TestExtensions.CookieAuthenticationScheme, transaction.SetCookie[1]);
997              var authCookie = transaction.AuthenticationCookieValue;
998              transaction = await server.SendAsync(&quot;https:&amp;bsol;&amp;bsol;example.com/challengeFacebook&quot;, authCookie);
999              Assert.Equal(HttpStatusCode.Redirect, transaction.Response.StatusCode);
1000              Assert.StartsWith(&quot;https:&amp;bsol;&amp;bsol;www.facebook.com/&quot;, transaction.Response.Headers.Location.OriginalString);
1001          }
1002          private HttpMessageHandler CreateBackchannel()
1003          {
1004              return new TestHttpMessageHandler()
1005              {
1006                  Sender = req =&gt;
1007                  {
1008                      if (req.RequestUri.AbsoluteUri == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/oauth2/v4/token&quot;)
1009                      {
1010                          return ReturnJsonResponse(new
1011                          {
1012                              access_token = &quot;Test Access Token&quot;,
1013                              expires_in = 3600,
1014                              token_type = &quot;Bearer&quot;
1015                          });
1016                      }
1017                      else if (req.RequestUri.GetComponents(UriComponents.SchemeAndServer | UriComponents.Path, UriFormat.UriEscaped) == &quot;https:&amp;bsol;&amp;bsol;www.googleapis.com/plus/v1/people/me&quot;)
1018                      {
1019                          return ReturnJsonResponse(new
1020                          {
1021                              id = &quot;Test User ID&quot;,
1022                              displayName = &quot;Test Name&quot;,
1023                              name = new
1024                              {
1025                                  familyName = &quot;Test Family Name&quot;,
1026                                  givenName = &quot;Test Given Name&quot;
1027                              },
1028                              url = &quot;Profile link&quot;,
1029                              emails = new[]
1030                              {
1031                                  new
1032                                  {
1033                                      value = &quot;Test email&quot;,
1034                                      type = &quot;account&quot;
1035                                  }
1036                              }
1037                          });
1038                      }
1039                      throw new NotImplementedException(req.RequestUri.AbsoluteUri);
1040                  }
1041              };
1042          }
1043          private static HttpResponseMessage ReturnJsonResponse(object content, HttpStatusCode code = HttpStatusCode.OK)
1044          {
1045              var res = new HttpResponseMessage(code);
1046              var text = JsonConvert.SerializeObject(content);
1047              res.Content = new StringContent(text, Encoding.UTF8, &quot;application/json&quot;);
1048              return res;
1049          }
1050          private class ClaimsTransformer : IClaimsTransformation
1051          {
1052              public Task&lt;ClaimsPrincipal&gt; TransformAsync(ClaimsPrincipal p)
1053              {
1054                  if (!p.Identities.Any(i =&gt; i.AuthenticationType == &quot;xform&quot;))
1055                  {
1056                      var id = new ClaimsIdentity(&quot;xform&quot;);
1057                      id.AddClaim(new Claim(&quot;xform&quot;, &quot;yup&quot;));
1058                      p.AddIdentity(id);
1059                  }
1060                  return Task.FromResult(p);
1061              }
1062          }
1063          private static TestServer CreateServer(Action&lt;GoogleOptions&gt; configureOptions, Func&lt;HttpContext, Task&gt; testpath = null)
1064          {
1065              var builder = new WebHostBuilder()
1066                  .Configure(app =&gt;
1067                  {
1068                      app.UseAuthentication();
1069                      app.Use(async (context, next) =&gt;
1070                      {
1071                          var req = context.Request;
1072                          var res = context.Response;
1073                          if (req.Path == new PathString(&quot;/challenge&quot;))
1074                          {
1075                              await context.ChallengeAsync();
1076                          }
1077                          else if (req.Path == new PathString(&quot;/challengeFacebook&quot;))
1078                          {
1079                              await context.ChallengeAsync(&quot;Facebook&quot;);
1080                          }
1081                          else if (req.Path == new PathString(&quot;/tokens&quot;))
1082                          {
1083                              var result = await context.AuthenticateAsync(TestExtensions.CookieAuthenticationScheme);
1084                              var tokens = result.Properties.GetTokens();
1085                              res.Describe(tokens);
1086                          }
1087                          else if (req.Path == new PathString(&quot;/me&quot;))
1088                          {
1089                              res.Describe(context.User);
1090                          }
1091                          else if (req.Path == new PathString(&quot;/authenticate&quot;))
1092                          {
1093                              var result = await context.AuthenticateAsync(TestExtensions.CookieAuthenticationScheme);
1094                              res.Describe(result.Principal);
1095                          }
1096                          else if (req.Path == new PathString(&quot;/authenticateGoogle&quot;))
1097                          {
1098                              var result = await context.AuthenticateAsync(&quot;Google&quot;);
1099                              res.Describe(result?.Principal);
1100                          }
1101                          else if (req.Path == new PathString(&quot;/authenticateFacebook&quot;))
1102                          {
1103                              var result = await context.AuthenticateAsync(&quot;Facebook&quot;);
1104                              res.Describe(result?.Principal);
1105                          }
1106                          else if (req.Path == new PathString(&quot;/unauthorized&quot;))
1107                          {
1108                              var result = await context.AuthenticateAsync(&quot;Google&quot;);
1109                              await context.ChallengeAsync(&quot;Google&quot;);
1110                          }
1111                          else if (req.Path == new PathString(&quot;/unauthorizedAuto&quot;))
1112                          {
1113                              var result = await context.AuthenticateAsync(&quot;Google&quot;);
1114                              await context.ChallengeAsync(&quot;Google&quot;);
1115                          }
1116                          else if (req.Path == new PathString(&quot;/401&quot;))
1117                          {
1118                              res.StatusCode = 401;
1119                          }
1120                          else if (req.Path == new PathString(&quot;/signIn&quot;))
1121                          {
1122                              await Assert.ThrowsAsync&lt;InvalidOperationException&gt;(() =&gt; context.SignInAsync(&quot;Google&quot;, new ClaimsPrincipal()));
1123                          }
1124                          else if (req.Path == new PathString(&quot;/signOut&quot;))
1125                          {
1126                              await Assert.ThrowsAsync&lt;InvalidOperationException&gt;(() =&gt; context.SignOutAsync(&quot;Google&quot;));
1127                          }
1128                          else if (req.Path == new PathString(&quot;/forbid&quot;))
1129                          {
1130                              await Assert.ThrowsAsync&lt;InvalidOperationException&gt;(() =&gt; context.ForbidAsync(&quot;Google&quot;));
1131                          }
1132                          else if (testpath != null)
1133                          {
1134                              await testpath(context);
1135                          }
1136                          else
1137                          {
1138                              await next();
1139                          }
1140                      });
1141                  })
1142                  .ConfigureServices(services =&gt;
1143                  {
1144                      services.AddTransient&lt;IClaimsTransformation, ClaimsTransformer&gt;();
1145                      services.AddAuthentication(TestExtensions.CookieAuthenticationScheme)
1146                          .AddCookie(TestExtensions.CookieAuthenticationScheme, o =&gt; o.ForwardChallenge = GoogleDefaults.AuthenticationScheme)
1147                          .AddGoogle(configureOptions)
1148                          .AddFacebook(o =&gt;
1149                          {
1150                              o.ClientId = &quot;Test ClientId&quot;;
1151                              o.ClientSecret = &quot;Test AppSecrent&quot;;
1152                          });
1153                  });
1154              return new TestServer(builder);
1155          }
1156          private class TestStateDataFormat : ISecureDataFormat&lt;AuthenticationProperties&gt;
1157          {
1158              private AuthenticationProperties Data { get; set; }
1159              public string Protect(AuthenticationProperties data)
1160              {
1161                  return &quot;protected_state&quot;;
1162              }
1163              public string Protect(AuthenticationProperties data, string purpose)
1164              {
1165                  throw new NotImplementedException();
1166              }
1167              public AuthenticationProperties Unprotect(string protectedText)
1168              {
1169                  Assert.Equal(&quot;protected_state&quot;, protectedText);
1170                  var properties = new AuthenticationProperties(new Dictionary&lt;string, string&gt;()
1171                  {
1172                      { &quot;.xsrf&quot;, &quot;correlationId&quot; },
1173                      { &quot;testkey&quot;, &quot;testvalue&quot; }
1174                  });
1175                  properties.RedirectUri = &quot;http:&amp;bsol;&amp;bsol;testhost/redirect&quot;;
1176                  return properties;
1177              }
1178              public AuthenticationProperties Unprotect(string protectedText, string purpose)
1179              {
1180                  throw new NotImplementedException();
1181              }
1182          }
1183      }
1184  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-MicrosoftAccountTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-GoogleTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>201                      OnCreatingTicket = context =&gt;
202                      {
203                          var refreshToken = context.RefreshToken;
204                          context.Principal.AddIdentity(new ClaimsIdentity(new Claim[] { new Claim(&quot;RefreshToken&quot;, refreshToken, ClaimValueTypes.String, &quot;Microsoft&quot;) }, &quot;Microsoft&quot;));
205                          return Task.FromResult&lt;object&gt;(null);
</pre></code></div>
                <div class="column column_space"><pre><code>657                      OnCreatingTicket = context =&gt;
658                      {
659                          var refreshToken = context.RefreshToken;
660                          context.Principal.AddIdentity(new ClaimsIdentity(new Claim[] { new Claim(&quot;RefreshToken&quot;, refreshToken, ClaimValueTypes.String, &quot;Google&quot;) }, &quot;Google&quot;));
661                          return Task.FromResult(0);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    