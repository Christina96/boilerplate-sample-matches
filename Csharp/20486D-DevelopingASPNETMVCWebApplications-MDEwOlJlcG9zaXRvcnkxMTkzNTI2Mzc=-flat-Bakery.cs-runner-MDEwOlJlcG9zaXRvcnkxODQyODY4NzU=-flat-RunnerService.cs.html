
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 8.187134502923977%, Tokens: 14</h2>
        <div class="column">
            <h3>20486D-DevelopingASPNETMVCWebApplications-MDEwOlJlcG9zaXRvcnkxMTkzNTI2Mzc=-flat-Bakery.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Linq;
4  using System.Threading.Tasks;
5  using System.ComponentModel.DataAnnotations;
6  namespace Cupcakes.Models
7  {
8      public class Bakery
9      {
10          [Key]
11          public int BakeryId { get; set; }
12          [StringLength(50, MinimumLength = 4)]
13          public string BakeryName { get; set; }
14          [Range(1, 40)]
15          public int Quantity { get; set; }
16          [StringLength(50, MinimumLength = 4)]
<span onclick='openModal()' class='match'>17          public string Address { get; set; }
18          public virtual ICollection<Cupcake> Cupcakes { get; set; }
</span>19      }
20  }
</code></pre>
        </div>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-RunnerService.cs</h3>
            <pre><code>1  using System;
2  using System.ComponentModel;
3  using System.Diagnostics;
4  using System.Globalization;
5  using System.IO;
6  using System.Reflection;
7  using System.Runtime.InteropServices;
8  using System.ServiceProcess;
9  using System.Threading;
10  using System.Threading.Tasks;
11  namespace RunnerService
12  {
13      public partial class RunnerService : ServiceBase
14      {
15          public const string EventSourceName = "ActionsRunnerService";
16          private const int CTRL_C_EVENT = 0;
17          private const int CTRL_BREAK_EVENT = 1;
18          private bool _restart = false;
<span onclick='openModal()' class='match'>19          private Process RunnerListener { get; set; }
20          private bool Stopping { get; set; }
</span>21          private object ServiceLock { get; set; }
22          private Task RunningLoop { get; set; }
23          public RunnerService(string serviceName)
24          {
25              ServiceLock = new Object();
26              InitializeComponent();
27              base.ServiceName = serviceName;
28          }
29          protected override void OnStart(string[] args)
30          {
31              RunningLoop = Task.Run(
32                  () =>
33                      {
34                          try
35                          {
36                              bool stopping;
37                              WriteInfo("Starting Actions Runner Service");
38                              TimeSpan timeBetweenRetries = TimeSpan.FromSeconds(5);
39                              lock (ServiceLock)
40                              {
41                                  stopping = Stopping;
42                              }
43                              while (!stopping)
44                              {
45                                  WriteInfo("Starting Actions Runner listener");
46                                  lock (ServiceLock)
47                                  {
48                                      RunnerListener = CreateRunnerListener();
49                                      RunnerListener.OutputDataReceived += RunnerListener_OutputDataReceived;
50                                      RunnerListener.ErrorDataReceived += RunnerListener_ErrorDataReceived;
51                                      RunnerListener.Start();
52                                      RunnerListener.BeginOutputReadLine();
53                                      RunnerListener.BeginErrorReadLine();
54                                  }
55                                  RunnerListener.WaitForExit();
56                                  int exitCode = RunnerListener.ExitCode;
57                                  switch (exitCode)
58                                  {
59                                      case 0:
60                                          Stopping = true;
61                                          WriteInfo(Resource.RunnerExitWithoutError);
62                                          break;
63                                      case 1:
64                                          Stopping = true;
65                                          WriteInfo(Resource.RunnerExitWithTerminatedError);
66                                          break;
67                                      case 2:
68                                          WriteInfo(Resource.RunnerExitWithError);
69                                          break;
70                                      case 3:
71                                          WriteInfo(Resource.RunnerUpdateInProcess);
72                                          var updateResult = HandleRunnerUpdate();
73                                          if (updateResult == RunnerUpdateResult.Succeed)
74                                          {
75                                              WriteInfo(Resource.RunnerUpdateSucceed);
76                                          }
77                                          else if (updateResult == RunnerUpdateResult.Failed)
78                                          {
79                                              WriteInfo(Resource.RunnerUpdateFailed);
80                                              Stopping = true;
81                                          }
82                                          else if (updateResult == RunnerUpdateResult.SucceedNeedRestart)
83                                          {
84                                              WriteInfo(Resource.RunnerUpdateRestartNeeded);
85                                              _restart = true;
86                                              ExitCode = int.MaxValue;
87                                              Stop();
88                                          }
89                                          break;
90                                      default:
91                                          WriteInfo(Resource.RunnerExitWithUndefinedReturnCode);
92                                          break;
93                                  }
94                                  if (Stopping)
95                                  {
96                                      ExitCode = exitCode;
97                                      Stop();
98                                  }
99                                  else
100                                  {
101                                      Thread.Sleep(timeBetweenRetries);
102                                  }
103                                  lock (ServiceLock)
104                                  {
105                                      RunnerListener.OutputDataReceived -= RunnerListener_OutputDataReceived;
106                                      RunnerListener.ErrorDataReceived -= RunnerListener_ErrorDataReceived;
107                                      RunnerListener.Dispose();
108                                      RunnerListener = null;
109                                      stopping = Stopping;
110                                  }
111                              }
112                          }
113                          catch (Exception exception)
114                          {
115                              WriteException(exception);
116                              ExitCode = 99;
117                              Stop();
118                          }
119                      });
120          }
121          private void RunnerListener_ErrorDataReceived(object sender, DataReceivedEventArgs e)
122          {
123              if (!string.IsNullOrEmpty(e.Data))
124              {
125                  WriteToEventLog(e.Data, EventLogEntryType.Error);
126              }
127          }
128          private void RunnerListener_OutputDataReceived(object sender, DataReceivedEventArgs e)
129          {
130              if (!string.IsNullOrEmpty(e.Data))
131              {
132                  WriteToEventLog(e.Data, EventLogEntryType.Information);
133              }
134          }
135          private Process CreateRunnerListener()
136          {
137              string exeLocation = Assembly.GetEntryAssembly().Location;
138              string runnerExeLocation = Path.Combine(Path.GetDirectoryName(exeLocation), "Runner.Listener.exe");
139              Process newProcess = new Process();
140              newProcess.StartInfo = new ProcessStartInfo(runnerExeLocation, "run --startuptype service");
141              newProcess.StartInfo.CreateNoWindow = true;
142              newProcess.StartInfo.UseShellExecute = false;
143              newProcess.StartInfo.RedirectStandardInput = true;
144              newProcess.StartInfo.RedirectStandardOutput = true;
145              newProcess.StartInfo.RedirectStandardError = true;
146              return newProcess;
147          }
148          protected override void OnShutdown()
149          {
150              SendCtrlSignalToRunnerListener(CTRL_BREAK_EVENT);
151              base.OnShutdown();
152          }
153          protected override void OnStop()
154          {
155              lock (ServiceLock)
156              {
157                  Stopping = true;
158                  if (_restart)
159                  {
160                      throw new Exception(Resource.CrashServiceHost);
161                  }
162                  SendCtrlSignalToRunnerListener(CTRL_C_EVENT);
163              }
164          }
165          private void SendCtrlSignalToRunnerListener(uint signal)
166          {
167              try
168              {
169                  if (RunnerListener != null && !RunnerListener.HasExited)
170                  {
171                      if (AttachConsole((uint)RunnerListener.Id))
172                      {
173                          SetConsoleCtrlHandler(null, true);
174                          try
175                          {
176                              GenerateConsoleCtrlEvent(signal, 0);
177                              RunnerListener.WaitForExit(30000);
178                          }
179                          finally
180                          {
181                              FreeConsole();
182                              SetConsoleCtrlHandler(null, false);
183                          }
184                      }
185                      if (!RunnerListener.HasExited)
186                      {
187                          RunnerListener.Kill();
188                      }
189                  }
190              }
191              catch (Exception exception)
192              {
193                  WriteException(exception);
194              }
195          }
196          private RunnerUpdateResult HandleRunnerUpdate()
197          {
198              Thread.Sleep(5000);
199              DirectoryInfo dirInfo = new DirectoryInfo(GetDiagnosticFolderPath());
200              FileInfo[] updateLogs = dirInfo.GetFiles("SelfUpdate-*-*.log.*") ?? new FileInfo[0];
201              if (updateLogs.Length == 0)
202              {
203                  return RunnerUpdateResult.Failed;
204              }
205              else
206              {
207                  FileInfo latestLogFile = null;
208                  DateTime latestLogTimestamp = DateTime.MinValue;
209                  foreach (var logFile in updateLogs)
210                  {
211                      int timestampStartIndex = logFile.Name.IndexOf("-") + 1;
212                      int timestampEndIndex = logFile.Name.LastIndexOf(".log") - 1;
213                      string timestamp = logFile.Name.Substring(timestampStartIndex, timestampEndIndex - timestampStartIndex + 1);
214                      DateTime updateTime;
215                      if (DateTime.TryParseExact(timestamp, "yyyyMMdd-HHmmss", null, DateTimeStyles.None, out updateTime) &&
216                          updateTime > latestLogTimestamp)
217                      {
218                          latestLogFile = logFile;
219                          latestLogTimestamp = updateTime;
220                      }
221                  }
222                  if (latestLogFile == null || latestLogTimestamp == DateTime.MinValue)
223                  {
224                      return RunnerUpdateResult.Failed;
225                  }
226                  latestLogFile.Refresh();
227                  if (DateTime.UtcNow - latestLogFile.LastWriteTimeUtc > TimeSpan.FromSeconds(15))
228                  {
229                      return RunnerUpdateResult.Failed;
230                  }
231                  else
232                  {
233                      string resultString = Path.GetExtension(latestLogFile.Name).TrimStart('.');
234                      RunnerUpdateResult result;
235                      if (Enum.TryParse<RunnerUpdateResult>(resultString, true, out result))
236                      {
237                          return result;
238                      }
239                      else
240                      {
241                          return RunnerUpdateResult.Failed;
242                      }
243                  }
244              }
245          }
246          private void WriteToEventLog(string eventText, EventLogEntryType entryType)
247          {
248              EventLog.WriteEntry(EventSourceName, eventText, entryType, 100);
249          }
250          private string GetDiagnosticFolderPath()
251          {
252              return Path.Combine(Path.GetDirectoryName(Path.GetDirectoryName(Assembly.GetEntryAssembly().Location)), "_diag");
253          }
254          private void WriteError(int exitCode)
255          {
256              String diagFolder = GetDiagnosticFolderPath();
257              String eventText = String.Format(
258                  CultureInfo.InvariantCulture,
259                  "The Runner.Listener process failed to start successfully. It exited with code {0}. Check the latest Runner log files in {1} for more information.",
260                  exitCode,
261                  diagFolder);
262              WriteToEventLog(eventText, EventLogEntryType.Error);
263          }
264          private void WriteInfo(string message)
265          {
266              WriteToEventLog(message, EventLogEntryType.Information);
267          }
268          private void WriteException(Exception exception)
269          {
270              WriteToEventLog(exception.ToString(), EventLogEntryType.Error);
271          }
272          private enum RunnerUpdateResult
273          {
274              Succeed,
275              Failed,
276              SucceedNeedRestart,
277          }
278          [DllImport("kernel32.dll", SetLastError = true)]
279          private static extern bool GenerateConsoleCtrlEvent(uint dwCtrlEvent, uint dwProcessGroupId);
280          [DllImport("kernel32.dll", SetLastError = true)]
281          private static extern bool AttachConsole(uint dwProcessId);
282          [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]
283          private static extern bool FreeConsole();
284          [DllImport("kernel32.dll", SetLastError = true)]
285          private static extern bool SetConsoleCtrlHandler(ConsoleCtrlDelegate HandlerRoutine, bool Add);
286          delegate Boolean ConsoleCtrlDelegate(uint CtrlType);
287      }
288  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from 20486D-DevelopingASPNETMVCWebApplications-MDEwOlJlcG9zaXRvcnkxMTkzNTI2Mzc=-flat-Bakery.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-RunnerService.cs</div>
                </div>
                <div class="column column_space"><pre><code>17          public string Address { get; set; }
18          public virtual ICollection<Cupcake> Cupcakes { get; set; }
</pre></code></div>
                <div class="column column_space"><pre><code>19          private Process RunnerListener { get; set; }
20          private bool Stopping { get; set; }
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    