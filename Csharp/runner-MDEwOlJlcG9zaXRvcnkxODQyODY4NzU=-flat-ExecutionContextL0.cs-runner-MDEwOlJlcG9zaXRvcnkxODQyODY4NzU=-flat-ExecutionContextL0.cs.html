
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 33, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ExecutionContextL0.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Linq;
4  using System.Runtime.CompilerServices;
5  using System.Threading;
6  using GitHub.DistributedTask.Pipelines.ContextData;
7  using GitHub.DistributedTask.WebApi;
8  using GitHub.Runner.Worker;
9  using GitHub.Runner.Worker.Container;
10  using GitHub.Runner.Worker.Handlers;
11  using Moq;
12  using Xunit;
13  using GitHub.DistributedTask.ObjectTemplating.Tokens;
14  using Pipelines = GitHub.DistributedTask.Pipelines;
15  namespace GitHub.Runner.Common.Tests.Worker
16  {
17      public sealed class ExecutionContextL0
18      {
19          [Fact]
20          [Trait("Level", "L0")]
21          [Trait("Category", "Worker")]
22          public void AddIssue_CountWarningsErrors()
23          {
24              using (TestHostContext hc = CreateTestContext())
25              {
26                  TaskOrchestrationPlanReference plan = new();
27                  TimelineReference timeline = new();
28                  Guid jobId = Guid.NewGuid();
29                  string jobName = "some job name";
30                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
31                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
32                  {
33                      Alias = Pipelines.PipelineConstants.SelfAlias,
34                      Id = "github",
35                      Version = "sha1"
36                  });
37                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
38                  var pagingLogger = new Mock<IPagingLogger>();
39                  var jobServerQueue = new Mock<IJobServerQueue>();
40                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
41                  hc.EnqueueInstance(pagingLogger.Object);
42                  hc.SetSingleton(jobServerQueue.Object);
43                  var ec = new Runner.Worker.ExecutionContext();
44                  ec.Initialize(hc);
45                  ec.InitializeJob(jobRequest, CancellationToken.None);
46                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
47                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
48                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
49                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
50                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
51                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
52                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
53                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
54                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
55                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
56                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
57                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
58                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
59                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
60                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
61                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
62                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
63                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
64                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
65                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
66                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
67                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
68                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
69                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
70                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
71                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
72                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
73                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
74                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
75                  ec.Complete();
76                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.ErrorCount > 0)), Times.AtLeast(10));
77                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.WarningCount > 0)), Times.AtLeast(10));
78                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.Issues.Where(i => i.Type == IssueType.Error).Count() == 10)), Times.AtLeastOnce);
79                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.Issues.Where(i => i.Type == IssueType.Warning).Count() == 10)), Times.AtLeastOnce);
80              }
81          }
82          [Fact]
83          [Trait("Level", "L0")]
84          [Trait("Category", "Worker")]
85          public void ApplyContinueOnError_CheckResultAndOutcome()
86          {
87              using (TestHostContext hc = CreateTestContext())
88              {
89                  TaskOrchestrationPlanReference plan = new();
90                  TimelineReference timeline = new();
91                  Guid jobId = Guid.NewGuid();
92                  string jobName = "some job name";
93                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
94                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
95                  {
96                      Alias = Pipelines.PipelineConstants.SelfAlias,
97                      Id = "github",
98                      Version = "sha1"
99                  });
100                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
101                  jobRequest.Variables["ACTIONS_STEP_DEBUG"] = "true";
102                  var pagingLogger = new Mock<IPagingLogger>();
103                  var jobServerQueue = new Mock<IJobServerQueue>();
104                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
105                  jobServerQueue.Setup(x => x.QueueWebConsoleLine(It.IsAny<Guid>(), It.IsAny<string>(), It.IsAny<long>())).Callback((Guid id, string msg, long? lineNumber) => { hc.GetTrace().Info(msg); });
106                  hc.EnqueueInstance(pagingLogger.Object);
107                  hc.SetSingleton(jobServerQueue.Object);
108                  var ec = new Runner.Worker.ExecutionContext();
109                  ec.Initialize(hc);
110                  ec.InitializeJob(jobRequest, CancellationToken.None);
111                  foreach (var tc in new List<(TemplateToken token, TaskResult result, TaskResult? expectedResult, TaskResult? expectedOutcome)> {
112                  (token: new BooleanToken(null, null, null, true), result: TaskResult.Failed, expectedResult: TaskResult.Succeeded, expectedOutcome: TaskResult.Failed),
113                  (token: new BooleanToken(null, null, null, true), result: TaskResult.Succeeded, expectedResult: TaskResult.Succeeded, expectedOutcome: null),
114                  (token: new BooleanToken(null, null, null, true), result: TaskResult.Canceled, expectedResult: TaskResult.Canceled, expectedOutcome: null),
115                  (token: new BooleanToken(null, null, null, false), result: TaskResult.Failed, expectedResult: TaskResult.Failed, expectedOutcome: null),
116                  (token: new BooleanToken(null, null, null, false), result: TaskResult.Succeeded, expectedResult: TaskResult.Succeeded, expectedOutcome: null),
117                  (token: new BooleanToken(null, null, null, false), result: TaskResult.Canceled, expectedResult: TaskResult.Canceled, expectedOutcome: null),
118              })
119                  {
120                      ec.Result = tc.result;
121                      ec.Outcome = null;
122                      ec.ApplyContinueOnError(tc.token);
123                      Assert.Equal(ec.Result, tc.expectedResult);
124                      Assert.Equal(ec.Outcome, tc.expectedOutcome);
125                  }
126              }
127          }
128          [Fact]
129          [Trait("Level", "L0")]
130          [Trait("Category", "Worker")]
131          public void AddIssue_TrimMessageSize()
132          {
133              using (TestHostContext hc = CreateTestContext())
134              {
135                  TaskOrchestrationPlanReference plan = new();
136                  TimelineReference timeline = new();
137                  Guid jobId = Guid.NewGuid();
138                  string jobName = "some job name";
139                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
140                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
141                  {
142                      Alias = Pipelines.PipelineConstants.SelfAlias,
143                      Id = "github",
144                      Version = "sha1"
145                  });
146                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
147                  var pagingLogger = new Mock<IPagingLogger>();
148                  var jobServerQueue = new Mock<IJobServerQueue>();
149                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
150                  hc.EnqueueInstance(pagingLogger.Object);
151                  hc.SetSingleton(jobServerQueue.Object);
152                  var ec = new Runner.Worker.ExecutionContext();
153                  ec.Initialize(hc);
154                  ec.InitializeJob(jobRequest, CancellationToken.None);
155                  var bigMessage = "";
156                  for (var i = 0; i < 5000; i++)
157                  {
158                      bigMessage += "a";
159                  }
160                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = bigMessage }, ExecutionContextLogOptions.Default);
161                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = bigMessage }, ExecutionContextLogOptions.Default);
162                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = bigMessage }, ExecutionContextLogOptions.Default);
163                  ec.Complete();
164                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.Issues.Where(i => i.Type == IssueType.Error).Single().Message.Length <= 4096)), Times.AtLeastOnce);
165                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.Issues.Where(i => i.Type == IssueType.Warning).Single().Message.Length <= 4096)), Times.AtLeastOnce);
166                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.Issues.Where(i => i.Type == IssueType.Notice).Single().Message.Length <= 4096)), Times.AtLeastOnce);
167              }
168          }
169          [Fact]
170          [Trait("Level", "L0")]
171          [Trait("Category", "Worker")]
172          public void AddIssue_OverrideLogMessage()
173          {
174              using (TestHostContext hc = CreateTestContext())
175              {
176                  TaskOrchestrationPlanReference plan = new();
177                  TimelineReference timeline = new();
178                  Guid jobId = Guid.NewGuid();
179                  string jobName = "some job name";
180                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
181                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
182                  {
183                      Alias = Pipelines.PipelineConstants.SelfAlias,
184                      Id = "github",
185                      Version = "sha1"
186                  });
187                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
188                  var pagingLogger = new Mock<IPagingLogger>();
189                  var jobServerQueue = new Mock<IJobServerQueue>();
190                  hc.EnqueueInstance(pagingLogger.Object);
191                  hc.SetSingleton(jobServerQueue.Object);
192                  var ec = new Runner.Worker.ExecutionContext();
193                  ec.Initialize(hc);
194                  ec.InitializeJob(jobRequest, CancellationToken.None);
195                  var issueMessage = "Message embedded in issue.";
196                  var overrideMessage = "Message override.";
197                  var options = new ExecutionContextLogOptions(true, overrideMessage);
198                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = issueMessage }, options);
199                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = issueMessage }, options);
200                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = issueMessage }, options);
201                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = issueMessage }, ExecutionContextLogOptions.Default);
202                  ec.Complete();
203                  jobServerQueue.Verify(x => x.QueueWebConsoleLine(It.IsAny<Guid>(), It.IsAny<string>(), It.IsAny<long?>()), Times.Exactly(4));
204                  jobServerQueue.Verify(x => x.QueueWebConsoleLine(It.IsAny<Guid>(), It.Is<string>(text => text.EndsWith(overrideMessage)), It.IsAny<long?>()), Times.Exactly(3));
205                  jobServerQueue.Verify(x => x.QueueWebConsoleLine(It.IsAny<Guid>(), It.Is<string>(text => text.EndsWith(issueMessage)), It.IsAny<long?>()), Times.Exactly(1));
206              }
207          }
208          [Fact]
209          [Trait("Level", "L0")]
210          [Trait("Category", "Worker")]
211          public void AddIssue_AddStepAndLineNumberInformation()
212          {
213              using (TestHostContext hc = CreateTestContext())
214              {
215                  TaskOrchestrationPlanReference plan = new();
216                  TimelineReference timeline = new();
217                  Guid jobId = Guid.NewGuid();
218                  string jobName = "some job name";
219                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
220                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
221                  {
222                      Alias = Pipelines.PipelineConstants.SelfAlias,
223                      Id = "github",
224                      Version = "sha1"
225                  });
226                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
227                  var pagingLogger = new Mock<IPagingLogger>();
228                  var pagingLogger2 = new Mock<IPagingLogger>();
229                  var jobServerQueue = new Mock<IJobServerQueue>();
230                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
231                  hc.EnqueueInstance(pagingLogger.Object);
232                  hc.EnqueueInstance(pagingLogger2.Object);
233                  hc.SetSingleton(jobServerQueue.Object);
234                  var ec = new Runner.Worker.ExecutionContext();
235                  ec.Initialize(hc);
236                  ec.InitializeJob(jobRequest, CancellationToken.None);
237                  ec.Start();
238                  var embeddedStep = ec.CreateChild(Guid.NewGuid(), "action_1_pre", "action_1_pre", null, null, ActionRunStage.Main, isEmbedded: true);
239                  embeddedStep.Start();
240                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Error, Message = "error annotation that should have step and line number information" }, ExecutionContextLogOptions.Default);
241                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning annotation that should have step and line number information" }, ExecutionContextLogOptions.Default);
242                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Notice, Message = "notice annotation that should have step and line number information" }, ExecutionContextLogOptions.Default);
243                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()), Times.AtLeastOnce);
244                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.Issues.Where(i => i.Data.ContainsKey("stepNumber") && i.Data.ContainsKey("logFileLineNumber") && i.Type == IssueType.Error).Count() == 1)), Times.Never);
245                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.Issues.Where(i => i.Data.ContainsKey("stepNumber") && i.Data.ContainsKey("logFileLineNumber") && i.Type == IssueType.Warning).Count() == 1)), Times.Never);
246                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.Issues.Where(i => i.Data.ContainsKey("stepNumber") && i.Data.ContainsKey("logFileLineNumber") && i.Type == IssueType.Notice).Count() == 1)), Times.Never);
247              }
248          }
249          [Fact]
250          [Trait("Level", "L0")]
251          [Trait("Category", "Worker")]
252          public void Debug_Multilines()
253          {
254              using (TestHostContext hc = CreateTestContext())
255              {
256                  TaskOrchestrationPlanReference plan = new();
257                  TimelineReference timeline = new();
258                  Guid jobId = Guid.NewGuid();
259                  string jobName = "some job name";
260                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
261                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
262                  {
263                      Alias = Pipelines.PipelineConstants.SelfAlias,
264                      Id = "github",
265                      Version = "sha1"
266                  });
267                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
268                  jobRequest.Variables["ACTIONS_STEP_DEBUG"] = "true";
269                  var pagingLogger = new Mock<IPagingLogger>();
270                  var jobServerQueue = new Mock<IJobServerQueue>();
271                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
272                  jobServerQueue.Setup(x => x.QueueWebConsoleLine(It.IsAny<Guid>(), It.IsAny<string>(), It.IsAny<long>())).Callback((Guid id, string msg, long? lineNumber) => { hc.GetTrace().Info(msg); });
273                  hc.EnqueueInstance(pagingLogger.Object);
274                  hc.SetSingleton(jobServerQueue.Object);
275                  var ec = new Runner.Worker.ExecutionContext();
276                  ec.Initialize(hc);
277                  ec.InitializeJob(jobRequest, CancellationToken.None);
278                  ec.Debug(null);
279                  ec.Debug("");
280                  ec.Debug("\n");
281                  ec.Debug("\r\n");
282                  ec.Debug("test");
283                  ec.Debug("te\nst");
284                  ec.Debug("te\r\nst");
285                  ec.Complete();
286                  jobServerQueue.Verify(x => x.QueueWebConsoleLine(It.IsAny<Guid>(), It.IsAny<string>(), It.IsAny<long?>()), Times.Exactly(10));
287              }
288          }
289          [Fact]
290          [Trait("Level", "L0")]
291          [Trait("Category", "Worker")]
292          public void RegisterPostJobAction_ShareState()
293          {
294              using (TestHostContext hc = CreateTestContext())
295              {
296                  TaskOrchestrationPlanReference plan = new();
297                  TimelineReference timeline = new();
298                  Guid jobId = Guid.NewGuid();
299                  string jobName = "some job name";
300                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
301                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
302                  {
303                      Alias = Pipelines.PipelineConstants.SelfAlias,
304                      Id = "github",
305                      Version = "sha1"
306                  });
307                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
308                  jobRequest.Variables["ACTIONS_STEP_DEBUG"] = "true";
309                  var pagingLogger1 = new Mock<IPagingLogger>();
310                  var pagingLogger2 = new Mock<IPagingLogger>();
311                  var pagingLogger3 = new Mock<IPagingLogger>();
312                  var pagingLogger4 = new Mock<IPagingLogger>();
313                  var pagingLogger5 = new Mock<IPagingLogger>();
314                  var jobServerQueue = new Mock<IJobServerQueue>();
315                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
316                  jobServerQueue.Setup(x => x.QueueWebConsoleLine(It.IsAny<Guid>(), It.IsAny<string>(), It.IsAny<long?>())).Callback((Guid id, string msg, long? lineNumber) => { hc.GetTrace().Info(msg); });
317                  var actionRunner1 = new ActionRunner();
318                  actionRunner1.Initialize(hc);
319                  var actionRunner2 = new ActionRunner();
320                  actionRunner2.Initialize(hc);
321                  hc.EnqueueInstance(pagingLogger1.Object);
322                  hc.EnqueueInstance(pagingLogger2.Object);
323                  hc.EnqueueInstance(pagingLogger3.Object);
324                  hc.EnqueueInstance(pagingLogger4.Object);
325                  hc.EnqueueInstance(pagingLogger5.Object);
326                  hc.EnqueueInstance(actionRunner1 as IActionRunner);
327                  hc.EnqueueInstance(actionRunner2 as IActionRunner);
328                  hc.SetSingleton(jobServerQueue.Object);
329                  var jobContext = new Runner.Worker.ExecutionContext();
330                  jobContext.Initialize(hc);
331                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
332                  var action1 = jobContext.CreateChild(Guid.NewGuid(), "action_1", "action_1", null, null, 0);
333                  action1.IntraActionState["state"] = "1";
334                  var action2 = jobContext.CreateChild(Guid.NewGuid(), "action_2", "action_2", null, null, 0);
335                  action2.IntraActionState["state"] = "2";
336                  var postRunner1 = hc.CreateService<IActionRunner>();
337                  postRunner1.Action = new Pipelines.ActionStep() { Id = Guid.NewGuid(), Name = "post1", DisplayName = "Test 1", Reference = new Pipelines.RepositoryPathReference() { Name = "actions/action" } };
338                  postRunner1.Stage = ActionRunStage.Post;
339                  postRunner1.Condition = "always()";
340                  postRunner1.DisplayName = "post1";
341                  var postRunner2 = hc.CreateService<IActionRunner>();
342                  postRunner2.Action = new Pipelines.ActionStep() { Id = Guid.NewGuid(), Name = "post2", DisplayName = "Test 2", Reference = new Pipelines.RepositoryPathReference() { Name = "actions/action" } };
343                  postRunner2.Stage = ActionRunStage.Post;
344                  postRunner2.Condition = "always()";
345                  postRunner2.DisplayName = "post2";
346                  action1.RegisterPostJobStep(postRunner1);
347                  action2.RegisterPostJobStep(postRunner2);
348                  Assert.NotNull(jobContext.JobSteps);
349                  Assert.NotNull(jobContext.PostJobSteps);
350                  Assert.Null(action1.JobSteps);
351                  Assert.Null(action2.JobSteps);
352                  Assert.Null(action1.PostJobSteps);
353                  Assert.Null(action2.PostJobSteps);
354                  var post1 = jobContext.PostJobSteps.Pop();
355                  var post2 = jobContext.PostJobSteps.Pop();
356                  Assert.Equal("post2", (post1 as IActionRunner).Action.Name);
357                  Assert.Equal("post1", (post2 as IActionRunner).Action.Name);
358                  Assert.Equal(ActionRunStage.Post, (post1 as IActionRunner).Stage);
359                  Assert.Equal(ActionRunStage.Post, (post2 as IActionRunner).Stage);
360                  Assert.Equal("always()", (post1 as IActionRunner).Condition);
361                  Assert.Equal("always()", (post2 as IActionRunner).Condition);
362                  Assert.Equal("2", (post1 as IActionRunner).ExecutionContext.IntraActionState["state"]);
363                  Assert.Equal("1", (post2 as IActionRunner).ExecutionContext.IntraActionState["state"]);
364              }
365          }
366          [Fact]
367          [Trait("Level", "L0")]
368          [Trait("Category", "Worker")]
369          public void RegisterPostJobAction_NotRegisterPostTwice()
370          {
371              using (TestHostContext hc = CreateTestContext())
372              {
373                  TaskOrchestrationPlanReference plan = new();
374                  TimelineReference timeline = new();
375                  Guid jobId = Guid.NewGuid();
376                  string jobName = "some job name";
377                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
378                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
379                  {
380                      Alias = Pipelines.PipelineConstants.SelfAlias,
381                      Id = "github",
382                      Version = "sha1"
383                  });
384                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
385                  jobRequest.Variables["ACTIONS_STEP_DEBUG"] = "true";
386                  var pagingLogger1 = new Mock<IPagingLogger>();
387                  var pagingLogger2 = new Mock<IPagingLogger>();
388                  var pagingLogger3 = new Mock<IPagingLogger>();
389                  var pagingLogger4 = new Mock<IPagingLogger>();
390                  var pagingLogger5 = new Mock<IPagingLogger>();
391                  var jobServerQueue = new Mock<IJobServerQueue>();
392                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
393                  jobServerQueue.Setup(x => x.QueueWebConsoleLine(It.IsAny<Guid>(), It.IsAny<string>(), It.IsAny<long?>())).Callback((Guid id, string msg, long? lineNumber) => { hc.GetTrace().Info(msg); });
394                  var actionRunner1 = new ActionRunner();
395                  actionRunner1.Initialize(hc);
396                  var actionRunner2 = new ActionRunner();
397                  actionRunner2.Initialize(hc);
398                  hc.EnqueueInstance(pagingLogger1.Object);
399                  hc.EnqueueInstance(pagingLogger2.Object);
400                  hc.EnqueueInstance(pagingLogger3.Object);
401                  hc.EnqueueInstance(pagingLogger4.Object);
402                  hc.EnqueueInstance(pagingLogger5.Object);
403                  hc.EnqueueInstance(actionRunner1 as IActionRunner);
404                  hc.EnqueueInstance(actionRunner2 as IActionRunner);
405                  hc.SetSingleton(jobServerQueue.Object);
406                  var jobContext = new Runner.Worker.ExecutionContext();
407                  jobContext.Initialize(hc);
408                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
409                  var action1 = jobContext.CreateChild(Guid.NewGuid(), "action_1_pre", "action_1_pre", null, null, 0);
410                  var action2 = jobContext.CreateChild(Guid.NewGuid(), "action_1_main", "action_1_main", null, null, 0);
411                  var actionId = Guid.NewGuid();
412                  var postRunner1 = hc.CreateService<IActionRunner>();
413                  postRunner1.Action = new Pipelines.ActionStep() { Id = actionId, Name = "post1", DisplayName = "Test 1", Reference = new Pipelines.RepositoryPathReference() { Name = "actions/action" } };
414                  postRunner1.Stage = ActionRunStage.Post;
415                  postRunner1.Condition = "always()";
416                  postRunner1.DisplayName = "post1";
417                  var postRunner2 = hc.CreateService<IActionRunner>();
418                  postRunner2.Action = new Pipelines.ActionStep() { Id = actionId, Name = "post2", DisplayName = "Test 2", Reference = new Pipelines.RepositoryPathReference() { Name = "actions/action" } };
419                  postRunner2.Stage = ActionRunStage.Post;
420                  postRunner2.Condition = "always()";
421                  postRunner2.DisplayName = "post2";
422                  action1.RegisterPostJobStep(postRunner1);
423                  action2.RegisterPostJobStep(postRunner2);
424                  Assert.NotNull(jobContext.JobSteps);
425                  Assert.NotNull(jobContext.PostJobSteps);
426                  Assert.Equal(1, jobContext.PostJobSteps.Count);
427                  var post1 = jobContext.PostJobSteps.Pop();
428                  Assert.Equal("post1", (post1 as IActionRunner).Action.Name);
429                  Assert.Equal(ActionRunStage.Post, (post1 as IActionRunner).Stage);
430                  Assert.Equal("always()", (post1 as IActionRunner).Condition);
431              }
432          }
433          [Fact]
434          [Trait("Level", "L0")]
435          [Trait("Category", "Worker")]
436          public void ActionResult_Lowercase()
437          {
438              using (TestHostContext hc = CreateTestContext())
439              {
440                  TaskOrchestrationPlanReference plan = new();
441                  TimelineReference timeline = new();
442                  Guid jobId = Guid.NewGuid();
443                  string jobName = "some job name";
444                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
445                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
446                  {
447                      Alias = Pipelines.PipelineConstants.SelfAlias,
448                      Id = "github",
449                      Version = "sha1"
450                  });
451                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
452                  jobRequest.Variables["ACTIONS_STEP_DEBUG"] = "true";
453                  var pagingLogger1 = new Mock<IPagingLogger>();
454                  var jobServerQueue = new Mock<IJobServerQueue>();
455                  hc.EnqueueInstance(pagingLogger1.Object);
456                  hc.SetSingleton(jobServerQueue.Object);
457                  var jobContext = new Runner.Worker.ExecutionContext();
458                  jobContext.Initialize(hc);
459                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
460                  jobContext.Global.StepsContext.SetConclusion(null, "step1", ActionResult.Success);
461                  var conclusion1 = (jobContext.Global.StepsContext.GetScope(null)["step1"] as DictionaryContextData)["conclusion"].ToString();
462                  Assert.Equal(conclusion1, conclusion1.ToLowerInvariant());
463                  jobContext.Global.StepsContext.SetOutcome(null, "step2", ActionResult.Cancelled);
464                  var outcome1 = (jobContext.Global.StepsContext.GetScope(null)["step2"] as DictionaryContextData)["outcome"].ToString();
465                  Assert.Equal(outcome1, outcome1.ToLowerInvariant());
466                  jobContext.Global.StepsContext.SetConclusion(null, "step3", ActionResult.Failure);
467                  var conclusion2 = (jobContext.Global.StepsContext.GetScope(null)["step3"] as DictionaryContextData)["conclusion"].ToString();
468                  Assert.Equal(conclusion2, conclusion2.ToLowerInvariant());
469                  jobContext.Global.StepsContext.SetOutcome(null, "step4", ActionResult.Skipped);
470                  var outcome2 = (jobContext.Global.StepsContext.GetScope(null)["step4"] as DictionaryContextData)["outcome"].ToString();
471                  Assert.Equal(outcome2, outcome2.ToLowerInvariant());
472                  jobContext.JobContext.Status = ActionResult.Success;
473                  Assert.Equal(jobContext.JobContext["status"].ToString(), jobContext.JobContext["status"].ToString().ToLowerInvariant());
474              }
475          }
476          [Fact]
477          [Trait("Level", "L0")]
478          [Trait("Category", "Worker")]
479          public void PublishStepTelemetry_RegularStep_NoOpt()
480          {
481              using (TestHostContext hc = CreateTestContext())
482              {
483                  TaskOrchestrationPlanReference plan = new();
484                  TimelineReference timeline = new();
485                  Guid jobId = Guid.NewGuid();
486                  string jobName = "some job name";
487                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
488                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
489                  {
490                      Alias = Pipelines.PipelineConstants.SelfAlias,
491                      Id = "github",
492                      Version = "sha1"
493                  });
494                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
495                  var pagingLogger = new Mock<IPagingLogger>();
496                  var jobServerQueue = new Mock<IJobServerQueue>();
497                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
498                  hc.EnqueueInstance(pagingLogger.Object);
499                  hc.SetSingleton(jobServerQueue.Object);
500                  var ec = new Runner.Worker.ExecutionContext();
501                  ec.Initialize(hc);
502                  ec.InitializeJob(jobRequest, CancellationToken.None);
503                  ec.Start();
504                  ec.Complete();
505                  Assert.Equal(0, ec.Global.StepsTelemetry.Count);
506              }
507          }
508          [Fact]
509          [Trait("Level", "L0")]
510          [Trait("Category", "Worker")]
511          public void PublishStepTelemetry_RegularStep()
512          {
513              using (TestHostContext hc = CreateTestContext())
514              {
515                  TaskOrchestrationPlanReference plan = new();
516                  TimelineReference timeline = new();
517                  Guid jobId = Guid.NewGuid();
518                  string jobName = "some job name";
519                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
520                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
521                  {
522                      Alias = Pipelines.PipelineConstants.SelfAlias,
523                      Id = "github",
524                      Version = "sha1"
525                  });
526                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
527                  var pagingLogger = new Mock<IPagingLogger>();
528                  var jobServerQueue = new Mock<IJobServerQueue>();
529                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
530                  hc.EnqueueInstance(pagingLogger.Object);
531                  hc.SetSingleton(jobServerQueue.Object);
532                  var ec = new Runner.Worker.ExecutionContext();
533                  ec.Initialize(hc);
534                  ec.InitializeJob(jobRequest, CancellationToken.None);
535                  ec.Start();
536                  ec.StepTelemetry.Type = "node16";
537                  ec.StepTelemetry.Action = "actions/checkout";
538                  ec.StepTelemetry.Ref = "v2";
539                  ec.StepTelemetry.IsEmbedded = false;
540                  ec.StepTelemetry.StepId = Guid.NewGuid();
541                  ec.StepTelemetry.Stage = "main";
542                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
543                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
544                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = "notice" }, ExecutionContextLogOptions.Default);
545                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
546                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
547                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = "notice" }, ExecutionContextLogOptions.Default);
548                  ec.Complete();
549                  Assert.Equal(1, ec.Global.StepsTelemetry.Count);
550                  Assert.Equal("node16", ec.Global.StepsTelemetry.Single().Type);
551                  Assert.Equal("actions/checkout", ec.Global.StepsTelemetry.Single().Action);
552                  Assert.Equal("v2", ec.Global.StepsTelemetry.Single().Ref);
553                  Assert.Equal(TaskResult.Succeeded, ec.Global.StepsTelemetry.Single().Result);
554                  Assert.NotNull(ec.Global.StepsTelemetry.Single().ExecutionTimeInSeconds);
555                  Assert.Equal(3, ec.Global.StepsTelemetry.Single().ErrorMessages.Count);
556                  Assert.DoesNotContain(ec.Global.StepsTelemetry.Single().ErrorMessages, x => x.Contains("notice"));
557              }
558          }
559          [Fact]
560          [Trait("Level", "L0")]
561          [Trait("Category", "Worker")]
562          public void PublishStepTelemetry_EmbeddedStep()
563          {
564              using (TestHostContext hc = CreateTestContext())
565              {
566                  TaskOrchestrationPlanReference plan = new();
567                  TimelineReference timeline = new();
568                  Guid jobId = Guid.NewGuid();
569                  string jobName = "some job name";
570                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
571                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
572                  {
573                      Alias = Pipelines.PipelineConstants.SelfAlias,
574                      Id = "github",
575                      Version = "sha1"
576                  });
577                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
578                  var pagingLogger = new Mock<IPagingLogger>();
579                  var pagingLogger2 = new Mock<IPagingLogger>();
580                  var jobServerQueue = new Mock<IJobServerQueue>();
581                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
582                  hc.EnqueueInstance(pagingLogger.Object);
583                  hc.EnqueueInstance(pagingLogger2.Object);
584                  hc.SetSingleton(jobServerQueue.Object);
585                  var ec = new Runner.Worker.ExecutionContext();
586                  ec.Initialize(hc);
587                  ec.InitializeJob(jobRequest, CancellationToken.None);
588                  ec.Start();
589                  var embeddedStep = ec.CreateChild(Guid.NewGuid(), "action_1_pre", "action_1_pre", null, null, ActionRunStage.Main, isEmbedded: true);
590                  embeddedStep.Start();
591                  embeddedStep.StepTelemetry.Type = "node16";
592                  embeddedStep.StepTelemetry.Action = "actions/checkout";
593                  embeddedStep.StepTelemetry.Ref = "v2";
594                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
595                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
596                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Notice, Message = "notice" }, ExecutionContextLogOptions.Default);
597                  embeddedStep.PublishStepTelemetry();
598                  Assert.Equal(1, ec.Global.StepsTelemetry.Count);
599                  Assert.Equal("node16", ec.Global.StepsTelemetry.Single().Type);
600                  Assert.Equal("actions/checkout", ec.Global.StepsTelemetry.Single().Action);
601                  Assert.Equal("v2", ec.Global.StepsTelemetry.Single().Ref);
602                  Assert.Equal(ActionRunStage.Main.ToString(), ec.Global.StepsTelemetry.Single().Stage);
603                  Assert.True(ec.Global.StepsTelemetry.Single().IsEmbedded);
604                  Assert.Null(ec.Global.StepsTelemetry.Single().Result);
605                  Assert.Null(ec.Global.StepsTelemetry.Single().ExecutionTimeInSeconds);
606                  Assert.Equal(0, ec.Global.StepsTelemetry.Single().ErrorMessages.Count);
607              }
608          }
609          [Fact]
610          [Trait("Level", "L0")]
611          [Trait("Category", "Worker")]
612          public void PublishStepResult_EmbeddedStep()
613          {
614              using (TestHostContext hc = CreateTestContext())
615              {
616                  TaskOrchestrationPlanReference plan = new();
617                  TimelineReference timeline = new();
618                  Guid jobId = Guid.NewGuid();
619                  string jobName = "some job name";
620                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
621                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
622                  {
623                      Alias = Pipelines.PipelineConstants.SelfAlias,
624                      Id = "github",
625                      Version = "sha1"
626                  });
627                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
628                  var pagingLogger = new Mock<IPagingLogger>();
629                  var pagingLogger2 = new Mock<IPagingLogger>();
630                  var jobServerQueue = new Mock<IJobServerQueue>();
631                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
632                  hc.EnqueueInstance(pagingLogger.Object);
633                  hc.EnqueueInstance(pagingLogger2.Object);
634                  hc.SetSingleton(jobServerQueue.Object);
635                  var ec = new Runner.Worker.ExecutionContext();
636                  ec.Initialize(hc);
637                  ec.InitializeJob(jobRequest, CancellationToken.None);
638                  ec.Start();
639                  var embeddedStep = ec.CreateChild(Guid.NewGuid(), "action_1_pre", "action_1_pre", null, null, ActionRunStage.Main, isEmbedded: true);
640                  embeddedStep.Start();
641                  embeddedStep.StepTelemetry.Type = "node16";
642                  embeddedStep.StepTelemetry.Action = "actions/checkout";
643                  embeddedStep.StepTelemetry.Ref = "v2";
644                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
645                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
646                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Notice, Message = "notice" }, ExecutionContextLogOptions.Default);
647                  ec.Complete();
648                  Assert.Equal(1, ec.Global.StepsResult.Count);
649                  Assert.Equal(TaskResult.Succeeded, ec.Global.StepsResult.Single().Conclusion);
650              }
651          }
652          private TestHostContext CreateTestContext([CallerMemberName] String testName = "")
653          {
654              var hc = new TestHostContext(this, testName);
655              var configurationStore = new Mock<IConfigurationStore>();
656              configurationStore.Setup(x => x.GetSettings()).Returns(new RunnerSettings());
657              hc.SetSingleton(configurationStore.Object);
658              hc.SetSingleton(new Mock<IJobServerQueue>().Object);
659              return hc;
660          }
661          [Fact]
662          [Trait("Level", "L0")]
663          [Trait("Category", "Worker")]
664          public void GetExpressionValues_ContainerStepHost()
665          {
666              using (TestHostContext hc = CreateTestContext())
667              {
668                  const string source = "/home/username/Projects/work/runner/_layout";
669                  var containerInfo = new ContainerInfo();
670                  containerInfo.ContainerId = "test";
671                  containerInfo.AddPathTranslateMapping($"{source}/_work", "/__w");
672                  containerInfo.AddPathTranslateMapping($"{source}/_temp", "/__t");
673                  containerInfo.AddPathTranslateMapping($"{source}/externals", "/__e");
674                  containerInfo.AddPathTranslateMapping($"{source}/_work/_temp/_github_home", "/github/home");
675                  containerInfo.AddPathTranslateMapping($"{source}/_work/_temp/_github_workflow", "/github/workflow");
676                  foreach (var v in new List<string>() {
677                      $"{source}/_work",
678                      $"{source}/externals",
679                      $"{source}/_work/_temp",
680                      $"{source}/_work/_actions",
681                      $"{source}/_work/_tool",
682                  })
683                  {
684                      containerInfo.MountVolumes.Add(new MountVolume(v, containerInfo.TranslateToContainerPath(v)));
685                  };
686                  var stepHost = new ContainerStepHost();
687                  stepHost.Container = containerInfo;
688                  var ec = new Runner.Worker.ExecutionContext();
689                  ec.Initialize(hc);
690                  var inputGithubContext = new GitHubContext();
691                  var inputeRunnerContext = new RunnerContext();
692                  inputGithubContext["action_path"] = new StringContextData("/home/username/Projects/work/runner/_layout/_work/_actions/owner/composite/main");
693                  inputGithubContext["action"] = new StringContextData("__owner_composite");
694                  inputGithubContext["api_url"] = new StringContextData("https:&bsol;&bsol;api.github.com/custom/path");
695                  inputGithubContext["env"] = new StringContextData("/home/username/Projects/work/runner/_layout/_work/_temp/_runner_file_commands/set_env_265698aa-7f38-40f5-9316-5c01a3153672");
696                  inputGithubContext["path"] = new StringContextData("/home/username/Projects/work/runner/_layout/_work/_temp/_runner_file_commands/add_path_265698aa-7f38-40f5-9316-5c01a3153672");
697                  inputGithubContext["event_path"] = new StringContextData("/home/username/Projects/work/runner/_layout/_work/_temp/_github_workflow/event.json");
698                  inputGithubContext["repository"] = new StringContextData("owner/repo-name");
699                  inputGithubContext["run_id"] = new StringContextData("2033211332");
700                  inputGithubContext["workflow"] = new StringContextData("Name of Workflow");
701                  inputGithubContext["workspace"] = new StringContextData("/home/username/Projects/work/runner/_layout/_work/step-order/step-order");
702                  inputeRunnerContext["temp"] = new StringContextData("/home/username/Projects/work/runner/_layout/_work/_temp");
703                  inputeRunnerContext["tool_cache"] = new StringContextData("/home/username/Projects/work/runner/_layout/_work/_tool");
704                  var githubEvent = new DictionaryContextData();
705                  githubEvent["inputs"] = null;
706                  githubEvent["ref"] = new StringContextData("refs/heads/main");
707                  githubEvent["repository"] = new DictionaryContextData();
708                  githubEvent["sender"] = new DictionaryContextData();
709                  githubEvent["workflow"] = new StringContextData(".github/workflows/composite_step_host_translate.yaml");
710                  inputGithubContext["event"] = githubEvent;
711                  ec.ExpressionValues["github"] = inputGithubContext;
712                  ec.ExpressionValues["runner"] = inputeRunnerContext;
713                  var ecExpect = new Runner.Worker.ExecutionContext();
714                  ecExpect.Initialize(hc);
715                  var expectedGithubEvent = new DictionaryContextData();
716                  expectedGithubEvent["inputs"] = null;
717                  expectedGithubEvent["ref"] = new StringContextData("refs/heads/main");
718                  expectedGithubEvent["repository"] = new DictionaryContextData();
719                  expectedGithubEvent["sender"] = new DictionaryContextData();
720                  expectedGithubEvent["workflow"] = new StringContextData(".github/workflows/composite_step_host_translate.yaml");
721                  var expectedGithubContext = new GitHubContext();
722                  var expectedRunnerContext = new RunnerContext();
723                  expectedGithubContext["action_path"] = new StringContextData("/__w/_actions/owner/composite/main");
724                  expectedGithubContext["action"] = new StringContextData("__owner_composite");
725                  expectedGithubContext["api_url"] = new StringContextData("https:&bsol;&bsol;api.github.com/custom/path");
726                  expectedGithubContext["env"] = new StringContextData("/__w/_temp/_runner_file_commands/set_env_265698aa-7f38-40f5-9316-5c01a3153672");
727                  expectedGithubContext["path"] = new StringContextData("/__w/_temp/_runner_file_commands/add_path_265698aa-7f38-40f5-9316-5c01a3153672");
728                  expectedGithubContext["event_path"] = new StringContextData("/github/workflow/event.json");
729                  expectedGithubContext["repository"] = new StringContextData("owner/repo-name");
730                  expectedGithubContext["run_id"] = new StringContextData("2033211332");
731                  expectedGithubContext["workflow"] = new StringContextData("Name of Workflow");
732                  expectedGithubContext["workspace"] = new StringContextData("/__w/step-order/step-order");
733                  expectedGithubContext["event"] = expectedGithubEvent;
734                  expectedRunnerContext["temp"] = new StringContextData("/__w/_temp");
735                  expectedRunnerContext["tool_cache"] = new StringContextData("/__w/_tool");
736                  ecExpect.ExpressionValues["github"] = expectedGithubContext;
737                  ecExpect.ExpressionValues["runner"] = expectedRunnerContext;
738                  var translatedExpressionValues = ec.GetExpressionValues(stepHost);
739                  foreach (var contextName in new string[] { "github", "runner" })
740                  {
741                      var dict = translatedExpressionValues[contextName].AssertDictionary($"expected context github to be a dictionary");
742                      var expectedExpressionValues = ecExpect.ExpressionValues[contextName].AssertDictionary("expect dict");
743                      foreach (var key in dict.Keys.ToList())
744                      {
745                          if (dict[key] is StringContextData)
746                          {
747                              var expect = dict[key].AssertString("expect string");
748                              var outcome = expectedExpressionValues[key].AssertString("expect string");
749                              Assert.Equal(expect.Value, outcome.Value);
750                          }
751                          else if (dict[key] is DictionaryContextData || dict[key] is CaseSensitiveDictionaryContextData)
752                          {
753                              var expectDict = dict[key].AssertDictionary("expect dict");
754                              var actualDict = expectedExpressionValues[key].AssertDictionary("expect dict");
755                              Assert.True(ExpressionValuesAssertEqual(expectDict, actualDict));
756                          }
757                      }
758                  }
759              }
760          }
761          [Fact]
762          [Trait("Level", "L0")]
763          [Trait("Category", "Worker")]
764          public void ActionVariables_AddedToVarsContext()
765          {
766              using (TestHostContext hc = CreateTestContext())
767              {
768                  TaskOrchestrationPlanReference plan = new();
769                  TimelineReference timeline = new();
770                  Guid jobId = Guid.NewGuid();
771                  string jobName = "some job name";
772                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
773                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
774                  {
775                      Alias = Pipelines.PipelineConstants.SelfAlias,
776                      Id = "github",
777                      Version = "sha1"
778                  });
779                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
780                  var inputVarsContext = new DictionaryContextData();
781                  inputVarsContext["VARIABLE_1"] = new StringContextData("value1");
782                  inputVarsContext["VARIABLE_2"] = new StringContextData("value2");
783                  jobRequest.ContextData["vars"] = inputVarsContext;
784                  var pagingLogger1 = new Mock<IPagingLogger>();
785                  var jobServerQueue = new Mock<IJobServerQueue>();
786                  hc.EnqueueInstance(pagingLogger1.Object);
787                  hc.SetSingleton(jobServerQueue.Object);
788                  var jobContext = new Runner.Worker.ExecutionContext();
789                  jobContext.Initialize(hc);
790                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
791                  var expected = new DictionaryContextData();
792                  expected["VARIABLE_1"] = new StringContextData("value1");
793                  expected["VARIABLE_2"] = new StringContextData("value1");
794                  Assert.True(ExpressionValuesAssertEqual(expected, jobContext.ExpressionValues["vars"] as DictionaryContextData));
795              }
796          }
797          [Fact]
798          [Trait("Level", "L0")]
799          [Trait("Category", "Worker")]
800          public void ActionVariables_DebugUsingVars()
801          {
802              using (TestHostContext hc = CreateTestContext())
803              {
804                  TaskOrchestrationPlanReference plan = new TaskOrchestrationPlanReference();
805                  TimelineReference timeline = new TimelineReference();
806                  Guid jobId = Guid.NewGuid();
807                  string jobName = "some job name";
808                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
809                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
810                  {
811                      Alias = Pipelines.PipelineConstants.SelfAlias,
812                      Id = "github",
813                      Version = "sha1"
814                  });
815                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
816                  var inputVarsContext = new DictionaryContextData();
817                  inputVarsContext[Constants.Variables.Actions.StepDebug] = new StringContextData("true");
818                  inputVarsContext[Constants.Variables.Actions.RunnerDebug] = new StringContextData("true");
819                  jobRequest.ContextData["vars"] = inputVarsContext;
820                  var pagingLogger1 = new Mock<IPagingLogger>();
821                  var jobServerQueue = new Mock<IJobServerQueue>();
822                  hc.EnqueueInstance(pagingLogger1.Object);
823                  hc.SetSingleton(jobServerQueue.Object);
824                  var jobContext = new Runner.Worker.ExecutionContext();
825                  jobContext.Initialize(hc);
826                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
827                  Assert.Equal("true", jobContext.Global.Variables.Get(Constants.Variables.Actions.StepDebug));
828                  Assert.Equal("true", jobContext.Global.Variables.Get(Constants.Variables.Actions.RunnerDebug));
829              }
830          }
831          [Fact]
832          [Trait("Level", "L0")]
833          [Trait("Category", "Worker")]
834          public void ActionVariables_SecretsPrecedenceForDebugUsingVars()
835          {
836              using (TestHostContext hc = CreateTestContext())
837              {
838                  TaskOrchestrationPlanReference plan = new TaskOrchestrationPlanReference();
839                  TimelineReference timeline = new TimelineReference();
840                  Guid jobId = Guid.NewGuid();
841                  string jobName = "some job name";
842                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
<span onclick='openModal()' class='match'>843                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
844                  {
845                      Alias = Pipelines.PipelineConstants.SelfAlias,
846                      Id = "github",
847                      Version = "sha1"
848                  });
849                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
</span>850                  var inputVarsContext = new DictionaryContextData();
851                  inputVarsContext[Constants.Variables.Actions.StepDebug] = new StringContextData("true");
852                  inputVarsContext[Constants.Variables.Actions.RunnerDebug] = new StringContextData("true");
853                  jobRequest.ContextData["vars"] = inputVarsContext;
854                  jobRequest.Variables[Constants.Variables.Actions.StepDebug] = "false";
855                  jobRequest.Variables[Constants.Variables.Actions.RunnerDebug] = "false";
856                  var pagingLogger1 = new Mock<IPagingLogger>();
857                  var jobServerQueue = new Mock<IJobServerQueue>();
858                  hc.EnqueueInstance(pagingLogger1.Object);
859                  hc.SetSingleton(jobServerQueue.Object);
860                  var jobContext = new Runner.Worker.ExecutionContext();
861                  jobContext.Initialize(hc);
862                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
863                  Assert.Equal("false", jobContext.Global.Variables.Get(Constants.Variables.Actions.StepDebug));
864                  Assert.Equal("false", jobContext.Global.Variables.Get(Constants.Variables.Actions.RunnerDebug));
865              }
866          }
867          private bool ExpressionValuesAssertEqual(DictionaryContextData expect, DictionaryContextData actual)
868          {
869              foreach (var key in expect.Keys.ToList())
870              {
871                  if (expect[key] is StringContextData)
872                  {
873                      var expectValue = expect[key].AssertString("expect string");
874                      var actualValue = actual[key].AssertString("expect string");
875                      if (expectValue.Equals(actualValue))
876                      {
877                          return false;
878                      }
879                  }
880                  else if (expect[key] is DictionaryContextData || expect[key] is CaseSensitiveDictionaryContextData)
881                  {
882                      var expectDict = expect[key].AssertDictionary("expect dict");
883                      var actualDict = actual[key].AssertDictionary("expect dict");
884                      if (!ExpressionValuesAssertEqual(expectDict, actualDict))
885                      {
886                          return false;
887                      }
888                  }
889              }
890              return true;
891          }
892      }
893  }
</code></pre>
        </div>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ExecutionContextL0.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Linq;
4  using System.Runtime.CompilerServices;
5  using System.Threading;
6  using GitHub.DistributedTask.Pipelines.ContextData;
7  using GitHub.DistributedTask.WebApi;
8  using GitHub.Runner.Worker;
9  using GitHub.Runner.Worker.Container;
10  using GitHub.Runner.Worker.Handlers;
11  using Moq;
12  using Xunit;
13  using GitHub.DistributedTask.ObjectTemplating.Tokens;
14  using Pipelines = GitHub.DistributedTask.Pipelines;
15  namespace GitHub.Runner.Common.Tests.Worker
16  {
17      public sealed class ExecutionContextL0
18      {
19          [Fact]
20          [Trait("Level", "L0")]
21          [Trait("Category", "Worker")]
22          public void AddIssue_CountWarningsErrors()
23          {
24              using (TestHostContext hc = CreateTestContext())
25              {
26                  TaskOrchestrationPlanReference plan = new();
27                  TimelineReference timeline = new();
28                  Guid jobId = Guid.NewGuid();
29                  string jobName = "some job name";
30                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
31                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
32                  {
33                      Alias = Pipelines.PipelineConstants.SelfAlias,
34                      Id = "github",
35                      Version = "sha1"
36                  });
37                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
38                  var pagingLogger = new Mock<IPagingLogger>();
39                  var jobServerQueue = new Mock<IJobServerQueue>();
40                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
41                  hc.EnqueueInstance(pagingLogger.Object);
42                  hc.SetSingleton(jobServerQueue.Object);
43                  var ec = new Runner.Worker.ExecutionContext();
44                  ec.Initialize(hc);
45                  ec.InitializeJob(jobRequest, CancellationToken.None);
46                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
47                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
48                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
49                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
50                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
51                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
52                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
53                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
54                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
55                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
56                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
57                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
58                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
59                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
60                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
61                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
62                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
63                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
64                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
65                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
66                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
67                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
68                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
69                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
70                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
71                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
72                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
73                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
74                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
75                  ec.Complete();
76                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.ErrorCount > 0)), Times.AtLeast(10));
77                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.WarningCount > 0)), Times.AtLeast(10));
78                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.Issues.Where(i => i.Type == IssueType.Error).Count() == 10)), Times.AtLeastOnce);
79                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.Issues.Where(i => i.Type == IssueType.Warning).Count() == 10)), Times.AtLeastOnce);
80              }
81          }
82          [Fact]
83          [Trait("Level", "L0")]
84          [Trait("Category", "Worker")]
85          public void ApplyContinueOnError_CheckResultAndOutcome()
86          {
87              using (TestHostContext hc = CreateTestContext())
88              {
89                  TaskOrchestrationPlanReference plan = new();
90                  TimelineReference timeline = new();
91                  Guid jobId = Guid.NewGuid();
92                  string jobName = "some job name";
93                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
94                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
95                  {
96                      Alias = Pipelines.PipelineConstants.SelfAlias,
97                      Id = "github",
98                      Version = "sha1"
99                  });
100                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
101                  jobRequest.Variables["ACTIONS_STEP_DEBUG"] = "true";
102                  var pagingLogger = new Mock<IPagingLogger>();
103                  var jobServerQueue = new Mock<IJobServerQueue>();
104                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
105                  jobServerQueue.Setup(x => x.QueueWebConsoleLine(It.IsAny<Guid>(), It.IsAny<string>(), It.IsAny<long>())).Callback((Guid id, string msg, long? lineNumber) => { hc.GetTrace().Info(msg); });
106                  hc.EnqueueInstance(pagingLogger.Object);
107                  hc.SetSingleton(jobServerQueue.Object);
108                  var ec = new Runner.Worker.ExecutionContext();
109                  ec.Initialize(hc);
110                  ec.InitializeJob(jobRequest, CancellationToken.None);
111                  foreach (var tc in new List<(TemplateToken token, TaskResult result, TaskResult? expectedResult, TaskResult? expectedOutcome)> {
112                  (token: new BooleanToken(null, null, null, true), result: TaskResult.Failed, expectedResult: TaskResult.Succeeded, expectedOutcome: TaskResult.Failed),
113                  (token: new BooleanToken(null, null, null, true), result: TaskResult.Succeeded, expectedResult: TaskResult.Succeeded, expectedOutcome: null),
114                  (token: new BooleanToken(null, null, null, true), result: TaskResult.Canceled, expectedResult: TaskResult.Canceled, expectedOutcome: null),
115                  (token: new BooleanToken(null, null, null, false), result: TaskResult.Failed, expectedResult: TaskResult.Failed, expectedOutcome: null),
116                  (token: new BooleanToken(null, null, null, false), result: TaskResult.Succeeded, expectedResult: TaskResult.Succeeded, expectedOutcome: null),
117                  (token: new BooleanToken(null, null, null, false), result: TaskResult.Canceled, expectedResult: TaskResult.Canceled, expectedOutcome: null),
118              })
119                  {
120                      ec.Result = tc.result;
121                      ec.Outcome = null;
122                      ec.ApplyContinueOnError(tc.token);
123                      Assert.Equal(ec.Result, tc.expectedResult);
124                      Assert.Equal(ec.Outcome, tc.expectedOutcome);
125                  }
126              }
127          }
128          [Fact]
129          [Trait("Level", "L0")]
130          [Trait("Category", "Worker")]
131          public void AddIssue_TrimMessageSize()
132          {
133              using (TestHostContext hc = CreateTestContext())
134              {
135                  TaskOrchestrationPlanReference plan = new();
136                  TimelineReference timeline = new();
137                  Guid jobId = Guid.NewGuid();
138                  string jobName = "some job name";
139                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
140                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
141                  {
142                      Alias = Pipelines.PipelineConstants.SelfAlias,
143                      Id = "github",
144                      Version = "sha1"
145                  });
146                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
147                  var pagingLogger = new Mock<IPagingLogger>();
148                  var jobServerQueue = new Mock<IJobServerQueue>();
149                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
150                  hc.EnqueueInstance(pagingLogger.Object);
151                  hc.SetSingleton(jobServerQueue.Object);
152                  var ec = new Runner.Worker.ExecutionContext();
153                  ec.Initialize(hc);
154                  ec.InitializeJob(jobRequest, CancellationToken.None);
155                  var bigMessage = "";
156                  for (var i = 0; i < 5000; i++)
157                  {
158                      bigMessage += "a";
159                  }
160                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = bigMessage }, ExecutionContextLogOptions.Default);
161                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = bigMessage }, ExecutionContextLogOptions.Default);
162                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = bigMessage }, ExecutionContextLogOptions.Default);
163                  ec.Complete();
164                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.Issues.Where(i => i.Type == IssueType.Error).Single().Message.Length <= 4096)), Times.AtLeastOnce);
165                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.Issues.Where(i => i.Type == IssueType.Warning).Single().Message.Length <= 4096)), Times.AtLeastOnce);
166                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.Issues.Where(i => i.Type == IssueType.Notice).Single().Message.Length <= 4096)), Times.AtLeastOnce);
167              }
168          }
169          [Fact]
170          [Trait("Level", "L0")]
171          [Trait("Category", "Worker")]
172          public void AddIssue_OverrideLogMessage()
173          {
174              using (TestHostContext hc = CreateTestContext())
175              {
176                  TaskOrchestrationPlanReference plan = new();
177                  TimelineReference timeline = new();
178                  Guid jobId = Guid.NewGuid();
179                  string jobName = "some job name";
180                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
181                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
182                  {
183                      Alias = Pipelines.PipelineConstants.SelfAlias,
184                      Id = "github",
185                      Version = "sha1"
186                  });
187                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
188                  var pagingLogger = new Mock<IPagingLogger>();
189                  var jobServerQueue = new Mock<IJobServerQueue>();
190                  hc.EnqueueInstance(pagingLogger.Object);
191                  hc.SetSingleton(jobServerQueue.Object);
192                  var ec = new Runner.Worker.ExecutionContext();
193                  ec.Initialize(hc);
194                  ec.InitializeJob(jobRequest, CancellationToken.None);
195                  var issueMessage = "Message embedded in issue.";
196                  var overrideMessage = "Message override.";
197                  var options = new ExecutionContextLogOptions(true, overrideMessage);
198                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = issueMessage }, options);
199                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = issueMessage }, options);
200                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = issueMessage }, options);
201                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = issueMessage }, ExecutionContextLogOptions.Default);
202                  ec.Complete();
203                  jobServerQueue.Verify(x => x.QueueWebConsoleLine(It.IsAny<Guid>(), It.IsAny<string>(), It.IsAny<long?>()), Times.Exactly(4));
204                  jobServerQueue.Verify(x => x.QueueWebConsoleLine(It.IsAny<Guid>(), It.Is<string>(text => text.EndsWith(overrideMessage)), It.IsAny<long?>()), Times.Exactly(3));
205                  jobServerQueue.Verify(x => x.QueueWebConsoleLine(It.IsAny<Guid>(), It.Is<string>(text => text.EndsWith(issueMessage)), It.IsAny<long?>()), Times.Exactly(1));
206              }
207          }
208          [Fact]
209          [Trait("Level", "L0")]
210          [Trait("Category", "Worker")]
211          public void AddIssue_AddStepAndLineNumberInformation()
212          {
213              using (TestHostContext hc = CreateTestContext())
214              {
215                  TaskOrchestrationPlanReference plan = new();
216                  TimelineReference timeline = new();
217                  Guid jobId = Guid.NewGuid();
218                  string jobName = "some job name";
219                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
220                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
221                  {
222                      Alias = Pipelines.PipelineConstants.SelfAlias,
223                      Id = "github",
224                      Version = "sha1"
225                  });
226                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
227                  var pagingLogger = new Mock<IPagingLogger>();
228                  var pagingLogger2 = new Mock<IPagingLogger>();
229                  var jobServerQueue = new Mock<IJobServerQueue>();
230                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
231                  hc.EnqueueInstance(pagingLogger.Object);
232                  hc.EnqueueInstance(pagingLogger2.Object);
233                  hc.SetSingleton(jobServerQueue.Object);
234                  var ec = new Runner.Worker.ExecutionContext();
235                  ec.Initialize(hc);
236                  ec.InitializeJob(jobRequest, CancellationToken.None);
237                  ec.Start();
238                  var embeddedStep = ec.CreateChild(Guid.NewGuid(), "action_1_pre", "action_1_pre", null, null, ActionRunStage.Main, isEmbedded: true);
239                  embeddedStep.Start();
240                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Error, Message = "error annotation that should have step and line number information" }, ExecutionContextLogOptions.Default);
241                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning annotation that should have step and line number information" }, ExecutionContextLogOptions.Default);
242                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Notice, Message = "notice annotation that should have step and line number information" }, ExecutionContextLogOptions.Default);
243                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()), Times.AtLeastOnce);
244                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.Issues.Where(i => i.Data.ContainsKey("stepNumber") && i.Data.ContainsKey("logFileLineNumber") && i.Type == IssueType.Error).Count() == 1)), Times.Never);
245                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.Issues.Where(i => i.Data.ContainsKey("stepNumber") && i.Data.ContainsKey("logFileLineNumber") && i.Type == IssueType.Warning).Count() == 1)), Times.Never);
246                  jobServerQueue.Verify(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.Is<TimelineRecord>(t => t.Issues.Where(i => i.Data.ContainsKey("stepNumber") && i.Data.ContainsKey("logFileLineNumber") && i.Type == IssueType.Notice).Count() == 1)), Times.Never);
247              }
248          }
249          [Fact]
250          [Trait("Level", "L0")]
251          [Trait("Category", "Worker")]
252          public void Debug_Multilines()
253          {
254              using (TestHostContext hc = CreateTestContext())
255              {
256                  TaskOrchestrationPlanReference plan = new();
257                  TimelineReference timeline = new();
258                  Guid jobId = Guid.NewGuid();
259                  string jobName = "some job name";
260                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
<span onclick='openModal()' class='match'>261                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
262                  {
263                      Alias = Pipelines.PipelineConstants.SelfAlias,
264                      Id = "github",
265                      Version = "sha1"
266                  });
267                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
</span>268                  jobRequest.Variables["ACTIONS_STEP_DEBUG"] = "true";
269                  var pagingLogger = new Mock<IPagingLogger>();
270                  var jobServerQueue = new Mock<IJobServerQueue>();
271                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
272                  jobServerQueue.Setup(x => x.QueueWebConsoleLine(It.IsAny<Guid>(), It.IsAny<string>(), It.IsAny<long>())).Callback((Guid id, string msg, long? lineNumber) => { hc.GetTrace().Info(msg); });
273                  hc.EnqueueInstance(pagingLogger.Object);
274                  hc.SetSingleton(jobServerQueue.Object);
275                  var ec = new Runner.Worker.ExecutionContext();
276                  ec.Initialize(hc);
277                  ec.InitializeJob(jobRequest, CancellationToken.None);
278                  ec.Debug(null);
279                  ec.Debug("");
280                  ec.Debug("\n");
281                  ec.Debug("\r\n");
282                  ec.Debug("test");
283                  ec.Debug("te\nst");
284                  ec.Debug("te\r\nst");
285                  ec.Complete();
286                  jobServerQueue.Verify(x => x.QueueWebConsoleLine(It.IsAny<Guid>(), It.IsAny<string>(), It.IsAny<long?>()), Times.Exactly(10));
287              }
288          }
289          [Fact]
290          [Trait("Level", "L0")]
291          [Trait("Category", "Worker")]
292          public void RegisterPostJobAction_ShareState()
293          {
294              using (TestHostContext hc = CreateTestContext())
295              {
296                  TaskOrchestrationPlanReference plan = new();
297                  TimelineReference timeline = new();
298                  Guid jobId = Guid.NewGuid();
299                  string jobName = "some job name";
300                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
301                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
302                  {
303                      Alias = Pipelines.PipelineConstants.SelfAlias,
304                      Id = "github",
305                      Version = "sha1"
306                  });
307                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
308                  jobRequest.Variables["ACTIONS_STEP_DEBUG"] = "true";
309                  var pagingLogger1 = new Mock<IPagingLogger>();
310                  var pagingLogger2 = new Mock<IPagingLogger>();
311                  var pagingLogger3 = new Mock<IPagingLogger>();
312                  var pagingLogger4 = new Mock<IPagingLogger>();
313                  var pagingLogger5 = new Mock<IPagingLogger>();
314                  var jobServerQueue = new Mock<IJobServerQueue>();
315                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
316                  jobServerQueue.Setup(x => x.QueueWebConsoleLine(It.IsAny<Guid>(), It.IsAny<string>(), It.IsAny<long?>())).Callback((Guid id, string msg, long? lineNumber) => { hc.GetTrace().Info(msg); });
317                  var actionRunner1 = new ActionRunner();
318                  actionRunner1.Initialize(hc);
319                  var actionRunner2 = new ActionRunner();
320                  actionRunner2.Initialize(hc);
321                  hc.EnqueueInstance(pagingLogger1.Object);
322                  hc.EnqueueInstance(pagingLogger2.Object);
323                  hc.EnqueueInstance(pagingLogger3.Object);
324                  hc.EnqueueInstance(pagingLogger4.Object);
325                  hc.EnqueueInstance(pagingLogger5.Object);
326                  hc.EnqueueInstance(actionRunner1 as IActionRunner);
327                  hc.EnqueueInstance(actionRunner2 as IActionRunner);
328                  hc.SetSingleton(jobServerQueue.Object);
329                  var jobContext = new Runner.Worker.ExecutionContext();
330                  jobContext.Initialize(hc);
331                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
332                  var action1 = jobContext.CreateChild(Guid.NewGuid(), "action_1", "action_1", null, null, 0);
333                  action1.IntraActionState["state"] = "1";
334                  var action2 = jobContext.CreateChild(Guid.NewGuid(), "action_2", "action_2", null, null, 0);
335                  action2.IntraActionState["state"] = "2";
336                  var postRunner1 = hc.CreateService<IActionRunner>();
337                  postRunner1.Action = new Pipelines.ActionStep() { Id = Guid.NewGuid(), Name = "post1", DisplayName = "Test 1", Reference = new Pipelines.RepositoryPathReference() { Name = "actions/action" } };
338                  postRunner1.Stage = ActionRunStage.Post;
339                  postRunner1.Condition = "always()";
340                  postRunner1.DisplayName = "post1";
341                  var postRunner2 = hc.CreateService<IActionRunner>();
342                  postRunner2.Action = new Pipelines.ActionStep() { Id = Guid.NewGuid(), Name = "post2", DisplayName = "Test 2", Reference = new Pipelines.RepositoryPathReference() { Name = "actions/action" } };
343                  postRunner2.Stage = ActionRunStage.Post;
344                  postRunner2.Condition = "always()";
345                  postRunner2.DisplayName = "post2";
346                  action1.RegisterPostJobStep(postRunner1);
347                  action2.RegisterPostJobStep(postRunner2);
348                  Assert.NotNull(jobContext.JobSteps);
349                  Assert.NotNull(jobContext.PostJobSteps);
350                  Assert.Null(action1.JobSteps);
351                  Assert.Null(action2.JobSteps);
352                  Assert.Null(action1.PostJobSteps);
353                  Assert.Null(action2.PostJobSteps);
354                  var post1 = jobContext.PostJobSteps.Pop();
355                  var post2 = jobContext.PostJobSteps.Pop();
356                  Assert.Equal("post2", (post1 as IActionRunner).Action.Name);
357                  Assert.Equal("post1", (post2 as IActionRunner).Action.Name);
358                  Assert.Equal(ActionRunStage.Post, (post1 as IActionRunner).Stage);
359                  Assert.Equal(ActionRunStage.Post, (post2 as IActionRunner).Stage);
360                  Assert.Equal("always()", (post1 as IActionRunner).Condition);
361                  Assert.Equal("always()", (post2 as IActionRunner).Condition);
362                  Assert.Equal("2", (post1 as IActionRunner).ExecutionContext.IntraActionState["state"]);
363                  Assert.Equal("1", (post2 as IActionRunner).ExecutionContext.IntraActionState["state"]);
364              }
365          }
366          [Fact]
367          [Trait("Level", "L0")]
368          [Trait("Category", "Worker")]
369          public void RegisterPostJobAction_NotRegisterPostTwice()
370          {
371              using (TestHostContext hc = CreateTestContext())
372              {
373                  TaskOrchestrationPlanReference plan = new();
374                  TimelineReference timeline = new();
375                  Guid jobId = Guid.NewGuid();
376                  string jobName = "some job name";
377                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
378                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
379                  {
380                      Alias = Pipelines.PipelineConstants.SelfAlias,
381                      Id = "github",
382                      Version = "sha1"
383                  });
384                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
385                  jobRequest.Variables["ACTIONS_STEP_DEBUG"] = "true";
386                  var pagingLogger1 = new Mock<IPagingLogger>();
387                  var pagingLogger2 = new Mock<IPagingLogger>();
388                  var pagingLogger3 = new Mock<IPagingLogger>();
389                  var pagingLogger4 = new Mock<IPagingLogger>();
390                  var pagingLogger5 = new Mock<IPagingLogger>();
391                  var jobServerQueue = new Mock<IJobServerQueue>();
392                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
393                  jobServerQueue.Setup(x => x.QueueWebConsoleLine(It.IsAny<Guid>(), It.IsAny<string>(), It.IsAny<long?>())).Callback((Guid id, string msg, long? lineNumber) => { hc.GetTrace().Info(msg); });
394                  var actionRunner1 = new ActionRunner();
395                  actionRunner1.Initialize(hc);
396                  var actionRunner2 = new ActionRunner();
397                  actionRunner2.Initialize(hc);
398                  hc.EnqueueInstance(pagingLogger1.Object);
399                  hc.EnqueueInstance(pagingLogger2.Object);
400                  hc.EnqueueInstance(pagingLogger3.Object);
401                  hc.EnqueueInstance(pagingLogger4.Object);
402                  hc.EnqueueInstance(pagingLogger5.Object);
403                  hc.EnqueueInstance(actionRunner1 as IActionRunner);
404                  hc.EnqueueInstance(actionRunner2 as IActionRunner);
405                  hc.SetSingleton(jobServerQueue.Object);
406                  var jobContext = new Runner.Worker.ExecutionContext();
407                  jobContext.Initialize(hc);
408                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
409                  var action1 = jobContext.CreateChild(Guid.NewGuid(), "action_1_pre", "action_1_pre", null, null, 0);
410                  var action2 = jobContext.CreateChild(Guid.NewGuid(), "action_1_main", "action_1_main", null, null, 0);
411                  var actionId = Guid.NewGuid();
412                  var postRunner1 = hc.CreateService<IActionRunner>();
413                  postRunner1.Action = new Pipelines.ActionStep() { Id = actionId, Name = "post1", DisplayName = "Test 1", Reference = new Pipelines.RepositoryPathReference() { Name = "actions/action" } };
414                  postRunner1.Stage = ActionRunStage.Post;
415                  postRunner1.Condition = "always()";
416                  postRunner1.DisplayName = "post1";
417                  var postRunner2 = hc.CreateService<IActionRunner>();
418                  postRunner2.Action = new Pipelines.ActionStep() { Id = actionId, Name = "post2", DisplayName = "Test 2", Reference = new Pipelines.RepositoryPathReference() { Name = "actions/action" } };
419                  postRunner2.Stage = ActionRunStage.Post;
420                  postRunner2.Condition = "always()";
421                  postRunner2.DisplayName = "post2";
422                  action1.RegisterPostJobStep(postRunner1);
423                  action2.RegisterPostJobStep(postRunner2);
424                  Assert.NotNull(jobContext.JobSteps);
425                  Assert.NotNull(jobContext.PostJobSteps);
426                  Assert.Equal(1, jobContext.PostJobSteps.Count);
427                  var post1 = jobContext.PostJobSteps.Pop();
428                  Assert.Equal("post1", (post1 as IActionRunner).Action.Name);
429                  Assert.Equal(ActionRunStage.Post, (post1 as IActionRunner).Stage);
430                  Assert.Equal("always()", (post1 as IActionRunner).Condition);
431              }
432          }
433          [Fact]
434          [Trait("Level", "L0")]
435          [Trait("Category", "Worker")]
436          public void ActionResult_Lowercase()
437          {
438              using (TestHostContext hc = CreateTestContext())
439              {
440                  TaskOrchestrationPlanReference plan = new();
441                  TimelineReference timeline = new();
442                  Guid jobId = Guid.NewGuid();
443                  string jobName = "some job name";
444                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
445                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
446                  {
447                      Alias = Pipelines.PipelineConstants.SelfAlias,
448                      Id = "github",
449                      Version = "sha1"
450                  });
451                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
452                  jobRequest.Variables["ACTIONS_STEP_DEBUG"] = "true";
453                  var pagingLogger1 = new Mock<IPagingLogger>();
454                  var jobServerQueue = new Mock<IJobServerQueue>();
455                  hc.EnqueueInstance(pagingLogger1.Object);
456                  hc.SetSingleton(jobServerQueue.Object);
457                  var jobContext = new Runner.Worker.ExecutionContext();
458                  jobContext.Initialize(hc);
459                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
460                  jobContext.Global.StepsContext.SetConclusion(null, "step1", ActionResult.Success);
461                  var conclusion1 = (jobContext.Global.StepsContext.GetScope(null)["step1"] as DictionaryContextData)["conclusion"].ToString();
462                  Assert.Equal(conclusion1, conclusion1.ToLowerInvariant());
463                  jobContext.Global.StepsContext.SetOutcome(null, "step2", ActionResult.Cancelled);
464                  var outcome1 = (jobContext.Global.StepsContext.GetScope(null)["step2"] as DictionaryContextData)["outcome"].ToString();
465                  Assert.Equal(outcome1, outcome1.ToLowerInvariant());
466                  jobContext.Global.StepsContext.SetConclusion(null, "step3", ActionResult.Failure);
467                  var conclusion2 = (jobContext.Global.StepsContext.GetScope(null)["step3"] as DictionaryContextData)["conclusion"].ToString();
468                  Assert.Equal(conclusion2, conclusion2.ToLowerInvariant());
469                  jobContext.Global.StepsContext.SetOutcome(null, "step4", ActionResult.Skipped);
470                  var outcome2 = (jobContext.Global.StepsContext.GetScope(null)["step4"] as DictionaryContextData)["outcome"].ToString();
471                  Assert.Equal(outcome2, outcome2.ToLowerInvariant());
472                  jobContext.JobContext.Status = ActionResult.Success;
473                  Assert.Equal(jobContext.JobContext["status"].ToString(), jobContext.JobContext["status"].ToString().ToLowerInvariant());
474              }
475          }
476          [Fact]
477          [Trait("Level", "L0")]
478          [Trait("Category", "Worker")]
479          public void PublishStepTelemetry_RegularStep_NoOpt()
480          {
481              using (TestHostContext hc = CreateTestContext())
482              {
483                  TaskOrchestrationPlanReference plan = new();
484                  TimelineReference timeline = new();
485                  Guid jobId = Guid.NewGuid();
486                  string jobName = "some job name";
487                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
488                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
489                  {
490                      Alias = Pipelines.PipelineConstants.SelfAlias,
491                      Id = "github",
492                      Version = "sha1"
493                  });
494                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
495                  var pagingLogger = new Mock<IPagingLogger>();
496                  var jobServerQueue = new Mock<IJobServerQueue>();
497                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
498                  hc.EnqueueInstance(pagingLogger.Object);
499                  hc.SetSingleton(jobServerQueue.Object);
500                  var ec = new Runner.Worker.ExecutionContext();
501                  ec.Initialize(hc);
502                  ec.InitializeJob(jobRequest, CancellationToken.None);
503                  ec.Start();
504                  ec.Complete();
505                  Assert.Equal(0, ec.Global.StepsTelemetry.Count);
506              }
507          }
508          [Fact]
509          [Trait("Level", "L0")]
510          [Trait("Category", "Worker")]
511          public void PublishStepTelemetry_RegularStep()
512          {
513              using (TestHostContext hc = CreateTestContext())
514              {
515                  TaskOrchestrationPlanReference plan = new();
516                  TimelineReference timeline = new();
517                  Guid jobId = Guid.NewGuid();
518                  string jobName = "some job name";
519                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
520                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
521                  {
522                      Alias = Pipelines.PipelineConstants.SelfAlias,
523                      Id = "github",
524                      Version = "sha1"
525                  });
526                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
527                  var pagingLogger = new Mock<IPagingLogger>();
528                  var jobServerQueue = new Mock<IJobServerQueue>();
529                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
530                  hc.EnqueueInstance(pagingLogger.Object);
531                  hc.SetSingleton(jobServerQueue.Object);
532                  var ec = new Runner.Worker.ExecutionContext();
533                  ec.Initialize(hc);
534                  ec.InitializeJob(jobRequest, CancellationToken.None);
535                  ec.Start();
536                  ec.StepTelemetry.Type = "node16";
537                  ec.StepTelemetry.Action = "actions/checkout";
538                  ec.StepTelemetry.Ref = "v2";
539                  ec.StepTelemetry.IsEmbedded = false;
540                  ec.StepTelemetry.StepId = Guid.NewGuid();
541                  ec.StepTelemetry.Stage = "main";
542                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
543                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
544                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = "notice" }, ExecutionContextLogOptions.Default);
545                  ec.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
546                  ec.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
547                  ec.AddIssue(new Issue() { Type = IssueType.Notice, Message = "notice" }, ExecutionContextLogOptions.Default);
548                  ec.Complete();
549                  Assert.Equal(1, ec.Global.StepsTelemetry.Count);
550                  Assert.Equal("node16", ec.Global.StepsTelemetry.Single().Type);
551                  Assert.Equal("actions/checkout", ec.Global.StepsTelemetry.Single().Action);
552                  Assert.Equal("v2", ec.Global.StepsTelemetry.Single().Ref);
553                  Assert.Equal(TaskResult.Succeeded, ec.Global.StepsTelemetry.Single().Result);
554                  Assert.NotNull(ec.Global.StepsTelemetry.Single().ExecutionTimeInSeconds);
555                  Assert.Equal(3, ec.Global.StepsTelemetry.Single().ErrorMessages.Count);
556                  Assert.DoesNotContain(ec.Global.StepsTelemetry.Single().ErrorMessages, x => x.Contains("notice"));
557              }
558          }
559          [Fact]
560          [Trait("Level", "L0")]
561          [Trait("Category", "Worker")]
562          public void PublishStepTelemetry_EmbeddedStep()
563          {
564              using (TestHostContext hc = CreateTestContext())
565              {
566                  TaskOrchestrationPlanReference plan = new();
567                  TimelineReference timeline = new();
568                  Guid jobId = Guid.NewGuid();
569                  string jobName = "some job name";
570                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
571                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
572                  {
573                      Alias = Pipelines.PipelineConstants.SelfAlias,
574                      Id = "github",
575                      Version = "sha1"
576                  });
577                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
578                  var pagingLogger = new Mock<IPagingLogger>();
579                  var pagingLogger2 = new Mock<IPagingLogger>();
580                  var jobServerQueue = new Mock<IJobServerQueue>();
581                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
582                  hc.EnqueueInstance(pagingLogger.Object);
583                  hc.EnqueueInstance(pagingLogger2.Object);
584                  hc.SetSingleton(jobServerQueue.Object);
585                  var ec = new Runner.Worker.ExecutionContext();
586                  ec.Initialize(hc);
587                  ec.InitializeJob(jobRequest, CancellationToken.None);
588                  ec.Start();
589                  var embeddedStep = ec.CreateChild(Guid.NewGuid(), "action_1_pre", "action_1_pre", null, null, ActionRunStage.Main, isEmbedded: true);
590                  embeddedStep.Start();
591                  embeddedStep.StepTelemetry.Type = "node16";
592                  embeddedStep.StepTelemetry.Action = "actions/checkout";
593                  embeddedStep.StepTelemetry.Ref = "v2";
594                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
595                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
596                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Notice, Message = "notice" }, ExecutionContextLogOptions.Default);
597                  embeddedStep.PublishStepTelemetry();
598                  Assert.Equal(1, ec.Global.StepsTelemetry.Count);
599                  Assert.Equal("node16", ec.Global.StepsTelemetry.Single().Type);
600                  Assert.Equal("actions/checkout", ec.Global.StepsTelemetry.Single().Action);
601                  Assert.Equal("v2", ec.Global.StepsTelemetry.Single().Ref);
602                  Assert.Equal(ActionRunStage.Main.ToString(), ec.Global.StepsTelemetry.Single().Stage);
603                  Assert.True(ec.Global.StepsTelemetry.Single().IsEmbedded);
604                  Assert.Null(ec.Global.StepsTelemetry.Single().Result);
605                  Assert.Null(ec.Global.StepsTelemetry.Single().ExecutionTimeInSeconds);
606                  Assert.Equal(0, ec.Global.StepsTelemetry.Single().ErrorMessages.Count);
607              }
608          }
609          [Fact]
610          [Trait("Level", "L0")]
611          [Trait("Category", "Worker")]
612          public void PublishStepResult_EmbeddedStep()
613          {
614              using (TestHostContext hc = CreateTestContext())
615              {
616                  TaskOrchestrationPlanReference plan = new();
617                  TimelineReference timeline = new();
618                  Guid jobId = Guid.NewGuid();
619                  string jobName = "some job name";
620                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
621                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
622                  {
623                      Alias = Pipelines.PipelineConstants.SelfAlias,
624                      Id = "github",
625                      Version = "sha1"
626                  });
627                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
628                  var pagingLogger = new Mock<IPagingLogger>();
629                  var pagingLogger2 = new Mock<IPagingLogger>();
630                  var jobServerQueue = new Mock<IJobServerQueue>();
631                  jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
632                  hc.EnqueueInstance(pagingLogger.Object);
633                  hc.EnqueueInstance(pagingLogger2.Object);
634                  hc.SetSingleton(jobServerQueue.Object);
635                  var ec = new Runner.Worker.ExecutionContext();
636                  ec.Initialize(hc);
637                  ec.InitializeJob(jobRequest, CancellationToken.None);
638                  ec.Start();
639                  var embeddedStep = ec.CreateChild(Guid.NewGuid(), "action_1_pre", "action_1_pre", null, null, ActionRunStage.Main, isEmbedded: true);
640                  embeddedStep.Start();
641                  embeddedStep.StepTelemetry.Type = "node16";
642                  embeddedStep.StepTelemetry.Action = "actions/checkout";
643                  embeddedStep.StepTelemetry.Ref = "v2";
644                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Error, Message = "error" }, ExecutionContextLogOptions.Default);
645                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Warning, Message = "warning" }, ExecutionContextLogOptions.Default);
646                  embeddedStep.AddIssue(new Issue() { Type = IssueType.Notice, Message = "notice" }, ExecutionContextLogOptions.Default);
647                  ec.Complete();
648                  Assert.Equal(1, ec.Global.StepsResult.Count);
649                  Assert.Equal(TaskResult.Succeeded, ec.Global.StepsResult.Single().Conclusion);
650              }
651          }
652          private TestHostContext CreateTestContext([CallerMemberName] String testName = "")
653          {
654              var hc = new TestHostContext(this, testName);
655              var configurationStore = new Mock<IConfigurationStore>();
656              configurationStore.Setup(x => x.GetSettings()).Returns(new RunnerSettings());
657              hc.SetSingleton(configurationStore.Object);
658              hc.SetSingleton(new Mock<IJobServerQueue>().Object);
659              return hc;
660          }
661          [Fact]
662          [Trait("Level", "L0")]
663          [Trait("Category", "Worker")]
664          public void GetExpressionValues_ContainerStepHost()
665          {
666              using (TestHostContext hc = CreateTestContext())
667              {
668                  const string source = "/home/username/Projects/work/runner/_layout";
669                  var containerInfo = new ContainerInfo();
670                  containerInfo.ContainerId = "test";
671                  containerInfo.AddPathTranslateMapping($"{source}/_work", "/__w");
672                  containerInfo.AddPathTranslateMapping($"{source}/_temp", "/__t");
673                  containerInfo.AddPathTranslateMapping($"{source}/externals", "/__e");
674                  containerInfo.AddPathTranslateMapping($"{source}/_work/_temp/_github_home", "/github/home");
675                  containerInfo.AddPathTranslateMapping($"{source}/_work/_temp/_github_workflow", "/github/workflow");
676                  foreach (var v in new List<string>() {
677                      $"{source}/_work",
678                      $"{source}/externals",
679                      $"{source}/_work/_temp",
680                      $"{source}/_work/_actions",
681                      $"{source}/_work/_tool",
682                  })
683                  {
684                      containerInfo.MountVolumes.Add(new MountVolume(v, containerInfo.TranslateToContainerPath(v)));
685                  };
686                  var stepHost = new ContainerStepHost();
687                  stepHost.Container = containerInfo;
688                  var ec = new Runner.Worker.ExecutionContext();
689                  ec.Initialize(hc);
690                  var inputGithubContext = new GitHubContext();
691                  var inputeRunnerContext = new RunnerContext();
692                  inputGithubContext["action_path"] = new StringContextData("/home/username/Projects/work/runner/_layout/_work/_actions/owner/composite/main");
693                  inputGithubContext["action"] = new StringContextData("__owner_composite");
694                  inputGithubContext["api_url"] = new StringContextData("https:&bsol;&bsol;api.github.com/custom/path");
695                  inputGithubContext["env"] = new StringContextData("/home/username/Projects/work/runner/_layout/_work/_temp/_runner_file_commands/set_env_265698aa-7f38-40f5-9316-5c01a3153672");
696                  inputGithubContext["path"] = new StringContextData("/home/username/Projects/work/runner/_layout/_work/_temp/_runner_file_commands/add_path_265698aa-7f38-40f5-9316-5c01a3153672");
697                  inputGithubContext["event_path"] = new StringContextData("/home/username/Projects/work/runner/_layout/_work/_temp/_github_workflow/event.json");
698                  inputGithubContext["repository"] = new StringContextData("owner/repo-name");
699                  inputGithubContext["run_id"] = new StringContextData("2033211332");
700                  inputGithubContext["workflow"] = new StringContextData("Name of Workflow");
701                  inputGithubContext["workspace"] = new StringContextData("/home/username/Projects/work/runner/_layout/_work/step-order/step-order");
702                  inputeRunnerContext["temp"] = new StringContextData("/home/username/Projects/work/runner/_layout/_work/_temp");
703                  inputeRunnerContext["tool_cache"] = new StringContextData("/home/username/Projects/work/runner/_layout/_work/_tool");
704                  var githubEvent = new DictionaryContextData();
705                  githubEvent["inputs"] = null;
706                  githubEvent["ref"] = new StringContextData("refs/heads/main");
707                  githubEvent["repository"] = new DictionaryContextData();
708                  githubEvent["sender"] = new DictionaryContextData();
709                  githubEvent["workflow"] = new StringContextData(".github/workflows/composite_step_host_translate.yaml");
710                  inputGithubContext["event"] = githubEvent;
711                  ec.ExpressionValues["github"] = inputGithubContext;
712                  ec.ExpressionValues["runner"] = inputeRunnerContext;
713                  var ecExpect = new Runner.Worker.ExecutionContext();
714                  ecExpect.Initialize(hc);
715                  var expectedGithubEvent = new DictionaryContextData();
716                  expectedGithubEvent["inputs"] = null;
717                  expectedGithubEvent["ref"] = new StringContextData("refs/heads/main");
718                  expectedGithubEvent["repository"] = new DictionaryContextData();
719                  expectedGithubEvent["sender"] = new DictionaryContextData();
720                  expectedGithubEvent["workflow"] = new StringContextData(".github/workflows/composite_step_host_translate.yaml");
721                  var expectedGithubContext = new GitHubContext();
722                  var expectedRunnerContext = new RunnerContext();
723                  expectedGithubContext["action_path"] = new StringContextData("/__w/_actions/owner/composite/main");
724                  expectedGithubContext["action"] = new StringContextData("__owner_composite");
725                  expectedGithubContext["api_url"] = new StringContextData("https:&bsol;&bsol;api.github.com/custom/path");
726                  expectedGithubContext["env"] = new StringContextData("/__w/_temp/_runner_file_commands/set_env_265698aa-7f38-40f5-9316-5c01a3153672");
727                  expectedGithubContext["path"] = new StringContextData("/__w/_temp/_runner_file_commands/add_path_265698aa-7f38-40f5-9316-5c01a3153672");
728                  expectedGithubContext["event_path"] = new StringContextData("/github/workflow/event.json");
729                  expectedGithubContext["repository"] = new StringContextData("owner/repo-name");
730                  expectedGithubContext["run_id"] = new StringContextData("2033211332");
731                  expectedGithubContext["workflow"] = new StringContextData("Name of Workflow");
732                  expectedGithubContext["workspace"] = new StringContextData("/__w/step-order/step-order");
733                  expectedGithubContext["event"] = expectedGithubEvent;
734                  expectedRunnerContext["temp"] = new StringContextData("/__w/_temp");
735                  expectedRunnerContext["tool_cache"] = new StringContextData("/__w/_tool");
736                  ecExpect.ExpressionValues["github"] = expectedGithubContext;
737                  ecExpect.ExpressionValues["runner"] = expectedRunnerContext;
738                  var translatedExpressionValues = ec.GetExpressionValues(stepHost);
739                  foreach (var contextName in new string[] { "github", "runner" })
740                  {
741                      var dict = translatedExpressionValues[contextName].AssertDictionary($"expected context github to be a dictionary");
742                      var expectedExpressionValues = ecExpect.ExpressionValues[contextName].AssertDictionary("expect dict");
743                      foreach (var key in dict.Keys.ToList())
744                      {
745                          if (dict[key] is StringContextData)
746                          {
747                              var expect = dict[key].AssertString("expect string");
748                              var outcome = expectedExpressionValues[key].AssertString("expect string");
749                              Assert.Equal(expect.Value, outcome.Value);
750                          }
751                          else if (dict[key] is DictionaryContextData || dict[key] is CaseSensitiveDictionaryContextData)
752                          {
753                              var expectDict = dict[key].AssertDictionary("expect dict");
754                              var actualDict = expectedExpressionValues[key].AssertDictionary("expect dict");
755                              Assert.True(ExpressionValuesAssertEqual(expectDict, actualDict));
756                          }
757                      }
758                  }
759              }
760          }
761          [Fact]
762          [Trait("Level", "L0")]
763          [Trait("Category", "Worker")]
764          public void ActionVariables_AddedToVarsContext()
765          {
766              using (TestHostContext hc = CreateTestContext())
767              {
768                  TaskOrchestrationPlanReference plan = new();
769                  TimelineReference timeline = new();
770                  Guid jobId = Guid.NewGuid();
771                  string jobName = "some job name";
772                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
773                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
774                  {
775                      Alias = Pipelines.PipelineConstants.SelfAlias,
776                      Id = "github",
777                      Version = "sha1"
778                  });
779                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
780                  var inputVarsContext = new DictionaryContextData();
781                  inputVarsContext["VARIABLE_1"] = new StringContextData("value1");
782                  inputVarsContext["VARIABLE_2"] = new StringContextData("value2");
783                  jobRequest.ContextData["vars"] = inputVarsContext;
784                  var pagingLogger1 = new Mock<IPagingLogger>();
785                  var jobServerQueue = new Mock<IJobServerQueue>();
786                  hc.EnqueueInstance(pagingLogger1.Object);
787                  hc.SetSingleton(jobServerQueue.Object);
788                  var jobContext = new Runner.Worker.ExecutionContext();
789                  jobContext.Initialize(hc);
790                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
791                  var expected = new DictionaryContextData();
792                  expected["VARIABLE_1"] = new StringContextData("value1");
793                  expected["VARIABLE_2"] = new StringContextData("value1");
794                  Assert.True(ExpressionValuesAssertEqual(expected, jobContext.ExpressionValues["vars"] as DictionaryContextData));
795              }
796          }
797          [Fact]
798          [Trait("Level", "L0")]
799          [Trait("Category", "Worker")]
800          public void ActionVariables_DebugUsingVars()
801          {
802              using (TestHostContext hc = CreateTestContext())
803              {
804                  TaskOrchestrationPlanReference plan = new TaskOrchestrationPlanReference();
805                  TimelineReference timeline = new TimelineReference();
806                  Guid jobId = Guid.NewGuid();
807                  string jobName = "some job name";
808                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
809                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
810                  {
811                      Alias = Pipelines.PipelineConstants.SelfAlias,
812                      Id = "github",
813                      Version = "sha1"
814                  });
815                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
816                  var inputVarsContext = new DictionaryContextData();
817                  inputVarsContext[Constants.Variables.Actions.StepDebug] = new StringContextData("true");
818                  inputVarsContext[Constants.Variables.Actions.RunnerDebug] = new StringContextData("true");
819                  jobRequest.ContextData["vars"] = inputVarsContext;
820                  var pagingLogger1 = new Mock<IPagingLogger>();
821                  var jobServerQueue = new Mock<IJobServerQueue>();
822                  hc.EnqueueInstance(pagingLogger1.Object);
823                  hc.SetSingleton(jobServerQueue.Object);
824                  var jobContext = new Runner.Worker.ExecutionContext();
825                  jobContext.Initialize(hc);
826                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
827                  Assert.Equal("true", jobContext.Global.Variables.Get(Constants.Variables.Actions.StepDebug));
828                  Assert.Equal("true", jobContext.Global.Variables.Get(Constants.Variables.Actions.RunnerDebug));
829              }
830          }
831          [Fact]
832          [Trait("Level", "L0")]
833          [Trait("Category", "Worker")]
834          public void ActionVariables_SecretsPrecedenceForDebugUsingVars()
835          {
836              using (TestHostContext hc = CreateTestContext())
837              {
838                  TaskOrchestrationPlanReference plan = new TaskOrchestrationPlanReference();
839                  TimelineReference timeline = new TimelineReference();
840                  Guid jobId = Guid.NewGuid();
841                  string jobName = "some job name";
842                  var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
843                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
844                  {
845                      Alias = Pipelines.PipelineConstants.SelfAlias,
846                      Id = "github",
847                      Version = "sha1"
848                  });
849                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
850                  var inputVarsContext = new DictionaryContextData();
851                  inputVarsContext[Constants.Variables.Actions.StepDebug] = new StringContextData("true");
852                  inputVarsContext[Constants.Variables.Actions.RunnerDebug] = new StringContextData("true");
853                  jobRequest.ContextData["vars"] = inputVarsContext;
854                  jobRequest.Variables[Constants.Variables.Actions.StepDebug] = "false";
855                  jobRequest.Variables[Constants.Variables.Actions.RunnerDebug] = "false";
856                  var pagingLogger1 = new Mock<IPagingLogger>();
857                  var jobServerQueue = new Mock<IJobServerQueue>();
858                  hc.EnqueueInstance(pagingLogger1.Object);
859                  hc.SetSingleton(jobServerQueue.Object);
860                  var jobContext = new Runner.Worker.ExecutionContext();
861                  jobContext.Initialize(hc);
862                  jobContext.InitializeJob(jobRequest, CancellationToken.None);
863                  Assert.Equal("false", jobContext.Global.Variables.Get(Constants.Variables.Actions.StepDebug));
864                  Assert.Equal("false", jobContext.Global.Variables.Get(Constants.Variables.Actions.RunnerDebug));
865              }
866          }
867          private bool ExpressionValuesAssertEqual(DictionaryContextData expect, DictionaryContextData actual)
868          {
869              foreach (var key in expect.Keys.ToList())
870              {
871                  if (expect[key] is StringContextData)
872                  {
873                      var expectValue = expect[key].AssertString("expect string");
874                      var actualValue = actual[key].AssertString("expect string");
875                      if (expectValue.Equals(actualValue))
876                      {
877                          return false;
878                      }
879                  }
880                  else if (expect[key] is DictionaryContextData || expect[key] is CaseSensitiveDictionaryContextData)
881                  {
882                      var expectDict = expect[key].AssertDictionary("expect dict");
883                      var actualDict = actual[key].AssertDictionary("expect dict");
884                      if (!ExpressionValuesAssertEqual(expectDict, actualDict))
885                      {
886                          return false;
887                      }
888                  }
889              }
890              return true;
891          }
892      }
893  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ExecutionContextL0.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-ExecutionContextL0.cs</div>
                </div>
                <div class="column column_space"><pre><code>843                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
844                  {
845                      Alias = Pipelines.PipelineConstants.SelfAlias,
846                      Id = "github",
847                      Version = "sha1"
848                  });
849                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
</pre></code></div>
                <div class="column column_space"><pre><code>261                  jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
262                  {
263                      Alias = Pipelines.PipelineConstants.SelfAlias,
264                      Id = "github",
265                      Version = "sha1"
266                  });
267                  jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    