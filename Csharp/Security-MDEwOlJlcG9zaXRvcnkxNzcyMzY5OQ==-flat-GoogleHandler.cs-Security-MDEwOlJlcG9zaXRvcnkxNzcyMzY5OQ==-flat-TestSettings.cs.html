
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 12, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-GoogleHandler.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Net.Http;
4  using System.Net.Http.Headers;
5  using System.Security.Claims;
6  using System.Text.Encodings.Web;
7  using System.Threading.Tasks;
8  using Microsoft.AspNetCore.Authentication.OAuth;
9  using Microsoft.AspNetCore.WebUtilities;
10  using Microsoft.Extensions.Logging;
11  using Microsoft.Extensions.Options;
12  using Newtonsoft.Json.Linq;
13  namespace Microsoft.AspNetCore.Authentication.Google
14  {
15      public class GoogleHandler : OAuthHandler<GoogleOptions>
16      {
17          public GoogleHandler(IOptionsMonitor<GoogleOptions> options, ILoggerFactory logger, UrlEncoder encoder, ISystemClock clock)
18              : base(options, logger, encoder, clock)
19          { }
20          protected override async Task<AuthenticationTicket> CreateTicketAsync(
21              ClaimsIdentity identity,
22              AuthenticationProperties properties,
23              OAuthTokenResponse tokens)
24          {
25              var request = new HttpRequestMessage(HttpMethod.Get, Options.UserInformationEndpoint);
26              request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", tokens.AccessToken);
27              var response = await Backchannel.SendAsync(request, Context.RequestAborted);
28              if (!response.IsSuccessStatusCode)
29              {
30                  throw new HttpRequestException($"An error occurred when retrieving Google user information ({response.StatusCode}). Please check if the authentication information is correct and the corresponding Google+ API is enabled.");
31              }
32              var payload = JObject.Parse(await response.Content.ReadAsStringAsync());
33              var context = new OAuthCreatingTicketContext(new ClaimsPrincipal(identity), properties, Context, Scheme, Options, Backchannel, tokens, payload);
34              context.RunClaimActions();
35              await Events.CreatingTicket(context);
36              return new AuthenticationTicket(context.Principal, context.Properties, Scheme.Name);
37          }
38          protected override string BuildChallengeUrl(AuthenticationProperties properties, string redirectUri)
39          {
40              var queryStrings = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
41              queryStrings.Add("response_type", "code");
42              queryStrings.Add("client_id", Options.ClientId);
43              queryStrings.Add("redirect_uri", redirectUri);
44              AddQueryString(queryStrings, properties, GoogleChallengeProperties.ScopeKey, FormatScope, Options.Scope);
45              AddQueryString(queryStrings, properties, GoogleChallengeProperties.AccessTypeKey, Options.AccessType);
46              AddQueryString(queryStrings, properties, GoogleChallengeProperties.ApprovalPromptKey);
47              AddQueryString(queryStrings, properties, GoogleChallengeProperties.PromptParameterKey);
48              AddQueryString(queryStrings, properties, GoogleChallengeProperties.LoginHintKey);
49              AddQueryString(queryStrings, properties, GoogleChallengeProperties.IncludeGrantedScopesKey, v => v?.ToString().ToLower(), (bool?)null);
50              var state = Options.StateDataFormat.Protect(properties);
51              queryStrings.Add("state", state);
52              var authorizationEndpoint = QueryHelpers.AddQueryString(Options.AuthorizationEndpoint, queryStrings);
53              return authorizationEndpoint;
54          }
55          private void AddQueryString<T>(
56              IDictionary<string, string> queryStrings,
57              AuthenticationProperties properties,
58              string name,
59              Func<T, string> formatter,
60              T defaultValue)
61          {
62              string value = null;
63              var parameterValue = properties.GetParameter<T>(name);
64              if (parameterValue != null)
65              {
66                  value = formatter(parameterValue);
67              }
68              else if (!properties.Items.TryGetValue(name, out value))
69              {
70                  value = formatter(defaultValue);
71              }
72              properties.Items.Remove(name);
73              if (value != null)
74              {
75                  queryStrings[name] = value;
76              }
77          }
<span onclick='openModal()' class='match'>78          private void AddQueryString(
79              IDictionary<string, string> queryStrings,
80              AuthenticationProperties properties,
</span>81              string name,
82              string defaultValue = null)
83              => AddQueryString(queryStrings, properties, name, x => x, defaultValue);
84      }
85  }
</code></pre>
        </div>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-TestSettings.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Diagnostics;
4  using System.IO;
5  using System.Linq;
6  using System.Net.Http;
7  using System.Reflection;
8  using System.Text;
9  using System.Text.Encodings.Web;
10  using System.Threading;
11  using System.Threading.Tasks;
12  using System.Xml.Linq;
13  using Microsoft.AspNetCore.Authentication.OpenIdConnect;
14  using Microsoft.AspNetCore.TestHost;
15  using Microsoft.IdentityModel.Protocols.OpenIdConnect;
16  using Xunit;
17  namespace Microsoft.AspNetCore.Authentication.Test.OpenIdConnect
18  {
19      internal class TestSettings
20      {
21          private readonly Action<OpenIdConnectOptions> _configureOptions;
22          private OpenIdConnectOptions _options;
23          public TestSettings() : this(configure: null)
24          {
25          }
26          public TestSettings(Action<OpenIdConnectOptions> configure)
27          {
28              _configureOptions = o =>
29              {
30                  configure?.Invoke(o);
31                  _options = o;
32                  _options.BackchannelHttpHandler = new MockBackchannel();
33              };
34          }
35          public UrlEncoder Encoder => UrlEncoder.Default;
36          public string ExpectedState { get; set; }
37          public TestServer CreateTestServer(AuthenticationProperties properties = null) => TestServerBuilder.CreateServer(_configureOptions, handler: null, properties: properties);
38          public IDictionary<string, string> ValidateChallengeFormPost(string responseBody, params string[] parametersToValidate)
39          {
40              IDictionary<string, string> formInputs = null;
41              var errors = new List<string>();
42              var xdoc = XDocument.Parse(responseBody.Replace("doctype", "DOCTYPE"));
43              var forms = xdoc.Descendants("form");
44              if (forms.Count() != 1)
45              {
46                  errors.Add("Only one form element is expected in response body.");
47              }
48              else
49              {
50                  formInputs = forms.Single()
51                                    .Elements("input")
52                                    .ToDictionary(elem => elem.Attribute("name").Value,
53                                                  elem => elem.Attribute("value").Value);
54                  ValidateParameters(formInputs, parametersToValidate, errors, htmlEncoded: false);
55              }
56              if (errors.Any())
57              {
58                  var buf = new StringBuilder();
59                  buf.AppendLine($"The challenge form post is not valid.");
60                  foreach (var error in errors)
61                  {
62                      buf.AppendLine(error);
63                  }
64                  Debug.WriteLine(buf.ToString());
65                  Assert.True(false, buf.ToString());
66              }
67              return formInputs;
68          }
69          public IDictionary<string, string> ValidateSignoutFormPost(TestTransaction transaction, params string[] parametersToValidate)
70          {
71              IDictionary<string, string> formInputs = null;
72              var errors = new List<string>();
73              var xdoc = XDocument.Parse(transaction.ResponseText.Replace("doctype", "DOCTYPE"));
74              var forms = xdoc.Descendants("form");
75              if (forms.Count() != 1)
76              {
77                  errors.Add("Only one form element is expected in response body.");
78              }
79              else
80              {
81                  formInputs = forms.Single()
82                                    .Elements("input")
83                                    .ToDictionary(elem => elem.Attribute("name").Value,
84                                                  elem => elem.Attribute("value").Value);
85                  ValidateParameters(formInputs, parametersToValidate, errors, htmlEncoded: false);
86              }
87              if (errors.Any())
88              {
89                  var buf = new StringBuilder();
90                  buf.AppendLine($"The signout form post is not valid.");
91                  foreach (var error in errors)
92                  {
93                      buf.AppendLine(error);
94                  }
95                  Debug.WriteLine(buf.ToString());
96                  Assert.True(false, buf.ToString());
97              }
98              return formInputs;
99          }
100          public IDictionary<string, string> ValidateChallengeRedirect(Uri redirectUri, params string[] parametersToValidate) =>
101              ValidateRedirectCore(redirectUri, OpenIdConnectRequestType.Authentication, parametersToValidate);
102          public IDictionary<string, string> ValidateSignoutRedirect(Uri redirectUri, params string[] parametersToValidate) =>
103              ValidateRedirectCore(redirectUri, OpenIdConnectRequestType.Logout, parametersToValidate);
104          private IDictionary<string, string> ValidateRedirectCore(Uri redirectUri, OpenIdConnectRequestType requestType, string[] parametersToValidate)
105          {
106              var errors = new List<string>();
107              ValidateExpectedAuthority(redirectUri.AbsoluteUri, errors, requestType);
108              var queryDict = string.IsNullOrEmpty(redirectUri.Query) ?
109                  new Dictionary<string, string>() :
110                  redirectUri.Query.TrimStart('?').Split('&').Select(part => part.Split('=')).ToDictionary(parts => parts[0], parts => parts[1]);
111              ValidateParameters(queryDict, parametersToValidate, errors, htmlEncoded: true);
112              if (errors.Any())
113              {
114                  var buf = new StringBuilder();
115                  buf.AppendLine($"The redirect uri is not valid.");
116                  buf.AppendLine(redirectUri.AbsoluteUri);
117                  foreach (var error in errors)
118                  {
119                      buf.AppendLine(error);
120                  }
121                  Debug.WriteLine(buf.ToString());
122                  Assert.True(false, buf.ToString());
123              }
124              return queryDict;
125          }
<span onclick='openModal()' class='match'>126          private void ValidateParameters(
127              IDictionary<string, string> actualValues,
128              IEnumerable<string> parametersToValidate,
</span>129              ICollection<string> errors,
130              bool htmlEncoded)
131          {
132              foreach (var paramToValidate in parametersToValidate)
133              {
134                  switch (paramToValidate)
135                  {
136                      case OpenIdConnectParameterNames.ClientId:
137                          ValidateClientId(actualValues, errors, htmlEncoded);
138                          break;
139                      case OpenIdConnectParameterNames.ResponseType:
140                          ValidateResponseType(actualValues, errors, htmlEncoded);
141                          break;
142                      case OpenIdConnectParameterNames.ResponseMode:
143                          ValidateResponseMode(actualValues, errors, htmlEncoded);
144                          break;
145                      case OpenIdConnectParameterNames.Scope:
146                          ValidateScope(actualValues, errors, htmlEncoded);
147                          break;
148                      case OpenIdConnectParameterNames.RedirectUri:
149                          ValidateRedirectUri(actualValues, errors, htmlEncoded);
150                          break;
151                      case OpenIdConnectParameterNames.Resource:
152                          ValidateResource(actualValues, errors, htmlEncoded);
153                          break;
154                      case OpenIdConnectParameterNames.State:
155                          ValidateState(actualValues, errors, htmlEncoded);
156                          break;
157                      case OpenIdConnectParameterNames.SkuTelemetry:
158                          ValidateSkuTelemetry(actualValues, errors);
159                          break;
160                      case OpenIdConnectParameterNames.VersionTelemetry:
161                          ValidateVersionTelemetry(actualValues, errors, htmlEncoded);
162                          break;
163                      case OpenIdConnectParameterNames.PostLogoutRedirectUri:
164                          ValidatePostLogoutRedirectUri(actualValues, errors, htmlEncoded);
165                          break;
166                      case OpenIdConnectParameterNames.MaxAge:
167                          ValidateMaxAge(actualValues, errors, htmlEncoded);
168                          break;
169                      case OpenIdConnectParameterNames.Prompt:
170                          ValidatePrompt(actualValues, errors, htmlEncoded);
171                          break;
172                      default:
173                          throw new InvalidOperationException($"Unknown parameter \"{paramToValidate}\".");
174                  }
175              }
176          }
177          private void ValidateExpectedAuthority(string absoluteUri, ICollection<string> errors, OpenIdConnectRequestType requestType)
178          {
179              string expectedAuthority;
180              switch (requestType)
181              {
182                  case OpenIdConnectRequestType.Token:
183                      expectedAuthority = _options.Configuration?.TokenEndpoint ?? _options.Authority + @"/oauth2/token";
184                      break;
185                  case OpenIdConnectRequestType.Logout:
186                      expectedAuthority = _options.Configuration?.EndSessionEndpoint ?? _options.Authority + @"/oauth2/logout";
187                      break;
188                  default:
189                      expectedAuthority = _options.Configuration?.AuthorizationEndpoint ?? _options.Authority + @"/oauth2/authorize";
190                      break;
191              }
192              if (!absoluteUri.StartsWith(expectedAuthority))
193              {
194                  errors.Add($"ExpectedAuthority: {expectedAuthority}");
195              }
196          }
197          private void ValidateClientId(IDictionary<string, string> actualParams, ICollection<string> errors, bool htmlEncoded) =>
198              ValidateParameter(OpenIdConnectParameterNames.ClientId, _options.ClientId, actualParams, errors, htmlEncoded);
199          private void ValidateResponseType(IDictionary<string, string> actualParams, ICollection<string> errors, bool htmlEncoded) =>
200              ValidateParameter(OpenIdConnectParameterNames.ResponseType, _options.ResponseType, actualParams, errors, htmlEncoded);
201          private void ValidateResponseMode(IDictionary<string, string> actualParams, ICollection<string> errors, bool htmlEncoded) =>
202              ValidateParameter(OpenIdConnectParameterNames.ResponseMode, _options.ResponseMode, actualParams, errors, htmlEncoded);
203          private void ValidateScope(IDictionary<string, string> actualParams, ICollection<string> errors, bool htmlEncoded) =>
204              ValidateParameter(OpenIdConnectParameterNames.Scope, string.Join(" ", _options.Scope), actualParams, errors, htmlEncoded);
205          private void ValidateRedirectUri(IDictionary<string, string> actualParams, ICollection<string> errors, bool htmlEncoded) =>
206              ValidateParameter(OpenIdConnectParameterNames.RedirectUri, TestServerBuilder.TestHost + _options.CallbackPath, actualParams, errors, htmlEncoded);
207          private void ValidateResource(IDictionary<string, string> actualParams, ICollection<string> errors, bool htmlEncoded) =>
208              ValidateParameter(OpenIdConnectParameterNames.RedirectUri, _options.Resource, actualParams, errors, htmlEncoded);
209          private void ValidateState(IDictionary<string, string> actualParams, ICollection<string> errors, bool htmlEncoded) =>
210              ValidateParameter(OpenIdConnectParameterNames.State, ExpectedState, actualParams, errors, htmlEncoded);
211          private static void ValidateSkuTelemetry(IDictionary<string, string> actualParams, ICollection<string> errors)
212          {
213              if (!actualParams.ContainsKey(OpenIdConnectParameterNames.SkuTelemetry))
214              {
215                  errors.Add($"Parameter {OpenIdConnectParameterNames.SkuTelemetry} is missing");
216              }
217          }
218          private void ValidateVersionTelemetry(IDictionary<string, string> actualParams, ICollection<string> errors, bool htmlEncoded) =>
219              ValidateParameter(OpenIdConnectParameterNames.VersionTelemetry, typeof(OpenIdConnectMessage).GetTypeInfo().Assembly.GetName().Version.ToString(), actualParams, errors, htmlEncoded);
220          private void ValidatePostLogoutRedirectUri(IDictionary<string, string> actualParams, ICollection<string> errors, bool htmlEncoded) =>
221              ValidateParameter(OpenIdConnectParameterNames.PostLogoutRedirectUri, "https:&bsol;&bsol;example.com/signout-callback-oidc", actualParams, errors, htmlEncoded);
222          private void ValidateMaxAge(IDictionary<string, string> actualQuery, ICollection<string> errors, bool htmlEncoded)
223          {
224              if(_options.MaxAge.HasValue)
225              {
226                  Assert.Equal(TimeSpan.FromMinutes(20), _options.MaxAge.Value);
227                  string expectedMaxAge = "1200";
228                  ValidateParameter(OpenIdConnectParameterNames.MaxAge, expectedMaxAge, actualQuery, errors, htmlEncoded);
229              }
230              else if(actualQuery.ContainsKey(OpenIdConnectParameterNames.MaxAge))
231              {
232                  errors.Add($"Parameter {OpenIdConnectParameterNames.MaxAge} is present but it should be absent");
233              }
234          }
235          private void ValidatePrompt(IDictionary<string, string> actualParams, ICollection<string> errors, bool htmlEncoded) =>
236              ValidateParameter(OpenIdConnectParameterNames.Prompt, _options.Prompt, actualParams, errors, htmlEncoded);
237          private void ValidateParameter(
238              string parameterName,
239              string expectedValue,
240              IDictionary<string, string> actualParams,
241              ICollection<string> errors,
242              bool htmlEncoded)
243          {
244              string actualValue;
245              if (actualParams.TryGetValue(parameterName, out actualValue))
246              {
247                  if (htmlEncoded)
248                  {
249                      expectedValue = Encoder.Encode(expectedValue);
250                  }
251                  if (actualValue != expectedValue)
252                  {
253                      errors.Add($"Parameter {parameterName}'s expected value is '{expectedValue}' but its actual value is '{actualValue}'");
254                  }
255              }
256              else
257              {
258                  errors.Add($"Parameter {parameterName} is missing");
259              }
260          }
261          private class MockBackchannel : HttpMessageHandler
262          {
263              protected override async Task<HttpResponseMessage> SendAsync(HttpRequestMessage request, CancellationToken cancellationToken)
264              {
265                  if (request.RequestUri.AbsoluteUri.Equals("https:&bsol;&bsol;login.microsoftonline.com/common/.well-known/openid-configuration"))
266                  {
267                      return await ReturnResource("wellknownconfig.json");
268                  }
269                  if (request.RequestUri.AbsoluteUri.Equals("https:&bsol;&bsol;login.microsoftonline.com/common/discovery/keys"))
270                  {
271                      return await ReturnResource("wellknownkeys.json");
272                  }
273                  throw new NotImplementedException();
274              }
275              private async Task<HttpResponseMessage> ReturnResource(string resource)
276              {
277                  var resourceName = "Microsoft.AspNetCore.Authentication.Test.OpenIdConnect." + resource;
278                  using (var stream = typeof(MockBackchannel).Assembly.GetManifestResourceStream(resourceName))
279                  using (var reader = new StreamReader(stream))
280                  {
281                      var body = await reader.ReadToEndAsync();
282                      var content = new StringContent(body, Encoding.UTF8, "application/json");
283                      return new HttpResponseMessage()
284                      {
285                          Content = content,
286                      };
287                  }
288              }
289          }
290      }
291  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-GoogleHandler.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-TestSettings.cs</div>
                </div>
                <div class="column column_space"><pre><code>78          private void AddQueryString(
79              IDictionary<string, string> queryStrings,
80              AuthenticationProperties properties,
</pre></code></div>
                <div class="column column_space"><pre><code>126          private void ValidateParameters(
127              IDictionary<string, string> actualValues,
128              IEnumerable<string> parametersToValidate,
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    