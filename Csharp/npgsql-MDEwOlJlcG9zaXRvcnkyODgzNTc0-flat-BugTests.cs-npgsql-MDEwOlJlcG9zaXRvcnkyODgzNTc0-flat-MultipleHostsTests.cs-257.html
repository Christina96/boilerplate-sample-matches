
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 13, <button onclick='openModal()' class='match'>CODE CLONE</button></h2>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-BugTests.cs</h3>
            <pre><code>1  using Npgsql.BackendMessages;
2  using Npgsql.Tests.Support;
3  using Npgsql.TypeMapping;
4  using NpgsqlTypes;
5  using NUnit.Framework;
6  using System;
7  using System.Data;
8  using System.Text;
9  using System.Threading;
10  using System.Threading.Tasks;
11  using System.Transactions;
12  using static Npgsql.Tests.TestUtil;
13  namespace Npgsql.Tests;
14  public class BugTests : TestBase
15  {
16      #region Sequential reader bugs
17      [Test, Description(&quot;In sequential access, performing a null check on a non-first field would check the first field&quot;)]
18      public void SequentialNullCheckOnNonFirstField()
19      {
20          using var conn = OpenConnection();
21          using var cmd = new NpgsqlCommand(&quot;SELECT &#x27;X&#x27;, NULL&quot;, conn);
22          using var dr = cmd.ExecuteReader(CommandBehavior.SequentialAccess);
23          dr.Read();
24          Assert.That(dr.IsDBNull(1), Is.True);
25      }
26      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/1034&quot;)]
27      public void SequentialSkipOverFirstRow()
28      {
29          using var conn = OpenConnection();
30          using var cmd = new NpgsqlCommand(&quot;SELECT 1; SELECT 2&quot;, conn);
31          using var reader = cmd.ExecuteReader(CommandBehavior.SequentialAccess);
32          Assert.That(reader.NextResult(), Is.True);
33          Assert.That(reader.Read(), Is.True);
34          Assert.That(reader.GetInt32(0), Is.EqualTo(2));
35      }
36      [Test]
37      public void SequentialConsumeWithNull()
38      {
39          using var conn = OpenConnection();
40          using var command = new NpgsqlCommand(&quot;SELECT 1, NULL&quot;, conn);
41          using var reader = command.ExecuteReader(CommandBehavior.SequentialAccess);
42          reader.Read();
43      }
44      #endregion
45      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/1210&quot;)]
46      public void Many_parameters_with_mixed_FormatCode()
47      {
48          using var conn = OpenConnection();
49          using var cmd = new NpgsqlCommand();
50          cmd.Connection = conn;
51          var sb = new StringBuilder(&quot;SELECT @text_param&quot;);
52          cmd.Parameters.AddWithValue(&quot;@text_param&quot;, &quot;some_text&quot;);
53          for (var i = 0; i &lt; conn.Settings.WriteBufferSize; i++)
54          {
55              var paramName = $&quot;@binary_param{i}&quot;;
56              sb.Append(&#x27;,&#x27;);
57              sb.Append(paramName);
58              cmd.Parameters.AddWithValue(paramName, 8);
59          }
60          cmd.CommandText = sb.ToString();
61          var ex = Assert.Throws&lt;PostgresException&gt;(() =&gt; cmd.ExecuteNonQuery())!;
62          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.ProgramLimitExceeded)
63              .Or.EqualTo(PostgresErrorCodes.TooManyColumns)); 
64      }
65      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/1238&quot;)]
66      public void Record_with_non_int_field()
67      {
68          using var conn = OpenConnection();
69          using var cmd = new NpgsqlCommand(&quot;SELECT (&#x27;one&#x27;::TEXT, 2)&quot;, conn);
70          using var reader = cmd.ExecuteReader();
71          reader.Read();
72          var record = reader.GetFieldValue&lt;object[]&gt;(0);
73          Assert.That(record[0], Is.EqualTo(&quot;one&quot;));
74          Assert.That(record[1], Is.EqualTo(2));
75      }
76      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/1450&quot;)]
77      public void Bug1450()
78      {
79          using var conn = OpenConnection();
80          using var cmd = new NpgsqlCommand();
81          cmd.Connection = conn;
82          cmd.CommandText = &quot;CREATE TEMP TABLE a (a1 int); CREATE TEMP TABLE b (b1 int);&quot;;
83          cmd.ExecuteNonQuery();
84          cmd.CommandText = &quot;CREATE TEMP TABLE c (c1 int);&quot;;
85          cmd.ExecuteNonQuery();
86      }
87      [Test]
88      public async Task Bug1645()
89      {
90          await using var conn = await OpenConnectionAsync();
91          var tableName = await CreateTempTable(conn, &quot;field_text TEXT, field_int2 SMALLINT, field_int4 INTEGER&quot;);
92          Assert.That(() =&gt;
93              {
94                  using var writer = conn.BeginBinaryImport($&quot;COPY {tableName} (field_text, field_int4) FROM STDIN BINARY&quot;);
95                  writer.StartRow();
96                  writer.Write(&quot;foo&quot;);
97                  writer.Write(8);
98                  writer.StartRow();
99                  throw new InvalidOperationException(&quot;Catch me outside the using statement if you can!&quot;);
100              }, Throws.Exception
101                  .TypeOf&lt;InvalidOperationException&gt;()
102                  .With.Property(nameof(InvalidOperationException.Message)).EqualTo(&quot;Catch me outside the using statement if you can!&quot;)
103          );
104          Assert.That(await conn.ExecuteScalarAsync($&quot;SELECT COUNT(*) FROM {tableName}&quot;), Is.Zero);
105      }
106      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/3600&quot;)]
107      public async Task Bug3600()
108      {
109          var csb = new NpgsqlConnectionStringBuilder(ConnectionString)
110          {
111              CommandTimeout = 1,
112          };
113          await using var postmasterMock = PgPostmasterMock.Start(csb.ConnectionString);
114          await using var dataSource = CreateDataSource(postmasterMock.ConnectionString);
115          await using var conn = await dataSource.OpenConnectionAsync();
116          var serverMock = await postmasterMock.WaitForServerConnection();
117          await serverMock
118              .WriteCopyInResponse()
119              .FlushAsync();
120          var ex = Assert.ThrowsAsync&lt;NpgsqlException&gt;(async () =&gt;
121          {
122              await using var importer = await conn.BeginTextImportAsync($&quot;COPY SomeTable (field_text, field_int4) FROM STDIN&quot;);
123          });
124          Assert.That(ex!.InnerException, Is.TypeOf&lt;TimeoutException&gt;());
125      }
126      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/1497&quot;)]
127      public async Task Bug1497()
128      {
129          await using var conn = await OpenConnectionAsync();
130          var tableName = await CreateTempTable(conn, &quot;id INT4&quot;);
131          conn.ExecuteNonQuery($&quot;INSERT INTO {tableName} (id) VALUES (NULL)&quot;);
132          await using var cmd = new NpgsqlCommand($&quot;SELECT * FROM {tableName}&quot;, conn);
133          await using var reader = await cmd.ExecuteReaderAsync();
134          var dt = new DataTable();
135          dt.Load(reader);
136      }
137      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/1558&quot;)]
138      public void Bug1558()
139      {
140          using var dataSource = CreateDataSource(csb =&gt;
141          {
142              csb.Pooling = false;
143              csb.Enlist = true;
144          });
145          using var tx = new TransactionScope();
146          using var conn = dataSource.OpenConnection();
147      }
148      [Test]
149      public void Bug1695()
150      {
151          using var dataSource = CreateDataSource(csb =&gt;
152          {
153              csb.Pooling = false;
154              csb.MaxAutoPrepare = 10;
155              csb.AutoPrepareMinUsages = 1;
156          });
157          using var conn = dataSource.OpenConnection();
158          using (var cmd = new NpgsqlCommand(&quot;SELECT 1; SELECT 2&quot;, conn))
159          using (var reader = cmd.ExecuteReader())
160          {
161              reader.Read();
162          }
163          Assert.That(conn.ExecuteScalar(&quot;SELECT 2&quot;), Is.EqualTo(2));
164      }
165      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/1700&quot;)]
166      public void Bug1700()
167      {
168          Assert.That(() =&gt;
169          {
170              using var conn = OpenConnection();
171              using var tx = conn.BeginTransaction();
172              using var cmd = conn.CreateCommand();
173              cmd.CommandText = &quot;SELECT 1&quot;;
174              var reader = cmd.ExecuteReader();
175              while (reader.Read())
176              {
177                  throw new InvalidOperationException(&quot;Some problem parsing the returned data&quot;);
178              }
179              tx.Commit();
180          }, Throws.InvalidOperationException.With.Message.EqualTo(&quot;Some problem parsing the returned data&quot;));
181      }
182      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/1964&quot;)]
183      public void Bug1964()
184      {
185          using var conn = OpenConnection();
186          using var cmd = new NpgsqlCommand(&quot;INVALID SQL&quot;, conn);
187          cmd.Parameters.Add(new NpgsqlParameter { ParameterName = &quot;p&quot;, Direction = ParameterDirection.Output });
188          Assert.That(() =&gt; cmd.ExecuteNonQuery(), Throws.Exception.TypeOf&lt;PostgresException&gt;()
189              .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.SyntaxError));
190      }
191      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/1986&quot;)]
192      public void Bug1986()
193      {
194          using var conn = OpenConnection();
195          using var cmd = new NpgsqlCommand(&quot;SELECT &#x27;hello&#x27;, &#x27;goodbye&#x27;&quot;, conn);
196          using var reader = cmd.ExecuteReader();
197          reader.Read();
198          using (var textReader1 = reader.GetTextReader(0))
199          {
200          }
201          using (var textReader2 = reader.GetTextReader(1))
202          {
203          }
204      }
205      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/1987&quot;)]
206      public async Task Bug1987()
207      {
208          await using var adminConnection = await OpenConnectionAsync();
209          var type = await GetTempTypeName(adminConnection);
210          await adminConnection.ExecuteNonQueryAsync($&quot;CREATE TYPE {type} AS ENUM (&#x27;sad&#x27;, &#x27;ok&#x27;, &#x27;happy&#x27;)&quot;);
211          var dataSourceBuilder = CreateDataSourceBuilder();
212          dataSourceBuilder.MapEnum&lt;Mood&gt;(type);
213          await using var dataSource = dataSourceBuilder.Build();
214          await using var connection = await dataSource.OpenConnectionAsync();
215          for (var i = 0; i &lt; 2; i++)
216          {
217              await using var cmd = new NpgsqlCommand(&quot;SELECT @p&quot;, connection);
218              cmd.Parameters.AddWithValue(&quot;p&quot;, Mood.Happy);
219              Assert.That(await cmd.ExecuteScalarAsync(), Is.EqualTo(Mood.Happy));
220          }
221      }
222      enum Mood { Sad, Ok, Happy };
223      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2003&quot;)]
224      public void Bug2003()
225      {
226          using var conn = OpenConnection();
227          var longFieldName = new string(&#x27;x&#x27;, conn.Settings.ReadBufferSize);
228          using var cmd = new NpgsqlCommand($&quot;SELECT 8 AS {longFieldName}&quot;, conn);
229          using var reader = cmd.ExecuteReader(CommandBehavior.SequentialAccess);
230          reader.Read();
231          Assert.That(reader.GetInt32(0), Is.EqualTo(8));
232      }
233      [Test]
234      public async Task Bug2046()
235      {
236          var expected = 64.27245f;
237          using var conn = OpenConnection();
238          using var cmd = new NpgsqlCommand(&quot;SELECT @p = 64.27245::real, 64.27245::real, @p&quot;, conn);
239          cmd.Parameters.AddWithValue(&quot;p&quot;, expected);
240          using var rdr = await cmd.ExecuteReaderAsync();
241          rdr.Read();
242          Assert.That(rdr.GetFieldValue&lt;bool&gt;(0));
243          Assert.That(rdr.GetFieldValue&lt;float&gt;(1), Is.EqualTo(expected));
244          Assert.That(rdr.GetFieldValue&lt;float&gt;(2), Is.EqualTo(expected));
245      }
246      [Test]
247      public void Bug1761()
248      {
249          using var dataSource = CreateDataSource(csb =&gt;
250          {
251              csb.Enlist = true;
252              csb.Pooling = true;
253              csb.MinPoolSize = 1;
254              csb.MaxPoolSize = 1;
255          });
256          for (var i = 0; i &lt; 2; i++)
257          {
258              try
259              {
260                  using var scope = new TransactionScope(TransactionScopeOption.Required, TimeSpan.FromMilliseconds(100));
261                  Thread.Sleep(1000);
262                  using (var connection = dataSource.OpenConnection())
263                  using (var cmd = new NpgsqlCommand(&quot;SELECT 1&quot;, connection))
264                  {
265                      cmd.CommandText = &quot;select 1;&quot;;
266                      cmd.ExecuteNonQuery();
267                  }
268                  scope.Complete();
269              }
270              catch (TransactionException)
271              {
272              }
273          }
274      }
275      [Test]
276      public void Bug2274()
277      {
278          using var conn = OpenConnection();
279          using var cmd = new NpgsqlCommand(&quot;SELECT 1&quot;, conn);
280          cmd.Parameters.Add(new NpgsqlParameter
281          {
282              ParameterName = &quot;p&quot;,
283              Direction = ParameterDirection.Output
284          });
285          using var reader = cmd.ExecuteReader(CommandBehavior.SingleRow);
286          Assert.That(() =&gt; reader.GetInt32(0), Throws.Exception.TypeOf&lt;InvalidOperationException&gt;());
287          Assert.That(reader.Read(), Is.True);
288          Assert.That(reader.GetInt32(0), Is.EqualTo(1));
289          Assert.That(reader.Read(), Is.False);
290      }
291      [Test]
292      public async Task Bug2278()
293      {
294          await using var adminConnection = await OpenConnectionAsync();
295          var enumType = await GetTempTypeName(adminConnection);
296          var domainType = await GetTempTypeName(adminConnection);
297          var compositeType = await GetTempTypeName(adminConnection);
298          await adminConnection.ExecuteNonQueryAsync($@&quot;
299  CREATE TYPE {enumType} AS ENUM (&#x27;left&#x27;, &#x27;right&#x27;);
300  CREATE DOMAIN {domainType} AS {enumType} NOT NULL;
301  CREATE TYPE {compositeType} AS (value {domainType})&quot;);
302          var table = await CreateTempTable(adminConnection, $&quot;value {compositeType}&quot;);
303          var dataSourceBuilder = CreateDataSourceBuilder();
304          dataSourceBuilder.MapComposite&lt;Bug2278CompositeType&gt;(compositeType);
305          dataSourceBuilder.MapEnum&lt;Bug2278EnumType&gt;(enumType);
306          await using var dataSource = dataSourceBuilder.Build();
307          await using var connection = await dataSource.OpenConnectionAsync();
308          await connection.ExecuteScalarAsync($&quot;SELECT * FROM {table} AS d&quot;);
309      }
310      class Bug2278CompositeType
311      {
312          public Bug2278EnumType Value { get; set; }
313      }
314      enum Bug2278EnumType
315      {
316          Left,
317          Right
318      }
319      [Test]
320      [IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2178&quot;)]
321      public async Task Bug2178()
322      {
323          await using var dataSource = CreateDataSource(csb =&gt;
324          {
325              csb.AutoPrepareMinUsages = 2;
326              csb.MaxAutoPrepare = 2;
327          });
328          await using var conn = await dataSource.OpenConnectionAsync();
329          await using var cmd = new NpgsqlCommand();
330          cmd.Connection = conn;
<span onclick='openModal()' class='match'>331          cmd.CommandText = &quot;SELECT 1&quot;;
332          await cmd.ExecuteScalarAsync();
333          await cmd.ExecuteScalarAsync();
</span>334          Assert.That(cmd.IsPrepared);
335          cmd.CommandText = &quot;SELECT * FROM public.dummy_table_name&quot;;
336          for (var i = 0; i &lt; 3; ++i)
337          {
338              Assert.ThrowsAsync&lt;PostgresException&gt;(async () =&gt; await cmd.ExecuteScalarAsync());
339          }
340          cmd.CommandText = &quot;SELECT 1&quot;;
341          await cmd.ExecuteScalarAsync();
342          Assert.That(cmd.IsPrepared);
343      }
344      [Test]
345      public async Task Bug2296()
346      {
347          await using var conn = await OpenConnectionAsync();
348          await conn.ExecuteNonQueryAsync(&quot;DROP TYPE IF EXISTS \&quot;boolean\&quot; CASCADE&quot;);
349          await conn.ExecuteNonQueryAsync(&quot;CREATE DOMAIN pg_temp.\&quot;boolean\&quot; AS bool&quot;);
350          conn.ReloadTypes();
351          var tableName = await CreateTempTable(conn, $&quot;mybool \&quot;boolean\&quot;&quot;);
352          await conn.ExecuteNonQueryAsync($&quot;INSERT INTO {tableName} (mybool) VALUES (TRUE)&quot;);
353          await conn.ExecuteScalarAsync($&quot;SELECT mybool FROM {tableName}&quot;);
354      }
355      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2660&quot;)]
356      public void Standard_conforming_strings()
357      {
358          using var conn = OpenConnection();
359          var sql = @&quot;
360  SELECT table_name
361  FROM information_schema.views
362  WHERE table_name LIKE @p0 escape &#x27;\&#x27; AND (is_updatable = &#x27;NO&#x27;) = @p1&quot;;
363          using var cmd = new NpgsqlCommand(sql, conn);
364          cmd.Parameters.AddWithValue(&quot;@p0&quot;, &quot;%trig%&quot;);
365          cmd.Parameters.AddWithValue(&quot;@p1&quot;, true);
366          using var reader = cmd.ExecuteReader();
367          reader.Read();
368      }
369      #region Bug1285
370      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/1285&quot;)]
371      public void Bug1285()
372      {
373          using var conn = OpenConnection();
374          using var cmd = new NpgsqlCommand { Connection = conn };
375          cmd.CommandText = Bug1285CreateStatement;
376          cmd.ExecuteNonQuery();
377          cmd.CommandText = Bug1285SelectStatement;
378          cmd.Parameters.Add(new NpgsqlParameter(&quot;@1&quot;, Guid.NewGuid()));
379          cmd.ExecuteNonQuery();
380      }
381      const string Bug1285SelectStatement =
382          &quot;select &quot; +
383          &quot; \&quot;Afbeelding\&quot;&quot; +
384          &quot;, \&quot;Afbeelding#Id\&quot;&quot; +
385          &quot;, \&quot;Omschrijving\&quot;&quot; +
386          &quot;, \&quot;Website\&quot;&quot; +
387          &quot;, \&quot;EMailadres\&quot;&quot; +
388          &quot;, \&quot;SocialMediaVastleggen\&quot;&quot; +
389          &quot;, \&quot;Facebook\&quot;&quot; +
390          &quot;, \&quot;Linkedin\&quot;&quot; +
391          &quot;, \&quot;Twitter\&quot;&quot; +
392          &quot;, \&quot;Youtube\&quot;&quot; +
393          &quot;, \&quot;Branche\&quot;&quot; +
394          &quot;, \&quot;Branche#Id\&quot;&quot; +
395          &quot;, \&quot;Branche#ComponentId\&quot;&quot; +
396          &quot;, \&quot;Telefoonnummer\&quot;&quot; +
397          &quot;, \&quot;Overheidsidentificatienummer\&quot;&quot; +
398          &quot;, \&quot;Adres\&quot;&quot; +
399          &quot;, \&quot;Adres#Id\&quot;&quot; +
400          &quot;, \&quot;Adres#ComponentId\&quot;&quot; +
401          &quot;, \&quot;2gIKz62kaTdGxw82_OrzTc4ANSM_\&quot;&quot; +
402          &quot;, \&quot;OnderdeelVanOrganisatie\&quot;&quot; +
403          &quot;, \&quot;OnderdeelVanOrganisatie#Id\&quot;&quot; +
404          &quot;, \&quot;OnderdeelVanOrganisatie#ComponentId\&quot;&quot; +
405          &quot;, \&quot;Profit\&quot;&quot; +
406          &quot;, \&quot;Profit#Id\&quot;&quot; +
407          &quot;, \&quot;Profit#ComponentId\&quot;&quot; +
408          &quot;, \&quot;Taal\&quot;&quot; +
409          &quot;, \&quot;Taal#Id\&quot;&quot; +
410          &quot;, \&quot;Taal#ComponentId\&quot;&quot; +
411          &quot;, \&quot;KlantSinds\&quot;&quot; +
412          &quot;, \&quot;BarcodeKlant\&quot;&quot; +
413          &quot;, \&quot;BarcodeKlant#BarcodeType\&quot;&quot; +
414          &quot;, \&quot;BarcodeKlant#Value\&quot;&quot; +
415          &quot;, \&quot;Postadres\&quot;&quot; +
416          &quot;, \&quot;Postadres#Id\&quot;&quot; +
417          &quot;, \&quot;Postadres#ComponentId\&quot;&quot; +
418          &quot;, \&quot;LeverancierSinds\&quot;&quot; +
419          &quot;, \&quot;BarcodeLeverancier\&quot;&quot; +
420          &quot;, \&quot;BarcodeLeverancier#BarcodeType\&quot;&quot; +
421          &quot;, \&quot;BarcodeLeverancier#Value\&quot;&quot; +
422          &quot;, \&quot;Zoeknaam\&quot;&quot; +
423          &quot;, \&quot;TitelEnAanhef\&quot;&quot; +
424          &quot;, \&quot;TitelEnAanhef#Id\&quot;&quot; +
425          &quot;, \&quot;TitelEnAanhef#ComponentId\&quot;&quot; +
426          &quot;, \&quot;Rechtsvorm\&quot;&quot; +
427          &quot;, \&quot;Rechtsvorm#Id\&quot;&quot; +
428          &quot;, \&quot;Rechtsvorm#ComponentId\&quot;&quot; +
429          &quot;, \&quot;LandVanVestiging\&quot;&quot; +
430          &quot;, \&quot;LandVanVestiging#Id\&quot;&quot; +
431          &quot;, \&quot;LandVanVestiging#ComponentId\&quot;&quot; +
432          &quot;, \&quot;AantalMedewerkers\&quot;&quot; +
433          &quot;, \&quot;NaamStatutair\&quot;&quot; +
434          &quot;, \&quot;VestigingStatutair\&quot;&quot; +
435          &quot;, \&quot;Correspondentie\&quot;&quot; +
436          &quot;, \&quot;Medium\&quot;&quot; +
437          &quot;, \&quot;FiscaalNummer\&quot;&quot; +
438          &quot;, \&quot;AangebrachtDoor\&quot;&quot; +
439          &quot;, \&quot;AangebrachtDoor#Id\&quot;&quot; +
440          &quot;, \&quot;AangebrachtDoor#ComponentId\&quot;&quot; +
441          &quot;, \&quot;Status\&quot;&quot; +
442          &quot;, \&quot;NummerKamerVanKoophandel\&quot;&quot; +
443          &quot;, \&quot;zII9SOHbwUPS_jKSlcRrQzuEr6A_\&quot;&quot; +
444          &quot;, \&quot;Code\&quot;&quot; +
445          &quot;, \&quot;OrganisatorischeEenheid\&quot;&quot; +
446          &quot;, \&quot;OrganisatorischeEenheid#Id\&quot;&quot; +
447          &quot;, \&quot;OrganisatorischeEenheid#ComponentId\&quot;&quot; +
448          &quot;, \&quot;PJlr3asVdeHVoqmAyHIF2fF1gVM_\&quot;&quot; +
449          &quot;, \&quot;IsUwv\&quot;&quot; +
450          &quot;, \&quot;Uwv\&quot;&quot; +
451          &quot;, \&quot;Uwv#Id\&quot;&quot; +
452          &quot;, \&quot;Uwv#ComponentId\&quot;&quot; +
453          &quot;, \&quot;IsVerzekeraarVoorWerkgever\&quot;&quot; +
454          &quot;, \&quot;VerzekeraarVoorWerkgever\&quot;&quot; +
455          &quot;, \&quot;VerzekeraarVoorWerkgever#Id\&quot;&quot; +
456          &quot;, \&quot;VerzekeraarVoorWerkgever#ComponentId\&quot;&quot; +
457          &quot;, \&quot;IsAbonnementsadministratie\&quot;&quot; +
458          &quot;, \&quot;Abonnementsadministratie\&quot;&quot; +
459          &quot;, \&quot;Abonnementsadministratie#Id\&quot;&quot; +
460          &quot;, \&quot;Abonnementsadministratie#ComponentId\&quot;&quot; +
461          &quot;, \&quot;IsPensioenfonds\&quot;&quot; +
462          &quot;, \&quot;Pensioenfonds\&quot;&quot; +
463          &quot;, \&quot;Pensioenfonds#Id\&quot;&quot; +
464          &quot;, \&quot;Pensioenfonds#ComponentId\&quot;&quot; +
465          &quot;, \&quot;IsProfit\&quot;&quot; +
466          &quot;, \&quot;Profit1\&quot;&quot; +
467          &quot;, \&quot;Profit1#Id\&quot;&quot; +
468          &quot;, \&quot;Profit1#ComponentId\&quot;&quot; +
469          &quot;, \&quot;Verantwoordelijke\&quot;&quot; +
470          &quot;, \&quot;Verantwoordelijke#Id\&quot;&quot; +
471          &quot;, \&quot;Verantwoordelijke#ComponentId\&quot;&quot; +
472          &quot;, \&quot;IsKlant\&quot;&quot; +
473          &quot;, \&quot;Klant\&quot;&quot; +
474          &quot;, \&quot;Klant#Id\&quot;&quot; +
475          &quot;, \&quot;Klant#ComponentId\&quot;&quot; +
476          &quot;, \&quot;IsFactureringsadministratie\&quot;&quot; +
477          &quot;, \&quot;Factureringsadministratie\&quot;&quot; +
478          &quot;, \&quot;Factureringsadministratie#Id\&quot;&quot; +
479          &quot;, \&quot;Factureringsadministratie#ComponentId\&quot;&quot; +
480          &quot;, \&quot;IsLeninggever\&quot;&quot; +
481          &quot;, \&quot;Leninggever\&quot;&quot; +
482          &quot;, \&quot;Leninggever#Id\&quot;&quot; +
483          &quot;, \&quot;Leninggever#ComponentId\&quot;&quot; +
484          &quot;, \&quot;IsProjectadministratie\&quot;&quot; +
485          &quot;, \&quot;Projectadministratie\&quot;&quot; +
486          &quot;, \&quot;Projectadministratie#Id\&quot;&quot; +
487          &quot;, \&quot;Projectadministratie#ComponentId\&quot;&quot; +
488          &quot;, \&quot;IsVervangingsfonds\&quot;&quot; +
489          &quot;, \&quot;Vervangingsfonds\&quot;&quot; +
490          &quot;, \&quot;Vervangingsfonds#Id\&quot;&quot; +
491          &quot;, \&quot;Vervangingsfonds#ComponentId\&quot;&quot; +
492          &quot;, \&quot;IsPensioen\&quot;&quot; +
493          &quot;, \&quot;Pensioen\&quot;&quot; +
494          &quot;, \&quot;Pensioen#Id\&quot;&quot; +
495          &quot;, \&quot;Pensioen#ComponentId\&quot;&quot; +
496          &quot;, \&quot;IsVasteActivaAdministratie\&quot;&quot; +
497          &quot;, \&quot;VasteActivaAdministratie\&quot;&quot; +
498          &quot;, \&quot;VasteActivaAdministratie#Id\&quot;&quot; +
499          &quot;, \&quot;VasteActivaAdministratie#ComponentId\&quot;&quot; +
500          &quot;, \&quot;IsBelastingdienst\&quot;&quot; +
501          &quot;, \&quot;Belastingdienst\&quot;&quot; +
502          &quot;, \&quot;Belastingdienst#Id\&quot;&quot; +
503          &quot;, \&quot;Belastingdienst#ComponentId\&quot;&quot; +
504          &quot;, \&quot;IsCursusadministratie\&quot;&quot; +
505          &quot;, \&quot;Cursusadministratie\&quot;&quot; +
506          &quot;, \&quot;Cursusadministratie#Id\&quot;&quot; +
507          &quot;, \&quot;Cursusadministratie#ComponentId\&quot;&quot; +
508          &quot;, \&quot;IsUitvoerderVervangingsfonds\&quot;&quot; +
509          &quot;, \&quot;UitvoerderVervangingsfonds\&quot;&quot; +
510          &quot;, \&quot;UitvoerderVervangingsfonds#Id\&quot;&quot; +
511          &quot;, \&quot;UitvoerderVervangingsfonds#ComponentId\&quot;&quot; +
512          &quot;, \&quot;IsAssemblageadministratie\&quot;&quot; +
513          &quot;, \&quot;Assemblageadministratie\&quot;&quot; +
514          &quot;, \&quot;Assemblageadministratie#Id\&quot;&quot; +
515          &quot;, \&quot;Assemblageadministratie#ComponentId\&quot;&quot; +
516          &quot;, \&quot;IsLeasemaatschappij\&quot;&quot; +
517          &quot;, \&quot;Leasemaatschappij\&quot;&quot; +
518          &quot;, \&quot;Leasemaatschappij#Id\&quot;&quot; +
519          &quot;, \&quot;Leasemaatschappij#ComponentId\&quot;&quot; +
520          &quot;, \&quot;IsBeslaglegger\&quot;&quot; +
521          &quot;, \&quot;Beslaglegger\&quot;&quot; +
522          &quot;, \&quot;Beslaglegger#Id\&quot;&quot; +
523          &quot;, \&quot;Beslaglegger#ComponentId\&quot;&quot; +
524          &quot;, \&quot;IsVerzekeraarVoorMedewerker\&quot;&quot; +
525          &quot;, \&quot;VerzekeraarVoorMedewerker\&quot;&quot; +
526          &quot;, \&quot;VerzekeraarVoorMedewerker#Id\&quot;&quot; +
527          &quot;, \&quot;VerzekeraarVoorMedewerker#ComponentId\&quot;&quot; +
528          &quot;, \&quot;IsWoningverhuur\&quot;&quot; +
529          &quot;, \&quot;Woningverhuur\&quot;&quot; +
530          &quot;, \&quot;Woningverhuur#Id\&quot;&quot; +
531          &quot;, \&quot;Woningverhuur#ComponentId\&quot;&quot; +
532          &quot;, \&quot;9cSTu7fkjOZm08FFQUHvclQHSWY_\&quot;&quot; +
533          &quot;, \&quot;Goederenstroomadministratie\&quot;&quot; +
534          &quot;, \&quot;Goederenstroomadministratie#Id\&quot;&quot; +
535          &quot;, \&quot;Goederenstroomadministratie#ComponentId\&quot;&quot; +
536          &quot;, \&quot;IsConcurrent\&quot;&quot; +
537          &quot;, \&quot;Concurrent\&quot;&quot; +
538          &quot;, \&quot;Concurrent#Id\&quot;&quot; +
539          &quot;, \&quot;Concurrent#ComponentId\&quot;&quot; +
540          &quot;, \&quot;IsArbodienst\&quot;&quot; +
541          &quot;, \&quot;Arbodienst\&quot;&quot; +
542          &quot;, \&quot;Arbodienst#Id\&quot;&quot; +
543          &quot;, \&quot;Arbodienst#ComponentId\&quot;&quot; +
544          &quot;, \&quot;IsUitvoerderSociaalFonds\&quot;&quot; +
545          &quot;, \&quot;UitvoerderSociaalFonds\&quot;&quot; +
546          &quot;, \&quot;UitvoerderSociaalFonds#Id\&quot;&quot; +
547          &quot;, \&quot;UitvoerderSociaalFonds#ComponentId\&quot;&quot; +
548          &quot;, \&quot;IsPensioenuitvoerder\&quot;&quot; +
549          &quot;, \&quot;Pensioenuitvoerder\&quot;&quot; +
550          &quot;, \&quot;Pensioenuitvoerder#Id\&quot;&quot; +
551          &quot;, \&quot;Pensioenuitvoerder#ComponentId\&quot;&quot; +
552          &quot;, \&quot;IsProspect\&quot;&quot; +
553          &quot;, \&quot;Prospect\&quot;&quot; +
554          &quot;, \&quot;Prospect#Id\&quot;&quot; +
555          &quot;, \&quot;Prospect#ComponentId\&quot;&quot; +
556          &quot;, \&quot;IsProspectadministratie\&quot;&quot; +
557          &quot;, \&quot;Prospectadministratie\&quot;&quot; +
558          &quot;, \&quot;Prospectadministratie#Id\&quot;&quot; +
559          &quot;, \&quot;Prospectadministratie#ComponentId\&quot;&quot; +
560          &quot;, \&quot;IsArtikelbeheeradministratie\&quot;&quot; +
561          &quot;, \&quot;Artikelbeheeradministratie\&quot;&quot; +
562          &quot;, \&quot;Artikelbeheeradministratie#Id\&quot;&quot; +
563          &quot;, \&quot;Artikelbeheeradministratie#ComponentId\&quot;&quot; +
564          &quot;, \&quot;v1J4Rq2eNZy9GBvGhuCBKqga0Rg_\&quot;&quot; +
565          &quot;, \&quot;g4i3gYZGL0yu0T6UwmiZTaUDI8Y_\&quot;&quot; +
566          &quot;, \&quot;g4i3gYZGL0yu0T6UwmiZTaUDI8Y_#Id\&quot;&quot; +
567          &quot;, \&quot;g4i3gYZGL0yu0T6UwmiZTaUDI8Y_#ComponentId\&quot;&quot; +
568          &quot;, \&quot;IsSociaalFonds\&quot;&quot; +
569          &quot;, \&quot;SociaalFonds\&quot;&quot; +
570          &quot;, \&quot;SociaalFonds#Id\&quot;&quot; +
571          &quot;, \&quot;SociaalFonds#ComponentId\&quot;&quot; +
572          &quot;, \&quot;IsWagenparkadministratie\&quot;&quot; +
573          &quot;, \&quot;Wagenparkadministratie\&quot;&quot; +
574          &quot;, \&quot;Wagenparkadministratie#Id\&quot;&quot; +
575          &quot;, \&quot;Wagenparkadministratie#ComponentId\&quot;&quot; +
576          &quot;, \&quot;IsLeverancier\&quot;&quot; +
577          &quot;, \&quot;Leverancier\&quot;&quot; +
578          &quot;, \&quot;Leverancier#Id\&quot;&quot; +
579          &quot;, \&quot;Leverancier#ComponentId\&quot;&quot; +
580          &quot;, \&quot;IsWagenparkAfnemer\&quot;&quot; +
581          &quot;, \&quot;WagenparkAfnemer\&quot;&quot; +
582          &quot;, \&quot;WagenparkAfnemer#Id\&quot;&quot; +
583          &quot;, \&quot;WagenparkAfnemer#ComponentId\&quot;&quot; +
584          &quot;, \&quot;IsEvenementadministratie\&quot;&quot; +
585          &quot;, \&quot;Evenementadministratie\&quot;&quot; +
586          &quot;, \&quot;Evenementadministratie#Id\&quot;&quot; +
587          &quot;, \&quot;Evenementadministratie#ComponentId\&quot;&quot; +
588          &quot;, \&quot;IsCrediteur\&quot;&quot; +
589          &quot;, \&quot;Crediteur\&quot;&quot; +
590          &quot;, \&quot;Crediteur#Id\&quot;&quot; +
591          &quot;, \&quot;Crediteur#ComponentId\&quot;&quot; +
592          &quot;, \&quot;IsFinancieleAdministratie\&quot;&quot; +
593          &quot;, \&quot;FinancieleAdministratie\&quot;&quot; +
594          &quot;, \&quot;FinancieleAdministratie#Id\&quot;&quot; +
595          &quot;, \&quot;FinancieleAdministratie#ComponentId\&quot;&quot; +
596          &quot;, \&quot;IsSociaalSecretariaat\&quot;&quot; +
597          &quot;, \&quot;SociaalSecretariaat\&quot;&quot; +
598          &quot;, \&quot;SociaalSecretariaat#Id\&quot;&quot; +
599          &quot;, \&quot;SociaalSecretariaat#ComponentId\&quot;&quot; +
600          &quot;, \&quot;IsBank\&quot;&quot; +
601          &quot;, \&quot;Bank\&quot;&quot; +
602          &quot;, \&quot;Bank#Id\&quot;&quot; +
603          &quot;, \&quot;Bank#ComponentId\&quot;&quot; +
604          &quot;, \&quot;IsWerkgever\&quot;&quot; +
605          &quot;, \&quot;Werkgever\&quot;&quot; +
606          &quot;, \&quot;Werkgever#Id\&quot;&quot; +
607          &quot;, \&quot;Werkgever#ComponentId\&quot;&quot; +
608          &quot;, \&quot;IsVerkoopadministratie\&quot;&quot; +
609          &quot;, \&quot;Verkoopadministratie\&quot;&quot; +
610          &quot;, \&quot;Verkoopadministratie#Id\&quot;&quot; +
611          &quot;, \&quot;Verkoopadministratie#ComponentId\&quot;&quot; +
612          &quot;, \&quot;IsInkoopadministratie\&quot;&quot; +
613          &quot;, \&quot;Inkoopadministratie\&quot;&quot; +
614          &quot;, \&quot;Inkoopadministratie#Id\&quot;&quot; +
615          &quot;, \&quot;Inkoopadministratie#ComponentId\&quot;&quot; +
616          &quot;, \&quot;IsSubsidient\&quot;&quot; +
617          &quot;, \&quot;Subsidient\&quot;&quot; +
618          &quot;, \&quot;Subsidient#Id\&quot;&quot; +
619          &quot;, \&quot;Subsidient#ComponentId\&quot;&quot; +
620          &quot;, \&quot;IsEnqueteadministratie\&quot;&quot; +
621          &quot;, \&quot;Enqueteadministratie\&quot;&quot; +
622          &quot;, \&quot;Enqueteadministratie#Id\&quot;&quot; +
623          &quot;, \&quot;Enqueteadministratie#ComponentId\&quot;&quot; +
624          &quot;, \&quot;XWiQaVjEbD041r7QN0kj2aKeCys_\&quot;&quot; +
625          &quot;, \&quot;X_TVE5FRBaQ97JJQbT7LmX4HBVY_\&quot;&quot; +
626          &quot;, \&quot;BrancheDescription\&quot;&quot; +
627          &quot;, \&quot;AdresDescription\&quot;&quot; +
628          &quot;, \&quot;PicMWY7oCqeiZMTdDqwFqi1U508_\&quot;&quot; +
629          &quot;, \&quot;ProfitDescription\&quot;&quot; +
630          &quot;, \&quot;TaalDescription\&quot;&quot; +
631          &quot;, \&quot;PostadresDescription\&quot;&quot; +
632          &quot;, \&quot;TitelEnAanhefDescription\&quot;&quot; +
633          &quot;, \&quot;RechtsvormDescription\&quot;&quot; +
634          &quot;, \&quot;LandVanVestigingDescription\&quot;&quot; +
635          &quot;, \&quot;AangebrachtDoorDescription\&quot;&quot; +
636          &quot;, \&quot;KFEDo6ZYK_ffNCeHuujBCshlPVs_\&quot;&quot; +
637          &quot;, \&quot;VerantwoordelijkeDescription\&quot;&quot; +
638          &quot;, \&quot;FunctionalState\&quot;&quot; +
639          &quot;, \&quot;KlantFinancieleAdministratie\&quot;&quot; +
640          &quot;, \&quot;KlantFinancieleAdministratie#Id\&quot;&quot; +
641          &quot;, \&quot;KlantFinancieleAdministratie#ComponentId\&quot;&quot; +
642          &quot;, \&quot;KlantVerkoopadministratie\&quot;&quot; +
643          &quot;, \&quot;KlantVerkoopadministratie#Id\&quot;&quot; +
644          &quot;, \&quot;KlantVerkoopadministratie#ComponentId\&quot;&quot; +
645          &quot;, \&quot;NQwaM_lfzxIm_JPrPhwruL0YOXY_\&quot;&quot; +
646          &quot;, \&quot;NQwaM_lfzxIm_JPrPhwruL0YOXY_#Id\&quot;&quot; +
647          &quot;, \&quot;NQwaM_lfzxIm_JPrPhwruL0YOXY_#ComponentId\&quot;&quot; +
648          &quot;, \&quot;uSf1yseW4YQ1K6EoHNlzCxPofm0_\&quot;&quot; +
649          &quot;, \&quot;uSf1yseW4YQ1K6EoHNlzCxPofm0_#Id\&quot;&quot; +
650          &quot;, \&quot;uSf1yseW4YQ1K6EoHNlzCxPofm0_#ComponentId\&quot;&quot; +
651          &quot;, \&quot;KlantEvenementadministratie\&quot;&quot; +
652          &quot;, \&quot;KlantEvenementadministratie#Id\&quot;&quot; +
653          &quot;, \&quot;KlantEvenementadministratie#ComponentId\&quot;&quot; +
654          &quot;, \&quot;KlantCursusadministratie\&quot;&quot; +
655          &quot;, \&quot;KlantCursusadministratie#Id\&quot;&quot; +
656          &quot;, \&quot;KlantCursusadministratie#ComponentId\&quot;&quot; +
657          &quot;, \&quot;KlantProspectadministratie\&quot;&quot; +
658          &quot;, \&quot;KlantProspectadministratie#Id\&quot;&quot; +
659          &quot;, \&quot;KlantProspectadministratie#ComponentId\&quot;&quot; +
660          &quot;, \&quot;KlantInkoopadministratie\&quot;&quot; +
661          &quot;, \&quot;KlantInkoopadministratie#Id\&quot;&quot; +
662          &quot;, \&quot;KlantInkoopadministratie#ComponentId\&quot;&quot; +
663          &quot;, \&quot;KlantProjectadministratie\&quot;&quot; +
664          &quot;, \&quot;KlantProjectadministratie#Id\&quot;&quot; +
665          &quot;, \&quot;KlantProjectadministratie#ComponentId\&quot;&quot; +
666          &quot;, \&quot;P0gBTGcrSbl2kK8BM4_24fIeMvk_\&quot;&quot; +
667          &quot;, \&quot;P0gBTGcrSbl2kK8BM4_24fIeMvk_#Id\&quot;&quot; +
668          &quot;, \&quot;P0gBTGcrSbl2kK8BM4_24fIeMvk_#ComponentId\&quot;&quot; +
669          &quot;, \&quot;KlantMain\&quot;&quot; +
670          &quot;, \&quot;KlantMain#Id\&quot;&quot; +
671          &quot;, \&quot;KlantMain#ComponentId\&quot;&quot; +
672          &quot;, \&quot;8awXARDcCdVtrvN6IRlwAk5UcrI_\&quot;&quot; +
673          &quot;, \&quot;8awXARDcCdVtrvN6IRlwAk5UcrI_#Id\&quot;&quot; +
674          &quot;, \&quot;8awXARDcCdVtrvN6IRlwAk5UcrI_#ComponentId\&quot;&quot; +
675          &quot;, \&quot;MjgFAhRfH64O3M9Ts_5b0ENQDBE_\&quot;&quot; +
676          &quot;, \&quot;MjgFAhRfH64O3M9Ts_5b0ENQDBE_#Id\&quot;&quot; +
677          &quot;, \&quot;MjgFAhRfH64O3M9Ts_5b0ENQDBE_#ComponentId\&quot;&quot; +
678          &quot;, \&quot;LeverancierMain\&quot;&quot; +
679          &quot;, \&quot;LeverancierMain#Id\&quot;&quot; +
680          &quot;, \&quot;LeverancierMain#ComponentId\&quot;&quot; +
681          &quot;, \&quot;2CaNQvGgtPNHP2XCsoKBQEpwmYA_\&quot;&quot; +
682          &quot;, \&quot;2CaNQvGgtPNHP2XCsoKBQEpwmYA_#Id\&quot;&quot; +
683          &quot;, \&quot;2CaNQvGgtPNHP2XCsoKBQEpwmYA_#ComponentId\&quot;&quot; +
684          &quot;, \&quot;kleo39GG1utTUtP0F15mWkXZBFQ_\&quot;&quot; +
685          &quot;, \&quot;kleo39GG1utTUtP0F15mWkXZBFQ_#Id\&quot;&quot; +
686          &quot;, \&quot;kleo39GG1utTUtP0F15mWkXZBFQ_#ComponentId\&quot;&quot; +
687          &quot;, \&quot;d9jEYARbghWBrZU6jKbtZPyZUAk_\&quot;&quot; +
688          &quot;, \&quot;d9jEYARbghWBrZU6jKbtZPyZUAk_#Id\&quot;&quot; +
689          &quot;, \&quot;d9jEYARbghWBrZU6jKbtZPyZUAk_#ComponentId\&quot;&quot; +
690          &quot;, \&quot;CrediteurMain\&quot;&quot; +
691          &quot;, \&quot;CrediteurMain#Id\&quot;&quot; +
692          &quot;, \&quot;CrediteurMain#ComponentId\&quot;&quot; +
693          &quot;, \&quot;TTStart\&quot;&quot; +
694          &quot;, \&quot;TTEnd\&quot;&quot; +
695          &quot;, \&quot;InstanceId\&quot;&quot; +
696          &quot;, \&quot;StartDate\&quot;&quot; +
697          &quot;, \&quot;EndDate\&quot;&quot; +
698          &quot;, \&quot;UserId\&quot;&quot; +
699          &quot;, \&quot;Id\&quot;&quot; +
700          &quot; from \&quot;OrganisatieQmo_Organisatie_QueryModelObjects_Imp\&quot; WHERE (\&quot;InstanceId\&quot; = @1) AND ((\&quot;StartDate\&quot; IS NULL) AND (\&quot;TTEnd\&quot; IS NULL)) ORDER BY \&quot;Id\&quot; ASC NULLS FIRST OFFSET 0 ROWS FETCH NEXT 2 ROWS ONLY;&quot;;
701      const string Bug1285CreateStatement = @&quot;
702  CREATE TEMP TABLE &quot;&quot;OrganisatieQmo_Organisatie_QueryModelObjects_Imp&quot;&quot;
703  (
704    &quot;&quot;Id&quot;&quot; uuid NOT NULL,
705    &quot;&quot;InstanceId&quot;&quot; uuid,
706    &quot;&quot;UserId&quot;&quot; text,
707    &quot;&quot;StartDate&quot;&quot; timestamp(3) without time zone,
708    &quot;&quot;EndDate&quot;&quot; timestamp(3) without time zone,
709    &quot;&quot;TTStart&quot;&quot; timestamp(3) without time zone,
710    &quot;&quot;TTEnd&quot;&quot; timestamp(3) without time zone,
711    &quot;&quot;Afbeelding#Id&quot;&quot; uuid,
712    &quot;&quot;Afbeelding&quot;&quot; boolean,
713    &quot;&quot;Omschrijving&quot;&quot; character varying(250),
714    &quot;&quot;Website&quot;&quot; text,
715    &quot;&quot;EMailadres&quot;&quot; character varying(255),
716    &quot;&quot;SocialMediaVastleggen&quot;&quot; boolean,
717    &quot;&quot;Facebook&quot;&quot; text,
718    &quot;&quot;Linkedin&quot;&quot; text,
719    &quot;&quot;Twitter&quot;&quot; text,
720    &quot;&quot;Youtube&quot;&quot; text,
721    &quot;&quot;Branche#Id&quot;&quot; uuid,
722    &quot;&quot;Branche#ComponentId&quot;&quot; uuid,
723    &quot;&quot;Branche&quot;&quot; boolean,
724    &quot;&quot;Telefoonnummer&quot;&quot; character varying(18),
725    &quot;&quot;Overheidsidentificatienummer&quot;&quot; character varying(40),
726    &quot;&quot;Adres#Id&quot;&quot; uuid,
727    &quot;&quot;Adres#ComponentId&quot;&quot; uuid,
728    &quot;&quot;Adres&quot;&quot; boolean,
729    &quot;&quot;2gIKz62kaTdGxw82_OrzTc4ANSM_&quot;&quot; boolean,
730    &quot;&quot;OnderdeelVanOrganisatie#Id&quot;&quot; uuid,
731    &quot;&quot;OnderdeelVanOrganisatie#ComponentId&quot;&quot; uuid,
732    &quot;&quot;OnderdeelVanOrganisatie&quot;&quot; boolean,
733    &quot;&quot;Profit#Id&quot;&quot; uuid,
734    &quot;&quot;Profit#ComponentId&quot;&quot; uuid,
735    &quot;&quot;Profit&quot;&quot; boolean,
736    &quot;&quot;Taal#Id&quot;&quot; uuid,
737    &quot;&quot;Taal#ComponentId&quot;&quot; uuid,
738    &quot;&quot;Taal&quot;&quot; boolean,
739    &quot;&quot;KlantSinds&quot;&quot; timestamp(3) without time zone,
740    &quot;&quot;BarcodeKlant#BarcodeType&quot;&quot; uuid,
741    &quot;&quot;BarcodeKlant#Value&quot;&quot; text,
742    &quot;&quot;BarcodeKlant&quot;&quot; boolean,
743    &quot;&quot;Postadres#Id&quot;&quot; uuid,
744    &quot;&quot;Postadres#ComponentId&quot;&quot; uuid,
745    &quot;&quot;Postadres&quot;&quot; boolean,
746    &quot;&quot;LeverancierSinds&quot;&quot; timestamp(3) without time zone,
747    &quot;&quot;BarcodeLeverancier#BarcodeType&quot;&quot; uuid,
748    &quot;&quot;BarcodeLeverancier#Value&quot;&quot; text,
749    &quot;&quot;BarcodeLeverancier&quot;&quot; boolean,
750    &quot;&quot;Zoeknaam&quot;&quot; character varying(255),
751    &quot;&quot;TitelEnAanhef#Id&quot;&quot; uuid,
752    &quot;&quot;TitelEnAanhef#ComponentId&quot;&quot; uuid,
753    &quot;&quot;TitelEnAanhef&quot;&quot; boolean,
754    &quot;&quot;Rechtsvorm#Id&quot;&quot; uuid,
755    &quot;&quot;Rechtsvorm#ComponentId&quot;&quot; uuid,
756    &quot;&quot;Rechtsvorm&quot;&quot; boolean,
757    &quot;&quot;LandVanVestiging#Id&quot;&quot; uuid,
758    &quot;&quot;LandVanVestiging#ComponentId&quot;&quot; uuid,
759    &quot;&quot;LandVanVestiging&quot;&quot; boolean,
760    &quot;&quot;AantalMedewerkers&quot;&quot; character varying(50),
761    &quot;&quot;NaamStatutair&quot;&quot; character varying(255),
762    &quot;&quot;VestigingStatutair&quot;&quot; character varying(255),
763    &quot;&quot;Correspondentie&quot;&quot; boolean,
764    &quot;&quot;Medium&quot;&quot; character varying(255),
765    &quot;&quot;FiscaalNummer&quot;&quot; character varying(9),
766    &quot;&quot;AangebrachtDoor#Id&quot;&quot; uuid,
767    &quot;&quot;AangebrachtDoor#ComponentId&quot;&quot; uuid,
768    &quot;&quot;AangebrachtDoor&quot;&quot; boolean,
769    &quot;&quot;Status&quot;&quot; character varying(255),
770    &quot;&quot;NummerKamerVanKoophandel&quot;&quot; character varying(30),
771    &quot;&quot;zII9SOHbwUPS_jKSlcRrQzuEr6A_&quot;&quot; timestamp(3) without time zone,
772    &quot;&quot;Code&quot;&quot; character varying(255),
773    &quot;&quot;OrganisatorischeEenheid#Id&quot;&quot; uuid,
774    &quot;&quot;OrganisatorischeEenheid#ComponentId&quot;&quot; uuid,
775    &quot;&quot;OrganisatorischeEenheid&quot;&quot; boolean,
776    &quot;&quot;PJlr3asVdeHVoqmAyHIF2fF1gVM_&quot;&quot; uuid,
777    &quot;&quot;IsUwv&quot;&quot; boolean,
778    &quot;&quot;Uwv#Id&quot;&quot; uuid,
779    &quot;&quot;Uwv#ComponentId&quot;&quot; uuid,
780    &quot;&quot;Uwv&quot;&quot; boolean,
781    &quot;&quot;IsVerzekeraarVoorWerkgever&quot;&quot; boolean,
782    &quot;&quot;VerzekeraarVoorWerkgever#Id&quot;&quot; uuid,
783    &quot;&quot;VerzekeraarVoorWerkgever#ComponentId&quot;&quot; uuid,
784    &quot;&quot;VerzekeraarVoorWerkgever&quot;&quot; boolean,
785    &quot;&quot;IsAbonnementsadministratie&quot;&quot; boolean,
786    &quot;&quot;Abonnementsadministratie#Id&quot;&quot; uuid,
787    &quot;&quot;Abonnementsadministratie#ComponentId&quot;&quot; uuid,
788    &quot;&quot;Abonnementsadministratie&quot;&quot; boolean,
789    &quot;&quot;IsPensioenfonds&quot;&quot; boolean,
790    &quot;&quot;Pensioenfonds#Id&quot;&quot; uuid,
791    &quot;&quot;Pensioenfonds#ComponentId&quot;&quot; uuid,
792    &quot;&quot;Pensioenfonds&quot;&quot; boolean,
793    &quot;&quot;IsProfit&quot;&quot; boolean,
794    &quot;&quot;Profit1#Id&quot;&quot; uuid,
795    &quot;&quot;Profit1#ComponentId&quot;&quot; uuid,
796    &quot;&quot;Profit1&quot;&quot; boolean,
797    &quot;&quot;Verantwoordelijke#Id&quot;&quot; uuid,
798    &quot;&quot;Verantwoordelijke#ComponentId&quot;&quot; uuid,
799    &quot;&quot;Verantwoordelijke&quot;&quot; boolean,
800    &quot;&quot;IsKlant&quot;&quot; boolean,
801    &quot;&quot;Klant#Id&quot;&quot; uuid,
802    &quot;&quot;Klant#ComponentId&quot;&quot; uuid,
803    &quot;&quot;Klant&quot;&quot; boolean,
804    &quot;&quot;IsFactureringsadministratie&quot;&quot; boolean,
805    &quot;&quot;Factureringsadministratie#Id&quot;&quot; uuid,
806    &quot;&quot;Factureringsadministratie#ComponentId&quot;&quot; uuid,
807    &quot;&quot;Factureringsadministratie&quot;&quot; boolean,
808    &quot;&quot;IsLeninggever&quot;&quot; boolean,
809    &quot;&quot;Leninggever#Id&quot;&quot; uuid,
810    &quot;&quot;Leninggever#ComponentId&quot;&quot; uuid,
811    &quot;&quot;Leninggever&quot;&quot; boolean,
812    &quot;&quot;IsProjectadministratie&quot;&quot; boolean,
813    &quot;&quot;Projectadministratie#Id&quot;&quot; uuid,
814    &quot;&quot;Projectadministratie#ComponentId&quot;&quot; uuid,
815    &quot;&quot;Projectadministratie&quot;&quot; boolean,
816    &quot;&quot;IsVervangingsfonds&quot;&quot; boolean,
817    &quot;&quot;Vervangingsfonds#Id&quot;&quot; uuid,
818    &quot;&quot;Vervangingsfonds#ComponentId&quot;&quot; uuid,
819    &quot;&quot;Vervangingsfonds&quot;&quot; boolean,
820    &quot;&quot;IsPensioen&quot;&quot; boolean,
821    &quot;&quot;Pensioen#Id&quot;&quot; uuid,
822    &quot;&quot;Pensioen#ComponentId&quot;&quot; uuid,
823    &quot;&quot;Pensioen&quot;&quot; boolean,
824    &quot;&quot;IsVasteActivaAdministratie&quot;&quot; boolean,
825    &quot;&quot;VasteActivaAdministratie#Id&quot;&quot; uuid,
826    &quot;&quot;VasteActivaAdministratie#ComponentId&quot;&quot; uuid,
827    &quot;&quot;VasteActivaAdministratie&quot;&quot; boolean,
828    &quot;&quot;IsBelastingdienst&quot;&quot; boolean,
829    &quot;&quot;Belastingdienst#Id&quot;&quot; uuid,
830    &quot;&quot;Belastingdienst#ComponentId&quot;&quot; uuid,
831    &quot;&quot;Belastingdienst&quot;&quot; boolean,
832    &quot;&quot;IsCursusadministratie&quot;&quot; boolean,
833    &quot;&quot;Cursusadministratie#Id&quot;&quot; uuid,
834    &quot;&quot;Cursusadministratie#ComponentId&quot;&quot; uuid,
835    &quot;&quot;Cursusadministratie&quot;&quot; boolean,
836    &quot;&quot;IsUitvoerderVervangingsfonds&quot;&quot; boolean,
837    &quot;&quot;UitvoerderVervangingsfonds#Id&quot;&quot; uuid,
838    &quot;&quot;UitvoerderVervangingsfonds#ComponentId&quot;&quot; uuid,
839    &quot;&quot;UitvoerderVervangingsfonds&quot;&quot; boolean,
840    &quot;&quot;IsAssemblageadministratie&quot;&quot; boolean,
841    &quot;&quot;Assemblageadministratie#Id&quot;&quot; uuid,
842    &quot;&quot;Assemblageadministratie#ComponentId&quot;&quot; uuid,
843    &quot;&quot;Assemblageadministratie&quot;&quot; boolean,
844    &quot;&quot;IsLeasemaatschappij&quot;&quot; boolean,
845    &quot;&quot;Leasemaatschappij#Id&quot;&quot; uuid,
846    &quot;&quot;Leasemaatschappij#ComponentId&quot;&quot; uuid,
847    &quot;&quot;Leasemaatschappij&quot;&quot; boolean,
848    &quot;&quot;IsBeslaglegger&quot;&quot; boolean,
849    &quot;&quot;Beslaglegger#Id&quot;&quot; uuid,
850    &quot;&quot;Beslaglegger#ComponentId&quot;&quot; uuid,
851    &quot;&quot;Beslaglegger&quot;&quot; boolean,
852    &quot;&quot;IsVerzekeraarVoorMedewerker&quot;&quot; boolean,
853    &quot;&quot;VerzekeraarVoorMedewerker#Id&quot;&quot; uuid,
854    &quot;&quot;VerzekeraarVoorMedewerker#ComponentId&quot;&quot; uuid,
855    &quot;&quot;VerzekeraarVoorMedewerker&quot;&quot; boolean,
856    &quot;&quot;IsWoningverhuur&quot;&quot; boolean,
857    &quot;&quot;Woningverhuur#Id&quot;&quot; uuid,
858    &quot;&quot;Woningverhuur#ComponentId&quot;&quot; uuid,
859    &quot;&quot;Woningverhuur&quot;&quot; boolean,
860    &quot;&quot;9cSTu7fkjOZm08FFQUHvclQHSWY_&quot;&quot; boolean,
861    &quot;&quot;Goederenstroomadministratie#Id&quot;&quot; uuid,
862    &quot;&quot;Goederenstroomadministratie#ComponentId&quot;&quot; uuid,
863    &quot;&quot;Goederenstroomadministratie&quot;&quot; boolean,
864    &quot;&quot;IsConcurrent&quot;&quot; boolean,
865    &quot;&quot;Concurrent#Id&quot;&quot; uuid,
866    &quot;&quot;Concurrent#ComponentId&quot;&quot; uuid,
867    &quot;&quot;Concurrent&quot;&quot; boolean,
868    &quot;&quot;IsArbodienst&quot;&quot; boolean,
869    &quot;&quot;Arbodienst#Id&quot;&quot; uuid,
870    &quot;&quot;Arbodienst#ComponentId&quot;&quot; uuid,
871    &quot;&quot;Arbodienst&quot;&quot; boolean,
872    &quot;&quot;IsUitvoerderSociaalFonds&quot;&quot; boolean,
873    &quot;&quot;UitvoerderSociaalFonds#Id&quot;&quot; uuid,
874    &quot;&quot;UitvoerderSociaalFonds#ComponentId&quot;&quot; uuid,
875    &quot;&quot;UitvoerderSociaalFonds&quot;&quot; boolean,
876    &quot;&quot;IsPensioenuitvoerder&quot;&quot; boolean,
877    &quot;&quot;Pensioenuitvoerder#Id&quot;&quot; uuid,
878    &quot;&quot;Pensioenuitvoerder#ComponentId&quot;&quot; uuid,
879    &quot;&quot;Pensioenuitvoerder&quot;&quot; boolean,
880    &quot;&quot;IsProspect&quot;&quot; boolean,
881    &quot;&quot;Prospect#Id&quot;&quot; uuid,
882    &quot;&quot;Prospect#ComponentId&quot;&quot; uuid,
883    &quot;&quot;Prospect&quot;&quot; boolean,
884    &quot;&quot;IsProspectadministratie&quot;&quot; boolean,
885    &quot;&quot;Prospectadministratie#Id&quot;&quot; uuid,
886    &quot;&quot;Prospectadministratie#ComponentId&quot;&quot; uuid,
887    &quot;&quot;Prospectadministratie&quot;&quot; boolean,
888    &quot;&quot;IsArtikelbeheeradministratie&quot;&quot; boolean,
889    &quot;&quot;Artikelbeheeradministratie#Id&quot;&quot; uuid,
890    &quot;&quot;Artikelbeheeradministratie#ComponentId&quot;&quot; uuid,
891    &quot;&quot;Artikelbeheeradministratie&quot;&quot; boolean,
892    &quot;&quot;v1J4Rq2eNZy9GBvGhuCBKqga0Rg_&quot;&quot; boolean,
893    &quot;&quot;g4i3gYZGL0yu0T6UwmiZTaUDI8Y_#Id&quot;&quot; uuid,
894    &quot;&quot;g4i3gYZGL0yu0T6UwmiZTaUDI8Y_#ComponentId&quot;&quot; uuid,
895    &quot;&quot;g4i3gYZGL0yu0T6UwmiZTaUDI8Y_&quot;&quot; boolean,
896    &quot;&quot;IsSociaalFonds&quot;&quot; boolean,
897    &quot;&quot;SociaalFonds#Id&quot;&quot; uuid,
898    &quot;&quot;SociaalFonds#ComponentId&quot;&quot; uuid,
899    &quot;&quot;SociaalFonds&quot;&quot; boolean,
900    &quot;&quot;IsWagenparkadministratie&quot;&quot; boolean,
901    &quot;&quot;Wagenparkadministratie#Id&quot;&quot; uuid,
902    &quot;&quot;Wagenparkadministratie#ComponentId&quot;&quot; uuid,
903    &quot;&quot;Wagenparkadministratie&quot;&quot; boolean,
904    &quot;&quot;IsLeverancier&quot;&quot; boolean,
905    &quot;&quot;Leverancier#Id&quot;&quot; uuid,
906    &quot;&quot;Leverancier#ComponentId&quot;&quot; uuid,
907    &quot;&quot;Leverancier&quot;&quot; boolean,
908    &quot;&quot;IsWagenparkAfnemer&quot;&quot; boolean,
909    &quot;&quot;WagenparkAfnemer#Id&quot;&quot; uuid,
910    &quot;&quot;WagenparkAfnemer#ComponentId&quot;&quot; uuid,
911    &quot;&quot;WagenparkAfnemer&quot;&quot; boolean,
912    &quot;&quot;IsEvenementadministratie&quot;&quot; boolean,
913    &quot;&quot;Evenementadministratie#Id&quot;&quot; uuid,
914    &quot;&quot;Evenementadministratie#ComponentId&quot;&quot; uuid,
915    &quot;&quot;Evenementadministratie&quot;&quot; boolean,
916    &quot;&quot;IsCrediteur&quot;&quot; boolean,
917    &quot;&quot;Crediteur#Id&quot;&quot; uuid,
918    &quot;&quot;Crediteur#ComponentId&quot;&quot; uuid,
919    &quot;&quot;Crediteur&quot;&quot; boolean,
920    &quot;&quot;IsFinancieleAdministratie&quot;&quot; boolean,
921    &quot;&quot;FinancieleAdministratie#Id&quot;&quot; uuid,
922    &quot;&quot;FinancieleAdministratie#ComponentId&quot;&quot; uuid,
923    &quot;&quot;FinancieleAdministratie&quot;&quot; boolean,
924    &quot;&quot;IsSociaalSecretariaat&quot;&quot; boolean,
925    &quot;&quot;SociaalSecretariaat#Id&quot;&quot; uuid,
926    &quot;&quot;SociaalSecretariaat#ComponentId&quot;&quot; uuid,
927    &quot;&quot;SociaalSecretariaat&quot;&quot; boolean,
928    &quot;&quot;IsBank&quot;&quot; boolean,
929    &quot;&quot;Bank#Id&quot;&quot; uuid,
930    &quot;&quot;Bank#ComponentId&quot;&quot; uuid,
931    &quot;&quot;Bank&quot;&quot; boolean,
932    &quot;&quot;IsWerkgever&quot;&quot; boolean,
933    &quot;&quot;Werkgever#Id&quot;&quot; uuid,
934    &quot;&quot;Werkgever#ComponentId&quot;&quot; uuid,
935    &quot;&quot;Werkgever&quot;&quot; boolean,
936    &quot;&quot;IsVerkoopadministratie&quot;&quot; boolean,
937    &quot;&quot;Verkoopadministratie#Id&quot;&quot; uuid,
938    &quot;&quot;Verkoopadministratie#ComponentId&quot;&quot; uuid,
939    &quot;&quot;Verkoopadministratie&quot;&quot; boolean,
940    &quot;&quot;IsInkoopadministratie&quot;&quot; boolean,
941    &quot;&quot;Inkoopadministratie#Id&quot;&quot; uuid,
942    &quot;&quot;Inkoopadministratie#ComponentId&quot;&quot; uuid,
943    &quot;&quot;Inkoopadministratie&quot;&quot; boolean,
944    &quot;&quot;IsSubsidient&quot;&quot; boolean,
945    &quot;&quot;Subsidient#Id&quot;&quot; uuid,
946    &quot;&quot;Subsidient#ComponentId&quot;&quot; uuid,
947    &quot;&quot;Subsidient&quot;&quot; boolean,
948    &quot;&quot;IsEnqueteadministratie&quot;&quot; boolean,
949    &quot;&quot;Enqueteadministratie#Id&quot;&quot; uuid,
950    &quot;&quot;Enqueteadministratie#ComponentId&quot;&quot; uuid,
951    &quot;&quot;Enqueteadministratie&quot;&quot; boolean,
952    &quot;&quot;XWiQaVjEbD041r7QN0kj2aKeCys_&quot;&quot; boolean,
953    &quot;&quot;X_TVE5FRBaQ97JJQbT7LmX4HBVY_&quot;&quot; boolean,
954    &quot;&quot;BrancheDescription&quot;&quot; character varying(250),
955    &quot;&quot;AdresDescription&quot;&quot; character varying(250),
956    &quot;&quot;PicMWY7oCqeiZMTdDqwFqi1U508_&quot;&quot; character varying(250),
957    &quot;&quot;ProfitDescription&quot;&quot; character varying(100),
958    &quot;&quot;TaalDescription&quot;&quot; character varying(250),
959    &quot;&quot;PostadresDescription&quot;&quot; character varying(250),
960    &quot;&quot;TitelEnAanhefDescription&quot;&quot; character varying(250),
961    &quot;&quot;RechtsvormDescription&quot;&quot; character varying(250),
962    &quot;&quot;LandVanVestigingDescription&quot;&quot; character varying(250),
963    &quot;&quot;AangebrachtDoorDescription&quot;&quot; character varying(250),
964    &quot;&quot;KFEDo6ZYK_ffNCeHuujBCshlPVs_&quot;&quot; character varying(250),
965    &quot;&quot;VerantwoordelijkeDescription&quot;&quot; character varying(250),
966    &quot;&quot;FunctionalState&quot;&quot; integer,
967    &quot;&quot;KlantFinancieleAdministratie#Id&quot;&quot; uuid,
968    &quot;&quot;KlantFinancieleAdministratie#ComponentId&quot;&quot; uuid,
969    &quot;&quot;KlantFinancieleAdministratie&quot;&quot; boolean,
970    &quot;&quot;KlantVerkoopadministratie#Id&quot;&quot; uuid,
971    &quot;&quot;KlantVerkoopadministratie#ComponentId&quot;&quot; uuid,
972    &quot;&quot;KlantVerkoopadministratie&quot;&quot; boolean,
973    &quot;&quot;NQwaM_lfzxIm_JPrPhwruL0YOXY_#Id&quot;&quot; uuid,
974    &quot;&quot;NQwaM_lfzxIm_JPrPhwruL0YOXY_#ComponentId&quot;&quot; uuid,
975    &quot;&quot;NQwaM_lfzxIm_JPrPhwruL0YOXY_&quot;&quot; boolean,
976    &quot;&quot;uSf1yseW4YQ1K6EoHNlzCxPofm0_#Id&quot;&quot; uuid,
977    &quot;&quot;uSf1yseW4YQ1K6EoHNlzCxPofm0_#ComponentId&quot;&quot; uuid,
978    &quot;&quot;uSf1yseW4YQ1K6EoHNlzCxPofm0_&quot;&quot; boolean,
979    &quot;&quot;KlantEvenementadministratie#Id&quot;&quot; uuid,
980    &quot;&quot;KlantEvenementadministratie#ComponentId&quot;&quot; uuid,
981    &quot;&quot;KlantEvenementadministratie&quot;&quot; boolean,
982    &quot;&quot;KlantCursusadministratie#Id&quot;&quot; uuid,
983    &quot;&quot;KlantCursusadministratie#ComponentId&quot;&quot; uuid,
984    &quot;&quot;KlantCursusadministratie&quot;&quot; boolean,
985    &quot;&quot;KlantProspectadministratie#Id&quot;&quot; uuid,
986    &quot;&quot;KlantProspectadministratie#ComponentId&quot;&quot; uuid,
987    &quot;&quot;KlantProspectadministratie&quot;&quot; boolean,
988    &quot;&quot;KlantInkoopadministratie#Id&quot;&quot; uuid,
989    &quot;&quot;KlantInkoopadministratie#ComponentId&quot;&quot; uuid,
990    &quot;&quot;KlantInkoopadministratie&quot;&quot; boolean,
991    &quot;&quot;KlantProjectadministratie#Id&quot;&quot; uuid,
992    &quot;&quot;KlantProjectadministratie#ComponentId&quot;&quot; uuid,
993    &quot;&quot;KlantProjectadministratie&quot;&quot; boolean,
994    &quot;&quot;P0gBTGcrSbl2kK8BM4_24fIeMvk_#Id&quot;&quot; uuid,
995    &quot;&quot;P0gBTGcrSbl2kK8BM4_24fIeMvk_#ComponentId&quot;&quot; uuid,
996    &quot;&quot;P0gBTGcrSbl2kK8BM4_24fIeMvk_&quot;&quot; boolean,
997    &quot;&quot;KlantMain#Id&quot;&quot; uuid,
998    &quot;&quot;KlantMain#ComponentId&quot;&quot; uuid,
999    &quot;&quot;KlantMain&quot;&quot; boolean,
1000    &quot;&quot;8awXARDcCdVtrvN6IRlwAk5UcrI_#Id&quot;&quot; uuid,
1001    &quot;&quot;8awXARDcCdVtrvN6IRlwAk5UcrI_#ComponentId&quot;&quot; uuid,
1002    &quot;&quot;8awXARDcCdVtrvN6IRlwAk5UcrI_&quot;&quot; boolean,
1003    &quot;&quot;MjgFAhRfH64O3M9Ts_5b0ENQDBE_#Id&quot;&quot; uuid,
1004    &quot;&quot;MjgFAhRfH64O3M9Ts_5b0ENQDBE_#ComponentId&quot;&quot; uuid,
1005    &quot;&quot;MjgFAhRfH64O3M9Ts_5b0ENQDBE_&quot;&quot; boolean,
1006    &quot;&quot;LeverancierMain#Id&quot;&quot; uuid,
1007    &quot;&quot;LeverancierMain#ComponentId&quot;&quot; uuid,
1008    &quot;&quot;LeverancierMain&quot;&quot; boolean,
1009    &quot;&quot;2CaNQvGgtPNHP2XCsoKBQEpwmYA_#Id&quot;&quot; uuid,
1010    &quot;&quot;2CaNQvGgtPNHP2XCsoKBQEpwmYA_#ComponentId&quot;&quot; uuid,
1011    &quot;&quot;2CaNQvGgtPNHP2XCsoKBQEpwmYA_&quot;&quot; boolean,
1012    &quot;&quot;kleo39GG1utTUtP0F15mWkXZBFQ_#Id&quot;&quot; uuid,
1013    &quot;&quot;kleo39GG1utTUtP0F15mWkXZBFQ_#ComponentId&quot;&quot; uuid,
1014    &quot;&quot;kleo39GG1utTUtP0F15mWkXZBFQ_&quot;&quot; boolean,
1015    &quot;&quot;d9jEYARbghWBrZU6jKbtZPyZUAk_#Id&quot;&quot; uuid,
1016    &quot;&quot;d9jEYARbghWBrZU6jKbtZPyZUAk_#ComponentId&quot;&quot; uuid,
1017    &quot;&quot;d9jEYARbghWBrZU6jKbtZPyZUAk_&quot;&quot; boolean,
1018    &quot;&quot;CrediteurMain#Id&quot;&quot; uuid,
1019    &quot;&quot;CrediteurMain#ComponentId&quot;&quot; uuid,
1020    &quot;&quot;CrediteurMain&quot;&quot; boolean,
1021    CONSTRAINT &quot;&quot;pk_OrganisatieQmo_Organisatie_QueryModelObjects_Imp&quot;&quot; PRIMARY KEY (&quot;&quot;Id&quot;&quot;)
1022  )&quot;;
1023      #endregion Bug1285
1024      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2849&quot;)]
1025      public async Task Chunked_string_write_buffer_encoding_space()
1026      {
1027          await using var dataSource = CreateDataSource(csb =&gt; csb.WriteBufferSize = 8192);
1028          await using var conn = await dataSource.OpenConnectionAsync();
1029          var tableName = await CreateTempTable(conn, &quot;col1 text, col2 text&quot;);
1030          await using var binaryImporter = await conn.BeginBinaryImportAsync($&quot;COPY {tableName} FROM STDIN (FORMAT BINARY);&quot;);
1031          await binaryImporter.StartRowAsync();
1032          var almostBufferFillingString = new string(&#x27;a&#x27;, 8152);
1033          await binaryImporter.WriteAsync(almostBufferFillingString, NpgsqlDbType.Text);
1034          var unicodeCharacterThatEncodesToThreeBytesInUtf8 = &#x27;\uD55C&#x27;;
1035          var longStringStartingWithAforementionedUnicodeCharacter = unicodeCharacterThatEncodesToThreeBytesInUtf8 + new string(&#x27;a&#x27;, 10000);
1036          await binaryImporter.WriteAsync(longStringStartingWithAforementionedUnicodeCharacter, NpgsqlDbType.Text);
1037          await binaryImporter.CompleteAsync();
1038      }
1039      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2849&quot;)]
1040      public async Task Chunked_char_array_write_buffer_encoding_space()
1041      {
1042          await using var dataSource = CreateDataSource(csb =&gt; csb.WriteBufferSize = 8192);
1043          await using var conn = await dataSource.OpenConnectionAsync();
1044          var tableName = await CreateTempTable(conn, &quot;col1 text, col2 text&quot;);
1045          await using var binaryImporter = await conn.BeginBinaryImportAsync($&quot;COPY {tableName} FROM STDIN (FORMAT BINARY);&quot;);
1046          await binaryImporter.StartRowAsync();
1047          var almostBufferFillingString = new string(&#x27;a&#x27;, 8152);
1048          await binaryImporter.WriteAsync(almostBufferFillingString, NpgsqlDbType.Text);
1049          var unicodeCharacterThatEncodesToThreeBytesInUtf8 = &#x27;\uD55C&#x27;;
1050          var longStringStartingWithAforementionedUnicodeCharacter = unicodeCharacterThatEncodesToThreeBytesInUtf8 + new string(&#x27;a&#x27;, 10000);
1051          await binaryImporter.WriteAsync(longStringStartingWithAforementionedUnicodeCharacter.ToCharArray(), NpgsqlDbType.Text);
1052          await binaryImporter.CompleteAsync();
1053      }
1054      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/2371&quot;)]
1055      public async Task NRE_in_BeginTextExport()
1056      {
1057          await using var conn = await OpenConnectionAsync();
1058          var funcName = await GetTempFunctionName(conn);
1059          await using var transaction = await conn.BeginTransactionAsync();
1060          await conn.ExecuteNonQueryAsync($&quot;CREATE OR REPLACE FUNCTION {funcName}() RETURNS TABLE (i INT) AS $$ BEGIN RETURN QUERY SELECT s.a FROM pg_stat_activity p; end; $$ LANGUAGE plpgsql;&quot;);
1061          using var reader = await conn.BeginTextExportAsync($&quot;copy (select * FROM {funcName}())  TO STDOUT WITH (format csv)&quot;);
1062          Assert.That(() =&gt; reader.ReadLine(), Throws.Exception
1063              .TypeOf&lt;PostgresException&gt;()
1064              .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.UndefinedTable)
1065          );
1066      }
1067      public enum TestEnum
1068      {
1069          One,
1070          Two
1071      }
1072      class SomeComposite
1073      {
1074          public TestEnum Test { get; set; }
1075          public int X { get; set; }
1076          public string SomeText { get; set; } = &quot;&quot;;
1077      }
1078      [Test]
1079      public async Task CompositePostgresType()
1080      {
1081          await using var adminConnection = await OpenConnectionAsync();
1082          var type = await GetTempTypeName(adminConnection);
1083          var func = await GetTempFunctionName(adminConnection);
1084          await adminConnection.ExecuteNonQueryAsync($&quot;CREATE TYPE {type} as (x int, some_text text, test int)&quot;);
1085          var dataSourceBuilder = CreateDataSourceBuilder();
1086          dataSourceBuilder.MapComposite&lt;SomeComposite&gt;(type);
1087          await using var dataSource = dataSourceBuilder.Build();
1088          await using var connection = await dataSource.OpenConnectionAsync();
1089          await connection.ExecuteNonQueryAsync(@$&quot;
1090  CREATE OR REPLACE FUNCTION {func}(id int, out comp1 {type}, OUT comp2 {type}[])
1091  LANGUAGE plpgsql AS
1092  $$
1093  BEGIN
1094      comp1 = ROW(9, &#x27;bar&#x27;, 1)::{type};
1095      comp2 = ARRAY[ROW(9, &#x27;bar&#x27;, 1)::{type}];
1096  END;
1097  $$;&quot;);
1098          Assert.ThrowsAsync&lt;InvalidCastException&gt;(async () =&gt; await connection.ExecuteScalarAsync($&quot;SELECT {func}(0)&quot;));
1099      }
1100      [Test]
1101      [IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/3117&quot;)]
1102      public void Bug3117()
1103      {
1104          const string OkCommand = &quot;SELECT 1&quot;;
1105          const string ErrorCommand = &quot;SELECT * FROM public.imnotexist&quot;;
1106          using var dataSource = CreateDataSource();
1107          using (var conn = dataSource.OpenConnection())
1108          {
1109              var okCommand = new NpgsqlCommand(OkCommand, conn);
1110              okCommand.Prepare();
1111              using (okCommand.ExecuteReader()) { }
1112              var errorCommand = new NpgsqlCommand(ErrorCommand, conn);
1113              Assert.That(() =&gt; errorCommand.Prepare(), Throws.Exception
1114                  .TypeOf&lt;PostgresException&gt;()
1115                  .With.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.UndefinedTable));
1116          }
1117          using (var conn = dataSource.OpenConnection())
1118          {
1119              var okCommand = new NpgsqlCommand(OkCommand, conn);
1120              okCommand.Prepare();
1121              using (okCommand.ExecuteReader()) { }
1122          }
1123      }
1124      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/3209&quot;)]
1125      public async Task Bug3209()
1126      {
1127          await using var conn = CreateConnection();
1128          await conn.CloseAsync();
1129          await conn.OpenAsync();
1130          await conn.CloseAsync();
1131          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
1132      }
1133      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/3373&quot;)]
1134      public async Task Bug3373()
1135      {
1136          await using var conn = await OpenConnectionAsync();
1137          using var cmd = conn.CreateCommand();
1138          cmd.CommandText = &quot;SELECT repeat(&#x27;1&#x27;, 10000); SELECT * from pg_sleep(3)&quot;;
1139          cmd.CommandTimeout = 0;
1140          await using var reader = await cmd.ExecuteReaderAsync();
1141          Assert.DoesNotThrowAsync(async () =&gt; await reader.NextResultAsync());
1142      }
1143      [Test, IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/3649&quot;)]
1144      public async Task Bug3649()
1145      {
1146          await using var conn = await OpenConnectionAsync();
1147          var table = await CreateTempTable(conn, &quot;value integer&quot;);
1148          using (var importer = await conn.BeginBinaryImportAsync($&quot;COPY {table} (value) FROM STDIN (FORMAT binary)&quot;))
1149          {
1150              await importer.StartRowAsync();
1151              await importer.WriteAsync(DBNull.Value, NpgsqlDbType.Integer);
1152              await importer.StartRowAsync();
1153              await importer.WriteAsync(1, NpgsqlDbType.Integer);
1154              await importer.StartRowAsync();
1155              await importer.WriteAsync(2, NpgsqlDbType.Integer);
1156              await importer.CompleteAsync();
1157          }
1158          using (var exporter = await conn.BeginBinaryExportAsync($&quot;COPY {table} (value) TO STDIN (FORMAT binary)&quot;))
1159          {
1160              await exporter.StartRowAsync();
1161              Assert.IsTrue(exporter.IsNull);
1162              await exporter.SkipAsync();
1163              await exporter.StartRowAsync();
1164              Assert.AreEqual(1, await exporter.ReadAsync&lt;int?&gt;());
1165              await exporter.StartRowAsync();
1166              Assert.AreEqual(2, await exporter.ReadAsync&lt;int?&gt;());
1167          }
1168      }
1169      [Test]
1170      [IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/3839&quot;)]
1171      public async Task SingleThreadedSynchronizationContext_deadlock()
1172      {
1173          var syncContext = new SingleThreadSynchronizationContext(nameof(SingleThreadedSynchronizationContext_deadlock));
1174          using (var _ = syncContext.Enter())
1175          {
1176              await Task.Yield();
1177              using var connection = OpenConnection();
1178              var data = new string(&#x27;x&#x27;, 5_000_000);
1179              using var cmd = new NpgsqlCommand(&quot;SELECT generate_series(1, 500000); SELECT @p&quot;, connection);
1180              cmd.Parameters.AddWithValue(&quot;p&quot;, NpgsqlDbType.Text, data);
1181              cmd.ExecuteNonQuery();
1182          }
1183          await Task.Yield();
1184      }
1185      [Test]
1186      [IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/3924&quot;)]
1187      public async Task Bug3924()
1188      {
1189          var csb = new NpgsqlConnectionStringBuilder(ConnectionString)
1190          {
1191              CommandTimeout = 10,
1192              KeepAlive = 5,
1193          };
1194          await using var postmaster = PgPostmasterMock.Start(csb.ConnectionString);
1195          await using var dataSource = CreateDataSource(postmaster.ConnectionString);
1196          await using var conn = await dataSource.OpenConnectionAsync();
1197          var serverMock = await postmaster.WaitForServerConnection();
1198          using (var cmd = conn.CreateCommand())
1199          {
1200              cmd.CommandTimeout = 1;
1201              cmd.CommandText = &quot;SELECT 1&quot;;
1202              var queryTask = cmd.ExecuteNonQueryAsync();
1203              await serverMock.ExpectExtendedQuery();
1204              _ = serverMock.WriteScalarResponseAndFlush(1);
1205              await queryTask;
1206          }
1207          await serverMock.ExpectMessage(FrontendMessageCode.Sync);
1208          await Task.Delay(1000);
1209          _ = serverMock.WriteReadyForQuery().FlushAsync();
1210          using (var cmd = conn.CreateCommand())
1211          {
1212              cmd.CommandTimeout = 1;
1213              cmd.CommandText = &quot;SELECT 1&quot;;
1214              var queryTask = cmd.ExecuteNonQueryAsync();
1215              await serverMock.ExpectExtendedQuery();
1216              _ = serverMock.WriteScalarResponseAndFlush(1);
1217              Assert.DoesNotThrowAsync(async () =&gt; await queryTask);
1218          }
1219      }
1220      [Test]
1221      [IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/4099&quot;)]
1222      public async Task Bug4099()
1223      {
1224          var csb = new NpgsqlConnectionStringBuilder(ConnectionString)
1225          {
1226              Multiplexing = true,
1227              MaxPoolSize = 1
1228          };
1229          await using var postmaster = PgPostmasterMock.Start(csb.ConnectionString);
1230          await using var dataSource = CreateDataSource(postmaster.ConnectionString);
1231          await using var firstConn = await dataSource.OpenConnectionAsync();
1232          await using var secondConn = await dataSource.OpenConnectionAsync();
1233          var firstQuery = firstConn.ExecuteScalarAsync(&quot;SELECT data&quot;);
1234          var server = await postmaster.WaitForServerConnection();
1235          await server.ExpectExtendedQuery();
1236          var secondQuery = secondConn.ExecuteScalarAsync(&quot;SELECT other_data&quot;);
1237          await server.ExpectExtendedQuery();
1238          var data = new byte[10000];
1239          await server
1240              .WriteParseComplete()
1241              .WriteBindComplete()
1242              .WriteRowDescription(new FieldDescription(PostgresTypeOIDs.Bytea))
1243              .WriteDataRowWithFlush(data);
1244          var otherData = new byte[10];
1245          await server
1246              .WriteCommandComplete()
1247              .WriteReadyForQuery()
1248              .WriteParseComplete()
1249              .WriteBindComplete()
1250              .WriteRowDescription(new FieldDescription(PostgresTypeOIDs.Bytea))
1251              .WriteDataRow(otherData)
1252              .WriteCommandComplete()
1253              .WriteReadyForQuery()
1254              .FlushAsync();
1255          Assert.That(data, Is.EquivalentTo((byte[])(await firstQuery)!));
1256          Assert.That(otherData, Is.EquivalentTo((byte[])(await secondQuery)!));
1257      }
1258      [Test]
1259      [IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/4123&quot;)]
1260      public async Task Bug4123()
1261      {
1262          await using var conn = await OpenConnectionAsync();
1263          await using var cmd = new NpgsqlCommand(&quot;SELECT 1&quot;, conn);
1264          await using var rdr = await cmd.ExecuteReaderAsync();
1265          await rdr.ReadAsync();
1266          await using var stream = await rdr.GetStreamAsync(0);
1267          Assert.DoesNotThrowAsync(stream.FlushAsync);
1268          Assert.DoesNotThrow(stream.Flush);
1269      }
1270  }
</code></pre>
        </div>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-MultipleHostsTests.cs</h3>
            <pre><code>1  using Npgsql.Internal;
2  using Npgsql.Tests.Support;
3  using NUnit.Framework;
4  using System;
5  using System.Collections.Generic;
6  using System.Data;
7  using System.IO;
8  using System.Linq;
9  using System.Net;
10  using System.Net.Sockets;
11  using System.Runtime.InteropServices;
12  using System.Threading;
13  using System.Threading.Tasks;
14  using System.Transactions;
15  using Npgsql.Properties;
16  using static Npgsql.Tests.Support.MockState;
17  using static Npgsql.Tests.TestUtil;
18  using IsolationLevel = System.Transactions.IsolationLevel;
19  using TransactionStatus = Npgsql.Internal.TransactionStatus;
20  namespace Npgsql.Tests;
21  public class MultipleHostsTests : TestBase
22  {
23      static readonly object[] MyCases =
24      {
25          new object[] { TargetSessionAttributes.Standby,        new[] { Primary,         Standby         }, 1 },
26          new object[] { TargetSessionAttributes.Standby,        new[] { PrimaryReadOnly, Standby         }, 1 },
27          new object[] { TargetSessionAttributes.PreferStandby,  new[] { Primary,         Standby         }, 1 },
28          new object[] { TargetSessionAttributes.PreferStandby,  new[] { PrimaryReadOnly, Standby         }, 1 },
29          new object[] { TargetSessionAttributes.PreferStandby,  new[] { Primary,         Primary         }, 0 },
30          new object[] { TargetSessionAttributes.Primary,        new[] { Standby,         Primary         }, 1 },
31          new object[] { TargetSessionAttributes.Primary,        new[] { Standby,         PrimaryReadOnly }, 1 },
32          new object[] { TargetSessionAttributes.PreferPrimary,  new[] { Standby,         Primary         }, 1 },
33          new object[] { TargetSessionAttributes.PreferPrimary,  new[] { Standby,         PrimaryReadOnly }, 1 },
34          new object[] { TargetSessionAttributes.PreferPrimary,  new[] { Standby,         Standby         }, 0 },
35          new object[] { TargetSessionAttributes.Any,            new[] { Standby,         Primary         }, 0 },
36          new object[] { TargetSessionAttributes.Any,            new[] { Primary,         Standby         }, 0 },
37          new object[] { TargetSessionAttributes.Any,            new[] { PrimaryReadOnly, Standby         }, 0 },
38          new object[] { TargetSessionAttributes.ReadWrite,      new[] { Standby,         Primary         }, 1 },
39          new object[] { TargetSessionAttributes.ReadWrite,      new[] { PrimaryReadOnly, Primary         }, 1 },
40          new object[] { TargetSessionAttributes.ReadOnly,       new[] { Primary,         Standby         }, 1 },
41          new object[] { TargetSessionAttributes.ReadOnly,       new[] { PrimaryReadOnly, Standby         }, 0 }
42      };
43      [Test]
44      [TestCaseSource(nameof(MyCases))]
45      public async Task Connect_to_correct_host_pooled(TargetSessionAttributes targetSessionAttributes, MockState[] servers, int expectedServer)
46      {
47          var postmasters = servers.Select(s =&gt; PgPostmasterMock.Start(state: s)).ToArray();
48          await using var __ = new DisposableWrapper(postmasters);
49          var connectionStringBuilder = new NpgsqlConnectionStringBuilder
50          {
51              Host = MultipleHosts(postmasters),
52              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
53              Pooling = true
54          };
55          await using var dataSource = new NpgsqlDataSourceBuilder(connectionStringBuilder.ConnectionString)
56              .BuildMultiHost();
57          await using var conn = await dataSource.OpenConnectionAsync(targetSessionAttributes);
58          Assert.That(conn.Port, Is.EqualTo(postmasters[expectedServer].Port));
59          for (var i = 0; i &lt;= expectedServer; i++)
60              _ = await postmasters[i].WaitForServerConnection();
61      }
62      [Test]
63      [TestCaseSource(nameof(MyCases))]
64      public async Task Connect_to_correct_host_unpooled(TargetSessionAttributes targetSessionAttributes, MockState[] servers, int expectedServer)
65      {
66          var postmasters = servers.Select(s =&gt; PgPostmasterMock.Start(state: s)).ToArray();
67          await using var __ = new DisposableWrapper(postmasters);
68          var connectionStringBuilder = new NpgsqlConnectionStringBuilder
69          {
70              Host = MultipleHosts(postmasters),
71              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
72              Pooling = false
73          };
74          await using var dataSource = new NpgsqlDataSourceBuilder(connectionStringBuilder.ConnectionString)
75              .BuildMultiHost();
76          await using var conn = await dataSource.OpenConnectionAsync(targetSessionAttributes);
77          Assert.That(conn.Port, Is.EqualTo(postmasters[expectedServer].Port));
78          for (var i = 0; i &lt;= expectedServer; i++)
79              _ = await postmasters[i].WaitForServerConnection();
80      }
81      [Test]
82      [TestCaseSource(nameof(MyCases))]
83      public async Task Connect_to_correct_host_with_available_idle(
84          TargetSessionAttributes targetSessionAttributes, MockState[] servers, int expectedServer)
85      {
86          var postmasters = servers.Select(s =&gt; PgPostmasterMock.Start(state: s)).ToArray();
87          await using var __ = new DisposableWrapper(postmasters);
88          var connectionStringBuilder = new NpgsqlConnectionStringBuilder
89          {
90              Host = MultipleHosts(postmasters),
91              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
92          };
93          await using var dataSource = new NpgsqlDataSourceBuilder(connectionStringBuilder.ConnectionString)
94              .BuildMultiHost();
95          var idleConnTargetSessionAttributes = servers[0] switch
96          {
97              Primary =&gt; TargetSessionAttributes.ReadWrite,
98              PrimaryReadOnly =&gt; TargetSessionAttributes.ReadOnly,
99              Standby =&gt; TargetSessionAttributes.Standby,
100              _ =&gt; throw new ArgumentOutOfRangeException()
101          };
102          await using (_ = await dataSource.OpenConnectionAsync(idleConnTargetSessionAttributes))
103          {
104          }
105          await using var conn = await dataSource.OpenConnectionAsync(targetSessionAttributes);
106          Assert.That(conn.Port, Is.EqualTo(postmasters[expectedServer].Port));
107          for (var i = 0; i &lt;= expectedServer; i++)
108              _ = await postmasters[i].WaitForServerConnection();
109      }
110      [Test]
111      [TestCase(TargetSessionAttributes.Standby,   new[] { Primary,         Primary })]
112      [TestCase(TargetSessionAttributes.Primary,   new[] { Standby,         Standby })]
113      [TestCase(TargetSessionAttributes.ReadWrite, new[] { PrimaryReadOnly, Standby })]
114      [TestCase(TargetSessionAttributes.ReadOnly,  new[] { Primary,         Primary })]
115      public async Task Valid_host_not_found(TargetSessionAttributes targetSessionAttributes, MockState[] servers)
116      {
117          var postmasters = servers.Select(s =&gt; PgPostmasterMock.Start(state: s)).ToArray();
118          await using var __ = new DisposableWrapper(postmasters);
119          var connectionStringBuilder = new NpgsqlConnectionStringBuilder
120          {
121              Host = MultipleHosts(postmasters),
122              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
123          };
124          await using var dataSource = new NpgsqlDataSourceBuilder(connectionStringBuilder.ConnectionString)
125              .BuildMultiHost();
126          var exception = Assert.ThrowsAsync&lt;NpgsqlException&gt;(async () =&gt; await dataSource.OpenConnectionAsync(targetSessionAttributes))!;
127          Assert.That(exception.Message, Is.EqualTo(&quot;No suitable host was found.&quot;));
128          Assert.That(exception.InnerException, Is.Null);
129          for (var i = 0; i &lt; servers.Length; i++)
130              _ = await postmasters[i].WaitForServerConnection();
131      }
132      [Test, Platform(Exclude = &quot;MacOsX&quot;, Reason = &quot;#3786&quot;)]
133      public void All_hosts_are_down()
134      {
135          if (RuntimeInformation.FrameworkDescription.StartsWith(&quot;.NET Core 3.1&quot;))
136              return;
137          var endpoint = new IPEndPoint(IPAddress.Loopback, 0);
138          using var socket1 = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
139          socket1.Bind(endpoint);
140          var localEndPoint1 = (IPEndPoint)socket1.LocalEndPoint!;
141          using var socket2 = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
142          socket2.Bind(endpoint);
143          var localEndPoint2 = (IPEndPoint)socket2.LocalEndPoint!;
144          var connectionString = new NpgsqlConnectionStringBuilder
145          {
146              Host = $&quot;{localEndPoint1.Address}:{localEndPoint1.Port},{localEndPoint2.Address}:{localEndPoint2.Port}&quot;
147          }.ConnectionString;
148          using var dataSource = new NpgsqlDataSourceBuilder(connectionString).BuildMultiHost();
149          var exception = Assert.ThrowsAsync&lt;NpgsqlException&gt;(async () =&gt; await dataSource.OpenConnectionAsync(TargetSessionAttributes.Any))!;
150          var aggregateException = (AggregateException)exception.InnerException!;
151          Assert.That(aggregateException.InnerExceptions, Has.Count.EqualTo(2));
152          for (var i = 0; i &lt; aggregateException.InnerExceptions.Count; i++)
153          {
154              Assert.That(aggregateException.InnerExceptions[i], Is.TypeOf&lt;NpgsqlException&gt;()
155                  .With.InnerException.TypeOf&lt;SocketException&gt;()
156                  .With.InnerException.Property(nameof(SocketException.SocketErrorCode)).EqualTo(SocketError.ConnectionRefused));
157          }
158      }
159      [Test]
160      public async Task All_hosts_are_unavailable(
161          [Values] bool pooling,
162          [Values(PostgresErrorCodes.InvalidCatalogName, PostgresErrorCodes.CannotConnectNow)] string errorCode)
163      {
164          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary, startupErrorCode: errorCode);
165          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby, startupErrorCode: errorCode);
166          var builder = new NpgsqlConnectionStringBuilder
167          {
168              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
169              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
170              Pooling = pooling,
171          };
172          await using var dataSource = new NpgsqlDataSourceBuilder(builder.ConnectionString).BuildMultiHost();
173          var ex = Assert.ThrowsAsync&lt;PostgresException&gt;(async () =&gt; await dataSource.OpenConnectionAsync(TargetSessionAttributes.Any))!;
174          Assert.That(ex.SqlState, Is.EqualTo(errorCode));
175      }
176      [Test]
177      [Platform(Exclude = &quot;MacOsX&quot;, Reason = &quot;Flaky in CI on Mac&quot;)]
178      public async Task First_host_is_down()
179      {
180          using var socket = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
181          var endpoint = new IPEndPoint(IPAddress.Loopback, 0);
182          socket.Bind(endpoint);
183          var localEndPoint = (IPEndPoint)socket.LocalEndPoint!;
184          await using var postmaster = PgPostmasterMock.Start(state: Primary);
185          var connectionString = new NpgsqlConnectionStringBuilder
186          {
187              Host = $&quot;{localEndPoint.Address}:{localEndPoint.Port},{postmaster.Host}:{postmaster.Port}&quot;,
188              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading
189          }.ConnectionString;
190          await using var dataSource = new NpgsqlDataSourceBuilder(connectionString).BuildMultiHost();
191          await using var conn = await dataSource.OpenConnectionAsync(TargetSessionAttributes.Any);
192          Assert.That(conn.Port, Is.EqualTo(postmaster.Port));
193      }
194      [Test]
195      [TestCase(&quot;any&quot;)]
196      [TestCase(&quot;primary&quot;)]
197      [TestCase(&quot;standby&quot;)]
198      [TestCase(&quot;prefer-primary&quot;)]
199      [TestCase(&quot;prefer-standby&quot;)]
200      [TestCase(&quot;read-write&quot;)]
201      [TestCase(&quot;read-only&quot;)]
202      public async Task TargetSessionAttributes_with_single_host(string targetSessionAttributes)
203      {
204          var connectionString = new NpgsqlConnectionStringBuilder(ConnectionString)
205          {
206              TargetSessionAttributes = targetSessionAttributes
207          }.ConnectionString;
208          if (targetSessionAttributes == &quot;any&quot;)
209          {
210              await using var postmasterMock = PgPostmasterMock.Start(ConnectionString);
211              using var pool = CreateTempPool(postmasterMock.ConnectionString, out connectionString);
212              await using var conn = new NpgsqlConnection(connectionString);
213              await conn.OpenAsync();
214              _ = await postmasterMock.WaitForServerConnection();
215          }
216          else
217          {
218              Assert.That(() =&gt; new NpgsqlConnection(connectionString), Throws.Exception.TypeOf&lt;NotSupportedException&gt;());
219          }
220      }
221      [Test]
222      public void TargetSessionAttributes_default_is_null()
223          =&gt; Assert.That(new NpgsqlConnectionStringBuilder().TargetSessionAttributes, Is.Null);
224      [Test]
225      [NonParallelizable] 
226      public async Task TargetSessionAttributes_uses_environment_variable()
227      {
228          using var envVarResetter = SetEnvironmentVariable(&quot;PGTARGETSESSIONATTRS&quot;, &quot;prefer-standby&quot;);
229          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary);
230          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby);
231          var builder = new NpgsqlConnectionStringBuilder
232          {
233              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
234              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading
235          };
236          Assert.That(builder.TargetSessionAttributes, Is.Null);
237          await using var dataSource = new NpgsqlDataSourceBuilder(builder.ConnectionString)
238              .BuildMultiHost();
239          await using var conn = await dataSource.OpenConnectionAsync();
240          Assert.That(conn.Port, Is.EqualTo(standbyPostmaster.Port));
241      }
242      [Test]
243      public void TargetSessionAttributes_invalid_throws()
244          =&gt; Assert.Throws&lt;ArgumentException&gt;(() =&gt;
245              new NpgsqlConnectionStringBuilder
246              {
247                  TargetSessionAttributes = nameof(TargetSessionAttributes_invalid_throws)
248              });
249      [Test]
250      public void HostRecheckSeconds_default_value()
251      {
252          var builder = new NpgsqlConnectionStringBuilder();
253          Assert.That(builder.HostRecheckSeconds, Is.EqualTo(10));
254          Assert.That(builder.HostRecheckSecondsTranslated, Is.EqualTo(TimeSpan.FromSeconds(10)));
255      }
256      [Test]
257      public void HostRecheckSeconds_zero_value()
258      {
259          var builder = new NpgsqlConnectionStringBuilder
260          {
261              HostRecheckSeconds = 0,
262          };
263          Assert.That(builder.HostRecheckSeconds, Is.EqualTo(0));
264          Assert.That(builder.HostRecheckSecondsTranslated, Is.EqualTo(TimeSpan.FromSeconds(-1)));
265      }
266      [Test]
267      public void HostRecheckSeconds_invalid_throws()
268          =&gt; Assert.Throws&lt;ArgumentException&gt;(() =&gt;
269              new NpgsqlConnectionStringBuilder
270              {
271                  HostRecheckSeconds = -1
272              });
273      [Test]
274      public async Task Connect_with_load_balancing()
275      {
276          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary);
277          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby);
278          var defaultCsb = new NpgsqlConnectionStringBuilder
279          {
280              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
281              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
282              MaxPoolSize = 1,
283              LoadBalanceHosts = true,
284          };
285          await using var dataSource = new NpgsqlDataSourceBuilder(defaultCsb.ConnectionString)
286              .BuildMultiHost();
287          NpgsqlConnector firstConnector;
288          NpgsqlConnector secondConnector;
289          await using (var firstConnection = await dataSource.OpenConnectionAsync())
290          {
291              firstConnector = firstConnection.Connector!;
292          }
293          await using (var secondConnection = await dataSource.OpenConnectionAsync())
294          {
295              secondConnector = secondConnection.Connector!;
296          }
297          Assert.AreNotSame(firstConnector, secondConnector);
298          await using (var firstBalancedConnection = await dataSource.OpenConnectionAsync())
299          {
300              Assert.AreSame(firstConnector, firstBalancedConnection.Connector);
301          }
302          await using (var secondBalancedConnection = await dataSource.OpenConnectionAsync())
303          {
304              Assert.AreSame(secondConnector, secondBalancedConnection.Connector);
305          }
306          await using (var thirdBalancedConnection = await dataSource.OpenConnectionAsync())
307          {
308              Assert.AreSame(firstConnector, thirdBalancedConnection.Connector);
309          }
310      }
311      [Test]
312      public async Task Connect_without_load_balancing()
313      {
314          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary);
315          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby);
316          var defaultCsb = new NpgsqlConnectionStringBuilder
317          {
318              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
319              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
320              MaxPoolSize = 1,
321              LoadBalanceHosts = false,
322          };
323          await using var dataSource = new NpgsqlDataSourceBuilder(defaultCsb.ConnectionString)
324              .BuildMultiHost();
325          NpgsqlConnector firstConnector;
326          NpgsqlConnector secondConnector;
327          await using (var firstConnection = await dataSource.OpenConnectionAsync())
328          {
329              firstConnector = firstConnection.Connector!;
330          }
331          await using (var secondConnection = await dataSource.OpenConnectionAsync())
332          {
333              Assert.AreSame(firstConnector, secondConnection.Connector);
334          }
335          await using (var firstConnection = await dataSource.OpenConnectionAsync())
336          await using (var secondConnection = await dataSource.OpenConnectionAsync())
337          {
338              secondConnector = secondConnection.Connector!;
339          }
340          Assert.AreNotSame(firstConnector, secondConnector);
341          await using (var firstUnbalancedConnection = await dataSource.OpenConnectionAsync())
342          {
343              Assert.AreSame(firstConnector, firstUnbalancedConnection.Connector);
344          }
345          await using (var secondUnbalancedConnection = await dataSource.OpenConnectionAsync())
346          {
347              Assert.AreSame(firstConnector, secondUnbalancedConnection.Connector);
348          }
349      }
350      [Test]
351      public async Task Connect_state_changing_hosts([Values] bool alwaysCheckHostState)
352      {
353          await using var primaryPostmaster = PgPostmasterMock.Start(state: Primary);
354          await using var standbyPostmaster = PgPostmasterMock.Start(state: Standby);
355          var defaultCsb = new NpgsqlConnectionStringBuilder
356          {
357              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
358              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
359              MaxPoolSize = 1,
360              HostRecheckSeconds = alwaysCheckHostState ? 0 : int.MaxValue,
361              NoResetOnClose = true,
362          };
363          await using var dataSource = new NpgsqlDataSourceBuilder(defaultCsb.ConnectionString)
364              .BuildMultiHost();
365          NpgsqlConnector firstConnector;
366          NpgsqlConnector secondConnector;
367          var firstServerTask = Task.Run(async () =&gt;
368          {
369              var server = await primaryPostmaster.WaitForServerConnection();
370              if (!alwaysCheckHostState)
371                  return;
372              await server.SendMockState(Primary);
373              await server.SendMockState(Standby);
374          });
375          var secondServerTask = Task.Run(async () =&gt;
376          {
377              var server = await standbyPostmaster.WaitForServerConnection();
378              if (!alwaysCheckHostState)
379                  return;
380              await server.SendMockState(Standby);
381              await server.SendMockState(Standby);
382              await server.SendMockState(Primary);
383          });
384          await using (var firstConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.PreferPrimary))
385          await using (var secondConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.PreferPrimary))
386          {
387              firstConnector = firstConnection.Connector!;
388              secondConnector = secondConnection.Connector!;
389          }
390          await using var thirdConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.PreferPrimary);
391          Assert.AreSame(alwaysCheckHostState ? secondConnector : firstConnector, thirdConnection.Connector);
392          await firstServerTask;
393          await secondServerTask;
394      }
395      [Test]
396      public void Database_state_cache_basic()
397      {
398          using var dataSource = CreateDataSource();
399          var timeStamp = DateTime.UtcNow;
400          dataSource.UpdateDatabaseState(DatabaseState.PrimaryReadWrite, timeStamp, TimeSpan.Zero);
401          Assert.AreEqual(DatabaseState.PrimaryReadWrite, dataSource.GetDatabaseState());
402          dataSource.UpdateDatabaseState(DatabaseState.Standby, timeStamp, TimeSpan.Zero);
403          Assert.AreEqual(DatabaseState.PrimaryReadWrite, dataSource.GetDatabaseState());
404          timeStamp = timeStamp.AddSeconds(1);
405          dataSource.UpdateDatabaseState(DatabaseState.PrimaryReadOnly, timeStamp, TimeSpan.Zero);
406          Assert.AreEqual(DatabaseState.PrimaryReadOnly, dataSource.GetDatabaseState());
407          timeStamp = timeStamp.AddSeconds(1);
408          dataSource.UpdateDatabaseState(DatabaseState.PrimaryReadWrite, timeStamp, TimeSpan.FromSeconds(-1));
409          Assert.AreEqual(DatabaseState.Unknown, dataSource.GetDatabaseState(ignoreExpiration: false));
410          Assert.AreEqual(DatabaseState.PrimaryReadWrite, dataSource.GetDatabaseState(ignoreExpiration: true));
411      }
412      [Test]
413      public async Task Offline_state_on_connection_failure()
414      {
415          await using var server = PgPostmasterMock.Start(ConnectionString, startupErrorCode: PostgresErrorCodes.ConnectionFailure);
416          await using var dataSource = server.CreateDataSource();
417          await using var conn = dataSource.CreateConnection();
418          var ex = Assert.ThrowsAsync&lt;PostgresException&gt;(conn.OpenAsync)!;
419          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.ConnectionFailure));
420          var state = conn.NpgsqlDataSource.GetDatabaseState();
421          Assert.That(state, Is.EqualTo(DatabaseState.Offline));
422      }
423      [Test]
424      public async Task Unknown_state_on_connection_authentication_failure()
425      {
426          await using var server = PgPostmasterMock.Start(ConnectionString, startupErrorCode: PostgresErrorCodes.InvalidAuthorizationSpecification);
427          await using var dataSource = server.CreateDataSource();
428          await using var conn = dataSource.CreateConnection();
429          var ex = Assert.ThrowsAsync&lt;PostgresException&gt;(conn.OpenAsync)!;
430          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.InvalidAuthorizationSpecification));
431          var state = conn.NpgsqlDataSource.GetDatabaseState();
432          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
433      }
434      [Test]
435      public async Task Offline_state_on_query_execution_pg_critical_failure()
436      {
437          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
438          await using var dataSource = postmaster.CreateDataSource();
439          await using var conn = await dataSource.OpenConnectionAsync();
440          await using var anotherConn = await dataSource.OpenConnectionAsync();
441          await anotherConn.CloseAsync();
442          var state = conn.NpgsqlDataSource.GetDatabaseState();
443          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
444          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
445          var server = await postmaster.WaitForServerConnection();
446          await server.WriteErrorResponse(PostgresErrorCodes.CrashShutdown).FlushAsync();
447          var ex = Assert.ThrowsAsync&lt;PostgresException&gt;(() =&gt; conn.ExecuteNonQueryAsync(&quot;SELECT 1&quot;))!;
448          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.CrashShutdown));
449          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
450          state = conn.NpgsqlDataSource.GetDatabaseState();
451          Assert.That(state, Is.EqualTo(DatabaseState.Offline));
452          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(0));
453      }
454      [Test, NonParallelizable]
455      public async Task Offline_state_on_query_execution_pg_non_critical_failure()
456      {
457          await using var dataSource = CreateDataSource();
458          await using var conn = await dataSource.OpenConnectionAsync();
459          var expectedState = conn.PostgreSqlVersion.Major &gt; 13 ? DatabaseState.PrimaryReadWrite : DatabaseState.Unknown;
460          var state = dataSource.GetDatabaseState();
461          Assert.That(state, Is.EqualTo(expectedState));
462          Assert.That(dataSource.Statistics.Total, Is.EqualTo(1));
463          var ex = Assert.ThrowsAsync&lt;PostgresException&gt;(() =&gt; conn.ExecuteNonQueryAsync(&quot;SELECT abc&quot;))!;
464          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.UndefinedColumn));
465          Assert.That(conn.State, Is.EqualTo(ConnectionState.Open));
466          state = dataSource.GetDatabaseState();
467          Assert.That(state, Is.EqualTo(expectedState));
468          Assert.That(dataSource.Statistics.Total, Is.EqualTo(1));
469      }
470      [Test]
471      public async Task Offline_state_on_query_execution_IOException()
472      {
473          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
474          await using var dataSource = postmaster.CreateDataSource();
475          await using var conn = await dataSource.OpenConnectionAsync();
476          await using var anotherConn = await dataSource.OpenConnectionAsync();
477          await anotherConn.CloseAsync();
478          var state = conn.NpgsqlDataSource.GetDatabaseState();
479          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
480          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
481          var server = await postmaster.WaitForServerConnection();
482          server.Close();
483          var ex = Assert.ThrowsAsync&lt;NpgsqlException&gt;(() =&gt; conn.ExecuteNonQueryAsync(&quot;SELECT 1&quot;))!;
484          Assert.That(ex.InnerException, Is.InstanceOf&lt;IOException&gt;());
485          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
486          state = conn.NpgsqlDataSource.GetDatabaseState();
487          Assert.That(state, Is.EqualTo(DatabaseState.Offline));
488          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(0));
489      }
490      [Test]
491      public async Task Offline_state_on_query_execution_TimeoutException()
492      {
493          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
494          var dataSourceBuilder = postmaster.GetDataSourceBuilder();
495          dataSourceBuilder.ConnectionStringBuilder.CommandTimeout = 1;
496          dataSourceBuilder.ConnectionStringBuilder.CancellationTimeout = 1;
497          await using var dataSource = dataSourceBuilder.Build();
498          await using var conn = await dataSource.OpenConnectionAsync();
499          await using var anotherConn = await dataSource.OpenConnectionAsync();
500          await anotherConn.CloseAsync();
501          var state = conn.NpgsqlDataSource.GetDatabaseState();
502          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
503          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
504          var ex = Assert.ThrowsAsync&lt;NpgsqlException&gt;(() =&gt; conn.ExecuteNonQueryAsync(&quot;SELECT 1&quot;))!;
505          Assert.That(ex.InnerException, Is.TypeOf&lt;TimeoutException&gt;());
506          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
507          state = conn.NpgsqlDataSource.GetDatabaseState();
508          Assert.That(state, Is.EqualTo(DatabaseState.Offline));
509          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(0));
510      }
511      [Test]
512      public async Task Unknown_state_on_query_execution_TimeoutException_with_disabled_cancellation()
513      {
514          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
515          var dataSourceBuilder = postmaster.GetDataSourceBuilder();
516          dataSourceBuilder.ConnectionStringBuilder.CommandTimeout = 1;
517          dataSourceBuilder.ConnectionStringBuilder.CancellationTimeout = -1;
518          await using var dataSource = dataSourceBuilder.Build();
519          await using var conn = await dataSource.OpenConnectionAsync();
520          await using var anotherConn = await dataSource.OpenConnectionAsync();
521          await anotherConn.CloseAsync();
522          var state = conn.NpgsqlDataSource.GetDatabaseState();
523          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
524          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
525          var ex = Assert.ThrowsAsync&lt;NpgsqlException&gt;(() =&gt; conn.ExecuteNonQueryAsync(&quot;SELECT 1&quot;))!;
526          Assert.That(ex.InnerException, Is.TypeOf&lt;TimeoutException&gt;());
527          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
528          state = conn.NpgsqlDataSource.GetDatabaseState();
529          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
530          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
531      }
532      [Test]
533      public async Task Unknown_state_on_query_execution_cancellation_with_disabled_cancellation_timeout()
534      {
535          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
536          var dataSourceBuilder = postmaster.GetDataSourceBuilder();
537          dataSourceBuilder.ConnectionStringBuilder.CommandTimeout = 30;
538          dataSourceBuilder.ConnectionStringBuilder.CancellationTimeout = -1;
539          await using var dataSource = dataSourceBuilder.Build();
540          await using var conn = await dataSource.OpenConnectionAsync();
541          await using var anotherConn = await dataSource.OpenConnectionAsync();
542          await anotherConn.CloseAsync();
543          var state = conn.NpgsqlDataSource.GetDatabaseState();
544          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
545          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(2));
546          using var cts = new CancellationTokenSource();
547          var query = conn.ExecuteNonQueryAsync(&quot;SELECT 1&quot;, cancellationToken: cts.Token);
548          cts.Cancel();
549          var ex = Assert.ThrowsAsync&lt;OperationCanceledException&gt;(async () =&gt; await query)!;
550          Assert.That(ex.InnerException, Is.TypeOf&lt;TimeoutException&gt;());
551          Assert.That(conn.State, Is.EqualTo(ConnectionState.Closed));
552          state = conn.NpgsqlDataSource.GetDatabaseState();
553          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
554          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
555      }
556      [Test]
557      public async Task Unknown_state_on_query_execution_TimeoutException_with_cancellation_failure()
558      {
559          await using var postmaster = PgPostmasterMock.Start(ConnectionString);
560          var dataSourceBuilder = postmaster.GetDataSourceBuilder();
561          dataSourceBuilder.ConnectionStringBuilder.CommandTimeout = 1;
562          dataSourceBuilder.ConnectionStringBuilder.CancellationTimeout = 0;
563          await using var dataSource = dataSourceBuilder.Build();
564          await using var conn = await dataSource.OpenConnectionAsync();
565          var state = conn.NpgsqlDataSource.GetDatabaseState();
566          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
567          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
568          var server = await postmaster.WaitForServerConnection();
569          var query = conn.ExecuteNonQueryAsync(&quot;SELECT 1&quot;);
570          await postmaster.WaitForCancellationRequest();
571          await server.WriteCancellationResponse().WriteReadyForQuery().FlushAsync();
572          var ex = Assert.ThrowsAsync&lt;NpgsqlException&gt;(async () =&gt; await query)!;
573          Assert.That(ex.InnerException, Is.TypeOf&lt;TimeoutException&gt;());
574          Assert.That(conn.State, Is.EqualTo(ConnectionState.Open));
575          state = conn.NpgsqlDataSource.GetDatabaseState();
576          Assert.That(state, Is.EqualTo(DatabaseState.Unknown));
577          Assert.That(conn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
578      }
579      [Test]
580      public async Task Clear_pool_one_host_only_on_admin_shutdown()
581      {
582          await using var primaryPostmaster = PgPostmasterMock.Start(ConnectionString, state: Primary);
583          await using var standbyPostmaster = PgPostmasterMock.Start(ConnectionString, state: Standby);
584          var dataSourceBuilder = new NpgsqlDataSourceBuilder
585          {
586              ConnectionStringBuilder =
587              {
588                  Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
589                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
590                  MaxPoolSize = 2
591              }
592          };
593          await using var multiHostDataSource = dataSourceBuilder.BuildMultiHost();
594          await using var preferPrimaryDataSource = multiHostDataSource.WithTargetSession(TargetSessionAttributes.PreferPrimary);
595          await using var primaryConn = await preferPrimaryDataSource.OpenConnectionAsync();
596          await using var anotherPrimaryConn = await preferPrimaryDataSource.OpenConnectionAsync();
597          await using var standbyConn = await preferPrimaryDataSource.OpenConnectionAsync();
598          var primaryDataSource = primaryConn.Connector!.DataSource;
599          var standbyDataSource = standbyConn.Connector!.DataSource;
600          await anotherPrimaryConn.CloseAsync();
601          await standbyConn.CloseAsync();
602          Assert.That(primaryDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.PrimaryReadWrite));
603          Assert.That(standbyDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Standby));
604          Assert.That(primaryConn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(3));
605          var server = await primaryPostmaster.WaitForServerConnection();
606          await server.WriteErrorResponse(PostgresErrorCodes.AdminShutdown).FlushAsync();
607          var ex = Assert.ThrowsAsync&lt;PostgresException&gt;(() =&gt; primaryConn.ExecuteNonQueryAsync(&quot;SELECT 1&quot;))!;
608          Assert.That(ex.SqlState, Is.EqualTo(PostgresErrorCodes.AdminShutdown));
609          Assert.That(primaryConn.State, Is.EqualTo(ConnectionState.Closed));
610          Assert.That(primaryDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Offline));
611          Assert.That(standbyDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Standby));
612          Assert.That(primaryConn.NpgsqlDataSource.Statistics.Total, Is.EqualTo(1));
613          multiHostDataSource.ClearDatabaseStates();
614          Assert.That(primaryDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Unknown));
615          Assert.That(standbyDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Unknown));
616      }
617      [Test]
618      [TestCase(&quot;any&quot;, true)]
619      [TestCase(&quot;primary&quot;, true)]
620      [TestCase(&quot;standby&quot;, false)]
621      [TestCase(&quot;prefer-primary&quot;, true)]
622      [TestCase(&quot;prefer-standby&quot;, false)]
623      [TestCase(&quot;read-write&quot;, true)]
624      [TestCase(&quot;read-only&quot;, false)]
625      public async Task Transaction_enlist_reuses_connection(string targetSessionAttributes, bool primary)
626      {
627          await using var primaryPostmaster = PgPostmasterMock.Start(ConnectionString, state: Primary);
628          await using var standbyPostmaster = PgPostmasterMock.Start(ConnectionString, state: Standby);
629          var csb = new NpgsqlConnectionStringBuilder
630          {
631              Host = MultipleHosts(primaryPostmaster, standbyPostmaster),
632              TargetSessionAttributes = targetSessionAttributes,
633              ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
634              MaxPoolSize = 10,
635          };
636          using var _ = CreateTempPool(csb, out var connString);
637          using var scope = new TransactionScope(TransactionScopeOption.Required,
638              new TransactionOptions { IsolationLevel = IsolationLevel.ReadCommitted }, TransactionScopeAsyncFlowOption.Enabled);
639          var query1Task = Query(connString);
640          var server = primary
641              ? await primaryPostmaster.WaitForServerConnection()
642              : await standbyPostmaster.WaitForServerConnection();
643          await server
644              .WriteCommandComplete()
645              .WriteReadyForQuery(TransactionStatus.InTransactionBlock)
646              .WriteParseComplete()
647              .WriteBindComplete()
648              .WriteNoData()
649              .WriteCommandComplete()
650              .WriteReadyForQuery(TransactionStatus.InTransactionBlock)
651              .FlushAsync();
652          await query1Task;
653          var query2Task = Query(connString);
654          await server
655              .WriteParseComplete()
656              .WriteBindComplete()
657              .WriteNoData()
658              .WriteCommandComplete()
659              .WriteReadyForQuery(TransactionStatus.InTransactionBlock)
660              .FlushAsync();
661          await query2Task;
662          await server
663              .WriteCommandComplete()
664              .WriteReadyForQuery()
665              .FlushAsync();
666          scope.Complete();
667          async Task Query(string connectionString)
668          {
669              await using var conn = new NpgsqlConnection(connectionString);
670              await conn.OpenAsync();
671              await using var cmd = conn.CreateCommand();
<span onclick='openModal()' class='match'>672              cmd.CommandText = &quot;SELECT 1&quot;;
673              await cmd.ExecuteNonQueryAsync();
674          }
</span>675      }
676      [Test]
677      public async Task Primary_host_failover_can_connect()
678      {
679          await using var firstPostmaster = PgPostmasterMock.Start(ConnectionString, state: Primary);
680          await using var secondPostmaster = PgPostmasterMock.Start(ConnectionString, state: Standby);
681          var dataSourceBuilder = new NpgsqlDataSourceBuilder
682          {
683              ConnectionStringBuilder =
684              {
685                  Host = MultipleHosts(firstPostmaster, secondPostmaster),
686                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
687                  HostRecheckSeconds = 5
688              }
689          };
690          await using var multiHostDataSource = dataSourceBuilder.BuildMultiHost();
691          var (firstDataSource, secondDataSource) = (multiHostDataSource.Pools[0], multiHostDataSource.Pools[1]);
692          await using var primaryDataSource = multiHostDataSource.WithTargetSession(TargetSessionAttributes.Primary);
693          await using var conn = await primaryDataSource.OpenConnectionAsync();
694          Assert.That(conn.Port, Is.EqualTo(firstPostmaster.Port));
695          var firstServer = await firstPostmaster.WaitForServerConnection();
696          await firstServer
697              .WriteErrorResponse(PostgresErrorCodes.AdminShutdown)
698              .FlushAsync();
699          var failoverEx = Assert.ThrowsAsync&lt;PostgresException&gt;(async () =&gt; await conn.ExecuteNonQueryAsync(&quot;SELECT 1&quot;))!;
700          Assert.That(failoverEx.SqlState, Is.EqualTo(PostgresErrorCodes.AdminShutdown));
701          var noHostFoundEx = Assert.ThrowsAsync&lt;NpgsqlException&gt;(async () =&gt; await conn.OpenAsync())!;
702          Assert.That(noHostFoundEx.Message, Is.EqualTo(&quot;No suitable host was found.&quot;));
703          Assert.That(firstDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Offline));
704          Assert.That(secondDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Standby));
705          firstPostmaster.State = Standby;
706          secondPostmaster.State = Primary;
707          var secondServer = await secondPostmaster.WaitForServerConnection();
708          await secondServer.SendMockState(Primary);
709          await Task.Delay(TimeSpan.FromSeconds(10));
710          Assert.That(firstDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Unknown));
711          Assert.That(secondDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Unknown));
712          await conn.OpenAsync();
713          Assert.That(conn.Port, Is.EqualTo(secondPostmaster.Port));
714          Assert.That(firstDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.Standby));
715          Assert.That(secondDataSource.GetDatabaseState(), Is.EqualTo(DatabaseState.PrimaryReadWrite));
716      }
717      [Test, NonParallelizable]
718      public void IntegrationTest([Values] bool loadBalancing, [Values] bool alwaysCheckHostState)
719      {
720          PoolManager.Reset();
721          var dataSourceBuilder = new NpgsqlDataSourceBuilder(ConnectionString)
722          {
723              ConnectionStringBuilder =
724              {
725                  Host = &quot;localhost,127.0.0.1&quot;,
726                  Pooling = true,
727                  MaxPoolSize = 2,
728                  LoadBalanceHosts = loadBalancing,
729                  HostRecheckSeconds = alwaysCheckHostState ? 0 : 10,
730              }
731          };
732          using var dataSource = dataSourceBuilder.BuildMultiHost();
733          var queriesDone = 0;
734          var clientsTask = Task.WhenAll(
735              Client(dataSource, TargetSessionAttributes.Any),
736              Client(dataSource, TargetSessionAttributes.Primary),
737              Client(dataSource, TargetSessionAttributes.PreferPrimary),
738              Client(dataSource, TargetSessionAttributes.PreferStandby),
739              Client(dataSource, TargetSessionAttributes.ReadWrite));
740          var onlyStandbyClient = Client(dataSource, TargetSessionAttributes.Standby);
741          var readOnlyClient = Client(dataSource, TargetSessionAttributes.ReadOnly);
742          Assert.DoesNotThrowAsync(() =&gt; clientsTask);
743          Assert.ThrowsAsync&lt;NpgsqlException&gt;(() =&gt; onlyStandbyClient);
744          Assert.ThrowsAsync&lt;NpgsqlException&gt;(() =&gt; readOnlyClient);
745          Assert.AreEqual(125, queriesDone);
746          Task Client(NpgsqlMultiHostDataSource multiHostDataSource, TargetSessionAttributes targetSessionAttributes)
747          {
748              var dataSource = multiHostDataSource.WithTargetSession(targetSessionAttributes);
749              var tasks = new List&lt;Task&gt;(5);
750              for (var i = 0; i &lt; 5; i++)
751              {
752                  tasks.Add(Task.Run(() =&gt; Query(dataSource)));
753              }
754              return Task.WhenAll(tasks);
755          }
756          async Task Query(NpgsqlDataSource dataSource)
757          {
758              await using var conn = dataSource.CreateConnection();
759              for (var i = 0; i &lt; 5; i++)
760              {
761                  await conn.OpenAsync();
762                  await conn.ExecuteNonQueryAsync(&quot;SELECT 1&quot;);
763                  await conn.CloseAsync();
764                  Interlocked.Increment(ref queriesDone);
765              }
766          }
767      }
768      [Test]
769      [IssueLink(&quot;https:&amp;bsol;&amp;bsol;github.com/npgsql/npgsql/issues/5055&quot;)]
770      [NonParallelizable] 
771      public async Task Multiple_hosts_with_disabled_sql_rewriting()
772      {
773          using var _ = DisableSqlRewriting();
774          var dataSourceBuilder = new NpgsqlDataSourceBuilder(ConnectionString)
775          {
776              ConnectionStringBuilder =
777              {
778                  Host = &quot;localhost,127.0.0.1&quot;,
779                  Pooling = true,
780                  HostRecheckSeconds = 0
781              }
782          };
783          await using var dataSource = dataSourceBuilder.BuildMultiHost();
784          await using var conn = await dataSource.OpenConnectionAsync();
785      }
786      [Test]
787      public async Task DataSource_with_wrappers()
788      {
789          await using var primaryPostmasterMock = PgPostmasterMock.Start(state: Primary);
790          await using var standbyPostmasterMock = PgPostmasterMock.Start(state: Standby);
791          var builder = new NpgsqlDataSourceBuilder
792          {
793              ConnectionStringBuilder =
794              {
795                  Host = MultipleHosts(primaryPostmasterMock, standbyPostmasterMock),
796                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
797              }
798          };
799          await using var dataSource = builder.BuildMultiHost();
800          await using var primaryDataSource = dataSource.WithTargetSession(TargetSessionAttributes.Primary);
801          await using var standbyDataSource = dataSource.WithTargetSession(TargetSessionAttributes.Standby);
802          await using var primaryConnection = await primaryDataSource.OpenConnectionAsync();
803          Assert.That(primaryConnection.Port, Is.EqualTo(primaryPostmasterMock.Port));
804          await using var standbyConnection = await standbyDataSource.OpenConnectionAsync();
805          Assert.That(standbyConnection.Port, Is.EqualTo(standbyPostmasterMock.Port));
806      }
807      [Test]
808      public async Task DataSource_without_wrappers()
809      {
810          await using var primaryPostmasterMock = PgPostmasterMock.Start(state: Primary);
811          await using var standbyPostmasterMock = PgPostmasterMock.Start(state: Standby);
812          var builder = new NpgsqlDataSourceBuilder
813          {
814              ConnectionStringBuilder =
815              {
816                  Host = MultipleHosts(primaryPostmasterMock, standbyPostmasterMock),
817                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
818              }
819          };
820          await using var dataSource = builder.BuildMultiHost();
821          await using var primaryConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.Primary);
822          Assert.That(primaryConnection.Port, Is.EqualTo(primaryPostmasterMock.Port));
823          await using var standbyConnection = await dataSource.OpenConnectionAsync(TargetSessionAttributes.Standby);
824          Assert.That(standbyConnection.Port, Is.EqualTo(standbyPostmasterMock.Port));
825      }
826      [Test]
827      public void DataSource_with_TargetSessionAttributes_is_not_supported()
828      {
829          var builder = new NpgsqlDataSourceBuilder(&quot;Host=foo,bar;Target Session Attributes=primary&quot;);
830          Assert.That(() =&gt; builder.BuildMultiHost(), Throws.Exception.TypeOf&lt;InvalidOperationException&gt;()
831              .With.Message.EqualTo(NpgsqlStrings.CannotSpecifyTargetSessionAttributes));
832      }
833      [Test]
834      public async Task BuildMultiHost_with_single_host_is_supported()
835      {
836          var builder = new NpgsqlDataSourceBuilder(ConnectionString);
837          await using var dataSource = builder.BuildMultiHost();
838          await using var connection = await dataSource.OpenConnectionAsync();
839          Assert.That(await connection.ExecuteScalarAsync(&quot;SELECT 1&quot;), Is.EqualTo(1));
840      }
841      [Test]
842      public async Task Build_with_multiple_hosts_is_supported()
843      {
844          await using var primaryPostmasterMock = PgPostmasterMock.Start(state: Primary);
845          await using var standbyPostmasterMock = PgPostmasterMock.Start(state: Standby);
846          var builder = new NpgsqlDataSourceBuilder
847          {
848              ConnectionStringBuilder =
849              {
850                  Host = MultipleHosts(primaryPostmasterMock, standbyPostmasterMock),
851                  ServerCompatibilityMode = ServerCompatibilityMode.NoTypeLoading,
852              }
853          };
854          await using var dataSource = builder.Build();
855          await using var connection = await dataSource.OpenConnectionAsync();
856      }
857      static string MultipleHosts(params PgPostmasterMock[] postmasters)
858          =&gt; string.Join(&quot;,&quot;, postmasters.Select(p =&gt; $&quot;{p.Host}:{p.Port}&quot;));
859      class DisposableWrapper : IAsyncDisposable
860      {
861          readonly IEnumerable&lt;IAsyncDisposable&gt; _disposables;
862          public DisposableWrapper(IEnumerable&lt;IAsyncDisposable&gt; disposables) =&gt; _disposables = disposables;
863          public async ValueTask DisposeAsync()
864          {
865              foreach (var disposable in _disposables)
866                  await disposable.DisposeAsync();
867          }
868      }
869  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-BugTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-MultipleHostsTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>331          cmd.CommandText = &quot;SELECT 1&quot;;
332          await cmd.ExecuteScalarAsync();
333          await cmd.ExecuteScalarAsync();
</pre></code></div>
                <div class="column column_space"><pre><code>672              cmd.CommandText = &quot;SELECT 1&quot;;
673              await cmd.ExecuteNonQueryAsync();
674          }
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    