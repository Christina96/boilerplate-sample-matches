
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 14.211438474870016%, Tokens: 17</h2>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-CreateStepSummaryCommandL0.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.IO;
4  using System.Text;
5  using System.Runtime.CompilerServices;
6  using GitHub.Runner.Common.Util;
7  using GitHub.Runner.Sdk;
8  using GitHub.Runner.Worker;
9  using Moq;
10  using Xunit;
11  using DTWebApi = GitHub.DistributedTask.WebApi;
12  using GitHub.DistributedTask.WebApi;
13  using Pipelines = GitHub.DistributedTask.Pipelines;
14  namespace GitHub.Runner.Common.Tests.Worker
15  {
16      public sealed class CreateStepSummaryCommandL0
17      {
18          private Mock<IExecutionContext> _executionContext;
19          private Mock<IJobServerQueue> _jobServerQueue;
20          private ExecutionContext _jobExecutionContext;
21          private List<Tuple<DTWebApi.Issue, string>> _issues;
22          private Variables _variables;
23          private string _rootDirectory;
24          private CreateStepSummaryCommand _createStepCommand;
25          private ITraceWriter _trace;
26          [Fact]
27          [Trait("Level", "L0")]
28          [Trait("Category", "Worker")]
29          public void CreateStepSummaryCommand_FileNull()
30          {
31              using (var hostContext = Setup())
32              {
33                  _createStepCommand.ProcessCommand(_executionContext.Object, null, null);
34                  _jobExecutionContext.Complete();
35                  _jobServerQueue.Verify(x => x.QueueFileUpload(It.IsAny<Guid>(), It.IsAny<Guid>(), It.IsAny<string>(), It.IsAny<string>(), It.IsAny<string>(), It.IsAny<bool>()), Times.Never());
36                  Assert.Equal(0, _issues.Count);
37              }
38          }
39          [Fact]
40          [Trait("Level", "L0")]
41          [Trait("Category", "Worker")]
42          public void CreateStepSummaryCommand_DirectoryNotFound()
43          {
<span onclick='openModal()' class='match'>44              using (var hostContext = Setup())
45              {
46                  var stepSummaryFile = Path.Combine(_rootDirectory, "directory-not-found", "env");
47                  _createStepCommand.ProcessCommand(_executionContext.Object, stepSummaryFile, null);
48                  _jobExecutionContext.Complete();
49                  _jobServerQueue.Verify(x => x.QueueFileUpload(It.IsAny<Guid>(), It.IsAny<Guid>(), It.IsAny<string>(), It.IsAny<string>(), It.IsAny<string>(), It.IsAny<bool>()), Times.Never());
50                  Assert.Equal(0, _issues.Count);
51              }
52          }
53          [Fact]
</span>54          [Trait("Level", "L0")]
55          [Trait("Category", "Worker")]
56          public void CreateStepSummaryCommand_FileNotFound()
57          {
58              using (var hostContext = Setup())
59              {
60                  var stepSummaryFile = Path.Combine(_rootDirectory, "file-not-found");
61                  _createStepCommand.ProcessCommand(_executionContext.Object, stepSummaryFile, null);
62                  _jobExecutionContext.Complete();
63                  _jobServerQueue.Verify(x => x.QueueFileUpload(It.IsAny<Guid>(), It.IsAny<Guid>(), It.IsAny<string>(), It.IsAny<string>(), It.IsAny<string>(), It.IsAny<bool>()), Times.Never());
64                  Assert.Equal(0, _issues.Count);
65              }
66          }
67          [Fact]
68          [Trait("Level", "L0")]
69          [Trait("Category", "Worker")]
70          public void CreateStepSummaryCommand_EmptyFile()
71          {
72              using (var hostContext = Setup())
73              {
74                  var stepSummaryFile = Path.Combine(_rootDirectory, "empty-file");
75                  File.Create(stepSummaryFile).Dispose();
76                  _createStepCommand.ProcessCommand(_executionContext.Object, stepSummaryFile, null);
77                  _jobExecutionContext.Complete();
78                  _jobServerQueue.Verify(x => x.QueueFileUpload(It.IsAny<Guid>(), It.IsAny<Guid>(), It.IsAny<string>(), It.IsAny<string>(), It.IsAny<string>(), It.IsAny<bool>()), Times.Never());
79                  Assert.Equal(0, _issues.Count);
80              }
81          }
82          [Fact]
83          [Trait("Level", "L0")]
84          [Trait("Category", "Worker")]
85          public void CreateStepSummaryCommand_LargeFile()
86          {
87              using (var hostContext = Setup())
88              {
89                  var stepSummaryFile = Path.Combine(_rootDirectory, "empty-file");
90                  File.WriteAllBytes(stepSummaryFile, new byte[CreateStepSummaryCommand.AttachmentSizeLimit + 1]);
91                  _createStepCommand.ProcessCommand(_executionContext.Object, stepSummaryFile, null);
92                  _jobExecutionContext.Complete();
93                  _jobServerQueue.Verify(x => x.QueueFileUpload(It.IsAny<Guid>(), It.IsAny<Guid>(), It.IsAny<string>(), It.IsAny<string>(), It.IsAny<string>(), It.IsAny<bool>()), Times.Never());
94                  Assert.Equal(1, _issues.Count);
95              }
96          }
97          [Fact]
98          [Trait("Level", "L0")]
99          [Trait("Category", "Worker")]
100          public void CreateStepSummaryCommand_Simple()
101          {
102              using (var hostContext = Setup())
103              {
104                  var stepSummaryFile = Path.Combine(_rootDirectory, "simple");
105                  var content = new List<string>
106                  {
107                      "# This is some markdown content",
108                      "",
109                      "## This is more markdown content",
110                  };
111                  WriteContent(stepSummaryFile, content);
112                  _createStepCommand.ProcessCommand(_executionContext.Object, stepSummaryFile, null);
113                  _jobExecutionContext.Complete();
114                  _jobServerQueue.Verify(x => x.QueueFileUpload(It.IsAny<Guid>(), It.IsAny<Guid>(), ChecksAttachmentType.StepSummary, _executionContext.Object.Id.ToString(), stepSummaryFile + "-scrubbed", It.IsAny<bool>()), Times.Once());
115                  Assert.Equal(0, _issues.Count);
116              }
117          }
118          [Fact]
119          [Trait("Level", "L0")]
120          [Trait("Category", "Worker")]
121          public void CreateStepSummaryCommand_ScrubSecrets()
122          {
123              using (var hostContext = Setup())
124              {
125                  hostContext.SecretMasker.AddRegex("Password=.*");
126                  hostContext.SecretMasker.AddRegex("ghs_.*");
127                  var stepSummaryFile = Path.Combine(_rootDirectory, "simple");
128                  var scrubbedFile = stepSummaryFile + "-scrubbed";
129                  var content = new List<string>
130                  {
131                      "# Password=ThisIsMySecretPassword!",
132                      "",
133                      "# GITHUB_TOKEN ghs_verysecuretoken",
134                  };
135                  WriteContent(stepSummaryFile, content);
136                  _createStepCommand.ProcessCommand(_executionContext.Object, stepSummaryFile, null);
137                  var scrubbedFileContents = File.ReadAllText(scrubbedFile);
138                  Assert.DoesNotContain("ThisIsMySecretPassword!", scrubbedFileContents);
139                  Assert.DoesNotContain("ghs_verysecuretoken", scrubbedFileContents);
140                  _jobExecutionContext.Complete();
141                  _jobServerQueue.Verify(x => x.QueueFileUpload(It.IsAny<Guid>(), It.IsAny<Guid>(), ChecksAttachmentType.StepSummary, _executionContext.Object.Id.ToString(), scrubbedFile, It.IsAny<bool>()), Times.Once());
142                  Assert.Equal(0, _issues.Count);
143              }
144          }
145          private void WriteContent(
146              string path,
147              List<string> content,
148              string newline = null)
149          {
150              if (string.IsNullOrEmpty(newline))
151              {
152                  newline = Environment.NewLine;
153              }
154              var encoding = new UTF8Encoding(true); 
155              var contentStr = string.Join(newline, content);
156              File.WriteAllText(path, contentStr, encoding);
157          }
158          private TestHostContext Setup([CallerMemberName] string name = "")
159          {
160              var hostContext = new TestHostContext(this, name);
161              _issues = new List<Tuple<DTWebApi.Issue, string>>();
162              TaskOrchestrationPlanReference plan = new();
163              TimelineReference timeline = new();
164              Guid jobId = Guid.NewGuid();
165              string jobName = "Summary Job";
166              var jobRequest = new Pipelines.AgentJobRequestMessage(plan, timeline, jobId, jobName, jobName, null, null, null, new Dictionary<string, VariableValue>(), new List<MaskHint>(), new Pipelines.JobResources(), new Pipelines.ContextData.DictionaryContextData(), new Pipelines.WorkspaceOptions(), new List<Pipelines.ActionStep>(), null, null, null, null);
167              jobRequest.Resources.Repositories.Add(new Pipelines.RepositoryResource()
168              {
169                  Alias = Pipelines.PipelineConstants.SelfAlias,
170                  Id = "github",
171                  Version = "sha1"
172              });
173              jobRequest.ContextData["github"] = new Pipelines.ContextData.DictionaryContextData();
174              jobRequest.Variables["ACTIONS_STEP_DEBUG"] = "true";
175              _jobServerQueue = new Mock<IJobServerQueue>();
176              _jobServerQueue.Setup(x => x.QueueTimelineRecordUpdate(It.IsAny<Guid>(), It.IsAny<TimelineRecord>()));
177              hostContext.SetSingleton(_jobServerQueue.Object);
178              var configurationStore = new Mock<IConfigurationStore>();
179              configurationStore.Setup(x => x.GetSettings()).Returns(new RunnerSettings());
180              hostContext.SetSingleton(configurationStore.Object);
181              var pagingLogger = new Mock<IPagingLogger>();
182              hostContext.EnqueueInstance(pagingLogger.Object);
183              _trace = hostContext.GetTrace();
184              _variables = new Variables(hostContext, new Dictionary<string, VariableValue>
185                  {
186                      { "MySecretName", new VariableValue("My secret value", true) },
187                  });
188              var workDirectory = hostContext.GetDirectory(WellKnownDirectory.Work);
189              ArgUtil.NotNullOrEmpty(workDirectory, nameof(workDirectory));
190              Directory.CreateDirectory(workDirectory);
191              _rootDirectory = Path.Combine(workDirectory, nameof(CreateStepSummaryCommandL0));
192              Directory.CreateDirectory(_rootDirectory);
193              _jobExecutionContext = new ExecutionContext();
194              _jobExecutionContext.Initialize(hostContext);
195              _jobExecutionContext.InitializeJob(jobRequest, System.Threading.CancellationToken.None);
196              _executionContext = new Mock<IExecutionContext>();
197              _executionContext.Setup(x => x.Global)
198                  .Returns(new GlobalContext
199                  {
200                      EnvironmentVariables = new Dictionary<string, string>(VarUtil.EnvironmentVariableKeyComparer),
201                      WriteDebug = true,
202                      Variables = _variables,
203                  });
204              _executionContext.Setup(x => x.AddIssue(It.IsAny<DTWebApi.Issue>(), It.IsAny<ExecutionContextLogOptions>()))
205                  .Callback((DTWebApi.Issue issue, ExecutionContextLogOptions logOptions) =>
206                  {
207                      var resolvedMessage = issue.Message;
208                      if (logOptions.WriteToLog && !string.IsNullOrEmpty(logOptions.LogMessageOverride))
209                      {
210                          resolvedMessage = logOptions.LogMessageOverride;
211                      }
212                      _issues.Add(new(issue, resolvedMessage));
213                      _trace.Info($"Issue '{issue.Type}': {resolvedMessage}");
214                  });
215              _executionContext.Setup(x => x.Write(It.IsAny<string>(), It.IsAny<string>()))
216                  .Callback((string tag, string message) =>
217                  {
218                      _trace.Info($"{tag}{message}");
219                  });
220              _executionContext.SetupGet(x => x.Root).Returns(_jobExecutionContext);
221              _createStepCommand = new CreateStepSummaryCommand();
222              _createStepCommand.Initialize(hostContext);
223              return hostContext;
224          }
225      }
226  }
</code></pre>
        </div>
        <div class="column">
            <h3>Simple.Data-MDEwOlJlcG9zaXRvcnk4MTg3Njg=-flat-InMemoryTests.cs</h3>
            <pre><code>1  namespace Simple.Data.InMemoryTest
2  {
3      using System;
4  	using System.Linq;
5      using System.Collections.Generic;
6      using System.Threading;
7      using NUnit.Framework;
8      [TestFixture]
9      public class InMemoryTests
10      {
11          [Test]
12          public void InsertAndGetShouldWork()
13          {
14              var adapter = new InMemoryAdapter();
15              adapter.SetKeyColumn("Test", "Id");
16              Database.UseMockAdapter(adapter);
17              var db = Database.Open();
18              db.Test.Insert(Id: 1, Name: "Alice");
19              var record = db.Test.Get(1);
20              Assert.IsNotNull(record);
21              Assert.AreEqual(1, record.Id);
22              Assert.AreEqual("Alice", record.Name);
23          }
24          [Test]
25          public void InsertAndFindShouldWork()
26          {
27              Database.UseMockAdapter(new InMemoryAdapter());
28              var db = Database.Open();
29              db.Test.Insert(Id: 1, Name: "Alice");
30              var record = db.Test.FindById(1);
31              Assert.IsNotNull(record);
32              Assert.AreEqual(1, record.Id);
33              Assert.AreEqual("Alice", record.Name);
34          }
35          [Test]
36          public void InsertAndFindAllShouldWork()
37          {
38              Database.UseMockAdapter(new InMemoryAdapter());
39              var db = Database.Open();
40              db.Test.Insert(Id: 1, Name: "Alice");
41              db.Test.Insert(Id: 2, Name: "Bob");
42              List<dynamic> records = db.Test.FindAllById(new[] { 1, 5 }).ToList();
43              var record = records.Single();
44              Assert.IsNotNull(record);
45              Assert.AreEqual(1, record.Id);
46              Assert.AreEqual("Alice", record.Name);
47          }
48          [Test]
49          public void InsertAndFindAllByStringTypeShouldWork()
50          {
51              Database.UseMockAdapter(new InMemoryAdapter());
52              var db = Database.Open();
53              db.Test.Insert(Id: 1, Name: "Alice");
54              db.Test.Insert(Id: 2, Name: "Bob");
55              List<dynamic> records = db.Test.FindAllByName(new[] { "Alice", "Bob" }).ToList();
56              Assert.IsNotNull(records);
57              Assert.AreEqual(2, records.Count);
58          }
59          [Test]
60          public void InsertAndFindWithTwoColumnsShouldWork()
61          {
62              Database.UseMockAdapter(new InMemoryAdapter());
63              var db = Database.Open();
64              db.Test.Insert(Id: 1, Name: "Alice");
65              var record = db.Test.FindByIdAndName(1, "Alice");
66              Assert.IsNotNull(record);
67              Assert.AreEqual(1, record.Id);
68              Assert.AreEqual("Alice", record.Name);
69          }
70          [Test]
71          public void InsertAndFindWithTwoColumnsUsingNamedParametersShouldWork()
72          {
73              Database.UseMockAdapter(new InMemoryAdapter());
74              var db = Database.Open();
75              db.Test.Insert(Id: 1, Name: "Alice");
76              var record = db.Test.FindBy(Id: 1, Name: "Alice");
77              Assert.IsNotNull(record);
78              Assert.AreEqual(1, record.Id);
79              Assert.AreEqual("Alice", record.Name);
80          }
81          [Test]
82          public void AllShouldReturnAllRecords()
83          {
84              Database.UseMockAdapter(new InMemoryAdapter());
85              var db = Database.Open();
86              db.Test.Insert(Id: 1, Name: "Alice");
87              db.Test.Insert(Id: 2, Name: "Bob");
88              List<dynamic> records = db.Test.All().ToList();
89              Assert.IsNotNull(records);
90              Assert.AreEqual(2, records.Count);
91          }
92          [Test]
93          public void TestFindAllByPartialName()
94          {
95              Database.UseMockAdapter(new InMemoryAdapter());
96              var db = Database.Open();
97              db.MySchema.Test.Insert(Id: 1, Name: "Alice");
98              db.MySchema.Test.Insert(Id: 2, Name: "Bob");
99              db.MySchema.Test.Insert(Id: 2, Name: "Clive");
100              List<dynamic> records = db.MySchema.Test.FindAll(db.MySchema.Test.Name.Like("A%")).ToList();
101              Assert.IsNotNull(records);
102              Assert.AreEqual(1, records.Count);
103          }
104          [Test]
105          public void TestFindAllByExcludedPartialName()
106          {
107              Database.UseMockAdapter(new InMemoryAdapter());
108              var db = Database.Open();
109              db.MySchema.Test.Insert(Id: 1, Name: "Alice");
110              db.MySchema.Test.Insert(Id: 2, Name: "Bob");
111              db.MySchema.Test.Insert(Id: 2, Name: "Clive");
112              List<dynamic> records = db.MySchema.Test.FindAll(db.MySchema.Test.Name.NotLike("A%")).ToList();
113              Assert.IsNotNull(records);
114              Assert.AreEqual(2, records.Count);
115          }
116          [Test]
117          public void SelectShouldReturnSubsetOfColumns()
118          {
119              Database.UseMockAdapter(new InMemoryAdapter());
120              var db = Database.Open();
121              db.Test.Insert(Id: 1, Name: "Alice");
<span onclick='openModal()' class='match'>122              db.Test.Insert(Id: 2, Name: "Bob");
123              List<IDictionary<string, object>> records = db.Test.All().Select(db.Test.Name).ToList<IDictionary<string, object>>();
124              Assert.IsNotNull(records);
125              Assert.AreEqual(2, records.Count);
126              Assert.False(records[0].ContainsKey("Id"));
127              Assert.True(records[0].ContainsKey("Name"));
128              Assert.False(records[1].ContainsKey("Id"));
129              Assert.True(records[1].ContainsKey("Name"));
130          }
131          [Test]
</span>132          public void SelectWithAverageShouldReturnAverage()
133          {
134              var db = CreateAggregateTestDb();
135              var records = db.Test.All().Select(db.Test.Name, db.Test.Age.Average().As("AverageAge")).ToList();
136              Assert.AreEqual(2, records.Count);
137              Assert.AreEqual(25, records[0].AverageAge);
138              Assert.AreEqual(45, records[1].AverageAge);
139          }
140          [Test]
141          public void SelectWithSumShouldReturnSum()
142          {
143              var db = CreateAggregateTestDb();
144              var records = db.Test.All().Select(db.Test.Name, db.Test.Age.Sum().As("SumAge")).ToList();
145              Assert.AreEqual(2, records.Count);
146              Assert.AreEqual(50, records[0].SumAge);
147              Assert.AreEqual(90, records[1].SumAge);
148          }
149          [Test]
150          public void SelectWithMinShouldReturnMin()
151          {
152              var db = CreateAggregateTestDb();
153              var records = db.Test.All().Select(db.Test.Name, db.Test.Age.Min().As("MinAge")).ToList();
154              Assert.AreEqual(2, records.Count);
155              Assert.AreEqual(20, records[0].MinAge);
156              Assert.AreEqual(40, records[1].MinAge);
157          }
158          [Test]
159          public void SelectWithMaxShouldReturnMax()
160          {
161              var db = CreateAggregateTestDb();
162              var records = db.Test.All().Select(db.Test.Name, db.Test.Age.Max().As("MaxAge")).ToList();
163              Assert.AreEqual(2, records.Count);
164              Assert.AreEqual(30, records[0].MaxAge);
165              Assert.AreEqual(50, records[1].MaxAge);
166          }
167          [Test]
168          public void SelectWithHavingSumShouldReturnOnlyMatchingRows()
169          {
170              var db = CreateAggregateTestDb();
171              var records = db.Test.All().Select(db.Test.Name).Having(db.Test.Age.Sum() > 50).ToList();
172              Assert.AreEqual(1, records.Count);
173              Assert.AreEqual("Bob", records[0].Name);
174          }
175          private static dynamic CreateAggregateTestDb()
176          {
177              Database.UseMockAdapter(new InMemoryAdapter());
178              var db = Database.Open();
179              db.Test.Insert(Id: 1, Name: "Alice", Age: 20);
180              db.Test.Insert(Id: 2, Name: "Alice", Age: 30);
181              db.Test.Insert(Id: 3, Name: "Bob", Age: 40);
182              db.Test.Insert(Id: 4, Name: "Bob", Age: 50);
183              return db;
184          }
185          [Test]
186          public void ShouldWorkWithByteArrays()
187          {
188              Database.UseMockAdapter(new InMemoryAdapter());
189              var db = Database.Open();
190              db.Test.Insert(Id: 1, Data: new byte[] { 0x1, 0x2, 0x3 });
191              var record = db.Test.FindById(1);
192              Assert.AreEqual(0x1, record.Data[0]);
193          }
194          [Test]
195          public void TestUpdateBy()
196          {
197              Database.UseMockAdapter(new InMemoryAdapter());
198              var db = Database.Open();
199              db.Test.Insert(Id: 1, Name: "Alice");
200              int updated = db.Test.UpdateById(Id: 1, Name: "Allyce");
201              Assert.AreEqual(1, updated);
202              var record = db.Test.FindById(1);
203              Assert.AreEqual("Allyce", record.Name);
204          }
205          [Test]
206          public void TestUpdate()
207          {
208              var adapter = new InMemoryAdapter();
209              adapter.SetKeyColumn("Test", "Id");
210              Database.UseMockAdapter(adapter);
211              var db = Database.Open();
212              var alice = db.Test.Insert(Id: 1, Name: "Alice");
213              var allyce = new { Id = 1, Name = "Allyce" };
214              int updated = db.Test.Update(allyce);
215              Assert.AreEqual(1, updated);
216              var record = db.Test.FindById(1);
217              Assert.AreEqual("Allyce", record.Name);
218          }
219          [Test]
220          public void TestDeleteBy()
221          {
222              Database.UseMockAdapter(new InMemoryAdapter());
223              var db = Database.Open();
224              db.Test.Insert(Id: 1, Name: "Alice");
225              Assert.AreEqual(1, db.Test.All().ToList().Count);
226              int deleted = db.Test.DeleteById(1);
227              Assert.AreEqual(1, deleted);
228              var record = db.Test.FindById(1);
229              Assert.IsNull(record);
230          }
231          [Test]
232          public void TestOrderBy()
233          {
234              Database.UseMockAdapter(new InMemoryAdapter());
235              var db = Database.Open();
236              for (int i = 0; i < 10; i++)
237              {
238                  db.Test.Insert(Id: i, Name: "Alice");
239              }
240              var records = db.Test.All().OrderByIdDescending().ToList();
241              Assert.AreEqual(9, records[0].Id);
242          }
243          [Test]
244          public void TestOrderByThenBy()
245          {
246              Database.UseMockAdapter(new InMemoryAdapter());
247              var db = Database.Open();
248              db.Test.Insert(Id: 3, Company: "B", Name: "Alfred");
249              db.Test.Insert(Id: 2, Company: "A", Name: "Bob");
250              db.Test.Insert(Id: 4, Company: "B", Name: "Steve");
251              db.Test.Insert(Id: 1, Company: "A", Name: "Alice");
252              var records = db.Test.All().OrderByCompany().ThenByName().ToList();
253              Assert.AreEqual("Alice", records[0].Name);
254              Assert.AreEqual("Bob", records[1].Name);
255              Assert.AreEqual("Alfred", records[2].Name);
256              Assert.AreEqual("Steve", records[3].Name);
257          }
258          [Test]
259          public void TestOrderByMultiple()
260          {
261              Database.UseMockAdapter(new InMemoryAdapter());
262              var db = Database.Open();
263              db.Test.Insert(Id: 3, Company: "B", Name: "Alfred");
264              db.Test.Insert(Id: 2, Company: "A", Name: "Bob");
265              db.Test.Insert(Id: 4, Company: "B", Name: "Steve");
266              db.Test.Insert(Id: 1, Company: "A", Name: "Alice");
267              var records = db.Test.All().OrderBy(db.Test.Company, db.Test.Name).ToList();
268              Assert.AreEqual("Alice", records[0].Name);
269              Assert.AreEqual("Bob", records[1].Name);
270              Assert.AreEqual("Alfred", records[2].Name);
271              Assert.AreEqual("Steve", records[3].Name);
272          }
273          [Test]
274          public void TestSkip()
275          {
276              Database.UseMockAdapter(new InMemoryAdapter());
277              var db = Database.Open();
278              for (int i = 0; i < 10; i++)
279              {
280                  db.Test.Insert(Id: i, Name: "Alice");
281              }
282              var records = db.Test.All().Skip(5).ToList();
283              Assert.AreEqual(5, records.Count);
284          }
285          [Test]
286          public void TestTake()
287          {
288              Database.UseMockAdapter(new InMemoryAdapter());
289              var db = Database.Open();
290              for (int i = 0; i < 10; i++)
291              {
292                  db.Test.Insert(Id: i, Name: "Alice");
293              }
294              var records = db.Test.All().Take(5).ToList();
295              Assert.AreEqual(5, records.Count);
296          }
297          [Test]
298          public void TestSkipAndTake()
299          {
300              Database.UseMockAdapter(new InMemoryAdapter());
301              var db = Database.Open();
302              for (int i = 0; i < 10; i++)
303              {
304                  db.Test.Insert(Id: i, Name: "Alice");
305              }
306              var records = db.Test.All().OrderByIdDescending().Skip(1).Take(1).ToList();
307              Assert.AreEqual(1, records.Count);
308              Assert.AreEqual(8, records[0].Id);
309          }
310          [Test]
311          public void TestJoin()
312          {
313              var adapter = new InMemoryAdapter();
314              adapter.ConfigureJoin("Customer", "ID", "Customer", "Order", "CustomerID", "Orders");
315              Database.UseMockAdapter(adapter);
316              var db = Database.Open();
317              db.Customer.Insert(ID: 1, Name: "NASA");
318              db.Customer.Insert(ID: 2, Name: "ACME");
319              db.Order.Insert(ID: 1, CustomerID: 1, Date: new DateTime(1997, 1, 12));
320              db.Order.Insert(ID: 2, CustomerID: 2, Date: new DateTime(2001, 1, 1));
321              var customers = db.Customer.FindAll(db.Customer.Orders.Date < new DateTime(1999, 12, 31)).ToList();
322              Assert.IsNotNull(customers);
323              Assert.AreEqual(1, customers.Count);
324          }
325          [Test]
326          public void TestJoinConfig()
327          {
328              var adapter = new InMemoryAdapter();
329              adapter.Join.Master("Customer", "ID").Detail("Order", "CustomerID");
330              Database.UseMockAdapter(adapter);
331              var db = Database.Open();
332              db.Customer.Insert(ID: 1, Name: "NASA");
333              db.Customer.Insert(ID: 2, Name: "ACME");
334              db.Order.Insert(ID: 1, CustomerID: 1, Date: new DateTime(1997, 1, 12));
335              db.Order.Insert(ID: 2, CustomerID: 2, Date: new DateTime(2001, 1, 1));
336              var customers = db.Customer.FindAll(db.Customer.Order.Date < new DateTime(1999, 12, 31)).ToList();
337              Assert.IsNotNull(customers);
338              Assert.AreEqual(1, customers.Count);
339          }
340          [Test]
341          public void SeparateThreadsShouldSeeDifferentMocks()
342          {
343              int r1 = 0;
344              int r2 = 0;
345              var t1 = new Thread(() => r1 = ThreadTestHelper(1));
346              var t2 = new Thread(() => r2 = ThreadTestHelper(2));
347              t1.Start();
348              t2.Start();
349              t1.Join();
350              t2.Join();
351              Assert.AreEqual(1, r1);
352              Assert.AreEqual(2, r2);
353          }
354          [Test]
355          public void FindAllWhenUsingNamePropertyShouldWork()
356          {
357              var adapter = new InMemoryAdapter();
358              adapter.ConfigureJoin("Users", "Id", "User", "Categories", "UserId", "Categories");
359              Database.UseMockAdapter(adapter);
360              var db = Database.Open();
361              db.Users.Insert(Id: 1, Name: "Marcus");
362              db.Users.Insert(Id: 2, Name: "Per");
363              db.Categories.Insert(Id: 1, UserId: 1, Name: "Category 1");
364              db.Categories.Insert(Id: 2, UserId: 2, Name: "Category 2");
365              var categories = db.Users.FindAll(db.User.Categories.Name == "Category 1").ToList();
366              Assert.NotNull(categories);
367              Assert.AreEqual(1, categories.Count);
368          }
369          [Test]
370          public void FindAllWhenUsingAnyOldPropertyNameShouldWork()
371          {
372              var adapter = new InMemoryAdapter();
373              adapter.ConfigureJoin("Users", "Id", "User", "Categories", "UserId", "Categories");
374              Database.UseMockAdapter(adapter);
375              var db = Database.Open();
376              db.Users.Insert(Id: 1, UserName: "Marcus");
377              db.Users.Insert(Id: 2, UserName: "Per");
378              db.Categories.Insert(Id: 1, UserId: 1, CategoryName: "Category 1");
379              db.Categories.Insert(Id: 2, UserId: 2, CategoryName: "Category 2");
380              var categories = db.Users.FindAll(db.User.Categories.CategoryName == "Category 1").ToList();
381              Assert.NotNull(categories);
382              Assert.AreEqual(1, categories.Count);
383          }
384          [Test]
385          public void AutoIncrementShouldSet1ForAutoIncrementedColumnsWhenNoRowsInTable()
386          {
387              var adapter = new InMemoryAdapter();
388              adapter.SetAutoIncrementColumn("Users", "Id");
389              Database.UseMockAdapter(adapter);
390              var db = Database.Open();
391              var newId = db.Users.Insert(Name: "Marcus").Id;
392              Assert.AreEqual(1, newId);
393          }
394          [Test]
395          public void AutoIncrementShouldReturnNextIdInSequenceWhenOneRowExsists()
396          {
397              var adapter = new InMemoryAdapter();
398              adapter.SetAutoIncrementColumn("Users", "Id");
399              Database.UseMockAdapter(adapter);
400              var db = Database.Open();
401              db.Users.Insert(Name: "Marcus");
402              var newId = db.Users.Insert(Name: "Per").Id;
403              Assert.AreEqual(2, newId);
404          }
405          [Test]
406          public void ShouldBeAbleToSetAutoIncrementWhenSettingKeyColumn()
407          {
408              var adapter = new InMemoryAdapter();
409              adapter.SetAutoIncrementKeyColumn("Users", "Id");
410              Database.UseMockAdapter(adapter);
411              var db = Database.Open();
412              var firstId = db.Users.Insert(Name: "Marcus").Id;
413              Assert.AreEqual(1, firstId);
414          }
415          [Test]
416          public void SelectCountShouldReturnCount()
417          {
418              Database.UseMockAdapter(new InMemoryAdapter());
419              var db = Database.Open();
420              db.Test.Insert(Id: 1, Name: "Alice");
421              db.Test.Insert(Id: 2, Name: "Bob");
422              var count = db.Test.All().Count();
423              Assert.AreEqual(2, count);
424          }
425          [Test]
426          public void SelectExistsShouldReturnTrueForAnyRows()
427          {
428              Database.UseMockAdapter(new InMemoryAdapter());
429              var db = Database.Open();
430              db.Test.Insert(Id: 1, Name: "Alice");
431              db.Test.Insert(Id: 2, Name: "Bob");
432              Assert.IsTrue(db.Test.All().Exists());
433          }
434          [Test]
435          public void SelectExistsShouldReturnFalseForNoRows()
436          {
437              Database.UseMockAdapter(new InMemoryAdapter());
438              var db = Database.Open();
439              Assert.IsFalse(db.Test.All().Exists());
440          }
441          [Test]
442          public void ShouldBeAbleToUseCountOnTable()
443          {
444              Database.UseMockAdapter(new InMemoryAdapter());
445              var db = Database.Open();
446              db.Users.Insert(Id: 1, Name: "Bob", Age: 30);
447              db.Users.Insert(Id: 2, Name: "Alice", Age: 18);
448              db.Users.Insert(Id: 3, Name: "Maria", Age: 12);
449              db.Users.Insert(Id: 4, Name: "John", Age: 8);
450              var adults = db.Users.GetCount(db.Users.Age >= 18);
451              Assert.AreEqual(2, adults);
452          }
453          [Test]
454          public void ExistsByNameShouldReturnTrueForExistingData()
455          {
456              Database.UseMockAdapter(new InMemoryAdapter());
457              var db = Database.Open();
458              db.Users.Insert(Id: 1, Name: "Bob", Age: 30);
459              var bobExists = db.Users.ExistsByName("Bob");
460              Assert.AreEqual(true, bobExists);
461          }
462          [Test]
463          public void ExistsByNameShouldReturnFalseForNonExistingData()
464          {
465              Database.UseMockAdapter(new InMemoryAdapter());
466              var db = Database.Open();
467              db.Users.Insert(Id: 1, Name: "Alice", Age: 30);
468              var bobExists = db.Users.ExistsByName("Bob");
469              Assert.AreEqual(false, bobExists);
470          }
471          [Test]
472          public void ExistsByNameParameterShouldReturnTrueForExistingData()
473          {
474              Database.UseMockAdapter(new InMemoryAdapter());
475              var db = Database.Open();
476              db.Users.Insert(Id: 1, Name: "Bob", Age: 30);
477              var bobExists = db.Users.ExistsBy(Name: "Bob");
478              Assert.AreEqual(true, bobExists);
479          }
480          [Test]
481          public void ExistsByNameParameterShouldReturnFalseForNonExistingData()
482          {
483              Database.UseMockAdapter(new InMemoryAdapter());
484              var db = Database.Open();
485              db.Users.Insert(Id: 1, Name: "Alice", Age: 30);
486              var bobExists = db.Users.ExistsBy(Name: "Bob");
487              Assert.AreEqual(false, bobExists);
488          }
489          [Test]
490          public void BulkInsertWithCallbackShouldWork()
491          {
492              Database.UseMockAdapter(new InMemoryAdapter());
493              var db = Database.Open();
494              ErrorCallback callback = (o, e) => true; 
495              db.Users.Insert(new[] { new { Id = 1, Name = "Alice", Age = 30 }, new { Id = 2, Name = "Bob", Age = 40 } }, callback);
496              Assert.AreEqual(2, db.Users.GetCount());
497          }
498          [Test]
499          public void BulkInsertWithoutCallbackShouldWork()
500          {
501              Database.UseMockAdapter(new InMemoryAdapter());
502              var db = Database.Open();
503              ErrorCallback callback = (o, e) => true; 
504              db.Users.Insert(new[] { new { Id = 1, Name = "Alice", Age = 30 }, new { Id = 2, Name = "Bob", Age = 40 } });
505              Assert.AreEqual(2, db.Users.GetCount());
506          }
507          private static int ThreadTestHelper(int userId)
508          {
509              var mockAdapter = new InMemoryAdapter();
510              Database.UseMockAdapter(mockAdapter);
511              var db = Database.Open();
512              db.Users.Insert(Id: userId, Email: "foo");
513              return Database.Default.Users.FindByEmail("foo").Id;
514          }
515          [Test]
516          public void TestJoinWithAlias()
517          {
518              var adapter = new InMemoryAdapter();
519              adapter.ConfigureJoin("Customer", "ID", "Customer", "Orders", "CustomerID", "Orders");
520              Database.UseMockAdapter(adapter);
521              var db = Database.Open();
522              db.Customer.Insert(ID: 1, Name: "NASA");
523              db.Customer.Insert(ID: 2, Name: "ACME");
524              db.Orders.Insert(ID: 1, Name: "Order1", CustomerID: 1);
525              db.Orders.Insert(ID: 2, Name: "Order2", CustomerID: 2);
526              db.Orders.Insert(ID: 3, Name: "Order3", CustomerID: 2);
527              IEnumerable<dynamic> orders = db.Orders.Query()
528                  .Where(db.Orders.Customer.Name == "ACME")
529                  .Select(db.Orders.Name.As("OrderName"),
530                          db.Orders.Customer.Name.As("CustomerName"))
531                  .ToList();
532              Assert.IsNotNull(orders);
533              Assert.AreEqual(2, orders.Count());
534              Assert.AreEqual(2, orders.Count(x => x.CustomerName == "ACME"));
535          }
536          [Test]
537          public void InsertAndGetWithTransactionShouldWork()
538          {
539              var adapter = new InMemoryAdapter();
540              adapter.SetKeyColumn("Test", "Id");
541              Database.UseMockAdapter(adapter);
542              var db = Database.Open();
543              using (var tx = db.BeginTransaction())
544              {
545                  tx.Test.Insert(Id: 1, Name: "Alice");
546                  var record = tx.Test.Get(1);
547                  Assert.IsNotNull(record);
548                  Assert.AreEqual(1, record.Id);
549                  Assert.AreEqual("Alice", record.Name);
550              }
551          }
552          [Test]
553          public void ProcedureShouldWork()
554          {
555              var adapter = new InMemoryAdapter();
556              adapter.AddFunction("Test", () => new Dictionary<string,object> { { "Foo", "Bar"}});
557              Database.UseMockAdapter(adapter);
558              var db = Database.Open();
559              foreach (var row in db.Test())
560              {
561                  Assert.AreEqual("Bar", row.Foo);
562              }
563          }
564          [Test]
565          public void ProcedureWithParametersShouldWork()
566          {
567              var adapter = new InMemoryAdapter();
568              adapter.AddFunction<string,object,IDictionary<string,object>>("Test", (key, value) => new Dictionary<string, object> { { key, value } });
569              Database.UseMockAdapter(adapter);
570              var db = Database.Open();
571              foreach (var row in db.Test("Foo", "Bar"))
572              {
573                  Assert.AreEqual("Bar", row.Foo);
574              }
575          }
576          [Test]
577          public void ProcedureReturningArrayShouldWork()
578          {
579              var adapter = new InMemoryAdapter();
580              adapter.AddFunction("Test", () => new[] { new Dictionary<string, object> { { "Foo", "Bar" } } });
581              Database.UseMockAdapter(adapter);
582              var db = Database.Open();
583              foreach (var row in db.Test())
584              {
585                  Assert.AreEqual("Bar", row.Foo);
586              }
587          }
588          [Test]
589          public void ProcedureWithParametersReturningArrayShouldWork()
590          {
591              var adapter = new InMemoryAdapter();
592              adapter.AddFunction<string, object, IDictionary<string, object>[]>("Test", (key, value) => new IDictionary<string, object>[] {new Dictionary<string, object> { { key, value } }});
593              Database.UseMockAdapter(adapter);
594              var db = Database.Open();
595              foreach (var row in db.Test("Foo", "Bar"))
596              {
597                  Assert.AreEqual("Bar", row.Foo);
598              }
599          }
600          [Test]
601          public void CanSimulateProcedureWithOutputParameters()
602          {
603              const string key = "outparam";
604              const string value = "outParamValue";
605              var adapter = new InMemoryAdapter();
606              adapter.AddFunction("Test", p =>
607                  {
608                      p.Add(key, value);
609                      return p;
610                  });
611              Database.UseMockAdapter(adapter);
612              var db = Database.Open();
613              var result = db.Test();
614              Assert.That(result.OutputValues[key], Is.EqualTo(value));
615          }
616          [Test]
617          public void UpsertShouldAddNewRecord()
618          {
619              var adapter = new InMemoryAdapter();
620              adapter.SetKeyColumn("Test", "Id");
621              Database.UseMockAdapter(adapter);
622              var db = Database.Open();
623              db.Test.Upsert(Id: 1, SomeValue: "Testing");
624              var record = db.Test.Get(1);
625              Assert.IsNotNull(record);
626              Assert.AreEqual("Testing", record.SomeValue);
627          }
628          [Test]
629          public void UpsertShouldUpdateExistingRecord()
630          {
631              var adapater = new InMemoryAdapter();
632              adapater.SetKeyColumn("Test","Id");
633              Database.UseMockAdapter(adapater);
634              var db = Database.Open();
635              db.Test.Upsert(Id: 1, SomeValue: "Testing");
636              db.Test.Upsert(Id: 1, SomeValue: "Updated");
637              List<dynamic> allRecords = db.Test.All().ToList();
638              Assert.IsNotNull(allRecords);
639              Assert.AreEqual(1,allRecords.Count);
640              Assert.AreEqual("Updated", allRecords.Single().SomeValue);
641          }
642          [Test]
643          public void UpsertWithoutDefinedKeyColumnsShouldThrowMeaningfulException()
644          {
645              var adapter = new InMemoryAdapter();
646              Database.UseMockAdapter(adapter);
647              var db = Database.Open();
648              var exception = Assert.Throws<InvalidOperationException>(() => db.Test.Upsert(Id: 1, HasTowel: true));
649              Assert.AreEqual("No key columns defined for table \"Test\"", exception.Message);
650          }
651          [Test]
652          public void JoinTest()
653          {
654              Guid masterId = Guid.NewGuid();
655              InMemoryAdapter adapter = new InMemoryAdapter();
656              adapter.Join.Master("Master", "Id").Detail("Detail", "MasterId");
657              Database.UseMockAdapter(adapter);
658              var db = Database.Open();
659              db.Master.Insert(Id: masterId);
660              db.Detail.Insert(Id: Guid.NewGuid(), MasterId: masterId, Box: 999);
661              IEnumerable<dynamic> list = db.Detail.All()
662                  .Join(db.Master).On(db.Master.Id == db.Detail.MasterId)
663                  .Select(db.Master.Id, db.Detail.Box)
664                          .Cast<dynamic>();
665              dynamic detail = list.FirstOrDefault();
666              Assert.NotNull(detail);
667              Assert.That(detail.Id, Is.EqualTo(masterId));
668              Assert.That(detail.Box, Is.EqualTo(999));
669          }
670          [Test]
671          public void LeftJoinTest()
672          {
673              var adapter = new InMemoryAdapter();
674              adapter.SetKeyColumn("Events", "Id");
675              adapter.SetAutoIncrementColumn("Events", "Id");
676              adapter.SetKeyColumn("Doors", "Id");
677              adapter.SetAutoIncrementColumn("Doors", "Id");
678              adapter.Join.Master("Events", "Id").Detail("Doors", "EventId");
679              Database.UseMockAdapter(adapter);
680              var db = Database.Open();
681              db.Events.Insert(Id: 1, Code: "CodeMash2013", Name: "CodeMash 2013");
682              db.Events.Insert(Id: 2, Code: "SomewhereElse", Name: "Some Other Conf");
683              db.Doors.Insert(Id: 1, Code: "F7E08AC9-5E75-417D-A7AA-60E88B5B99AD", EventID: 1);
684              db.Doors.Insert(Id: 2, Code: "0631C802-2748-4C63-A6D9-CE8C803002EB", EventID: 1);
685              db.Doors.Insert(Id: 3, Code: "281ED88F-677D-49B9-84FA-4FAE022BBC73", EventID: 1);
686              db.Doors.Insert(Id: 4, Code: "9DF7E964-1ECE-42E3-8211-1F2BF7054A0D", EventID: 2);
687              db.Doors.Insert(Id: 5, Code: "9418123D-312A-4E8C-8807-59F0A63F43B9", EventID: 2);
688              List<dynamic> actual = db.Doors.FindAll(db.Doors.Events.Code == "CodeMash2013")
689                             .Select(db.Doors.Id, db.Events.Name)
690                             .ToList();
691              Assert.AreEqual(3, actual.Count);
692          }
693          [Test]
694          public void UpdateWithOriginalValuesRowsUpdatedShouldBeZeroIfNewValueAreSameAsOriginalValue()
695          {
696              var adapter = new InMemoryAdapter();
697              adapter.SetKeyColumn("Test", "Id");
698              Database.UseMockAdapter(adapter);
699              var db = Database.Open();
700              db.Test.Upsert(Id: 1, SomeValue: "Testing");
701              var record = db.Test.Get(1);
702              var record1 = record.Clone();
703              var rowsUpdated = db.Test.Update(record, record1);
704              Assert.AreEqual(0, rowsUpdated);
705          }
706      }
707  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-CreateStepSummaryCommandL0.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Simple.Data-MDEwOlJlcG9zaXRvcnk4MTg3Njg=-flat-InMemoryTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>44              using (var hostContext = Setup())
45              {
46                  var stepSummaryFile = Path.Combine(_rootDirectory, "directory-not-found", "env");
47                  _createStepCommand.ProcessCommand(_executionContext.Object, stepSummaryFile, null);
48                  _jobExecutionContext.Complete();
49                  _jobServerQueue.Verify(x => x.QueueFileUpload(It.IsAny<Guid>(), It.IsAny<Guid>(), It.IsAny<string>(), It.IsAny<string>(), It.IsAny<string>(), It.IsAny<bool>()), Times.Never());
50                  Assert.Equal(0, _issues.Count);
51              }
52          }
53          [Fact]
</pre></code></div>
                <div class="column column_space"><pre><code>122              db.Test.Insert(Id: 2, Name: "Bob");
123              List<IDictionary<string, object>> records = db.Test.All().Select(db.Test.Name).ToList<IDictionary<string, object>>();
124              Assert.IsNotNull(records);
125              Assert.AreEqual(2, records.Count);
126              Assert.False(records[0].ContainsKey("Id"));
127              Assert.True(records[0].ContainsKey("Name"));
128              Assert.False(records[1].ContainsKey("Id"));
129              Assert.True(records[1].ContainsKey("Name"));
130          }
131          [Test]
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    