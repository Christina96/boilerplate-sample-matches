
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 44, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-AuthorizationMiddlewareTests.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Linq;
4  using System.Security.Claims;
5  using System.Threading.Tasks;
6  using Microsoft.AspNetCore.Authentication;
7  using Microsoft.AspNetCore.Authorization;
8  using Microsoft.AspNetCore.Authorization.Infrastructure;
9  using Microsoft.AspNetCore.Authorization.Test.TestObjects;
10  using Microsoft.AspNetCore.Http;
11  using Microsoft.AspNetCore.Http.Endpoints;
12  using Microsoft.AspNetCore.Http.Features;
13  using Microsoft.Extensions.DependencyInjection;
14  using Microsoft.Extensions.Options;
15  using Moq;
16  using Xunit;
17  namespace Microsoft.AspNetCore.Authorization.Test
18  {
19      public class AuthorizationMiddlewareTests
20      {
21          [Fact]
22          public async Task NoEndpoint_AnonymousUser_Allows()
23          {
24              var policy = new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build();
25              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
26              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
27              var next = new TestRequestDelegate();
28              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
29              var context = GetHttpContext(anonymous: true);
30              await middleware.Invoke(context);
31              Assert.True(next.Called);
32          }
33          [Fact]
34          public async Task NoEndpointWithRequired_AnonymousUser_Challenges()
35          {
36              var policy = new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build();
37              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
38              policyProvider.Setup(p => p.GetRequiredPolicyAsync()).ReturnsAsync(policy);
39              var next = new TestRequestDelegate();
40              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
41              var context = GetHttpContext(anonymous: true);
42              await middleware.Invoke(context);
43              Assert.False(next.Called);
44          }
45          [Fact]
46          public async Task HasEndpointWithoutAuth_AnonymousUser_Allows()
47          {
48              var policy = new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build();
49              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
50              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
51              var next = new TestRequestDelegate();
52              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
53              var context = GetHttpContext(anonymous: true, endpoint: CreateEndpoint());
54              await middleware.Invoke(context);
55              Assert.True(next.Called);
56          }
57          [Fact]
58          public async Task HasEndpointWithRequiredWithoutAuth_AnonymousUser_Challenges()
59          {
60              var policy = new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build();
61              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
62              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
63              policyProvider.Setup(p => p.GetRequiredPolicyAsync()).ReturnsAsync(policy);
64              var next = new TestRequestDelegate();
65              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
66              var context = GetHttpContext(anonymous: true, endpoint: CreateEndpoint());
67              await middleware.Invoke(context);
68              Assert.False(next.Called);
69          }
70          [Fact]
71          public async Task HasEndpointWithAuth_AnonymousUser_Challenges()
72          {
73              var policy = new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build();
74              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
75              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
76              var next = new TestRequestDelegate();
77              var authenticationService = new TestAuthenticationService();
78              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
79              var context = GetHttpContext(anonymous: true, endpoint: CreateEndpoint(new AuthorizeAttribute()), authenticationService: authenticationService);
80              await middleware.Invoke(context);
81              Assert.False(next.Called);
82              Assert.True(authenticationService.ChallengeCalled);
83          }
84          [Fact]
85          public async Task HasEndpointWithAuth_AnonymousUser_ChallengePerScheme()
86          {
87              var policy = new AuthorizationPolicyBuilder().RequireAuthenticatedUser().AddAuthenticationSchemes("schema1", "schema2").Build();
88              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
89              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
90              var next = new TestRequestDelegate();
91              var authenticationService = new TestAuthenticationService();
92              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
93              var context = GetHttpContext(anonymous: true, endpoint: CreateEndpoint(new AuthorizeAttribute()), authenticationService: authenticationService);
94              await middleware.Invoke(context);
95              Assert.False(next.Called);
96              Assert.Equal(2, authenticationService.ChallengeCount);
97          }
98          [Fact]
99          public async Task OnAuthorizationAsync_WillCallPolicyProvider()
100          {
101              var policy = new AuthorizationPolicyBuilder().RequireAssertion(_ => true).Build();
102              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
103              var getPolicyCount = 0;
104              var getRequiredPolicyCount = 0;
105              policyProvider.Setup(p => p.GetPolicyAsync(It.IsAny<string>())).ReturnsAsync(policy)
106                  .Callback(() => getPolicyCount++);
107              policyProvider.Setup(p => p.GetRequiredPolicyAsync()).ReturnsAsync(policy)
108                  .Callback(() => getRequiredPolicyCount++);
109              var next = new TestRequestDelegate();
110              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
111              var context = GetHttpContext(anonymous: true, endpoint: CreateEndpoint(new AuthorizeAttribute("whatever")));
112              await middleware.Invoke(context);
113              Assert.Equal(1, getPolicyCount);
114              Assert.Equal(1, getRequiredPolicyCount);
115              Assert.Equal(1, next.CalledCount);
116              await middleware.Invoke(context);
117              Assert.Equal(2, getPolicyCount);
118              Assert.Equal(2, getRequiredPolicyCount);
119              Assert.Equal(2, next.CalledCount);
120              await middleware.Invoke(context);
121              Assert.Equal(3, getPolicyCount);
122              Assert.Equal(3, getRequiredPolicyCount);
123              Assert.Equal(3, next.CalledCount);
124          }
125          [Fact]
126          public async Task Invoke_ValidClaimShouldNotFail()
127          {
128              var policy = new AuthorizationPolicyBuilder().RequireClaim("Permission", "CanViewPage").Build();
129              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
130              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
131              var next = new TestRequestDelegate();
132              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
133              var context = GetHttpContext(endpoint: CreateEndpoint(new AuthorizeAttribute()));
134              await middleware.Invoke(context);
135              Assert.True(next.Called);
136          }
137          [Fact]
138          public async Task HasEndpointWithAuthAndAllowAnonymous_AnonymousUser_Allows()
139          {
140              var policy = new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build();
141              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
142              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
143              var next = new TestRequestDelegate();
144              var authenticationService = new TestAuthenticationService();
145              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
146              var context = GetHttpContext(anonymous: true, endpoint: CreateEndpoint(new AuthorizeAttribute(), new AllowAnonymousAttribute()), authenticationService: authenticationService);
147              await middleware.Invoke(context);
148              Assert.True(next.Called);
149              Assert.False(authenticationService.ChallengeCalled);
150          }
151          [Fact]
152          public async Task HasEndpointWithAuth_AuthenticatedUser_Allows()
153          {
154              var policy = new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build();
155              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
156              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
157              var next = new TestRequestDelegate();
158              var authenticationService = new TestAuthenticationService();
159              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
160              var context = GetHttpContext(endpoint: CreateEndpoint(new AuthorizeAttribute()), authenticationService: authenticationService);
161              await middleware.Invoke(context);
162              Assert.True(next.Called);
163              Assert.False(authenticationService.ChallengeCalled);
164          }
165          [Fact]
166          public async Task Invoke_AuthSchemesFailShouldSetEmptyPrincipalOnContext()
167          {
168              var policy = new AuthorizationPolicyBuilder("Fails").RequireAuthenticatedUser().Build();
169              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
170              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
171              var next = new TestRequestDelegate();
172              var authenticationService = new TestAuthenticationService();
173              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
174              var context = GetHttpContext(endpoint: CreateEndpoint(new AuthorizeAttribute()), authenticationService: authenticationService);
175              await middleware.Invoke(context);
176              Assert.False(next.Called);
177              Assert.NotNull(context.User?.Identity);
178              Assert.True(authenticationService.AuthenticateCalled);
179              Assert.True(authenticationService.ChallengeCalled);
180          }
181          [Fact]
182          public async Task Invoke_SingleValidClaimShouldSucceed()
183          {
184              var policy = new AuthorizationPolicyBuilder().RequireClaim("Permission", "CanViewComment", "CanViewPage").Build();
185              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
186              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
187              var next = new TestRequestDelegate();
188              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
<span onclick='openModal()' class='match'>189              var context = GetHttpContext(endpoint: CreateEndpoint(new AuthorizeAttribute()));
190              await middleware.Invoke(context);
191              Assert.True(next.Called);
192          }
193          [Fact]
194          public async Task AuthZResourceShouldBeEndpoint()
195          {
196              object resource = null;
</span>197              var policy = new AuthorizationPolicyBuilder().RequireAssertion(c =>
198              {
199                  resource = c.Resource;
200                  return true;
201              }).Build();
202              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
203              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
204              var next = new TestRequestDelegate();
205              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
206              var endpoint = CreateEndpoint(new AuthorizeAttribute());
207              var context = GetHttpContext(endpoint: endpoint);
208              await middleware.Invoke(context);
209              Assert.Equal(endpoint, resource);
210          }
211          [Fact]
212          public async Task Invoke_RequireUnknownRoleShouldForbid()
213          {
214              var policy = new AuthorizationPolicyBuilder().RequireRole("Wut").Build();
215              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
216              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
217              var next = new TestRequestDelegate();
218              var authenticationService = new TestAuthenticationService();
219              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
220              var context = GetHttpContext(endpoint: CreateEndpoint(new AuthorizeAttribute()), authenticationService: authenticationService);
221              await middleware.Invoke(context);
222              Assert.False(next.Called);
223              Assert.False(authenticationService.ChallengeCalled);
224              Assert.True(authenticationService.ForbidCalled);
225          }
226          [Fact]
227          public async Task Invoke_RequireUnknownRole_ForbidPerScheme()
228          {
229              var policy = new AuthorizationPolicyBuilder().RequireRole("Wut").AddAuthenticationSchemes("Basic", "Bearer").Build();
230              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
231              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
232              var next = new TestRequestDelegate();
233              var authenticationService = new TestAuthenticationService();
234              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
235              var context = GetHttpContext(endpoint: CreateEndpoint(new AuthorizeAttribute()), authenticationService: authenticationService);
236              await middleware.Invoke(context);
237              Assert.False(next.Called);
238              Assert.Equal(2, authenticationService.ForbidCount);
239          }
240          [Fact]
241          public async Task Invoke_InvalidClaimShouldForbid()
242          {
243              var policy = new AuthorizationPolicyBuilder()
244                  .RequireClaim("Permission", "CanViewComment")
245                  .Build();
246              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
247              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
248              var next = new TestRequestDelegate();
249              var authenticationService = new TestAuthenticationService();
250              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
251              var context = GetHttpContext(endpoint: CreateEndpoint(new AuthorizeAttribute()), authenticationService: authenticationService);
252              await middleware.Invoke(context);
253              Assert.False(next.Called);
254              Assert.False(authenticationService.ChallengeCalled);
255              Assert.True(authenticationService.ForbidCalled);
256          }
257          private AuthorizationMiddleware CreateMiddleware(RequestDelegate requestDelegate = null, IAuthorizationPolicyProvider policyProvider = null)
258          {
259              requestDelegate = requestDelegate ?? ((context) => Task.CompletedTask);
260              return new AuthorizationMiddleware(requestDelegate, policyProvider);
261          }
262          private Endpoint CreateEndpoint(params object[] metadata)
263          {
264              return new Endpoint(context => Task.CompletedTask, new EndpointMetadataCollection(metadata), "Test endpoint");
265          }
266          private HttpContext GetHttpContext(
267              bool anonymous = false,
268              Action<IServiceCollection> registerServices = null,
269              Endpoint endpoint = null,
270              IAuthenticationService authenticationService = null)
271          {
272              var basicPrincipal = new ClaimsPrincipal(
273                  new ClaimsIdentity(
274                      new Claim[] {
275                          new Claim("Permission", "CanViewPage"),
276                          new Claim(ClaimTypes.Role, "Administrator"),
277                          new Claim(ClaimTypes.Role, "User"),
278                          new Claim(ClaimTypes.NameIdentifier, "John")},
279                          "Basic"));
280              var validUser = basicPrincipal;
281              var bearerIdentity = new ClaimsIdentity(
282                      new Claim[] {
283                          new Claim("Permission", "CupBearer"),
284                          new Claim(ClaimTypes.Role, "Token"),
285                          new Claim(ClaimTypes.NameIdentifier, "John Bear")},
286                          "Bearer");
287              validUser.AddIdentity(bearerIdentity);
288              var serviceCollection = new ServiceCollection();
289              authenticationService = authenticationService ?? Mock.Of<IAuthenticationService>();
290              serviceCollection.AddSingleton(authenticationService);
291              serviceCollection.AddOptions();
292              serviceCollection.AddLogging();
293              serviceCollection.AddAuthorization();
294              serviceCollection.AddAuthorizationPolicyEvaluator();
295              registerServices?.Invoke(serviceCollection);
296              var serviceProvider = serviceCollection.BuildServiceProvider();
297              var httpContext = new DefaultHttpContext();
298              if (endpoint != null)
299              {
300                  httpContext.SetEndpoint(endpoint);
301              }
302              httpContext.RequestServices = serviceProvider;
303              if (!anonymous)
304              {
305                  httpContext.User = validUser;
306              }
307              return httpContext;
308          }
309          private class TestRequestDelegate
310          {
311              private readonly int _statusCode;
312              public bool Called => CalledCount > 0;
313              public int CalledCount { get; private set; }
314              public TestRequestDelegate(int statusCode = 200)
315              {
316                  _statusCode = statusCode;
317              }
318              public Task Invoke(HttpContext context)
319              {
320                  CalledCount++;
321                  context.Response.StatusCode = _statusCode;
322                  return Task.CompletedTask;
323              }
324          }
325      }
326  }
</code></pre>
        </div>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-AuthorizationMiddlewareTests.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Linq;
4  using System.Security.Claims;
5  using System.Threading.Tasks;
6  using Microsoft.AspNetCore.Authentication;
7  using Microsoft.AspNetCore.Authorization;
8  using Microsoft.AspNetCore.Authorization.Infrastructure;
9  using Microsoft.AspNetCore.Authorization.Test.TestObjects;
10  using Microsoft.AspNetCore.Http;
11  using Microsoft.AspNetCore.Http.Endpoints;
12  using Microsoft.AspNetCore.Http.Features;
13  using Microsoft.Extensions.DependencyInjection;
14  using Microsoft.Extensions.Options;
15  using Moq;
16  using Xunit;
17  namespace Microsoft.AspNetCore.Authorization.Test
18  {
19      public class AuthorizationMiddlewareTests
20      {
21          [Fact]
22          public async Task NoEndpoint_AnonymousUser_Allows()
23          {
24              var policy = new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build();
25              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
26              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
27              var next = new TestRequestDelegate();
28              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
29              var context = GetHttpContext(anonymous: true);
30              await middleware.Invoke(context);
31              Assert.True(next.Called);
32          }
33          [Fact]
34          public async Task NoEndpointWithRequired_AnonymousUser_Challenges()
35          {
36              var policy = new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build();
37              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
38              policyProvider.Setup(p => p.GetRequiredPolicyAsync()).ReturnsAsync(policy);
39              var next = new TestRequestDelegate();
40              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
41              var context = GetHttpContext(anonymous: true);
42              await middleware.Invoke(context);
43              Assert.False(next.Called);
44          }
45          [Fact]
46          public async Task HasEndpointWithoutAuth_AnonymousUser_Allows()
47          {
48              var policy = new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build();
49              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
50              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
51              var next = new TestRequestDelegate();
52              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
53              var context = GetHttpContext(anonymous: true, endpoint: CreateEndpoint());
54              await middleware.Invoke(context);
55              Assert.True(next.Called);
56          }
57          [Fact]
58          public async Task HasEndpointWithRequiredWithoutAuth_AnonymousUser_Challenges()
59          {
60              var policy = new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build();
61              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
62              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
63              policyProvider.Setup(p => p.GetRequiredPolicyAsync()).ReturnsAsync(policy);
64              var next = new TestRequestDelegate();
65              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
66              var context = GetHttpContext(anonymous: true, endpoint: CreateEndpoint());
67              await middleware.Invoke(context);
68              Assert.False(next.Called);
69          }
70          [Fact]
71          public async Task HasEndpointWithAuth_AnonymousUser_Challenges()
72          {
73              var policy = new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build();
74              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
75              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
76              var next = new TestRequestDelegate();
77              var authenticationService = new TestAuthenticationService();
78              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
79              var context = GetHttpContext(anonymous: true, endpoint: CreateEndpoint(new AuthorizeAttribute()), authenticationService: authenticationService);
80              await middleware.Invoke(context);
81              Assert.False(next.Called);
82              Assert.True(authenticationService.ChallengeCalled);
83          }
84          [Fact]
85          public async Task HasEndpointWithAuth_AnonymousUser_ChallengePerScheme()
86          {
87              var policy = new AuthorizationPolicyBuilder().RequireAuthenticatedUser().AddAuthenticationSchemes("schema1", "schema2").Build();
88              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
89              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
90              var next = new TestRequestDelegate();
91              var authenticationService = new TestAuthenticationService();
92              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
93              var context = GetHttpContext(anonymous: true, endpoint: CreateEndpoint(new AuthorizeAttribute()), authenticationService: authenticationService);
94              await middleware.Invoke(context);
95              Assert.False(next.Called);
96              Assert.Equal(2, authenticationService.ChallengeCount);
97          }
98          [Fact]
99          public async Task OnAuthorizationAsync_WillCallPolicyProvider()
100          {
101              var policy = new AuthorizationPolicyBuilder().RequireAssertion(_ => true).Build();
102              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
103              var getPolicyCount = 0;
104              var getRequiredPolicyCount = 0;
105              policyProvider.Setup(p => p.GetPolicyAsync(It.IsAny<string>())).ReturnsAsync(policy)
106                  .Callback(() => getPolicyCount++);
107              policyProvider.Setup(p => p.GetRequiredPolicyAsync()).ReturnsAsync(policy)
108                  .Callback(() => getRequiredPolicyCount++);
109              var next = new TestRequestDelegate();
110              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
111              var context = GetHttpContext(anonymous: true, endpoint: CreateEndpoint(new AuthorizeAttribute("whatever")));
112              await middleware.Invoke(context);
113              Assert.Equal(1, getPolicyCount);
114              Assert.Equal(1, getRequiredPolicyCount);
115              Assert.Equal(1, next.CalledCount);
116              await middleware.Invoke(context);
117              Assert.Equal(2, getPolicyCount);
118              Assert.Equal(2, getRequiredPolicyCount);
119              Assert.Equal(2, next.CalledCount);
120              await middleware.Invoke(context);
121              Assert.Equal(3, getPolicyCount);
122              Assert.Equal(3, getRequiredPolicyCount);
123              Assert.Equal(3, next.CalledCount);
124          }
125          [Fact]
126          public async Task Invoke_ValidClaimShouldNotFail()
127          {
128              var policy = new AuthorizationPolicyBuilder().RequireClaim("Permission", "CanViewPage").Build();
129              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
130              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
131              var next = new TestRequestDelegate();
132              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
<span onclick='openModal()' class='match'>133              var context = GetHttpContext(endpoint: CreateEndpoint(new AuthorizeAttribute()));
134              await middleware.Invoke(context);
135              Assert.True(next.Called);
136          }
137          [Fact]
138          public async Task HasEndpointWithAuthAndAllowAnonymous_AnonymousUser_Allows()
139          {
140              var policy = new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build();
</span>141              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
142              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
143              var next = new TestRequestDelegate();
144              var authenticationService = new TestAuthenticationService();
145              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
146              var context = GetHttpContext(anonymous: true, endpoint: CreateEndpoint(new AuthorizeAttribute(), new AllowAnonymousAttribute()), authenticationService: authenticationService);
147              await middleware.Invoke(context);
148              Assert.True(next.Called);
149              Assert.False(authenticationService.ChallengeCalled);
150          }
151          [Fact]
152          public async Task HasEndpointWithAuth_AuthenticatedUser_Allows()
153          {
154              var policy = new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build();
155              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
156              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
157              var next = new TestRequestDelegate();
158              var authenticationService = new TestAuthenticationService();
159              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
160              var context = GetHttpContext(endpoint: CreateEndpoint(new AuthorizeAttribute()), authenticationService: authenticationService);
161              await middleware.Invoke(context);
162              Assert.True(next.Called);
163              Assert.False(authenticationService.ChallengeCalled);
164          }
165          [Fact]
166          public async Task Invoke_AuthSchemesFailShouldSetEmptyPrincipalOnContext()
167          {
168              var policy = new AuthorizationPolicyBuilder("Fails").RequireAuthenticatedUser().Build();
169              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
170              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
171              var next = new TestRequestDelegate();
172              var authenticationService = new TestAuthenticationService();
173              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
174              var context = GetHttpContext(endpoint: CreateEndpoint(new AuthorizeAttribute()), authenticationService: authenticationService);
175              await middleware.Invoke(context);
176              Assert.False(next.Called);
177              Assert.NotNull(context.User?.Identity);
178              Assert.True(authenticationService.AuthenticateCalled);
179              Assert.True(authenticationService.ChallengeCalled);
180          }
181          [Fact]
182          public async Task Invoke_SingleValidClaimShouldSucceed()
183          {
184              var policy = new AuthorizationPolicyBuilder().RequireClaim("Permission", "CanViewComment", "CanViewPage").Build();
185              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
186              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
187              var next = new TestRequestDelegate();
188              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
189              var context = GetHttpContext(endpoint: CreateEndpoint(new AuthorizeAttribute()));
190              await middleware.Invoke(context);
191              Assert.True(next.Called);
192          }
193          [Fact]
194          public async Task AuthZResourceShouldBeEndpoint()
195          {
196              object resource = null;
197              var policy = new AuthorizationPolicyBuilder().RequireAssertion(c =>
198              {
199                  resource = c.Resource;
200                  return true;
201              }).Build();
202              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
203              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
204              var next = new TestRequestDelegate();
205              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
206              var endpoint = CreateEndpoint(new AuthorizeAttribute());
207              var context = GetHttpContext(endpoint: endpoint);
208              await middleware.Invoke(context);
209              Assert.Equal(endpoint, resource);
210          }
211          [Fact]
212          public async Task Invoke_RequireUnknownRoleShouldForbid()
213          {
214              var policy = new AuthorizationPolicyBuilder().RequireRole("Wut").Build();
215              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
216              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
217              var next = new TestRequestDelegate();
218              var authenticationService = new TestAuthenticationService();
219              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
220              var context = GetHttpContext(endpoint: CreateEndpoint(new AuthorizeAttribute()), authenticationService: authenticationService);
221              await middleware.Invoke(context);
222              Assert.False(next.Called);
223              Assert.False(authenticationService.ChallengeCalled);
224              Assert.True(authenticationService.ForbidCalled);
225          }
226          [Fact]
227          public async Task Invoke_RequireUnknownRole_ForbidPerScheme()
228          {
229              var policy = new AuthorizationPolicyBuilder().RequireRole("Wut").AddAuthenticationSchemes("Basic", "Bearer").Build();
230              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
231              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
232              var next = new TestRequestDelegate();
233              var authenticationService = new TestAuthenticationService();
234              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
235              var context = GetHttpContext(endpoint: CreateEndpoint(new AuthorizeAttribute()), authenticationService: authenticationService);
236              await middleware.Invoke(context);
237              Assert.False(next.Called);
238              Assert.Equal(2, authenticationService.ForbidCount);
239          }
240          [Fact]
241          public async Task Invoke_InvalidClaimShouldForbid()
242          {
243              var policy = new AuthorizationPolicyBuilder()
244                  .RequireClaim("Permission", "CanViewComment")
245                  .Build();
246              var policyProvider = new Mock<IAuthorizationPolicyProvider>();
247              policyProvider.Setup(p => p.GetDefaultPolicyAsync()).ReturnsAsync(policy);
248              var next = new TestRequestDelegate();
249              var authenticationService = new TestAuthenticationService();
250              var middleware = CreateMiddleware(next.Invoke, policyProvider.Object);
251              var context = GetHttpContext(endpoint: CreateEndpoint(new AuthorizeAttribute()), authenticationService: authenticationService);
252              await middleware.Invoke(context);
253              Assert.False(next.Called);
254              Assert.False(authenticationService.ChallengeCalled);
255              Assert.True(authenticationService.ForbidCalled);
256          }
257          private AuthorizationMiddleware CreateMiddleware(RequestDelegate requestDelegate = null, IAuthorizationPolicyProvider policyProvider = null)
258          {
259              requestDelegate = requestDelegate ?? ((context) => Task.CompletedTask);
260              return new AuthorizationMiddleware(requestDelegate, policyProvider);
261          }
262          private Endpoint CreateEndpoint(params object[] metadata)
263          {
264              return new Endpoint(context => Task.CompletedTask, new EndpointMetadataCollection(metadata), "Test endpoint");
265          }
266          private HttpContext GetHttpContext(
267              bool anonymous = false,
268              Action<IServiceCollection> registerServices = null,
269              Endpoint endpoint = null,
270              IAuthenticationService authenticationService = null)
271          {
272              var basicPrincipal = new ClaimsPrincipal(
273                  new ClaimsIdentity(
274                      new Claim[] {
275                          new Claim("Permission", "CanViewPage"),
276                          new Claim(ClaimTypes.Role, "Administrator"),
277                          new Claim(ClaimTypes.Role, "User"),
278                          new Claim(ClaimTypes.NameIdentifier, "John")},
279                          "Basic"));
280              var validUser = basicPrincipal;
281              var bearerIdentity = new ClaimsIdentity(
282                      new Claim[] {
283                          new Claim("Permission", "CupBearer"),
284                          new Claim(ClaimTypes.Role, "Token"),
285                          new Claim(ClaimTypes.NameIdentifier, "John Bear")},
286                          "Bearer");
287              validUser.AddIdentity(bearerIdentity);
288              var serviceCollection = new ServiceCollection();
289              authenticationService = authenticationService ?? Mock.Of<IAuthenticationService>();
290              serviceCollection.AddSingleton(authenticationService);
291              serviceCollection.AddOptions();
292              serviceCollection.AddLogging();
293              serviceCollection.AddAuthorization();
294              serviceCollection.AddAuthorizationPolicyEvaluator();
295              registerServices?.Invoke(serviceCollection);
296              var serviceProvider = serviceCollection.BuildServiceProvider();
297              var httpContext = new DefaultHttpContext();
298              if (endpoint != null)
299              {
300                  httpContext.SetEndpoint(endpoint);
301              }
302              httpContext.RequestServices = serviceProvider;
303              if (!anonymous)
304              {
305                  httpContext.User = validUser;
306              }
307              return httpContext;
308          }
309          private class TestRequestDelegate
310          {
311              private readonly int _statusCode;
312              public bool Called => CalledCount > 0;
313              public int CalledCount { get; private set; }
314              public TestRequestDelegate(int statusCode = 200)
315              {
316                  _statusCode = statusCode;
317              }
318              public Task Invoke(HttpContext context)
319              {
320                  CalledCount++;
321                  context.Response.StatusCode = _statusCode;
322                  return Task.CompletedTask;
323              }
324          }
325      }
326  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-AuthorizationMiddlewareTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-AuthorizationMiddlewareTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>189              var context = GetHttpContext(endpoint: CreateEndpoint(new AuthorizeAttribute()));
190              await middleware.Invoke(context);
191              Assert.True(next.Called);
192          }
193          [Fact]
194          public async Task AuthZResourceShouldBeEndpoint()
195          {
196              object resource = null;
</pre></code></div>
                <div class="column column_space"><pre><code>133              var context = GetHttpContext(endpoint: CreateEndpoint(new AuthorizeAttribute()));
134              await middleware.Invoke(context);
135              Assert.True(next.Called);
136          }
137          [Fact]
138          public async Task HasEndpointWithAuthAndAllowAnonymous_AnonymousUser_Allows()
139          {
140              var policy = new AuthorizationPolicyBuilder().RequireAuthenticatedUser().Build();
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    