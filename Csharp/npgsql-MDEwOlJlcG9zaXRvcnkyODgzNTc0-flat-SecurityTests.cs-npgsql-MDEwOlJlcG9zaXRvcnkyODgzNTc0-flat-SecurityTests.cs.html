
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 59, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-SecurityTests.cs</h3>
            <pre><code>1  using System;
2  using System.Security.Authentication;
3  using System.Threading;
4  using System.Threading.Tasks;
5  using Npgsql.Properties;
6  using NUnit.Framework;
7  using static Npgsql.Tests.TestUtil;
8  namespace Npgsql.Tests;
9  public class SecurityTests : TestBase
10  {
11      [Test, Description("Establishes an SSL connection, assuming a self-signed server certificate")]
12      public void Basic_ssl()
13      {
14          using var dataSource = CreateDataSource(csb =>
15          {
16              csb.SslMode = SslMode.Require;
17              csb.TrustServerCertificate = true;
18          });
19          using var conn = dataSource.OpenConnection();
20          Assert.That(conn.IsSecure, Is.True);
21      }
22      [Test, Description("Default user must run with md5 password encryption")]
23      public void Default_user_uses_md5_password()
24      {
25          if (!IsOnBuildServer)
26              Assert.Ignore("Only executed in CI");
27          using var dataSource = CreateDataSource(csb =>
28          {
29              csb.SslMode = SslMode.Require;
30              csb.TrustServerCertificate = true;
31          });
32          using var conn = dataSource.OpenConnection();
33          Assert.That(conn.IsScram, Is.False);
34          Assert.That(conn.IsScramPlus, Is.False);
35      }
36      [Test, Description("Makes sure a certificate whose root CA isn't known isn't accepted")]
37      public void Reject_self_signed_certificate([Values(SslMode.VerifyCA, SslMode.VerifyFull)] SslMode sslMode)
38      {
39          var csb = new NpgsqlConnectionStringBuilder(ConnectionString)
40          {
41              SslMode = sslMode,
42              CheckCertificateRevocation = false,
43          };
44          using var _ = CreateTempPool(csb, out var connString);
45          using var conn = new NpgsqlConnection(connString);
46          var ex = Assert.Throws<NpgsqlException>(conn.Open)!;
47          Assert.That(ex.InnerException, Is.TypeOf<AuthenticationException>());
48      }
49      [Test, Description("Makes sure that ssl_renegotiation_limit is always 0, renegotiation is buggy")]
50      public void No_ssl_renegotiation()
51      {
52          using var dataSource = CreateDataSource(csb =>
53          {
54              csb.SslMode = SslMode.Require;
55              csb.TrustServerCertificate = true;
56          });
57          using var conn = dataSource.OpenConnection();
58          Assert.That(conn.ExecuteScalar("SHOW ssl_renegotiation_limit"), Is.EqualTo("0"));
59          conn.ExecuteNonQuery("DISCARD ALL");
60          Assert.That(conn.ExecuteScalar("SHOW ssl_renegotiation_limit"), Is.EqualTo("0"));
61      }
62      [Test, Description("Makes sure that when SSL is disabled IsSecure returns false")]
63      public void IsSecure_without_ssl()
64      {
65          using var dataSource = CreateDataSource(csb => csb.SslMode = SslMode.Disable);
66          using var conn = dataSource.OpenConnection();
67          Assert.That(conn.IsSecure, Is.False);
68      }
69      [Test, Explicit("Needs to be set up (and run with with Kerberos credentials on Linux)")]
70      public void IntegratedSecurity_with_Username()
71      {
72          var username = Environment.UserName;
73          if (username == null)
74              throw new Exception("Could find username");
75          var connString = new NpgsqlConnectionStringBuilder(ConnectionString)
76          {
77              Username = username,
78              Password = null
79          }.ToString();
80          using var conn = new NpgsqlConnection(connString);
81          try
82          {
83              conn.Open();
84          }
85          catch (Exception e)
86          {
87              if (IsOnBuildServer)
88                  throw;
89              Console.WriteLine(e);
90              Assert.Ignore("Integrated security (GSS/SSPI) doesn't seem to be set up");
91          }
92      }
93      [Test, Explicit("Needs to be set up (and run with with Kerberos credentials on Linux)")]
94      public void IntegratedSecurity_without_Username()
95      {
96          var connString = new NpgsqlConnectionStringBuilder(ConnectionString)
97          {
98              Username = null,
99              Password = null
100          }.ToString();
101          using var conn = new NpgsqlConnection(connString);
102          try
103          {
104              conn.Open();
105          }
106          catch (Exception e)
107          {
108              if (IsOnBuildServer)
109                  throw;
110              Console.WriteLine(e);
111              Assert.Ignore("Integrated security (GSS/SSPI) doesn't seem to be set up");
112          }
113      }
114      [Test, Explicit("Needs to be set up (and run with with Kerberos credentials on Linux)")]
115      public void Connection_database_is_populated_on_Open()
116      {
117          var connString = new NpgsqlConnectionStringBuilder(ConnectionString)
118          {
119              Username = null,
<span onclick='openModal()' class='match'>120              Password = null,
121              Database = null
122          }.ToString();
123          using var conn = new NpgsqlConnection(connString);
124          try
125          {
126              conn.Open();
127          }
128          catch (Exception e)
129          {
130              if (IsOnBuildServer)
131                  throw;
132              Console.WriteLine(e);
133              Assert.Ignore("Integrated security (GSS/SSPI) doesn't seem to be set up");
134          }
135          Assert.That(conn.Database, Is.Not.Null);
</span>136      }
137      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1718")]
138      public void Bug1718()
139      {
140          using var dataSource = CreateDataSource(csb =>
141          {
142              csb.SslMode = SslMode.Require;
143              csb.TrustServerCertificate = true;
144          });
145          using var conn = dataSource.OpenConnection();
146          using var cmd = CreateSleepCommand(conn, 10000);
147          var cts = new CancellationTokenSource(1000).Token;
148          Assert.That(async () => await cmd.ExecuteNonQueryAsync(cts), Throws.Exception
149              .TypeOf<OperationCanceledException>()
150              .With.InnerException.TypeOf<PostgresException>()
151              .With.InnerException.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.QueryCanceled));
152      }
153      [Test]
154      public void ScramPlus()
155      {
156          try
157          {
158              using var dataSource = CreateDataSource(csb =>
159              {
160                  csb.SslMode = SslMode.Require;
161                  csb.Username = "npgsql_tests_scram";
162                  csb.Password = "npgsql_tests_scram";
163                  csb.TrustServerCertificate = true;
164              });
165              using var conn = dataSource.OpenConnection();
166              if (conn.PostgreSqlVersion.Major >= 11)
167              {
168                  Assert.That(conn.IsScramPlus, Is.True);
169              }
170          }
171          catch (Exception e) when (!IsOnBuildServer)
172          {
173              Console.WriteLine(e);
174              Assert.Ignore("scram-sha-256-plus doesn't seem to be set up");
175          }
176      }
177      [Test]
178      public async Task Connect_with_only_ssl_allowed_user([Values] bool multiplexing, [Values] bool keepAlive)
179      {
180          if (multiplexing && keepAlive)
181          {
182              Assert.Ignore("Multiplexing doesn't support keepalive");
183          }
184          try
185          {
186              await using var dataSource = CreateDataSource(csb =>
187              {
188                  csb.SslMode = SslMode.Allow;
189                  csb.Username = "npgsql_tests_ssl";
190                  csb.Password = "npgsql_tests_ssl";
191                  csb.Multiplexing = multiplexing;
192                  csb.KeepAlive = keepAlive ? 10 : 0;
193              });
194              await using var conn = await dataSource.OpenConnectionAsync();
195              Assert.IsTrue(conn.IsSecure);
196          }
197          catch (Exception e) when (!IsOnBuildServer)
198          {
199              Console.WriteLine(e);
200              Assert.Ignore("Only ssl user doesn't seem to be set up");
201          }
202      }
203      [Test]
204      public void SslMode_Require_throws_without_TSC()
205      {
206          using var dataSource = CreateDataSource(csb => csb.SslMode = SslMode.Require);
207          var ex = Assert.ThrowsAsync<ArgumentException>(async () => await dataSource.OpenConnectionAsync())!;
208          Assert.That(ex.Message, Is.EqualTo(NpgsqlStrings.CannotUseSslModeRequireWithoutTrustServerCertificate));
209      }
210      [Test]
211      public async Task SslMode_Require_with_callback_without_TSC()
212      {
213          await using var dataSource = CreateDataSource(csb =>
214          {
215              csb.SslMode = SslMode.Require;
216              csb.TrustServerCertificate = false;
217              csb.Pooling = false;
218          });
219          await using var connection = dataSource.CreateConnection();
220          connection.UserCertificateValidationCallback = (_, _, _, _) => true;
221          await connection.OpenAsync();
222      }
223      [Test]
224      public async Task Connect_with_only_non_ssl_allowed_user([Values] bool multiplexing, [Values] bool keepAlive)
225      {
226          if (multiplexing && keepAlive)
227          {
228              Assert.Ignore("Multiplexing doesn't support keepalive");
229          }
230          try
231          {
232              await using var dataSource = CreateDataSource(csb =>
233              {
234                  csb.SslMode = SslMode.Prefer;
235                  csb.Username = "npgsql_tests_nossl";
236                  csb.Password = "npgsql_tests_nossl";
237                  csb.Multiplexing = multiplexing;
238                  csb.KeepAlive = keepAlive ? 10 : 0;
239              });
240              await using var conn = await dataSource.OpenConnectionAsync();
241              Assert.IsFalse(conn.IsSecure);
242          }
243          catch (Exception e) when (!IsOnBuildServer)
244          {
245              Console.WriteLine(e);
246              Assert.Ignore("Only nonssl user doesn't seem to be set up");
247          }
248      }
249      [Test]
250      public async Task DataSource_UserCertificateValidationCallback_is_invoked([Values] bool acceptCertificate)
251      {
252          var callbackWasInvoked = false;
253          var dataSourceBuilder = CreateDataSourceBuilder();
254          dataSourceBuilder.ConnectionStringBuilder.SslMode = SslMode.Require;
255          dataSourceBuilder.UseUserCertificateValidationCallback((_, _, _, _) =>
256          {
257              callbackWasInvoked = true;
258              return acceptCertificate;
259          });
260          await using var dataSource = dataSourceBuilder.Build();
261          await using var connection = dataSource.CreateConnection();
262          if (acceptCertificate)
263              Assert.DoesNotThrowAsync(async () => await connection.OpenAsync());
264          else
265          {
266              var ex = Assert.ThrowsAsync<NpgsqlException>(async () => await connection.OpenAsync())!;
267              Assert.That(ex.InnerException, Is.TypeOf<AuthenticationException>());
268          }
269          Assert.That(callbackWasInvoked);
270      }
271      [Test]
272      public async Task Connection_UserCertificateValidationCallback_is_invoked([Values] bool acceptCertificate)
273      {
274          var callbackWasInvoked = false;
275          var dataSourceBuilder = CreateDataSourceBuilder();
276          dataSourceBuilder.ConnectionStringBuilder.SslMode = SslMode.Require;
277          await using var dataSource = dataSourceBuilder.Build();
278          await using var connection = dataSource.CreateConnection();
279          connection.UserCertificateValidationCallback = (_, _, _, _) =>
280          {
281              callbackWasInvoked = true;
282              return acceptCertificate;
283          };
284          if (acceptCertificate)
285              Assert.DoesNotThrowAsync(async () => await connection.OpenAsync());
286          else
287          {
288              var ex = Assert.ThrowsAsync<NpgsqlException>(async () => await connection.OpenAsync())!;
289              Assert.That(ex.InnerException, Is.TypeOf<AuthenticationException>());
290          }
291          Assert.That(callbackWasInvoked);
292      }
293      [Test]
294      public void Connect_with_Verify_and_callback_throws([Values(SslMode.VerifyCA, SslMode.VerifyFull)] SslMode sslMode)
295      {
296          using var dataSource = CreateDataSource(csb => csb.SslMode = sslMode);
297          using var connection = dataSource.CreateConnection();
298          connection.UserCertificateValidationCallback = (_, _, _, _) => true;
299          var ex = Assert.ThrowsAsync<ArgumentException>(async () => await connection.OpenAsync())!;
300          Assert.That(ex.Message, Is.EqualTo(string.Format(NpgsqlStrings.CannotUseSslVerifyWithUserCallback, sslMode)));
301      }
302      [Test]
303      public void Connect_with_RootCertificate_and_callback_throws()
304      {
305          using var dataSource = CreateDataSource(csb =>
306          {
307              csb.SslMode = SslMode.Require;
308              csb.RootCertificate = "foo";
309          });
310          using var connection = dataSource.CreateConnection();
311          connection.UserCertificateValidationCallback = (_, _, _, _) => true;
312          var ex = Assert.ThrowsAsync<ArgumentException>(async () => await connection.OpenAsync())!;
313          Assert.That(ex.Message, Is.EqualTo(string.Format(NpgsqlStrings.CannotUseSslRootCertificateWithUserCallback)));
314      }
315      [Test]
316      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4305")]
317      public async Task Bug4305_Secure([Values] bool async)
318      {
319          await using var dataSource = CreateDataSource(csb =>
320          {
321              csb.SslMode = SslMode.Require;
322              csb.Username = "npgsql_tests_ssl";
323              csb.Password = "npgsql_tests_ssl";
324              csb.MaxPoolSize = 1;
325              csb.TrustServerCertificate = true;
326          });
327          NpgsqlConnection conn = default!;
328          try
329          {
330              conn = await dataSource.OpenConnectionAsync();
331              Assert.IsTrue(conn.IsSecure);
332          }
333          catch (Exception e) when (!IsOnBuildServer)
334          {
335              Console.WriteLine(e);
336              Assert.Ignore("Only ssl user doesn't seem to be set up");
337          }
338          await using var __ = conn;
339          var originalConnector = conn.Connector;
340          await using var cmd = conn.CreateCommand();
341          cmd.CommandText = "select pg_sleep(30)";
342          cmd.CommandTimeout = 3;
343          var ex = async
344              ? Assert.ThrowsAsync<NpgsqlException>(() => cmd.ExecuteNonQueryAsync())!
345              : Assert.Throws<NpgsqlException>(() => cmd.ExecuteNonQuery())!;
346          Assert.That(ex.InnerException, Is.TypeOf<TimeoutException>());
347          await conn.CloseAsync();
348          await conn.OpenAsync();
349          Assert.AreSame(originalConnector, conn.Connector);
350          cmd.CommandText = "SELECT 1";
351          if (async)
352              Assert.DoesNotThrowAsync(async () => await cmd.ExecuteNonQueryAsync());
353          else
354              Assert.DoesNotThrow(() => cmd.ExecuteNonQuery());
355      }
356      [Test]
357      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4305")]
358      public async Task Bug4305_not_Secure([Values] bool async)
359      {
360          await using var dataSource = CreateDataSource(csb =>
361          {
362              csb.SslMode = SslMode.Disable;
363              csb.Username = "npgsql_tests_nossl";
364              csb.Password = "npgsql_tests_nossl";
365              csb.MaxPoolSize = 1;
366          });
367          NpgsqlConnection conn = default!;
368          try
369          {
370              conn = await dataSource.OpenConnectionAsync();
371              Assert.IsFalse(conn.IsSecure);
372          }
373          catch (Exception e) when (!IsOnBuildServer)
374          {
375              Console.WriteLine(e);
376              Assert.Ignore("Only nossl user doesn't seem to be set up");
377          }
378          await using var __ = conn;
379          var originalConnector = conn.Connector;
380          await using var cmd = conn.CreateCommand();
381          cmd.CommandText = "select pg_sleep(30)";
382          cmd.CommandTimeout = 3;
383          var ex = async
384              ? Assert.ThrowsAsync<NpgsqlException>(() => cmd.ExecuteNonQueryAsync())!
385              : Assert.Throws<NpgsqlException>(() => cmd.ExecuteNonQuery())!;
386          Assert.That(ex.InnerException, Is.TypeOf<TimeoutException>());
387          await conn.CloseAsync();
388          await conn.OpenAsync();
389          Assert.AreSame(originalConnector, conn.Connector);
390          cmd.CommandText = "SELECT 1";
391          if (async)
392              Assert.DoesNotThrowAsync(async () => await cmd.ExecuteNonQueryAsync());
393          else
394              Assert.DoesNotThrow(() => cmd.ExecuteNonQuery());
395      }
396      #region Setup / Teardown / Utils
397      [OneTimeSetUp]
398      public void CheckSslSupport()
399      {
400          using var conn = OpenConnection();
401          var sslSupport = (string)conn.ExecuteScalar("SHOW ssl")!;
402          if (sslSupport == "off")
403              IgnoreExceptOnBuildServer("SSL support isn't enabled at the backend");
404      }
405      #endregion
406  }
</code></pre>
        </div>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-SecurityTests.cs</h3>
            <pre><code>1  using System;
2  using System.Security.Authentication;
3  using System.Threading;
4  using System.Threading.Tasks;
5  using Npgsql.Properties;
6  using NUnit.Framework;
7  using static Npgsql.Tests.TestUtil;
8  namespace Npgsql.Tests;
9  public class SecurityTests : TestBase
10  {
11      [Test, Description("Establishes an SSL connection, assuming a self-signed server certificate")]
12      public void Basic_ssl()
13      {
14          using var dataSource = CreateDataSource(csb =>
15          {
16              csb.SslMode = SslMode.Require;
17              csb.TrustServerCertificate = true;
18          });
19          using var conn = dataSource.OpenConnection();
20          Assert.That(conn.IsSecure, Is.True);
21      }
22      [Test, Description("Default user must run with md5 password encryption")]
23      public void Default_user_uses_md5_password()
24      {
25          if (!IsOnBuildServer)
26              Assert.Ignore("Only executed in CI");
27          using var dataSource = CreateDataSource(csb =>
28          {
29              csb.SslMode = SslMode.Require;
30              csb.TrustServerCertificate = true;
31          });
32          using var conn = dataSource.OpenConnection();
33          Assert.That(conn.IsScram, Is.False);
34          Assert.That(conn.IsScramPlus, Is.False);
35      }
36      [Test, Description("Makes sure a certificate whose root CA isn't known isn't accepted")]
37      public void Reject_self_signed_certificate([Values(SslMode.VerifyCA, SslMode.VerifyFull)] SslMode sslMode)
38      {
39          var csb = new NpgsqlConnectionStringBuilder(ConnectionString)
40          {
41              SslMode = sslMode,
42              CheckCertificateRevocation = false,
43          };
44          using var _ = CreateTempPool(csb, out var connString);
45          using var conn = new NpgsqlConnection(connString);
46          var ex = Assert.Throws<NpgsqlException>(conn.Open)!;
47          Assert.That(ex.InnerException, Is.TypeOf<AuthenticationException>());
48      }
49      [Test, Description("Makes sure that ssl_renegotiation_limit is always 0, renegotiation is buggy")]
50      public void No_ssl_renegotiation()
51      {
52          using var dataSource = CreateDataSource(csb =>
53          {
54              csb.SslMode = SslMode.Require;
55              csb.TrustServerCertificate = true;
56          });
57          using var conn = dataSource.OpenConnection();
58          Assert.That(conn.ExecuteScalar("SHOW ssl_renegotiation_limit"), Is.EqualTo("0"));
59          conn.ExecuteNonQuery("DISCARD ALL");
60          Assert.That(conn.ExecuteScalar("SHOW ssl_renegotiation_limit"), Is.EqualTo("0"));
61      }
62      [Test, Description("Makes sure that when SSL is disabled IsSecure returns false")]
63      public void IsSecure_without_ssl()
64      {
65          using var dataSource = CreateDataSource(csb => csb.SslMode = SslMode.Disable);
66          using var conn = dataSource.OpenConnection();
67          Assert.That(conn.IsSecure, Is.False);
68      }
69      [Test, Explicit("Needs to be set up (and run with with Kerberos credentials on Linux)")]
70      public void IntegratedSecurity_with_Username()
71      {
72          var username = Environment.UserName;
73          if (username == null)
74              throw new Exception("Could find username");
75          var connString = new NpgsqlConnectionStringBuilder(ConnectionString)
76          {
77              Username = username,
78              Password = null
79          }.ToString();
80          using var conn = new NpgsqlConnection(connString);
81          try
82          {
83              conn.Open();
84          }
85          catch (Exception e)
86          {
87              if (IsOnBuildServer)
88                  throw;
89              Console.WriteLine(e);
90              Assert.Ignore("Integrated security (GSS/SSPI) doesn't seem to be set up");
91          }
92      }
93      [Test, Explicit("Needs to be set up (and run with with Kerberos credentials on Linux)")]
94      public void IntegratedSecurity_without_Username()
95      {
96          var connString = new NpgsqlConnectionStringBuilder(ConnectionString)
97          {
98              Username = null,
99              Password = null
100          }.ToString();
101          using var conn = new NpgsqlConnection(connString);
102          try
103          {
104              conn.Open();
105          }
106          catch (Exception e)
107          {
108              if (IsOnBuildServer)
109                  throw;
110              Console.WriteLine(e);
111              Assert.Ignore("Integrated security (GSS/SSPI) doesn't seem to be set up");
112          }
113      }
114      [Test, Explicit("Needs to be set up (and run with with Kerberos credentials on Linux)")]
115      public void Connection_database_is_populated_on_Open()
116      {
117          var connString = new NpgsqlConnectionStringBuilder(ConnectionString)
118          {
119              Username = null,
<span onclick='openModal()' class='match'>120              Password = null,
121              Database = null
122          }.ToString();
123          using var conn = new NpgsqlConnection(connString);
124          try
125          {
126              conn.Open();
127          }
128          catch (Exception e)
129          {
130              if (IsOnBuildServer)
131                  throw;
132              Console.WriteLine(e);
133              Assert.Ignore("Integrated security (GSS/SSPI) doesn't seem to be set up");
134          }
135          Assert.That(conn.Database, Is.Not.Null);
</span>136      }
137      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1718")]
138      public void Bug1718()
139      {
140          using var dataSource = CreateDataSource(csb =>
141          {
142              csb.SslMode = SslMode.Require;
143              csb.TrustServerCertificate = true;
144          });
145          using var conn = dataSource.OpenConnection();
146          using var cmd = CreateSleepCommand(conn, 10000);
147          var cts = new CancellationTokenSource(1000).Token;
148          Assert.That(async () => await cmd.ExecuteNonQueryAsync(cts), Throws.Exception
149              .TypeOf<OperationCanceledException>()
150              .With.InnerException.TypeOf<PostgresException>()
151              .With.InnerException.Property(nameof(PostgresException.SqlState)).EqualTo(PostgresErrorCodes.QueryCanceled));
152      }
153      [Test]
154      public void ScramPlus()
155      {
156          try
157          {
158              using var dataSource = CreateDataSource(csb =>
159              {
160                  csb.SslMode = SslMode.Require;
161                  csb.Username = "npgsql_tests_scram";
162                  csb.Password = "npgsql_tests_scram";
163                  csb.TrustServerCertificate = true;
164              });
165              using var conn = dataSource.OpenConnection();
166              if (conn.PostgreSqlVersion.Major >= 11)
167              {
168                  Assert.That(conn.IsScramPlus, Is.True);
169              }
170          }
171          catch (Exception e) when (!IsOnBuildServer)
172          {
173              Console.WriteLine(e);
174              Assert.Ignore("scram-sha-256-plus doesn't seem to be set up");
175          }
176      }
177      [Test]
178      public async Task Connect_with_only_ssl_allowed_user([Values] bool multiplexing, [Values] bool keepAlive)
179      {
180          if (multiplexing && keepAlive)
181          {
182              Assert.Ignore("Multiplexing doesn't support keepalive");
183          }
184          try
185          {
186              await using var dataSource = CreateDataSource(csb =>
187              {
188                  csb.SslMode = SslMode.Allow;
189                  csb.Username = "npgsql_tests_ssl";
190                  csb.Password = "npgsql_tests_ssl";
191                  csb.Multiplexing = multiplexing;
192                  csb.KeepAlive = keepAlive ? 10 : 0;
193              });
194              await using var conn = await dataSource.OpenConnectionAsync();
195              Assert.IsTrue(conn.IsSecure);
196          }
197          catch (Exception e) when (!IsOnBuildServer)
198          {
199              Console.WriteLine(e);
200              Assert.Ignore("Only ssl user doesn't seem to be set up");
201          }
202      }
203      [Test]
204      public void SslMode_Require_throws_without_TSC()
205      {
206          using var dataSource = CreateDataSource(csb => csb.SslMode = SslMode.Require);
207          var ex = Assert.ThrowsAsync<ArgumentException>(async () => await dataSource.OpenConnectionAsync())!;
208          Assert.That(ex.Message, Is.EqualTo(NpgsqlStrings.CannotUseSslModeRequireWithoutTrustServerCertificate));
209      }
210      [Test]
211      public async Task SslMode_Require_with_callback_without_TSC()
212      {
213          await using var dataSource = CreateDataSource(csb =>
214          {
215              csb.SslMode = SslMode.Require;
216              csb.TrustServerCertificate = false;
217              csb.Pooling = false;
218          });
219          await using var connection = dataSource.CreateConnection();
220          connection.UserCertificateValidationCallback = (_, _, _, _) => true;
221          await connection.OpenAsync();
222      }
223      [Test]
224      public async Task Connect_with_only_non_ssl_allowed_user([Values] bool multiplexing, [Values] bool keepAlive)
225      {
226          if (multiplexing && keepAlive)
227          {
228              Assert.Ignore("Multiplexing doesn't support keepalive");
229          }
230          try
231          {
232              await using var dataSource = CreateDataSource(csb =>
233              {
234                  csb.SslMode = SslMode.Prefer;
235                  csb.Username = "npgsql_tests_nossl";
236                  csb.Password = "npgsql_tests_nossl";
237                  csb.Multiplexing = multiplexing;
238                  csb.KeepAlive = keepAlive ? 10 : 0;
239              });
240              await using var conn = await dataSource.OpenConnectionAsync();
241              Assert.IsFalse(conn.IsSecure);
242          }
243          catch (Exception e) when (!IsOnBuildServer)
244          {
245              Console.WriteLine(e);
246              Assert.Ignore("Only nonssl user doesn't seem to be set up");
247          }
248      }
249      [Test]
250      public async Task DataSource_UserCertificateValidationCallback_is_invoked([Values] bool acceptCertificate)
251      {
252          var callbackWasInvoked = false;
253          var dataSourceBuilder = CreateDataSourceBuilder();
254          dataSourceBuilder.ConnectionStringBuilder.SslMode = SslMode.Require;
255          dataSourceBuilder.UseUserCertificateValidationCallback((_, _, _, _) =>
256          {
257              callbackWasInvoked = true;
258              return acceptCertificate;
259          });
260          await using var dataSource = dataSourceBuilder.Build();
261          await using var connection = dataSource.CreateConnection();
262          if (acceptCertificate)
263              Assert.DoesNotThrowAsync(async () => await connection.OpenAsync());
264          else
265          {
266              var ex = Assert.ThrowsAsync<NpgsqlException>(async () => await connection.OpenAsync())!;
267              Assert.That(ex.InnerException, Is.TypeOf<AuthenticationException>());
268          }
269          Assert.That(callbackWasInvoked);
270      }
271      [Test]
272      public async Task Connection_UserCertificateValidationCallback_is_invoked([Values] bool acceptCertificate)
273      {
274          var callbackWasInvoked = false;
275          var dataSourceBuilder = CreateDataSourceBuilder();
276          dataSourceBuilder.ConnectionStringBuilder.SslMode = SslMode.Require;
277          await using var dataSource = dataSourceBuilder.Build();
278          await using var connection = dataSource.CreateConnection();
279          connection.UserCertificateValidationCallback = (_, _, _, _) =>
280          {
281              callbackWasInvoked = true;
282              return acceptCertificate;
283          };
284          if (acceptCertificate)
285              Assert.DoesNotThrowAsync(async () => await connection.OpenAsync());
286          else
287          {
288              var ex = Assert.ThrowsAsync<NpgsqlException>(async () => await connection.OpenAsync())!;
289              Assert.That(ex.InnerException, Is.TypeOf<AuthenticationException>());
290          }
291          Assert.That(callbackWasInvoked);
292      }
293      [Test]
294      public void Connect_with_Verify_and_callback_throws([Values(SslMode.VerifyCA, SslMode.VerifyFull)] SslMode sslMode)
295      {
296          using var dataSource = CreateDataSource(csb => csb.SslMode = sslMode);
297          using var connection = dataSource.CreateConnection();
298          connection.UserCertificateValidationCallback = (_, _, _, _) => true;
299          var ex = Assert.ThrowsAsync<ArgumentException>(async () => await connection.OpenAsync())!;
300          Assert.That(ex.Message, Is.EqualTo(string.Format(NpgsqlStrings.CannotUseSslVerifyWithUserCallback, sslMode)));
301      }
302      [Test]
303      public void Connect_with_RootCertificate_and_callback_throws()
304      {
305          using var dataSource = CreateDataSource(csb =>
306          {
307              csb.SslMode = SslMode.Require;
308              csb.RootCertificate = "foo";
309          });
310          using var connection = dataSource.CreateConnection();
311          connection.UserCertificateValidationCallback = (_, _, _, _) => true;
312          var ex = Assert.ThrowsAsync<ArgumentException>(async () => await connection.OpenAsync())!;
313          Assert.That(ex.Message, Is.EqualTo(string.Format(NpgsqlStrings.CannotUseSslRootCertificateWithUserCallback)));
314      }
315      [Test]
316      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4305")]
317      public async Task Bug4305_Secure([Values] bool async)
318      {
319          await using var dataSource = CreateDataSource(csb =>
320          {
321              csb.SslMode = SslMode.Require;
322              csb.Username = "npgsql_tests_ssl";
323              csb.Password = "npgsql_tests_ssl";
324              csb.MaxPoolSize = 1;
325              csb.TrustServerCertificate = true;
326          });
327          NpgsqlConnection conn = default!;
328          try
329          {
330              conn = await dataSource.OpenConnectionAsync();
331              Assert.IsTrue(conn.IsSecure);
332          }
333          catch (Exception e) when (!IsOnBuildServer)
334          {
335              Console.WriteLine(e);
336              Assert.Ignore("Only ssl user doesn't seem to be set up");
337          }
338          await using var __ = conn;
339          var originalConnector = conn.Connector;
340          await using var cmd = conn.CreateCommand();
341          cmd.CommandText = "select pg_sleep(30)";
342          cmd.CommandTimeout = 3;
343          var ex = async
344              ? Assert.ThrowsAsync<NpgsqlException>(() => cmd.ExecuteNonQueryAsync())!
345              : Assert.Throws<NpgsqlException>(() => cmd.ExecuteNonQuery())!;
346          Assert.That(ex.InnerException, Is.TypeOf<TimeoutException>());
347          await conn.CloseAsync();
348          await conn.OpenAsync();
349          Assert.AreSame(originalConnector, conn.Connector);
350          cmd.CommandText = "SELECT 1";
351          if (async)
352              Assert.DoesNotThrowAsync(async () => await cmd.ExecuteNonQueryAsync());
353          else
354              Assert.DoesNotThrow(() => cmd.ExecuteNonQuery());
355      }
356      [Test]
357      [IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4305")]
358      public async Task Bug4305_not_Secure([Values] bool async)
359      {
360          await using var dataSource = CreateDataSource(csb =>
361          {
362              csb.SslMode = SslMode.Disable;
363              csb.Username = "npgsql_tests_nossl";
364              csb.Password = "npgsql_tests_nossl";
365              csb.MaxPoolSize = 1;
366          });
367          NpgsqlConnection conn = default!;
368          try
369          {
370              conn = await dataSource.OpenConnectionAsync();
371              Assert.IsFalse(conn.IsSecure);
372          }
373          catch (Exception e) when (!IsOnBuildServer)
374          {
375              Console.WriteLine(e);
376              Assert.Ignore("Only nossl user doesn't seem to be set up");
377          }
378          await using var __ = conn;
379          var originalConnector = conn.Connector;
380          await using var cmd = conn.CreateCommand();
381          cmd.CommandText = "select pg_sleep(30)";
382          cmd.CommandTimeout = 3;
383          var ex = async
384              ? Assert.ThrowsAsync<NpgsqlException>(() => cmd.ExecuteNonQueryAsync())!
385              : Assert.Throws<NpgsqlException>(() => cmd.ExecuteNonQuery())!;
386          Assert.That(ex.InnerException, Is.TypeOf<TimeoutException>());
387          await conn.CloseAsync();
388          await conn.OpenAsync();
389          Assert.AreSame(originalConnector, conn.Connector);
390          cmd.CommandText = "SELECT 1";
391          if (async)
392              Assert.DoesNotThrowAsync(async () => await cmd.ExecuteNonQueryAsync());
393          else
394              Assert.DoesNotThrow(() => cmd.ExecuteNonQuery());
395      }
396      #region Setup / Teardown / Utils
397      [OneTimeSetUp]
398      public void CheckSslSupport()
399      {
400          using var conn = OpenConnection();
401          var sslSupport = (string)conn.ExecuteScalar("SHOW ssl")!;
402          if (sslSupport == "off")
403              IgnoreExceptOnBuildServer("SSL support isn't enabled at the backend");
404      }
405      #endregion
406  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-SecurityTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-SecurityTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>120              Password = null,
121              Database = null
122          }.ToString();
123          using var conn = new NpgsqlConnection(connString);
124          try
125          {
126              conn.Open();
127          }
128          catch (Exception e)
129          {
130              if (IsOnBuildServer)
131                  throw;
132              Console.WriteLine(e);
133              Assert.Ignore("Integrated security (GSS/SSPI) doesn't seem to be set up");
134          }
135          Assert.That(conn.Database, Is.Not.Null);
</pre></code></div>
                <div class="column column_space"><pre><code>120              Password = null,
121              Database = null
122          }.ToString();
123          using var conn = new NpgsqlConnection(connString);
124          try
125          {
126              conn.Open();
127          }
128          catch (Exception e)
129          {
130              if (IsOnBuildServer)
131                  throw;
132              Console.WriteLine(e);
133              Assert.Ignore("Integrated security (GSS/SSPI) doesn't seem to be set up");
134          }
135          Assert.That(conn.Database, Is.Not.Null);
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    