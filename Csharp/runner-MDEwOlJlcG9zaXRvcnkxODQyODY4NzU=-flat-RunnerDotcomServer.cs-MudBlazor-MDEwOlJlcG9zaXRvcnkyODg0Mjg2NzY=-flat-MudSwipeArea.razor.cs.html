
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 13, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-RunnerDotcomServer.cs</h3>
            <pre><code>1  using GitHub.DistributedTask.WebApi;
2  using System;
3  using System.Collections.Generic;
4  using System.Threading;
5  using System.Threading.Tasks;
6  using GitHub.Services.WebApi;
7  using GitHub.Services.Common;
8  using GitHub.Runner.Sdk;
9  using System.Net.Http;
10  using System.Net.Http.Headers;
11  using System.Linq;
12  namespace GitHub.Runner.Common
13  {
14      [ServiceLocator(Default = typeof(RunnerDotcomServer))]
15      public interface IRunnerDotcomServer : IRunnerService
16      {
17          Task<List<TaskAgent>> GetRunnersAsync(int runnerGroupId, string githubUrl, string githubToken, string agentName);
18          Task<DistributedTask.WebApi.Runner> AddRunnerAsync(int runnerGroupId, TaskAgent agent, string githubUrl, string githubToken, string publicKey);
19          Task<List<TaskAgentPool>> GetRunnerGroupsAsync(string githubUrl, string githubToken);
20          string GetGitHubRequestId(HttpResponseHeaders headers);
21      }
22      public enum RequestType
23      {
24          Get,
25          Post,
26          Patch,
27          Delete
28      }
29      public class RunnerDotcomServer : RunnerService, IRunnerDotcomServer
30      {
31          private ITerminal _term;
32          public override void Initialize(IHostContext hostContext)
33          {
34              base.Initialize(hostContext);
35              _term = hostContext.GetService<ITerminal>();
36          }
37          public async Task<List<TaskAgent>> GetRunnersAsync(int runnerGroupId, string githubUrl, string githubToken, string agentName = null)
38          {
39              var githubApiUrl = "";
40              var gitHubUrlBuilder = new UriBuilder(githubUrl);
41              var path = gitHubUrlBuilder.Path.Split('/', '\\', StringSplitOptions.RemoveEmptyEntries);
42              if (path.Length == 1)
43              {
44                  if (UrlUtil.IsHostedServer(gitHubUrlBuilder))
45                  {
46                      githubApiUrl = $"{gitHubUrlBuilder.Scheme}:&bsol;&bsol;api.{gitHubUrlBuilder.Host}/orgs/{path[0]}/actions/runner-groups/{runnerGroupId}/runners";
47                  }
48                  else
49                  {
50                      githubApiUrl = $"{gitHubUrlBuilder.Scheme}:&bsol;&bsol;{gitHubUrlBuilder.Host}/api/v3/orgs/{path[0]}/actions/runner-groups/{runnerGroupId}/runners";
51                  }
52              }
53              else if (path.Length == 2)
54              {
55                  if (!string.Equals(path[0], "enterprises", StringComparison.OrdinalIgnoreCase))
56                  {
57                      return null;
58                  }
59                  if (UrlUtil.IsHostedServer(gitHubUrlBuilder))
60                  {
61                      githubApiUrl = $"{gitHubUrlBuilder.Scheme}:&bsol;&bsol;api.{gitHubUrlBuilder.Host}/{path[0]}/{path[1]}/actions/runner-groups/{runnerGroupId}/runners";
62                  }
63                  else
64                  {
65                      githubApiUrl = $"{gitHubUrlBuilder.Scheme}:&bsol;&bsol;{gitHubUrlBuilder.Host}/api/v3/{path[0]}/{path[1]}/actions/runner-groups/{runnerGroupId}/runners";
66                  }
67              }
68              else
69              {
70                  throw new ArgumentException($"'{githubUrl}' should point to an org or enterprise.");
71              }
72              var runnersList = await RetryRequest<ListRunnersResponse>(githubApiUrl, githubToken, RequestType.Get, 3, "Failed to get agents pools");
73              var agents = runnersList.ToTaskAgents();
74              if (string.IsNullOrEmpty(agentName))
75              {
76                  return agents;
77              }
78              return agents.Where(x => string.Equals(x.Name, agentName, StringComparison.OrdinalIgnoreCase)).ToList();
79          }
80          public async Task<List<TaskAgentPool>> GetRunnerGroupsAsync(string githubUrl, string githubToken)
81          {
82              var githubApiUrl = "";
83              var gitHubUrlBuilder = new UriBuilder(githubUrl);
84              var path = gitHubUrlBuilder.Path.Split('/', '\\', StringSplitOptions.RemoveEmptyEntries);
85              if (path.Length == 1)
86              {
87                  if (UrlUtil.IsHostedServer(gitHubUrlBuilder))
88                  {
89                      githubApiUrl = $"{gitHubUrlBuilder.Scheme}:&bsol;&bsol;api.{gitHubUrlBuilder.Host}/orgs/{path[0]}/actions/runner-groups";
90                  }
91                  else
92                  {
93                      githubApiUrl = $"{gitHubUrlBuilder.Scheme}:&bsol;&bsol;{gitHubUrlBuilder.Host}/api/v3/orgs/{path[0]}/actions/runner-groups";
94                  }
95              }
96              else if (path.Length == 2)
97              {
98                  if (!string.Equals(path[0], "enterprises", StringComparison.OrdinalIgnoreCase))
99                  {
100                      return null;
101                  }
102                  if (UrlUtil.IsHostedServer(gitHubUrlBuilder))
103                  {
104                      githubApiUrl = $"{gitHubUrlBuilder.Scheme}:&bsol;&bsol;api.{gitHubUrlBuilder.Host}/{path[0]}/{path[1]}/actions/runner-groups";
105                  }
106                  else
107                  {
108                      githubApiUrl = $"{gitHubUrlBuilder.Scheme}:&bsol;&bsol;{gitHubUrlBuilder.Host}/api/v3/{path[0]}/{path[1]}/actions/runner-groups";
109                  }
110              }
111              else
112              {
113                  throw new ArgumentException($"'{githubUrl}' should point to an org or enterprise.");
114              }
115              var agentPools = await RetryRequest<RunnerGroupList>(githubApiUrl, githubToken, RequestType.Get, 3, "Failed to get agents pools");
116              return agentPools?.ToAgentPoolList();
117          }
118          public async Task<DistributedTask.WebApi.Runner> AddRunnerAsync(int runnerGroupId, TaskAgent agent, string githubUrl, string githubToken, string publicKey)
119          {
120              var gitHubUrlBuilder = new UriBuilder(githubUrl);
121              var path = gitHubUrlBuilder.Path.Split('/', '\\', StringSplitOptions.RemoveEmptyEntries);
122              string githubApiUrl;
123              if (UrlUtil.IsHostedServer(gitHubUrlBuilder))
124              {
125                  githubApiUrl = $"{gitHubUrlBuilder.Scheme}:&bsol;&bsol;api.{gitHubUrlBuilder.Host}/actions/runners/register";
126              }
127              else
128              {
129                  githubApiUrl = $"{gitHubUrlBuilder.Scheme}:&bsol;&bsol;{gitHubUrlBuilder.Host}/api/v3/actions/runners/register";
130              }
131              var bodyObject = new Dictionary<string, Object>()
132                      {
133                          {"url", githubUrl},
134                          {"group_id", runnerGroupId},
135                          {"name", agent.Name},
136                          {"version", agent.Version},
137                          {"updates_disabled", agent.DisableUpdate},
138                          {"ephemeral", agent.Ephemeral},
139                          {"labels", agent.Labels},
140                          {"public_key", publicKey}
141                      };
142              var body = new StringContent(StringUtil.ConvertToJson(bodyObject), null, "application/json");
143              return await RetryRequest<DistributedTask.WebApi.Runner>(githubApiUrl, githubToken, RequestType.Post, 3, "Failed to add agent", body);
144          }
145          private async Task<T> RetryRequest<T>(string githubApiUrl, string githubToken, RequestType requestType, int maxRetryAttemptsCount = 5, string errorMessage = null, StringContent body = null)
146          {
147              int retry = 0;
148              while (true)
149              {
150                  retry++;
151                  using (var httpClientHandler = HostContext.CreateHttpClientHandler())
152                  using (var httpClient = new HttpClient(httpClientHandler))
153                  {
154                      httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("RemoteAuth", githubToken);
155                      httpClient.DefaultRequestHeaders.UserAgent.AddRange(HostContext.UserAgents);
156                      var responseStatus = System.Net.HttpStatusCode.OK;
157                      try
158                      {
159                          HttpResponseMessage response = null;
160                          if (requestType == RequestType.Get)
161                          {
<span onclick='openModal()' class='match'>162                              response = await httpClient.GetAsync(githubApiUrl);
163                          }
164                          else
165                          {
166                              response = await httpClient.PostAsync(githubApiUrl, body);
</span>167                          }
168                          if (response != null)
169                          {
170                              responseStatus = response.StatusCode;
171                              var githubRequestId = GetGitHubRequestId(response.Headers);
172                              if (response.IsSuccessStatusCode)
173                              {
174                                  Trace.Info($"Http response code: {response.StatusCode} from '{requestType.ToString()} {githubApiUrl}' ({githubRequestId})");
175                                  var jsonResponse = await response.Content.ReadAsStringAsync();
176                                  return StringUtil.ConvertFromJson<T>(jsonResponse);
177                              }
178                              else
179                              {
180                                  _term.WriteError($"Http response code: {response.StatusCode} from '{requestType.ToString()} {githubApiUrl}' (Request Id: {githubRequestId})");
181                                  var errorResponse = await response.Content.ReadAsStringAsync();
182                                  _term.WriteError(errorResponse);
183                                  response.EnsureSuccessStatusCode();
184                              }
185                          }
186                      }
187                      catch (Exception ex) when (retry < maxRetryAttemptsCount && responseStatus != System.Net.HttpStatusCode.NotFound)
188                      {
189                          Trace.Error($"{errorMessage} -- Atempt: {retry}");
190                          Trace.Error(ex);
191                      }
192                  }
193                  var backOff = BackoffTimerHelper.GetRandomBackoff(TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(5));
194                  Trace.Info($"Retrying in {backOff.Seconds} seconds");
195                  await Task.Delay(backOff);
196              }
197          }
198          public string GetGitHubRequestId(HttpResponseHeaders headers)
199          {
200              if (headers.TryGetValues("x-github-request-id", out var headerValues))
201              {
202                  return headerValues.FirstOrDefault();
203              }
204              return string.Empty;
205          }
206      }
207  }
</code></pre>
        </div>
        <div class="column">
            <h3>MudBlazor-MDEwOlJlcG9zaXRvcnkyODg0Mjg2NzY=-flat-MudSwipeArea.razor.cs</h3>
            <pre><code>1  using System;
2  using System.Diagnostics.CodeAnalysis;
3  using System.Threading.Tasks;
4  using Microsoft.AspNetCore.Components;
5  using Microsoft.AspNetCore.Components.Web;
6  namespace MudBlazor
7  {
8  #nullable enable
9      public partial class MudSwipeArea : MudComponentBase
10      {
11          private static readonly string[] _preventDefaultEventNames = { "touchstart", "touchend", "touchcancel" };
12          private double? _swipeDelta;
13          internal int[]? _listenerIds;
14          internal double? _xDown, _yDown;
15          private bool _preventDefaultChanged;
16          private ElementReference _componentRef;
17          [Parameter]
18          [Category(CategoryTypes.SwipeArea.Behavior)]
19          public RenderFragment? ChildContent { get; set; }
20          [Obsolete("Use OnSwipeEnd instead.")]
21          [Parameter]
22          [Category(CategoryTypes.SwipeArea.Behavior)]
23          public Action<SwipeDirection>? OnSwipe { get; set; }
24          [Parameter]
25          [Category(CategoryTypes.SwipeArea.Behavior)]
26          public EventCallback<SwipeEventArgs> OnSwipeEnd { get; set; }
27          [Parameter]
28          [Category(CategoryTypes.SwipeArea.Behavior)]
29          public int Sensitivity { get; set; } = 100;
30          [Parameter]
31          [Category(CategoryTypes.SwipeArea.Behavior)]
32          public bool PreventDefault { get; set; }
33          public override async Task SetParametersAsync(ParameterView parameters)
34          {
35              var preventDefault = parameters.GetValueOrDefault<bool>(nameof(PreventDefault));
36              if (preventDefault != PreventDefault)
37              {
38                  _preventDefaultChanged = true;
39              }
40              await base.SetParametersAsync(parameters);
41          }
42          private async Task SetPreventDefaultInternal(bool value)
43          {
44              if (value)
45              {
<span onclick='openModal()' class='match'>46                  _listenerIds = await _componentRef.AddDefaultPreventingHandlers(_preventDefaultEventNames);
47              }
48              else
49              {
50                  if (_listenerIds != null)
</span>51                  {
52                      await _componentRef.RemoveDefaultPreventingHandlers(_preventDefaultEventNames, _listenerIds);
53                      _listenerIds = null;
54                  }
55              }
56          }
57          protected override async Task OnAfterRenderAsync(bool firstRender)
58          {
59              if (_preventDefaultChanged)
60              {
61                  _preventDefaultChanged = false;
62                  await SetPreventDefaultInternal(PreventDefault);
63              }
64          }
65          internal void OnTouchStart(TouchEventArgs arg)
66          {
67              _xDown = arg.Touches[0].ClientX;
68              _yDown = arg.Touches[0].ClientY;
69          }
70          internal async Task OnTouchEnd(TouchEventArgs arg)
71          {
72              if (_xDown is null || _yDown is null)
73              {
74                  return;
75              }
76              var xDiff = _xDown.Value - arg.ChangedTouches[0].ClientX;
77              var yDiff = _yDown.Value - arg.ChangedTouches[0].ClientY;
78              if (Math.Abs(xDiff) < Sensitivity && Math.Abs(yDiff) < Sensitivity)
79              {
80                  _xDown = _yDown = null;
81                  return;
82              }
83              var swipeDirection = Math.Abs(xDiff) > Math.Abs(yDiff) ?
84                  xDiff > 0 ? SwipeDirection.RightToLeft : SwipeDirection.LeftToRight :
85                  yDiff > 0 ? SwipeDirection.BottomToTop : SwipeDirection.TopToBottom;
86              if (Math.Abs(xDiff) > Math.Abs(yDiff))
87              {
88                  _swipeDelta = xDiff;
89              }
90              else
91              {
92                  _swipeDelta = yDiff;
93              }
94              await OnSwipeEnd.InvokeAsync(new SwipeEventArgs(arg, swipeDirection, _swipeDelta, this));
95  #pragma warning disable CS0618
96              if (OnSwipe != null)
97              {
98                  await InvokeAsync(() => OnSwipe(swipeDirection));
99              }
100  #pragma warning restore CS0618
101              _xDown = _yDown = null;
102          }
103          [ExcludeFromCodeCoverage]
104          [Obsolete("Use OnSwipeEnd to get SwipeDelta")]
105          public double? GetSwipeDelta() => _swipeDelta;
106          internal void OnTouchCancel(TouchEventArgs arg)
107          {
108              _xDown = _yDown = null;
109          }
110      }
111  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-RunnerDotcomServer.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from MudBlazor-MDEwOlJlcG9zaXRvcnkyODg0Mjg2NzY=-flat-MudSwipeArea.razor.cs</div>
                </div>
                <div class="column column_space"><pre><code>162                              response = await httpClient.GetAsync(githubApiUrl);
163                          }
164                          else
165                          {
166                              response = await httpClient.PostAsync(githubApiUrl, body);
</pre></code></div>
                <div class="column column_space"><pre><code>46                  _listenerIds = await _componentRef.AddDefaultPreventingHandlers(_preventDefaultEventNames);
47              }
48              else
49              {
50                  if (_listenerIds != null)
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    