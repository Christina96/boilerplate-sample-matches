
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Similarity: 10.1010101010101%, Tokens: 12</h2>
        <div class="column">
            <h3>runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-PipelineDirectoryManagerL0.cs</h3>
            <pre><code>1  using Pipelines = GitHub.DistributedTask.Pipelines;
2  using GitHub.Runner.Worker;
3  using Moq;
4  using System.IO;
5  using System.Runtime.CompilerServices;
6  using Xunit;
7  using System;
8  namespace GitHub.Runner.Common.Tests.Worker
9  {
10      public sealed class PipelineDirectoryManagerL0
11      {
12          private PipelineDirectoryManager _pipelineDirectoryManager;
13          private Mock<IExecutionContext> _ec;
14          private Pipelines.WorkspaceOptions _workspaceOptions;
15          private TrackingConfig _existingConfig;
16          private TrackingConfig _newConfig;
17          private string _trackingFile;
18          private Mock<ITrackingManager> _trackingManager;
19          [Fact]
20          [Trait("Level", "L0")]
21          [Trait("Category", "Worker")]
22          public void CreatesPipelineDirectories()
23          {
24              using (TestHostContext hc = Setup())
25              {
26                  _trackingManager.Setup(x => x.LoadIfExists(_ec.Object, _trackingFile)).Returns(default(TrackingConfig));
27                  _trackingManager.Setup(x => x.Create(_ec.Object, _trackingFile)).Returns(new TrackingConfig(_ec.Object));
28                  _newConfig = _pipelineDirectoryManager.PrepareDirectory(_ec.Object, _workspaceOptions);
29                  _trackingManager.Verify(x => x.Create(_ec.Object, _trackingFile));
30                  Assert.True(Directory.Exists(Path.Combine(hc.GetDirectory(WellKnownDirectory.Work), _newConfig.WorkspaceDirectory)));
31              }
32          }
33          [Fact]
34          [Trait("Level", "L0")]
35          [Trait("Category", "Worker")]
36          public void DeletesResourceDirectoryWhenCleanIsResources()
37          {
38              using (TestHostContext hc = Setup())
39              {
40                  _existingConfig = new TrackingConfig(_ec.Object);
41                  _trackingManager.Setup(x => x.LoadIfExists(_ec.Object, _trackingFile)).Returns(_existingConfig);
42                  _workspaceOptions.Clean = Pipelines.PipelineConstants.WorkspaceCleanOptions.Resources;
43                  string workspaceDirectory = Path.Combine(hc.GetDirectory(WellKnownDirectory.Work), _existingConfig.WorkspaceDirectory);
44                  string sourceFile = Path.Combine(workspaceDirectory, "some subdirectory", "some source file");
45                  Directory.CreateDirectory(Path.GetDirectoryName(sourceFile));
46                  File.WriteAllText(path: sourceFile, contents: "some source contents");
47                  _pipelineDirectoryManager.PrepareDirectory(_ec.Object, _workspaceOptions);
48                  Assert.True(Directory.Exists(workspaceDirectory));
49                  Assert.Equal(0, Directory.GetFileSystemEntries(workspaceDirectory, "*", SearchOption.AllDirectories).Length);
50              }
51          }
52          [Fact]
53          [Trait("Level", "L0")]
54          [Trait("Category", "Worker")]
55          public void DeletesNonResourceDirectoryWhenCleanIsOutputs()
56          {
57              using (TestHostContext hc = Setup())
58              {
59                  _existingConfig = new TrackingConfig(_ec.Object);
60                  _trackingManager.Setup(x => x.LoadIfExists(_ec.Object, _trackingFile)).Returns(_existingConfig);
61                  _workspaceOptions.Clean = Pipelines.PipelineConstants.WorkspaceCleanOptions.Outputs;
62                  string nonResourceDirectory = Path.Combine(hc.GetDirectory(WellKnownDirectory.Work), _existingConfig.PipelineDirectory, "somedir");
63                  string sourceFile = Path.Combine(nonResourceDirectory, "some subdirectory", "some source file");
64                  Directory.CreateDirectory(Path.GetDirectoryName(sourceFile));
65                  File.WriteAllText(path: sourceFile, contents: "some source contents");
66                  _pipelineDirectoryManager.PrepareDirectory(_ec.Object, _workspaceOptions);
67                  Assert.False(Directory.Exists(nonResourceDirectory));
68              }
69          }
70          [Fact]
71          [Trait("Level", "L0")]
72          [Trait("Category", "Worker")]
73          public void RecreatesPipelinesDirectoryWhenCleanIsAll()
74          {
75              using (TestHostContext hc = Setup())
76              {
77                  _existingConfig = new TrackingConfig(_ec.Object);
78                  _trackingManager.Setup(x => x.LoadIfExists(_ec.Object, _trackingFile)).Returns(_existingConfig);
79                  _workspaceOptions.Clean = Pipelines.PipelineConstants.WorkspaceCleanOptions.All;
80                  string pipelinesDirectory = Path.Combine(hc.GetDirectory(WellKnownDirectory.Work), _existingConfig.PipelineDirectory);
81                  string looseFile = Path.Combine(pipelinesDirectory, "some loose directory", "some loose file");
82                  Directory.CreateDirectory(Path.GetDirectoryName(looseFile));
83                  File.WriteAllText(path: looseFile, contents: "some loose file contents");
84                  _pipelineDirectoryManager.PrepareDirectory(_ec.Object, _workspaceOptions);
85                  Assert.Equal(1, Directory.GetFileSystemEntries(pipelinesDirectory, "*", SearchOption.AllDirectories).Length);
86                  Assert.True(Directory.Exists(Path.Combine(hc.GetDirectory(WellKnownDirectory.Work), _existingConfig.WorkspaceDirectory)));
87              }
88          }
89          [Fact]
90          [Trait("Level", "L0")]
91          [Trait("Category", "Worker")]
92          public void UpdatesExistingConfig()
93          {
94              using (TestHostContext hc = Setup())
95              {
96                  _existingConfig = new TrackingConfig(_ec.Object);
97                  _trackingManager.Setup(x => x.LoadIfExists(_ec.Object, _trackingFile)).Returns(_existingConfig);
98                  _pipelineDirectoryManager.PrepareDirectory(_ec.Object, _workspaceOptions);
99                  _trackingManager.Verify(x => x.LoadIfExists(_ec.Object, _trackingFile));
100                  _trackingManager.Verify(x => x.Update(_ec.Object, _existingConfig, _trackingFile));
101              }
102          }
103          [Fact]
104          [Trait("Level", "L0")]
105          [Trait("Category", "Worker")]
106          public void UpdatesRepositoryDirectoryWorkspaceRepo()
107          {
108              using (TestHostContext hc = Setup())
109              {
110                  _existingConfig = new TrackingConfig(_ec.Object);
<span onclick='openModal()' class='match'>111                  _trackingManager.Setup(x => x.LoadIfExists(_ec.Object, _trackingFile)).Returns(_existingConfig);
112                  _pipelineDirectoryManager.UpdateRepositoryDirectory(_ec.Object, "actions/runner", Path.Combine(hc.GetDirectory(WellKnownDirectory.Work), _existingConfig.PipelineDirectory, "my_new_path"), true);
113                  _trackingManager.Verify(x => x.LoadIfExists(_ec.Object, _trackingFile));
114                  _trackingManager.Verify(x => x.Update(_ec.Object, _existingConfig, _trackingFile));
115                  _ec.Verify(x => x.SetGitHubContext("workspace", Path.Combine(hc.GetDirectory(WellKnownDirectory.Work), _existingConfig.PipelineDirectory, "my_new_path")));
116              }
117          }
118          [Fact]
</span>119          [Trait("Level", "L0")]
120          [Trait("Category", "Worker")]
121          public void UpdatesRepositoryDirectoryNoneWorkspaceRepo()
122          {
123              using (TestHostContext hc = Setup())
124              {
125                  _existingConfig = new TrackingConfig(_ec.Object);
126                  _trackingManager.Setup(x => x.LoadIfExists(_ec.Object, _trackingFile)).Returns(_existingConfig);
127                  _pipelineDirectoryManager.UpdateRepositoryDirectory(_ec.Object, "actions/notrunner", Path.Combine(hc.GetDirectory(WellKnownDirectory.Work), _existingConfig.PipelineDirectory, "notrunner"), false);
128                  _trackingManager.Verify(x => x.LoadIfExists(_ec.Object, _trackingFile));
129                  _trackingManager.Verify(x => x.Update(_ec.Object, _existingConfig, _trackingFile));
130                  _ec.Verify(x => x.SetGitHubContext("workspace", It.IsAny<string>()), Times.Never);
131              }
132          }
133          [Fact]
134          [Trait("Level", "L0")]
135          [Trait("Category", "Worker")]
136          public void UpdatesRepositoryDirectoryThrowOnInvalidPath()
137          {
138              using (TestHostContext hc = Setup())
139              {
140                  _existingConfig = new TrackingConfig(_ec.Object);
141                  _trackingManager.Setup(x => x.LoadIfExists(_ec.Object, _trackingFile)).Returns(_existingConfig);
142                  Assert.ThrowsAny<ArgumentException>(() => _pipelineDirectoryManager.UpdateRepositoryDirectory(_ec.Object, "actions/notrunner", Path.Combine(hc.GetDirectory(WellKnownDirectory.Work), "not_under_pipeline_directory"), false));
143              }
144          }
145          private TestHostContext Setup(
146              [CallerMemberName] string name = "")
147          {
148              TestHostContext hc = new(this, name);
149              _ec = new Mock<IExecutionContext>();
150              _ec.Setup(x => x.Global).Returns(new GlobalContext());
151              GitHubContext githubContext = new();
152              _ec.Setup(x => x.GetGitHubContext("repository")).Returns("actions/runner");
153              _trackingFile = Path.Combine(
154                  hc.GetDirectory(WellKnownDirectory.Work),
155                  Constants.Pipeline.Path.PipelineMappingDirectory,
156                  "actions/runner",
157                  Constants.Pipeline.Path.TrackingConfigFile);
158              _workspaceOptions = new Pipelines.WorkspaceOptions();
159              _trackingManager = new Mock<ITrackingManager>();
160              hc.SetSingleton<ITrackingManager>(_trackingManager.Object);
161              _pipelineDirectoryManager = new PipelineDirectoryManager();
162              _pipelineDirectoryManager.Initialize(hc);
163              return hc;
164          }
165      }
166  }
</code></pre>
        </div>
        <div class="column">
            <h3>Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-SharedAuthenticationTests.cs</h3>
            <pre><code>1  using Microsoft.AspNetCore.Authentication.Tests;
2  using Microsoft.AspNetCore.Http;
3  using Microsoft.Extensions.DependencyInjection;
4  using System;
5  using System.Security.Claims;
6  using System.Threading.Tasks;
7  using Xunit;
8  namespace Microsoft.AspNetCore.Authentication
9  {
10      public abstract class SharedAuthenticationTests<TOptions> where TOptions : AuthenticationSchemeOptions
11      {
12          protected TestClock Clock { get; } = new TestClock();
13          protected abstract string DefaultScheme { get; }
14          protected virtual string DisplayName { get; }
15          protected abstract Type HandlerType { get; }
16          protected virtual bool SupportsSignIn { get => true; }
17          protected virtual bool SupportsSignOut { get => true; }
18          protected abstract void RegisterAuth(AuthenticationBuilder services, Action<TOptions> configure);
19          [Fact]
20          public async Task CanForwardDefault()
21          {
22              var services = new ServiceCollection().AddLogging();
23              var builder = services.AddAuthentication(o =>
24              {
25                  o.DefaultScheme = DefaultScheme;
26                  o.AddScheme<TestHandler>("auth1", "auth1");
27              });
28              RegisterAuth(builder, o => o.ForwardDefault = "auth1");
29              var forwardDefault = new TestHandler();
30              services.AddSingleton(forwardDefault);
31              var sp = services.BuildServiceProvider();
32              var context = new DefaultHttpContext();
33              context.RequestServices = sp;
34              Assert.Equal(0, forwardDefault.AuthenticateCount);
35              Assert.Equal(0, forwardDefault.ForbidCount);
36              Assert.Equal(0, forwardDefault.ChallengeCount);
37              Assert.Equal(0, forwardDefault.SignInCount);
38              Assert.Equal(0, forwardDefault.SignOutCount);
39              await context.AuthenticateAsync();
40              Assert.Equal(1, forwardDefault.AuthenticateCount);
41              await context.ForbidAsync();
42              Assert.Equal(1, forwardDefault.ForbidCount);
43              await context.ChallengeAsync();
44              Assert.Equal(1, forwardDefault.ChallengeCount);
45              if (SupportsSignOut)
46              {
47                  await context.SignOutAsync();
48                  Assert.Equal(1, forwardDefault.SignOutCount);
49              }
50              else
51              {
52                  await Assert.ThrowsAsync<InvalidOperationException>(() => context.SignOutAsync());
53              }
54              if (SupportsSignIn)
55              {
56                  await context.SignInAsync(new ClaimsPrincipal());
57                  Assert.Equal(1, forwardDefault.SignInCount);
58              }
59              else
60              {
61                  await Assert.ThrowsAsync<InvalidOperationException>(() => context.SignInAsync(new ClaimsPrincipal()));
62              }
63          }
64          [Fact]
65          public async Task ForwardSignInWinsOverDefault()
66          {
67              if (SupportsSignIn)
68              {
69                  var services = new ServiceCollection().AddLogging();
70                  var builder = services.AddAuthentication(o =>
71                  {
72                      o.DefaultScheme = DefaultScheme;
73                      o.AddScheme<TestHandler2>("auth1", "auth1");
74                      o.AddScheme<TestHandler>("specific", "specific");
75                  });
76                  RegisterAuth(builder, o =>
77                  {
78                      o.ForwardDefault = "auth1";
79                      o.ForwardSignIn = "specific";
80                  });
81                  var specific = new TestHandler();
82                  services.AddSingleton(specific);
83                  var forwardDefault = new TestHandler2();
84                  services.AddSingleton(forwardDefault);
85                  var sp = services.BuildServiceProvider();
86                  var context = new DefaultHttpContext();
87                  context.RequestServices = sp;
88                  await context.SignInAsync(new ClaimsPrincipal());
89                  Assert.Equal(1, specific.SignInCount);
90                  Assert.Equal(0, specific.AuthenticateCount);
91                  Assert.Equal(0, specific.ForbidCount);
92                  Assert.Equal(0, specific.ChallengeCount);
93                  Assert.Equal(0, specific.SignOutCount);
94                  Assert.Equal(0, forwardDefault.AuthenticateCount);
95                  Assert.Equal(0, forwardDefault.ForbidCount);
96                  Assert.Equal(0, forwardDefault.ChallengeCount);
97                  Assert.Equal(0, forwardDefault.SignInCount);
98                  Assert.Equal(0, forwardDefault.SignOutCount);
99              }
100          }
101          [Fact]
102          public async Task ForwardSignOutWinsOverDefault()
103          {
104              if (SupportsSignOut)
105              {
106                  var services = new ServiceCollection().AddLogging();
107                  var builder = services.AddAuthentication(o =>
108                  {
109                      o.DefaultScheme = DefaultScheme;
110                      o.AddScheme<TestHandler2>("auth1", "auth1");
111                      o.AddScheme<TestHandler>("specific", "specific");
112                  });
113                  RegisterAuth(builder, o =>
114                  {
115                      o.ForwardDefault = "auth1";
116                      o.ForwardSignOut = "specific";
117                  });
118                  var specific = new TestHandler();
119                  services.AddSingleton(specific);
120                  var forwardDefault = new TestHandler2();
121                  services.AddSingleton(forwardDefault);
122                  var sp = services.BuildServiceProvider();
123                  var context = new DefaultHttpContext();
124                  context.RequestServices = sp;
125                  await context.SignOutAsync();
126                  Assert.Equal(1, specific.SignOutCount);
127                  Assert.Equal(0, specific.AuthenticateCount);
128                  Assert.Equal(0, specific.ForbidCount);
129                  Assert.Equal(0, specific.ChallengeCount);
130                  Assert.Equal(0, specific.SignInCount);
131                  Assert.Equal(0, forwardDefault.AuthenticateCount);
132                  Assert.Equal(0, forwardDefault.ForbidCount);
133                  Assert.Equal(0, forwardDefault.ChallengeCount);
134                  Assert.Equal(0, forwardDefault.SignInCount);
135                  Assert.Equal(0, forwardDefault.SignOutCount);
136              }
137          }
138          [Fact]
139          public async Task ForwardForbidWinsOverDefault()
140          {
141              var services = new ServiceCollection().AddLogging();
142              var builder = services.AddAuthentication(o =>
143              {
144                  o.DefaultScheme = DefaultScheme;
145                  o.AddScheme<TestHandler2>("auth1", "auth1");
146                  o.AddScheme<TestHandler>("specific", "specific");
147              });
148              RegisterAuth(builder, o =>
149              {
150                  o.ForwardDefault = "auth1";
151                  o.ForwardForbid = "specific";
152              });
153              var specific = new TestHandler();
154              services.AddSingleton(specific);
155              var forwardDefault = new TestHandler2();
156              services.AddSingleton(forwardDefault);
157              var sp = services.BuildServiceProvider();
158              var context = new DefaultHttpContext();
159              context.RequestServices = sp;
160              await context.ForbidAsync();
161              Assert.Equal(0, specific.SignOutCount);
162              Assert.Equal(0, specific.AuthenticateCount);
163              Assert.Equal(1, specific.ForbidCount);
164              Assert.Equal(0, specific.ChallengeCount);
165              Assert.Equal(0, specific.SignInCount);
166              Assert.Equal(0, forwardDefault.AuthenticateCount);
167              Assert.Equal(0, forwardDefault.ForbidCount);
168              Assert.Equal(0, forwardDefault.ChallengeCount);
169              Assert.Equal(0, forwardDefault.SignInCount);
170              Assert.Equal(0, forwardDefault.SignOutCount);
171          }
172          [Fact]
173          public async Task ForwardAuthenticateWinsOverDefault()
174          {
175              var services = new ServiceCollection().AddLogging();
176              var builder = services.AddAuthentication(o =>
177              {
178                  o.DefaultScheme = DefaultScheme;
179                  o.AddScheme<TestHandler2>("auth1", "auth1");
180                  o.AddScheme<TestHandler>("specific", "specific");
181              });
182              RegisterAuth(builder, o =>
183              {
184                  o.ForwardDefault = "auth1";
185                  o.ForwardAuthenticate = "specific";
186              });
187              var specific = new TestHandler();
188              services.AddSingleton(specific);
189              var forwardDefault = new TestHandler2();
190              services.AddSingleton(forwardDefault);
191              var sp = services.BuildServiceProvider();
192              var context = new DefaultHttpContext();
193              context.RequestServices = sp;
194              await context.AuthenticateAsync();
<span onclick='openModal()' class='match'>195              Assert.Equal(0, specific.SignOutCount);
196              Assert.Equal(1, specific.AuthenticateCount);
197              Assert.Equal(0, specific.ForbidCount);
198              Assert.Equal(0, specific.ChallengeCount);
199              Assert.Equal(0, specific.SignInCount);
200              Assert.Equal(0, forwardDefault.AuthenticateCount);
201              Assert.Equal(0, forwardDefault.ForbidCount);
202              Assert.Equal(0, forwardDefault.ChallengeCount);
203              Assert.Equal(0, forwardDefault.SignInCount);
204              Assert.Equal(0, forwardDefault.SignOutCount);
205          }
206          [Fact]
</span>207          public async Task ForwardChallengeWinsOverDefault()
208          {
209              var services = new ServiceCollection().AddLogging();
210              var builder = services.AddAuthentication(o =>
211              {
212                  o.DefaultScheme = DefaultScheme;
213                  o.AddScheme<TestHandler2>("auth1", "auth1");
214                  o.AddScheme<TestHandler>("specific", "specific");
215              });
216              RegisterAuth(builder, o =>
217              {
218                  o.ForwardDefault = "auth1";
219                  o.ForwardChallenge = "specific";
220              });
221              var specific = new TestHandler();
222              services.AddSingleton(specific);
223              var forwardDefault = new TestHandler2();
224              services.AddSingleton(forwardDefault);
225              var sp = services.BuildServiceProvider();
226              var context = new DefaultHttpContext();
227              context.RequestServices = sp;
228              await context.ChallengeAsync();
229              Assert.Equal(0, specific.SignOutCount);
230              Assert.Equal(0, specific.AuthenticateCount);
231              Assert.Equal(0, specific.ForbidCount);
232              Assert.Equal(1, specific.ChallengeCount);
233              Assert.Equal(0, specific.SignInCount);
234              Assert.Equal(0, forwardDefault.AuthenticateCount);
235              Assert.Equal(0, forwardDefault.ForbidCount);
236              Assert.Equal(0, forwardDefault.ChallengeCount);
237              Assert.Equal(0, forwardDefault.SignInCount);
238              Assert.Equal(0, forwardDefault.SignOutCount);
239          }
240          [Fact]
241          public async Task ForwardSelectorWinsOverDefault()
242          {
243              var services = new ServiceCollection().AddLogging();
244              var builder = services.AddAuthentication(o =>
245              {
246                  o.DefaultScheme = DefaultScheme;
247                  o.AddScheme<TestHandler2>("auth1", "auth1");
248                  o.AddScheme<TestHandler3>("selector", "selector");
249                  o.AddScheme<TestHandler>("specific", "specific");
250              });
251              RegisterAuth(builder, o =>
252              {
253                  o.ForwardDefault = "auth1";
254                  o.ForwardDefaultSelector = _ => "selector";
255              });
256              var specific = new TestHandler();
257              services.AddSingleton(specific);
258              var forwardDefault = new TestHandler2();
259              services.AddSingleton(forwardDefault);
260              var selector = new TestHandler3();
261              services.AddSingleton(selector);
262              var sp = services.BuildServiceProvider();
263              var context = new DefaultHttpContext();
264              context.RequestServices = sp;
265              await context.AuthenticateAsync();
266              Assert.Equal(1, selector.AuthenticateCount);
267              await context.ForbidAsync();
268              Assert.Equal(1, selector.ForbidCount);
269              await context.ChallengeAsync();
270              Assert.Equal(1, selector.ChallengeCount);
271              if (SupportsSignOut)
272              {
273                  await context.SignOutAsync();
274                  Assert.Equal(1, selector.SignOutCount);
275              }
276              else
277              {
278                  await Assert.ThrowsAsync<InvalidOperationException>(() => context.SignOutAsync());
279              }
280              if (SupportsSignIn)
281              {
282                  await context.SignInAsync(new ClaimsPrincipal());
283                  Assert.Equal(1, selector.SignInCount);
284              }
285              else
286              {
287                  await Assert.ThrowsAsync<InvalidOperationException>(() => context.SignInAsync(new ClaimsPrincipal()));
288              }
289              Assert.Equal(0, forwardDefault.AuthenticateCount);
290              Assert.Equal(0, forwardDefault.ForbidCount);
291              Assert.Equal(0, forwardDefault.ChallengeCount);
292              Assert.Equal(0, forwardDefault.SignInCount);
293              Assert.Equal(0, forwardDefault.SignOutCount);
294              Assert.Equal(0, specific.AuthenticateCount);
295              Assert.Equal(0, specific.ForbidCount);
296              Assert.Equal(0, specific.ChallengeCount);
297              Assert.Equal(0, specific.SignInCount);
298              Assert.Equal(0, specific.SignOutCount);
299          }
300          [Fact]
301          public async Task NullForwardSelectorUsesDefault()
302          {
303              var services = new ServiceCollection().AddLogging();
304              var builder = services.AddAuthentication(o =>
305              {
306                  o.DefaultScheme = DefaultScheme;
307                  o.AddScheme<TestHandler2>("auth1", "auth1");
308                  o.AddScheme<TestHandler3>("selector", "selector");
309                  o.AddScheme<TestHandler>("specific", "specific");
310              });
311              RegisterAuth(builder, o =>
312              {
313                  o.ForwardDefault = "auth1";
314                  o.ForwardDefaultSelector = _ => null;
315              });
316              var specific = new TestHandler();
317              services.AddSingleton(specific);
318              var forwardDefault = new TestHandler2();
319              services.AddSingleton(forwardDefault);
320              var selector = new TestHandler3();
321              services.AddSingleton(selector);
322              var sp = services.BuildServiceProvider();
323              var context = new DefaultHttpContext();
324              context.RequestServices = sp;
325              await context.AuthenticateAsync();
326              Assert.Equal(1, forwardDefault.AuthenticateCount);
327              await context.ForbidAsync();
328              Assert.Equal(1, forwardDefault.ForbidCount);
329              await context.ChallengeAsync();
330              Assert.Equal(1, forwardDefault.ChallengeCount);
331              if (SupportsSignOut)
332              {
333                  await context.SignOutAsync();
334                  Assert.Equal(1, forwardDefault.SignOutCount);
335              }
336              else
337              {
338                  await Assert.ThrowsAsync<InvalidOperationException>(() => context.SignOutAsync());
339              }
340              if (SupportsSignIn)
341              {
342                  await context.SignInAsync(new ClaimsPrincipal());
343                  Assert.Equal(1, forwardDefault.SignInCount);
344              }
345              else
346              {
347                  await Assert.ThrowsAsync<InvalidOperationException>(() => context.SignInAsync(new ClaimsPrincipal()));
348              }
349              Assert.Equal(0, selector.AuthenticateCount);
350              Assert.Equal(0, selector.ForbidCount);
351              Assert.Equal(0, selector.ChallengeCount);
352              Assert.Equal(0, selector.SignInCount);
353              Assert.Equal(0, selector.SignOutCount);
354              Assert.Equal(0, specific.AuthenticateCount);
355              Assert.Equal(0, specific.ForbidCount);
356              Assert.Equal(0, specific.ChallengeCount);
357              Assert.Equal(0, specific.SignInCount);
358              Assert.Equal(0, specific.SignOutCount);
359          }
360          [Fact]
361          public async Task SpecificForwardWinsOverSelectorAndDefault()
362          {
363              var services = new ServiceCollection().AddLogging();
364              var builder = services.AddAuthentication(o =>
365              {
366                  o.DefaultScheme = DefaultScheme;
367                  o.AddScheme<TestHandler2>("auth1", "auth1");
368                  o.AddScheme<TestHandler3>("selector", "selector");
369                  o.AddScheme<TestHandler>("specific", "specific");
370              });
371              RegisterAuth(builder, o =>
372              {
373                  o.ForwardDefault = "auth1";
374                  o.ForwardDefaultSelector = _ => "selector";
375                  o.ForwardAuthenticate = "specific";
376                  o.ForwardChallenge = "specific";
377                  o.ForwardSignIn = "specific";
378                  o.ForwardSignOut = "specific";
379                  o.ForwardForbid = "specific";
380              });
381              var specific = new TestHandler();
382              services.AddSingleton(specific);
383              var forwardDefault = new TestHandler2();
384              services.AddSingleton(forwardDefault);
385              var selector = new TestHandler3();
386              services.AddSingleton(selector);
387              var sp = services.BuildServiceProvider();
388              var context = new DefaultHttpContext();
389              context.RequestServices = sp;
390              await context.AuthenticateAsync();
391              Assert.Equal(1, specific.AuthenticateCount);
392              await context.ForbidAsync();
393              Assert.Equal(1, specific.ForbidCount);
394              await context.ChallengeAsync();
395              Assert.Equal(1, specific.ChallengeCount);
396              if (SupportsSignOut)
397              {
398                  await context.SignOutAsync();
399                  Assert.Equal(1, specific.SignOutCount);
400              }
401              else
402              {
403                  await Assert.ThrowsAsync<InvalidOperationException>(() => context.SignOutAsync());
404              }
405              if (SupportsSignIn)
406              {
407                  await context.SignInAsync(new ClaimsPrincipal());
408                  Assert.Equal(1, specific.SignInCount);
409              }
410              else
411              {
412                  await Assert.ThrowsAsync<InvalidOperationException>(() => context.SignInAsync(new ClaimsPrincipal()));
413              }
414              Assert.Equal(0, forwardDefault.AuthenticateCount);
415              Assert.Equal(0, forwardDefault.ForbidCount);
416              Assert.Equal(0, forwardDefault.ChallengeCount);
417              Assert.Equal(0, forwardDefault.SignInCount);
418              Assert.Equal(0, forwardDefault.SignOutCount);
419              Assert.Equal(0, selector.AuthenticateCount);
420              Assert.Equal(0, selector.ForbidCount);
421              Assert.Equal(0, selector.ChallengeCount);
422              Assert.Equal(0, selector.SignInCount);
423              Assert.Equal(0, selector.SignOutCount);
424          }
425          [Fact]
426          public async Task VerifySchemeDefaults()
427          {
428              var services = new ServiceCollection();
429              var builder = services.AddAuthentication();
430              RegisterAuth(builder, o => { });
431              var sp = services.BuildServiceProvider();
432              var schemeProvider = sp.GetRequiredService<IAuthenticationSchemeProvider>();
433              var scheme = await schemeProvider.GetSchemeAsync(DefaultScheme);
434              Assert.NotNull(scheme);
435              Assert.Equal(HandlerType, scheme.HandlerType);
436              Assert.Equal(DisplayName, scheme.DisplayName);
437          }
438      }
439  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from runner-MDEwOlJlcG9zaXRvcnkxODQyODY4NzU=-flat-PipelineDirectoryManagerL0.cs</div>
                <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from Security-MDEwOlJlcG9zaXRvcnkxNzcyMzY5OQ==-flat-SharedAuthenticationTests.cs</div>
                <div class="column column_space"><pre><code>111                  _trackingManager.Setup(x => x.LoadIfExists(_ec.Object, _trackingFile)).Returns(_existingConfig);
112                  _pipelineDirectoryManager.UpdateRepositoryDirectory(_ec.Object, "actions/runner", Path.Combine(hc.GetDirectory(WellKnownDirectory.Work), _existingConfig.PipelineDirectory, "my_new_path"), true);
113                  _trackingManager.Verify(x => x.LoadIfExists(_ec.Object, _trackingFile));
114                  _trackingManager.Verify(x => x.Update(_ec.Object, _existingConfig, _trackingFile));
115                  _ec.Verify(x => x.SetGitHubContext("workspace", Path.Combine(hc.GetDirectory(WellKnownDirectory.Work), _existingConfig.PipelineDirectory, "my_new_path")));
116              }
117          }
118          [Fact]
</pre></code></div>
                <div class="column column_space"><pre><code>195              Assert.Equal(0, specific.SignOutCount);
196              Assert.Equal(1, specific.AuthenticateCount);
197              Assert.Equal(0, specific.ForbidCount);
198              Assert.Equal(0, specific.ChallengeCount);
199              Assert.Equal(0, specific.SignInCount);
200              Assert.Equal(0, forwardDefault.AuthenticateCount);
201              Assert.Equal(0, forwardDefault.ForbidCount);
202              Assert.Equal(0, forwardDefault.ChallengeCount);
203              Assert.Equal(0, forwardDefault.SignInCount);
204              Assert.Equal(0, forwardDefault.SignOutCount);
205          }
206          [Fact]
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    