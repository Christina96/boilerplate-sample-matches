
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Code Files</title>
            <style>
                .column {
                    width: 47%;
                    float: left;
                    padding: 12px;
                    border: 2px solid #ffd0d0;
                }
        
                .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgb(0, 0, 0);
                    background-color: rgba(0, 0, 0, 0.4);
                }
    
                .modal-content {
                    height: 250%;
                    background-color: #fefefe;
                    margin: 5% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 80%;
                }
    
                .close {
                    color: #aaa;
                    float: right;
                    font-size: 20px;
                    font-weight: bold;
                    text-align: right;
                }
    
                .close:hover, .close:focus {
                    color: black;
                    text-decoration: none;
                    cursor: pointer;
                }
    
                .row {
                    float: right;
                    width: 100%;
                }
    
                .column_space  {
                    white - space: pre-wrap;
                }
                 
                pre {
                    width: 100%;
                    overflow-y: auto;
                    background: #f8fef2;
                }
                
                .match {
                    cursor:pointer; 
                    background-color:#00ffbb;
                }
        </style>
    </head>
    <body>
        <h2>Tokens: 25, <button onclick='openModal()' class='match'></button></h2>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-PrepareTests.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Data;
4  using System.Linq;
5  using System.Text;
6  using System.Threading;
7  using System.Threading.Tasks;
8  using NpgsqlTypes;
9  using NUnit.Framework;
10  using static Npgsql.Tests.TestUtil;
11  namespace Npgsql.Tests;
12  public class PrepareTests: TestBase
13  {
14      [Test]
15      public void Basic()
16      {
17          using var conn = OpenConnectionAndUnprepare();
18          using (var cmd = new NpgsqlCommand("SELECT 1", conn))
19          {
20              AssertNumPreparedStatements(conn, 0);
21              Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
22              Assert.That(cmd.IsPrepared, Is.False);
23              cmd.Prepare();
24              AssertNumPreparedStatements(conn, 1);
25              Assert.That(cmd.IsPrepared, Is.True);
26              Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
27          }
28          AssertNumPreparedStatements(conn, 1);
29          conn.UnprepareAll();
30      }
31      [Test]
32      public async Task Async()
33      {
34          using var conn = OpenConnectionAndUnprepare();
35          using (var cmd = new NpgsqlCommand("SELECT 1", conn))
36          {
37              AssertNumPreparedStatements(conn, 0);
38              Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
39              Assert.That(cmd.IsPrepared, Is.False);
40              await cmd.PrepareAsync();
41              AssertNumPreparedStatements(conn, 1);
42              Assert.That(cmd.IsPrepared, Is.True);
43              Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
44          }
45          AssertNumPreparedStatements(conn, 1);
46          conn.UnprepareAll();
47      }
48      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3443")]
49      public void Bug3443()
50      {
51          using var conn = OpenConnectionAndUnprepare();
52          using var cmd = new NpgsqlCommand("SELECT 1", conn);
53          AssertNumPreparedStatements(conn, 0);
54          Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
55          Assert.That(cmd.IsPrepared, Is.False);
56          Assert.ThrowsAsync<OperationCanceledException>(() => cmd.PrepareAsync(new(canceled: true)));
57          AssertNumPreparedStatements(conn, 0);
58          Assert.That(cmd.IsPrepared, Is.False);
59          using var cmd2 = new NpgsqlCommand("SELECT 1", conn);
60          cmd2.Prepare();
61          Assert.That(cmd2.ExecuteScalar(), Is.EqualTo(1));
62          AssertNumPreparedStatements(conn, 1);
63          Assert.That(cmd2.IsPrepared, Is.True);
64      }
65      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4209")]
66      public async Task Async_cancel_NullReferenceException()
67      {
68          for (var i = 0; i < 10; i++)
69          {
70              using var conn = OpenConnectionAndUnprepare();
71              using var cmd = new NpgsqlCommand("SELECT 1", conn);
72              using var cts = new CancellationTokenSource();
73              using var mre = new ManualResetEventSlim();
74              var cancelTask = Task.Run(() =>
75              {
76                  mre.Wait();
77                  cts.Cancel();
78              });
79              try
80              {
81                  mre.Set();
82                  await cmd.PrepareAsync(cts.Token);
83              }
84              catch (OperationCanceledException)
85              {
86              }
87              await cancelTask;
88              Assert.That(conn.State, Is.EqualTo(ConnectionState.Open));
89          }
90      }
91      [Test]
92      public void Unprepare()
93          => Unprepare(false).GetAwaiter().GetResult();
94      [Test]
95      public Task UnprepareAsync()
96          => Unprepare(true);
97      async Task Unprepare(bool async)
98      {
99          using var conn = OpenConnectionAndUnprepare();
100          AssertNumPreparedStatements(conn, 0);
101          using var cmd = new NpgsqlCommand("SELECT 1", conn);
102          if(async)
103              await cmd.PrepareAsync();
104          else
105              cmd.Prepare();
106          AssertNumPreparedStatements(conn, 1);
107          if (async)
108              await cmd.UnprepareAsync();
109          else
110              cmd.Unprepare();
111          AssertNumPreparedStatements(conn, 0);
112          Assert.That(cmd.IsPrepared, Is.False);
113          Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
114      }
115      [Test]
116      public void Named_parameters()
117      {
118          using var conn = OpenConnectionAndUnprepare();
119          for (var i = 0; i < 2; i++)
120          {
121              using var command = new NpgsqlCommand("SELECT @a, @b", conn);
122              command.Parameters.Add(new NpgsqlParameter("a", DbType.Int32));
123              command.Parameters.Add(new NpgsqlParameter("b", 8));
124              command.Prepare();
125              command.Parameters[0].Value = 3;
126              command.Parameters[1].Value = 5;
127              using (var reader = command.ExecuteReader())
128              {
129                  Assert.That(reader.Read(), Is.True);
130                  Assert.That(reader.GetInt32(0), Is.EqualTo(3));
131                  Assert.That(reader.GetInt64(1), Is.EqualTo(5));
132              }
133              command.Unprepare();
134          }
135      }
136      [Test]
137      public void Positional_parameters()
138      {
139          using var conn = OpenConnectionAndUnprepare();
140          for (var i = 0; i < 2; i++)
141          {
142              using var command = new NpgsqlCommand("SELECT $1, $2", conn);
143              command.Parameters.Add(new NpgsqlParameter { DbType = DbType.Int32 });
144              command.Parameters.Add(new NpgsqlParameter { Value = 8 });
145              command.Prepare();
146              command.Parameters[0].Value = 3;
147              command.Parameters[1].Value = 5;
148              using (var reader = command.ExecuteReader())
149              {
150                  Assert.That(reader.Read(), Is.True);
151                  Assert.That(reader.GetInt32(0), Is.EqualTo(3));
152                  Assert.That(reader.GetInt64(1), Is.EqualTo(5));
153              }
154              command.Unprepare();
155          }
156      }
157      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1207")]
158      public void Double_prepare_same_sql()
159      {
160          using var conn = OpenConnectionAndUnprepare();
161          using var cmd = new NpgsqlCommand("SELECT 1", conn);
162          cmd.Prepare();
163          cmd.Prepare();
164          AssertNumPreparedStatements(conn, 1);
165          cmd.Unprepare();
<span onclick='openModal()' class='match'>166          AssertNumPreparedStatements(conn, 0);
167      }
168      [Test]
169      public void Double_prepare_different_sql()
170      {
171          using var conn = OpenConnectionAndUnprepare();
172          using var cmd = new NpgsqlCommand();
</span>173          cmd.Connection = conn;
174          cmd.CommandText = "SELECT 1";
175          cmd.Prepare();
176          cmd.ExecuteNonQuery();
177          cmd.CommandText = "SELECT 2";
178          cmd.Prepare();
179          AssertNumPreparedStatements(conn, 2);
180          cmd.ExecuteNonQuery();
181          conn.UnprepareAll();
182      }
183      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/395")]
184      public void Across_close_open_same_connector()
185      {
186          using var dataSource = CreateDataSource();
187          using var conn = dataSource.OpenConnection();
188          using var cmd = new NpgsqlCommand("SELECT 1", conn);
189          cmd.Prepare();
190          Assert.That(cmd.IsPrepared, Is.True);
191          var processId = conn.ProcessID;
192          conn.Close();
193          conn.Open();
194          Assert.That(processId, Is.EqualTo(conn.ProcessID));
195          Assert.That(cmd.IsPrepared, Is.True);
196          Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
197          cmd.Prepare();
198          Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
199      }
200      [Test]
201      public void Across_close_open_different_connector()
202      {
203          using var dataSource = CreateDataSource();
204          using var conn1 = dataSource.CreateConnection();
205          using var conn2 = dataSource.CreateConnection();
206          using var cmd = new NpgsqlCommand("SELECT 1", conn1);
207          conn1.Open();
208          cmd.Prepare();
209          Assert.That(cmd.IsPrepared, Is.True);
210          var processId = conn1.ProcessID;
211          conn1.Close();
212          conn2.Open();
213          conn1.Open();
214          Assert.That(conn1.ProcessID, Is.Not.EqualTo(processId));
215          Assert.That(cmd.IsPrepared, Is.False);
216          Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));  
217          cmd.Prepare();
218          Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
219      }
220      [Test]
221      public void Reuse_prepared_statement()
222      {
223          using var dataSource = CreateDataSource();
224          using var conn1 = dataSource.OpenConnection();
225          var preparedStatement = "";
226          using (var cmd1 = new NpgsqlCommand("SELECT @p", conn1))
227          {
228              cmd1.Parameters.AddWithValue("p", 8);
229              cmd1.Prepare();
230              Assert.That(cmd1.IsPrepared, Is.True);
231              Assert.That(cmd1.ExecuteScalar(), Is.EqualTo(8));
232              preparedStatement = cmd1.InternalBatchCommands[0].PreparedStatement!.Name!;
233          }
234          using (var cmd2 = new NpgsqlCommand("SELECT @p", conn1))
235          {
236              cmd2.Parameters.AddWithValue("p", 8);
237              cmd2.Prepare();
238              Assert.That(cmd2.IsPrepared, Is.True);
239              Assert.That(cmd2.InternalBatchCommands[0].PreparedStatement!.Name, Is.EqualTo(preparedStatement));
240              Assert.That(cmd2.ExecuteScalar(), Is.EqualTo(8));
241          }
242      }
243      [Test]
244      public void Legacy_batching()
245      {
246          using var conn = OpenConnectionAndUnprepare();
247          using (var cmd = new NpgsqlCommand("SELECT 1; SELECT 2", conn))
248          {
249              cmd.Prepare();
250              using (var reader = cmd.ExecuteReader())
251              {
252                  reader.Read();
253                  Assert.That(reader.GetInt32(0), Is.EqualTo(1));
254                  reader.NextResult();
255                  reader.Read();
256                  Assert.That(reader.GetInt32(0), Is.EqualTo(2));
257              }
258          }
259          AssertNumPreparedStatements(conn, 2);
260          using (var cmd = new NpgsqlCommand("SELECT 1; SELECT 2", conn))
261          {
262              cmd.Prepare();
263              using (var reader = cmd.ExecuteReader())
264              {
265                  reader.Read();
266                  Assert.That(reader.GetInt32(0), Is.EqualTo(1));
267                  reader.NextResult();
268                  reader.Read();
269                  Assert.That(reader.GetInt32(0), Is.EqualTo(2));
270              }
271          }
272          AssertNumPreparedStatements(conn, 2);
273          conn.UnprepareAll();
274      }
275      [Test]
276      public void Batch()
277      {
278          using var conn = OpenConnectionAndUnprepare();
279          using (var batch = new NpgsqlBatch(conn) { BatchCommands = { new("SELECT 1"), new("SELECT 2") } })
280          {
281              batch.Prepare();
282              using (var reader = batch.ExecuteReader())
283              {
284                  reader.Read();
285                  Assert.That(reader.GetInt32(0), Is.EqualTo(1));
286                  reader.NextResult();
287                  reader.Read();
288                  Assert.That(reader.GetInt32(0), Is.EqualTo(2));
289              }
290          }
291          using (var cmd = new NpgsqlCommand("SELECT 1; SELECT 2", conn))
292          {
293              cmd.Prepare();
294              using (var reader = cmd.ExecuteReader())
295              {
296                  reader.Read();
297                  Assert.That(reader.GetInt32(0), Is.EqualTo(1));
298                  reader.NextResult();
299                  reader.Read();
300                  Assert.That(reader.GetInt32(0), Is.EqualTo(2));
301              }
302          }
303          AssertNumPreparedStatements(conn, 2);
304          using (var cmd = new NpgsqlCommand("SELECT 1; SELECT 2", conn))
305          {
306              cmd.Prepare();
307              using (var reader = cmd.ExecuteReader())
308              {
309                  reader.Read();
310                  Assert.That(reader.GetInt32(0), Is.EqualTo(1));
311                  reader.NextResult();
312                  reader.Read();
313                  Assert.That(reader.GetInt32(0), Is.EqualTo(2));
314              }
315          }
316          AssertNumPreparedStatements(conn, 2);
317          conn.UnprepareAll();
318      }
319      [Test]
320      public void One_command_same_sql_twice()
321      {
322          using var conn = OpenConnectionAndUnprepare();
323          using var cmd = new NpgsqlCommand("SELECT 1; SELECT 1", conn);
324          cmd.Prepare();
325          AssertNumPreparedStatements(conn, 1);
326          cmd.ExecuteNonQuery();
327          cmd.Unprepare();
328      }
329      [Test]
330      public void One_command_same_sql_auto_prepare()
331      {
332          using var dataSource = CreateDataSource(csb =>
333          {
334              csb.MaxAutoPrepare = 5;
335              csb.AutoPrepareMinUsages = 2;
336          });
337          using var conn = dataSource.OpenConnection();
338          var sql = new StringBuilder();
339          for (var i = 0; i < 2 + 1; i++)
340              sql.Append("SELECT 1;");
341          using (var cmd = new NpgsqlCommand(sql.ToString(), conn))
342              cmd.ExecuteNonQuery();
343          AssertNumPreparedStatements(conn, 1);
344      }
345      [Test]
346      public void One_command_same_sql_twice_with_params()
347      {
348          using var conn = OpenConnectionAndUnprepare();
349          using var cmd = new NpgsqlCommand("SELECT @p1; SELECT @p2", conn);
350          cmd.Parameters.Add("p1", NpgsqlDbType.Integer);
351          cmd.Parameters.Add("p2", NpgsqlDbType.Integer);
352          cmd.Prepare();
353          AssertNumPreparedStatements(conn, 1);
354          cmd.Parameters[0].Value = 8;
355          cmd.Parameters[1].Value = 9;
356          using (var reader = cmd.ExecuteReader())
357          {
358              Assert.That(reader.Read(), Is.True);
359              Assert.That(reader.GetInt32(0), Is.EqualTo(8));
360              Assert.That(reader.NextResult(), Is.True);
361              Assert.That(reader.Read(), Is.True);
362              Assert.That(reader.GetInt32(0), Is.EqualTo(9));
363              Assert.That(reader.NextResult(), Is.False);
364          }
365          cmd.Unprepare();
366      }
367      [Test]
368      public void Unprepare_via_different_command()
369      {
370          using var conn = OpenConnectionAndUnprepare();
371          using var cmd1 = new NpgsqlCommand("SELECT 1; SELECT 2", conn);
372          using var cmd2 = new NpgsqlCommand("SELECT 2; SELECT 3", conn);
373          cmd1.Prepare();
374          cmd2.Prepare();
375          AssertNumPreparedStatements(conn, 3);
376          cmd2.Unprepare();
377          AssertNumPreparedStatements(conn, 1);
378          Assert.That(cmd1.IsPrepared, Is.False);  
379          cmd1.ExecuteNonQuery();
380          cmd1.Unprepare();
381          AssertNumPreparedStatements(conn, 0);
382          Assert.That(cmd1.IsPrepared, Is.False);
383          cmd1.ExecuteNonQuery();
384          conn.UnprepareAll();
385      }
386      [Test, Description("Prepares the same SQL with different parameters (overloading)")]
387      public void Overloaded_sql()
388      {
389          using var conn = OpenConnectionAndUnprepare();
390          using (var cmd = new NpgsqlCommand("SELECT @p", conn))
391          {
392              cmd.Parameters.Add("p", NpgsqlDbType.Integer);
393              cmd.Prepare();
394              Assert.That(cmd.IsPrepared, Is.True);
395          }
396          using (var cmd = new NpgsqlCommand("SELECT @p", conn))
397          {
398              cmd.Parameters.AddWithValue("p", NpgsqlDbType.Text, "foo");
399              cmd.Prepare();
400              Assert.That(cmd.ExecuteScalar(), Is.EqualTo("foo"));
401              Assert.That(cmd.IsPrepared, Is.False);
402          }
403          AssertNumPreparedStatements(conn, 1);
404          conn.UnprepareAll();
405      }
406      [Test]
407      public void Many_statements_on_unprepare()
408      {
409          using var conn = OpenConnectionAndUnprepare();
410          using var cmd = new NpgsqlCommand();
411          cmd.Connection = conn;
412          var sb = new StringBuilder();
413          for (var i = 0; i < conn.Settings.WriteBufferSize; i++)
414              sb.Append("SELECT 1;");
415          cmd.CommandText = sb.ToString();
416          cmd.Prepare();
417          cmd.Unprepare();
418      }
419      [Test]
420      public void IsPrepared_is_false_after_changing_CommandText()
421      {
422          using var conn = OpenConnectionAndUnprepare();
423          using var cmd = new NpgsqlCommand("SELECT 1", conn);
424          cmd.Prepare();
425          AssertNumPreparedStatements(conn, 1);
426          cmd.CommandText = "SELECT 2";
427          Assert.That(cmd.IsPrepared, Is.False);
428          cmd.ExecuteNonQuery();
429          Assert.That(cmd.IsPrepared, Is.False);
430          AssertNumPreparedStatements(conn, 1);
431          cmd.Unprepare();
432      }
433      [Test, Description("Basic persistent prepared system scenario. Checks that statement is not deallocated in the backend after command dispose.")]
434      public void Persistent_across_commands()
435      {
436          using var conn = OpenConnectionAndUnprepare();
437          AssertNumPreparedStatements(conn, 0);
438          using (var cmd = new NpgsqlCommand("SELECT 1", conn))
439          {
440              cmd.Prepare();
441              AssertNumPreparedStatements(conn, 1);
442              Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
443          }
444          AssertNumPreparedStatements(conn, 1);
445          var stmtName = GetPreparedStatements(conn).Single();
446          using (var cmd = new NpgsqlCommand("SELECT 1", conn))
447          {
448              cmd.Prepare();
449              Assert.That(cmd.IsPrepared, Is.True);
450              AssertNumPreparedStatements(conn, 1);
451              Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
452          }
453          AssertNumPreparedStatements(conn, 1);
454          Assert.That(GetPreparedStatements(conn).Single(), Is.EqualTo(stmtName));
455          conn.UnprepareAll();
456      }
457      [Test, Description("Basic persistent prepared system scenario. Checks that statement is not deallocated in the backend after connection close.")]
458      public void Persistent_across_connections()
459      {
460          using var dataSource = CreateDataSource();
461          using var conn = dataSource.OpenConnection();
462          var processId = conn.ProcessID;
463          AssertNumPreparedStatements(conn, 0);
464          using (var cmd = new NpgsqlCommand("SELECT 1", conn))
465              cmd.Prepare();
466          var stmtName = GetPreparedStatements(conn).Single();
467          conn.Close();
468          conn.Open();
469          Assert.That(conn.ProcessID, Is.EqualTo(processId), "Unexpected connection received from the pool");
470          AssertNumPreparedStatements(conn, 1, "Prepared statement deallocated");
471          Assert.That(GetPreparedStatements(conn).Single(), Is.EqualTo(stmtName), "Prepared statement name changed unexpectedly");
472          using (var cmd = new NpgsqlCommand("SELECT 1", conn))
473          {
474              cmd.Prepare();
475              Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
476          }
477          AssertNumPreparedStatements(conn, 1, "Prepared statement deallocated");
478          Assert.That(GetPreparedStatements(conn).Single(), Is.EqualTo(stmtName), "Prepared statement name changed unexpectedly");
479      }
480      [Test, Description("Makes sure that calling Prepare() twice on a command does not deallocate or make a new one after the first prepared statement when command does not change")]
481      public void Persistent_double_prepare_command_unchanged()
482      {
483          using var conn = OpenConnectionAndUnprepare();
484          using (var cmd = new NpgsqlCommand("SELECT 1", conn))
485          {
486              cmd.Prepare();
487              cmd.ExecuteNonQuery();
488              var stmtName = GetPreparedStatements(conn).Single();
489              cmd.Prepare();
490              cmd.ExecuteNonQuery();
491              AssertNumPreparedStatements(conn, 1, "Unexpected count of prepared statements");
492              Assert.That(GetPreparedStatements(conn).Single(), Is.EqualTo(stmtName), "Persistent prepared statement name changed unexpectedly");
493          }
494          AssertNumPreparedStatements(conn, 1, "Persistent prepared statement deallocated");
495          conn.UnprepareAll();
496      }
497      [Test]
498      public void Persistent_double_prepare_command_changed()
499      {
500          using var conn = OpenConnectionAndUnprepare();
501          using (var cmd = new NpgsqlCommand("SELECT 1", conn))
502          {
503              cmd.Prepare();
504              cmd.ExecuteNonQuery();
505              cmd.CommandText = "SELECT 2";
506              AssertNumPreparedStatements(conn, 1);
507              cmd.Prepare();
508              AssertNumPreparedStatements(conn, 2);
509              cmd.ExecuteNonQuery();
510          }
511          AssertNumPreparedStatements(conn, 2);
512          conn.UnprepareAll();
513      }
514      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2665")]
515      public void Prepared_command_failure()
516      {
517          using var conn = OpenConnection();
518          using (var command = new NpgsqlCommand("INSERT INTO test_table (id) VALUES (1)", conn))
519              Assert.Throws<PostgresException>(() => command.Prepare());
520          conn.ExecuteNonQuery("CREATE TEMP TABLE test_table (id integer)");
521          using (var command = new NpgsqlCommand("INSERT INTO test_table (id) VALUES (1)", conn))
522          {
523              command.Prepare();
524              command.ExecuteNonQuery();
525          }
526      }
527      [Test]
528      public void Invalid_statement()
529      {
530          using var conn = OpenConnection();
531          var cmd = new NpgsqlCommand("sele", conn);
532          Assert.That(() => cmd.Prepare(), Throws.Exception.TypeOf<PostgresException>());
533      }
534      [Test]
535      public void Prepare_multiple_commands_with_parameters()
536      {
537          using var conn = OpenConnection();
538          using var cmd1 = new NpgsqlCommand("SELECT @p1;", conn);
539          using var cmd2 = new NpgsqlCommand("SELECT @p1; SELECT @p2;", conn);
540          var p1 = new NpgsqlParameter("p1", NpgsqlDbType.Integer);
541          var p21 = new NpgsqlParameter("p1", NpgsqlDbType.Text);
542          var p22 = new NpgsqlParameter("p2", NpgsqlDbType.Text);
543          cmd1.Parameters.Add(p1);
544          cmd2.Parameters.Add(p21);
545          cmd2.Parameters.Add(p22);
546          cmd1.Prepare();
547          cmd2.Prepare();
548          p1.Value = 8;
549          p21.Value = "foo";
550          p22.Value = "bar";
551          using (var reader1 = cmd1.ExecuteReader())
552          {
553              Assert.That(reader1.Read(), Is.True);
554              Assert.That(reader1.GetInt32(0), Is.EqualTo(8));
555          }
556          using (var reader2 = cmd2.ExecuteReader())
557          {
558              Assert.That(reader2.Read(), Is.True);
559              Assert.That(reader2.GetString(0), Is.EqualTo("foo"));
560              Assert.That(reader2.NextResult(), Is.True);
561              Assert.That(reader2.Read(), Is.True);
562              Assert.That(reader2.GetString(0), Is.EqualTo("bar"));
563          }
564      }
565      [Test]
566      public void Multiplexing_not_supported()
567      {
568          using var dataSource = CreateDataSource(csb => csb.Multiplexing = true);
569          using var conn = dataSource.OpenConnection();
570          using var cmd = new NpgsqlCommand("SELECT 1", conn);
571          Assert.That(() => cmd.Prepare(), Throws.Exception.TypeOf<NotSupportedException>());
572          Assert.That(() => conn.UnprepareAll(), Throws.Exception.TypeOf<NotSupportedException>());
573      }
574      [Test]
575      public async Task Explicitly_prepared_statement_invalidation()
576      {
577          await using var dataSource = CreateDataSource(csb =>
578          {
579              csb.MaxAutoPrepare = 10;
580              csb.AutoPrepareMinUsages = 2;
581          });
582          await using var connection = await dataSource.OpenConnectionAsync();
583          var table = await CreateTempTable(connection, "foo int");
584          await using var command = new NpgsqlCommand($"SELECT * FROM {table}", connection);
585          await command.PrepareAsync();
586          await connection.ExecuteNonQueryAsync($"ALTER TABLE {table} RENAME COLUMN foo TO bar");
587          var exception = Assert.ThrowsAsync<PostgresException>(() => command.ExecuteNonQueryAsync())!;
588          Assert.That(exception.SqlState, Is.EqualTo(PostgresErrorCodes.FeatureNotSupported)); 
589          Assert.DoesNotThrowAsync(() => command.ExecuteNonQueryAsync());
590          Assert.False(command.IsPrepared);
591      }
592      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4920")]
593      public async Task Explicit_prepare_unprepare_many_queries()
594      {
595          await using var dataSource = CreateDataSource(csb => csb.WriteBufferSize = 5002);
596          await using var conn = await dataSource.OpenConnectionAsync();
597          await using var cmd = conn.CreateCommand();
598          cmd.CommandText = string.Join(';', Enumerable.Range(1, 500).Select(x => $"SELECT {x}"));
599          await cmd.PrepareAsync();
600          await cmd.UnprepareAsync();
601      }
602      NpgsqlConnection OpenConnectionAndUnprepare()
603      {
604          var conn = OpenConnection();
605          conn.UnprepareAll();
606          return conn;
607      }
608      void AssertNumPreparedStatements(NpgsqlConnection conn, int expected)
609          => Assert.That(conn.ExecuteScalar("SELECT COUNT(*) FROM pg_prepared_statements WHERE statement NOT LIKE '%FROM pg_prepared_statements%'"), Is.EqualTo(expected));
610      void AssertNumPreparedStatements(NpgsqlConnection conn, int expected, string message)
611          => Assert.That(conn.ExecuteScalar("SELECT COUNT(*) FROM pg_prepared_statements WHERE statement NOT LIKE '%FROM pg_prepared_statements%'"), Is.EqualTo(expected), message);
612      List<string> GetPreparedStatements(NpgsqlConnection conn)
613      {
614          var statements = new List<string>();
615          using var cmd = new NpgsqlCommand("SELECT name FROM pg_prepared_statements WHERE statement NOT LIKE '%FROM pg_prepared_statement%'", conn);
616          using var reader = cmd.ExecuteReader();
617          while (reader.Read())
618              statements.Add(reader.GetString(0));
619          return statements;
620      }
621  }
</code></pre>
        </div>
        <div class="column">
            <h3>npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-PrepareTests.cs</h3>
            <pre><code>1  using System;
2  using System.Collections.Generic;
3  using System.Data;
4  using System.Linq;
5  using System.Text;
6  using System.Threading;
7  using System.Threading.Tasks;
8  using NpgsqlTypes;
9  using NUnit.Framework;
10  using static Npgsql.Tests.TestUtil;
11  namespace Npgsql.Tests;
12  public class PrepareTests: TestBase
13  {
14      [Test]
15      public void Basic()
16      {
17          using var conn = OpenConnectionAndUnprepare();
18          using (var cmd = new NpgsqlCommand("SELECT 1", conn))
19          {
20              AssertNumPreparedStatements(conn, 0);
21              Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
22              Assert.That(cmd.IsPrepared, Is.False);
23              cmd.Prepare();
24              AssertNumPreparedStatements(conn, 1);
25              Assert.That(cmd.IsPrepared, Is.True);
26              Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
27          }
28          AssertNumPreparedStatements(conn, 1);
29          conn.UnprepareAll();
30      }
31      [Test]
32      public async Task Async()
33      {
34          using var conn = OpenConnectionAndUnprepare();
35          using (var cmd = new NpgsqlCommand("SELECT 1", conn))
36          {
37              AssertNumPreparedStatements(conn, 0);
38              Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
39              Assert.That(cmd.IsPrepared, Is.False);
40              await cmd.PrepareAsync();
41              AssertNumPreparedStatements(conn, 1);
42              Assert.That(cmd.IsPrepared, Is.True);
43              Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
44          }
45          AssertNumPreparedStatements(conn, 1);
46          conn.UnprepareAll();
47      }
48      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/3443")]
49      public void Bug3443()
50      {
51          using var conn = OpenConnectionAndUnprepare();
52          using var cmd = new NpgsqlCommand("SELECT 1", conn);
53          AssertNumPreparedStatements(conn, 0);
54          Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
55          Assert.That(cmd.IsPrepared, Is.False);
56          Assert.ThrowsAsync<OperationCanceledException>(() => cmd.PrepareAsync(new(canceled: true)));
57          AssertNumPreparedStatements(conn, 0);
58          Assert.That(cmd.IsPrepared, Is.False);
59          using var cmd2 = new NpgsqlCommand("SELECT 1", conn);
60          cmd2.Prepare();
61          Assert.That(cmd2.ExecuteScalar(), Is.EqualTo(1));
62          AssertNumPreparedStatements(conn, 1);
63          Assert.That(cmd2.IsPrepared, Is.True);
64      }
65      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4209")]
66      public async Task Async_cancel_NullReferenceException()
67      {
68          for (var i = 0; i < 10; i++)
69          {
70              using var conn = OpenConnectionAndUnprepare();
71              using var cmd = new NpgsqlCommand("SELECT 1", conn);
72              using var cts = new CancellationTokenSource();
73              using var mre = new ManualResetEventSlim();
74              var cancelTask = Task.Run(() =>
75              {
76                  mre.Wait();
77                  cts.Cancel();
78              });
79              try
80              {
81                  mre.Set();
82                  await cmd.PrepareAsync(cts.Token);
83              }
84              catch (OperationCanceledException)
85              {
86              }
87              await cancelTask;
88              Assert.That(conn.State, Is.EqualTo(ConnectionState.Open));
89          }
90      }
91      [Test]
92      public void Unprepare()
93          => Unprepare(false).GetAwaiter().GetResult();
94      [Test]
95      public Task UnprepareAsync()
96          => Unprepare(true);
97      async Task Unprepare(bool async)
98      {
99          using var conn = OpenConnectionAndUnprepare();
100          AssertNumPreparedStatements(conn, 0);
101          using var cmd = new NpgsqlCommand("SELECT 1", conn);
102          if(async)
103              await cmd.PrepareAsync();
104          else
105              cmd.Prepare();
106          AssertNumPreparedStatements(conn, 1);
107          if (async)
108              await cmd.UnprepareAsync();
109          else
110              cmd.Unprepare();
111          AssertNumPreparedStatements(conn, 0);
112          Assert.That(cmd.IsPrepared, Is.False);
113          Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
114      }
115      [Test]
116      public void Named_parameters()
117      {
118          using var conn = OpenConnectionAndUnprepare();
119          for (var i = 0; i < 2; i++)
120          {
121              using var command = new NpgsqlCommand("SELECT @a, @b", conn);
122              command.Parameters.Add(new NpgsqlParameter("a", DbType.Int32));
123              command.Parameters.Add(new NpgsqlParameter("b", 8));
124              command.Prepare();
125              command.Parameters[0].Value = 3;
126              command.Parameters[1].Value = 5;
127              using (var reader = command.ExecuteReader())
128              {
129                  Assert.That(reader.Read(), Is.True);
130                  Assert.That(reader.GetInt32(0), Is.EqualTo(3));
131                  Assert.That(reader.GetInt64(1), Is.EqualTo(5));
132              }
133              command.Unprepare();
134          }
135      }
136      [Test]
137      public void Positional_parameters()
138      {
139          using var conn = OpenConnectionAndUnprepare();
140          for (var i = 0; i < 2; i++)
141          {
142              using var command = new NpgsqlCommand("SELECT $1, $2", conn);
143              command.Parameters.Add(new NpgsqlParameter { DbType = DbType.Int32 });
144              command.Parameters.Add(new NpgsqlParameter { Value = 8 });
145              command.Prepare();
146              command.Parameters[0].Value = 3;
147              command.Parameters[1].Value = 5;
148              using (var reader = command.ExecuteReader())
149              {
150                  Assert.That(reader.Read(), Is.True);
151                  Assert.That(reader.GetInt32(0), Is.EqualTo(3));
152                  Assert.That(reader.GetInt64(1), Is.EqualTo(5));
153              }
154              command.Unprepare();
155          }
156      }
157      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/1207")]
158      public void Double_prepare_same_sql()
159      {
160          using var conn = OpenConnectionAndUnprepare();
161          using var cmd = new NpgsqlCommand("SELECT 1", conn);
162          cmd.Prepare();
163          cmd.Prepare();
164          AssertNumPreparedStatements(conn, 1);
165          cmd.Unprepare();
<span onclick='openModal()' class='match'>166          AssertNumPreparedStatements(conn, 0);
167      }
168      [Test]
169      public void Double_prepare_different_sql()
170      {
171          using var conn = OpenConnectionAndUnprepare();
172          using var cmd = new NpgsqlCommand();
</span>173          cmd.Connection = conn;
174          cmd.CommandText = "SELECT 1";
175          cmd.Prepare();
176          cmd.ExecuteNonQuery();
177          cmd.CommandText = "SELECT 2";
178          cmd.Prepare();
179          AssertNumPreparedStatements(conn, 2);
180          cmd.ExecuteNonQuery();
181          conn.UnprepareAll();
182      }
183      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/395")]
184      public void Across_close_open_same_connector()
185      {
186          using var dataSource = CreateDataSource();
187          using var conn = dataSource.OpenConnection();
188          using var cmd = new NpgsqlCommand("SELECT 1", conn);
189          cmd.Prepare();
190          Assert.That(cmd.IsPrepared, Is.True);
191          var processId = conn.ProcessID;
192          conn.Close();
193          conn.Open();
194          Assert.That(processId, Is.EqualTo(conn.ProcessID));
195          Assert.That(cmd.IsPrepared, Is.True);
196          Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
197          cmd.Prepare();
198          Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
199      }
200      [Test]
201      public void Across_close_open_different_connector()
202      {
203          using var dataSource = CreateDataSource();
204          using var conn1 = dataSource.CreateConnection();
205          using var conn2 = dataSource.CreateConnection();
206          using var cmd = new NpgsqlCommand("SELECT 1", conn1);
207          conn1.Open();
208          cmd.Prepare();
209          Assert.That(cmd.IsPrepared, Is.True);
210          var processId = conn1.ProcessID;
211          conn1.Close();
212          conn2.Open();
213          conn1.Open();
214          Assert.That(conn1.ProcessID, Is.Not.EqualTo(processId));
215          Assert.That(cmd.IsPrepared, Is.False);
216          Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));  
217          cmd.Prepare();
218          Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
219      }
220      [Test]
221      public void Reuse_prepared_statement()
222      {
223          using var dataSource = CreateDataSource();
224          using var conn1 = dataSource.OpenConnection();
225          var preparedStatement = "";
226          using (var cmd1 = new NpgsqlCommand("SELECT @p", conn1))
227          {
228              cmd1.Parameters.AddWithValue("p", 8);
229              cmd1.Prepare();
230              Assert.That(cmd1.IsPrepared, Is.True);
231              Assert.That(cmd1.ExecuteScalar(), Is.EqualTo(8));
232              preparedStatement = cmd1.InternalBatchCommands[0].PreparedStatement!.Name!;
233          }
234          using (var cmd2 = new NpgsqlCommand("SELECT @p", conn1))
235          {
236              cmd2.Parameters.AddWithValue("p", 8);
237              cmd2.Prepare();
238              Assert.That(cmd2.IsPrepared, Is.True);
239              Assert.That(cmd2.InternalBatchCommands[0].PreparedStatement!.Name, Is.EqualTo(preparedStatement));
240              Assert.That(cmd2.ExecuteScalar(), Is.EqualTo(8));
241          }
242      }
243      [Test]
244      public void Legacy_batching()
245      {
246          using var conn = OpenConnectionAndUnprepare();
247          using (var cmd = new NpgsqlCommand("SELECT 1; SELECT 2", conn))
248          {
249              cmd.Prepare();
250              using (var reader = cmd.ExecuteReader())
251              {
252                  reader.Read();
253                  Assert.That(reader.GetInt32(0), Is.EqualTo(1));
254                  reader.NextResult();
255                  reader.Read();
256                  Assert.That(reader.GetInt32(0), Is.EqualTo(2));
257              }
258          }
259          AssertNumPreparedStatements(conn, 2);
260          using (var cmd = new NpgsqlCommand("SELECT 1; SELECT 2", conn))
261          {
262              cmd.Prepare();
263              using (var reader = cmd.ExecuteReader())
264              {
265                  reader.Read();
266                  Assert.That(reader.GetInt32(0), Is.EqualTo(1));
267                  reader.NextResult();
268                  reader.Read();
269                  Assert.That(reader.GetInt32(0), Is.EqualTo(2));
270              }
271          }
272          AssertNumPreparedStatements(conn, 2);
273          conn.UnprepareAll();
274      }
275      [Test]
276      public void Batch()
277      {
278          using var conn = OpenConnectionAndUnprepare();
279          using (var batch = new NpgsqlBatch(conn) { BatchCommands = { new("SELECT 1"), new("SELECT 2") } })
280          {
281              batch.Prepare();
282              using (var reader = batch.ExecuteReader())
283              {
284                  reader.Read();
285                  Assert.That(reader.GetInt32(0), Is.EqualTo(1));
286                  reader.NextResult();
287                  reader.Read();
288                  Assert.That(reader.GetInt32(0), Is.EqualTo(2));
289              }
290          }
291          using (var cmd = new NpgsqlCommand("SELECT 1; SELECT 2", conn))
292          {
293              cmd.Prepare();
294              using (var reader = cmd.ExecuteReader())
295              {
296                  reader.Read();
297                  Assert.That(reader.GetInt32(0), Is.EqualTo(1));
298                  reader.NextResult();
299                  reader.Read();
300                  Assert.That(reader.GetInt32(0), Is.EqualTo(2));
301              }
302          }
303          AssertNumPreparedStatements(conn, 2);
304          using (var cmd = new NpgsqlCommand("SELECT 1; SELECT 2", conn))
305          {
306              cmd.Prepare();
307              using (var reader = cmd.ExecuteReader())
308              {
309                  reader.Read();
310                  Assert.That(reader.GetInt32(0), Is.EqualTo(1));
311                  reader.NextResult();
312                  reader.Read();
313                  Assert.That(reader.GetInt32(0), Is.EqualTo(2));
314              }
315          }
316          AssertNumPreparedStatements(conn, 2);
317          conn.UnprepareAll();
318      }
319      [Test]
320      public void One_command_same_sql_twice()
321      {
322          using var conn = OpenConnectionAndUnprepare();
323          using var cmd = new NpgsqlCommand("SELECT 1; SELECT 1", conn);
324          cmd.Prepare();
325          AssertNumPreparedStatements(conn, 1);
326          cmd.ExecuteNonQuery();
327          cmd.Unprepare();
328      }
329      [Test]
330      public void One_command_same_sql_auto_prepare()
331      {
332          using var dataSource = CreateDataSource(csb =>
333          {
334              csb.MaxAutoPrepare = 5;
335              csb.AutoPrepareMinUsages = 2;
336          });
337          using var conn = dataSource.OpenConnection();
338          var sql = new StringBuilder();
339          for (var i = 0; i < 2 + 1; i++)
340              sql.Append("SELECT 1;");
341          using (var cmd = new NpgsqlCommand(sql.ToString(), conn))
342              cmd.ExecuteNonQuery();
343          AssertNumPreparedStatements(conn, 1);
344      }
345      [Test]
346      public void One_command_same_sql_twice_with_params()
347      {
348          using var conn = OpenConnectionAndUnprepare();
349          using var cmd = new NpgsqlCommand("SELECT @p1; SELECT @p2", conn);
350          cmd.Parameters.Add("p1", NpgsqlDbType.Integer);
351          cmd.Parameters.Add("p2", NpgsqlDbType.Integer);
352          cmd.Prepare();
353          AssertNumPreparedStatements(conn, 1);
354          cmd.Parameters[0].Value = 8;
355          cmd.Parameters[1].Value = 9;
356          using (var reader = cmd.ExecuteReader())
357          {
358              Assert.That(reader.Read(), Is.True);
359              Assert.That(reader.GetInt32(0), Is.EqualTo(8));
360              Assert.That(reader.NextResult(), Is.True);
361              Assert.That(reader.Read(), Is.True);
362              Assert.That(reader.GetInt32(0), Is.EqualTo(9));
363              Assert.That(reader.NextResult(), Is.False);
364          }
365          cmd.Unprepare();
366      }
367      [Test]
368      public void Unprepare_via_different_command()
369      {
370          using var conn = OpenConnectionAndUnprepare();
371          using var cmd1 = new NpgsqlCommand("SELECT 1; SELECT 2", conn);
372          using var cmd2 = new NpgsqlCommand("SELECT 2; SELECT 3", conn);
373          cmd1.Prepare();
374          cmd2.Prepare();
375          AssertNumPreparedStatements(conn, 3);
376          cmd2.Unprepare();
377          AssertNumPreparedStatements(conn, 1);
378          Assert.That(cmd1.IsPrepared, Is.False);  
379          cmd1.ExecuteNonQuery();
380          cmd1.Unprepare();
381          AssertNumPreparedStatements(conn, 0);
382          Assert.That(cmd1.IsPrepared, Is.False);
383          cmd1.ExecuteNonQuery();
384          conn.UnprepareAll();
385      }
386      [Test, Description("Prepares the same SQL with different parameters (overloading)")]
387      public void Overloaded_sql()
388      {
389          using var conn = OpenConnectionAndUnprepare();
390          using (var cmd = new NpgsqlCommand("SELECT @p", conn))
391          {
392              cmd.Parameters.Add("p", NpgsqlDbType.Integer);
393              cmd.Prepare();
394              Assert.That(cmd.IsPrepared, Is.True);
395          }
396          using (var cmd = new NpgsqlCommand("SELECT @p", conn))
397          {
398              cmd.Parameters.AddWithValue("p", NpgsqlDbType.Text, "foo");
399              cmd.Prepare();
400              Assert.That(cmd.ExecuteScalar(), Is.EqualTo("foo"));
401              Assert.That(cmd.IsPrepared, Is.False);
402          }
403          AssertNumPreparedStatements(conn, 1);
404          conn.UnprepareAll();
405      }
406      [Test]
407      public void Many_statements_on_unprepare()
408      {
409          using var conn = OpenConnectionAndUnprepare();
410          using var cmd = new NpgsqlCommand();
411          cmd.Connection = conn;
412          var sb = new StringBuilder();
413          for (var i = 0; i < conn.Settings.WriteBufferSize; i++)
414              sb.Append("SELECT 1;");
415          cmd.CommandText = sb.ToString();
416          cmd.Prepare();
417          cmd.Unprepare();
418      }
419      [Test]
420      public void IsPrepared_is_false_after_changing_CommandText()
421      {
422          using var conn = OpenConnectionAndUnprepare();
423          using var cmd = new NpgsqlCommand("SELECT 1", conn);
424          cmd.Prepare();
425          AssertNumPreparedStatements(conn, 1);
426          cmd.CommandText = "SELECT 2";
427          Assert.That(cmd.IsPrepared, Is.False);
428          cmd.ExecuteNonQuery();
429          Assert.That(cmd.IsPrepared, Is.False);
430          AssertNumPreparedStatements(conn, 1);
431          cmd.Unprepare();
432      }
433      [Test, Description("Basic persistent prepared system scenario. Checks that statement is not deallocated in the backend after command dispose.")]
434      public void Persistent_across_commands()
435      {
436          using var conn = OpenConnectionAndUnprepare();
437          AssertNumPreparedStatements(conn, 0);
438          using (var cmd = new NpgsqlCommand("SELECT 1", conn))
439          {
440              cmd.Prepare();
441              AssertNumPreparedStatements(conn, 1);
442              Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
443          }
444          AssertNumPreparedStatements(conn, 1);
445          var stmtName = GetPreparedStatements(conn).Single();
446          using (var cmd = new NpgsqlCommand("SELECT 1", conn))
447          {
448              cmd.Prepare();
449              Assert.That(cmd.IsPrepared, Is.True);
450              AssertNumPreparedStatements(conn, 1);
451              Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
452          }
453          AssertNumPreparedStatements(conn, 1);
454          Assert.That(GetPreparedStatements(conn).Single(), Is.EqualTo(stmtName));
455          conn.UnprepareAll();
456      }
457      [Test, Description("Basic persistent prepared system scenario. Checks that statement is not deallocated in the backend after connection close.")]
458      public void Persistent_across_connections()
459      {
460          using var dataSource = CreateDataSource();
461          using var conn = dataSource.OpenConnection();
462          var processId = conn.ProcessID;
463          AssertNumPreparedStatements(conn, 0);
464          using (var cmd = new NpgsqlCommand("SELECT 1", conn))
465              cmd.Prepare();
466          var stmtName = GetPreparedStatements(conn).Single();
467          conn.Close();
468          conn.Open();
469          Assert.That(conn.ProcessID, Is.EqualTo(processId), "Unexpected connection received from the pool");
470          AssertNumPreparedStatements(conn, 1, "Prepared statement deallocated");
471          Assert.That(GetPreparedStatements(conn).Single(), Is.EqualTo(stmtName), "Prepared statement name changed unexpectedly");
472          using (var cmd = new NpgsqlCommand("SELECT 1", conn))
473          {
474              cmd.Prepare();
475              Assert.That(cmd.ExecuteScalar(), Is.EqualTo(1));
476          }
477          AssertNumPreparedStatements(conn, 1, "Prepared statement deallocated");
478          Assert.That(GetPreparedStatements(conn).Single(), Is.EqualTo(stmtName), "Prepared statement name changed unexpectedly");
479      }
480      [Test, Description("Makes sure that calling Prepare() twice on a command does not deallocate or make a new one after the first prepared statement when command does not change")]
481      public void Persistent_double_prepare_command_unchanged()
482      {
483          using var conn = OpenConnectionAndUnprepare();
484          using (var cmd = new NpgsqlCommand("SELECT 1", conn))
485          {
486              cmd.Prepare();
487              cmd.ExecuteNonQuery();
488              var stmtName = GetPreparedStatements(conn).Single();
489              cmd.Prepare();
490              cmd.ExecuteNonQuery();
491              AssertNumPreparedStatements(conn, 1, "Unexpected count of prepared statements");
492              Assert.That(GetPreparedStatements(conn).Single(), Is.EqualTo(stmtName), "Persistent prepared statement name changed unexpectedly");
493          }
494          AssertNumPreparedStatements(conn, 1, "Persistent prepared statement deallocated");
495          conn.UnprepareAll();
496      }
497      [Test]
498      public void Persistent_double_prepare_command_changed()
499      {
500          using var conn = OpenConnectionAndUnprepare();
501          using (var cmd = new NpgsqlCommand("SELECT 1", conn))
502          {
503              cmd.Prepare();
504              cmd.ExecuteNonQuery();
505              cmd.CommandText = "SELECT 2";
506              AssertNumPreparedStatements(conn, 1);
507              cmd.Prepare();
508              AssertNumPreparedStatements(conn, 2);
509              cmd.ExecuteNonQuery();
510          }
511          AssertNumPreparedStatements(conn, 2);
512          conn.UnprepareAll();
513      }
514      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/2665")]
515      public void Prepared_command_failure()
516      {
517          using var conn = OpenConnection();
518          using (var command = new NpgsqlCommand("INSERT INTO test_table (id) VALUES (1)", conn))
519              Assert.Throws<PostgresException>(() => command.Prepare());
520          conn.ExecuteNonQuery("CREATE TEMP TABLE test_table (id integer)");
521          using (var command = new NpgsqlCommand("INSERT INTO test_table (id) VALUES (1)", conn))
522          {
523              command.Prepare();
524              command.ExecuteNonQuery();
525          }
526      }
527      [Test]
528      public void Invalid_statement()
529      {
530          using var conn = OpenConnection();
531          var cmd = new NpgsqlCommand("sele", conn);
532          Assert.That(() => cmd.Prepare(), Throws.Exception.TypeOf<PostgresException>());
533      }
534      [Test]
535      public void Prepare_multiple_commands_with_parameters()
536      {
537          using var conn = OpenConnection();
538          using var cmd1 = new NpgsqlCommand("SELECT @p1;", conn);
539          using var cmd2 = new NpgsqlCommand("SELECT @p1; SELECT @p2;", conn);
540          var p1 = new NpgsqlParameter("p1", NpgsqlDbType.Integer);
541          var p21 = new NpgsqlParameter("p1", NpgsqlDbType.Text);
542          var p22 = new NpgsqlParameter("p2", NpgsqlDbType.Text);
543          cmd1.Parameters.Add(p1);
544          cmd2.Parameters.Add(p21);
545          cmd2.Parameters.Add(p22);
546          cmd1.Prepare();
547          cmd2.Prepare();
548          p1.Value = 8;
549          p21.Value = "foo";
550          p22.Value = "bar";
551          using (var reader1 = cmd1.ExecuteReader())
552          {
553              Assert.That(reader1.Read(), Is.True);
554              Assert.That(reader1.GetInt32(0), Is.EqualTo(8));
555          }
556          using (var reader2 = cmd2.ExecuteReader())
557          {
558              Assert.That(reader2.Read(), Is.True);
559              Assert.That(reader2.GetString(0), Is.EqualTo("foo"));
560              Assert.That(reader2.NextResult(), Is.True);
561              Assert.That(reader2.Read(), Is.True);
562              Assert.That(reader2.GetString(0), Is.EqualTo("bar"));
563          }
564      }
565      [Test]
566      public void Multiplexing_not_supported()
567      {
568          using var dataSource = CreateDataSource(csb => csb.Multiplexing = true);
569          using var conn = dataSource.OpenConnection();
570          using var cmd = new NpgsqlCommand("SELECT 1", conn);
571          Assert.That(() => cmd.Prepare(), Throws.Exception.TypeOf<NotSupportedException>());
572          Assert.That(() => conn.UnprepareAll(), Throws.Exception.TypeOf<NotSupportedException>());
573      }
574      [Test]
575      public async Task Explicitly_prepared_statement_invalidation()
576      {
577          await using var dataSource = CreateDataSource(csb =>
578          {
579              csb.MaxAutoPrepare = 10;
580              csb.AutoPrepareMinUsages = 2;
581          });
582          await using var connection = await dataSource.OpenConnectionAsync();
583          var table = await CreateTempTable(connection, "foo int");
584          await using var command = new NpgsqlCommand($"SELECT * FROM {table}", connection);
585          await command.PrepareAsync();
586          await connection.ExecuteNonQueryAsync($"ALTER TABLE {table} RENAME COLUMN foo TO bar");
587          var exception = Assert.ThrowsAsync<PostgresException>(() => command.ExecuteNonQueryAsync())!;
588          Assert.That(exception.SqlState, Is.EqualTo(PostgresErrorCodes.FeatureNotSupported)); 
589          Assert.DoesNotThrowAsync(() => command.ExecuteNonQueryAsync());
590          Assert.False(command.IsPrepared);
591      }
592      [Test, IssueLink("https:&bsol;&bsol;github.com/npgsql/npgsql/issues/4920")]
593      public async Task Explicit_prepare_unprepare_many_queries()
594      {
595          await using var dataSource = CreateDataSource(csb => csb.WriteBufferSize = 5002);
596          await using var conn = await dataSource.OpenConnectionAsync();
597          await using var cmd = conn.CreateCommand();
598          cmd.CommandText = string.Join(';', Enumerable.Range(1, 500).Select(x => $"SELECT {x}"));
599          await cmd.PrepareAsync();
600          await cmd.UnprepareAsync();
601      }
602      NpgsqlConnection OpenConnectionAndUnprepare()
603      {
604          var conn = OpenConnection();
605          conn.UnprepareAll();
606          return conn;
607      }
608      void AssertNumPreparedStatements(NpgsqlConnection conn, int expected)
609          => Assert.That(conn.ExecuteScalar("SELECT COUNT(*) FROM pg_prepared_statements WHERE statement NOT LIKE '%FROM pg_prepared_statements%'"), Is.EqualTo(expected));
610      void AssertNumPreparedStatements(NpgsqlConnection conn, int expected, string message)
611          => Assert.That(conn.ExecuteScalar("SELECT COUNT(*) FROM pg_prepared_statements WHERE statement NOT LIKE '%FROM pg_prepared_statements%'"), Is.EqualTo(expected), message);
612      List<string> GetPreparedStatements(NpgsqlConnection conn)
613      {
614          var statements = new List<string>();
615          using var cmd = new NpgsqlCommand("SELECT name FROM pg_prepared_statements WHERE statement NOT LIKE '%FROM pg_prepared_statement%'", conn);
616          using var reader = cmd.ExecuteReader();
617          while (reader.Read())
618              statements.Add(reader.GetString(0));
619          return statements;
620      }
621  }
</code></pre>
        </div>
    
        <!-- The Modal -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="row close">&times;</span>
                <div class='row'>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-PrepareTests.cs</div>
                    <div class="column" style="font-weight: bold;text-decoration: underline">Fragment from npgsql-MDEwOlJlcG9zaXRvcnkyODgzNTc0-flat-PrepareTests.cs</div>
                </div>
                <div class="column column_space"><pre><code>166          AssertNumPreparedStatements(conn, 0);
167      }
168      [Test]
169      public void Double_prepare_different_sql()
170      {
171          using var conn = OpenConnectionAndUnprepare();
172          using var cmd = new NpgsqlCommand();
</pre></code></div>
                <div class="column column_space"><pre><code>166          AssertNumPreparedStatements(conn, 0);
167      }
168      [Test]
169      public void Double_prepare_different_sql()
170      {
171          using var conn = OpenConnectionAndUnprepare();
172          using var cmd = new NpgsqlCommand();
</pre></code></div>
            </div>
        </div>
        <script>
        // Get the modal
        var modal = document.getElementById("myModal");
        
        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        
        // When the user clicks the button, open the modal
        function openModal(){
          modal.style.display = "block";
        }
        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
        modal.style.display = "none";
        }
        
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
        modal.style.display = "none";
        } }
        
        </script>
    </body>
    </html>
    